<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documento Convertido</title>
    <style>
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f8fafc; --bg-accent: #f1f5f9;
            --text-primary: #1e293b; --text-secondary: #475569; --text-muted: #64748b;
            --border-color: #e2e8f0; --accent-color: #3b82f6; --accent-hover: #2563eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --toc-bg: #f8fafc;
        }
        [data-theme="dark"] {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-accent: #334155;
            --text-primary: #f1f5f9; --text-secondary: #cbd5e1; --text-muted: #94a3b8;
            --border-color: #334155; --accent-color: #60a5fa; --accent-hover: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); --toc-bg: #1e293b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Inter", "Segoe UI", sans-serif; line-height: 1.7; color: var(--text-primary); background-color: var(--bg-primary); transition: background-color 0.3s, color 0.3s; }
        html { scroll-behavior: smooth; }
        
        .layout-container { display: flex; }

        .sidebar { flex: 0 0 300px; position: sticky; top: 0; height: 100vh; overflow-y: auto; background: var(--toc-bg); padding: 24px; border-right: 1px solid var(--border-color); transition: transform 0.3s ease; }
        .main-content { flex-grow: 1; padding: 40px; }
        
        .toc-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border-color); }
        .toc-title { font-size: 1.2rem; font-weight: 600; color: var(--text-primary); }
        .theme-toggle { background: var(--bg-accent); border: 1px solid var(--border-color); border-radius: 8px; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; transition: all 0.3s ease; }
        .theme-toggle:hover { background: var(--accent-color); color: white; transform: scale(1.05); }
        
        .toc-nav { list-style: none; }
        .toc-item { margin-bottom: 4px; }
        .toc-link { display: block; padding: 8px 12px; color: var(--text-secondary); text-decoration: none; border-radius: 8px; font-size: 0.9rem; transition: all 0.2s ease; border-left: 3px solid transparent; }
        .toc-link:hover, .toc-link.active { background: var(--bg-accent); color: var(--accent-color); border-left-color: var(--accent-color); transform: translateX(4px); }
        .toc-h1 { font-weight: 600; }
        .toc-h2 { padding-left: 20px; }
        .toc-h3 { padding-left: 32px; font-size: 0.85rem; }
        .toc-h4 { padding-left: 44px; font-size: 0.8rem; }
        
        .main-content-header { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .document-title { font-size: 2.5rem; font-weight: 700; color: var(--text-primary); }

        h1, h2, h3, h4 { scroll-margin-top: 20px; }
        h1 { font-size: 2.2rem; margin: 48px 0 24px 0; padding-bottom: 16px; border-bottom: 2px solid var(--accent-color); }
        h2 { font-size: 1.6rem; margin: 40px 0 20px 0; padding-left: 16px; border-left: 4px solid var(--accent-color); }
        h3 { font-size: 1.3rem; margin: 32px 0 16px 0; }
        p { margin-bottom: 20px; text-align: justify; }
        ul, ol { margin: 24px 0; padding-left: 24px; }
        li { margin-bottom: 12px; }
        a { color: var(--accent-color); text-decoration: none; font-weight: 500; }
        a:hover { text-decoration: underline; }
        
        .mobile-header { display: none; }

        @media (max-width: 1024px) {
            .sidebar { position: fixed; top: 0; left: 0; z-index: 1000; transform: translateX(-100%); background: var(--bg-primary); box-shadow: var(--shadow); }
            .sidebar.is-open { transform: translateX(0); }
            .main-content { padding: 20px; }
            .layout-container { display: block; }

            .mobile-header { display: flex; align-items: center; justify-content: space-between; padding: 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 999; }
            .menu-toggle { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary); }
            .overlay { display: none; }
            .overlay.is-active { display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 998; }
        }
    </style>
</head>
<body>
    <div class="mobile-header">
         <h1 class="document-title" style="font-size: 1.2rem; margin: 0;">Documento</h1>
         <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
    </div>

    <div class="layout-container">
        <aside class="sidebar" id="sidebar">
            <nav class="table-of-contents">
                <div class="toc-header">
                    <h2 class="toc-title">üìö √çndice</h2>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema"><span id="theme-icon">üåô</span></button>
                </div>
                <ul class="toc-nav" id="toc-nav">
                    
                    <li class="toc-item">
                        <a href="#robert-cecil-martin-0" class="toc-link toc-h3">Robert Cecil Martin</a>
                    </li>
                    <li class="toc-item">
                        <a href="#codigo-limpio-1" class="toc-link toc-h1">C√≥digo limpio</a>
                    </li>
                    <li class="toc-item">
                        <a href="#agradecimientos-2" class="toc-link toc-h1">Agradecimientos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#prologo-3" class="toc-link toc-h1">Pr√≥logo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#introduccion-4" class="toc-link toc-h1">Introducci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#sobre-la-imagen-de-cubierta-5" class="toc-link toc-h1">Sobre la imagen de cubierta</a>
                    </li>
                    <li class="toc-item">
                        <a href="#codigo-limpio-6" class="toc-link toc-h1">C√≥digo Limpio</a>
                    </li>
                    <li class="toc-item">
                        <a href="#hagase-el-codigo-7" class="toc-link toc-h3">H√°gase el c√≥digo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#codigo-incorrecto-8" class="toc-link toc-h3">C√≥digo Incorrecto</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-coste-total-de-un-desastre-9" class="toc-link toc-h3">El coste total de un desastre</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-gran-cambio-de-diseno-10" class="toc-link toc-h3">El gran cambio de dise√±o</a>
                    </li>
                    <li class="toc-item">
                        <a href="#actitud-11" class="toc-link toc-h3">Actitud</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-enigma-12" class="toc-link toc-h3">El enigma</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-arte-del-codigo-limpio-13" class="toc-link toc-h3">¬øEl arte del c√≥digo limpio?</a>
                    </li>
                    <li class="toc-item">
                        <a href="#concepto-de-codigo-limpio-14" class="toc-link toc-h3">Concepto de c√≥digo limpio</a>
                    </li>
                    <li class="toc-item">
                        <a href="#escuelas-de-pensamiento-15" class="toc-link toc-h3">Escuelas de pensamiento</a>
                    </li>
                    <li class="toc-item">
                        <a href="#somos-autores-16" class="toc-link toc-h3">Somos autores</a>
                    </li>
                    <li class="toc-item">
                        <a href="#la-regla-del-boy-scout-17" class="toc-link toc-h3">La regla del Boy Scout</a>
                    </li>
                    <li class="toc-item">
                        <a href="#precuela-y-principios-18" class="toc-link toc-h3">Precuela y principios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-19" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-20" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#nombres-con-sentido-21" class="toc-link toc-h1">Nombres con sentido</a>
                    </li>
                    <li class="toc-item">
                        <a href="#introduccion-22" class="toc-link toc-h3">Introducci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-nombres-que-revelen-las-intenciones-23" class="toc-link toc-h3">Usar nombres que revelen las intenciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#evitar-la-desinformacion-24" class="toc-link toc-h3">Evitar la desinformaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#realizar-distinciones-con-sentido-25" class="toc-link toc-h3">Realizar distinciones con sentido</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-nombres-que-se-puedan-pronunciar-26" class="toc-link toc-h3">Usar nombres que se puedan pronunciar</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-nombres-que-se-puedan-buscar-27" class="toc-link toc-h3">Usar nombres que se puedan buscar</a>
                    </li>
                    <li class="toc-item">
                        <a href="#evitar-codificaciones-28" class="toc-link toc-h3">Evitar codificaciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#notacion-hungara-29" class="toc-link toc-h3">Notaci√≥n h√∫ngara</a>
                    </li>
                    <li class="toc-item">
                        <a href="#prefijos-de-miembros-30" class="toc-link toc-h3">Prefijos de miembros</a>
                    </li>
                    <li class="toc-item">
                        <a href="#interfaces-e-implementaciones-31" class="toc-link toc-h3">Interfaces e Implementaciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#evitar-asignaciones-mentales-32" class="toc-link toc-h3">Evitar asignaciones mentales</a>
                    </li>
                    <li class="toc-item">
                        <a href="#nombres-de-clases-33" class="toc-link toc-h3">Nombres de clases</a>
                    </li>
                    <li class="toc-item">
                        <a href="#nombres-de-metodos-34" class="toc-link toc-h3">Nombres de m√©todos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#no-se-exceda-con-el-atractivo-35" class="toc-link toc-h3">No se exceda con el atractivo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#una-palabra-por-concepto-36" class="toc-link toc-h3">Una palabra por concepto</a>
                    </li>
                    <li class="toc-item">
                        <a href="#no-haga-juegos-de-palabras-37" class="toc-link toc-h3">No haga juegos de palabras</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-nombres-de-dominios-de-soluciones-38" class="toc-link toc-h3">Usar nombres de dominios de soluciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-nombres-de-dominios-de-problemas-39" class="toc-link toc-h3">Usar nombres de dominios de problemas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#anadir-contexto-con-sentido-40" class="toc-link toc-h3">A√±adir contexto con sentido</a>
                    </li>
                    <li class="toc-item">
                        <a href="#no-anadir-contextos-innecesarios-41" class="toc-link toc-h3">No a√±adir contextos innecesarios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-42" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#funciones-43" class="toc-link toc-h1">Funciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#tamano-reducido-44" class="toc-link toc-h3">Tama√±o reducido</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bloques-y-sangrado-45" class="toc-link toc-h3">Bloques y sangrado</a>
                    </li>
                    <li class="toc-item">
                        <a href="#hacer-una-cosa-46" class="toc-link toc-h3">Hacer una cosa</a>
                    </li>
                    <li class="toc-item">
                        <a href="#secciones-en-funciones-47" class="toc-link toc-h3">Secciones en funciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#un-nivel-de-abstraccion-por-funcion-48" class="toc-link toc-h3">Un nivel de abstracci√≥n por funci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#leer-codigo-de-arriba-a-abajo-la-regla-descendente-49" class="toc-link toc-h3">Leer c√≥digo de arriba a abajo: la regla descendente</a>
                    </li>
                    <li class="toc-item">
                        <a href="#instrucciones-switch-50" class="toc-link toc-h3">Instrucciones Switch</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-nombres-descriptivos-51" class="toc-link toc-h3">Usar nombres descriptivos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#argumentos-de-funciones-52" class="toc-link toc-h3">Argumentos de funciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#formas-monadicas-habituales-53" class="toc-link toc-h3">Formas mon√°dicas habituales</a>
                    </li>
                    <li class="toc-item">
                        <a href="#argumentos-de-indicador-54" class="toc-link toc-h3">Argumentos de indicador</a>
                    </li>
                    <li class="toc-item">
                        <a href="#funciones-diadicas-55" class="toc-link toc-h3">Funciones di√°dicas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#triadas-56" class="toc-link toc-h3">Triadas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#objeto-de-argumento-57" class="toc-link toc-h3">Objeto de argumento</a>
                    </li>
                    <li class="toc-item">
                        <a href="#listas-de-argumentos-58" class="toc-link toc-h3">Listas de argumentos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#verbos-y-palabras-clave-59" class="toc-link toc-h3">Verbos y palabras clave</a>
                    </li>
                    <li class="toc-item">
                        <a href="#sin-efectos-secundarios-60" class="toc-link toc-h3">Sin efectos secundarios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#argumentos-de-salida-61" class="toc-link toc-h3">Argumentos de salida</a>
                    </li>
                    <li class="toc-item">
                        <a href="#separacion-de-consultas-de-comando-62" class="toc-link toc-h3">Separaci√≥n de consultas de comando</a>
                    </li>
                    <li class="toc-item">
                        <a href="#mejor-excepciones-que-devolver-codigos-de-error-63" class="toc-link toc-h3">Mejor excepciones que devolver c√≥digos de error</a>
                    </li>
                    <li class="toc-item">
                        <a href="#extraer-bloques-trycatch-64" class="toc-link toc-h3">Extraer bloques Try/Catch</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-procesamiento-de-errores-es-una-cosa-65" class="toc-link toc-h3">El procesamiento de errores es una cosa</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-iman-de-dependencias-errorjava-66" class="toc-link toc-h3">El im√°n de dependencias Error.java</a>
                    </li>
                    <li class="toc-item">
                        <a href="#no-repetirse-67" class="toc-link toc-h3">No repetirse</a>
                    </li>
                    <li class="toc-item">
                        <a href="#programacion-estructurada-68" class="toc-link toc-h3">Programaci√≥n estructurada</a>
                    </li>
                    <li class="toc-item">
                        <a href="#como-crear-este-tipo-de-funciones-69" class="toc-link toc-h3">C√≥mo crear este tipo de funciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-70" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#setupteardownincluder-71" class="toc-link toc-h3">SetupTeardownIncluder</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-72" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-73" class="toc-link toc-h1">Comentarios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#los-comentarios-no-compensan-el-codigo-incorrecto-74" class="toc-link toc-h3">Los comentarios no compensan el c√≥digo incorrecto</a>
                    </li>
                    <li class="toc-item">
                        <a href="#explicarse-en-el-codigo-75" class="toc-link toc-h3">Explicarse en el c√≥digo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-de-calidad-76" class="toc-link toc-h3">Comentarios de calidad</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-legales-77" class="toc-link toc-h3">Comentarios legales</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-informativos-78" class="toc-link toc-h3">Comentarios informativos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#explicar-la-intencion-79" class="toc-link toc-h3">Explicar la intenci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#clarificacion-80" class="toc-link toc-h3">Clarificaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#advertir-de-las-consecuencias-81" class="toc-link toc-h3">Advertir de las consecuencias</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-todo-82" class="toc-link toc-h3">Comentarios TODO</a>
                    </li>
                    <li class="toc-item">
                        <a href="#amplificacion-83" class="toc-link toc-h3">Amplificaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#javadoc-en-api-publicas-84" class="toc-link toc-h3">Javadoc en API p√∫blicas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-incorrectos-85" class="toc-link toc-h3">Comentarios incorrectos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#balbucear-86" class="toc-link toc-h3">Balbucear</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-redundantes-87" class="toc-link toc-h3">Comentarios redundantes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-confusos-88" class="toc-link toc-h3">Comentarios confusos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-obligatorios-89" class="toc-link toc-h3">Comentarios obligatorios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-periodicos-90" class="toc-link toc-h3">Comentarios peri√≥dicos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-sobrantes-91" class="toc-link toc-h3">Comentarios sobrantes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-sobrantes-espeluznantes-92" class="toc-link toc-h3">Comentarios sobrantes espeluznantes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#no-usar-comentarios-si-se-puede-usar-una-funcion-o-93" class="toc-link toc-h3">No usar comentarios si se puede usar una funci√≥n o una</a>
                    </li>
                    <li class="toc-item">
                        <a href="#variable-94" class="toc-link toc-h3">variable</a>
                    </li>
                    <li class="toc-item">
                        <a href="#marcadores-de-posicion-95" class="toc-link toc-h3">Marcadores de posici√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-de-llave-de-cierre-96" class="toc-link toc-h3">Comentarios de llave de cierre</a>
                    </li>
                    <li class="toc-item">
                        <a href="#asignaciones-y-menciones-97" class="toc-link toc-h3">Asignaciones y menciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#codigo-comentado-98" class="toc-link toc-h3">C√≥digo comentado</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-html-99" class="toc-link toc-h3">Comentarios HTML</a>
                    </li>
                    <li class="toc-item">
                        <a href="#informacion-no-local-100" class="toc-link toc-h3">Informaci√≥n no local</a>
                    </li>
                    <li class="toc-item">
                        <a href="#demasiada-informacion-101" class="toc-link toc-h3">Demasiada informaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conexiones-no-evidentes-102" class="toc-link toc-h3">Conexiones no evidentes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#encabezados-de-funcion-103" class="toc-link toc-h3">Encabezados de funci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#javadocs-en-codigo-no-publico-104" class="toc-link toc-h3">Javadocs en c√≥digo no p√∫blico</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ejemplo-105" class="toc-link toc-h3">Ejemplo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-106" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#formato-107" class="toc-link toc-h1">Formato</a>
                    </li>
                    <li class="toc-item">
                        <a href="#la-funcion-del-formato-108" class="toc-link toc-h3">La funci√≥n del formato</a>
                    </li>
                    <li class="toc-item">
                        <a href="#formato-vertical-109" class="toc-link toc-h3">Formato vertical</a>
                    </li>
                    <li class="toc-item">
                        <a href="#la-metafora-del-periodico-110" class="toc-link toc-h3">La met√°fora del peri√≥dico</a>
                    </li>
                    <li class="toc-item">
                        <a href="#apertura-vertical-entre-conceptos-111" class="toc-link toc-h3">Apertura vertical entre conceptos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#densidad-vertical-112" class="toc-link toc-h3">Densidad vertical</a>
                    </li>
                    <li class="toc-item">
                        <a href="#distancia-vertical-113" class="toc-link toc-h3">Distancia vertical</a>
                    </li>
                    <li class="toc-item">
                        <a href="#orden-vertical-114" class="toc-link toc-h3">Orden vertical</a>
                    </li>
                    <li class="toc-item">
                        <a href="#formato-horizontal-115" class="toc-link toc-h3">Formato horizontal</a>
                    </li>
                    <li class="toc-item">
                        <a href="#apertura-y-densidad-horizontal-116" class="toc-link toc-h3">Apertura y densidad horizontal</a>
                    </li>
                    <li class="toc-item">
                        <a href="#alineacion-horizontal-117" class="toc-link toc-h3">Alineaci√≥n horizontal</a>
                    </li>
                    <li class="toc-item">
                        <a href="#sangrado-118" class="toc-link toc-h3">Sangrado</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ambitos-ficticios-119" class="toc-link toc-h3">√Åmbitos ficticios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#reglas-de-equipo-120" class="toc-link toc-h3">Reglas de equipo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#reglas-de-formato-de-uncle-bob-121" class="toc-link toc-h3">Reglas de formato de Uncle Bob</a>
                    </li>
                    <li class="toc-item">
                        <a href="#objetos-y-estructuras-de-datos-122" class="toc-link toc-h1">Objetos y estructuras de datos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#abstraccion-de-datos-123" class="toc-link toc-h3">Abstracci√≥n de datos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#antisimetria-de-datos-y-objetos-124" class="toc-link toc-h3">Antisimetr√≠a de datos y objetos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#la-ley-de-demeter-125" class="toc-link toc-h3">La ley de Demeter</a>
                    </li>
                    <li class="toc-item">
                        <a href="#choque-de-trenes-126" class="toc-link toc-h3">Choque de trenes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#hibridos-127" class="toc-link toc-h3">H√≠bridos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ocultar-la-estructura-128" class="toc-link toc-h3">Ocultar la estructura</a>
                    </li>
                    <li class="toc-item">
                        <a href="#objetos-de-transferencia-de-datos-129" class="toc-link toc-h3">Objetos de transferencia de datos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#registro-activo-130" class="toc-link toc-h3">Registro activo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-131" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-132" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#procesar-errores-133" class="toc-link toc-h1">Procesar errores</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-excepciones-en-lugar-de-codigos-devueltos-134" class="toc-link toc-h3">Usar excepciones en lugar de c√≥digos devueltos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#crear-primero-la-instruccion-try-catch-finally-135" class="toc-link toc-h3">Crear primero la instrucci√≥n try-catch-finally</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-excepciones-sin-comprobar-136" class="toc-link toc-h3">Usar excepciones sin comprobar</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ofrecer-contexto-junto-a-las-excepciones-137" class="toc-link toc-h3">Ofrecer contexto junto a las excepciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#definir-clases-de-excepcion-de-acuerdo-a-las-neces-138" class="toc-link toc-h3">Definir clases de excepci√≥n de acuerdo a las necesidades</a>
                    </li>
                    <li class="toc-item">
                        <a href="#del-invocador-139" class="toc-link toc-h3">del invocador</a>
                    </li>
                    <li class="toc-item">
                        <a href="#definir-el-flujo-normal-140" class="toc-link toc-h3">Definir el flujo normal</a>
                    </li>
                    <li class="toc-item">
                        <a href="#no-devolver-null-141" class="toc-link toc-h3">No devolver Null</a>
                    </li>
                    <li class="toc-item">
                        <a href="#no-pasar-null-142" class="toc-link toc-h3">No pasar Null</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-143" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-144" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#limites-145" class="toc-link toc-h1">L√≠mites</a>
                    </li>
                    <li class="toc-item">
                        <a href="#utilizar-codigo-de-terceros-146" class="toc-link toc-h3">Utilizar c√≥digo de terceros</a>
                    </li>
                    <li class="toc-item">
                        <a href="#explorar-y-aprender-limites-147" class="toc-link toc-h3">Explorar y aprender l√≠mites</a>
                    </li>
                    <li class="toc-item">
                        <a href="#aprender-log4j-148" class="toc-link toc-h3">Aprender log4j</a>
                    </li>
                    <li class="toc-item">
                        <a href="#las-pruebas-de-aprendizaje-son-algo-mas-que-gratui-149" class="toc-link toc-h3">Las pruebas de aprendizaje son algo m√°s que gratuitas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-codigo-que-todavia-no-existe-150" class="toc-link toc-h3">Usar c√≥digo que todav√≠a no existe</a>
                    </li>
                    <li class="toc-item">
                        <a href="#limites-limpios-151" class="toc-link toc-h3">L√≠mites limpios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-152" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#pruebas-de-unidad-153" class="toc-link toc-h1">Pruebas de unidad</a>
                    </li>
                    <li class="toc-item">
                        <a href="#las-tres-leyes-del-dgp-154" class="toc-link toc-h3">Las tres leyes del DGP</a>
                    </li>
                    <li class="toc-item">
                        <a href="#realizar-pruebas-limpias-155" class="toc-link toc-h3">Realizar pruebas limpias</a>
                    </li>
                    <li class="toc-item">
                        <a href="#las-pruebas-propician-posibilidades-156" class="toc-link toc-h3">Las pruebas propician posibilidades</a>
                    </li>
                    <li class="toc-item">
                        <a href="#pruebas-limpias-157" class="toc-link toc-h3">Pruebas limpias</a>
                    </li>
                    <li class="toc-item">
                        <a href="#lenguaje-de-pruebas-especifico-del-dominio-158" class="toc-link toc-h3">Lenguaje de pruebas espec√≠fico del dominio</a>
                    </li>
                    <li class="toc-item">
                        <a href="#un-estandar-dual-159" class="toc-link toc-h3">Un est√°ndar dual</a>
                    </li>
                    <li class="toc-item">
                        <a href="#una-afirmacion-por-prueba-160" class="toc-link toc-h3">Una afirmaci√≥n por prueba</a>
                    </li>
                    <li class="toc-item">
                        <a href="#un-solo-concepto-por-prueba-161" class="toc-link toc-h3">Un solo concepto por prueba</a>
                    </li>
                    <li class="toc-item">
                        <a href="#first-162" class="toc-link toc-h3">F.I.R.S.T.</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-163" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-164" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#clases-165" class="toc-link toc-h1">Clases</a>
                    </li>
                    <li class="toc-item">
                        <a href="#organizacion-de-clases-166" class="toc-link toc-h3">Organizaci√≥n de clases</a>
                    </li>
                    <li class="toc-item">
                        <a href="#encapsulacion-167" class="toc-link toc-h3">Encapsulaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#las-clases-deben-ser-de-tamano-reducido-168" class="toc-link toc-h3">Las clases deben ser de tama√±o reducido</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-principio-de-responsabilidad-unica-169" class="toc-link toc-h3">El Principio de responsabilidad √∫nica</a>
                    </li>
                    <li class="toc-item">
                        <a href="#cohesion-170" class="toc-link toc-h3">Cohesi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#mantener-resultados-consistentes-en-muchas-clases--171" class="toc-link toc-h3">Mantener resultados consistentes en muchas clases de</a>
                    </li>
                    <li class="toc-item">
                        <a href="#tamano-reducido-172" class="toc-link toc-h3">tama√±o reducido</a>
                    </li>
                    <li class="toc-item">
                        <a href="#organizar-los-cambios-173" class="toc-link toc-h3">Organizar los cambios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#aislarnos-de-los-cambios-174" class="toc-link toc-h3">Aislarnos de los cambios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-175" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#sistemas-176" class="toc-link toc-h1">Sistemas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#como-construir-una-ciudad-177" class="toc-link toc-h3">C√≥mo construir una ciudad</a>
                    </li>
                    <li class="toc-item">
                        <a href="#separar-la-construccion-de-un-sistema-de-su-uso-178" class="toc-link toc-h3">Separar la construcci√≥n de un sistema de su uso</a>
                    </li>
                    <li class="toc-item">
                        <a href="#separar-main-179" class="toc-link toc-h3">Separar Main</a>
                    </li>
                    <li class="toc-item">
                        <a href="#factorias-180" class="toc-link toc-h3">Factor√≠as</a>
                    </li>
                    <li class="toc-item">
                        <a href="#inyectar-dependencias-181" class="toc-link toc-h3">Inyectar dependencias</a>
                    </li>
                    <li class="toc-item">
                        <a href="#evolucionar-182" class="toc-link toc-h3">Evolucionar</a>
                    </li>
                    <li class="toc-item">
                        <a href="#aspectos-transversales-183" class="toc-link toc-h3">Aspectos transversales</a>
                    </li>
                    <li class="toc-item">
                        <a href="#proxies-de-java-184" class="toc-link toc-h3">Proxies de Java</a>
                    </li>
                    <li class="toc-item">
                        <a href="#estructuras-aop-java-puras-185" class="toc-link toc-h3">Estructuras AOP Java puras</a>
                    </li>
                    <li class="toc-item">
                        <a href="#aspectos-de-aspectj-186" class="toc-link toc-h3">Aspectos de AspectJ</a>
                    </li>
                    <li class="toc-item">
                        <a href="#pruebas-de-unidad-de-la-arquitectura-del-sistema-187" class="toc-link toc-h3">Pruebas de unidad de la arquitectura del sistema</a>
                    </li>
                    <li class="toc-item">
                        <a href="#optimizar-la-toma-de-decisiones-188" class="toc-link toc-h3">Optimizar la toma de decisiones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#usar-estandares-cuando-anadan-un-valor-demostrable-189" class="toc-link toc-h3">Usar est√°ndares cuando a√±adan un valor demostrable</a>
                    </li>
                    <li class="toc-item">
                        <a href="#los-sistemas-necesitan-lenguajes-especificos-del-d-190" class="toc-link toc-h3">Los sistemas necesitan lenguajes espec√≠ficos del dominio</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-191" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-192" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#emergencia-193" class="toc-link toc-h1">Emergencia</a>
                    </li>
                    <li class="toc-item">
                        <a href="#limpieza-a-traves-de-disenos-emergentes-194" class="toc-link toc-h3">Limpieza a trav√©s de dise√±os emergentes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#primera-regla-del-diseno-sencillo-ejecutar-todas-l-195" class="toc-link toc-h3">Primera regla del dise√±o sencillo: Ejecutar todas las</a>
                    </li>
                    <li class="toc-item">
                        <a href="#pruebas-196" class="toc-link toc-h3">pruebas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#reglas-2-a-4-del-diseno-sencillo-refactorizar-197" class="toc-link toc-h3">Reglas 2 a 4 del dise√±o sencillo: Refactorizar</a>
                    </li>
                    <li class="toc-item">
                        <a href="#eliminar-duplicados-198" class="toc-link toc-h3">Eliminar duplicados</a>
                    </li>
                    <li class="toc-item">
                        <a href="#expresividad-199" class="toc-link toc-h3">Expresividad</a>
                    </li>
                    <li class="toc-item">
                        <a href="#clases-y-metodos-minimos-200" class="toc-link toc-h3">Clases y m√©todos m√≠nimos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-201" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-202" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#concurrencia-203" class="toc-link toc-h1">Concurrencia</a>
                    </li>
                    <li class="toc-item">
                        <a href="#por-que-concurrencia-204" class="toc-link toc-h3">¬øPor qu√© concurrencia?</a>
                    </li>
                    <li class="toc-item">
                        <a href="#mitos-e-imprecisiones-205" class="toc-link toc-h3">Mitos e imprecisiones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#desafios-206" class="toc-link toc-h3">Desaf√≠os</a>
                    </li>
                    <li class="toc-item">
                        <a href="#principios-de-defensa-de-la-concurrencia-207" class="toc-link toc-h3">Principios de defensa de la concurrencia</a>
                    </li>
                    <li class="toc-item">
                        <a href="#principio-de-responsabilidad-unica-srp-208" class="toc-link toc-h3">Principio de responsabilidad √∫nica (SRP)</a>
                    </li>
                    <li class="toc-item">
                        <a href="#corolario-limitar-el-ambito-de-los-datos-209" class="toc-link toc-h3">Corolario: Limitar el √°mbito de los datos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#corolario-usar-copias-de-datos-210" class="toc-link toc-h3">Corolario: Usar copias de datos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#corolario-los-procesos-deben-ser-independientes-211" class="toc-link toc-h3">Corolario: Los procesos deben ser independientes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conocer-las-bibliotecas-212" class="toc-link toc-h3">Conocer las bibliotecas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#colecciones-compatibles-con-procesos-213" class="toc-link toc-h3">Colecciones compatibles con procesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conocer-los-modelos-de-ejecucion-214" class="toc-link toc-h3">Conocer los modelos de ejecuci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#productor-consumidor-215" class="toc-link toc-h3">Productor-Consumidor</a>
                    </li>
                    <li class="toc-item">
                        <a href="#lectores-escritores-216" class="toc-link toc-h3">Lectores-Escritores</a>
                    </li>
                    <li class="toc-item">
                        <a href="#la-cena-de-los-filosofos-217" class="toc-link toc-h3">La cena de los fil√≥sofos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#dependencias-entre-metodos-sincronizados-218" class="toc-link toc-h3">Dependencias entre m√©todos sincronizados</a>
                    </li>
                    <li class="toc-item">
                        <a href="#reducir-el-tamano-de-las-secciones-sincronizadas-219" class="toc-link toc-h3">Reducir el tama√±o de las secciones sincronizadas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#crear-codigo-de-cierre-correcto-es-complicado-220" class="toc-link toc-h3">Crear c√≥digo de cierre correcto es complicado</a>
                    </li>
                    <li class="toc-item">
                        <a href="#probar-codigo-con-procesos-221" class="toc-link toc-h3">Probar c√≥digo con procesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#considerar-los-fallos-como-posibles-problemas-de-l-222" class="toc-link toc-h3">Considerar los fallos como posibles problemas de los</a>
                    </li>
                    <li class="toc-item">
                        <a href="#procesos-223" class="toc-link toc-h3">procesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conseguir-que-primero-funcione-el-codigo-sin-proce-224" class="toc-link toc-h3">Conseguir que primero funcione el c√≥digo sin procesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-codigo-con-procesos-se-debe-poder-conectar-a-ot-225" class="toc-link toc-h3">El c√≥digo con procesos se debe poder conectar a otros</a>
                    </li>
                    <li class="toc-item">
                        <a href="#elementos-226" class="toc-link toc-h3">elementos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-codigo-con-procesos-debe-ser-modificable-227" class="toc-link toc-h3">El c√≥digo con procesos debe ser modificable</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ejecutar-con-mas-procesos-que-procesadores-228" class="toc-link toc-h3">Ejecutar con m√°s procesos que procesadores</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ejecutar-en-diferentes-plataformas-229" class="toc-link toc-h3">Ejecutar en diferentes plataformas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#disenar-el-codigo-para-probar-y-forzar-fallos-230" class="toc-link toc-h3">Dise√±ar el c√≥digo para probar y forzar fallos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#manual-231" class="toc-link toc-h3">Manual</a>
                    </li>
                    <li class="toc-item">
                        <a href="#automatica-232" class="toc-link toc-h3">Autom√°tica</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-233" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-234" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#refinamiento-sucesivo-235" class="toc-link toc-h1">Refinamiento sucesivo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#implementacion-de-args-236" class="toc-link toc-h3">Implementaci√≥n de Args</a>
                    </li>
                    <li class="toc-item">
                        <a href="#como-se-ha-realizado-237" class="toc-link toc-h3">C√≥mo se ha realizado</a>
                    </li>
                    <li class="toc-item">
                        <a href="#args-el-primer-borrador-238" class="toc-link toc-h3">Args: El primer borrador</a>
                    </li>
                    <li class="toc-item">
                        <a href="#entonces-me-detuve-239" class="toc-link toc-h3">Entonces me detuve</a>
                    </li>
                    <li class="toc-item">
                        <a href="#sobre-el-incrementalismo-240" class="toc-link toc-h3">Sobre el incrementalismo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#argumentos-de-cadena-241" class="toc-link toc-h3">Argumentos de cadena</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-242" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#aspectos-internos-de-junit-243" class="toc-link toc-h1">Aspectos internos de JUnit</a>
                    </li>
                    <li class="toc-item">
                        <a href="#la-estructura-junit-244" class="toc-link toc-h3">La estructura JUnit</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-245" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#refactorizacion-de-serialdate-246" class="toc-link toc-h1">Refactorizaci√≥n de SerialDate</a>
                    </li>
                    <li class="toc-item">
                        <a href="#primero-conseguir-que-funcione-247" class="toc-link toc-h3">Primero, conseguir que funcione</a>
                    </li>
                    <li class="toc-item">
                        <a href="#hacer-que-sea-correcta-248" class="toc-link toc-h3">Hacer que sea correcta</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-249" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-250" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#sintomas-y-heuristica-251" class="toc-link toc-h1">S√≠ntomas y heur√≠stica</a>
                    </li>
                    <li class="toc-item">
                        <a href="#comentarios-252" class="toc-link toc-h3">Comentarios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#c1-informacion-inapropiada-253" class="toc-link toc-h3">C1: Informaci√≥n inapropiada</a>
                    </li>
                    <li class="toc-item">
                        <a href="#c2-comentario-obsoleto-254" class="toc-link toc-h3">C2: Comentario obsoleto</a>
                    </li>
                    <li class="toc-item">
                        <a href="#c3-comentario-redundante-255" class="toc-link toc-h3">C3: Comentario redundante</a>
                    </li>
                    <li class="toc-item">
                        <a href="#c4-comentario-mal-escrito-256" class="toc-link toc-h3">C4: Comentario mal escrito</a>
                    </li>
                    <li class="toc-item">
                        <a href="#c5-codigo-comentado-257" class="toc-link toc-h3">C5: C√≥digo comentado</a>
                    </li>
                    <li class="toc-item">
                        <a href="#entorno-258" class="toc-link toc-h3">Entorno</a>
                    </li>
                    <li class="toc-item">
                        <a href="#e1-la-generacion-requiere-mas-de-un-paso-259" class="toc-link toc-h3">E1: La generaci√≥n requiere m√°s de un paso</a>
                    </li>
                    <li class="toc-item">
                        <a href="#e2-las-pruebas-requieren-mas-de-un-paso-260" class="toc-link toc-h3">E2: Las pruebas requieren m√°s de un paso</a>
                    </li>
                    <li class="toc-item">
                        <a href="#funciones-261" class="toc-link toc-h3">Funciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#f1-demasiados-argumentos-262" class="toc-link toc-h3">F1: Demasiados argumentos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#f2-argumentos-de-salida-263" class="toc-link toc-h3">F2: Argumentos de salida</a>
                    </li>
                    <li class="toc-item">
                        <a href="#f3-argumentos-de-indicador-264" class="toc-link toc-h3">F3: Argumentos de indicador</a>
                    </li>
                    <li class="toc-item">
                        <a href="#f4-funcion-muerta-265" class="toc-link toc-h3">F4: Funci√≥n muerta</a>
                    </li>
                    <li class="toc-item">
                        <a href="#general-266" class="toc-link toc-h3">General</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g1-varios-lenguajes-en-un-archivo-de-codigo-267" class="toc-link toc-h3">G1: Varios lenguajes en un archivo de c√≥digo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g2-comportamiento-evidente-no-implementado-268" class="toc-link toc-h3">G2: Comportamiento evidente no implementado</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g3-comportamiento-incorrecto-en-los-limites-269" class="toc-link toc-h3">G3: Comportamiento incorrecto en los l√≠mites</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g4-medidas-de-seguridad-canceladas-270" class="toc-link toc-h3">G4: Medidas de seguridad canceladas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g5-duplicacion-271" class="toc-link toc-h3">G5: Duplicaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g6-codigo-en-un-nivel-de-abstraccion-incorrecto-272" class="toc-link toc-h3">G6: C√≥digo en un nivel de abstracci√≥n incorrecto</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g7-clases-base-que-dependen-de-sus-variantes-273" class="toc-link toc-h3">G7: Clases base que dependen de sus variantes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g8-exceso-de-informacion-274" class="toc-link toc-h3">G8: Exceso de informaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g9-codigo-muerto-275" class="toc-link toc-h3">G9: C√≥digo muerto</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g10-separacion-vertical-276" class="toc-link toc-h3">G10: Separaci√≥n vertical</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g11-incoherencia-277" class="toc-link toc-h3">G11: Incoherencia</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g12-desorden-278" class="toc-link toc-h3">G12: Desorden</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g13-conexiones-artificiales-279" class="toc-link toc-h3">G13: Conexiones artificiales</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g14-envidia-de-las-caracteristicas-280" class="toc-link toc-h3">G14: Envidia de las caracter√≠sticas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g15-argumentos-de-selector-281" class="toc-link toc-h3">G15: Argumentos de selector</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g16-intencion-desconocida-282" class="toc-link toc-h3">G16: Intenci√≥n desconocida</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g17-responsabilidad-desubicada-283" class="toc-link toc-h3">G17: Responsabilidad desubicada</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g18-elementos-estaticos-incorrectos-284" class="toc-link toc-h3">G18: Elementos est√°ticos incorrectos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g19-usar-variables-explicativas-285" class="toc-link toc-h3">G19: Usar variables explicativas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g20-los-nombres-de-funcion-deben-indicar-lo-que-286" class="toc-link toc-h3">G20: Los nombres de funci√≥n deben indicar lo que</a>
                    </li>
                    <li class="toc-item">
                        <a href="#hacen-287" class="toc-link toc-h3">hacen</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g21-comprender-el-algoritmo-288" class="toc-link toc-h3">G21: Comprender el algoritmo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g22-convertir-dependencias-logicas-en-fisicas-289" class="toc-link toc-h3">G22: Convertir dependencias l√≥gicas en f√≠sicas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g23-polimorfismo-antes-que-ifelse-o-switchcase-290" class="toc-link toc-h3">G23: Polimorfismo antes que If/Else o Switch/Case</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g24-seguir-las-convenciones-estandar-291" class="toc-link toc-h3">G24: Seguir las convenciones est√°ndar</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g25-sustituir-numeros-magicos-por-constantes-con-292" class="toc-link toc-h3">G25: Sustituir n√∫meros m√°gicos por constantes con</a>
                    </li>
                    <li class="toc-item">
                        <a href="#nombre-293" class="toc-link toc-h3">nombre</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g26-precision-294" class="toc-link toc-h3">G26: Precisi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g27-estructura-sobre-convencion-295" class="toc-link toc-h3">G27: Estructura sobre convenci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g28-encapsular-condicionales-296" class="toc-link toc-h3">G28: Encapsular condicionales</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g29-evitar-condicionales-negativas-297" class="toc-link toc-h3">G29: Evitar condicionales negativas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g30-las-funciones-solo-deben-hacer-una-cosa-298" class="toc-link toc-h3">G30: Las funciones s√≥lo deben hacer una cosa</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g31-conexiones-temporales-ocultas-299" class="toc-link toc-h3">G31: Conexiones temporales ocultas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g32-evitar-la-arbitrariedad-300" class="toc-link toc-h3">G32: Evitar la arbitrariedad</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g33-encapsular-condiciones-de-limite-301" class="toc-link toc-h3">G33: Encapsular condiciones de l√≠mite</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g34-las-funciones-solo-deben-descender-un-nivel-de-302" class="toc-link toc-h3">G34: Las funciones s√≥lo deben descender un nivel de</a>
                    </li>
                    <li class="toc-item">
                        <a href="#abstraccion-303" class="toc-link toc-h3">abstracci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g35-mantener-los-datos-configurables-en-los-nivele-304" class="toc-link toc-h3">G35: Mantener los datos configurables en los niveles</a>
                    </li>
                    <li class="toc-item">
                        <a href="#superiores-305" class="toc-link toc-h3">superiores</a>
                    </li>
                    <li class="toc-item">
                        <a href="#g36-evitar-desplazamientos-transitivos-306" class="toc-link toc-h3">G36: Evitar desplazamientos transitivos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#java-307" class="toc-link toc-h3">Java</a>
                    </li>
                    <li class="toc-item">
                        <a href="#j1-evitar-extensas-listas-de-importacion-mediante--308" class="toc-link toc-h3">J1: Evitar extensas listas de importaci√≥n mediante el</a>
                    </li>
                    <li class="toc-item">
                        <a href="#uso-de-comodines-309" class="toc-link toc-h3">uso de comodines</a>
                    </li>
                    <li class="toc-item">
                        <a href="#j2-no-heredar-constantes-310" class="toc-link toc-h3">J2: No heredar constantes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#j3-constantes-frente-a-enumeraciones-311" class="toc-link toc-h3">J3: Constantes frente a enumeraciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#nombres-312" class="toc-link toc-h3">Nombres</a>
                    </li>
                    <li class="toc-item">
                        <a href="#n1-elegir-nombres-descriptivos-313" class="toc-link toc-h3">N1: Elegir nombres descriptivos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#n2-elegir-nombres-en-el-nivel-correcto-de-abstracc-314" class="toc-link toc-h3">N2: Elegir nombres en el nivel correcto de abstracci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#n3-usar-nomenclatura-estandar-siempre-que-sea-315" class="toc-link toc-h3">N3: Usar nomenclatura est√°ndar siempre que sea</a>
                    </li>
                    <li class="toc-item">
                        <a href="#posible-316" class="toc-link toc-h3">posible</a>
                    </li>
                    <li class="toc-item">
                        <a href="#n4-nombres-inequivocos-317" class="toc-link toc-h3">N4: Nombres inequ√≠vocos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#n5-usar-nombres-extensos-para-ambitos-extensos-318" class="toc-link toc-h3">N5: Usar nombres extensos para √°mbitos extensos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#n6-evitar-codificaciones-319" class="toc-link toc-h3">N6: Evitar codificaciones</a>
                    </li>
                    <li class="toc-item">
                        <a href="#n7-los-nombres-deben-describir-efectos-secundarios-320" class="toc-link toc-h3">N7: Los nombres deben describir efectos secundarios</a>
                    </li>
                    <li class="toc-item">
                        <a href="#pruebas-test-321" class="toc-link toc-h3">Pruebas (Test)</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t1-pruebas-insuficientes-322" class="toc-link toc-h3">T1: Pruebas insuficientes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t2-usar-una-herramienta-de-cobertura-323" class="toc-link toc-h3">T2: Usar una herramienta de cobertura</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t3-no-ignorar-pruebas-triviales-324" class="toc-link toc-h3">T3: No ignorar pruebas triviales</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t4-una-prueba-ignorada-es-una-pregunta-sobre-una-325" class="toc-link toc-h3">T4: Una prueba ignorada es una pregunta sobre una</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ambiguedad-326" class="toc-link toc-h3">ambig√ºedad</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t5-probar-condiciones-de-limite-327" class="toc-link toc-h3">T5: Probar condiciones de l√≠mite</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t6-probar-de-forma-exhaustiva-junto-a-los-errores-328" class="toc-link toc-h3">T6: Probar de forma exhaustiva junto a los errores</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t7-los-patrones-de-fallo-son-reveladores-329" class="toc-link toc-h3">T7: Los patrones de fallo son reveladores</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t8-los-patrones-de-cobertura-de-pruebas-pueden-ser-330" class="toc-link toc-h3">T8: Los patrones de cobertura de pruebas pueden ser</a>
                    </li>
                    <li class="toc-item">
                        <a href="#reveladores-331" class="toc-link toc-h3">reveladores</a>
                    </li>
                    <li class="toc-item">
                        <a href="#t9-las-pruebas-deben-ser-rapidas-332" class="toc-link toc-h3">T9: Las pruebas deben ser r√°pidas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-333" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bibliografia-334" class="toc-link toc-h3">Bibliograf√≠a</a>
                    </li>
                    <li class="toc-item">
                        <a href="#apendice-a-335" class="toc-link toc-h1">Ap√©ndice A</a>
                    </li>
                    <li class="toc-item">
                        <a href="#concurrencia-ii-336" class="toc-link toc-h1">Concurrencia II</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ejemplo-clienteservidor-337" class="toc-link toc-h3">Ejemplo cliente/servidor</a>
                    </li>
                    <li class="toc-item">
                        <a href="#el-servidor-338" class="toc-link toc-h3">El servidor</a>
                    </li>
                    <li class="toc-item">
                        <a href="#anadir-subprocesos-339" class="toc-link toc-h3">A√±adir subprocesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#observaciones-del-servidor-340" class="toc-link toc-h3">Observaciones del servidor</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-341" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#posibles-rutas-de-ejecucion-342" class="toc-link toc-h3">Posibles rutas de ejecuci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#numero-de-rutas-343" class="toc-link toc-h3">N√∫mero de rutas</a>
                    </li>
                    <li class="toc-item">
                        <a href="#un-examen-mas-profundo-344" class="toc-link toc-h3">Un examen m√°s profundo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-345" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conocer-su-biblioteca-346" class="toc-link toc-h3">Conocer su biblioteca</a>
                    </li>
                    <li class="toc-item">
                        <a href="#la-estructura-executor-347" class="toc-link toc-h3">La estructura Executor</a>
                    </li>
                    <li class="toc-item">
                        <a href="#soluciones-no-bloqueantes-348" class="toc-link toc-h3">Soluciones no bloqueantes</a>
                    </li>
                    <li class="toc-item">
                        <a href="#clases-incompatibles-con-subprocesos-349" class="toc-link toc-h3">Clases incompatibles con subprocesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#las-dependencias-entre-metodos-pueden-afectar-al-350" class="toc-link toc-h3">Las dependencias entre m√©todos pueden afectar al</a>
                    </li>
                    <li class="toc-item">
                        <a href="#codigo-concurrente-351" class="toc-link toc-h3">c√≥digo concurrente</a>
                    </li>
                    <li class="toc-item">
                        <a href="#tolerar-el-fallo-352" class="toc-link toc-h3">Tolerar el fallo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bloqueo-basado-en-el-cliente-353" class="toc-link toc-h3">Bloqueo basado en el cliente</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bloqueo-basado-en-el-servidor-354" class="toc-link toc-h3">Bloqueo basado en el servidor</a>
                    </li>
                    <li class="toc-item">
                        <a href="#aumentar-la-produccion-355" class="toc-link toc-h3">Aumentar la producci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#calculo-de-produccion-de-un-solo-subproceso-356" class="toc-link toc-h3">C√°lculo de producci√≥n de un solo subproceso</a>
                    </li>
                    <li class="toc-item">
                        <a href="#calculo-de-produccion-con-varios-subprocesos-357" class="toc-link toc-h3">C√°lculo de producci√≥n con varios subprocesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bloqueo-mutuo-358" class="toc-link toc-h3">Bloqueo mutuo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#exclusion-mutua-359" class="toc-link toc-h3">Exclusi√≥n mutua</a>
                    </li>
                    <li class="toc-item">
                        <a href="#bloqueo-y-espera-360" class="toc-link toc-h3">Bloqueo y espera</a>
                    </li>
                    <li class="toc-item">
                        <a href="#no-expropiacion-361" class="toc-link toc-h3">No expropiaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#espera-circular-362" class="toc-link toc-h3">Espera circular</a>
                    </li>
                    <li class="toc-item">
                        <a href="#evitar-la-exclusion-mutua-363" class="toc-link toc-h3">Evitar la exclusi√≥n mutua</a>
                    </li>
                    <li class="toc-item">
                        <a href="#evitar-bloqueo-y-espera-364" class="toc-link toc-h3">Evitar bloqueo y espera</a>
                    </li>
                    <li class="toc-item">
                        <a href="#evitar-la-expropiacion-365" class="toc-link toc-h3">Evitar la expropiaci√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#evitar-la-espera-circular-366" class="toc-link toc-h3">Evitar la espera circular</a>
                    </li>
                    <li class="toc-item">
                        <a href="#probar-codigo-con-multiples-subprocesos-367" class="toc-link toc-h3">Probar c√≥digo con m√∫ltiples subprocesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#herramientas-para-probar-codigo-basado-en-368" class="toc-link toc-h3">Herramientas para probar c√≥digo basado en</a>
                    </li>
                    <li class="toc-item">
                        <a href="#subprocesos-369" class="toc-link toc-h3">subprocesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#conclusion-370" class="toc-link toc-h3">Conclusi√≥n</a>
                    </li>
                    <li class="toc-item">
                        <a href="#ejemplos-de-codigo-completos-371" class="toc-link toc-h3">Ejemplos de c√≥digo completos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#clienteservidor-sin-subprocesos-372" class="toc-link toc-h3">Cliente/Servidor sin subprocesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#clienteservidor-con-subprocesos-373" class="toc-link toc-h3">Cliente/Servidor con subprocesos</a>
                    </li>
                    <li class="toc-item">
                        <a href="#apendice-b-374" class="toc-link toc-h1">Ap√©ndice B</a>
                    </li>
                    <li class="toc-item">
                        <a href="#orgjfreedateserialdate-375" class="toc-link toc-h1">org.jfree.date.SerialDate</a>
                    </li>
                    <li class="toc-item">
                        <a href="#epilogo-376" class="toc-link toc-h1">Ep√≠logo</a>
                    </li>
                    <li class="toc-item">
                        <a href="#notas-377" class="toc-link toc-h1">Notas</a>
                    </li>
                </ul>
            </nav>
        </aside>
        
        <div class="overlay" id="overlay"></div>

        <main class="main-content">
            <header class="main-content-header">
                <h1 class="document-title">Documento Convertido</h1>
            </header>
            <hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Cada a√±o, se invierten innumerables horas y se pierden numerosos</p>
<p>recursos debido c√≥digo mal escrito, ralentizando el desarrollo,</p>
<p>disminuyendo la productividad, generando graves fallos incluso</p>
<p>pudiendo acabar con la organizaci√≥n o empresa.</p>
<p>El reconocido experto de software Robert C. Martin, junto con sus</p>
<p>colegas de Object Mentor, nos presentan sus √≥ptimas t√©cnicas y</p>
<p>metodolog√≠as √°giles para limpiar el c√≥digo sobre la marcha y crearlo</p>
<p>de forma correcta, de este modo mejorar√° como programador.</p>
<p>Esta obra se divide en tres partes. La primera describe los principios,</p>
<p>patrones y pr√°cticas para crear c√≥digo limpio. La segunda incluye</p>
<p>varios casos de estudio cuya complejidad va aumentando. Cada</p>
<p>ejemplo es un ejercicio de limpieza y transformaci√≥n de c√≥digo con</p>
<p>problemas. La tercera parte del libro contiene una lista de heur√≠stica y</p>
<p>s√≠ntomas de c√≥digo err√≥neo (smells) confeccionada al crear los casos</p>
<p>pr√°cticos. El resultado es una base de conocimientos que describe</p>
<p>c√≥mo pensamos cuando creamos, leemos y limpiamos c√≥digo.</p>
<p>Imprescindible para cualquier desarrollador, ingeniero de software,</p>
<p>director de proyectos, jefe de equipo analista de sistemas</p>
<p>interesado en crear c√≥digo de mejor calidad.</p>
<p>¬°El libro que todo programador debe leer!</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="robert-cecil-martin-0">Robert Cecil Martin</h3>
<h1 id="codigo-limpio-1">C√≥digo limpio</h1>
<p>Manual de estilo para el desarrollo √°gil de software</p>
<p>ePub r1.1</p>
<p>XcUiDi 21.03.2018</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>T√≠tulo original: Clean code: A handbook of agile software craftsmanship</p>
<p>Robert Cecil Martin, 2009</p>
<p>Traducci√≥n: Jos√© Luis G√≥mez Celador</p>
<p>Ilustraciones: Jeniffer Kohnke &amp; Angela Brooks</p>
<p>Editor digital: XcUiDi</p>
<p>Colaborador: Mario J. C. (PDF-Espa√±ol)</p>
<p>ePub base r1.2</p>
<p>Este libro se ha maquetado siguiendo los est√°ndares de calidad de</p>
<p>www.epublibre.org. La p√°gina, sus editores, no obtienen ning√∫n tipo de</p>
<p>beneficio econ√≥mico por ello. Si ha llegado a tu poder desde otra web debes saber</p>
<p>que seguramente sus propietarios s√≠ obtengan ingresos publicitarios mediante</p>
<p>archivos como este</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Para Ann Marie: El verdadero amor de mi vida.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="agradecimientos-2">Agradecimientos</h1>
<p>Me gustar√≠a dar las gracias a mis dos artistas, Jeniffer Kohnke y Angela</p>
<p>Brooks. Jennifer es la encargada de las impresionantes ilustraciones del inicio</p>
<p>de cada cap√≠tulo y tambi√©n de los retratos de Kent Beck, Ward Cunningham,</p>
<p>Bjarne Stroustrup, Ron Jeffries, Grady Booch, Dave Thomas, Michael</p>
<p>Feathers y el m√≠o propio.</p>
<p>Angela se encarga de las ilustraciones internas de los cap√≠tulos. Ha</p>
<p>realizado muchos dibujos para m√≠ en los √∫ltimos a√±os, incluidos muchos de</p>
<p>los del libro Agile Software Development: Principles, Patterns, and</p>
<p>Practices . Tambi√©n es mi primog√©nita.</p>
<p>Un agradecimiento especial a los revisores Bob Bogetti, George Bullock,</p>
<p>Jeffrey Overbey y especialmente Matt Heusser. Han sido incre√≠bles. Han sido</p>
<p>inmisericordes. Han sido minuciosos. Me han forzado al m√°ximo para</p>
<p>realizar las mejoras necesarias.</p>
<p>Gracias a mi editor, Chris Guzikowski, por su apoyo, aliento y amistad.</p>
<p>Gracias a todo el personal de la editorial, incluida Raina Chrobak, que se</p>
<p>encarg√≥ de que fuera honesto y cumpliera los plazos.</p>
<p>Gracias a Micah Martin y a todos los de 8th Light (www.8thlight.com)</p>
<p>por sus cr√≠ticas y su apoyo.</p>
<p>Gracias a todos los Object Mentor, pasados, presentes y futuros, incluidos</p>
<p>Bob Koss, Michael Feathers, Michael Hill, Erik Meade, Jeff Langr, Pascal</p>
<p>Roy, David Farber, Brett Schuchert, Dean Wampler, Tim Ottinger, Dave</p>
<p>Thomas, James Grenning, Brian Button, Ron Jeffries, Lowell Lindstrom,</p>
<p>Angelique Martin, Cindy Sprague, Libby Ottinger, Joleen Craig, Janice</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Brown, Susan Rosso y el resto.</p>
<p>Gracias Jim Newkirk, mi amigo y socio, que me ha ense√±ado m√°s de lo</p>
<p>que cree. Mi agradecimiento Kent Beck, Martin Fowler, Ward</p>
<p>Cunningham, Bjarne Stroustrup, Grady Booch todos mis mentores,</p>
<p>compatriotas y colegas. Gracias a John Vlissides por estar ah√≠ cuando lo</p>
<p>necesitaba. Gracias a todos los de Zebra por permitirme despotricar sobre la</p>
<p>extensi√≥n que debe tener una funci√≥n.</p>
<p>Y, por √∫ltimo, darle las gracias por leer estos agradecimientos.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="prologo-3">Pr√≥logo</h1>
<p>Una de nuestras golosinas preferidas en Dinamarca es Ga-Jol , con un fuerte</p>
<p>sabor regaliz, que constituye un complemento perfecto para nuestro</p>
<p>h√∫medo y fr√≠o clima. Parte del encanto de Ga-Jol para los daneses es la frase</p>
<p>que suele incluir en el envoltorio. Esta ma√±ana compr√© un paquete de dos y</p>
<p>me encontr√© con este antiguo dicho dan√©s:</p>
<p>√Ürlighed i sm√• ting er ikke nogen lille ting.</p>
<p>¬´La honestidad por las cosas peque√±as no es algo menor¬ª. Perfecto para</p>
<p>que lo que pensaba escribir. Las cosas peque√±as importan. Este libro trata</p>
<p>sobre humildes preocupaciones cuyo valor dista mucho de ser menor.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Dios est√° en los detalles , afirm√≥ el arquitecto Ludwig mies van der Rohe.</p>
<p>Esta cita recuerda argumentos contempor√°neos sobre el papel de la</p>
<p>arquitectura en el desarrollo de software , en especial en el universo √°gil. Bob</p>
<p>y yo hemos tenido esta conversaci√≥n muchas veces. Y s√≠, mies van der Rohe</p>
<p>se fijaba en la utilidad y la forma atemporal de la construcci√≥n que subyace a</p>
<p>las grandes creaciones arquitect√≥nicas. Por otra parte, seleccionaba</p>
<p>personalmente los pomos de todas las puertas de todas las casas que dise√±aba.</p>
<p>¬øPor qu√©? Porque las cosas peque√±as importan.</p>
<p>En nuestro interminable debate sobre TDD, Bob y yo coincidimos en que</p>
<p>la arquitectura del software desempe√±a una importante labor en el desarrollo,</p>
<p>aunque tenemos diferentes visiones de lo que esto significa. Estas diferencias</p>
<p>carecen de importancia, ya que podemos aceptar que los profesionales</p>
<p>responsables dedican parte de su tiempo a planificar un proyecto antes de</p>
<p>comenzarlo. Las nociones de dise√±o controlado √∫nicamente por pruebas y el</p>
<p>c√≥digo, propias de finales de la d√©cada de 1990, ya no son v√°lidas. Y la</p>
<p>atenci√≥n al detalle es un pilar fundamental de los profesionales, casi como</p>
<p>cualquier visi√≥n. Por un lado, la pr√°ctica en los detalles otorga dominio a los</p>
<p>profesionales, y aumenta su confianza para la pr√°ctica a mayor escala. Por</p>
<p>otra parte, el m√°s m√≠nimo fallo de construcci√≥n, una puerta que no cierre bien</p>
<p>o un baldos√≠n mal colocado, acaba con el encanto del todo. De eso se trata el</p>
<p>c√≥digo limpio.</p>
<p>Pero la arquitectura es s√≥lo una met√°fora del desarrollo de software y en</p>
<p>concreto de la parte del software que ofrece el producto inicial, de la misma</p>
<p>forma que un arquitecto entrega un edificio inmaculado. Hoy en d√≠a, el</p>
<p>objetivo es comercializar r√°pidamente los productos. Queremos que las</p>
<p>f√°bricas produzcan software pleno rendimiento. Se trata de f√°bricas</p>
<p>humanas, programadores que piensan, que sienten y que trabajan para crear</p>
<p>un producto. La met√°fora de la manufacturaci√≥n es incluso m√°s evidente en</p>
<p>este pensamiento. Los aspectos productivos de las f√°bricas de autom√≥viles</p>
<p>japonesas fueron una gran inspiraci√≥n para Serum.</p>
<p>Pero incluso en la industria automovil√≠stica, gran parte del trabajo no</p>
<p>radica en la fabricaci√≥n sino en el mantenimiento, o m√°s bien en c√≥mo</p>
<p>evitarlo. En el software , el 80 por 100 o m√°s de lo que hacemos se denomina</p>
<p>cuantitativamente mantenimiento, el acto de reparar. En lugar de optar por la</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>t√≠pica costumbre occidental de crear software de calidad, debemos pensar</p>
<p>como reparadores o mec√°nicos. ¬øQu√© piensan los directores japoneses de</p>
<p>todo esto?</p>
<p>En 1951, un enfoque de calidad denominado TPM ( Total Productive</p>
<p>Maintenance o Mantenimiento productivo total) apareci√≥ en escena. Se</p>
<p>centraba en el mantenimiento y no en la producci√≥n. Uno de los pilares de</p>
<p>TPM es el conjunto de principios denominados 5S, una serie de disciplinas.</p>
<p>Estos principios 5S son en realidad la base Lean, otro conocido t√©rmino en la</p>
<p>escena occidental, y cada vez m√°s presente en el mundo del software . Estos</p>
<p>principios no son opcionales. Como indica Uncle Bob, la pr√°ctica del</p>
<p>software correcto requiere disciplina. No siempre se trata de hacer, de</p>
<p>producir a la velocidad √≥ptima.</p>
<p>La filosof√≠a 5S incluye estos conceptos:</p>
<p>Seiri u organizaci√≥n : Es fundamental saber d√≥nde est√°n las cosas,</p>
<p>mediante enfoques como el uso de nombres correctos. ¬øCree que los</p>
<p>nombres de los identificadores no son relevantes? Lea los siguientes</p>
<p>cap√≠tulos.</p>
<p>Seiton o sistematizaci√≥n : Existe un antiguo dicho norteamericano: un</p>
<p>sitio para cada cosa y cada cosa en su sitio. Un fragmento de c√≥digo</p>
<p>debe estar donde esperamos encontrarlo; en caso contrario, refactorice</p>
<p>hasta conseguirlo.</p>
<p>Seiso o limpieza : Mantenga limpio el lugar de trabajo. ¬øQu√© dicen los</p>
<p>autores sobre inundar el c√≥digo de comentarios y l√≠neas que capturan</p>
<p>historias o deseos futuros? Elim√≠nelos.</p>
<p>Seiketsu o estandarizaci√≥n : El grupo decide c√≥mo mantener limpio el</p>
<p>lugar de trabajo. ¬øCree que este libro habla sobre tener un estilo de</p>
<p>c√≥digo coherente y una serie de pr√°cticas dentro del grupo? ¬øDe d√≥nde</p>
<p>provienen esos est√°ndares? Siga leyendo.</p>
<p>Shutsuke o disciplina : Significa ser disciplinado en la aplicaci√≥n de las</p>
<p>pr√°cticas y reflejarlas en el trabajo y aceptar los cambios.</p>
<p>Si acepta el reto, ha le√≠do bien, el reto, de leer y llevar a la pr√°ctica este</p>
<p>libro, podr√° comprender y apreciar el √∫ltimo punto. Aqu√≠ nos acercamos a la</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>ra√≠z de la profesionalidad responsable de una profesi√≥n que deber√≠a</p>
<p>preocuparse del ciclo vital de un producto. Al igual que mantenemos coches</p>
<p>y otras m√°quinas, el mantenimiento divisible, esperar a que surjan los errores,</p>
<p>es la excepci√≥n. Por el contrario, ascendemos un nivel: inspeccionamos</p>
<p>diariamente las m√°quinas y arreglamos los componentes gastados antes de</p>
<p>que se rompan, o cambiamos el aceite cada varios miles de kil√≥metros para</p>
<p>evitar problemas. En el c√≥digo, debemos refactorizar sin compasi√≥n. Puede</p>
<p>ascender otro nivel m√°s, como hizo el movimiento TPM hace 50 a√±os: crear</p>
<p>m√°quinas que se pueden mantener mejor. Crear c√≥digo legible es tan</p>
<p>importante como crear c√≥digo ejecutable. La pr√°ctica definitiva, que apareci√≥</p>
<p>en los c√≠rculos TPM en 1960, es la que se centra en introducir nuevas</p>
<p>m√°quinas sustituir las antiguas. Como Fred Brooks nos advirti√≥,</p>
<p>deber√≠amos rehacer el software cada siete a√±os para eliminar los problemas</p>
<p>latentes. Tendr√≠amos que actualizar este plazo por semanas, d√≠as e incluso</p>
<p>horas en lugar de a√±os. Ah√≠ es donde se encuentra el detalle.</p>
<p>El detalle tiene un gran poder, y es un enfoque vital humilde y profundo,</p>
<p>como es de esperar de cualquier enfoque de origen japon√©s. Pero no es s√≥lo la</p>
<p>visi√≥n oriental de la vida; tambi√©n lo encontramos en el pueblo</p>
<p>norteamericano. La cita seiton anterior proviene de la pluma de un ministro</p>
<p>de Ohio que, literalmente, consideraba la limpieza como un remedio para</p>
<p>todas las formas del mal. ¬øY seiso La limpieza es la pureza . Aunque una</p>
<p>casa sea bella, el mobiliario inadecuado acaba con su encanto. ¬øY la opini√≥n</p>
<p>de shutsuke al respecto? El que conf√≠e en lo peque√±o confiar√° en lo superior</p>
<p>¬øY la predisposici√≥n a refactorizar en el momento adecuado, reforzando</p>
<p>nuestra posici√≥n para las posteriores grandes decisiones, en lugar de dejarlo</p>
<p>pasar? Una puntada a tiempo ahorra ciento. Al que madruga, Dios le ayuda.</p>
<p>No dejes para ma√±ana lo que puedas hacer hoy (√©ste era el sentido original</p>
<p>de la frase ¬´en el momento adecuado¬ª de Lean hasta que cay√≥ en manos de</p>
<p>consultores de software ). ¬øY sobre calibrar la importancia de los peque√±os</p>
<p>esfuerzos individuales en un todo mayor? De peque√±as semillas crecen</p>
<p>grandes √°rboles . ¬øY la integraci√≥n de sencillas tareas preventivas en la vida</p>
<p>diaria? M√°s vale prevenir que curar . El c√≥digo limpio honra las ra√≠ces de la</p>
<p>sabidur√≠a popular, de antes o de ahora, y se puede aplicar con atenci√≥n al</p>
<p>detalle.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Incluso en la literatura arquitect√≥nica encontramos ejemplos de estos</p>
<p>detalles. Piense en los pomos de mies van der Rohe. Eso es seiri . Es la</p>
<p>atenci√≥n a todos los nombres de variables. Debe bautizar a una variable con</p>
<p>el mismo cuidado como si fuera su primog√©nito.</p>
<p>Y como todo sabemos, este cuidado no acaba nunca. El arquitecto</p>
<p>Christopher Alexander, padre de patrones y lenguajes de patrones, considera</p>
<p>todo acto de dise√±o como un peque√±o acto local de reparaci√≥n, y considera la</p>
<p>maestr√≠a de la estructura como competencia √∫nica del arquitecto; las formas</p>
<p>mayores se ceden a los patrones y su aplicaci√≥n a los habitantes. El dise√±o es</p>
<p>interminable no s√≥lo al a√±adir una nueva habitaci√≥n a una casa, sino al prestar</p>
<p>atenci√≥n a la pintura, a cambiar las alfombras o a instalar un nuevo fregadero</p>
<p>en la cocina. Otras artes muestran sentimientos an√°logos. En nuestra</p>
<p>b√∫squeda por la importancia de los detalles, nos topamos con el autor franc√©s</p>
<p>del siglo XIX Gustav Flaubert. El poeta franc√©s Paul Valery afirma que un</p>
<p>poema no se acaba nunca y que tiene que retocarse continuamente, y que</p>
<p>dejar de trabajar en el poema es se√±al de abandono. Tal preocupaci√≥n por el</p>
<p>detalle es com√∫n en todas las empresas de excelencia. Puede que esto no sea</p>
<p>nada nuevo, pero al leer este libro sentir√° la necesidad de adoptar disciplinas</p>
<p>rechazadas en su momento por apat√≠a o por un deseo de espontaneidad o una</p>
<p>simple respuesta al cambio.</p>
<p>Desafortunadamente, no solemos considerar estas preocupaciones la</p>
<p>clave del arte de la programaci√≥n. Renunciamos pronto a nuestro c√≥digo, no</p>
<p>porque lo hayamos completado, sino porque nuestro sistema de valores se</p>
<p>centra en el futuro m√°s que en la sustancia de nuestros productos.</p>
<p>Esto tiene un precio final: hierba mala nunca muere . La investigaci√≥n, ni</p>
<p>en el mundo industrial ni en el acad√©mico, se reduce a mantener limpio el</p>
<p>c√≥digo. Cuando trabajaba en la organizaci√≥n Bell Labs Software Production</p>
<p>Research (sin duda de producci√≥n) comprobamos que un estilo de sangrado</p>
<p>coherente era uno de los mayores indicadores estad√≠sticamente significativos</p>
<p>de una baja densidad de errores. Queremos que una arquitectura, un lenguaje</p>
<p>de programaci√≥n u otra noci√≥n superior sea el motivo de la calidad; como</p>
<p>seres cuya supuesta profesionalidad se debe al dominio de herramientas y</p>
<p>m√©todos de dise√±o, nos sentimos insultados por el valor que los</p>
<p>programadores a√±aden con tan s√≥lo aplicar un estilo de sangrado coherente.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Para citar mi propio libro de hace 17 a√±os, dicho estilo distingue la excelencia</p>
<p>de la simple competencia. La visi√≥n japonesa comprende el verdadero valor</p>
<p>del trabajador cotidiano y, en especial, de los sistemas de desarrollo que</p>
<p>dependen de las sencillas acciones diarias de tales trabajadores. La calidad es</p>
<p>el resultado de un mill√≥n de acciones cuidadosas, no de un m√©todo magn√≠fico</p>
<p>ca√≠do del cielo. Que dichas acciones sean simples no significa que sean</p>
<p>simplistas, y mucho menos que sean sencillas. Son la base de la grandeza y,</p>
<p>cada vez m√°s, de cualquier empresa humana. Ignorarlas no es humano en</p>
<p>absoluto.</p>
<p>Evidentemente, todav√≠a defiendo el pensamiento global, en especial el</p>
<p>valor de los enfoques arquitect√≥nicos cimentados en el conocimiento de los</p>
<p>dominios y la capacidad de uso del software . Este libro no versa sobre esto, al</p>
<p>menos no de forma evidente. Este libro transmite un mensaje m√°s sutil cuya</p>
<p>profundidad no debe menospreciarse. Coincide con la visi√≥n de gente como</p>
<p>Peter Sommerlad, Kevlin Henney y Giovanni Asproni, cuyos mantras son</p>
<p>¬´El c√≥digo es el dise√±o¬ª y ¬´C√≥digo simple¬ª. Aunque debemos recordar que</p>
<p>la interfaz es el programa y que sus estructuras dicen mucho sobre la propia</p>
<p>estructura del programa, es fundamental adoptar de forma continuada la</p>
<p>humilde posici√≥n de que el dise√±o vive en el c√≥digo. Y aunque los cambios y</p>
<p>la met√°fora de la f√°brica supongan costes, los cambios de dise√±o suponen</p>
<p>valor. Debemos considerar al c√≥digo como la articulaci√≥n de los esfuerzos de</p>
<p>dise√±o, visto como un proceso, no como algo est√°tico. Es en el c√≥digo donde</p>
<p>se desarrollan los conceptos arquitect√≥nicos de conexi√≥n y cohesi√≥n. Si</p>
<p>escucha a Larry Constantine describir la conexi√≥n y la cohesi√≥n, lo hace en</p>
<p>t√©rminos del c√≥digo, no desde conceptos abstractos propios de UML. En su</p>
<p>ensayo Abstraction Descant , Richard Gabriel afirma que la abstracci√≥n es el</p>
<p>mal. El c√≥digo es el remedio al mal y el c√≥digo limpio puede que sea divino.</p>
<p>Volviendo a mi caja de Ga-Jol , considero importante recordar que la</p>
<p>sabidur√≠a danesa nos recomienda no s√≥lo prestar atenci√≥n a las peque√±as</p>
<p>cosas, sino tambi√©n ser honestos con ellas. Esto significa ser honesto con el</p>
<p>c√≥digo, con nuestros colegas sobre el estado del c√≥digo y, en especial, con</p>
<p>nosotros mismos. ¬øHemos hecho todo lo posible para dejar las cosas mejor</p>
<p>que como las encontramos? ¬øHemos refactorizado el c√≥digo antes de</p>
<p>terminarlo? No se trata de preocupaciones perif√©ricas, sino que se encuentran</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>en la base misma de los valores Agile. En Serum se recomienda que la</p>
<p>refactorizaci√≥n sea parte del concepto de Terminado. Ni la arquitectura ni el</p>
<p>c√≥digo limpio insisten en la perfecci√≥n, sino en la honestidad y en hacerlo lo</p>
<p>mejor posible. Errar es humano; perdonar es divino . En Serum, todo lo</p>
<p>hacemos de forma visible. Aireamos los trapos sucios. Somos honestos sobre</p>
<p>el estado de nuestro c√≥digo ya que nunca es perfecto. Nos hemos hecho m√°s</p>
<p>humanos, m√°s merecedores de lo divino y estamos m√°s pr√≥ximos a la</p>
<p>grandeza de los detalles.</p>
<p>En nuestra profesi√≥n, necesitamos desesperadamente toda la ayuda</p>
<p>posible. Si un suelo seco reduce el riesgo de resbalones y las herramientas</p>
<p>bien organizadas aumentan la productividad, es nuestra meta. Y en cuanto al</p>
<p>libro, es la mejor aplicaci√≥n pragm√°tica de los principios Lean de software</p>
<p>que he visto nunca en formato impreso. No esperaba menos de este grupo de</p>
<p>individuos que durante a√±os se han esforzado no s√≥lo por mejorar sino en</p>
<p>ofrecer sus conocimientos a la industria mediante obras como la que ahora</p>
<p>tiene entre manos. Hace que el mundo sea un poco mejor que antes de que</p>
<p>Uncle Bob me enviara el manuscrito.</p>
<p>Y tras completar este ejercicio, me dispongo a limpiar mi escritorio.</p>
<p>James O. Coplien</p>
<p>M√∏rdrup, Dinamarca</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="introduccion-4">Introducci√≥n</h1>
<p>Reproducido con permiso de Thom Holwerda.</p>
<p>http://www.osnews.com/story/19266/WTFs_m. ¬© 2008 Focus Shift.</p>
<p>¬øQu√© puerta representa su c√≥digo? ¬øQu√© puerta representa a su equipo o a su</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>empresa? ¬øPor qu√© estamos en esa habitaci√≥n? ¬øEs una sencilla revisi√≥n del</p>
<p>c√≥digo o hemos detectado un sinf√≠n de problemas terribles? ¬øDepuramos</p>
<p>presas del p√°nico el c√≥digo que pens√°bamos que funcionaba? ¬øLos clientes</p>
<p>huyen despavoridos los directores nos pisan los talones? ¬øC√≥mo</p>
<p>asegurarnos de que abrimos la puerta correcta cuando las cosas se ponen</p>
<p>feas? La respuesta: la maestr√≠a</p>
<p>La maestr√≠a se consigue de dos formas: conocimientos y trabajo. Debe</p>
<p>adquirir el conocimiento de los principios, patrones, pr√°cticas y heur√≠stica</p>
<p>propios de un maestro, y dominar dichos conocimientos a trav√©s de la</p>
<p>pr√°ctica.</p>
<p>Puedo ense√±arle la teor√≠a de montar en bicicleta. De hecho, los conceptos</p>
<p>matem√°ticos cl√°sicos son muy sencillos. Gravedad, fricci√≥n, velocidad</p>
<p>angular, centro de masa, etc., se pueden demostrar en menos de una p√°gina</p>
<p>repleta de ecuaciones. Con esas f√≥rmulas, puedo demostrar que montar en</p>
<p>bicicleta es pr√°ctico y proporcionarle los conocimientos necesarios para</p>
<p>conseguirlo. Pero la primera vez que se monte en una bici se caer√° al suelo.</p>
<p>El dise√±o de c√≥digo no es diferente. Podr√≠amos enumerar todos los</p>
<p>principios del c√≥digo limpio y confiar en que se encargue del resto (es decir,</p>
<p>dejar que se cayera de la bici) pero entonces la pregunta ser√≠a qu√© clase de</p>
<p>profesores somos y qu√© clase de alumno ser√≠a.</p>
<p>No. As√≠ no funciona este libro.</p>
<p>Aprender a crear c√≥digo limpio es complicado . Requiere algo m√°s que</p>
<p>conocer principios y patrones. Tiene que sudar. Debe practicarlo y fallar.</p>
<p>Debe ver c√≥mo otros practican y fallan. Debe observar c√≥mo se caen y</p>
<p>recuperan el paso. Debe ver c√≥mo agonizan en cada decisi√≥n y el precio que</p>
<p>pagan por tomar decisiones equivocadas.</p>
<p>Para leer este libro, prep√°rese a trabajar duro. No es un libro que se pueda</p>
<p>leer en un avi√≥n y terminarlo antes de aterrizar. Este libro le har√° trabajar, y</p>
<p>mucho. ¬øY qu√© tipo de trabajo? Tendr√° que leer c√≥digo, en abundancia. Y se</p>
<p>le pedir√° que piense en qu√© acierta el c√≥digo y en qu√© falla. Se le pedir√° que</p>
<p>siga nuestras descripciones mientras despedazamos m√≥dulos y los volvemos</p>
<p>a ensamblar. Para ello necesitar√° tiempo y esfuerzo, pero creemos que merece</p>
<p>la pena.</p>
<p>Hemos dividido el libro en tres partes. Los primeros cap√≠tulos describen</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>los principios, patrones pr√°cticas para crear c√≥digo limpio. Incluyen</p>
<p>abundante c√≥digo y resultan dif√≠ciles de leer. Sirven como preparaci√≥n a la</p>
<p>segunda parte. Si abandona tras leer la primera secci√≥n, que tenga buena</p>
<p>suerte.</p>
<p>La segunda parte del libro es la m√°s dif√≠cil. Incluye varios casos de</p>
<p>estudio cuya complejidad va aumentando. Cada ejemplo es un ejercicio de</p>
<p>limpieza de c√≥digo, transformar c√≥digo con problemas para que tenga menos</p>
<p>problemas. El detalle de esta parte es abundante . Tendr√° que alternar entre el</p>
<p>texto y los listados de c√≥digo. Tendr√° que analizar y entender el c√≥digo, y</p>
<p>comprender el razonamiento de cada cambio realizado. Piense en que esta</p>
<p>parte le llevar√° varios d√≠as</p>
<p>La tercera parte del libro es un √∫nico cap√≠tulo que contiene una lista de</p>
<p>heur√≠stica y s√≠ntomas de c√≥digo err√≥neo ( smells ) confeccionada al crear los</p>
<p>casos pr√°cticos. Al analizar limpiar el c√≥digo de los ejemplos,</p>
<p>documentamos el motivo de todas nuestras acciones como heur√≠stica o</p>
<p>s√≠ntoma. Intentamos comprender nuestras reacciones al c√≥digo que le√≠amos y</p>
<p>modific√°bamos, y nos esforzamos por capturar las sensaciones que tuvimos y</p>
<p>las decisiones que adoptamos. El resultado es una base de conocimientos que</p>
<p>describe c√≥mo pensamos cuando creamos, leemos y limpiamos c√≥digo.</p>
<p>Esta base de conocimientos no le servir√° de mucho si no lee atentamente</p>
<p>los casos de la segunda parte del libro. En esos cap√≠tulos hemos anotado con</p>
<p>precisi√≥n todos los cambios realizados con referencias a la heur√≠stica. Estas</p>
<p>referencias se muestran entre corchetes, como [H22]. De este modo puede ver</p>
<p>el contexto en el que se ha aplicado y creado dicha heur√≠stica. No importa</p>
<p>tanto el propio valor de las heur√≠sticas sino la relaci√≥n entre ellas y las</p>
<p>decisiones adoptadas al limpiar el c√≥digo en los ejemplos</p>
<p>Si lee la primera y la tercera parte y se salta los casos pr√°cticos, habr√°</p>
<p>le√≠do otro libro distinto sobre c√≥mo crear c√≥digo correcto, pero si dedica</p>
<p>tiempo a analizar los casos, sigue todos y cada uno de los pasos, cada una de</p>
<p>las decisiones, si se pone en nuestro lugar y se obliga a pensar tal y como lo</p>
<p>hicimos nosotros, entonces comprender√° mucho mejor todos los principios,</p>
<p>patrones, pr√°cticas y heur√≠stica. Ya no ser√° un conocimiento superficial. Se</p>
<p>convertir√° en algo profundo. Lo integrar√° de la misma forma que una</p>
<p>bicicleta se convierte en una extensi√≥n propia una vez dominada la forma de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>montar.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="sobre-la-imagen-de-cubierta-5">Sobre la imagen de cubierta</h1>
<p>La imagen de la portada es M104: la Galaxia del Sombrero. M104 se</p>
<p>encuentra en Virgo, a unos 30 millones de a√±os luz, y su n√∫cleo es un s√∫per</p>
<p>agujero negro que pesa aproximadamente mil millones de masas solares.</p>
<p>¬øLa imagen le recuerda la explosi√≥n de la luna Praxis de Klingon?</p>
<p>Recuerdo la escena de Star Trek VI en la que se mostraba un anillo de restos</p>
<p>flotando tras la explosi√≥n. Tras esa escena, el anillo se ha convertido en un</p>
<p>elemento habitual de las explosiones de ciencia ficci√≥n. Incluso se a√±adi√≥ a la</p>
<p>explosi√≥n de Alderaan en ediciones posteriores de la primera pel√≠cula de La</p>
<p>Guerra de las Galaxias.</p>
<p>¬øQu√© provoc√≥ la formaci√≥n de este anillo alrededor de M104? ¬øPor qu√©</p>
<p>tiene un centro de tales dimensiones y un n√∫cleo tan brillante y diminuto?</p>
<p>Parece como si el agujero negro central hubiera provocado un orificio de</p>
<p>30 000 a√±os luz en el centro de la galaxia. La desgracia caer√≠a sobre las</p>
<p>civilizaciones que se encontraran en el camino de este desastre c√≥smico.</p>
<p>Los s√∫per agujeros negros desayunan estrellas y convierten parte de su</p>
<p>masa en energ√≠a. E=MC puede bastar, pero cuando M es una masa estelar</p>
<p>hay que tener cuidado. ¬øCu√°ntas estrellas habr√° engullido este monstruo antes</p>
<p>de saciar su apetito? El tama√±o del vac√≠o central podr√≠a ser una pista.</p>
<p>La imagen de M104 de la portada es una combinaci√≥n de la famosa</p>
<p>fotograf√≠a del Hubble (imagen superior) y la reciente imagen de infrarrojos</p>
<p>del observatorio orbital Spitzer (inferior).</p>
<p>Esta √∫ltima muestra claramente la forma de anillo de la galaxia.</p>
<p>A la luz, s√≥lo vemos el borde frontal de la silueta del anillo.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>La masa central oculta el resto.</p>
<p>Pero en la imagen de infrarrojos, las</p>
<p>part√≠culas calientes del anillo brillan a trav√©s</p>
<p>de la masa central. Las dos im√°genes</p>
<p>combinadas nos ofrecen una vista desconocida</p>
<p>hasta ahora e implican que hace tiempo era un</p>
<p>aut√©ntico infierno activo.</p>
<p>Imagen de portada: ¬© Spitzet Space</p>
<p>Telescope.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="codigo-limpio-6">C√≥digo Limpio</h1>
<p>Est√° leyendo este libro por dos motivos. Por un lado, es programador. Por</p>
<p>otro, quiere ser mejor programador. Perfecto. Necesitamos mejores</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>programadores.</p>
<p>Este libro trata sobre programaci√≥n correcta. Est√° repleto de c√≥digo. Lo</p>
<p>analizaremos desde todas las direcciones. Desde arriba, desde abajo y desde</p>
<p>dentro. Cuando terminemos, sabremos mucho sobre c√≥digo y, en especial</p>
<p>sabremos distinguir entre c√≥digo correcto e incorrecto. Sabremos c√≥mo</p>
<p>escribir c√≥digo correcto y c√≥mo transformar c√≥digo incorrecto en c√≥digo</p>
<p>correcto.</p>
<h3 id="hagase-el-codigo-7">H√°gase el c√≥digo</h3>
<p>Se podr√≠a afirmar que un libro sobre c√≥digo es algo obsoleto, que el c√≥digo</p>
<p>ya no es el problema y que deber√≠amos centrarnos en modelos y requisitos.</p>
<p>Hay quienes sugieren que el final del c√≥digo est√° pr√≥ximo. Que los</p>
<p>programadores ya no ser√°n necesarios porque los empresarios generar√°n</p>
<p>programas a partir de especificaciones.</p>
<p>No es cierto. El c√≥digo nunca desaparecer√°, ya que representa los detalles</p>
<p>de los requisitos. En alg√∫n nivel, dichos detalles no se pueden ignorar ni</p>
<p>abstraer; deben especificarse, y para especificar requisitos de forma que un</p>
<p>equipo pueda ejecutarlos se necesita la programaci√≥n. Dicha especificaci√≥n es</p>
<p>el c√≥digo.</p>
<p>Espero que el nivel de abstracci√≥n de nuestros lenguajes siga</p>
<p>aumentando. Tambi√©n espero que aumente el n√∫mero de lenguajes</p>
<p>espec√≠ficos de dominios. Ser√° algo positivo, pero no eliminar√° el c√≥digo. De</p>
<p>hecho, todas las especificaciones creadas en estos lenguajes de nivel superior</p>
<p>y espec√≠ficos de los dominios ser√°n c√≥digo, y tendr√° que ser riguroso, preciso,</p>
<p>formal y detallado para que un equipo pueda entenderlo y ejecutarlo.</p>
<p>El que piense que el c√≥digo va a desaparecer es como el matem√°tico que</p>
<p>espera que un d√≠a las matem√°ticas no sean formales. Esperan descubrir una</p>
<p>forma de crear m√°quinas que hagan lo que queramos en lugar de lo que</p>
<p>digamos. Esas m√°quinas tendr√≠an que entendernos de tal forma que puedan</p>
<p>traducir necesidades ambiguas en programas perfectamente ejecutados que</p>
<p>satisfagan dichas necesidades a la perfecci√≥n.</p>
<p>Esto nunca suceder√°. Ni siquiera los humanos, con toda su intuici√≥n y</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>creatividad, han sido capaces de crear sistemas satisfactorios a partir de las</p>
<p>sensaciones de sus clientes. En realidad, si la disciplina de la especificaci√≥n</p>
<p>de requisitos nos ha ense√±ado algo es que los requisitos bien especificados</p>
<p>son tan formales como el c√≥digo que pueden actuar como pruebas</p>
<p>ejecutables de dicho c√≥digo.</p>
<p>Recuerde que el c√≥digo es b√°sicamente el lenguaje en el que expresamos</p>
<p>los requisitos en √∫ltima instancia. Podemos crear lenguajes que se asemejen a</p>
<p>dichos requisitos. Podemos crear herramientas que nos permitan analizar y</p>
<p>combinar dichos requisitos en estructuras formales, pero nunca eliminaremos</p>
<p>la precisi√≥n necesaria; por ello, siempre habr√° c√≥digo.</p>
<h3 id="codigo-incorrecto-8">C√≥digo Incorrecto</h3>
<p>Recientemente le√≠ el pr√≥logo del libro</p>
<p>[1]</p>
<p>Implementation Pattern de Kent Beck,</p>
<p>donde afirmaba que ¬´...este libro se basa en</p>
<p>una fr√°gil premisa: que el c√≥digo correcto</p>
<p>es relevante...¬ª. ¬øUna fr√°gil premisa? En</p>
<p>absoluto. Considero que es una de las m√°s</p>
<p>robustas, admitidas importantes de</p>
<p>nuestro sector (y creo que Kent lo sabe).</p>
<p>Sabemos que el c√≥digo correcto es</p>
<p>relevante porque durante mucho tiempo</p>
<p>hemos tenido que sufrir su ausencia.</p>
<p>S√© de una empresa que, a finales de la</p>
<p>d√©cada de 1980, cre√≥ una magn√≠fica</p>
<p>aplicaci√≥n, muy popular que muchos</p>
<p>profesionales compraron utilizaron. Pero los ciclos de publicaci√≥n</p>
<p>empezaron a distanciarse. No se corrigieron los errores entre una versi√≥n y la</p>
<p>siguiente. Crecieron los tiempos de carga y aumentaron los fallos. Todav√≠a</p>
<p>recuerdo el d√≠a en que apagu√© el producto y nunca m√°s lo volv√≠ a usar.</p>
<p>Poco despu√©s, la empresa desapareci√≥.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Dos d√©cadas despu√©s conoc√≠ a uno de los empleados de la empresa y le</p>
<p>pregunt√© sobre lo que hab√≠a pasado. La respuesta confirm√≥ mis temores.</p>
<p>Hab√≠an comercializado el producto antes de tiempo con graves fallos en el</p>
<p>c√≥digo. Al a√±adir nuevas funciones, el c√≥digo empeor√≥ hasta que ya no</p>
<p>pudieron controlarlo. El c√≥digo incorrecto fue el motivo del fin de la</p>
<p>empresa</p>
<p>¬øEn alguna ocasi√≥n el c√≥digo incorrecto le ha supuesto un obst√°culo? Si</p>
<p>es programador seguramente s√≠. De hecho, tenemos una palabra que lo</p>
<p>describe: sortear . Tenemos que sortear el c√≥digo incorrecto. Nos arrastramos</p>
<p>por una mara√±a de zarzas y trampas ocultas. Intentamos buscar el camino,</p>
<p>una pista de lo que est√° pasando, pero lo √∫nico que vemos es m√°s y m√°s</p>
<p>c√≥digo sin sentido.</p>
<p>Sin duda el c√≥digo incorrecto le ha supuesto un obst√°culo. Entonces, ¬øpor</p>
<p>qu√© lo escribi√≥?</p>
<p>¬øTen√≠a prisa? ¬øPlazos de entrega? Seguramente. Puede que pensara que</p>
<p>no ten√≠a tiempo para hacer un buen trabajo; que su jefe se enfadar√≠a si</p>
<p>necesitaba tiempo para limpiar su c√≥digo. O puede que estuviera cansado de</p>
<p>trabajar en ese programa y quisiera acabar cuanto antes. O que viera el</p>
<p>trabajo pendiente y tuviera que acabar con un m√≥dulo para pasar al siguiente.</p>
<p>A todos nos ha pasado.</p>
<p>Todos hemos visto el l√≠o en el que est√°bamos y hemos optado por dejarlo</p>
<p>para otro d√≠a. Todos hemos sentido el alivio de ver c√≥mo un programa</p>
<p>incorrecto funcionaba y hemos decidido que un mal programa que funciona</p>
<p>es mejor que nada. Todos hemos dicho que lo solucionar√≠amos despu√©s.</p>
<p>Evidentemente, por aquel entonces, no conoc√≠amos la ley de LeBlanc:</p>
<p>Despu√©s es igual a nunca</p>
<h3 id="el-coste-total-de-un-desastre-9">El coste total de un desastre</h3>
<p>Si es programador desde hace dos o tres a√±os, probablemente haya sufrido los</p>
<p>desastres cometidos por otros en el c√≥digo. Si tiene m√°s experiencia, lo habr√°</p>
<p>sufrido en mayor medida. El grado de sufrimiento puede ser significativo. En</p>
<p>un periodo de un a√±o o dos, los equipos que avancen r√°pidamente al inicio de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>un proyecto pueden acabar a paso de tortuga. Cada cambio en el c√≥digo</p>
<p>afecta a dos o tres partes del mismo. Ning√∫n cambio es trivial. Para ampliar o</p>
<p>modificar el sistema es necesario comprender todos los detalles, efectos y</p>
<p>consecuencias, para de ese modo poder a√±adir nuevos detalles, efectos y</p>
<p>consecuencias. Con el tiempo, el desastre aumenta de tal modo que no se</p>
<p>puede remediar. Es imposible.</p>
<p>Al aumentar este desastre, la productividad del equipo disminuye y acaba</p>
<p>por desaparecer. Al reducirse la productividad, el director hace lo √∫nico que</p>
<p>puede: ampliar la plantilla del proyecto con la esperanza de aumentar la</p>
<p>productividad. Pero esa nueva plantilla no conoce el dise√±o del sistema. No</p>
<p>conocen la diferencia entre un cambio adecuado al objetivo de dise√±o y otro</p>
<p>que lo destroce. Por tanto, todos se encuentran sometidos a una gran presi√≥n</p>
<p>para aumentar la productividad. Por ello, cometen m√°s errores, aumenta el</p>
<p>desastre y la productividad se acerca a cero cada vez m√°s (v√©ase la figura</p>
<p>1.1).</p>
<p>Figura 1.1. Productividad frente a tiempo.</p>
<h3 id="el-gran-cambio-de-diseno-10">El gran cambio de dise√±o</h3>
<p>En √∫ltima instancia, el equipo se rebela. Informan al director que no pueden</p>
<p>seguir trabajando con ese c√≥digo. Exigen un cambio de dise√±o. La direcci√≥n</p>
<p>no requiere invertir en un cambio de dise√±o del proyecto, pero no puede</p>
<p>ignorar el bajo nivel de productividad.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Acaba por ceder a las exigencias de los programadores y autoriza el gran</p>
<p>cambio de dise√±o. Se selecciona un nuevo equipo. Todos quieren formar</p>
<p>parte del nuevo equipo por ser un lienzo en blanco. Pueden empezar de cero y</p>
<p>crear algo realmente bello, pero s√≥lo los mejores ser√°n elegidos para el nuevo</p>
<p>equipo. Los dem√°s deben continuar con el mantenimiento del sistema actual.</p>
<p>Ahora los dos equipos compiten. El nuevo debe crear un sistema que haga</p>
<p>lo que el antiguo no puede. Adem√°s, deben asumir los cambios que</p>
<p>continuamente se aplican al sistema antiguo. La direcci√≥n no sustituir√° el</p>
<p>sistema antiguo hasta que el nuevo sea capaz de hacer todo lo que hace el</p>
<p>antiguo.</p>
<p>Esta competici√≥n puede durar mucho tiempo. Conozco casos de casi 10</p>
<p>a√±os. Y cuando acaba, los miembros originales del equipo nuevo han</p>
<p>desaparecido y los miembros actuales exigen un cambio de dise√±o del nuevo</p>
<p>sistema porque es un desastre.</p>
<p>Si ha experimentado alguna fase de esta historia, ya sabr√° que dedicar</p>
<p>tiempo a que el c√≥digo sea correcto no s√≥lo es rentable, es una cuesti√≥n de</p>
<p>supervivencia profesional.</p>
<h3 id="actitud-11">Actitud</h3>
<p>¬øAlguna vez ha tenido que superar un desastre tan grave que ha tardado</p>
<p>semanas en lo que normalmente hubiera tardado horas? ¬øHa visto un cambio</p>
<p>que deber√≠a haberse realizado en una l√≠nea, aplicado en cientos de m√≥dulos</p>
<p>distintos? Son s√≠ntomas demasiado habituales.</p>
<p>¬øPor qu√© sucede en el c√≥digo? ¬øPor qu√© el c√≥digo de calidad se</p>
<p>transforma tan r√°pidamente en c√≥digo incorrecto? Hay muchas explicaciones.</p>
<p>Nos quejamos de que los requisitos cambian de forma que comprometen el</p>
<p>dise√±o original, de que los plazos de entrega son demasiado exigentes para</p>
<p>hacer las cosas bien. Culpamos directores incompetentes, usuarios</p>
<p>intolerantes y a comerciales sin sentido. Pero la culpa, querido Dilbert, es</p>
<p>nuestra. No somos profesionales.</p>
<p>Puede que resulte duro escucharlo. ¬øC√≥mo es posible que seamos</p>
<p>responsables de tales desastres? ¬øQu√© pasa con los requisitos? ¬øY los plazos</p>
<p>de entrega? ¬øY los directores incompetentes y los comerciales sin sentido?</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>¬øNo es tambi√©n culpa suya?</p>
<p>No. Los directores y los comerciales nos exigen la informaci√≥n que</p>
<p>necesitan para realizar sus promesas y compromisos, e incluso cuando no</p>
<p>recurren a nosotros, no debemos tener miedo a decirles lo que pensamos. Los</p>
<p>usuarios acuden a nosotros para validar la forma de encajar los requisitos en</p>
<p>el sistema. Los directores de proyectos acuden a nosotros para determinar los</p>
<p>objetivos. Somos c√≥mplices en la programaci√≥n del proyecto y compartimos</p>
<p>gran parte de la responsabilidad de los fallos, en especial si tienen que ver</p>
<p>con c√≥digo incorrecto.</p>
<p>Seguramente piense que, si no hace lo que su jefe le dice, le despedir√°n.</p>
<p>Es improbable. Muchos jefes s√≥lo quieren la verdad, aunque lo disimulen.</p>
<p>Muchos quieren c√≥digo correcto, aunque est√©n obsesionados con los</p>
<p>objetivos. Pueden defender apasionadamente los objetivos y los requisitos,</p>
<p>pero es su trabajo. El nuestro es defender el c√≥digo con la misma intensidad.</p>
<p>Para resumir, imagine que es m√©dico y un paciente le exige que no se lave</p>
<p>[2]</p>
<p>las manos antes de una operaci√≥n porque se pierde demasiado tiempo . En</p>
<p>este caso, el paciente es el jefe, pero el m√©dico debe negarse a lo que pide.</p>
<p>¬øPor qu√©? Porque el m√©dico sabe m√°s que el paciente sobre los riesgos de</p>
<p>infecciones. No ser√≠a profesional (incluso ser√≠a ilegal) que el m√©dico cediera</p>
<p>a las exigencias del paciente.</p>
<p>Tampoco ser√≠a profesional que los programadores cedieran a la voluntad</p>
<p>de los jefes que no entienden los riesgos de un posible desastre.</p>
<h3 id="el-enigma-12">El enigma</h3>
<p>Los programadores se enfrentan a un enigma de valores b√°sicos. Los que</p>
<p>tienen a√±os de experiencia saben que un desastre ralentiza su trabajo, y aun</p>
<p>as√≠ todos los programadores sienten la presi√≥n de cometer errores para poder</p>
<p>cumplir los plazos de entrega. En definitiva, no toman el tiempo necesario</p>
<p>para avanzar.</p>
<p>Los verdaderos profesionales saben que la segunda parte del enigma no es</p>
<p>cierta. No se cumple un plazo de entrega cometiendo un error. De hecho, el</p>
<p>error nos ralentiza de forma inmediata y hace que no lleguemos al plazo de</p>
<p>entrega. La √∫nica forma de cumplirlo, la √∫nica forma de avanzar, es intentar</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>que el c√≥digo siempre sea limpio.</p>
<h3 id="el-arte-del-codigo-limpio-13">¬øEl arte del c√≥digo limpio?</h3>
<p>Imagine que cree que el c√≥digo incorrecto es un obst√°culo significativo.</p>
<p>Imagine que acepta que la √∫nica forma de avanzar es mantener el c√≥digo</p>
<p>limpio. Entonces se preguntar√° c√≥mo crear c√≥digo limpio. No tiene sentido</p>
<p>intentar crearlo si no sabe lo que es.</p>
<p>La mala noticia es que crear c√≥digo limpio es como pintar un cuadro.</p>
<p>Muchos sabemos si un cuadro se ha pintado bien o no, pero poder reconocer</p>
<p>la calidad de una obra no significa que sepamos pintar. Por ello, reconocer</p>
<p>c√≥digo limpio no significa que sepamos c√≥mo crearlo.</p>
<p>Para crearlo se requiere el uso disciplinado de miles de t√©cnicas aplicadas</p>
<p>mediante un detallado sentido de la ¬´correcci√≥n¬ª. Este sentido del c√≥digo es</p>
<p>la clave.</p>
<p>Algunos nacen con este sentido. Otros han de luchar para conseguirlo. No</p>
<p>s√≥lo permite distinguir entre c√≥digo correcto e incorrecto, sino que tambi√©n</p>
<p>muestra la estrategia para aplicar nuestra disciplina y transformar c√≥digo</p>
<p>incorrecto en c√≥digo correcto.</p>
<p>Un programador sin este sentido puede reconocer el desastre cometido en</p>
<p>un m√≥dulo, pero no saber c√≥mo solucionarlo. Un programador con este</p>
<p>sentido ver√° las posibles opciones y elegir√° la variante √≥ptima para definir</p>
<p>una secuencia de cambios.</p>
<p>En definitiva, un programador que cree c√≥digo limpio es un artista que</p>
<p>puede transformar un lienzo en blanco en un sistema de c√≥digo elegante.</p>
<h3 id="concepto-de-codigo-limpio-14">Concepto de c√≥digo limpio</h3>
<p>Existen tantas definiciones como programadores. Por ello, he consultado la</p>
<p>opini√≥n de conocidos y experimentados programadores.</p>
<p>Bjarne Stroustrup, inventor de C++ y autor</p>
<p>de The C++ Programming Language</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Me gusta que mi c√≥digo sea elegante y</p>
<p>eficaz. La l√≥gica debe ser directa para</p>
<p>evitar errores ocultos, las dependencias</p>
<p>deben ser m√≠nimas para facilitar el</p>
<p>mantenimiento, el procesamiento de</p>
<p>errores completo sujeto una</p>
<p>estrategia articulada, y el rendimiento</p>
<p>debe ser √≥ptimo para que los usuarios</p>
<p>no tiendan a estropear el c√≥digo con</p>
<p>optimizaciones sin sentido. El c√≥digo</p>
<p>limpio hace bien una cosa.</p>
<p>Bjarne usa la palabra ¬´elegante¬ª. Menuda palabra.</p>
<p>Seg√∫n el diccionario, ¬´elegante¬ª significa ¬´ dotado de gracia, nobleza y</p>
<p>sencillez ¬ª. Aparentemente Bjarne piensa que el c√≥digo limpio es un placer a</p>
<p>la hora de leerlo. Su lectura debe hacernos sonre√≠r, como una caja de m√∫sica</p>
<p>o un coche bien dise√±ado.</p>
<p>Bjarne tambi√©n menciona la eficacia, en dos ocasiones . No deber√≠a</p>
<p>sorprendemos viniendo del inventor de C++; pero considero que hay algo</p>
<p>m√°s que el mero deseo de velocidad. Los ciclos malgastados no son</p>
<p>elegantes, no son un placer. Y f√≠jese en la palabra empleada por Bjarne para</p>
<p>describir la consecuencia de esta falta de elegancia. Usa tiendan . Una gran</p>
<p>verdad. El c√≥digo incorrecto tiende a aumentar el desastre. Cuando otros</p>
<p>cambian c√≥digo incorrecto, tienden a empeorarlo.</p>
<p>Dave Thomas y Andy Hunt lo expresan de forma diferente. Usan la</p>
<p>[3]</p>
<p>met√°fora de las ventanas rotas . Un edificio con ventanas rotas parece</p>
<p>abandonado. Y hace que otros lo abandonen. Dejan que se rompan otras</p>
<p>ventanas. E incluso las rompen a prop√≥sito. La fachada se ensucia con</p>
<p>pintadas y se acumula la basura. Una ventana rota inicia el proceso de la</p>
<p>decadencia.</p>
<p>Bjarne tambi√©n menciona que el procesamiento de errores debe ser</p>
<p>completo, lo que se relaciona con la disciplina de prestar atenci√≥n a los</p>
<p>detalles. El procesamiento de errores abreviado es una forma de ignorar los</p>
<p>detalles. Otras son las fugas de memoria, las condiciones de carrera o el uso</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>incoherente de los nombres. En definitiva, el c√≥digo limpio muestra gran</p>
<p>atenci√≥n al detalle.</p>
<p>Bjarne termina afirmando que el c√≥digo limpio hace una cosa bien . No es</p>
<p>accidental que existan tantos principios de dise√±o de software que se puedan</p>
<p>reducir a esta sencilla m√°xima. Muchos escritores han tratado de comunicar</p>
<p>este pensamiento. El c√≥digo incorrecto intenta hacer demasiadas cosas y su</p>
<p>cometido es ambiguo y enrevesado. El c√≥digo limpio es concreto . Cada</p>
<p>funci√≥n, cada clase y cada m√≥dulo muestran una √∫nica actitud que se</p>
<p>mantiene invariable y no se contamina por los detalles circundantes.</p>
<p>Grady Booch, autor de Object Oriented</p>
<p>Analysis and Design with Applications</p>
<p>El c√≥digo limpio es simple y directo. El</p>
<p>c√≥digo limpio se lee como un texto bien</p>
<p>escrito. El c√≥digo limpio no oculta la</p>
<p>intenci√≥n del dise√±ador, sino que</p>
<p>muestra n√≠tidas abstracciones y l√≠neas</p>
<p>directas de control.</p>
<p>Grady mantiene las mismas ideas que</p>
<p>Bjarne, pero adopta una perspectiva de legibilidad . Me gusta especialmente</p>
<p>que el c√≥digo limpio se pueda leer como un texto bien escrito. Piense en un</p>
<p>buen libro. Recordar√° que las palabras desaparecen y se sustituyen por</p>
<p>im√°genes, como ver una pel√≠cula.</p>
<p>Mejor todav√≠a. Es ver los caracteres, escuchar los sonidos, experimentar</p>
<p>las sensaciones.</p>
<p>Leer c√≥digo limpio nunca ser√° como leer El Se√±or de los Anillos . Pero</p>
<p>esta met√°fora literaria no es incorrecta. Como una buena novela, el c√≥digo</p>
<p>limpio debe mostrar de forma clara el suspense del problema que hay que</p>
<p>resolver. Debe llevar ese suspense hasta un punto √°lgido para despu√©s</p>
<p>demostrar al lector que los problemas y el suspense se han solucionado de</p>
<p>forma evidente.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>La frase ¬´n√≠tida abstracci√≥n¬ª de Grady es un ox√≠moron fascinante. N√≠tido</p>
<p>es casi un sin√≥nimo de concreto, con un potente mensaje. El c√≥digo debe ser</p>
<p>espec√≠fico y no especulativo. S√≥lo debe incluir lo necesario. Nuestros lectores</p>
<p>deben percibir que hemos tomado decisiones.</p>
<p>¬´Big¬ª Dave Thomas, fundador de OTI, el</p>
<p>padrino de la estrategia Eclipse</p>
<p>El c√≥digo limpio se puede leer</p>
<p>mejorar por parte de un programador</p>
<p>que no sea su autor original. Tiene</p>
<p>pruebas de unidad de aceptaci√≥n.</p>
<p>Tiene nombres con sentido. Ofrece una</p>
<p>y no varias formas de hacer algo. Sus</p>
<p>dependencias son m√≠nimas, se definen</p>
<p>de forma expl√≠cita y ofrece una API</p>
<p>clara m√≠nima. El c√≥digo debe ser</p>
<p>culto en funci√≥n del lenguaje, ya que no</p>
<p>toda la informaci√≥n necesaria se puede</p>
<p>expresar de forma clara en el c√≥digo.</p>
<p>Big Dave comparte el deseo de Grady de la legibilidad, pero con una</p>
<p>importante variante. Dave afirma que el c√≥digo limpio facilita las labores de</p>
<p>mejora de otros . Puede parecer evidente pero no debemos excedernos.</p>
<p>Despu√©s de todo, existe una diferencia entre el c√≥digo f√°cil de leer y el</p>
<p>c√≥digo f√°cil de cambiar.</p>
<p>Dave vincula la limpieza a las pruebas. Hace 10 a√±os esto hubiera</p>
<p>provocado cierta controversia. Pero la disciplina del Desarrollo controlado</p>
<p>por pruebas ha tenido un gran impacto en nuestro sector y se ha convertido en</p>
<p>uno de sus pilares. Dave tiene raz√≥n. El c√≥digo, sin pruebas, no es limpio.</p>
<p>Independientemente de su elegancia, legibilidad y accesibilidad, si no tiene</p>
<p>pruebas, no ser√° limpio.</p>
<p>Dave usa dos veces la palabra m√≠nimo . Valora el c√≥digo de tama√±o</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>reducido, una opini√≥n habitual en la literatura de software desde su</p>
<p>concepci√≥n. Cuanto m√°s peque√±o, mejor.</p>
<p>Tambi√©n afirma que el c√≥digo debe ser culto , una referencia indirecta a la</p>
<p>[4]</p>
<p>programaci√≥n de Knuth y que en definitiva indica que el c√≥digo debe</p>
<p>redactarse de una forma legible para los humanos.</p>
<p>Michael Feathers, autor de Working</p>
<p>Effectively with Legacy Code</p>
<p>Podr√≠a enumerar todas las cualidades</p>
<p>del c√≥digo limpio, pero hay una</p>
<p>principal que engloba a todas ellas. El</p>
<p>c√≥digo limpio siempre parece que ha</p>
<p>sido escrito por alguien quien le</p>
<p>importa. No hay nada evidente que</p>
<p>hacer para mejorarlo. El autor del</p>
<p>c√≥digo pens√≥ en todos los aspectos</p>
<p>posibles si intentamos imaginar</p>
<p>alguna mejora, volvemos al punto de</p>
<p>partida y s√≥lo nos queda disfrutar del</p>
<p>c√≥digo que alguien quien le importa realmente nos ha</p>
<p>proporcionado.</p>
<p>Una palabra; dar importancia. Es el verdadero tema de este libro, que</p>
<p>incluso podr√≠a usar el subt√≠tulo ¬´ C√≥mo dar importancia al c√≥digo ¬ª.</p>
<p>Michael ha acertado de pleno. El c√≥digo limpio es aqu√©l al que se le ha</p>
<p>dado importancia. Alguien ha dedicado su tiempo para que sea sencillo y ha</p>
<p>prestado atenci√≥n a los detalles. Se ha preocupado.</p>
<p>Ron Jeffries, autor de Extreme</p>
<p>Programming Installed Extreme</p>
<p>Programming Adventures in C#</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Ron comenz√≥ su carrera como</p>
<p>programador con Fortran en Strategic Air</p>
<p>Command ha escrito c√≥digo para la</p>
<p>pr√°ctica totalidad de lenguajes y equipos.</p>
<p>Merece la pena fijarse en sus palabras:</p>
<p>En los √∫ltimos a√±os, comenc√©</p>
<p>pr√°cticamente termin√© con las reglas de</p>
<p>c√≥digo simple de Beck.</p>
<p>En orden de prioridad, el c√≥digo simple:</p>
<p>Ejecuta todas las pruebas.</p>
<p>No contiene duplicados.</p>
<p>Expresa todos los conceptos de dise√±o del sistema.</p>
<p>Minimiza el n√∫mero de entidades como clases, m√©todos,</p>
<p>funciones y similares.</p>
<p>De todos ellos, me quedo con la duplicaci√≥n. Cuando algo se repite</p>
<p>una y otra vez, es una se√±al de que tenemos una idea que no acabamos</p>
<p>de representar correctamente en el c√≥digo. Intento determinar cu√°l es</p>
<p>y, despu√©s, expresar esa idea con mayor claridad. Para m√≠, la</p>
<p>expresividad debe incluir nombres con sentido y estoy dispuesto a</p>
<p>cambiar los nombres de las cosas varias veces. Con las modernas</p>
<p>herramientas de creaci√≥n de c√≥digo como Eclipse, el cambio de</p>
<p>nombres es muy sencillo, por lo que no me supone problema alguno.</p>
<p>La expresividad va m√°s all√° de los nombres. Tambi√©n me fijo si un</p>
<p>objeto o un m√©todo hacen m√°s de una cosa. Si se trata de un objeto,</p>
<p>probablemente tenga que dividirse en dos o m√°s. Si se trata de un</p>
<p>m√©todo, siempre recurro a la refactorizaci√≥n de extracci√≥n de m√©todos</p>
<p>para generar un m√©todo que exprese con mayor claridad su cometido</p>
<p>y varios m√©todos secundarios que expliquen c√≥mo lo hace.</p>
<p>La duplicaci√≥n y la expresividad son dos factores que permiten</p>
<p>mejorar considerablemente c√≥digo que no sea limpio. Sin embargo,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>existe otra cosa que tambi√©n hago conscientemente, aunque sea m√°s</p>
<p>dif√≠cil de explicar.</p>
<p>Tras a√±os en este trabajo, creo que todos los programas est√°n</p>
<p>formados de elementos muy similares. Un ejemplo es la b√∫squeda de</p>
<p>elementos en una colecci√≥n. Independientemente de que sea una base</p>
<p>de datos de registros de empleados o un mapa de claves y valores, o</p>
<p>una matriz de elementos, por lo general tenemos que buscar un</p>
<p>elemento concreto de esa colecci√≥n. Cuando esto sucede, suelo incluir</p>
<p>esa implementaci√≥n concreta en un m√©todo una clase m√°s</p>
<p>abstractos. De ese modo disfruto de una serie de interesantes ventajas.</p>
<p>Puedo implementar la funcionalidad con algo sencillo, como un mapa</p>
<p>hash, por ejemplo, pero como ahora todas las referencias la</p>
<p>b√∫squeda se ocultan en mi peque√±a abstracci√≥n, puedo modificar la</p>
<p>implementaci√≥n siempre que desee. Puedo avanzar r√°pidamente al</p>
<p>tiempo que conservo la posibilidad de realizar cambios posteriores.</p>
<p>Adem√°s, la abstracci√≥n de la colecci√≥n suele captar mi atenci√≥n en lo</p>
<p>que realmente sucede e impide que implemente comportamientos de</p>
<p>colecciones arbitrarias si lo que realmente necesito es una forma</p>
<p>sencilla de localizar un elemento.</p>
<p>Reducir los duplicados, maximizar la expresividad y dise√±ar sencillas</p>
<p>abstracciones en las fases iniciales. Para m√≠, es lo que hace que el</p>
<p>c√≥digo sea limpio.</p>
<p>En estos breves p√°rrafos, Ron resume el contenido de este libro. Nada de</p>
<p>duplicados, un objetivo, expresividad y peque√±as abstracciones. Todo est√°</p>
<p>ah√≠.</p>
<p>Ward Cunningham, inventor de Wiki, Fit,</p>
<p>y uno de los inventores de la programaci√≥n</p>
<p>eXtreme. Uno de los impulsores de los</p>
<p>patrones de dise√±o. Una de las mentes tras</p>
<p>Smalltalk y la programaci√≥n orientada a</p>
<p>objetos. El padrino de todos a los que les</p>
<p>importa el c√≥digo.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Sabemos que estamos trabajando con</p>
<p>c√≥digo limpio cuando cada rutina que</p>
<p>leemos resulta ser lo que esper√°bamos.</p>
<p>Se puede denominar c√≥digo atractivo</p>
<p>cuando el c√≥digo hace que parezca que</p>
<p>el lenguaje se ha creado para el</p>
<p>problema en cuesti√≥n.</p>
<p>Este tipo de afirmaciones son</p>
<p>caracter√≠sticas de Ward. Las leemos,</p>
<p>asentimos y pasamos a la siguiente. Es tan</p>
<p>razonable y evidente que apenas parece profundo. Incluso podemos pensar</p>
<p>que es lo que esper√°bamos. Pero preste atenci√≥n.</p>
<p>¬´... resulta ser lo que esper√°bamos¬ª. ¬øCu√°ndo fue la √∫ltima vez que vio</p>
<p>un m√≥dulo que fuera m√°s o menos lo que esperaba? ¬øLo habitual no es ver</p>
<p>m√≥dulos complicados y enrevesados? ¬øNo es esta falta de concreci√≥n lo</p>
<p>habitual? ¬øNo est√° acostumbrado a intentar extraer el razonamiento de un</p>
<p>sistema para llegar al m√≥dulo que est√° leyendo? ¬øCu√°ndo fue la √∫ltima vez</p>
<p>que ley√≥ un c√≥digo y asinti√≥ como seguramente haya hecho al leer la</p>
<p>afirmaci√≥n de Ward?</p>
<p>Ward espera que al leer c√≥digo limpio no le sorprenda. De hecho, ni</p>
<p>siquiera tendr√° que esforzarse. Lo leer√° y ser√° pr√°cticamente lo que esperaba.</p>
<p>Ser√° evidente, sencillo y atractivo. Cada m√≥dulo prepara el camino del</p>
<p>siguiente. Cada uno indica c√≥mo se escribir√° el siguiente. Los programas</p>
<p>limpios est√°n tan bien escritos que ni siquiera se dar√° cuenta. El dise√±ador</p>
<p>consigue simplificarlo todo enormemente, como sucede con todos los dise√±os</p>
<p>excepcionales.</p>
<p>¬øY la noci√≥n de atractivo de Ward? Todos hemos criticado que nuestros</p>
<p>lenguajes no se hayan dise√±ado para nuestros problemas. Pero la afirmaci√≥n</p>
<p>de Ward hace que ahora la responsabilidad sea nuestra. Afirma que el c√≥digo</p>
<p>atractivo hace que el lenguaje parezca creado para el problema . Por tanto,</p>
<p>somos responsables de que el lenguaje parezca sencillo. No es el lenguaje el</p>
<p>que hace que los programas parezcan sencillos, sino el programador que</p>
<p>consigue que el lenguaje lo parezca.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="escuelas-de-pensamiento-15">Escuelas de pensamiento</h3>
<p>¬øY yo (Uncle Bob)? ¬øQu√© es para m√≠ el</p>
<p>c√≥digo limpio? En este libro le contaremos,</p>
<p>con todo detalle, lo que yo y mis colegas</p>
<p>pensamos del c√≥digo limpio. Le contaremos</p>
<p>lo que pensamos que hace que un nombre</p>
<p>de variable, una funci√≥n o una clase sean</p>
<p>limpias.</p>
<p>Presentaremos estas opiniones de forma</p>
<p>absoluta, sin disculparnos. En este punto de</p>
<p>nuestra carrera, ya son absolutas. Son</p>
<p>nuestra escuela de pensamiento del c√≥digo</p>
<p>limpio.</p>
<p>Los especialistas de las artes marciales no se ponen de acuerdo sobre cu√°l</p>
<p>es la mejor de todas, ni siquiera sobre cu√°l es la mejor t√©cnica de un arte</p>
<p>marcial. Es habitual que los maestros de las artes marciales creen sus propias</p>
<p>escuelas de pensamiento y los alumnos aprendan de ellos. De esta forma</p>
<p>naci√≥ Gracie Jiu Jitsu , creada e impartida por la familia Gracie en Brasil;</p>
<p>Hakkoryu Jiu Jitsu , fundada e impartida por Okuyama Ryuho en Tokio o Jeet</p>
<p>Kune Do , fundada e impartida por Bruce Lee en Estados Unidos.</p>
<p>Los alumnos de estas disciplinas se sumergen en las ense√±anzas del</p>
<p>fundador. Se dedican a aprender lo que su maestro les ense√±a y suelen excluir</p>
<p>las ense√±anzas de otros maestros. Despu√©s, cuando han mejorado su arte,</p>
<p>pueden convertirse en alumnos de otro maestro diferente para ampliar sus</p>
<p>conocimientos su experiencia. Algunos seguir√°n mejorando sus</p>
<p>habilidades, descubriendo nuevas t√©cnicas y fundando sus propias escuelas.</p>
<p>Ninguna de estas escuelas tiene la raz√≥n absoluta pero dentro de cada una</p>
<p>actuamos como si las ense√±anzas y las t√©cnicas fueran correctas. Despu√©s de</p>
<p>todo, existe una forma correcta de practicar Hakkoryu Jiu Jitsu o Jeet Kune</p>
<p>Do, pero esta correcci√≥n dentro de una escuela determinada no anula las</p>
<p>ense√±anzas de otra diferente.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Imagine que este libro es una descripci√≥n de la Escuela de mentores del</p>
<p>c√≥digo limpio . Las t√©cnicas y ense√±anzas impartidas son la forma en la que</p>
<p>practicamos nuestro arte. Podemos afirmar que, si sigue nuestras ense√±anzas,</p>
<p>disfrutar√° de lo que hemos disfrutado nosotros, y aprender√° a crear c√≥digo</p>
<p>limpio y profesional. Pero no cometa el error de pensar que somos los √∫nicos</p>
<p>que tenemos raz√≥n. Existen otras escuelas y otros maestros tan profesionales</p>
<p>como nosotros, y su labor es aprender de ellos tambi√©n.</p>
<p>De hecho, muchas de las recomendaciones del libro son controvertidas,</p>
<p>seguramente no est√© de acuerdo con muchas de ellas y puede que rechace</p>
<p>algunas de forma definitiva. Es correcto. No somos la autoridad final. Pero,</p>
<p>por otra parte, las recomendaciones del libro son algo en lo que hemos</p>
<p>pensado mucho. Las hemos aprendido tras d√©cadas de experiencia y ensayo y</p>
<p>error. Por lo tanto, est√© o no de acuerdo, ser√≠a una l√°stima que no apreciara, y</p>
<p>respetara, nuestro punto de vista.</p>
<h3 id="somos-autores-16">Somos autores</h3>
<p>El campo @author de un Javadoc indica qui√©nes somos. Somos autores. Y los</p>
<p>autores tienen lectores. De hecho, los autores son responsables de</p>
<p>comunicarse correctamente con sus lectores. La pr√≥xima vez que escriba una</p>
<p>l√≠nea de c√≥digo, recuerde que es un autor y que escribe para que sus lectores</p>
<p>juzguen su esfuerzo.</p>
<p>Seguramente se pregunte qu√© cantidad de c√≥digo se lee realmente y si la</p>
<p>mayor parte del esfuerzo no se concentra en crearlo.</p>
<p>¬øAlguna vez ha reproducido una sesi√≥n de edici√≥n? En las d√©cadas de</p>
<p>1980 y 1990 ten√≠amos editores como Emacs que controlaban cada pulsaci√≥n</p>
<p>de tecla. Se pod√≠a trabajar durante una hora y despu√©s reproducir la sesi√≥n de</p>
<p>edici√≥n completa como una pel√≠cula a alta velocidad. Cuando lo hice, los</p>
<p>resultados fueron fascinantes.</p>
<p>La mayor parte de la reproducci√≥n eran desplazamientos entre m√≥dulos.</p>
<p>Bob accede al m√≥dulo.</p>
<p>Se desplaza hasta la funci√≥n que tiene que cambiar.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Se detiene y piensa en las posibles opciones.</p>
<p>Oh, vuelve al inicio del m√≥dulo para comprobar la inicializaci√≥n de</p>
<p>una variable.</p>
<p>Ahora vuelve a bajar y comienza a escribir.</p>
<p>Vaya, borra lo que hab√≠a escrito.</p>
<p>Vuelve a escribirlo.</p>
<p>Lo vuelve a borrar.</p>
<p>Escribe algo diferente pero tambi√©n lo borra.</p>
<p>Se desplaza otra funci√≥n que invoca la funci√≥n que est√°</p>
<p>modificando para comprobar c√≥mo se invoca.</p>
<p>Vuelve a subir y escribe el mismo c√≥digo que acaba de borrar.</p>
<p>Se detiene.</p>
<p>Vuelve a borrar el c√≥digo.</p>
<p>Abre otra ventana y examina las subclases. ¬øSe ha reemplazado esa</p>
<p>funci√≥n?</p>
<p>...</p>
<p>Se hace una idea. En realidad, la proporci√≥n entre tiempo dedicado a leer</p>
<p>frente a tiempo dedicado a escribir es de m√°s de 10:1. Constantemente</p>
<p>tenemos que leer c√≥digo antiguo como parte del esfuerzo de crear c√≥digo</p>
<p>nuevo.</p>
<p>Al ser una proporci√≥n tan elevada, queremos que la lectura del c√≥digo sea</p>
<p>sencilla, aunque eso complique su creaci√≥n. Evidentemente, no se puede</p>
<p>escribir c√≥digo sin leerlo, de modo que si es m√°s f√°cil de leer ser√° m√°s f√°cil</p>
<p>de escribir</p>
<p>Es una l√≥gica sin escapatoria. No se puede escribir c√≥digo si no se puede</p>
<p>leer el c√≥digo circundante. El c√≥digo que intente escribir hoy ser√° f√°cil o</p>
<p>dif√≠cil de escribir en funci√≥n de lo f√°cil o dif√≠cil de leer que sea el c√≥digo</p>
<p>circundante. Si quiere avanzar r√°pidamente, terminar cuanto antes y que su</p>
<p>c√≥digo sea f√°cil de escribir, haga que sea f√°cil de leer.</p>
<h3 id="la-regla-del-boy-scout-17">La regla del Boy Scout</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>No basta con escribir c√≥digo correctamente. El c√≥digo debe limpiarse con el</p>
<p>tiempo. Todos hemos visto que el c√≥digo se corrompe con el tiempo, de</p>
<p>modo que debemos adoptar un papel activo para evitarlo.</p>
<p>Los Boy Scouts norteamericanos tienen una sencilla regla que podemos</p>
<p>aplicar a nuestra profesi√≥n:</p>
<p>[5]</p>
<p>Dejar el campamento m√°s limpio de lo que se ha encontrado</p>
<p>Si todos entregamos el c√≥digo m√°s limpio de lo que lo hemos recibido, no</p>
<p>se corromper√°. No hace falta que la limpieza sea masiva. Cambie el nombre</p>
<p>de una variable, divida una funci√≥n demasiado extensa, elimine elementos</p>
<p>duplicados, simplifique una instrucci√≥n if compuesta.</p>
<p>¬øSe imagina trabajar en un proyecto en el que el c√≥digo mejorara con el</p>
<p>tiempo? ¬øCree que hay otras opciones que puedan considerarse</p>
<p>profesionales? De hecho, ¬øla mejora continuada no es una parte intr√≠nseca de</p>
<p>la profesionalidad?</p>
<h3 id="precuela-y-principios-18">Precuela y principios</h3>
<p>En muchos aspectos, este libro es una ¬´precuela¬ª de otro que escrib√≠ en 2002</p>
<p>titulado Agile Software Development: Principles, Patterns, and Practices</p>
<p>(PPP). El libro PPP trata sobre los principios del dise√±o orientado a objetos y</p>
<p>muchas de las t√©cnicas empleadas por desarrolladores profesionales. Si no ha</p>
<p>le√≠do PPP, comprobar√° que contin√∫a la historia contada en este libro. Si lo ha</p>
<p>le√≠do, encontrar√° muchas de las sensaciones de ese libro reproducidas en √©ste</p>
<p>a nivel del c√≥digo.</p>
<p>En este libro encontrar√° referencias espor√°dicas a distintos principios de</p>
<p>dise√±o como SRP Single Responsibility Principle Principio de</p>
<p>responsabilidad √∫nica), OCP Open Closed Principle Principio</p>
<p>Abierto/Cerrado) y DIP ( Dependency Inversion Principle o Principio de</p>
<p>inversi√≥n de dependencias) entre otros. Todos estos principios se describen</p>
<p>detalladamente en PPP.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="conclusion-19">Conclusi√≥n</h3>
<p>Los libros sobre arte no le prometen que se convertir√° en artista. Solamente</p>
<p>pueden mostrarle herramientas, t√©cnicas y procesos de pensamiento que otros</p>
<p>artistas hayan utilizado. Del mismo modo, este libro no puede prometer que</p>
<p>se convierta en un buen programador, que tenga sentido del c√≥digo. S√≥lo</p>
<p>puede mostrarle los procesos de pensamiento de buenos programadores y los</p>
<p>trucos, t√©cnicas y herramientas que emplean.</p>
<p>Al igual que un libro sobre arte, este libro est√° repleto de detalles.</p>
<p>Encontrar√° mucho c√≥digo. Ver√° c√≥digo correcto y c√≥digo incorrecto. Ver√°</p>
<p>c√≥digo incorrecto transformado en c√≥digo correcto. Ver√° listas de heur√≠stica,</p>
<p>disciplinas y t√©cnicas. Ver√° un ejemplo tras otro. Y despu√©s de todo, ser√°</p>
<p>responsabilidad suya.</p>
<p>¬øRecuerda el chiste sobre el violinista que se pierde camino de un</p>
<p>concierto? Se cruza con un anciano y le pregunta c√≥mo llegar al Teatro Real.</p>
<p>El anciano mira al violinista y al viol√≠n que lleva bajo el brazo y le responde:</p>
<p>¬´Practique joven, practique¬ª.</p>
<h3 id="bibliografia-20">Bibliograf√≠a</h3>
<p>[Beck07] Implementation Patterns , Kent Beck, Addison-Wesley, 2007.</p>
<p>[Knuth92] Literate Programming , Donald E. Knuth, Center for the</p>
<p>Study of Language and Information, Leland Stanford Junior University,</p>
<p>1992.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="nombres-con-sentido-21">Nombres con sentido</h1>
<p>por Tim Ottinger</p>
<h3 id="introduccion-22">Introducci√≥n</h3>
<p>En el software , los nombres son omnipresentes. Aparecen en variables,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>funciones, argumentos, clases y paquetes. Asignamos nombres a archivos y a</p>
<p>directorios, a archivos jar, war y ear. Usamos nombres constantemente. Por</p>
<p>ello, debemos hacerlo bien. A continuaci√≥n, veremos algunas reglas b√°sicas</p>
<p>para crear nombres correctos.</p>
<h3 id="usar-nombres-que-revelen-las-intenciones-23">Usar nombres que revelen las intenciones</h3>
<p>Es f√°cil afirmar que los nombres deben revelar nuestras intenciones. Lo que</p>
<p>queremos recalcar es la importancia de hacerlo. Elegir nombres correctos</p>
<p>lleva tiempo, pero tambi√©n ahorra trabajo. Por ello, preste atenci√≥n a los</p>
<p>nombres y c√°mbielos cuando encuentre otros mejores. Todo el que lea su</p>
<p>c√≥digo se lo agradecer√°.</p>
<p>El nombre de una variable, funci√≥n o clase debe responder una serie de</p>
<p>cuestiones b√°sicas. Debe indicar por qu√© existe, qu√© hace y c√≥mo se usa. Si</p>
<p>un nombre requiere un comentario, significa que no revela su cometido.</p>
<p>int d; // tiempo transcurrido en d√≠as</p>
<p>El nombre no revela nada. No evoca una sensaci√≥n de tiempo</p>
<p>transcurrido, ni de d√≠as. Debe elegir un nombre que especifique lo que se</p>
<p>mide y la unidad de dicha medida:</p>
<p>int elapsedTimeInDays;</p>
<p>int daysSinceCreation;</p>
<p>int daysSinceModification;</p>
<p>int fileAgeInDays;</p>
<p>La elecci√≥n de nombres que revelen intenciones facilita</p>
<p>considerablemente la comprensi√≥n y la modificaci√≥n del c√≥digo. ¬øPara qu√©</p>
<p>sirve el siguiente c√≥digo?</p>
<p>public List&lt;int[]&gt; getThem() {</p>
<p>List&lt;int[]&gt; list1 = new ArrayList&lt;int[]&gt;();</p>
<p>for (int[] x : theList)</p>
<p>if (x[0] == 4)</p>
<p>list1.add(x);</p>
<p>return list1;</p>
<p>¬øPor qu√© es complicado saber la funci√≥n de este c√≥digo? No hay</p>
<p>expresiones complejas. Los espacios y el sangrado son razonables. S√≥lo hay</p>
<p>tres variables y dos constantes. Ni siquiera contiene clases complejas o</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>m√©todos polim√≥rficos, s√≥lo una lista de matrices (o eso parece).</p>
<p>El problema no es la simplicidad del c√≥digo sino su car√°cter impl√≠cito : el</p>
<p>grado en el que el contexto no es expl√≠cito en el propio c√≥digo.</p>
<p>Impl√≠citamente, el c√≥digo requiere que sepamos las respuestas a las siguientes</p>
<p>preguntas:</p>
<p>¬øQu√© contiene theList</p>
<p>¬øQu√© significado tiene el sub√≠ndice cero de un elemento de theList</p>
<p>¬øQu√© importancia tiene el valor</p>
<p>¬øC√≥mo se usa la lista devuelta?</p>
<p>Las respuestas a estas preguntas no se encuentran en el c√≥digo, pero se</p>
<p>podr√≠an haber incluido. Imagine que trabaja en un juego de buscar minas. El</p>
<p>tablero es una lista de celdas llamada theList . Cambiemos el nombre por</p>
<p>gameBoard</p>
<p>Cada celda del teclado se representa por medio de una matriz. El</p>
<p>sub√≠ndice cero es la ubicaci√≥n de un valor de estado que, cuando es</p>
<p>significa que se ha detectado. Al asignar nombres estos conceptos</p>
<p>mejoramos considerablemente el c√≥digo:</p>
<p>public List&lt;int[]&gt; getFlaggedCells() {</p>
<p>List&lt;int[]&gt; flaggedCells = new ArrayList&lt;int[]&gt;();</p>
<p>for (int[] cell : gameBoard)</p>
<p>if (cell[STATUS_VALUE] == FLAGGED)</p>
<p>flaggedCells.add(cell);</p>
<p>return flaggedCells;</p>
<p>La simplicidad del c√≥digo no ha cambiado. Sigue teniendo los mismos</p>
<p>operadores y constantes y el mismo n√∫mero de niveles anidados, pero ahora</p>
<p>es mucho m√°s expl√≠cito. Podemos crear una sencilla clase para celdas en</p>
<p>lugar de usar una matriz de elementos int . Puede incluir una funci√≥n que</p>
<p>revele el objetivo (con el nombre isFlagged ) para ocultar los n√∫meros. El</p>
<p>resultado es una nueva versi√≥n de la funci√≥n:</p>
<p>public List&lt;Cell&gt; getFlaggedCells() {</p>
<p>List&lt;Cell&gt; flaggedCells = new ArrayList&lt;Cell&gt;();</p>
<p>for (Cell cell : gameBoard)</p>
<p>if (cell.isFlagged())</p>
<p>flaggedCells.add(cell);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return flaggedCells;</p>
<p>Con estos sencillos cambios de nombre, es f√°cil saber qu√© sucede. Es la</p>
<p>ventaja de seleccionar nombres adecuados.</p>
<h3 id="evitar-la-desinformacion-24">Evitar la desinformaci√≥n</h3>
<p>Los programadores deben evitar dejar pistas falsas que dificulten el</p>
<p>significado del c√≥digo. Debemos evitar palabras cuyo significado se aleje del</p>
<p>que pretendemos. Por ejemplo, hp aix sco son nombres de variables</p>
<p>pobres ya que son los nombres de plataformas o variantes de Unix. Aunque</p>
<p>se trate del c√≥digo de una hipotenusa y hp parezca la abreviatura correcta,</p>
<p>puede no serlo.</p>
<p>No haga referencia a un grupo de cuentas como accountList a menos</p>
<p>que realmente sea una lista ( List ). La palabra lista tiene un significado</p>
<p>concreto para los programadores. Si el contenedor de las cuentas no es</p>
<p>[6]</p>
<p>realmente una lista, puede provocar falsas conclusiones . Por tanto, resulta</p>
<p>m√°s adecuado usar accountGroup bunchOfAccounts simplemente</p>
<p>accounts</p>
<p>Evite usar nombres con variaciones m√≠nimas. ¬øCu√°nto se tarda en</p>
<p>apreciar la sutil diferencia entre</p>
<p>XYZControllerForEfficientHandlingOfStrings</p>
<p>XYZControllerForEfficientStorageOfStrings en un m√≥dulo? Ambas</p>
<p>palabras tienen una forma similar.</p>
<p>La ortograf√≠a similar de conceptos parecidos es informaci√≥n; el uso de</p>
<p>ortograf√≠a incoherente es desinformaci√≥n. En los entornos modernos de Java,</p>
<p>el c√≥digo se completa de forma autom√°tica. Escribimos varios caracteres de</p>
<p>un nombre y pulsamos varias teclas para obtener una lista de posibles</p>
<p>opciones de un nombre. Es muy √∫til si los nombres de elementos similares se</p>
<p>ordenan alfab√©ticamente de forma conjunta y si las diferencias son muy</p>
<p>evidentes, ya que es probable que el programador elija un objeto por nombre</p>
<p>sin fijarse en los comentarios o la lista de m√©todos proporcionados por una</p>
<p>clase.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Un ejemplo de nombre desinformativo ser√≠a el uso de la min√∫scula o la</p>
<p>may√∫scula como nombres de variables, sobre todo combinados. El</p>
<p>problema, evidentemente, es que se parecen las constantes</p>
<p>respectivamente:</p>
<p>int a = l;</p>
<p>if ( O == l )</p>
<p>a = O1;</p>
<p>else</p>
<p>l = 01;</p>
<p>El lector puede pensar que es una invenci√≥n, pero hemos visto c√≥digo con</p>
<p>abundancia de estos elementos. En un caso, el autor del c√≥digo, sugiri√≥ usar</p>
<p>una fuente distinta para que las diferencias fueran m√°s evidentes, una</p>
<p>soluci√≥n que se hubiera transmitido a todos los futuros programadores como</p>
<p>tradici√≥n oral o en un documento escrito. El problema se resolvi√≥ con</p>
<p>car√°cter definitivo y sin necesidad de crear nuevos productos, con tan s√≥lo</p>
<p>cambiar los nombres.</p>
<h3 id="realizar-distinciones-con-sentido-25">Realizar distinciones con sentido</h3>
<p>Los programadores se crean un problema al</p>
<p>crear c√≥digo √∫nicamente dirigido un</p>
<p>compilador o int√©rprete. Por ejemplo, como</p>
<p>se puede usar el mismo nombre para hacer</p>
<p>referencia a dos elementos distintos en el</p>
<p>mismo √°mbito, puede verse tentado a cambiar un nombre de forma arbitraria.</p>
<p>En ocasiones se hace escribi√©ndolo incorrectamente, lo que provoca que los</p>
<p>[7]</p>
<p>errores ortogr√°ficos impidan la compilaci√≥n</p>
<p>No basta con a√±adir series de n√∫meros o palabras adicionales, aunque eso</p>
<p>satisfaga al compilador. Si los nombres tienen que ser distintos, tambi√©n</p>
<p>deben tener un significado diferente.</p>
<p>Los nombres de series num√©ricas ( a1 a2 ... aN ) son lo contrario a los</p>
<p>nombres intencionados. No desinforman, simplemente no ofrecen</p>
<p>informaci√≥n; son una pista sobre la intenci√≥n del autor. F√≠jese en lo siguiente:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public static void copyChars(char a1[], char a2[]) {</p>
<p>for (int i = 0; i &lt; a1.length; i++) {</p>
<p>a2[i] = a1[i];</p>
<p>Esta funci√≥n se lee mejor cuando se usa source destination como</p>
<p>nombres de argumentos.</p>
<p>Las palabras adicionales son otra distinci√≥n sin sentido. Imagine que tiene</p>
<p>la clase Product. Si tiene otra clase con el nombre ProductInfo</p>
<p>ProductData , habr√° creado nombres distintos, pero con el mismo significado.</p>
<p>Info Data son palabras adicionales, como an the</p>
<p>No es incorrecto usar prefijos como the mientras la distinci√≥n tenga</p>
<p>sentido. Imagine que usa para variables locales y for para argumentos de</p>
<p>[8]</p>
<p>funciones . El problema aparece cuando decide invocar la variable theZork</p>
<p>porque ya tiene otra variable con el nombre zork</p>
<p>Las palabras adicionales son redundantes. La palabra variable no debe</p>
<p>incluirse nunca en el nombre de una variable. La palabra table no debe</p>
<p>incluirse nunca en el nombre de una tabla. ¬øEs mejor NameString que Name</p>
<p>¬øPodr√≠a ser Name un n√∫mero de coma flotante? En caso afirmativo, incumple</p>
<p>la regla anterior sobre desinformaci√≥n. Imagine que encuentra una clase con</p>
<p>el nombre Customer y otra con el nombre CustomerObject . ¬øCu√°l ser√≠a la</p>
<p>distinci√≥n? ¬øCu√°l representa mejor el historial de pagos de un cliente?</p>
<p>Existe una aplicaci√≥n que lo ilustra. Hemos cambiado los nombres para</p>
<p>proteger al culpable. Veamos el error exacto:</p>
<p>getActiveAccount();</p>
<p>getActiveAccounts();</p>
<p>getActiveAccountInfo();</p>
<p>¬øC√≥mo saben los programadores de este proyecto qu√© funci√≥n deben</p>
<p>invocar?</p>
<p>En ausencia de convenciones concretas, la variable moneyAmount no se</p>
<p>distingue de money customerInfo no se distingue de customer accountData</p>
<p>no se distingue de account theMessage no se distingue de message . Debe</p>
<p>diferenciar los nombres de forma que el lector aprecie las diferencias.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="usar-nombres-que-se-puedan-pronunciar-26">Usar nombres que se puedan pronunciar</h3>
<p>A los humanos se nos dan bien las palabras. Gran parte de nuestro cerebro se</p>
<p>dedica al concepto de palabras. Y, por definici√≥n, las palabras son</p>
<p>pronunciables. Ser√≠a una pena malgastar esa parte de nuestro cerebro</p>
<p>dedicada al lenguaje hablado. Por tanto, cree nombres pronunciables. Si no lo</p>
<p>puede pronunciar, no podr√° explicarlo sin parecer tonto. Es un factor</p>
<p>importante, ya que la programaci√≥n es una actividad social.</p>
<p>Conozco una empresa que usa genymdhms (fecha de generaci√≥n, a√±o, mes,</p>
<p>d√≠a, hora, minuto y segundo) y lo pronuncian tal cual. Yo tengo la costumbre</p>
<p>de pronunciar todo tal y como lo veo escrito, de forma que muchos analistas</p>
<p>y dise√±adores acabaron por llamarme algo como ¬´genimedemes¬ª. Era un</p>
<p>chiste y nos parec√≠a divertido, pero en realidad est√°bamos tolerando el uso de</p>
<p>nombres pobres. Ten√≠amos que explicar las variables los nuevos</p>
<p>programadores y cuando las pronunciaban, usaban palabras inventadas en</p>
<p>lugar de nombres correctos. Compare:</p>
<p>class DtaRcrd102 {</p>
<p>private Date genymdhms;</p>
<p>private Date modymdhms;</p>
<p>private final String pszqint = ‚Äú102‚Äù;</p>
<p>/*... */</p>
<p>};</p>
<p>con:</p>
<p>class Customer {</p>
<p>private Date generationTimestamp;</p>
<p>private Date modificationTimestamp;</p>
<p>private final String recordId = ‚Äú102‚Äù;</p>
<p>/*... */</p>
<p>};</p>
<p>Ahora se puede mantener una conversaci√≥n inteligente: ¬´Eh, Mikey, f√≠jate</p>
<p>en este registro. La marca de tiempo de generaci√≥n es para ma√±ana. ¬øC√≥mo</p>
<p>es posible?¬ª</p>
<h3 id="usar-nombres-que-se-puedan-buscar-27">Usar nombres que se puedan buscar</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Los nombres de una letra y las constantes num√©ricas tienen un problema: no</p>
<p>son f√°ciles de localizar en el texto. Se puede detectar</p>
<p>MAX_CLASSES_PER_STUDENT , pero el n√∫mero 7 resulta m√°s complicado. Las</p>
<p>b√∫squedas pueden devolver el d√≠gito como parte de nombres de archivo, otras</p>
<p>definiciones de constantes o expresiones en las que se use con otra intenci√≥n.</p>
<p>Mucho peor si la constante es un n√∫mero extenso y alguien ha intercambiado</p>
<p>los d√≠gitos, lo que genera un error inmediato y no aparece en la b√∫squeda.</p>
<p>Del mismo modo, el nombre es una opci√≥n muy pobre para variables</p>
<p>que el programador tenga que buscar. Es la letra m√°s usada en ingl√©s y</p>
<p>aparece en la pr√°ctica totalidad de los textos de un programa. A este respecto,</p>
<p>los nombres extensos superan a los breves y cualquier nombre que se pueda</p>
<p>buscar supera a una constante en el c√≥digo.</p>
<p>Personalmente prefiero nombres de una letra que s√≥lo se puedan usar</p>
<p>como variables locales dentro de m√©todos breves. La longitud de un nombre</p>
<p>debe corresponderse al tama√±o de su √°mbito [N5]. Si una variable o</p>
<p>constante se usa en varios puntos del c√≥digo, debe asignarle un nombre que</p>
<p>se pueda buscar. Compare:</p>
<p>for (int j=0; j&lt;34; j++) {</p>
<p>s += (t[j]*4)/5;</p>
<p>con:</p>
<p>int realDaysPerIdealDay = 4;</p>
<p>const int WORK_DAYS_PER_WEEK = 5;</p>
<p>int sum = 0;</p>
<p>for (int j = 0; j &lt; NUMBER_OF_TASKS; j++) {</p>
<p>int realTaskDays = taskEstimate[j] * realDaysPerIdealDay;</p>
<p>int realTaskWeeks = (realdays / WORK_DAYS_PER_WEEK);</p>
<p>sum += realTaskWeeks;</p>
<p>En este ejemplo, sum no es un nombre especialmente √∫til, pero al menos</p>
<p>se puede buscar. Se usa una funci√≥n m√°s extensa, pero comprobar√° que</p>
<p>resulta mucho m√°s f√°cil buscar WORK_DAYS_PER_WEEK que todas las instancias</p>
<p>de y filtrar la lista a los casos con el significado adecuado.</p>
<h3 id="evitar-codificaciones-28">Evitar codificaciones</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Ya tenemos suficientes codificaciones como para tener que a√±adir otras</p>
<p>nuevas. Al codificar informaci√≥n de tipos o √°mbitos en un nombre se dificulta</p>
<p>la descodificaci√≥n. No parece razonable que todos los nuevos empleados</p>
<p>tengan que aprender otro lenguaje de codificaci√≥n adem√°s del c√≥digo con el</p>
<p>que van a trabajar. Es una carga mental innecesaria a la hora de intentar</p>
<p>solucionar un problema. Los nombres codificados resultan impronunciables y</p>
<p>suelen escribirse de forma incorrecta.</p>
<h3 id="notacion-hungara-29">Notaci√≥n h√∫ngara</h3>
<p>Antiguamente, cuando trabaj√°bamos con lenguajes en los que la longitud de</p>
<p>los nombres era un reto, incumpl√≠amos esta regla a nuestro pesar. Fortran</p>
<p>forzaba las codificaciones convirtiendo la primera letra de un tipo en c√≥digo.</p>
<p>En sus primeras versiones, BASIC s√≥lo se permit√≠a una letra y un d√≠gito. La</p>
<p>notaci√≥n h√∫ngara (HN) lo llev√≥ a un nuevo nivel.</p>
<p>HN se consideraba muy importante en el API C de Windows, donde todo</p>
<p>era un control entero, un puntero long , un puntero void o una de varias</p>
<p>implementaciones de string (con diferentes usos y atributos). Por aquel</p>
<p>entonces, el compilador no comprobaba los tipos, de modo que los</p>
<p>programadores ten√≠an que recordarlos.</p>
<p>En los lenguajes modernos disponemos de sistemas de tipos m√°s</p>
<p>completos y los compiladores recuerdan los tipos y los aplican. Es m√°s,</p>
<p>existe una tendencia a usar clases y funciones m√°s breves para que los</p>
<p>usuarios aprecien la declaraci√≥n de las variables que usan.</p>
<p>Los programadores de Java no tienen que codificar tipos. Los objetos son</p>
<p>de tipos fuertes y los entornos de edici√≥n han avanzado tanto que detectan un</p>
<p>error de tipo antes de ejecutar la compilaci√≥n. Por ello, en la actualidad HN y</p>
<p>otras formas de codificaci√≥n de tipos no son m√°s que un impedimento. Hacen</p>
<p>que sea m√°s complicado cambiar el nombre o el tipo de una variable o clase.</p>
<p>Dificultan la legibilidad del c√≥digo y pueden hacer que el sistema de</p>
<p>codificaci√≥n confunda al lector:</p>
<p>PhoneNumber phoneString;</p>
<p>// el nombre no cambia cuando cambia el tipo</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="prefijos-de-miembros-30">Prefijos de miembros</h3>
<p>Tampoco es necesario a√±adir m_ como prefijo a los nombres de variables. Las</p>
<p>clases y funciones tienen el tama√±o necesario para no tener que hacerlo, y</p>
<p>debe usar un entorno de edici√≥n que resalte o coloree los miembros para</p>
<p>distinguirlos.</p>
<p>public class Part {</p>
<p>private String m_dsc; // La descripci√≥n textual</p>
<p>void setName(String name) {</p>
<p>m_dsc = name;</p>
<p>public class Part {</p>
<p>String description;</p>
<p>void setDescription(String description) {</p>
<p>this.description = description;</p>
<p>Adem√°s, los usuarios aprenden r√°pidamente a ignorar el prefijo (o sufijo)</p>
<p>y fijarse en la parte con sentido del nombre. Cuanto m√°s c√≥digo leemos,</p>
<p>menos nos fijamos en los prefijos. En √∫ltima instancia, los prefijos son un</p>
<p>indicio de c√≥digo antiguo.</p>
<h3 id="interfaces-e-implementaciones-31">Interfaces e Implementaciones</h3>
<p>Existe un caso especial para usar codificaciones. Imagine por ejemplo que</p>
<p>crea una factor√≠a abstracta para crear formas. Esta factor√≠a ser√° una interfaz y</p>
<p>se implementar√° por medio de una clase concreta. ¬øQu√© nombres debe</p>
<p>asignar? IShapeFactory ShapeFactory Prefiero las interfaces sin</p>
<p>adornos. La I inicial, tan habitual en los archivos de legado actuales es, en el</p>
<p>mejor de los casos, una distracci√≥n, y en el peor, un exceso de informaci√≥n.</p>
<p>No quiero que mis usuarios sepan que se trata de una interfaz, solamente que</p>
<p>se trata de ShapeFactory Si tengo que codificar la interfaz la</p>
<p>implementaci√≥n, opto por √©sta √∫ltima. Es mejor usar ShapeFactoryImp</p>
<p>incluso CShapeFactory , que codificar la interfaz.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="evitar-asignaciones-mentales-32">Evitar asignaciones mentales</h3>
<p>Los lectores no tienen que traducir mentalmente sus nombres en otros que ya</p>
<p>conocen. Este problema suele aparecer al elegir entre no usar t√©rminos de</p>
<p>dominio de problemas o de soluciones.</p>
<p>Es un problema de los nombres de variables de una sola letra. Un</p>
<p>contador de bucles se podr√≠a bautizar como (pero nunca ) si su</p>
<p>√°mbito es muy reducido y no hay conflictos con otros nombres, ya que los</p>
<p>nombres de una letra son tradicionales en contadores de bucles. Sin embargo,</p>
<p>en otros contextos, un nombre de una letra es una opci√≥n muy pobre: es como</p>
<p>un marcador de posici√≥n que el lector debe asignar mentalmente a un</p>
<p>concepto real. No hay peor motivo para usar el nombre que ya est√©n</p>
<p>seleccionados.</p>
<p>Por lo general, los programadores son gente inteligente. A la gente</p>
<p>inteligente le gusta presumir de sus habilidades mentales. Si puede recordar</p>
<p>que es la versi√≥n en min√∫scula de una URL sin el host y el sistema, debe ser</p>
<p>muy listo.</p>
<p>Una diferencia entre un programador inteligente un programador</p>
<p>profesional es que este √∫ltimo sabe que la claridad es lo que importa . Los</p>
<p>profesionales usan sus poderes para hacer el bien y crean c√≥digo que otros</p>
<p>puedan entender.</p>
<h3 id="nombres-de-clases-33">Nombres de clases</h3>
<p>Las clases y los objetos deben tener nombres o frases de nombre como</p>
<p>Customer WikiPage Account AddressParser Evite palabras como</p>
<p>Manager Processor Data , o Info en el nombre de una clase. El nombre de</p>
<p>una clase no debe ser un verbo.</p>
<h3 id="nombres-de-metodos-34">Nombres de m√©todos</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Los m√©todos deben tener nombres de verbo como postPayment deletePage</p>
<p>save . Los m√©todos de acceso, de modificaci√≥n y los predicados deben tener</p>
<p>como nombre su valor y usar como prefijo get set is de acuerdo al</p>
<p>[9]</p>
<p>est√°ndar de javabean</p>
<p>string name = employee.getName();</p>
<p>customer.setName(‚Äúmike‚Äù);</p>
<p>if (paycheck.isPosted())...</p>
<p>Al sobrecargar constructores, use m√©todos de factor√≠a est√°ticos con</p>
<p>nombres que describan los argumentos. Por ejemplo:</p>
<p>Complex fulcrumPoint = Complex.FromRealNumber(23.0);</p>
<p>es mejor que:</p>
<p>Complex fulcrumPoint = new Complex(23.0);</p>
<p>Refuerce su uso convirtiendo en privados sus constructores</p>
<p>correspondientes.</p>
<h3 id="no-se-exceda-con-el-atractivo-35">No se exceda con el atractivo</h3>
<p>Si los nombres son demasiado inteligentes,</p>
<p>s√≥lo los recordar√°n los que compartan el</p>
<p>sentido del humor de su autor, s√≥lo</p>
<p>mientras se acuerden del chiste. ¬øSabr√°n</p>
<p>qu√© significa la funci√≥n HolyHandGrenade</p>
<p>Sin duda es atractiva, pero en este caso</p>
<p>puede que DeleteItems fuera m√°s indicado. Opte por la claridad antes que</p>
<p>por el entretenimiento. En el c√≥digo, el atractivo suele aparecer como formas</p>
<p>coloquiales o jergas. Por ejemplo, no use whack() en lugar de kill() . No</p>
<p>recurra a bromas culturales como eatMyShorts() si quiere decir abort()</p>
<p>Diga lo que piense. Piense lo que diga.</p>
<h3 id="una-palabra-por-concepto-36">Una palabra por concepto</h3>
<p>Elija una palabra por cada concepto abstracto y mant√©ngala. Por ejemplo,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>resulta confuso usar fetch retrieve get como m√©todos equivalentes de</p>
<p>clases distintas. ¬øC√≥mo va a recordar qu√© m√©todo se corresponde a cada</p>
<p>clase? Desafortunadamente, tendr√° que recordar qu√© empresa, grupo</p>
<p>individuo ha creado la biblioteca o clase en cuesti√≥n para recordar qu√©</p>
<p>t√©rmino se ha empleado. En caso contrario, perder√° mucho tiempo buscando</p>
<p>en encabezados y fragmentos de c√≥digo.</p>
<p>Los entornos de edici√≥n modernos como Eclipse e IntelliJ ofrecen pistas</p>
<p>sensibles al contexto, como la lista de m√©todos que puede invocar en un</p>
<p>determinado objeto. Pero esta lista no suele incluir los comentarios de</p>
<p>nombres de funciones y listas de par√°metros. Tendr√° suerte si muestra los</p>
<p>nombres de par√°metros de las declaraciones de funciones. Los nombres de</p>
<p>funciones deben ser independientes y coherentes para que pueda elegir el</p>
<p>m√©todo correcto sin necesidad de b√∫squedas adicionales.</p>
<p>Del mismo modo, resulta confuso tener un controlador, un administrador</p>
<p>y un control en la misma base de c√≥digo. ¬øCu√°l es la diferencia entre</p>
<p>DeviceManager ProtocolController ¬øPor qu√© no son los dos</p>
<p>controladores o administradores? ¬øSon controladores? El nombre hace que</p>
<p>espere que dos objetos tengan un tipo diferente y clases diferentes.</p>
<p>Un l√©xico coherente es una gran ventaja para los programadores que</p>
<p>tengan que usar su c√≥digo.</p>
<h3 id="no-haga-juegos-de-palabras-37">No haga juegos de palabras</h3>
<p>Evite usar la misma palabra con dos fines distintos. Suele hacerse en juegos</p>
<p>de palabras. Si aplica la regla de una palabra por conceptos, acabar√° con</p>
<p>muchas clases que por ejemplo tengan un m√©todo add . Mientras las listas de</p>
<p>par√°metros los valores devueltos de los distintos m√©todos add sean</p>
<p>sem√°nticamente equivalentes, no hay problema.</p>
<p>Sin embargo, alguien puede decidir usar la palabra add por motivos de</p>
<p>coherencia, aunque no sea en el mismo sentido. Imagine que hay varias</p>
<p>clases en las que add crea un nuevo valor sumando o concatenando dos</p>
<p>valores existentes. Imagine ahora que crea una nueva clase con un m√©todo</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>que a√±ada su par√°metro a una colecci√≥n. ¬øEste m√©todo debe tener el m√©todo</p>
<p>add ? Parece coherente ya que hay otros muchos m√©todos add , pero en este</p>
<p>caso hay una diferencia sem√°ntica, de modo que debemos usar un nombre</p>
<p>como insert append . Llamar add al nuevo m√©todo ser√≠a un juego de</p>
<p>palabras.</p>
<p>Nuestro objetivo, como autores, es facilitar la comprensi√≥n del c√≥digo.</p>
<p>Queremos que el c√≥digo sea algo r√°pido, no un estudio exhaustivo. Queremos</p>
<p>usar un modelo en el que el autor sea el responsable de transmitir el</p>
<p>significado, no un modelo acad√©mico que exija investigar el significado</p>
<p>mostrado.</p>
<h3 id="usar-nombres-de-dominios-de-soluciones-38">Usar nombres de dominios de soluciones</h3>
<p>Recuerde que los lectores de su c√≥digo ser√°n programadores. Por ello, use</p>
<p>t√©rminos inform√°ticos, algoritmos, nombres de patrones, t√©rminos</p>
<p>matem√°ticos y dem√°s. No conviene extraer todos los nombres del dominio de</p>
<p>problemas ya que no queremos que nuestros colegas tengan que preguntar el</p>
<p>significado de cada nombre en especial cuando ya conocen el concepto bajo</p>
<p>otro nombre diferente.</p>
<p>El nombre AccountVisitor tiene mucho significado para un programador</p>
<p>familiarizado con el patr√≥n VISITOR . ¬øQu√© programador no sabe lo que es</p>
<p>JobQueue ? Hay cientos de cosas t√©cnicas que los programadores tienen que</p>
<p>hacer y elegir nombres t√©cnicos para dichas cosas suele ser lo m√°s adecuado.</p>
<h3 id="usar-nombres-de-dominios-de-problemas-39">Usar nombres de dominios de problemas</h3>
<p>Cuando no exista un t√©rmino de programaci√≥n para lo que est√© haciendo, use</p>
<p>el nombre del dominio de problemas. Al menos el programador que</p>
<p>mantenga su c√≥digo podr√° preguntar el significado a un experto en dominios.</p>
<p>Separar los conceptos de dominio de soluciones y de problemas es parte</p>
<p>del trabajo de un buen programador y dise√±ador. El c√≥digo que tenga m√°s</p>
<p>relaci√≥n con los conceptos del dominio de problemas tendr√° nombres</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>extra√≠dos de dicho dominio.</p>
<h3 id="anadir-contexto-con-sentido-40">A√±adir contexto con sentido</h3>
<p>Algunos nombres tienen significado por s√≠ mismos, pero la mayor√≠a no. Por</p>
<p>ello, debe incluirlos en un contexto, en clases, funciones y espacios de</p>
<p>nombres con nombres adecuados. Cuando todo lo dem√°s falle, pueden usarse</p>
<p>prefijos como √∫ltimo recurso.</p>
<p>Imagine que tiene las variables firstName lastName street</p>
<p>houseNumber city state y z ipcode . Si las combina, es evidente que forman</p>
<p>una direcci√≥n. Pero si la variable state se usa de forma aislada en un</p>
<p>m√©todo, ¬øsabr√≠a que forma parte de una direcci√≥n? Puede a√±adir contexto por</p>
<p>medio de prefijos: addrFirstName addrLastName addrState , etc. Al menos</p>
<p>los lectores comprender√°n que estas variables forman parte de una estructura</p>
<p>mayor. Evidentemente, es mejor crear la clase Address . De ese modo, incluso</p>
<p>el compilador sabr√° que las variables pertenecen a un concepto m√°s amplio.</p>
<p>F√≠jese en el m√©todo del Listado 2-1. ¬øLas variables necesitan un contexto</p>
<p>con m√°s sentido? El nombre de la funci√≥n s√≥lo ofrece parte del contexto, el</p>
<p>resto se obtiene del algoritmo. Tras leer la funci√≥n, ver√° que las tres variables</p>
<p>number verb pluralModifier forman parte del mensaje guess</p>
<p>statistics . Desafortunadamente, es necesario inferir el contexto. Al leer el</p>
<p>m√©todo, el significado de las variables no es evidente.</p>
<p>Listado 2-1</p>
<p>Variables en un contexto ambiguo.</p>
<p>private void printGuessStatistics(char candidate, int count) {</p>
<p>String number;</p>
<p>String verb;</p>
<p>String pluralModifier;</p>
<p>if (count == 0) {</p>
<p>number = ‚Äúno‚Äù;</p>
<p>verb = ‚Äúare‚Äù;</p>
<p>pluralModifier = ‚Äús‚Äù;</p>
<p>} else if (count == 1) {</p>
<p>number = ‚Äú1‚Äù;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>verb = ‚Äúis‚Äù;</p>
<p>pluralModifier = ‚Äú‚Äù;</p>
<p>} else {</p>
<p>number = Integer.toString(count);</p>
<p>verb = ‚Äúare‚Äù;</p>
<p>pluralModifier = ‚Äús‚Äù;</p>
<p>String guessMessage = String.format(</p>
<p>‚ÄúThere %s %s %s%s‚Äù, verb, number, candidate, pluralModifier</p>
<p>);</p>
<p>print(guessMessage);</p>
<p>La funci√≥n es demasiado extensa y las variables aparecen por todas</p>
<p>partes. Para dividir la funci√≥n en fragmentos m√°s reducidos necesitamos crear</p>
<p>una clase GuessStatisticsMessage convertir las tres variables en</p>
<p>campos de la misma. De este modo contamos con un contexto m√°s obvio</p>
<p>para las tres variables. Forman parte sin duda de GuessStatisticsMessage</p>
<p>La mejora del contexto tambi√©n permite que el algoritmo sea m√°s limpio y se</p>
<p>divida en funciones m√°s reducidas (v√©ase el Listado 2-2).</p>
<p>Listado 2-2</p>
<p>Variables con un contexto.</p>
<p>public class GuessStatisticsMessage (</p>
<p>private String number;</p>
<p>private String verb;</p>
<p>private String pluralModifier;</p>
<p>public String make(char candidate, int count) {</p>
<p>createPluralDependentMessageParts(count);</p>
<p>return String.format(</p>
<p>‚ÄúThere %s %s %s%s,</p>
<p>verb, number, candidate, pluralModifier);</p>
<p>private void createPluralDependentMessageParts(int count) {</p>
<p>if (count == 0) {</p>
<p>thereAreNoLetters();</p>
<p>} else if (cout == 1) {</p>
<p>thereIsOneLetter();</p>
<p>} else {</p>
<p>thereAreManyLetters(count);</p>
<p>private void thereAreManyLetters(int count) {</p>
<p>number = ‚Äú1‚Äù;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>verb = ‚Äúis‚Äù;</p>
<p>pluralModifier = ‚Äú‚Äù;</p>
<p>private void thereIsOneLetter() {</p>
<p>number = ‚Äú1‚Äù;</p>
<p>verb = ‚Äúis‚Äù;</p>
<p>pluralModifier = ‚Äú‚Äù;</p>
<p>private void thereAreNoLetters() {</p>
<p>number = ‚Äúno‚Äù;</p>
<p>verb = ‚Äúare‚Äù;</p>
<p>pluralModifier = ‚Äús‚Äù;</p>
<h3 id="no-anadir-contextos-innecesarios-41">No a√±adir contextos innecesarios</h3>
<p>En la aplicaci√≥n imaginaria Gas Station Deluxe, no es aconsejable usar el</p>
<p>prefijo GSD en todas las clases. Es trabajar contra las herramientas</p>
<p>proporcionadas. Introduzca y pulse la tecla de finalizaci√≥n para acceder a</p>
<p>una lista interminable de todas las clases del sistema. ¬øEs lo correcto? ¬øPor</p>
<p>qu√© dificultar la ayuda del IDE?</p>
<p>Del mismo modo, imagine que ha creado la clase MailingAddress en un</p>
<p>m√≥dulo de contabilidad de GSD , con el nombre GSDAccountAddress . Despu√©s,</p>
<p>necesita una direcci√≥n de correo para la aplicaci√≥n de contacto con el cliente.</p>
<p>¬øUsar√° GSDAccountAddress ? ¬øLe parece el nombre correcto? 10 de los 17</p>
<p>caracteres son redundantes o irrelevantes.</p>
<p>Los nombres breves suelen ser m√°s adecuados que los extensos, siempre</p>
<p>que sean claros. No a√±ada m√°s contexto del necesario a un nombre. Los</p>
<p>nombres accountAddress customerAddress son perfectos para instancias</p>
<p>de la clase Address pero no sirven como nombres de clase. Address sirve</p>
<p>como nombre de clase. Para distinguir entre direcciones MAC, direcciones de</p>
<p>puertos y direcciones Web, podr√≠a usar PostalAddress MAC URI . Los</p>
<p>nombres resultantes son m√°s precisos, el objetivo de cualquier nombre.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="conclusion-42">Conclusi√≥n</h3>
<p>Lo m√°s complicado a la hora de elegir un buen nombre es que requiere</p>
<p>habilidad descriptiva y acervo cultural. Es un problema de formaci√≥n m√°s</p>
<p>que t√©cnico, empresarial o administrativo. Como resultado, mucha gente del</p>
<p>sector no aprende a hacerlo bien.</p>
<p>La gente teme que al cambiar los nombres otros programadores se quejen.</p>
<p>Nosotros no compartimos ese temor y agradecemos los cambios de nombre</p>
<p>(siempre que sean a mejor). En muchos casos no memorizamos los nombres</p>
<p>de clases y m√©todos. Usamos herramientas modernas para estos detalles y as√≠</p>
<p>poder centrarnos en si el c√≥digo se lee como frases o p√°rrafos, o al menos</p>
<p>como tablas y estructuras de datos (una frase no siempre es la mejor forma de</p>
<p>mostrar datos). Seguramente acabar√° sorprendiendo a alguien cuando cambie</p>
<p>los nombres, como puede suceder con cualquier otra mejora del c√≥digo. No</p>
<p>deje que le detenga.</p>
<p>Aplique estas reglas y compruebe si mejora o no la legibilidad de su</p>
<p>c√≥digo. Si es el encargado de mantener c√≥digo de terceros, use herramientas</p>
<p>para solucionar estos problemas. Obtendr√° recompensas a corto y largo plazo.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="funciones-43">Funciones</h1>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>En los inicios de la programaci√≥n, cre√°bamos sistemas a partir de rutinas y</p>
<p>subrutinas. Despu√©s, en la √©poca de Fortran y PL/1, cre√°bamos nuestros</p>
<p>sistemas con programas, subprogramas y funciones. En la actualidad, s√≥lo las</p>
<p>funciones han sobrevivido. Son la primera l√≠nea organizativa en cualquier</p>
<p>programa. En este cap√≠tulo veremos c√≥mo crearlas.</p>
<p>F√≠jese en el c√≥digo del Listado 3-1. Es complicado encontrar una funci√≥n</p>
<p>[10]</p>
<p>extensa en FitNesse , pero acab√© encontrando √©sta. No s√≥lo es extensa, sino</p>
<p>que tambi√©n contiene c√≥digo duplicado, muchas cadenas y tipos de datos</p>
<p>extra√±os, adem√°s de API poco habituales nada evidentes. Intente</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>comprenderlo en los pr√≥ximos tres minutos.</p>
<p>Listado 3-1</p>
<p>HtmlUtil.java (FitNesse 20070619).</p>
<p>public static String testableHtml {</p>
<p>PageData pageData,</p>
<p>boolean includeSuiteSetup</p>
<p>} throws Exception {</p>
<p>WikiPage wikiPage = pageData.getWikiPage();</p>
<p>StringBuffer buffer = new StringBuffer();</p>
<p>if (pageData.hasAttribute(‚ÄúTest‚Äù)) {</p>
<p>if (includeSuiteSetup) {</p>
<p>WikiPage suiteSetup =</p>
<p>PageCrawlerImpl.getInheritedPage(</p>
<p>SuiteResponder.SUITE_SETUP_NAME, wikiPage</p>
<p>);</p>
<p>if (suiteSetup != null) {</p>
<p>WikiPagePath pagePath =</p>
<p>suiteSetup.getPageCrawler().getFullPath (suiteSetup);</p>
<p>String pagePathName = PathParser.render(pagePath);</p>
<p>buffer.append(‚Äú!include -setup .‚Äù)</p>
<p>.append(pagePathName)</p>
<p>.append(‚Äú\n‚Äù);</p>
<p>WikiPage setup =</p>
<p>PageCrawlerImpl.getInheritedPage(‚ÄúSetUp‚Äù, wikiPage);</p>
<p>if (setup != null) {</p>
<p>WikiPagePath setupPath =</p>
<p>wikiPage.getPageCrawler().getFullPath(setup);</p>
<p>String setupPathName = PathParser.render(setupPath);</p>
<p>buffer.append(‚Äú!include -setup .‚Äù)</p>
<p>.append(setupPathName)</p>
<p>.append(‚Äú\n‚Äù);</p>
<p>buffer.append(pageData.getContent());</p>
<p>if (pageData.hasAttribute(‚ÄúTest‚Äù)) {</p>
<p>WikiPage teardown =</p>
<p>PageCrawlerImpl.getInheritedPage(‚ÄúTearDown‚Äù, wikiPage);</p>
<p>if (teardown != null) {</p>
<p>WikiPagePath tearDownPath =</p>
<p>wikiPage.getPageCrawler().getFullPath(teardown);</p>
<p>String tearDownPathName = PathParser.render(tearDownPath);</p>
<p>buffer.append(‚Äú\n‚Äù)</p>
<p>.append(‚Äú!include -teardown .‚Äù)</p>
<p>.append(tearDownPathName)</p>
<p>.append(‚Äú\n‚Äù);</p>
<p>if (includeSuiteSetup) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>WikiPage suiteTeardown =</p>
<p>PageCrawlerImpl.getInheritedPage(</p>
<p>SuiteResponder.SUITE_TEARDOWN_NAME,</p>
<p>wikiPage</p>
<p>);</p>
<p>if (suiteTeardown != null) {</p>
<p>WikiPagePath pagePath =</p>
<p>suiteTeardown.getPageCrawler().getFullPath (suiteTeardown);</p>
<p>String pagePathName = PathParser.render(pagePath);</p>
<p>buffer.append(‚Äú!include -teardown .‚Äù)</p>
<p>.append(pagePathName)</p>
<p>.append(‚Äú\n‚Äù);</p>
<p>pageData.setContent(buffer.toString());</p>
<p>return pageData.getHtml();</p>
<p>¬øTras tres minutos entiende la funci√≥n? Seguramente no. Pasan</p>
<p>demasiadas cosas y hay demasiados niveles de abstracci√≥n diferentes. Hay</p>
<p>cadenas extra√±as e invocaciones de funciones mezcladas en instrucciones if</p>
<p>doblemente anidadas controladas por indicadores. Sin embargo, con sencillas</p>
<p>extracciones de c√≥digo, alg√∫n cambio de nombres y cierta reestructuraci√≥n,</p>
<p>pude capturar la intenci√≥n de la funci√≥n en las nueve l√≠neas del Listado 3-2.</p>
<p>Compruebe si ahora la entiende.</p>
<p>Listado 3-2</p>
<p>HtmlUtil.java (refactorizaci√≥n).</p>
<p>public static String renderPageWithSetupsAndTeardowns(</p>
<p>PageData pageData, boolean isSuite</p>
<p>) throws Exception {</p>
<p>boolean isTestPage = pageData.hasAttribute(‚ÄúTest‚Äù);</p>
<p>if (isTestPage) {</p>
<p>WikiPage testPage = pageData.getWikiPage();</p>
<p>StringBuffer newPageContent = new StringBuffer();</p>
<p>includeSetupPages (testPage, newPageContent, isSuite);</p>
<p>newPageContent.append(pageData.getContent());</p>
<p>includeTeardownPages(testPage, newPageContent, isSuite);</p>
<p>pageData.setContent(newPageContent.toString());</p>
<p>return pageData.getHtml();</p>
<p>A menos que sea un alumno de FitNesse, seguramente no entienda los</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>detalles. Entender√° que la funci√≥n se encarga de a√±adir p√°ginas de</p>
<p>configuraci√≥n y detalles en una p√°gina de prueba, que despu√©s muestra en</p>
<p>[11]</p>
<p>HTML. Si est√° familiarizado con JUnit , ver√° que esta funci√≥n pertenece a</p>
<p>alg√∫n tipo de estructura de pruebas basada en la Web y, evidentemente, es</p>
<p>correcto. Resulta sencillo adivinar esta informaci√≥n del Listado 3-2 pero no</p>
<p>del Listado 3-1. ¬øQu√© tiene la funci√≥n del Listado 3-2 para que resulte</p>
<p>sencilla de leer y entender? ¬øQu√© hay que hacer para que una funci√≥n</p>
<p>transmita su intenci√≥n? ¬øQu√© atributos podemos asignar a nuestras funciones</p>
<p>para que el lector pueda intuir el tipo de programa al que pertenecen?</p>
<h3 id="tamano-reducido-44">Tama√±o reducido</h3>
<p>La primera regla de las funciones es que deben ser de tama√±o reducido. La</p>
<p>segunda es que deben ser todav√≠a m√°s reducidas . No es una afirmaci√≥n que</p>
<p>pueda justificar. No puedo mostrar referencias a estudios que demuestren que</p>
<p>las funciones muy reducidas sean mejores. Lo que s√≠ puedo afirmar es que</p>
<p>durante casi cuatro d√©cadas he creado funciones de diferentes tama√±os. He</p>
<p>creado monstruos de casi 3000 l√≠neas y otras muchas funciones de entre 100</p>
<p>y 300 l√≠neas. Tambi√©n he creado funciones de 20 a 30 l√≠neas de longitud. Esta</p>
<p>experiencia me ha demostrado, mediante ensayo y error, que las funciones</p>
<p>deben ser muy reducidas.</p>
<p>En la d√©cada de 1980 se dec√≠a que una funci√≥n no deb√≠a superar el</p>
<p>tama√±o de una pantalla. Por aquel entonces, las pantallas VT100 ten√≠an 24</p>
<p>l√≠neas por 80 columnas, y nuestros editores usaban 4 l√≠neas para tareas</p>
<p>administrativas. En la actualidad, con una fuente m√≠nima y un monitor de</p>
<p>gran tama√±o, se pueden encajar 150 caracteres por l√≠nea y 100 l√≠neas o m√°s</p>
<p>en una pantalla. Las l√≠neas no deben tener 150 caracteres. Las funciones no</p>
<p>deben tener 100 l√≠neas de longitud. Las funciones deben tener una longitud</p>
<p>aproximada de 20 l√≠neas.</p>
<p>¬øQu√© tama√±o m√≠nimo debe tener una funci√≥n? En 1999 visit√© a Kent</p>
<p>Beck en su casa de Oregon. Nos sentamos y comenzamos a programar. Me</p>
<p>ense√±√≥ un atractivo programa de Java/Swing que hab√≠a llamado Sparkle</p>
<p>Generaba un efecto visual en pantalla, similar a la varita m√°gica del hada de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Cenicienta. Al mover el rat√≥n, sal√≠an estrellitas del cursor, y descend√≠an a la</p>
<p>parte inferior de la pantalla en un campo gravitatorio simulado. Cuando Kent</p>
<p>me ense√±√≥ el c√≥digo, me sorprendi√≥ la brevedad de las funciones. Estaba</p>
<p>acostumbrado ver programas de Swing con funciones que ocupaban</p>
<p>kil√≥metros de espacio vertical. En este programa, las funciones ten√≠an dos,</p>
<p>tres o cuatro l√≠neas de longitud. Todas eran obvias. Todas contaban una</p>
<p>historia y cada una llevaba a la siguiente en un orden atractivo. ¬°As√≠ de breves</p>
<p>[12]</p>
<p>deber√≠an ser todas las funciones!</p>
<p>¬øQu√© tama√±o m√≠nimo deben tener sus funciones? Deber√≠an ser m√°s</p>
<p>breves que las del Listado 3-2. De hecho, el Listado 3-2 deber√≠a reducirse</p>
<p>como el Listado 3-3.</p>
<p>Listado 3-3</p>
<p>HtmlUtil.java (nueva refactorizaci√≥n).</p>
<p>public static String renderPageWithSetupsAndTeardowns(</p>
<p>PageData pageData, boolean isSuite) throws Exception {</p>
<p>if (isTestPage(pageData))</p>
<p>includeSetupAndTeardownPages(pageData, isSuite);</p>
<p>return pageData.getHtml();</p>
<h3 id="bloques-y-sangrado-45">Bloques y sangrado</h3>
<p>Esto implica que los bloques en instrucciones if else while y similares</p>
<p>deben tener una l√≠nea de longitud que, seguramente, sea la invocaci√≥n de una</p>
<p>funci√≥n. De esta forma, no s√≥lo se reduce el tama√±o de la funci√≥n, sino que</p>
<p>tambi√©n se a√±ade valor documental ya que la funci√≥n invocada desde el</p>
<p>bloque puede tener un nombre descriptivo. Tambi√©n implica que las</p>
<p>funciones no deben tener un tama√±o excesivo que albergue estructuras</p>
<p>anidadas. Por tanto, el nivel de sangrado de una funci√≥n no debe ser mayor de</p>
<p>uno o dos. Evidentemente, de esta forma las funciones son m√°s f√°ciles de leer</p>
<p>y entender.</p>
<h3 id="hacer-una-cosa-46">Hacer una cosa</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Es evidente que el Listado 3-1 hace m√°s de</p>
<p>una cosa. Crea b√∫feres, obtiene p√°ginas,</p>
<p>busca p√°ginas heredadas, a√±ade cadenas</p>
<p>antiguas y genera HTML. El Listado 3-1</p>
<p>est√° muy ocupado realizando varias tareas.</p>
<p>Por su parte, el Listado 3-3 s√≥lo hace una</p>
<p>cosa: incluye configuraciones y detalles en</p>
<p>p√°ginas de prueba.</p>
<p>El siguiente consejo lleva vigente, de</p>
<p>una u otra forma, durante m√°s de 30 a√±os:</p>
<p>LAS FUNCIONES S√ìLO DEBEN HACER UNA COSA. DEBEN</p>
<p>HACERLO BIEN Y DEBE SER LO √öNICO QUE HAGAN.</p>
<p>El problema de esta afirmaci√≥n es saber qu√© es una cosa. ¬øEl Listado 3-3</p>
<p>hace una cosa? Se podr√≠a pensar que hace tres:</p>
<ul>
<li>Determinar si la p√°gina es una p√°gina de prueba.</li>
<li>En caso afirmativo, incluir configuraciones y detalles.</li>
<li>Representar la p√°gina en HTML.</li>
</ul>
<p>¬øCu√°l ser√° de las tres? ¬øLa funci√≥n hace una o tres cosas? Los tres pasos</p>
<p>de la funci√≥n se encuentran un nivel de abstracci√≥n por debajo del nombre de</p>
<p>la funci√≥n. Podemos describir la funci√≥n como un breve p√°rrafo TO (PARA)</p>
<p>[13]</p>
<p>Para renderPageWithSetupsAndTeardowns comprobamos si la</p>
<p>p√°gina es de prueba y, en caso afirmativo, incluimos las</p>
<p>configuraciones y los detalles. En ambos casos, la representamos en</p>
<p>HTML.</p>
<p>Si una funci√≥n s√≥lo realiza los pasos situados un nivel por debajo del</p>
<p>nombre de la funci√≥n, entonces hace una cosa. En definitiva, creamos</p>
<p>funciones para descomponer conceptos m√°s amplios (es decir, el nombre de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>la funci√≥n) en un conjunto de pasos en el siguiente nivel de abstracci√≥n. Es</p>
<p>evidente que el Listado 3-1 contiene pasos en distintos niveles de abstracci√≥n,</p>
<p>por lo que es obvio que hace m√°s de una cosa. Incluso el Listado 3-2 tiene</p>
<p>tres niveles de abstracci√≥n, como ha demostrado la capacidad de reducirlo,</p>
<p>pero ser√≠a complicado reducir con sentido el Listado 3-3. Podr√≠amos extraer</p>
<p>la instrucci√≥n if en la funci√≥n includeSetupsAndTeardownsIfTestPage</p>
<p>pero s√≥lo reducir√≠amos el c√≥digo sin cambiar el nivel de abstracci√≥n.</p>
<p>Por ello, otra forma de saber que una funci√≥n hace m√°s de una cosa es</p>
<p>extraer otra funci√≥n de la misma con un nombre que no sea una reducci√≥n de</p>
<p>su implementaci√≥n [G34].</p>
<h3 id="secciones-en-funciones-47">Secciones en funciones</h3>
<p>F√≠jese en el Listado 4-7. Ver√° que la funci√≥n generatePrimes se divide en</p>
<p>secciones como declaraciones, inicializaciones filtros. Es un s√≠ntoma</p>
<p>evidente de que hace m√°s de una cosa. Las funciones que hacen una sola cosa</p>
<p>no se pueden dividir en secciones.</p>
<h3 id="un-nivel-de-abstraccion-por-funcion-48">Un nivel de abstracci√≥n por funci√≥n</h3>
<p>Para que las funciones realicen ¬´una cosa¬ª, aseg√∫rese de que las</p>
<p>instrucciones de la funci√≥n se encuentran en el mismo nivel de abstracci√≥n.</p>
<p>El Listado 3-1 incumple esta regla. Incluye conceptos a un elevado nivel de</p>
<p>abstracci√≥n, como getHtml(); otros se encuentran en un nivel intermedio,</p>
<p>como StringpagePathName PathParser.render(pagePath) y hay otros</p>
<p>en un nivel especialmente bajo, como .append(‚Äú\n‚Äù).</p>
<p>La mezcla de niveles de abstracci√≥n en una funci√≥n siempre resulta</p>
<p>confusa. Los lectores no sabr√°n si una determinada expresi√≥n es un concepto</p>
<p>esencial o un detalle. Peor todav√≠a, si se mezclan detalles con conceptos</p>
<p>esenciales, aumentar√°n los detalles dentro de la funci√≥n.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="leer-codigo-de-arriba-a-abajo-la-regla-descendente-49">Leer c√≥digo de arriba a abajo: la regla descendente</h3>
<p>[14]</p>
<p>El objetivo es que el c√≥digo se lea como un texto de arriba a abajo</p>
<p>Queremos que tras todas las funciones aparezcan las del siguiente nivel de</p>
<p>abstracci√≥n para poder leer el programa, descendiendo un nivel de</p>
<p>abstracci√≥n por vez mientras leemos la lista de funciones. Es lo que</p>
<p>denomino la regla descendente.</p>
<p>Para decirlo de otra forma, queremos leer el programa como si fuera un</p>
<p>conjunto de p√°rrafos TO , en el que cada uno describe el nivel actual de</p>
<p>abstracci√≥n y hace referencia a los p√°rrafos TO posteriores en el siguiente</p>
<p>nivel.</p>
<p>Para incluir configuraciones y detalles, incluimos configuraciones,</p>
<p>despu√©s del contenido de la p√°gina de prueba, y por √∫ltimo los</p>
<p>detalles.</p>
<p>Para incluir las configuraciones, incluimos la configuraci√≥n de suite</p>
<p>si se trata de una suite, y despu√©s la configuraci√≥n convencional.</p>
<p>Para incluir la configuraci√≥n de suite; buscamos la jerarqu√≠a</p>
<p>principal de la p√°gina SuiteSetUp a√±adimos una instrucci√≥n</p>
<p>include con la ruta de dicha p√°gina.</p>
<p>Para buscar la jerarqu√≠a principal...</p>
<p>A los programadores les resulta complicado aprender esta regla y crear</p>
<p>funciones en un √∫nico nivel de abstracci√≥n, pero es un truco importante. Es la</p>
<p>clave para reducir la longitud de las funciones y garantizar que s√≥lo hagan</p>
<p>una cosa. Al conseguir que el c√≥digo se lea de arriba a abajo, se mantiene la</p>
<p>coherencia de los niveles de abstracci√≥n.</p>
<p>F√≠jese en el Listado 3-7 del final del cap√≠tulo. Muestra la funci√≥n</p>
<p>testableHtml modificada de acuerdo estos principios. Cada funci√≥n</p>
<p>presenta a la siguiente y se mantiene en un nivel de abstracci√≥n coherente.</p>
<h3 id="instrucciones-switch-50">Instrucciones Switch</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[15]</p>
<p>Es complicado usar una instrucci√≥n switch de tama√±o reducido . Aunque</p>
<p>s√≥lo tenga dos casos, es mayor de lo que un bloque o funci√≥n deber√≠a ser.</p>
<p>Tambi√©n es complicado crear una instrucci√≥n switch que haga una sola cosa.</p>
<p>Por su naturaleza, las instrucciones switch siempre hacen cosas.</p>
<p>Desafortunadamente, no siempre podemos evitar las instrucciones switch</p>
<p>pero podemos asegurarnos de incluirlas en una clase de nivel inferior y de no</p>
<p>repetirlas. Para ello, evidentemente, recurrimos al polimorfismo.</p>
<p>F√≠jese en el Listado 3-4. Muestra una de las operaciones que pueden</p>
<p>depender del tipo de empleado.</p>
<p>Listado 3-4</p>
<p>Payroll.java.</p>
<p>public Money calculatePay(Employee e)</p>
<p>throws InvalidEmployeeType (</p>
<p>switch (e.type) {</p>
<p>case COMMISSIONED:</p>
<p>return calculateCommissionedPay(e);</p>
<p>case HOURLY:</p>
<p>return calculateHourlyPay(e);</p>
<p>case SALARIED:</p>
<p>return calculateSalariedPay(e);</p>
<p>default:</p>
<p>throw new InvalidEmployeeType(e.type);</p>
<p>Esta funci√≥n tiene varios problemas. Por un lado, es de gran tama√±o y</p>
<p>cuando se a√±adan nuevos tipos de empleado, aumentar√° m√°s. Por otra parte,</p>
<p>hace m√°s de una cosa. Tambi√©n incumple el Principio de responsabilidad</p>
<p>[16]</p>
<p>√∫nica ( Single Responsibility Principie o SRP) ya que hay m√°s de un</p>
<p>motivo para cambiarla. Adem√°s, incumple el Principio de abierto/cerrado</p>
<p>[17]</p>
<p>Open Closed Principle u OCP) , ya que debe cambiar cuando se a√±adan</p>
<p>nuevos tipos, pero posiblemente el peor de los problemas es que hay un</p>
<p>n√∫mero ilimitado de funciones que tienen la misma estructura.</p>
<p>Por ejemplo, podr√≠amos tener:</p>
<p>isPayday(Employee e, Date date),</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>deliverPay(Employee e, Date date),</p>
<p>o muchas otras, todas con la misma estructura.</p>
<p>La soluci√≥n al problema (v√©ase el Listado 3-5) consiste en ocultar la</p>
<p>[18]</p>
<p>instrucci√≥n switch en una factor√≠a abstracta e impedir que nadie la vea. La</p>
<p>factor√≠a usa la instrucci√≥n switch para crear las instancias adecuadas de los</p>
<p>derivados de Employee las distintas funciones, como calculatePay</p>
<p>isPayday deliverPay , se entregar√°n de forma polim√≥rfica a trav√©s de la</p>
<p>interfaz Employee</p>
<p>Listado 3-5</p>
<p>Employee y Factory.</p>
<p>public abstract class Employee {</p>
<p>public abstract boolean isPayday();</p>
<p>public abstract Money calculatePay();</p>
<p>public abstract void deliverPay(Money pay);</p>
<p>public interface EmployeeFactory {</p>
<p>public Employee makeEmployee(EmployeeRecord r) throws InvalidEmployeeType;</p>
<p>public class EmployeeFactoryImpl implements EmployeeFactory {</p>
<p>public Employee makeEmployee(EmployeeRecord r) throws InvalidEmployeeType</p>
<p>switch (r.type) {</p>
<p>case COMMISSIONED:</p>
<p>return new CommissionedEmployee(r);</p>
<p>case HOURLY:</p>
<p>return new HourlyEmployee(r);</p>
<p>case SALARIED:</p>
<p>return new SalariedEmployee(r);</p>
<p>default:</p>
<p>throw new InvalidEmployeeType(r.type);</p>
<p>Mi regla general para las instrucciones switch es que se pueden tolerar si</p>
<p>s√≥lo aparecen una vez, se usan para crear objetos polim√≥rficos y se ocultan</p>
<p>tras una relaci√≥n de herencia para que el resto del sistema no las pueda ver</p>
<p>[G23]. Evidentemente, cada caso es diferente y en ocasiones se puede</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>incumplir una o varias partes de esta regla.</p>
<h3 id="usar-nombres-descriptivos-51">Usar nombres descriptivos</h3>
<p>En el Listado 3-7, hemos cambiado el nombre de la funci√≥n de ejemplo de</p>
<p>testableHtml SetupTeardownIncluder.render Es un nombre m√°s</p>
<p>apropiado ya que describe mejor el cometido de la funci√≥n. Tambi√©n hemos</p>
<p>asignado a los m√©todos privados un nombre descriptivo como isTestable</p>
<p>includeSetupAndTeardownPages . No hay que olvidar el valor de los nombres</p>
<p>correctos. Recuerde el principio de Ward: ¬´Sabemos que trabajamos con</p>
<p>c√≥digo limpio cuando cada rutina es m√°s o menos lo que esper√°bamos¬ª. Para</p>
<p>alcanzar este principio, gran parte del esfuerzo se basa en seleccionar</p>
<p>nombres adecuados para peque√±as funciones que hacen una cosa. Cuanto m√°s</p>
<p>reducida y concreta sea una funci√≥n, m√°s sencillo ser√° elegir un nombre</p>
<p>descriptivo. No tema los nombres extensos. Un nombre descriptivo extenso</p>
<p>es mucho mejor que uno breve pero enigm√°tico. Use una convenci√≥n de</p>
<p>nombres que permita leer varias palabras en los nombres de las funciones y</p>
<p>use esas palabras para asignar a la funci√≥n un nombre que describa su</p>
<p>cometido.</p>
<p>No tema dedicar tiempo a elegir un buen nombre. De hecho, deber√≠a</p>
<p>probar con varios nombres y leer el c√≥digo con todos ellos. Los IDE</p>
<p>modernos como Eclipse o IntelliJ facilitan el cambio de nombres. Use uno de</p>
<p>estos IDE y experimente con diferentes nombres hasta que encuentre uno que</p>
<p>sea lo bastante descriptivo.</p>
<p>La elecci√≥n de nombres descriptivos clarifica el dise√±o de los m√≥dulos y</p>
<p>le permite mejorarlos. No es extra√±o que la b√∫squeda de nombres adecuados</p>
<p>genere una reestructuraci√≥n favorable del c√≥digo. Sea coherente con los</p>
<p>nombres. Use las mismas frases, sustantivos y verbos en los nombres de</p>
<p>funci√≥n que elija para los m√≥dulos. Pruebe, por ejemplo, con</p>
<p>includeSetupAndTeardownPages includeSetupPages</p>
<p>includeSuiteSetupPage includeSetupPage . La estructura similar de estos</p>
<p>nombres permite que la secuencia cuente una historia. En realidad, si ve la</p>
<p>secuencia anterior, seguramente se pregunte qu√© ha pasado con</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>includeTeardownPages includeSuiteTeardownPage</p>
<p>includeTeardownPage</p>
<h3 id="argumentos-de-funciones-52">Argumentos de funciones</h3>
<p>El n√∫mero ideal de argumentos para una</p>
<p>funci√≥n es cero. Despu√©s uno (mon√°dico) y</p>
<p>dos (di√°dico). Siempre que sea posible,</p>
<p>evite la presencia de tres argumentos</p>
<p>(tri√°dico). M√°s de tres argumentos</p>
<p>(poli√°dico) requiere una justificaci√≥n</p>
<p>especial y no es muy habitual.</p>
<p>Los argumentos son complejos ya que</p>
<p>requieren un gran poder conceptual. Por</p>
<p>ello suelo evitarlos en los ejemplos. F√≠jese</p>
<p>en StringBuffer Podr√≠amos haberlo</p>
<p>pasado como argumento en lugar de como</p>
<p>variable de instancia, pero los lectores habr√≠an tenido que interpretarlo cada</p>
<p>vez que lo vieran. Al leer la historia que cuenta el m√≥dulo,</p>
<p>includeSetupPage() es m√°s sencillo de interpretar que</p>
<p>includeSetupPageInto(newPageContent) . El argumento se encuentra en un</p>
<p>nivel de abstracci√≥n diferente que el nombre de la funci√≥n y nos obliga a</p>
<p>conocer un detalle ( StringBuffer ) que no es especialmente importante en</p>
<p>ese momento.</p>
<p>Los argumentos son todav√≠a m√°s complicados desde un punto de vista de</p>
<p>pruebas. Imagine la dificultad de crear todos los casos de prueba para</p>
<p>garantizar el funcionamiento de las distintas combinaciones de argumentos.</p>
<p>Si no hay argumentos, todo es m√°s sencillo. Si hay uno, no es demasiado</p>
<p>dif√≠cil. Con dos argumentos el problema es m√°s complejo. Con m√°s de dos</p>
<p>argumentos, probar cada combinaci√≥n de valores adecuados es todo un reto.</p>
<p>Los argumentos de salida son m√°s dif√≠ciles de entender que los de entrada. Al</p>
<p>leer una funci√≥n, estamos acostumbrados al concepto de informaci√≥n a√±adida</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>a la funci√≥n a trav√©s de argumentos y extra√≠da a trav√©s de un valor devuelto.</p>
<p>No esperamos que la informaci√≥n se devuelva a trav√©s de los argumentos. Por</p>
<p>ello, los argumentos de salida suelen obligamos a realizar una comprobaci√≥n</p>
<p>doble.</p>
<p>Un argumento de salida es la mejor opci√≥n, despu√©s de la ausencia de</p>
<p>argumentos. SetupTeardownIncluder.render(pageData) se entiende bien.</p>
<p>Evidentemente, vamos a representar los datos en el objeto pageData</p>
<h3 id="formas-monadicas-habituales-53">Formas mon√°dicas habituales</h3>
<p>Hay dos motivos principales para pasar un solo argumento a una funci√≥n.</p>
<p>Puede que realice una pregunta sobre el argumento, como en boolean</p>
<p>fileExists(‚ÄúMyFile‚Äù), o que procese el argumento, lo transforme en otra</p>
<p>cosa lo devuelva. Por ejemplo, InputStream fileOpen(‚ÄúMyFile‚Äù)</p>
<p>transforma un nombre de archivo String en un valor devuelto InputStream</p>
<p>Los usuarios esperan estos dos usos cuando ven una funci√≥n. Debe elegir</p>
<p>nombres que realicen la distinci√≥n con claridad y usar siempre ambas formas</p>
<p>en un contexto coherente (consulte el apartado sobre separaci√≥n de consultas</p>
<p>de comandos).</p>
<p>Una forma menos habitual pero muy √∫til para un argumento es un evento.</p>
<p>En esta forma, hay argumento de entrada pero no de salida. El programa debe</p>
<p>interpretar la invocaci√≥n de la funci√≥n como evento y usar el argumento para</p>
<p>alterar el estado del sistema, por ejemplo, void</p>
<p>passwordAttemptFailedNtimes(int attempts) Use esta forma con</p>
<p>precauci√≥n. Debe ser claro para el lector que se trata de un evento. Elija</p>
<p>nombres y contextos con atenci√≥n. Intente evitar funciones mon√°dicas que no</p>
<p>tengan estas formas, por ejemplo, void</p>
<p>includeSetupPageInto(StringBuffer pageText) . El uso de un argumento</p>
<p>de salida en lugar de un valor devuelto para realizar transformaciones resulta</p>
<p>confuso. Si una funci√≥n va a transformar su argumento de entrada, la</p>
<p>transformaci√≥n debe aparecer como valor devuelto. Sin duda</p>
<p>StringBuffertransform(StringBuffer in) es mejor que void</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>transform(StringBuffer out) , aunque la implementaci√≥n del primer caso</p>
<p>devuelva solamente el argumento de entrada. Al menos se ajusta a la forma</p>
<p>de la transformaci√≥n.</p>
<h3 id="argumentos-de-indicador-54">Argumentos de indicador</h3>
<p>Los argumentos de indicador son horribles. Pasar un valor Booleano a una</p>
<p>funci√≥n es una pr√°ctica totalmente desaconsejable. Complica inmediatamente</p>
<p>la firma del m√©todo e indica que la funci√≥n hace m√°s de una cosa. Hace algo</p>
<p>si el indicador es true y otra cosa diferente si es false . En el Listado 3-7 no</p>
<p>se puede evitar, porque los invocadores ya pasan el indicador y el objetivo</p>
<p>era limitar el √°mbito a la funci√≥n y despu√©s, pero la invocaci√≥n de render</p>
<p>(true) es confusa para el lector. Si se desplaza el rat√≥n sobre la invocaci√≥n</p>
<p>vemos que render (boolean isSuite) puede ayudar, pero no demasiado.</p>
<p>Tendremos que dividir la funci√≥n en dos: renderForSuite()</p>
<p>renderForSingleTest()</p>
<h3 id="funciones-diadicas-55">Funciones di√°dicas</h3>
<p>Una funci√≥n con dos argumentos es m√°s dif√≠cil de entender que una funci√≥n</p>
<p>mon√°dica. Por ejemplo writeField(name) es m√°s f√°cil de entender que</p>
<p>[19]</p>
<p>writeField (outputStream, name) Aunque en ambos casos el</p>
<p>significado es evidente, la primera se capta mejor visualmente. La segunda</p>
<p>requiere una breve pausa hasta que ignoramos el segundo par√°metro, lo que</p>
<p>en √∫ltima instancia genera problemas ya que no debemos ignorar esa parte</p>
<p>del c√≥digo. Las partes que ignoramos son las que esconden los errores. Pero</p>
<p>en ocasiones se necesitan dos argumentos. Por ejemplo. Point new</p>
<p>Point(0,0); es totalmente razonable. Los puntos cartesianos suelen adoptar</p>
<p>dos argumentos. De hecho, ser√≠a muy sorprendente ver Point(0) . Sin</p>
<p>embargo, en este caso ambos argumentos son componentes ordenados de un</p>
<p>mismo valor, mientras que outputStream name carecen de una cohesi√≥n o</p>
<p>un orden natural.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Incluso funciones di√°dicas evidentes como assertEquals(expected,</p>
<p>actual) resultan problem√°ticas. ¬øCu√°ntas veces ha incluido el valor real en</p>
<p>su posici√≥n esperada? Los dos argumentos carecen de un orden natural. El</p>
<p>orden real y esperado es una convenci√≥n que se adquiere gracias a la pr√°ctica.</p>
<p>Las combinaciones di√°dicas no son el mal en persona y tendr√° que</p>
<p>usarlas. Sin embargo, recuerde que tienen un precio y que debe aprovechar</p>
<p>los mecanismos disponibles para convertirlas en unitarias. Por ejemplo,</p>
<p>puede hacer que el m√©todo writeField sea un miembro de outputStream</p>
<p>para poder usar outputStream.writeField(name) podr√≠a convertir</p>
<p>outputStream en una variable miembro de la clase actual para no tener que</p>
<p>pasarla. Incluso podr√≠a extraer una nueva clase como FieldWriter que usara</p>
<p>outputStream en su constructor y tuviera un m√©todo write</p>
<h3 id="triadas-56">Triadas</h3>
<p>Las funciones que aceptan tres argumentos son sin duda mucho m√°s dif√≠ciles</p>
<p>de entender que las de dos. Los problemas a la hora de ordenar, ignorar o</p>
<p>detenerse en los argumentos se duplican. Piense atentamente antes de crear</p>
<p>una triada.</p>
<p>Por ejemplo, f√≠jese en la sobrecarga de assertEquals que acepta tres</p>
<p>argumentos: assertEquals(message, expected, actual) . ¬øCu√°ntas veces</p>
<p>lee el mensaje y piensa que es lo esperado? He visto esta triada en concreto</p>
<p>muchas veces. De hecho, siempre que la veo, tengo que repasarla antes de</p>
<p>ignorar el mensaje.</p>
<p>Por otra parte, hay otra triada que no es tan negativa: assertEquals(1.0,</p>
<p>amount, .001) . Aunque tambi√©n exija doble atenci√≥n, merece la pena.</p>
<p>Conviene recordar siempre que la igualdad de los valores de coma flotante es</p>
<p>algo relativo.</p>
<h3 id="objeto-de-argumento-57">Objeto de argumento</h3>
<p>Cuando una funci√≥n parece necesitar dos o m√°s argumentos, es probable que</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>alguno de ellos se incluya en una clase propia. F√≠jese en la diferencia entre las</p>
<p>dos siguientes declaraciones:</p>
<p>Circle makeCircle (double x, double y, double radius);</p>
<p>Circle makeCircle(Point center, double radius);</p>
<p>La reducci√≥n del n√∫mero de argumentos mediante la creaci√≥n de objetos</p>
<p>puede parecer una trampa pero no lo es. Cuando se pasan grupos de variables</p>
<p>de forma conjunta, como x e y en el ejemplo anterior, es probable que formen</p>
<p>parte de un concepto que se merece un nombre propio.</p>
<h3 id="listas-de-argumentos-58">Listas de argumentos</h3>
<p>En ocasiones tendremos que pasar un n√∫mero variable de argumentos a una</p>
<p>funci√≥n. F√≠jese en el m√©todo String.format</p>
<p>String.format (‚Äú%s worked %.2f hours.‚Äù, name, hours);</p>
<p>Si los argumentos variables se procesan de la misma forma, como en el</p>
<p>ejemplo anterior, ser√°n equivalentes a un √∫nico argumento de tipo List . Por</p>
<p>tanto, String.format es en realidad di√°dico. De hecho, la siguiente</p>
<p>declaraci√≥n de String.format es claramente di√°dica.</p>
<p>public String format(String format, Object... args)</p>
<p>As√≠ pues, se aplican las mismas reglas. Las funciones que aceptan</p>
<p>argumentos variables pueden ser mon√°dicas, di√°dicas o incluso tri√°dicas, pero</p>
<p>ser√≠a un error asignar m√°s argumentos.</p>
<p>void monad(Integer... args);</p>
<p>void dyad(String name, Integer... args);</p>
<p>void triad(String name, int count, Integer... args);</p>
<h3 id="verbos-y-palabras-clave-59">Verbos y palabras clave</h3>
<p>La selecci√≥n de nombres correctos para una funci√≥n mejora la explicaci√≥n de</p>
<p>su cometido, as√≠ como el orden y el cometido de los argumentos. En formato</p>
<p>mon√°dico, la funci√≥n y el argumento deben formar un par de verbo y</p>
<p>sustantivo. Por ejemplo, write(name) resulta muy evocador. Sea lo que sea</p>
<p>name , sin duda se escribe (write)</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Un nombre m√°s acertado podr√≠a ser writeField(name) , que nos dice que</p>
<p>name es un campo (field) . √âste es un ejemplo de palabra clave como</p>
<p>nombre de funci√≥n. Con este formato codificamos los nombres de los</p>
<p>argumentos en el nombre de la funci√≥n. Por ejemplo, assertEquals se podr√≠a</p>
<p>haber escrito como assertExpectedEqualsActual(expected, actual) , lo</p>
<p>que mitiga el problema de tener que recordar el orden de los argumentos.</p>
<h3 id="sin-efectos-secundarios-60">Sin efectos secundarios</h3>
<p>Los efectos secundarios son mentiras. Su funci√≥n promete hacer una cosa,</p>
<p>pero tambi√©n hace otras cosas ocultas. En ocasiones realiza cambios</p>
<p>inesperados en las variables de su propia clase. En ocasiones las convierte en</p>
<p>las variables pasadas a la funci√≥n o a elementos globales del sistema. En</p>
<p>cualquier caso, se comete un enga√±o que suele provocar extra√±as</p>
<p>combinaciones temporales y dependencias de orden.</p>
<p>F√≠jese en la funci√≥n del Listado 3-6, aparentemente inofensiva. Usa un</p>
<p>algoritmo est√°ndar para comparar userName con password . Devuelve true si</p>
<p>coinciden y false si hay alg√∫n problema, pero tambi√©n hay un efecto</p>
<p>secundario. ¬øLo detecta?</p>
<p>Listado 3-6</p>
<p>UserValidator.java.</p>
<p>public class UserValidator {</p>
<p>private Cryptographer cryptographer;</p>
<p>public boolean checkPassword(String userName, String password) {</p>
<p>User user = UserGateway.findByName(userName);</p>
<p>if (user != User.NULL) {</p>
<p>String codedPhrase = user.getPhraseEncodedByPassword();</p>
<p>String phrase = cryptographer.decrypt(codedPhrase, password);</p>
<p>if (‚ÄúValid Password‚Äù.equals(phrase)){</p>
<p>Session.initialize();</p>
<p>return true;</p>
<p>return false;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>El efecto secundario es la invocaci√≥n de Session.initialize() . La</p>
<p>funci√≥n checkPassword , por su nombre, afirma comprobar la contrase√±a. El</p>
<p>nombre no implica que inicialice la sesi√≥n. Por tanto, un invocador que se</p>
<p>crea lo que dice el nombre de la funci√≥n se arriesga a borrar los datos de</p>
<p>sesi√≥n actuales cuando decida comprobar la validez del usuario. Este efecto</p>
<p>secundario genera una combinaci√≥n temporal. Es decir, s√≥lo se puede invocar</p>
<p>checkPassword en determinados momentos (cuando se pueda inicializar la</p>
<p>sesi√≥n). Si no se invoca en orden, se pueden perder los datos de la sesi√≥n. Las</p>
<p>combinaciones temporales son confusas, en especial cuando se ocultan como</p>
<p>efecto secundario. Si tiene que realizar una combinaci√≥n temporal, h√°galo de</p>
<p>forma clara en el nombre de la funci√≥n. En este caso, podr√≠amos cambiar el</p>
<p>nombre de la funci√≥n por checkPasswordAndInitializeSession pero</p>
<p>incumplir√≠a la norma de hacer una sola cosa.</p>
<h3 id="argumentos-de-salida-61">Argumentos de salida</h3>
<p>Los argumentos suelen interpretarse como entradas de una funci√≥n. Si lleva</p>
<p>varios a√±os programando, estoy seguro de que habr√° visto un argumento que</p>
<p>en vez de ser de entrada era de salida. Por ejemplo;</p>
<p>appendFooter(s);</p>
<p>¬øEst√° funci√≥n a√±ade al final de algo? ¬øO a√±ade el final de algo a ? ¬ø</p>
<p>es una entrada o una salida? Lo sabemos al ver la firma de la funci√≥n:</p>
<p>public void appendFooter(StringBuffer report)</p>
<p>Esto lo aclara todo, pero para ello hay que comprobar la declaraci√≥n de la</p>
<p>funci√≥n. Todo lo que le obligue a comprobar la firma de la funci√≥n es un</p>
<p>esfuerzo doble. Es una pausa cognitiva y debe evitarse.</p>
<p>Antes de la programaci√≥n orientada objetos, era necesario tener</p>
<p>argumentos de salida. Sin embargo, gran parte de su necesidad desaparece en</p>
<p>los lenguajes orientados a objetos, pensados para actuar como argumento de</p>
<p>salida. Es decir, ser√≠a m√°s indicado invocar appendFooter como</p>
<p>report.appendFooter();.</p>
<p>Por lo general, los argumentos de salida deben evitarse. Si su funci√≥n</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>tiene que cambiar el estado de un elemento, haga que cambie el estado de su</p>
<p>objeto contenedor.</p>
<h3 id="separacion-de-consultas-de-comando-62">Separaci√≥n de consultas de comando</h3>
<p>Las funciones deben hacer algo o responder a algo, pero no ambas cosas. Su</p>
<p>funci√≥n debe cambiar el estado de un objeto o devolver informaci√≥n sobre el</p>
<p>mismo, pero ambas operaciones causan confusi√≥n. F√≠jese en la siguiente</p>
<p>funci√≥n:</p>
<p>public boolean set(String attribute, String value);</p>
<p>Esta funci√≥n establece el valor de un atributo y devuelve true en caso de</p>
<p>√©xito o false si el atributo no existe. Esto provoca la presencia de una</p>
<p>extra√±a instrucci√≥n como la siguiente:</p>
<p>if (set(‚Äúusername‚Äù, ‚Äúunclebob‚Äù))...</p>
<p>Imag√≠nelo desde el punto de vista del lector. ¬øQu√© significa? ¬øPregunta si</p>
<p>el atributo ¬´ username ¬ª se ha establecido antes en ¬´ unclebob ¬ª, o si el atributo</p>
<p>¬´username¬ª se ha establecido correctamente en ¬´ unclebob ¬ª? Es complicado</p>
<p>saberlo por la invocaci√≥n ya que no es evidente si set es un verbo o un</p>
<p>adjetivo.</p>
<p>El autor pretend√≠a que set fuera un verbo, pero el contexto de la</p>
<p>instrucci√≥n if parece un adjetivo. La instrucci√≥n se lee como ¬´si el atributo</p>
<p>username se ha establecido previamente en unclebob ¬ª, no como ¬´establecer</p>
<p>el atributo username en unclebob y si funciona, entonces...¬ª. Podr√≠amos</p>
<p>solucionarlo si cambiamos el nombre de la funci√≥n set por</p>
<p>setAndCheckIfExists , pero no mejorar√≠a la legibilidad de la instrucci√≥n if</p>
<p>La verdadera soluci√≥n es separar el comando de la consulta para evitar la</p>
<p>ambig√ºedad.</p>
<p>if (attributeExists(‚Äúusername‚Äù)) {</p>
<p>setAttribute(‚Äúusername‚Äù, ‚Äúunclebob‚Äù);</p>
<p>...</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="mejor-excepciones-que-devolver-codigos-de-error-63">Mejor excepciones que devolver c√≥digos de error</h3>
<p>Devolver c√≥digos de error de funciones de comando es un sutil</p>
<p>incumplimiento de la separaci√≥n de comandos de consulta. Hace que los</p>
<p>comandos usados asciendan expresiones en los predicados de las</p>
<p>instrucciones if</p>
<p>if (deletePage(page) == E_OK)</p>
<p>No padece la confusi√≥n entre verbo y adjetivo, pero genera estructuras</p>
<p>anidadas. Al devolver un c√≥digo de error se crea un problema: el invocador</p>
<p>debe procesar el error de forma inmediata.</p>
<p>if (deletePage(page) == E_OK) {</p>
<p>if (registry.deleteReference(page.name) == E_OK) {</p>
<p>if (configKeys.deleteKey(page.name.makeKey()) == E_OK) {</p>
<p>logger.log(‚Äúpage deleted‚Äù);</p>
<p>} else {</p>
<p>logger.log(‚ÄúconfigKey not deleted‚Äù);</p>
<p>} else {</p>
<p>logger.log(‚ÄúdeleteReference from registry failed‚Äù);</p>
<p>} else {</p>
<p>logger.log(‚Äúdelete failed‚Äù);</p>
<p>return E_ERROR;</p>
<p>Por otra parte, si usa excepciones en lugar de c√≥digos de error, el c√≥digo</p>
<p>de procesamiento del error se puede separar del c√≥digo de ruta y se puede</p>
<p>simplificar:</p>
<p>try {</p>
<p>deletePage(page);</p>
<p>registry.deleteReference(page.name);</p>
<p>configKeys.deleteKey(page.name.makeKey());</p>
<p>catch (Exception e) {</p>
<p>logger.log(e.getMessage());</p>
<h3 id="extraer-bloques-trycatch-64">Extraer bloques Try/Catch</h3>
<p>Los bloques try/catch no son atractivos por naturaleza. Confunden la</p>
<p>estructura del c√≥digo y mezclan el procesamiento de errores con el normal.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Por ello, conviene extraer el cuerpo de los bloques try catch en funciones</p>
<p>individuales.</p>
<p>public void delete(Page page) {</p>
<p>try {</p>
<p>deletePageAndAllReferences(page);</p>
<p>catch (Exception e) {</p>
<p>logError(e);</p>
<p>private void deletePageAndAllReferences(Page page) throws Exception {</p>
<p>deletePage(page);</p>
<p>registry.deleteReference(page.name);</p>
<p>configKeys.deleteKey(page.name.makeKey());</p>
<p>private void logError(Exception e) {</p>
<p>logger.log(e.getMessage());</p>
<p>En este caso, la funci√≥n delete es de procesamiento de errores. Es f√°cil</p>
<p>de entender e ignorar. La funci√≥n deletePageAndAllReferences es para los</p>
<p>procesos de borrar una p√°gina. El procesamiento de errores se puede ignorar.</p>
<p>De este modo, la separaci√≥n facilita la comprensi√≥n y la modificaci√≥n del</p>
<p>c√≥digo.</p>
<h3 id="el-procesamiento-de-errores-es-una-cosa-65">El procesamiento de errores es una cosa</h3>
<p>Las funciones s√≥lo deben hacer una cosa y el procesamiento de errores es un</p>
<p>ejemplo. Por tanto, una funci√≥n que procese errores no debe hacer nada m√°s.</p>
<p>Esto implica (como en el ejemplo anterior) que, si una funci√≥n incluye la</p>
<p>palabra clave try , debe ser la primera de la funci√≥n y que no debe haber nada</p>
<p>m√°s despu√©s de los bloques catch/finally</p>
<h3 id="el-iman-de-dependencias-errorjava-66">El im√°n de dependencias Error.java</h3>
<p>La devoluci√≥n de c√≥digos de error suele implicar que existe una clase o</p>
<p>enumeraci√≥n en la que se definen los c√≥digos de error.</p>
<p>public enum Error {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>OK,</p>
<p>INVALID,</p>
<p>NO_SUCH,</p>
<p>LOCKED,</p>
<p>OUT_OF_RESOURCES,</p>
<p>WAITING_FOR_EVENT;</p>
<p>Clases como √©sta son un im√°n para las dependencias ; otras muchas clases</p>
<p>deben importarlas y usarlas. Por ello, cuando cambia la enumeraci√≥n Error</p>
<p>[20]</p>
<p>es necesario volver a compilar e implementar dichas clases . Esto a√±ade</p>
<p>presi√≥n a la clase Error . Los programadores no quieren a√±adir nuevos errores</p>
<p>porque tendr√°n que volver a generar e implementarlo todo. Por ello, reutilizan</p>
<p>c√≥digos de error antiguos en lugar de a√±adir otros nuevos.</p>
<p>Al usar excepciones en lugar de c√≥digos de error, las nuevas excepciones</p>
<p>son derivaciones de la clase de la excepci√≥n. Se pueden a√±adir sin necesidad</p>
<p>[21]</p>
<p>de volver a compilar o implementar</p>
<p>[22]</p>
<h3 id="no-repetirse-67">No repetirse</h3>
<p>F√≠jese de nuevo en el Listado 3-1; ver√° que</p>
<p>hay un algoritmo que se repite cuatro veces,</p>
<p>en los casos SetUp SuiteSetUp TearDown</p>
<p>SuiteTearDown . No es f√°cil detectar esta</p>
<p>repetici√≥n ya que las cuatro instancias se</p>
<p>mezclan con otro c√≥digo, pero la</p>
<p>duplicaci√≥n es un problema ya que aumenta el tama√±o del c√≥digo y requerir√°</p>
<p>una modificaci√≥n cu√°druple si alguna vez cambia el algoritmo.</p>
<p>Tambi√©n se cuadriplica el riesgo de errores.</p>
<p>Esta duplicaci√≥n se remedia gracias al m√©todo include del Listado 3-7.</p>
<p>Vuelva a leer el c√≥digo y f√≠jese en c√≥mo se ha mejorado la legibilidad del</p>
<p>c√≥digo reduciendo la duplicaci√≥n.</p>
<p>La duplicaci√≥n puede ser la ra√≠z de todos los problemas del software</p>
<p>Existen numerosos principios pr√°cticas para controlarla eliminarla.</p>
<p>Imagine que todas las formas normales de la base de datos de Codd sirvieran</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>para eliminar la duplicaci√≥n de datos. Imagine tambi√©n c√≥mo la</p>
<p>programaci√≥n orientada a objetos concentra el c√≥digo en clases base que en</p>
<p>otros casos serian redundantes. La programaci√≥n estructurada, la</p>
<p>programaci√≥n orientada a aspecto y la orientada a componentes son, en parte,</p>
<p>estrategias para eliminar duplicados. Parece que, desde la aparici√≥n de las</p>
<p>subrutinas, las innovaciones en desarrollo de software han sido un intento</p>
<p>continuado por eliminar la duplicaci√≥n de nuestro c√≥digo fuente.</p>
<h3 id="programacion-estructurada-68">Programaci√≥n estructurada</h3>
<p>Algunos programadores siguen las reglas de programaci√≥n estructurada de</p>
<p>[23]</p>
<p>Edsger Dijkstra . Dijkstra afirma que todas las funciones y todos los</p>
<p>bloques de una funci√≥n deben tener una entrada y una salida. Estas reglas</p>
<p>implican que s√≥lo debe haber una instrucci√≥n return en una funci√≥n, que no</p>
<p>debe haber instrucciones break continue en un bucle y nunca, bajo ning√∫n</p>
<p>concepto, debe haber instrucciones goto</p>
<p>Aunque apreciemos los objetivos disciplinas de la programaci√≥n</p>
<p>estructurada, no sirven de mucho cuando las funciones son de reducido</p>
<p>tama√±o. Su verdadero beneficio se aprecia en funciones de gran tama√±o.</p>
<p>Por tanto, si sus funciones son de tama√±o reducido, una instrucci√≥n</p>
<p>return break continue no har√° da√±o alguno y en ocasiones puede resultar</p>
<p>m√°s expresiva que la regla de una entrada y una salida. Por otra parte, goto</p>
<p>s√≥lo tiene sentido en funciones de gran tama√±o y debe evitarse.</p>
<h3 id="como-crear-este-tipo-de-funciones-69">C√≥mo crear este tipo de funciones</h3>
<p>La creaci√≥n de software es como cualquier otro proceso creativo. Al escribir</p>
<p>un informe o un art√≠culo, primero se estructuran las ideas y despu√©s el</p>
<p>mensaje hasta que se lea bien. El primer borrador puede estar desorganizado,</p>
<p>de modo que lo retoca y mejora hasta que se lea de la forma adecuada.</p>
<p>Cuando creo funciones, suelen ser extensas complicadas, con</p>
<p>abundancia de sangrados bucles anidados. Con extensas listas de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>argumentos, nombres arbitrarios y c√≥digo duplicado, pero tambi√©n cuento</p>
<p>con una serie de pruebas de unidad que abarcan todas y cada una de las l√≠neas</p>
<p>de c√≥digo.</p>
<p>Por tanto, retoco el c√≥digo, divido las funciones, cambio los nombres y</p>
<p>elimino los duplicados. Reduzco los m√©todos y los reordeno. En ocasiones,</p>
<p>elimino clases enteras, mientras mantengo las pruebas.</p>
<p>Al final, consigo funciones que cumplen las reglas detalladas en este</p>
<p>cap√≠tulo. No las escribo al comenzar y dudo que nadie pueda hacerlo.</p>
<h3 id="conclusion-70">Conclusi√≥n</h3>
<p>Todo sistema se crea a partir de un lenguaje espec√≠fico del dominio dise√±ado</p>
<p>por los programadores para describir dicho sistema. Las funciones son los</p>
<p>verbos del lenguaje y las clases los sustantivos. No es volver a la noci√≥n de</p>
<p>que los sustantivos y verbos de un documento de requisitos son las clases y</p>
<p>funciones de un sistema. Es una verdad mucho m√°s antigua. El arte de la</p>
<p>programaci√≥n es, y ha sido siempre, el arte del dise√±o del lenguaje.</p>
<p>Los programadores experimentados piensan en los sistemas como en</p>
<p>historias que contar, no como en programas que escribir. Recurren a las</p>
<p>prestaciones del lenguaje de programaci√≥n seleccionado para crear un</p>
<p>lenguaje expresivo mejor y m√°s completo que poder usar para contar esa</p>
<p>historia. Parte de ese lenguaje es la jerarqu√≠a de funciones que describen las</p>
<p>acciones que se pueden realizar en el sistema. Dichas acciones se crean para</p>
<p>usar el lenguaje de dominio concreto que definen para contar su peque√±a</p>
<p>parte de la historia.</p>
<p>En este cap√≠tulo hemos visto la mec√°nica de la creaci√≥n de funciones</p>
<p>correctas. Si aplica estas reglas, sus funciones ser√°n breves, con nombres</p>
<p>correctos, y bien organizadas, pero no olvide que su verdadero objetivo es</p>
<p>contar la historia del sistema y que las funciones que escriba deben encajar en</p>
<p>un lenguaje claro y preciso que le sirva para contar esa historia.</p>
<h3 id="setupteardownincluder-71">SetupTeardownIncluder</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Listado 3-7</p>
<p>SetupTeardownIncluder.java.</p>
<p>package fitnesse.html;</p>
<p>import fitnesse.responders.run.SuiteResponder;</p>
<p>import fitnesse.wiki.*;</p>
<p>public class SetupTeardownIncluder {</p>
<p>private PageData pageData;</p>
<p>private boolean isSuite;</p>
<p>private WikiPage testPage;</p>
<p>private StringBuffer newPageContent;</p>
<p>private PageCrawler pageCrawler;</p>
<p>public static String render(PageData pageData) throws Exception {</p>
<p>return render(pageData, false);</p>
<p>public static String render(PageData pageData, boolean isSuite)</p>
<p>throws Exception {</p>
<p>return new SetupTeardownIncluder(pageData).render(isSuite);</p>
<p>private SetupTeardownIncluder(PageData pageData) {</p>
<p>this.pageData = pageData;</p>
<p>testPage = pageData.getWikiPage();</p>
<p>pageCrawler = testPage.getPageCrawler();</p>
<p>newPageContent = new StringBuffer();</p>
<p>private String render(boolean isSuite) throws Exception {</p>
<p>this.isSuite = isSuite;</p>
<p>if (isTestPage())</p>
<p>includeSetupAndTeardownPages();</p>
<p>return pageData.getHtml();</p>
<p>private boolean isTestPage() throws Exception {</p>
<p>return pageData.hasAttribute(‚ÄúTest‚Äù);</p>
<p>private void includeSetupAndTeardownPages() throws Exception {</p>
<p>includeSetupPages();</p>
<p>includePageContent();</p>
<p>includeTeardownPages();</p>
<p>updatePageContent();</p>
<p>private void includeSetupPages() throws Exception {</p>
<p>if (isSuite)</p>
<p>includeSuiteSetupPage();</p>
<p>includeSetupPage();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void includeSuiteSetupPage() throws Exception {</p>
<p>include(SuiteResponder.SUITE_SETUP_NAME, ‚Äú-setup‚Äù);</p>
<p>private void includeSetupPage() throws Exception {</p>
<p>include(‚ÄúSetUp‚Äù, ‚Äú-setup‚Äù);</p>
<p>private void includePageContent() throws Exception {</p>
<p>newPageContent.append(pageData.getContent());</p>
<p>private void includeTeardownPages() throws Exception {</p>
<p>includeTeardownPage();</p>
<p>if (isSuite)</p>
<p>includeSuiteTeardownPage();</p>
<p>private void includeTeardownPage() throws Exception {</p>
<p>include(‚ÄúTearDown‚Äù, ‚Äú-teardown‚Äù);</p>
<p>private void includeSuiteTeardownPage() throws Exception {</p>
<p>include(SuiteResponder.SUITE_TEARDOWN_NAME, ‚Äú-teardown‚Äù);</p>
<p>private void updatePageContent() throws Exception {</p>
<p>pageData.setContent(newPageContent.toString());</p>
<p>private void include(String pageName, String arg) throws Exception (</p>
<p>WikiPage inheritedPage = findInheritedPage(pageName);</p>
<p>if (inheritedPage != null) {</p>
<p>String pagePathName = getPathNameForPage(inheritedPage);</p>
<p>buildIncludeDirective(pagePathName, arg);</p>
<p>private WikiPage findInheritedPage(String pageName) throws Exception {</p>
<p>return PageCrawlerImpl.getInheritedPage(pageName, testPage);</p>
<p>private String getPathNameForPage(WikiPage page) throws Exception {</p>
<p>WikiPagePath pagePath = pageCrawler.getFullPath(page);</p>
<p>return PathParser.render(pagePath);</p>
<p>private void buildIncludeDirective(String pagePathName, String arg) {</p>
<p>newPageContent</p>
<p>.append(‚Äú\n!include ‚Äù)</p>
<p>.append(arg)</p>
<p>.append(‚Äú .‚Äù)</p>
<p>.append(pagePathName)</p>
<p>.append(‚Äú\n‚Äù);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="bibliografia-72">Bibliograf√≠a</h3>
<p>[KP78] : Kernighan and Plaugher, The Elements of Programming Style</p>
<p>2d. ed., McGraw-Hill, 1978.</p>
<p>[PPP02] : Robert C. Martin, Agile Software Development: Principles,</p>
<p>Patterns, and Practices, Prentice Hall, 2002.</p>
<p>[GOF] Design Patterns: Elements of Reusable Object Oriented</p>
<p>Software, Gamma et al., Addison Wesley, 1996.</p>
<p>[PRAG] The Pragmatic Programmer , Andrew Hunt, Dave Thomas,</p>
<p>Addison-Wesley, 2000.</p>
<p>[SP72] Structured Programming , O. J. Dahl, E. W. Dijkstra, C. A. R.</p>
<p>Hoare, Academic Press, London, 1972.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="comentarios-73">Comentarios</h1>
<p>¬´No comente el c√≥digo incorrecto, reescr√≠balo¬ª.</p>
<p>[24]</p>
<p>Brian W. Kernighan y P. J. Plaugher</p>
<p>No hay nada m√°s √∫til que un comentario bien colocado. No hay nada que</p>
<p>colapse m√°s un m√≥dulo que comentarios dogm√°ticos innecesarios. No hay</p>
<p>nada m√°s da√±ino que un comentario antiguo que propague mentiras y</p>
<p>desinformaci√≥n.</p>
<p>Los comentarios no son como la Lista de Schindler. No son pura bondad.</p>
<p>De hecho, en el mejor de los casos, son un mal necesario. Si los lenguajes de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>programaci√≥n fueran m√°s expresivos si pudi√©ramos dominarlos para</p>
<p>expresar nuestras intenciones, no necesitar√≠amos demasiados comentarios,</p>
<p>puede que incluso ninguno.</p>
<p>El uso correcto de los comentarios permite compensar nuestra</p>
<p>incapacidad para expresarnos en el c√≥digo. He usado la palabra incapacidad,</p>
<p>a prop√≥sito. Los comentarios siempre son fallos. Debemos usarlos porque no</p>
<p>siempre sabemos c√≥mo expresarnos sin ellos pero su uso no es motivo de</p>
<p>celebraci√≥n.</p>
<p>Cuando tenga que escribir un comentario, piense si no existe otra forma</p>
<p>de expresarse en el c√≥digo. Siempre que se exprese en el c√≥digo, debe</p>
<p>felicitarse. Siempre que escriba un comentario, debe hacer un gesto de</p>
<p>desaprobaci√≥n y sentir su incapacidad para expresarse.</p>
<p>¬øPor qu√© estoy en contra de los comentarios? Porque mienten. No</p>
<p>siempre y no siempre intencionadamente, pero lo hacen. Cuando m√°s antiguo</p>
<p>es un comentario y m√°s se aleja del c√≥digo que describe, mayor es la</p>
<p>probabilidad de que sea equivocado. El motivo es sencillo. Los</p>
<p>programadores no los pueden mantener.</p>
<p>El c√≥digo cambia y evoluciona. Los fragmentos cambian de lugar, se</p>
<p>bifurcan, se reproducen y se vuelven a combinar para crear quimeras.</p>
<p>Desafortunadamente, los comentarios no siempre siguen el ritmo, no siempre</p>
<p>pueden hacerlo y suelen separarse del c√≥digo que describen y se convierten</p>
<p>en hu√©rfanos sin precisi√≥n alguna. Por ejemplo, f√≠jese en lo que sucede con</p>
<p>este comentario y la l√≠nea que pretend√≠a describir:</p>
<p>MockRequest request;</p>
<p>private final String HTTP_DATE_REGEXP =</p>
<p>‚Äú[SMTWF][a-z]{2}\\,\\s[0-9]{2}\\s[JFMASOND][a-z]{2}\\s‚Äù +</p>
<p>‚Äú[0-9]{4}\\s[0-9]{2}\\:[0-9]{2}\\:[0-9]{2}\\sGMT‚Äù;</p>
<p>private Response response;</p>
<p>private FitNesseContext context;</p>
<p>private FileResponder responder;</p>
<p>private Locale saveLocale;</p>
<p>// Ejemplo: ¬´Tue, 02 Apr 2003 22:18:49 GMT¬ª</p>
<p>Seguramente se a√±adieron despu√©s otras variables de instancia entre la</p>
<p>constante HTTP_DATE_REGEXP y su comentario explicativo.</p>
<p>Se podr√≠a afirmar que los programadores deben ser lo bastante</p>
<p>disciplinados como para mantener los comentarios actualizados, relevantes y</p>
<p>precisos. De acuerdo, deber√≠a, pero esa energ√≠a deber√≠a invertirse en crear</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>c√≥digo claro y expresivo que no necesite comentario alguno.</p>
<p>Los comentarios imprecisos son mucho peor que la ausencia de</p>
<p>comentarios. Suelen confundir al usuario. Generan expectativas que nunca se</p>
<p>cumplen. Definen reglas que no deben seguirse en absoluto.</p>
<p>La verdad s√≥lo se encuentra en un punto: el c√≥digo. S√≥lo el c√≥digo puede</p>
<p>contar lo que hace. Es la √∫nica fuente de informaci√≥n precisa. Por tanto,</p>
<p>aunque los comentarios sean necesarios en ocasiones, dedicaremos nuestra</p>
<p>energ√≠a a minimizarlos.</p>
<h3 id="los-comentarios-no-compensan-el-codigo-incorrecto-74">Los comentarios no compensan el c√≥digo incorrecto</h3>
<p>Una de las principales motivaciones para crear comentarios es el c√≥digo</p>
<p>incorrecto. Creamos un m√≥dulo sabemos que es confuso est√°</p>
<p>desorganizado. Sabemos que es un desastre entonces decidimos</p>
<p>comentarlo. Error. Mejor l√≠mpielo.</p>
<p>El c√≥digo claro y expresivo sin apenas comentarios es muy superior al</p>
<p>c√≥digo enrevesado y complejo con multitud de comentarios. En lugar de</p>
<p>perder tiempo escribiendo comentarios que expliquen el desastre cometido,</p>
<p>ded√≠quelo a solucionarlo.</p>
<h3 id="explicarse-en-el-codigo-75">Explicarse en el c√≥digo</h3>
<p>En ocasiones, el c√≥digo es un pobre veh√≠culo de expresi√≥n.</p>
<p>Desafortunadamente, muchos programadores lo entienden como que el</p>
<p>c√≥digo no es un buen medio de expresi√≥n. Esto es falso. ¬øQu√© prefiere ver?</p>
<p>Esto:</p>
<p>// Comprobar si el empleado tiene derecho a todos los beneficios</p>
<p>if ((employee.flags &amp; HOURLY_FLAG) &amp;&amp;</p>
<p>(employee.age &gt; 65))</p>
<p>o esto otro:</p>
<p>if (employee.isEligibleForFullBenefits())</p>
<p>Apenas se tardan unos segundos en explicar nuestras intenciones en el</p>
<p>c√≥digo. En muchos casos, basta con crear una funci√≥n que diga lo mismo que</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>el comentario que pensaba escribir.</p>
<h3 id="comentarios-de-calidad-76">Comentarios de calidad</h3>
<p>Algunos comentarios son necesarios o beneficiosos. Veremos algunos de los</p>
<p>que considero v√°lidos. No obstante, recuerde que el √∫nico comentario</p>
<p>realmente bueno es el que no tiene que escribir.</p>
<h3 id="comentarios-legales-77">Comentarios legales</h3>
<p>En ocasiones, nuestros est√°ndares corporativos de creaci√≥n de c√≥digo nos</p>
<p>obligan a crear determinados comentarios por motivos legales. Por ejemplo,</p>
<p>los comentarios de derechos de autor son necesarios y deben incluirse al</p>
<p>inicio de cada archivo.</p>
<p>El siguiente encabezado de comentario se incluye de forma est√°ndar al</p>
<p>inicio de todos los archivos fuente de FitNesse. Nuestro IDE evita que este</p>
<p>comentario parezca sobrante repleg√°ndolo de forma autom√°tica.</p>
<p>// Copyright (C) 2003,2004,2005 de Object Mentor, Inc. Todos los derechos</p>
<p>reservados.</p>
<p>// Publicado bajo las condiciones de la Licencia p√∫blica general GNU versi√≥n</p>
<p>2 o posterior.</p>
<p>Este tipo de comentarios no deben ser contratos ni tomos legales. Siempre</p>
<p>que sea posible, haga referencia a una licencia est√°ndar o a otro documento</p>
<p>externo en lugar de incluir todos los t√©rminos y condiciones en el comentario.</p>
<h3 id="comentarios-informativos-78">Comentarios informativos</h3>
<p>En ocasiones es √∫til proporcionar informaci√≥n b√°sica con un comentario. Por</p>
<p>ejemplo, el siguiente comentario explica el valor devuelto por un m√©todo</p>
<p>abstracto:</p>
<p>// Devuelve una instancia del elemento Responder probado.</p>
<p>protected abstract Responder responderInstance();</p>
<p>Estos comentarios pueden ser √∫tiles, pero es mejor usar el nombre de la</p>
<p>funci√≥n para transmitir la informaci√≥n siempre que sea posible. Por ejemplo,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>en este caso el comentario ser√≠a redundante si cambiamos el nombre de la</p>
<p>funci√≥n por responderBeingTested. Veamos un ejemplo mejor:</p>
<p>// el formato coincide con kk:mm:ss EEE, MMM dd, yyyy</p>
<p>Pattern timeMatcher = Pattern.compile(</p>
<p>‚Äú\\d*:\\d*:\\d* \\w*, \\w* \\d*, \\d*‚Äù);</p>
<p>En este caso, el comentario nos indica que la expresi√≥n regular debe</p>
<p>coincidir con una fecha y una hora con el formato aplicado por la funci√≥n</p>
<p>SimpleDateFormat.format con la cadena de formato especificada.</p>
<p>Hubiera resultado mejor y m√°s claro si el c√≥digo se hubiera cambiado a</p>
<p>una clase especial que convirtiera los formatos de fechas y horas. De ese</p>
<p>modo el comentario habr√≠a sido superfluo.</p>
<h3 id="explicar-la-intencion-79">Explicar la intenci√≥n</h3>
<p>En ocasiones, un comentario es algo m√°s que informaci√≥n √∫til sobre la</p>
<p>implementaci√≥n y proporciona la intenci√≥n de una decisi√≥n. En el siguiente</p>
<p>caso, vemos una interesante decisi√≥n documentada por un comentario. Al</p>
<p>comparar dos objetos, el autor decidi√≥ ordenar los objetos de su clase por</p>
<p>encima de los objetos de otra.</p>
<p>public int compareTo(Object o)</p>
<p>if (o instanceof WikiPagePath)</p>
<p>WikiPagePath p = (WikiPagePath) o;</p>
<p>String compressedName = StringUtil.join(names, ‚Äú‚Äù);</p>
<p>String compressedArgumentName = StringUtil.join(p.names, ‚Äú‚Äù);</p>
<p>return compressedName.compareTo(compressedArgumentName);</p>
<p>return 1; // somos mayores porque somos el tipo correcto.</p>
<p>Veamos otro ejemplo mejor. Puede que no est√© de acuerdo con la</p>
<p>soluci√≥n del programador, pero al menos sabe lo que intentaba hacer.</p>
<p>public void testConcurrentAddWidgets() throws Exception {</p>
<p>WidgetBuilder widgetBuilder =</p>
<p>new WidgetBuilder(new Class[](BoldWidget.class));</p>
<p>String text = ‚Äú‚Äò‚Äò‚Äòbold text‚Äô‚Äô‚Äô‚Äù;</p>
<p>ParentWidget parent =</p>
<p>new BoldWidget(new MockWidgetRoot(), ‚Äú‚Äò‚Äò‚Äòbold text‚Äô‚Äô‚Äô‚Äù);</p>
<p>AtomicBoolean failFlag = new AtomicBoolean();</p>
<p>failFlag.set(false);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>//Nuestro mejor intento de obtener una condici√≥n de carrera</p>
<p>//creando un gran n√∫mero de procesos.</p>
<p>for (int i = 0; i &lt; 25000; i++) {</p>
<p>WidgetBuilderThread widgetBuiIderThread =</p>
<p>new WidgetBuilderThread(WidgetBuilder, text, parent, failFlag);</p>
<p>Thread thread = new Thread(WidgetBuilderThread);</p>
<p>thread.start();</p>
<p>assertEquals(false, failFlag.get());</p>
<h3 id="clarificacion-80">Clarificaci√≥n</h3>
<p>En ocasiones, basta con traducir el significado de un argumento o valor</p>
<p>devuelto en algo m√°s legible. Por lo general, conviene buscar la forma de que</p>
<p>el argumento o el valor devuelto sean claros por s√≠ mismos; pero cuando</p>
<p>forma parte de una biblioteca est√°ndar o de c√≥digo que no se puede alterar, un</p>
<p>comentario aclarativo puede ser muy √∫til.</p>
<p>public void testCompareTo() throws Exception</p>
<p>WikiPagePath a = PathParser.parse(‚ÄúPageA‚Äù);</p>
<p>WikiPagePath ab = PathParser.parse(‚ÄúPageA.PageB‚Äù);</p>
<p>WikiPagePath b = PathParser.parse(‚ÄúPageB‚Äù);</p>
<p>WikiPagePath aa = PathParser.parse(‚ÄúPageA.PageA‚Äù);</p>
<p>WikiPagePath bb = PathParser.parse(‚ÄúPageB.PageB‚Äù);</p>
<p>WikiPagePath ba = PathParser.parse(‚ÄúPageB.PageA‚Äù);</p>
<p>assertTrue(a.compareTo(a) == 0); // a == a</p>
<p>assertTrue(a.compareTo(b) != 0); // a != b</p>
<p>assertTrue(ab.compareTo(ab) == 0); // ab == ab</p>
<p>assertTrue(a.compareTo(b) == -1); // a &lt; b</p>
<p>assertTrue(aa.compareTo(ab) == -1); // aa &lt; ab</p>
<p>assertTrue(ba.compareTo(bb) == -1); // ba &lt; bb</p>
<p>assertTrue(b.compareTo(a) == 1); // b &gt; a</p>
<p>assertTrue(ab.compareTo (aa) == 1); // ab &gt; aa</p>
<p>assertTrue(bb.compareTo(ba) == 1); // bb &gt; ba</p>
<p>Pero tambi√©n existe el riesgo de que un comentario aclarativo sea</p>
<p>incorrecto. En el ejemplo anterior, compruebe lo dif√≠cil que resulta</p>
<p>comprobar si los comentarios son correctos. Esto explica por qu√© la</p>
<p>clarificaci√≥n es necesaria y tambi√©n arriesgada. Por ello, antes de escribir</p>
<p>estos comentarios, aseg√∫rese de que no hay una soluci√≥n mejor y tambi√©n de</p>
<p>que sean precisos.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="advertir-de-las-consecuencias-81">Advertir de las consecuencias</h3>
<p>En ocasiones es muy √∫til advertir a otros</p>
<p>programadores de determinadas</p>
<p>consecuencias. Por ejemplo, el siguiente</p>
<p>comentario explica por qu√© un determinado</p>
<p>caso de prueba est√° desactivado:</p>
<p>// No ejecutar a menos</p>
<p>// que le sobre tiempo.</p>
<p>public void _testWithReallyBigFile()</p>
<p>writeLinesToFile(10000000);</p>
<p>response.setBody(testFile);</p>
<p>response.readyToSend(this);</p>
<p>String responseString = output.toString();</p>
<p>assertSubString(‚ÄúContent-Length: 1000000000‚Äù, responseString);</p>
<p>assertTrue(bytesSent &gt; 1000000000);</p>
<p>En la actualidad, evidentemente, desactivar√≠amos la prueba por medio del</p>
<p>atributo @Ignore con la correspondiente cadena explicativa: @Ignore(‚ÄúTakes</p>
<p>too long to run‚Äù) , pero antes de la aparici√≥n de JUnit 4, era habitual a√±adir</p>
<p>un guion bajo delante del nombre del m√©todo. El comentario realizaba su</p>
<p>cometido. Veamos otro ejemplo:</p>
<p>public static SimpleDateFormat makeStandardHttpDateFormat()</p>
<p>//SimpleDataFormat no es compatible con procesos,</p>
<p>//por lo que debe crear cada instancia de forma independiente.</p>
<p>SimpleDateFormat df = new SimpleDateFormat(‚ÄúEEE, dd MMM yyyy HH:mm:ss z‚Äù);</p>
<p>df.setTimeZone (TimeZone.getTimeZone (‚ÄúGMT‚Äù));</p>
<p>return df;</p>
<p>Seguramente conozca soluciones mejores para este problema. Estoy de</p>
<p>acuerdo, pero el comentario es perfectamente razonable. Evita que un</p>
<p>programador use un inicializador est√°tico por motivos de eficacia.</p>
<h3 id="comentarios-todo-82">Comentarios TODO</h3>
<p>En ocasiones conviene usar notas con forma de comentarios //TODO . En el</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>siguiente caso, el comentario TODO explica por qu√© la funci√≥n tiene una</p>
<p>implementaci√≥n incorrecta y cu√°l debe ser su futuro.</p>
<p>// TODO-MdM no son necesarios</p>
<p>// Esperamos que desaparezca en el modelo definitivo</p>
<p>protected VersionInfo makeVersion() throws Exception</p>
<p>return null;</p>
<p>TODO son tareas que el programador piensa que deber√≠a haber hecho pero</p>
<p>que no es as√≠. Pueden ser un recordatorio para eliminar una funci√≥n obsoleta</p>
<p>o una petici√≥n para resolver un problema.</p>
<p>Pueden ser una solicitud para buscar un nombre m√°s adecuado o para</p>
<p>realizar un cambio que dependa de un evento planeado. Sea lo que sea, no es</p>
<p>excusa para mantener c√≥digo incorrecto en el sistema.</p>
<p>En la actualidad, muchos IDE cuentan con funciones especiales para</p>
<p>localizar comentarios TODO por lo que seguramente no se pierda. Sin</p>
<p>embargo, no colapse el c√≥digo con estos comentarios. Exam√≠nelos y elimine</p>
<p>todos los que pueda.</p>
<h3 id="amplificacion-83">Amplificaci√≥n</h3>
<p>Se puede usar un comentario para amplificar la importancia de algo que, en</p>
<p>caso contrario, parecer√≠a irrelevante.</p>
<p>String listItemContent = match.group(3).trim();</p>
<p>// el recorte es importante. Elimina los espacios iniciales</p>
<p>// que har√≠an que el elemento se reconociera como</p>
<p>// otra lista.</p>
<p>new ListItemWidget(this, listItemContent, this.level + 1);</p>
<p>return buildList(text.substring(match.end()));</p>
<h3 id="javadoc-en-api-publicas-84">Javadoc en API p√∫blicas</h3>
<p>No hay nada m√°s √∫til y satisfactorio que una API p√∫blica bien descrita. Los</p>
<p>javadoc de la biblioteca est√°ndar de Java son un ejemplo. Ser√≠a muy</p>
<p>complicado crear programas de Java sin ellos.</p>
<p>Si usa una API p√∫blica, debe crear javadoc de calidad para la misma, pero</p>
<p>recuerde el siguiente consejo a lo largo del cap√≠tulo: los javadoc pueden ser</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>tan ambiguos, amplios y descorteses como cualquier otro tipo de documento.</p>
<h3 id="comentarios-incorrectos-85">Comentarios incorrectos</h3>
<p>Muchos comentarios pertenecen a esta categor√≠a. Suelen ser excusas de</p>
<p>c√≥digo pobre o justificaciones de decisiones insuficientes, algo as√≠ como si el</p>
<p>programador se hablara a s√≠ mismo.</p>
<h3 id="balbucear-86">Balbucear</h3>
<p>A√±adir un comentario sin raz√≥n o porque el proceso lo requiere es un error. Si</p>
<p>decide escribir un comentario, t√≥mese el tiempo necesario para asegurarse de</p>
<p>que sea el mejor que puede redactar.</p>
<p>El siguiente ejemplo es de FitNesse, donde un comentario sin duda ser√≠a</p>
<p>de utilidad, pero el autor ten√≠a prisa o no prest√≥ demasiada atenci√≥n. Su</p>
<p>balbuceo gener√≥ un enigma:</p>
<p>public void loadProperties()</p>
<p>try</p>
<p>String propertiesPath = propertiesLocation + ‚Äú/‚Äù + PROPERTIES_FILE;</p>
<p>FileInputStream propertiesStream = new FileInputStream(propertiesPath);</p>
<p>loadedProperties.load(propertiesStream);</p>
<p>catch(IOException e)</p>
<p>// Si no hay archivos de propiedades significan que cargan las predeterminadas</p>
<p>¬øQu√© significa el comentario del bloque catch ? Seguro que algo para el</p>
<p>autor, pero el significado no est√° claro. Aparentemente, si se genera</p>
<p>IOException , significa que no hay archivo de propiedades y, en ese caso, se</p>
<p>cargan los valores predeterminados. ¬øPero qui√©n carga los valores</p>
<p>predeterminados? ¬øSe cargan antes de la invocaci√≥n de</p>
<p>loadProperties.load loadProperties.load captura la excepci√≥n, carga</p>
<p>los valores predeterminados y despu√©s nos pasa la excepci√≥n para que la</p>
<p>ignoremos? ¬øO ser√° que loadProperties.load carga todos los valores</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>predeterminados antes de intentar abrir el archivo? ¬øIntentaba el autor</p>
<p>consolarse por dejar el bloque catch vac√≠o? √âsta es la posibilidad m√°s temida,</p>
<p>¬øse estaba diciendo que volviera m√°s tarde para crear el c√≥digo para cargar</p>
<p>los valores predeterminados?</p>
<p>Nuestro √∫nico recurso es examinar el c√≥digo en otras partes del sistema</p>
<p>para determinar qu√© sucede. Cualquier comentario que le obligue a buscar su</p>
<p>significado en otro m√≥dulo ha fallado en su intento de comunicaci√≥n y no</p>
<p>merece los bits que consume.</p>
<h3 id="comentarios-redundantes-87">Comentarios redundantes</h3>
<p>El Listado 4-1 muestra una sencilla funci√≥n con un comentario de</p>
<p>encabezado totalmente redundante. Seguramente se tarde m√°s en leer que el</p>
<p>propio c√≥digo.</p>
<p>Listado 4-1</p>
<p>waitForClose.</p>
<p>// M√©todo de utilidad devuelto cuando this.closed es true. Genera una excepci√≥n</p>
<p>// si se alcanza el tiempo de espera.</p>
<p>public synchronized void waitForClose(final long timeoutMillis)</p>
<p>throws Exception</p>
<p>if (!closed)</p>
<p>wait(timeoutMillis);</p>
<p>if(!closed)</p>
<p>throw new Exception (‚ÄúMockResponseSender could not be closed‚Äù);</p>
<p>¬øPara qu√© sirve este comentario? No es m√°s informativo que el c√≥digo.</p>
<p>No lo justifica ni transmite la intenci√≥n ni la l√≥gica. No es m√°s f√°cil de leer</p>
<p>que el c√≥digo. De hecho, es menos preciso y obliga al lector a aceptar la falta</p>
<p>de precisi√≥n en lugar de a entenderlo. Es como un vendedor de coches de</p>
<p>segunda menos que le asegura que no hace falta revisar el motor.</p>
<p>F√≠jese ahora en la legi√≥n de javadoc in√∫tiles y redundantes del Listado 4-</p>
<p>2, obtenido de Tomcat. Estos comentarios √∫nicamente ensucian y oscurecen</p>
<p>el c√≥digo. No tienen ninguna funci√≥n documental. Para empeorar las cosas,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>s√≥lo le mostramos algunos. El m√≥dulo tiene muchos m√°s.</p>
<p>Listado 4-2</p>
<p>ContainerBase.java (Tomcat).</p>
<p>public abstract class ContainerBase</p>
<p>implements Container, Lifecycle, Pipeline,</p>
<p>MBeanRegistration, Serializable {</p>
<p>/**</p>
<ul>
<li>Retardo del procesador para este componente.</li>
</ul>
<p>*/</p>
<p>protected int backgroundProcessorDelay = -1;</p>
<p>/**</p>
<ul>
<li>Compatibilidad con eventos de ciclo vital de este componente.</li>
</ul>
<p>*/</p>
<p>protected LifecycleSupport lifecycle =</p>
<p>new LifecycleSupport(this);</p>
<p>/**</p>
<ul>
<li>Escuchadores de eventos de contenedor de este contenedor.</li>
</ul>
<p>*/</p>
<p>protected ArrayList listeners = new ArrayList();</p>
<p>/**</p>
<ul>
<li>Implementaci√≥n Loader a la que se asocia este contenedor.</li>
</ul>
<p>*/</p>
<p>protected Loader loader = null;</p>
<p>/**</p>
<ul>
<li>Implementaci√≥n Logger a la que se asocia este contenedor.</li>
</ul>
<p>*/</p>
<p>protected Log logger = null;</p>
<p>/**</p>
<ul>
<li>Nombre de registrador asociado.</li>
</ul>
<p>*/</p>
<p>protected String logName = null;</p>
<p>/**</p>
<ul>
<li>Implementaci√≥n Manager a la que se asocia este contenedor.</li>
</ul>
<p>*/</p>
<p>protected Manager manager = null;</p>
<p>/**</p>
<ul>
<li>Cl√∫ster al que se asocia este contenedor.</li>
</ul>
<p>*/</p>
<p>protected Cluster cluster = null;</p>
<p>/**</p>
<ul>
<li>Nombre legible de este contenedor.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
</ul>
<p>*/</p>
<p>protected String name = null;</p>
<p>/**</p>
<ul>
<li>Contenedor principal de este contenedor.</li>
</ul>
<p>*/</p>
<p>protected Container parent = null;</p>
<p>/**</p>
<ul>
<li>Cargador de clase principal que configurar al instalar un elemento</li>
<li>Loader.</li>
</ul>
<p>*/</p>
<p>protected ClassLoader parentClassLoader = null;</p>
<p>/**</p>
<ul>
<li>Objeto Pipeline al que se asocia este contenedor.</li>
</ul>
<p>*/</p>
<p>protected Pipeline pipeline = new StandardPipeline(this);</p>
<p>/**</p>
<ul>
<li>Objeto Realm al que se asocia este contenedor.</li>
</ul>
<p>*/</p>
<p>protected Realm realm = null;</p>
<p>/**</p>
<ul>
<li>Objeto DirContext de recursos al que se asocia este contenedor.</li>
</ul>
<p>*/</p>
<p>protected DirContext resources = null;</p>
<h3 id="comentarios-confusos-88">Comentarios confusos</h3>
<p>En ocasiones, a pesar de las buenas intenciones, un programador realiza una</p>
<p>afirmaci√≥n en sus comentarios que no es del todo precisa. F√≠jese otra vez en</p>
<p>el comentario redundante y confuso del Listado 4-1.</p>
<p>¬øSabe por qu√© es confuso? El m√©todo no devuelve nada cuando</p>
<p>this.closed se convierte en true . Devuelve algo si this.closed es true ; en</p>
<p>caso contrario, espera y genera una excepci√≥n si this.closed no es true</p>
<p>Este sutil fragmento, oculto en un comentario m√°s dif√≠cil de leer que el</p>
<p>cuerpo del c√≥digo, puede hacer que otro programador invoque la funci√≥n con</p>
<p>la esperanza de que devuelva algo cuando this.closed sea true . Ese pobre</p>
<p>programador se encontrar√° en una sesi√≥n de depuraci√≥n intentando</p>
<p>determinar por qu√© el c√≥digo se ejecuta tan lentamente.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="comentarios-obligatorios-89">Comentarios obligatorios</h3>
<p>Es una locura tener una regla que afirme que todas las funciones deben tener</p>
<p>un javadoc o que todas las variables deben tener un comentario. Este tipo de</p>
<p>comentarios ensucian el c√≥digo y generan confusi√≥n y desorganizaci√≥n. Por</p>
<p>ejemplo, los javadoc obligatorios para todas las funciones crean</p>
<p>abominaciones como el Listado 4-3. No sirven de nada, complican el c√≥digo</p>
<p>y constituyen posibles enga√±os y desorientaciones.</p>
<p>Listado 4-3</p>
<p>/**</p>
<ul>
<li>@param title El t√≠tulo del CD</li>
<li>@param author El autor del CD</li>
<li>@param tracks El n√∫mero de pistas del CD</li>
<li>@param durationInMinutes La duraci√≥n del CD en minutos</li>
</ul>
<p>*/</p>
<p>public void addCD(String title, String author,</p>
<p>int tracks, int durationInMinutes) {</p>
<p>CD cd = new CD();</p>
<p>cd.title = title;</p>
<p>cd.author = author;</p>
<p>cd.tracks = tracks;</p>
<p>cd.duration = duration;</p>
<p>cdList.add(cd);</p>
<h3 id="comentarios-periodicos-90">Comentarios peri√≥dicos</h3>
<p>En ocasiones, se a√±ade un comentario al inicio de un m√≥dulo cada vez que se</p>
<p>edita. Estos comentarios acumulan una especie de registro de todos los</p>
<p>cambios realizados. He visto m√≥dulos con decenas de p√°ginas con estas</p>
<p>entradas.</p>
<ul>
<li>Cambios (11-Oct-2001)</li>
<li>-----------------------------</li>
<li>11-Oct- : Reorganizaci√≥n de la clase y cambio a un nuevo paquete</li>
</ul>
<p>com.jrefinery.date (DG);</p>
<ul>
<li>05-Nov- : Se a√±ade un m√©todo getDescription() y se elimina la clase</li>
</ul>
<p>NotableDate (DG);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<ul>
<li>12-Nov- : IBD requiere el m√©todo setDescription(), una vez eliminada la</li>
</ul>
<p>clase NotableDate</p>
<p>(DG); se cambian getPreviousDayOfWeek(), getFollowingDayOfWeek()</p>
<p>y getNearestDayOfWeek() para corregir errores (DG);</p>
<ul>
<li>05-Dic- : Error corregido en la clase SpreadsheetDate (DG);</li>
<li>29-May- : Se transfieren todas las constantes de mes a una interfaz</li>
</ul>
<p>independiente (MonthConstants) (DG);</p>
<ul>
<li>27-Ago- : Error corregido en el m√©todo addMonths(), gracias a N√°levka Petr</li>
</ul>
<p>(DG);</p>
<ul>
<li>03-Oct- : Errores indicados por Checkstyle (DG) corregidos;</li>
<li>13-Mar- : Implementaci√≥n de Serializable (DG);</li>
<li>29-May- : Error corregido en el m√©todo addMonths (DG);</li>
<li>04-Sep- : Implementaci√≥n de Comparable. Actualizaci√≥n de los javadoc</li>
</ul>
<p>isInRange (DG);</p>
<ul>
<li>05-Ene- : Error corregido en el m√©todo addYears() (1096202) (DG);</li>
</ul>
<p>Hace tiempo hubo una buena raz√≥n para crear y mantener estas entradas</p>
<p>de registro al inicio de cada m√≥dulo. Carec√≠amos de sistemas de control de</p>
<p>c√≥digo fuente que se encargaran de ello, pero en la actualidad, estas entradas</p>
<p>son elementos sobrantes que complican los m√≥dulos. Debe eliminarlas</p>
<p>totalmente.</p>
<h3 id="comentarios-sobrantes-91">Comentarios sobrantes</h3>
<p>En ocasiones vemos comentarios que simplemente sobran. Restan</p>
<p>importancia a lo evidente y no ofrecen informaci√≥n nueva.</p>
<p>/**</p>
<ul>
<li>Constructor predeterminado.</li>
</ul>
<p>*/</p>
<p>protected AnnualDateRule() {</p>
<p>¬øEn serio? ¬øY este otro?:</p>
<p>/** D√≠a del mes. */</p>
<p>private int dayOfMonth;</p>
<p>Y aqu√≠ el parang√≥n de la redundancia:</p>
<p>/**</p>
<ul>
<li>Devuelve el d√≠a del mes.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>@return el d√≠a del mes.</li>
</ul>
<p>*/</p>
<p>public int getDayOfMonth() {</p>
<p>return dayOfMonth;</p>
<p>Estos comentarios son tan inservibles que aprendemos a ignorarlos. Al</p>
<p>leer el c√≥digo, la vista los salta. Con el tiempo, los comentarios empiezan a</p>
<p>mentir cuando cambia el c√≥digo que les rodea.</p>
<p>[25]</p>
<p>El primer comentario del Listado 4-4 parece correcto . Explica por qu√©</p>
<p>se ignora el bloque catch , pero el segundo comentario sobra. Parece que el</p>
<p>programador estaba tan frustrado con crear bloques try/catch en la funci√≥n</p>
<p>que necesitaba explotar.</p>
<p>Listado 4-4</p>
<p>startSending.</p>
<p>private void startSending()</p>
<p>try</p>
<p>doSending();</p>
<p>catch(SocketException e)</p>
<p>// normal, alguien ha detenido la solicitud.</p>
<p>catch(Exception e)</p>
<p>try</p>
<p>response.add(ErrorResponder.makeExceptionString(e));</p>
<p>response.closeAll();</p>
<p>catch(Exception e1)</p>
<p>//¬°Un respiro!</p>
<p>En lugar de explotar en un comentario sin sentido, el programador</p>
<p>deber√≠a haber sabido que su frustraci√≥n se podr√≠a aliviar mejorando la</p>
<p>estructura del c√≥digo. Tendr√≠a que haber centrado su energ√≠a en extraer el</p>
<p>√∫ltimo bloque try/catch en una funci√≥n independiente, como muestra el</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Listado 4-5.</p>
<p>Listado 4-5</p>
<p>startSending (refactorizado).</p>
<p>private void startSending()</p>
<p>try</p>
<p>doSending();</p>
<p>catch(SocketException e)</p>
<p>// normal. Alguien ha detenido la solicitud.</p>
<p>catch(Exception e)</p>
<p>addExceptionAndCloseResponse(e);</p>
<p>private void addExceptionAndCloseResponse(Exception e)</p>
<p>try</p>
<p>response.add(ErrorResponder.makeExceptionString(e));</p>
<p>response.closeAll();</p>
<p>catch(Exception e1)</p>
<p>Cambie la tentaci√≥n de crear elementos sobrantes por la determinaci√≥n de</p>
<p>limpiar su c√≥digo. Mejorar√° como programador y ser√° m√°s f√°cil.</p>
<h3 id="comentarios-sobrantes-espeluznantes-92">Comentarios sobrantes espeluznantes</h3>
<p>Los javadoc tambi√©n pueden ser innecesarios. ¬øPara qu√© sirven los siguientes</p>
<p>javadoc (de una conocida biblioteca) de c√≥digo abierto? La respuesta: para</p>
<p>nada. Son comentarios redundantes creados en un intento equivocado de</p>
<p>redactar documentaci√≥n.</p>
<p>/** El nombre. */</p>
<p>private String name;</p>
<p>/** La versi√≥n. */</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private String version;</p>
<p>/** El licenceName. */</p>
<p>private String licenceName;</p>
<p>/** La versi√≥n. */</p>
<p>private String info;</p>
<p>Vuelva a leer los comentarios. ¬øDetecta el error de corta y pega? Si los</p>
<p>autores no prestan atenci√≥n al escribir sus comentarios (o al pegarlos), ¬øpor</p>
<p>qu√© se espera que sean de utilidad para los lectores?</p>
<h3 id="no-usar-comentarios-si-se-puede-usar-una-funcion-o-93">No usar comentarios si se puede usar una funci√≥n o una</h3>
<h3 id="variable-94">variable</h3>
<p>F√≠jese en el siguiente c√≥digo:</p>
<p>// ¬øel m√≥dulo de la lista global &lt;mod&gt; depende del</p>
<p>// subsistema del que formamos parte?</p>
<p>if (smodule.getDependSubsystems().contains(subSysMod.getSubsystem()))</p>
<p>Se podr√≠a cambiar sin el comentario de esta forma:</p>
<p>ArrayList moduleDependees = smodule.getDependSubsystems();</p>
<p>String ourSubSystem = subSysMod.getSubSystem();</p>
<p>if (moduleDependees.contains(ourSubSystem))</p>
<p>El autor del c√≥digo original seguramente escribi√≥ primero el comentario</p>
<p>(improbable) y despu√©s el c√≥digo para ajustarlo al comentario. Sin embargo,</p>
<p>el autor tendr√≠a que haber refactorizado el c√≥digo, como hice yo, para poder</p>
<p>eliminar el comentario.</p>
<h3 id="marcadores-de-posicion-95">Marcadores de posici√≥n</h3>
<p>En ocasiones los programadores marcan una determinada posici√≥n en un</p>
<p>archivo. Por ejemplo, recientemente encontr√© esto en un programa:</p>
<p>// Acciones //////////////////////////////////</p>
<p>Son escasas las ocasiones en las que tiene sentido agrupar funciones bajo</p>
<p>esta estructura. Por lo general, debe eliminarse, sobre todo la molesta hilera</p>
<p>de barras al final.</p>
<p>Pi√©nselo de esta forma. Estas estructuras son atractivas si no las usa</p>
<p>demasiado. Por ello, √∫selas espor√°dicamente y s√≥lo cuando el beneficio sea</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>significativo. Si las usa en exceso, acabar√°n por ser ignoradas.</p>
<h3 id="comentarios-de-llave-de-cierre-96">Comentarios de llave de cierre</h3>
<p>En ocasiones, los programadores incluyen comentarios especiales en llaves</p>
<p>de cierre, como en el Listado 4-6. Aunque pueda tener sentido en funciones</p>
<p>extensas con estructuras anidadas, √∫nicamente estorba las funciones</p>
<p>encapsuladas y de peque√±o tama√±o que nos gustan. Por ello, si siente el deseo</p>
<p>de marcar sus llaves de cierre, pruebe a reducir el tama√±o de sus funciones.</p>
<p>Listado 4-6</p>
<p>wc.java.</p>
<p>public class wc {</p>
<p>public static void main(String[] args) {</p>
<p>BufferedReader in = new BufferedReader(new InputstreamReader(System.in));</p>
<p>String line;</p>
<p>int lineCount = 0;</p>
<p>int charCount = 0;</p>
<p>int wordCount = 0;</p>
<p>try {</p>
<p>while ((line = in.readLine()) != null) {</p>
<p>lineCount++;</p>
<p>charCount += line.length();</p>
<p>String words[] = line.split(‚Äú\\W‚Äù);</p>
<p>wordCount += words.length;</p>
<p>//while</p>
<p>System.out.println(‚ÄúwordCount = ‚Äù + wordCount);</p>
<p>System.out.println(‚ÄúlineCount = ‚Äù + lineCount);</p>
<p>System.out.println(‚ÄúcharCount = ‚Äù + charCount);</p>
<p>// try</p>
<p>catch (IOException e) {</p>
<p>System.err.println(‚ÄúError: ‚Äù + e.getMessage());</p>
<p>//catch</p>
<p>//main</p>
<h3 id="asignaciones-y-menciones-97">Asignaciones y menciones</h3>
<p>/* A√±adido por Rick */</p>
<p>Los sistemas de control de c√≥digo fuente recuerdan a la perfecci√≥n qui√©n ha</p>
<p>a√±adido qu√© y cu√°ndo. No es necesario plagar el c√≥digo con peque√±as</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>menciones. Puede pensar que estos comentarios son √∫tiles y que ayudan a</p>
<p>otros a hablar sobre el c√≥digo, pero en realidad sobreviven durante a√±os y</p>
<p>cada vez son menos precisos y relevantes. El sistema de control de c√≥digo</p>
<p>fuente es el punto id√≥neo para este tipo de informaci√≥n.</p>
<h3 id="codigo-comentado-98">C√≥digo comentado</h3>
<p>No hay nada m√°s odioso que el c√≥digo comentado. ¬°No lo haga!</p>
<p>InputStreamResponse response = new inputStreamResponse();</p>
<p>response.setBody(formatter.getResultStream(), formatter.getByteCount());</p>
<p>// InputStream resultsStream = formatter.getResultStream();</p>
<p>// StreamReader reader = new StreamReader(resultsStream);</p>
<p>// response.setContent(reader.read(formatter.getByteCount()));</p>
<p>Los lectores que vean c√≥digo comentado no tendr√°n el valor de borrarlo.</p>
<p>Pensar√°n que est√° ah√≠ por algo y que es demasiado importante para borrarlo.</p>
<p>Por ello, el c√≥digo comentado se acumula como los sedimentos en una botella</p>
<p>de vino malo.</p>
<p>F√≠jese en este fragmento de apache commons:</p>
<p>this.bytePos = writeBytes(pngIdBytes, 0);</p>
<p>//hdrPos = bytePos;</p>
<p>writeHeader();</p>
<p>writeResolution();</p>
<p>//dataPos = bytePos;</p>
<p>if (writeImageData()) {</p>
<p>writeEnd();</p>
<p>this.pngBytes = resizeByteArray(this.pngBytes, this.maxPos);</p>
<p>else {</p>
<p>this.pngBytes = null;</p>
<p>return this.pngBytes;</p>
<p>¬øPor qu√© hay dos l√≠neas comentadas? ¬øSon importantes? ¬øSe han</p>
<p>conservado como recordatorio de un cambio inminente o es algo que alguien</p>
<p>coment√≥ hace a√±os y no se ha preocupado de limpiar? Hubo una √©poca, en la</p>
<p>d√©cada de 1960, en la que el c√≥digo comentado pudo ser √∫til, pero hace</p>
<p>tiempo que contamos con buenos sistemas de control de c√≥digo fuente,</p>
<p>sistemas que recuerdan el c√≥digo por nosotros. Ya no tenemos que</p>
<p>comentarlo. Elim√≠nelo. No lo perder√°. Se lo aseguro.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="comentarios-html-99">Comentarios HTML</h3>
<p>El HTML en comentarios de c√≥digo fuente es una aberraci√≥n, como puede</p>
<p>apreciar en el siguiente fragmento. Dificulta la lectura de los comentarios</p>
<p>donde deber√≠a ser m√°s f√°cil; el editor o IDE. Si los comentarios se van a</p>
<p>extraer con una herramienta (como Javadoc) para mostrarlos en una p√°gina</p>
<p>Web, debe ser responsabilidad de dicha herramienta y no del programador el</p>
<p>adornar los comentarios con el correspondiente HTML.</p>
<p>/**</p>
<p>Tarea para ejecutar pruebas de aceptaci√≥n.</p>
<p>Esta tarea ejecuta pruebas de aceptaci√≥n y publica los resultados.</p>
<p>&lt;p/&gt;</p>
<p>&lt;pre&gt;</p>
<p>Uso:</p>
<p>&amp;lt;taskdef name=&amp;quot;execute-fitnesse-tests&amp;quot;</p>
<p>classname=&amp;quot;fitnesse.ant.ExecuteFitnesseTestsTask&amp;quot;</p>
<p>classpathref=&amp;quot;classpath&amp;quot; /&amp;gt;</p>
<p>OR</p>
<p>&amp;lt;taskdef classpathref=&amp;quot;classpath&amp;quot;</p>
<p>resource=&amp;quot;tasks.properties&amp;quot; /&amp;gt;</p>
<p>&lt;p/&gt;</p>
<p>&amp;lt;execute-fitnesse-tests</p>
<p>suitepage=&amp;quot;FitNesse.SuiteAcceptanceTests&amp;quot;</p>
<p>fitnesseport=&amp;quot;8082&amp;quot;</p>
<p>resultsdir=&amp;quot;$(results.dir)&amp;quot;</p>
<p>resultshtmlpage=&amp;quot;fit-results.html&amp;quot;</p>
<p>classpathref=&amp;quot;classpath&amp;quot; /&amp;gt;</p>
<p>&lt;/pre&gt;</p>
<p>*/</p>
<h3 id="informacion-no-local-100">Informaci√≥n no local</h3>
<p>Si tiene que escribir un comentario, aseg√∫rese de que describa el c√≥digo que</p>
<p>le rodea. No ofrezca informaci√≥n global del sistema en el contexto de un</p>
<p>comentario local. F√≠jese en el siguiente comentario javadoc. Aparte de su</p>
<p>terrible redundancia, tambi√©n ofrece informaci√≥n sobre el puerto</p>
<p>predeterminado la funci√≥n no tiene control alguno sobre el puerto</p>
<p>predeterminado. El comentario no describe la funci√≥n sino otra parte distinta</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>del sistema. Evidentemente, no hay garant√≠as de que el comentario cambie</p>
<p>cuando lo haga el c√≥digo que contiene el valor predeterminado.</p>
<p>/**</p>
<ul>
<li>Puerto para ejecutar fitnesse. El predeterminado es &lt;b&gt;8082&lt;/b&gt;.</li>
<li>@param fitnessePort</li>
</ul>
<p>*/</p>
<p>public void setFitnessePort(int fitnessePort)</p>
<p>this.fitnessePort = fitnessePort;</p>
<h3 id="demasiada-informacion-101">Demasiada informaci√≥n</h3>
<p>No incluya en sus comentarios interesantes reflexiones hist√≥ricas ni</p>
<p>irrelevantes descripciones de detalles. El siguiente comentario se ha extra√≠do</p>
<p>de un m√≥dulo dise√±ado para probar que una funci√≥n puede codificar y</p>
<p>descodificar base64. Aparte del n√∫mero RFC, el lector de este c√≥digo no</p>
<p>necesita la informaci√≥n obsoleta que contiene el comentario.</p>
<p>/*</p>
<p>RFC 2045 - Extensiones Multiprop√≥sito de correo de Internet (MIME)</p>
<p>Primera parte: Formato del Cuerpo de los Mensajes de Internet</p>
<p>secci√≥n 6.8. Codificaci√≥n de transferencia de contenidos Base64</p>
<p>El proceso de codificaci√≥n representa grupos de 24 bits de la entrada</p>
<p>como cadenas de salida de 4 caracteres codificados. Procediendo de</p>
<p>izquierda a derecha, se forma un grupo de 24 bits de entrada</p>
<p>concatenando 3 grupos de 8 bits de entrada. Estos 24 bits se tratan</p>
<p>como 4 grupos concatenados de 6 bits, cada uno de los cuales se</p>
<p>traduce en un solo d√≠gito del alfabeto base64. Cuando se codifica un</p>
<p>flujo de bits mediante la codificaci√≥n base64, el flujo de bits se</p>
<p>debe considerar ordenado con el bit m√°s significativo primero. Esto</p>
<p>es, el primer bit del flujo ser√° el bit de orden m√°s alto en el</p>
<p>primer byte de 8 bits, y el octavo bit ser√° el de orden m√°s bajo en</p>
<p>el primer byte de 8 bits, y as√≠ sucesivamente.</p>
<p>*/</p>
<h3 id="conexiones-no-evidentes-102">Conexiones no evidentes</h3>
<p>La conexi√≥n entre un comentario y el c√≥digo que describe debe ser evidente.</p>
<p>Si se ha preocupado de escribir un comentario, lo m√≠nimo es que el lector que</p>
<p>lo vea entienda a qu√© se refiere. F√≠jese en este comentario obtenido de apache</p>
<p>commons:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/*</p>
<p>comienza con una matriz de tama√±o suficiente para albergar todos los</p>
<p>pixeles</p>
<p>(m√°s bytes de filtro), bytes adicionales para la informaci√≥n de</p>
<p>encabezado</p>
<p>*/</p>
<p>this.pngBytes = new byte[((this.width + 1) * this.height * 3) + 200];</p>
<p>¬øQu√© es un byte de filtro? ¬øEst√° relacionado con +1 ? ¬øO con *3 ? ¬øCon</p>
<p>ambos? ¬øEs un pixel un byte ? ¬øPor qu√© 200? La funci√≥n de un comentario es</p>
<p>explicar c√≥digo que no se explica por s√≠ mismo. Es una l√°stima que un</p>
<p>comentario requiera su propia explicaci√≥n.</p>
<h3 id="encabezados-de-funcion-103">Encabezados de funci√≥n</h3>
<p>Las funciones breves apenas requieren explicaci√≥n. Un nombre bien elegido</p>
<p>para una funci√≥n que hace una cosa suele ser mejor que un encabezado de</p>
<p>comentario.</p>
<h3 id="javadocs-en-codigo-no-publico-104">Javadocs en c√≥digo no p√∫blico</h3>
<p>A pesar de la utilidad de los javadoc para las API p√∫blicas, no sirven para</p>
<p>c√≥digo no dirigido a consumo p√∫blico. La generaci√≥n de p√°ginas javadoc</p>
<p>para clases y funciones de un sistema no suele ser √∫til y la formalidad</p>
<p>adicional de los comentarios javadoc no es m√°s que una distracci√≥n.</p>
<h3 id="ejemplo-105">Ejemplo</h3>
<p>Escrib√≠ el m√≥dulo del Listado 4-7 para la primera versi√≥n de XP Immersion</p>
<p>Deb√≠a ser un ejemplo de estilo incorrecto de creaci√≥n de c√≥digo</p>
<p>comentarios. Despu√©s, Kent Beck refactoriz√≥ este c√≥digo en algo mucho m√°s</p>
<p>atractivo delante de varios alumnos. Posteriormente, adapt√© el ejemplo para</p>
<p>mi libro Agile Software Development, Principles, Patterns, and Practices</p>
<p>para el primero de mis art√≠culos Craftsman publicados en la revista Software</p>
<p>Development</p>
<p>Lo que me fascina de este m√≥dulo es que hubo un tiempo en que muchos</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>lo hubi√©ramos considerado bien documentado. Ahora vemos que es un</p>
<p>aut√©ntico desastre. A ver cu√°ntos problemas detecta en los comentarios.</p>
<p>Listado 4-7</p>
<p>GeneratePrimes.java.</p>
<p>/**</p>
<p>Esta clase genera n√∫meros primos hasta la cantidad m√°xima especificada por</p>
<p>el</p>
<ul>
<li>usuario. El algoritmo usado es la Criba de Erat√≥stenes.</li>
<li>&lt;p&gt;</li>
<li>Erat√≥stenes de Cirene, 276 a. C., Cirene, Libia -</li>
<li>194 a. C., Alejandr√≠a. El primer hombre en calcular la</li>
<li>circunferencia de la Tierra. Tambi√©n trabaj√≥ con calendarios</li>
<li>con a√±os bisiestos y fue responsable de la Biblioteca de Alejandr√≠a.</li>
<li>&lt;p&gt;</li>
<li>El algoritmo es muy simple. Dada una matriz de enteros</li>
</ul>
<p>empezando por el 2, se tachan todos los m√∫ltiplos de 2. Se busca el</p>
<p>siguiente</p>
<ul>
<li>entero sin tachar y se tachan todos sus m√∫ltiplos.</li>
<li>Repetir hasta superar la ra√≠z cuadrada del valor</li>
<li>m√°ximo.</li>
<li>¬©author Alphonse</li>
<li>¬©version 13 Feb 2002 atp</li>
</ul>
<p>*/</p>
<p>import java.util.*;</p>
<p>public class GeneratePrimes</p>
<p>/**</p>
<ul>
<li>@param maxValue es el l√≠mite de generaci√≥n.</li>
</ul>
<p>*/</p>
<p>public static int[] generatePrimes(int maxValue)</p>
<p>if (maxValue &gt;= 2) //el √∫nico caso v√°lido</p>
<p>// declaraciones</p>
<p>int s = maxValue + 1; // tama√±o de la matriz</p>
<p>boolean[] f = new boolean[s];</p>
<p>int i;</p>
<p>// inicializar la matriz en true.</p>
<p>for (i = 0; i &lt; s; i++)</p>
<p>f[i] = true;</p>
<p>// eliminar los n√∫meros no primos conocidos</p>
<p>f[0] = f[1] = false;</p>
<p>// cribar</p>
<p>int j;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>for (i = 2; i &lt; Math.sqrt(s) + 1; i++)</p>
<p>if (f[i]) // si no est√° tachado, tachar sus m√∫ltiplos.</p>
<p>for (j = 2 * i; j &lt; s; j += i)</p>
<p>f[j] = false; // el m√∫ltiplo no es primo</p>
<p>// ¬øcu√°ntos primos hay?</p>
<p>int count = 0;</p>
<p>for (i = 0; i &lt; s; i++)</p>
<p>if (f[i])</p>
<p>count++; // contador.</p>
<p>int[] primes = new int[count];</p>
<p>// enviar primos al resultado</p>
<p>for (i = 0, j = 0; i &lt; s; i++)</p>
<p>if (f[i]) // si es primo</p>
<p>primes[j++] = i;</p>
<p>return primes; // devolver los primos</p>
<p>else // maxValue &lt; 2</p>
<p>return new int[0]; // devolver matriz null si la entrada no es</p>
<p>correcta.</p>
<p>En el Listado 4-8 puede ver una versi√≥n refactorizada del mismo m√≥dulo.</p>
<p>Se ha limitado considerablemente el uso de comentarios. Hay s√≥lo dos en</p>
<p>todo el m√≥dulo y ambos claramente descriptivos.</p>
<p>Listado 4-8</p>
<p>PrimeGenerator.java (refactorizado).</p>
<p>/**</p>
<p>Esta clase genera n√∫meros primos hasta la cantidad m√°xima especificada por</p>
<p>el</p>
<p>usuario. El algoritmo usado es la Criba de Erat√≥stenes. Dada una matriz de</p>
<p>enteros</p>
<ul>
<li>empezando por el 2: buscar el primer entero sin tachar y tachar todos sus</li>
<li>m√∫ltiplos. Repetir hasta que no haya m√°s m√∫ltiplos en la matriz.</li>
</ul>
<p>*/</p>
<p>public class PrimeGenerator</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private static boolean[] crossedOut;</p>
<p>private static int[] result;</p>
<p>public static int[] generatePrimes(int maxValue)</p>
<p>if (maxValue &lt; 2)</p>
<p>return new int[0];</p>
<p>else</p>
<p>uncrossIntegersUpTo(maxValue);</p>
<p>crossOutMultiples();</p>
<p>putUncrossedIntegersIntoResult();</p>
<p>return result;</p>
<p>private static void uncrossIntegersUpTo(int maxValue)</p>
<p>crossedOut = new boolean[maxValue + 1];</p>
<p>for (int i = 2; i &lt; crossedOut.length; i++)</p>
<p>crossedOut[i] = false;</p>
<p>private static void crossOutMultiples()</p>
<p>int limit = determineIterationLimit();</p>
<p>for (int i = 2; i &lt;= limit; i++)</p>
<p>if (notCrossed(i))</p>
<p>crossOutMultiplesOf(i);</p>
<p>private static int determineIterationLimit()</p>
<p>// Cada m√∫ltiplo en la matriz tiene un factor primordial que</p>
<p>// es menor o igual que la ra√≠z del tama√±o de la matriz,</p>
<p>// entonces no tenemos que tachar m√∫ltiplos de n√∫meros</p>
<p>// m√°s grande que esa ra√≠z.</p>
<p>double iterationLimit = Math.sqrt(crossedOut.length);</p>
<p>return (int) iterationLimit;</p>
<p>private static void crossOutMultiplesOf (int i)</p>
<p>for (int multiple = 2 * i;</p>
<p>multiple &lt; crossedOut.length;</p>
<p>multiple += i)</p>
<p>crossedOut[multiple] = true;</p>
<p>private static boolean notCrossed(int i)</p>
<p>return crossedOut[i] == false;</p>
<p>private static void putUncrossedIntegersIntoResult()</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>result = new int[numberOfUncrossedIntegers()];</p>
<p>for (int j = 0, i = 2; i &lt; crossedOut.length; i++)</p>
<p>if (notCrossed(i))</p>
<p>result[j++] = i;</p>
<p>private static int numberOfUncrossedIntegers()</p>
<p>int count = 0;</p>
<p>for (int i = 2; i &lt; crossedOut.length; i++)</p>
<p>if (notCrossed(i))</p>
<p>count++;</p>
<p>return count;</p>
<p>Se podr√≠a decir que el primer comentario es redundante ya que es muy</p>
<p>similar a la funci√≥n generatePrimes pero creo que muestra mejor el</p>
<p>algoritmo al lector, motivo por el que lo he mantenido. El segundo argumento</p>
<p>es sin duda necesario. Explica la l√≥gica del uso de la ra√≠z cuadrada como</p>
<p>l√≠mite del bucle. No encontr√© otro nombre de variable m√°s sencillo ni otra</p>
<p>estructura de c√≥digo que lo aclarara m√°s. Por otra parte, el uso de la ra√≠z</p>
<p>cuadrada podr√≠a resultar presuntuoso. ¬øRealmente se ahorra tanto tiempo</p>
<p>limitando la iteraci√≥n a la ra√≠z cuadrada? ¬øEl c√°lculo de la ra√≠z cuadrada</p>
<p>llevar√≠a m√°s tiempo del que se ahorra? Conviene analizarlo. El uso de la ra√≠z</p>
<p>cuadrada como l√≠mite de iteraci√≥n satisface al viejo hacker de C y de</p>
<p>lenguajes de ensamblado de mi interior, pero no estoy convencido de que</p>
<p>merezca el tiempo y el esfuerzo que los dem√°s puedan dedicar a entenderlo.</p>
<h3 id="bibliografia-106">Bibliograf√≠a</h3>
<p>[KP78] : Kernighan and Plaugher, The Elements of Programming Style</p>
<p>2d. ed., McGraw-Hill, 1978.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="formato-107">Formato</h1>
<p>Cuando los usuarios miran entre bastidores, queremos que queden</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>impresionados por el atractivo, la coherencia y la atenci√≥n al detalle que</p>
<p>perciben. Queremos que el orden les sorprenda, que abran los ojos con</p>
<p>asombro cuando se desplacen por los m√≥dulos. Queremos que aprecien que</p>
<p>se trata de un trabajo de profesionales. Si ven una masa amorfa de c√≥digo que</p>
<p>parece escrito por un grupo de marineros borrachos, es probable que piensen</p>
<p>que suceder√° lo mismo en otros aspectos del proyecto.</p>
<p>Debe preocuparse por el formato de su c√≥digo. Debe elegir una serie de</p>
<p>reglas sencillas que controlen el formato del c√≥digo y despu√©s aplicarlas de</p>
<p>forma coherente. Si trabaja en equipo, debe acordar una serie de reglas que</p>
<p>todos los miembros deben cumplir. Tambi√©n es muy √∫til usar una</p>
<p>herramienta automatizada que se encargue de aplicar las reglas.</p>
<h3 id="la-funcion-del-formato-108">La funci√≥n del formato</h3>
<p>En primer lugar, debe ser claro. El formato de c√≥digo es importante,</p>
<p>demasiado importante como para ignorarlo y tambi√©n demasiado importante</p>
<p>como para tratarlo de forma religiosa. El formato del c√≥digo se basa en la</p>
<p>comunicaci√≥n la comunicaci√≥n debe ser el principal pilar de un</p>
<p>desarrollador profesional.</p>
<p>Puede que piense que conseguir que algo funcione es la principal</p>
<p>preocupaci√≥n de un programador profesional. Espero que este libro le haga</p>
<p>cambiar de idea. La funcionalidad que cree hoy es muy probable que cambie</p>
<p>en la siguiente versi√≥n, pero la legibilidad de su c√≥digo afectar√°</p>
<p>profundamente a todos los cambios que realice. El estilo del c√≥digo y su</p>
<p>legibilidad establecen los precedentes que afectan la capacidad de</p>
<p>mantenimiento y ampliaci√≥n mucho despu√©s de que el c√≥digo cambie. Su</p>
<p>estilo y su disciplina sobrevivir√°n, aunque el c√≥digo no lo haga.</p>
<p>Veamos qu√© aspectos del formato nos permiten comunicarnos mejor.</p>
<h3 id="formato-vertical-109">Formato vertical</h3>
<p>Comencemos por el tama√±o vertical. ¬øQu√© tama√±o debe tener un archivo</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>fuente? En Java, el tama√±o de los archivos est√° relacionado con el tama√±o de</p>
<p>las clases, como veremos m√°s adelante. Por el momento, nos detendremos en</p>
<p>el tama√±o de los archivos.</p>
<p>¬øQu√© tama√±o tienen la mayor√≠a de archivos fuente de Java? Existe una</p>
<p>amplia gama de tama√±os e importantes diferencias de estilo, como se aprecia</p>
<p>en la figura 5.1.</p>
<p>Figura 5.1. Escala LOG de distribuciones de longitud de archivos (altura del cuadro =</p>
<p>sigma).</p>
<p>Se describen siete proyectos: Junit, FitNesse, testNG, Time and Money,</p>
<p>JDepend, Ant y Tomcat. Las l√≠neas que cruzan los cuadros muestran la</p>
<p>longitud m√°xima m√≠nima de cada proyecto. El cuadro muestra</p>
<p>[26]</p>
<p>aproximadamente un tercio (una desviaci√≥n est√°ndar ) de los archivos. La</p>
<p>parte central del cuadro es la media. Por tanto, el tama√±o de archivo medio</p>
<p>del proyecto FitNesse es de 65 l√≠neas y un tercio de los archivos ocupan entre</p>
<p>40 y 100+ l√≠neas.</p>
<p>El mayor archivo de FitNesse tiene unas 400 l√≠neas y el de menor tama√±o,</p>
<ul>
<li>Es una escala de registro, de modo que la peque√±a diferencia de posici√≥n</li>
</ul>
<p>vertical supone una gran diferencia en tama√±o absoluto.</p>
<p>Junit, FitNesse Time and Money tienen archivos relativamente</p>
<p>peque√±os. Ninguno supera las 500 l√≠neas y la mayor√≠a tienen menos de 200.</p>
<p>Tomcat y Ant, por su parte, tienen archivos con varios miles de l√≠neas de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>longitud y m√°s de la mitad superan las 200.</p>
<p>¬øQu√© significa todo esto? Aparentemente se pueden crear sistemas</p>
<p>(FitNesse se aproxima a las 50 000 l√≠neas) a partir de archivos de unas 200</p>
<p>l√≠neas de longitud, con un l√≠mite m√°ximo de 500. Aunque no deber√≠a ser una</p>
<p>regla, es un intervalo aconsejable. Los archivos de peque√±o tama√±o se</p>
<p>entienden mejor que los grandes.</p>
<h3 id="la-metafora-del-periodico-110">La met√°fora del peri√≥dico</h3>
<p>Piense en un art√≠culo de peri√≥dico bien escrito. En la parte superior espera un</p>
<p>titular que indique de qu√© se trata la historia y le permita determinar si quiere</p>
<p>leerlo o no. El primer p√°rrafo ofrece una sinopsis de la historia, oculta los</p>
<p>detalles y muestra conceptos generales. Al avanzar la lectura, aumentan los</p>
<p>detalles junto con todas las fechas, nombres, citas y otros elementos.</p>
<p>Un archivo de c√≥digo debe ser como un art√≠culo de peri√≥dico. El nombre</p>
<p>debe ser sencillo pero claro. Por s√≠ mismo, debe bastar para indicarnos si</p>
<p>estamos o no en el m√≥dulo correcto. Los elementos superiores del archivo</p>
<p>deben proporcionar conceptos y algoritmos de nivel superior. Los detalles</p>
<p>deben aumentar seg√∫n avanzamos, hasta que en la parte final encontremos las</p>
<p>funciones de nivel inferior del archivo.</p>
<p>Un peri√≥dico se compone de varios art√≠culos, algunos muy reducidos y</p>
<p>otros de gran tama√±o. No hay muchos que ocupen toda la p√°gina con texto,</p>
<p>para que el peri√≥dico sea manejable. Si el peri√≥dico fuera un √∫nico y extenso</p>
<p>texto con una aglomeraci√≥n desorganizada de hechos, fechas y nombres, no</p>
<p>lo leer√≠amos.</p>
<h3 id="apertura-vertical-entre-conceptos-111">Apertura vertical entre conceptos</h3>
<p>La pr√°ctica totalidad del c√≥digo se lee de izquierda a derecha y de arriba a</p>
<p>abajo. Cada l√≠nea representa una expresi√≥n o una cl√°usula, y cada grupo de</p>
<p>l√≠neas representa un pensamiento completo. Estos pensamientos deben</p>
<p>separarse mediante l√≠neas en blanco.</p>
<p>F√≠jese en el Listado 5-1. Hay l√≠neas en blanco que separan la declaraci√≥n</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>del paquete, las importaciones y las funciones. Es una regla muy sencilla con</p>
<p>un profundo efecto en el dise√±o visual del c√≥digo. Cada l√≠nea en blanco es</p>
<p>una pista visual que identifica un nuevo concepto independiente. Al avanzar</p>
<p>por el listado, la vista se fija en la primera l√≠nea que aparece tras una l√≠nea en</p>
<p>blanco.</p>
<p>Listado 5-1</p>
<p>BoldWidget.java</p>
<p>package fitnesse.wikitext.widgets;</p>
<p>import java.util.regex.*;</p>
<p>public class BoldWidget extends ParentWidget {</p>
<p>public static final String REGEXP = ‚Äú‚Äò‚Äò‚Äò.+?‚Äô‚Äô‚Äô‚Äù;</p>
<p>private static final Pattern pattern = Pattern.compile (‚Äú‚Äò‚Äò‚Äò(.+?)‚Äô‚Äô‚Äô‚Äù,</p>
<p>Pattern.MULTILINE + Pattern.DOTALL</p>
<p>);</p>
<p>public BoldWidget(ParentWidget parent, String text) throws Exception {</p>
<p>super(parent);</p>
<p>Matcher match = pattern.matcher(text);</p>
<p>match.find();</p>
<p>addChildWidgets(match.group(1));</p>
<p>public String render() throws Exception {</p>
<p>StringBuffer html = new StringBuffer(‚Äú&lt;b&gt;‚Äù);</p>
<p>html.append(childHtml()).append (‚Äú&lt;/b&gt;‚Äù);</p>
<p>return html.toString();</p>
<p>Si eliminamos las l√≠neas en blanco, como en el Listado 5-2, se oscurece la</p>
<p>legibilidad del c√≥digo.</p>
<p>Listado 5-2</p>
<p>BoldWidget.java</p>
<p>package fitnesse.wikitext.widgets;</p>
<p>import java.util.regex.*;</p>
<p>public class BoldWidget extends ParentWidget {</p>
<p>public static final String REGEXP = ‚Äú‚Äò‚Äò‚Äò.+?‚Äô‚Äô‚Äô‚Äù;</p>
<p>private static final Pattern pattern = Pattern.compile(‚Äú‚Äò‚Äò‚Äò(.+?)‚Äô‚Äô‚Äô‚Äù,</p>
<p>Pattern.MULTILINE + Pattern.DOTALL);</p>
<p>public BoldWidget(ParentWidget parent, String text) throws Exception {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>super(parent);</p>
<p>Matcher match = pattern.matcher(text);</p>
<p>match.find();</p>
<p>addChildWidgets(match.group(1));}</p>
<p>public String render() throws Exception {</p>
<p>StringBuffer html = new StringBuffer(‚Äú&lt;b&gt;‚Äù);</p>
<p>html.append(childHtml()).append(‚Äú&lt;/b&gt;‚Äù);</p>
<p>return html.toString();</p>
<p>Este efecto aumenta todav√≠a m√°s si no centramos la vista. En el primer</p>
<p>ejemplo, los distintos grupos de l√≠neas saltan a la vista, mientras que en el</p>
<p>segundo es una mezcla amorfa. La diferencia entre ambos listados es una</p>
<p>ligera apertura vertical.</p>
<h3 id="densidad-vertical-112">Densidad vertical</h3>
<p>Si la apertura separa los conceptos, la densidad vertical implica asociaciones.</p>
<p>Por tanto, las l√≠neas de c√≥digo con una relaci√≥n directa deben aparecer</p>
<p>verticalmente densas. F√≠jese en c√≥mo los comentarios sin sentido del</p>
<p>Listado 5-3 anulan la asociaci√≥n entre las dos variables de instancia.</p>
<p>Listado 5-3</p>
<p>public class ReporterConfig {</p>
<p>/**</p>
<ul>
<li>Nombre de clase del escuchador</li>
</ul>
<p>*/</p>
<p>private String m_className;</p>
<p>/**</p>
<ul>
<li>Propiedades del escuchador</li>
</ul>
<p>*/</p>
<p>private List&lt;Property&gt; m_properties = new ArrayList&lt;Property&gt;();</p>
<p>public void addProperty(Property property) {</p>
<p>m_properties.add(property);</p>
<p>El Listado 5-4 es mucho m√°s f√°cil de leer. Lo apreciamos a simple vista o</p>
<p>al menos yo lo hago. Al mirarlo, veo que es una clase con dos variables y un</p>
<p>m√©todo, sin tener que mover la cabeza ni la vista. El listado anterior nos</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>obliga a forzar la vista y a mover la cabeza para alcanzar el mismo nivel de</p>
<p>comprensi√≥n.</p>
<p>Listado 5-4</p>
<p>public class ReporterConfig {</p>
<p>private String m_className;</p>
<p>private List&lt;Property&gt; m_properties = new ArrayList&lt;Property&gt;();</p>
<p>public void addProperty(Property property) {</p>
<p>m_properties.add(property);</p>
<h3 id="distancia-vertical-113">Distancia vertical</h3>
<p>¬øAlguna vez ha tenido que recorrer una clase, saltando de una funci√≥n a otra,</p>
<p>desplaz√°ndose por el c√≥digo para intentar adivinar la relaci√≥n el</p>
<p>funcionamiento de las funciones, y acabar totalmente confundido? ¬øAlguna</p>
<p>vez ha escudri√±ado la cadena de herencia buscando la definici√≥n de una</p>
<p>variable o funci√≥n? Resulta frustrante porque intenta comprender lo que hace</p>
<p>el sistema, pero pierde el tiempo y su energ√≠a mental en intentar localizar y</p>
<p>recordar sus elementos.</p>
<p>Los conceptos relacionados entre s√≠ deben mantenerse juntos</p>
<p>verticalmente [G10]. Esta regla no funciona con conceptos de archivos</p>
<p>independientes. Por lo tanto, no debe separar conceptos relacionados en</p>
<p>archivos independientes a menos que tenga un motivo de peso. De hecho, es</p>
<p>uno de los motivos por los que se debe evitar el uso de variables protegidas.</p>
<p>Para los conceptos relacionados que pertenecen al mismo archivo, su</p>
<p>separaci√≥n vertical debe medir su importancia con respecto a la legibilidad</p>
<p>del otro. Debe evitar que el lector deambule entre archivos y clases.</p>
<p>Declaraciones de variables</p>
<p>Las variables deben declararse de la forma m√°s aproximada a su uso. Como</p>
<p>las funciones son muy breves, las variables locales deben aparecer en la parte</p>
<p>superior de cada funci√≥n, como en este ejemplo de Junit4.3.1.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private static void readPreferences() {</p>
<p>InputStream is = null;</p>
<p>try {</p>
<p>is = new FileInputStream(getPreferencesFile());</p>
<p>setPreferences(new Properties(getPreferences()));</p>
<p>getPreferences().load(is);</p>
<p>} catch (IOException e) {</p>
<p>try {</p>
<p>if (is != null)</p>
<p>is.close();</p>
<p>} catch (IOException e1) {</p>
<p>Las variables de control de bucles deben declararse en la instrucci√≥n del</p>
<p>bucle, como en esta peque√±a funci√≥n del mismo c√≥digo fuente:</p>
<p>public int countTestCases() {</p>
<p>int count= 0;</p>
<p>for ( Test each : tests)</p>
<p>count += each.countTestCases();</p>
<p>return count;</p>
<p>En casos excepcionales, una variable puede declararse en la parte superior</p>
<p>de un bloque o antes de un bucle en una funci√≥n extensa. Puede ver este tipo</p>
<p>de variable en la siguiente funci√≥n de TestNG.</p>
<p>...</p>
<p>for (XmlTest test: m_suite.getTests()) {</p>
<p>TestRunner tr = m_runnerFactory.newTestRunner(this, test);</p>
<p>tr.addListener(m_textReporter);</p>
<p>m_testRunners.add(tr);</p>
<p>invoker = tr.getInvoker();</p>
<p>for (ITestNGMethod m : tr.getBeforeSuiteMethods()) {</p>
<p>beforeSuiteMethods.put(m.getMethod(), m);</p>
<p>for (ITestNGMethod m : tr.getAfterSuiteMethods()) {</p>
<p>afterSuiteMethods.put(m.getMethod(), m);</p>
<p>...</p>
<p>Variables de instancia</p>
<p>Las variables de instancia, por su parte, deben declararse en la parte superior</p>
<p>de la clase. Esto no debe aumentar la distancia vertical de las variables, ya</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>que en una clase bien dise√±ada se usan en muchos sino en todos sus m√©todos.</p>
<p>Existen discrepancias sobre la ubicaci√≥n de las variables de instancia.</p>
<p>En C++ suele aplicarse la denominada regla de las tijeras, que sit√∫a todas las</p>
<p>variables de instancia en la parte inferior. En Java, sin embargo, es habitual</p>
<p>ubicarlas en la parte superior de la clase. No veo motivos para no hacerlo. Lo</p>
<p>importante es declarar las variables de instancia en un punto conocido para</p>
<p>que todo el mundo sepa d√≥nde buscarlas.</p>
<p>F√≠jese en el extra√±o caso de la clase TestSuite de JUnit 4.3.1. He</p>
<p>atenuado considerablemente esta clase para ilustrar este concepto. Si se fija</p>
<p>en la mitad del listado, ver√° dos variables de instancia declaradas. Resultar√≠a</p>
<p>complicado ocultarlas en un punto mejor. Cualquiera que lea este c√≥digo</p>
<p>tendr√≠a que toparse con las declaraciones por casualidad (como me pas√≥ a</p>
<p>m√≠).</p>
<p>public class TestSuite implements Test {</p>
<p>static public Test createTest(Class&lt;? extends TestCase&gt; theClass,</p>
<p>String name) {</p>
<p>...</p>
<p>public static Constructor&lt;? extends TestCase&gt;</p>
<p>getTestConstructor(Class&lt;? extends TestCase&gt; theClass)</p>
<p>throws NoSuchMethodException {</p>
<p>...</p>
<p>public static Test warning(final String message) {</p>
<p>...</p>
<p>private static String exceptionToString(Throwable t) {</p>
<p>...</p>
<p>private String fName;</p>
<p>private Vector&lt;Test&gt; fTests = new Vector&lt;Test&gt;(10);</p>
<p>public TestSuite() {</p>
<p>public TestSuite(final Class&lt;? extends TestCase&gt; theClass) {</p>
<p>...</p>
<p>public TestSuite(Class&lt;? extends TestCase&gt; theClass, String name) {</p>
<p>...</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>... ... ... ...</p>
<p>Funciones dependientes</p>
<p>Si una funci√≥n invoca otra, deben estar verticalmente pr√≥ximas, y la funci√≥n</p>
<p>de invocaci√≥n debe estar por encima de la invocada siempre que sea posible.</p>
<p>De este modo el programa fluye con normalidad. Si la convenci√≥n se sigue de</p>
<p>forma fiable, los lectores sabr√°n que las definiciones de funci√≥n aparecen</p>
<p>despu√©s de su uso. F√≠jese en el fragmento de FitNesse del Listado 5-5.</p>
<p>La funci√≥n superior invoca las situadas por debajo que, a su vez, invocan</p>
<p>a las siguientes. Esto facilita la detecci√≥n de las funciones invocadas y mejora</p>
<p>considerablemente la legibilidad del m√≥dulo completo.</p>
<p>Listado 5-5</p>
<p>WikiPageResponder.java.</p>
<p>public class WikiPageResponder implements SecureResponder {</p>
<p>protected WikiPage page;</p>
<p>protected PageData pageData;</p>
<p>protected String pageTitle;</p>
<p>protected Request request;</p>
<p>protected PageCrawler crawler;</p>
<p>public Response makeResponse(FitNesseContext context, Request request)</p>
<p>throws Exception {</p>
<p>String pageName = getPageNameOrDefault(request, ‚ÄúFrontpage‚Äù);</p>
<p>LoadPage(pageName, context);</p>
<p>if (page == null)</p>
<p>return notFoundResponse(context, request);</p>
<p>else</p>
<p>return makePageResponse(context);</p>
<p>private String getPageNameOrDefault(Request request, String</p>
<p>defaultPageName)</p>
<p>String pageName = request.getResource();</p>
<p>if (StringUtil.isBlank(pageName))</p>
<p>pageName = defaultPageName;</p>
<p>return pageName;</p>
<p>protected void loadPage(String resource, FitNesseContext context)</p>
<p>throws Exception {</p>
<p>WikiPagePath path = PathParser.parse(resource);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>crawler = context.root.getPageCrawler();</p>
<p>crawler.setDeadEndStrategy(new VirtualEnabledPageCrawler());</p>
<p>page = crawler.getPage(context.root, path);</p>
<p>if (page != null)</p>
<p>pageData = page.getData();</p>
<p>private Response notFoundResponse(FitNesseContext context, Request</p>
<p>request)</p>
<p>throws Exception {</p>
<p>return new NotFoundResponder().makeResponse(context, request);</p>
<p>private SimpleResponse makePageResponse(FitNesseContext context)</p>
<p>throws Exception {</p>
<p>pageTitle = PathParser.render(crawler.getFullPath(page));</p>
<p>String html = makeHtml(context);</p>
<p>SimpleResponse response = new SimpleResponse();</p>
<p>response.setMaxAge(0);</p>
<p>response.setContent(html);</p>
<p>return response;</p>
<p>...</p>
<p>Adem√°s, este fragmento es un buen ejemplo de ubicaci√≥n de constantes</p>
<p>en un nivel correcto [G35]. La constante FrontPage se podr√≠a haber ocultado</p>
<p>en la funci√≥n getPageNameOrDefault , pero eso habr√≠a ocultado una constante</p>
<p>conocida y esperada en una funci√≥n de nivel inferior de forma incorrecta. Es</p>
<p>mejor pasar la constante desde un punto en el que tiene sentido a la posici√≥n</p>
<p>en la que realmente se usa.</p>
<p>Afinidad conceptual</p>
<p>Determinados conceptos de c√≥digo deben estar pr√≥ximos a otros. Tienen una</p>
<p>afinidad conceptual concreta. Cuanto mayor sea esta afinidad, menor</p>
<p>distancia vertical debe existir entre ellos.</p>
<p>Como hemos visto, esta afinidad se puede basar en una dependencia</p>
<p>directa, como cuando una funci√≥n invoca a otra, o cuando usa una variable.</p>
<p>Pero hay otras causas de afinidad. Puede generarse porque un grupo de</p>
<p>funciones realice una operaci√≥n similar. F√≠jese en este fragmento de c√≥digo</p>
<p>de Junit 4.3.1:</p>
<p>public class Assert {</p>
<p>static public void assertTrue(String message, boolean condition) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if (!condition)</p>
<p>fail(message);</p>
<p>static public void assertTrue(boolean</p>
<p>condition) {</p>
<p>assertTrue (null, condition);</p>
<p>static public void assertFalse(String</p>
<p>message, boolean condition) {</p>
<p>assertTrue(message, !condition);</p>
<p>static public void assertFalse(boolean</p>
<p>condition) {</p>
<p>assertFalse(null, condition);</p>
<p>...</p>
<p>Estas funciones tienen una elevada afinidad conceptual ya que comparten</p>
<p>un sistema de nombres com√∫n y realizan variantes de la misma tarea b√°sica.</p>
<p>El hecho de que se invoquen unas a otras es secundario. Aunque no lo</p>
<p>hicieran, deber√≠an seguir estando pr√≥ximas entre ellas.</p>
<h3 id="orden-vertical-114">Orden vertical</h3>
<p>Por lo general, las dependencias de invocaciones de funciones deben apuntar</p>
<p>hacia abajo. Es decir, la funci√≥n invocada debe situarse por debajo de la que</p>
<p>[27]</p>
<p>realice la invocaci√≥n . Esto genera un agradable flujo en el c√≥digo fuente,</p>
<p>de los niveles superiores a los inferiores.</p>
<p>Como sucede en los art√≠culos del peri√≥dico, esperamos que los conceptos</p>
<p>m√°s importantes aparezcan antes y que se expresen con la menor cantidad de</p>
<p>detalles sobrantes. Esperamos que los detalles de nivel inferior sean los</p>
<p>√∫ltimos. De este modo, podemos ojear los archivos de c√≥digo y captar el</p>
<p>mensaje en las primeras funciones sin necesidad de sumergirnos en los</p>
<p>detalles. El Listado 5-5 se organiza de esta forma. Puede que otros ejemplos</p>
<p>mejores sean los listados 15-5 y 3-7.</p>
<h3 id="formato-horizontal-115">Formato horizontal</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>¬øQu√© ancho debe tener una l√≠nea? Para responderlo, f√≠jese en la anchura de</p>
<p>las l√≠neas de un programa convencional. De nuevo, examinamos siete</p>
<p>proyectos diferentes. En la figura 5.2 puede ver la distribuci√≥n de longitud de</p>
<p>todos ellos. La regularidad es impresionante, en especial en tomo a los 45</p>
<p>caracteres. De hecho, los tama√±os entre 20 y 60 representan un uno por cien</p>
<p>del n√∫mero total de l√≠neas. ¬°Eso es un 40 por 100! Puede que otro 30 por 100</p>
<p>sea menos de 10 caracteres de ancho. Recuerde que es una escala de registro,</p>
<p>de modo que la apariencia lineal es muy significativa. Es evidente que los</p>
<p>programadores prefieren l√≠neas menos anchas.</p>
<p>Figura 5.2. Distribuci√≥n de anchura de l√≠neas en Java.</p>
<p>Esto sugiere que debemos intentar reducir las l√≠neas de c√≥digo. El antiguo</p>
<p>l√≠mite Hollerith de 80 es un tanto arbitrario y no me opongo a l√≠neas que</p>
<p>tienen 100 o incluso 120, pero no m√°s.</p>
<p>Como norma, no debe tener que desplazarse hacia la derecha. Los</p>
<p>monitores modernos son m√°s anchos y los programadores noveles pueden</p>
<p>reducir la fuente para encajar hasta 200 caracteres en la pantalla. No lo haga.</p>
<p>Mi l√≠mite personal es de 120.</p>
<h3 id="apertura-y-densidad-horizontal-116">Apertura y densidad horizontal</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Usamos el espacio en blanco horizontal para asociar elementos directamente</p>
<p>relacionados y separar otros con una relaci√≥n menos estrecha. F√≠jese en la</p>
<p>siguiente funci√≥n:</p>
<p>private void measureLine(String line) {</p>
<p>lineCount++;</p>
<p>int lineSize = line.length();</p>
<p>totalChars += lineSize;</p>
<p>lineWidthHistogram.addLine(lineSize, lineCount);</p>
<p>recordWidestLine(lineSize);</p>
<p>Hemos rodeado los operadores de asignaci√≥n con espacios en blanco para</p>
<p>destacarlos. Las instrucciones de asignaci√≥n tienen dos elementos principales:</p>
<p>el lado izquierdo y el derecho. Los espacios acent√∫an esta separaci√≥n.</p>
<p>Por otra parte, no hemos incluido espacios entre los nombres de las</p>
<p>funciones y el par√©ntesis de apertura, ya que la funci√≥n y sus argumentos</p>
<p>est√°n estrechamente relacionados. Su separaci√≥n los desconectar√≠a. Separo los</p>
<p>argumentos en los par√©ntesis de invocaci√≥n de la funci√≥n para acentuar la</p>
<p>coma e indicar que los argumentos son independientes. El espacio en blanco</p>
<p>tambi√©n se usa para acentuar la precedencia de los operadores:</p>
<p>public class Quadratic {</p>
<p>public static double root1(double a, double b, double c) {</p>
<p>double determinant = determinant(a, b, c);</p>
<p>return (-b + Math.sqrt(determinant)) / (2*a);</p>
<p>public static double root2(int a, int b, int c) {</p>
<p>double determinant = determinant(a, b, c);</p>
<p>return (-b - Math.sqrt(determinant)) / (2*a);</p>
<p>private static double determinant(double a, double b, double c) {</p>
<p>return b*b - 4*a*c;</p>
<p>F√≠jese en lo bien que se leen las ecuaciones. Los factores carecen de</p>
<p>espacios en blanco ya que tienen una mayor precedencia. Los t√©rminos se</p>
<p>separan mediante espacios en blanco ya que la suma y la resta son de</p>
<p>precedencia inferior.</p>
<p>Desafortunadamente, muchas herramientas de formato de c√≥digo ignoran</p>
<p>la precedencia de los operadores e imponen un espaciado uniforme. Por ello,</p>
<p>separaciones sutiles como las anteriores suelen perderse tras modificar el</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>formato del c√≥digo.</p>
<h3 id="alineacion-horizontal-117">Alineaci√≥n horizontal</h3>
<p>[28]</p>
<p>Cuando era programador de lenguajes de ensamblado , usaba la alineaci√≥n</p>
<p>horizontal para acentuar determinadas estructuras. Cuando comenc√©</p>
<p>programar en C, C++ y Java, segu√≠a intentando alinear los nombres de</p>
<p>variables en un conjunto de declaraciones o todos los valores en un grupo de</p>
<p>instrucciones de asignaci√≥n. El aspecto de mi c√≥digo era el siguiente:</p>
<p>public class FitNesseExpediter implements ResponseSender</p>
<p>private Socket socket;</p>
<p>private InputStream input;</p>
<p>private OutputStream output;</p>
<p>private Request request;</p>
<p>private Response response;</p>
<p>private FitNesseContext context;</p>
<p>protected long requestParsingTimeLimit;</p>
<p>private long requestProgress;</p>
<p>private long requestParsingDeadline;</p>
<p>private boolean hasError;</p>
<p>public FitNesseExpediter( Socket s,</p>
<p>FitNesseContext context) throws Exception</p>
<p>this.context = context;</p>
<p>socket = s;</p>
<p>input = s.getInputStream();</p>
<p>output = s.getOutputStream();</p>
<p>requestParsingTimeLimit = 10000;</p>
<p>Sin embargo, este tipo de alineaci√≥n no es √∫til. Parece enfatizar los</p>
<p>elementos incorrectos y aleja la vista de la verdadera intenci√≥n. Por ejemplo,</p>
<p>en la lista anterior de declaraciones, nos vemos tentados a leer la lista de</p>
<p>nombres de variables sin fijarnos en sus tipos. Del mismo modo, en la lista de</p>
<p>instrucciones de asignaci√≥n, nos fijamos en los valores sin ver el operador.</p>
<p>Para empeorarlo todo, las herramientas autom√°ticas de formato suelen</p>
<p>eliminar este tipo de alineaci√≥n. Por tanto, al final, ya no lo uso. Ahora</p>
<p>prefiero declaraciones asignaciones sin alinear, como se muestra</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>continuaci√≥n, ya que resaltan una deficiencia importante. Si tengo listas</p>
<p>extensas que deben alinearse, el problema es la longitud de las listas, no la</p>
<p>falta de alineaci√≥n. La longitud de la siguiente lista de declaraciones de</p>
<p>FitNesseExpediter sugiere que esta clase debe dividirse.</p>
<p>public class FitNesseExpediter implements ResponseSender</p>
<p>private Socket socket;</p>
<p>private InputStream input;</p>
<p>private OutputStream output;</p>
<p>private Request request;</p>
<p>private Response response;</p>
<p>private FitNesseContext context;</p>
<p>protected long requestParsingTimeLimit;</p>
<p>private long request Progress;</p>
<p>private long requestParsingDeadline;</p>
<p>private boolean hasError;</p>
<p>public FitNesseExpediter(Socket s, FitNesseContext context) throws</p>
<p>Exception</p>
<p>this.context = context;</p>
<p>socket = s;</p>
<p>input = s.getInputStream();</p>
<p>output = s.getOutputStream();</p>
<p>requestParsingTimeLimit = 10000;</p>
<h3 id="sangrado-118">Sangrado</h3>
<p>Un archivo de c√≥digo es una jerarqu√≠a m√°s que un contorno. Incluye</p>
<p>informaci√≥n que pertenece la totalidad del archivo, sus clases</p>
<p>individuales, a los m√©todos de las clases, a los bloques de los m√©todos y a los</p>
<p>bloques de los bloques. Cada nivel de esta jerarqu√≠a es un √°mbito en el que se</p>
<p>pueden declarar nombres en el que se interpretan declaraciones</p>
<p>instrucciones ejecutables.</p>
<p>Para que esta jerarqu√≠a de √°mbitos sea visible, sangramos las l√≠neas de</p>
<p>c√≥digo fuente de acuerdo a su posici√≥n en la jerarqu√≠a. Las instrucciones al</p>
<p>nivel del archivo, como las declaraciones de clases, no se sangran. Los</p>
<p>m√©todos de una clase se sangran un nivel a la derecha de la clase. Las</p>
<p>implementaciones de dichos m√©todos se implementan un nivel a la derecha</p>
<p>de la declaraci√≥n de los m√©todos. Las implementaciones de bloques se</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>implementan un nivel la derecha de su bloque contenedor as√≠</p>
<p>sucesivamente.</p>
<p>Los programadores dependen de este sistema de sangrado. Alinean</p>
<p>visualmente las l√≠neas a la izquierda para ver el √°mbito al que pertenece. De</p>
<p>este modo pueden acceder r√°pidamente a los √°mbitos, como por ejemplo a</p>
<p>implementaciones de instrucciones if while , que no son relevantes para la</p>
<p>situaci√≥n actual. Buscan en la izquierda nuevas declaraciones de m√©todos,</p>
<p>variables incluso clases. Sin el sangrado, los programas serian</p>
<p>pr√°cticamente ilegibles.</p>
<p>F√≠jese en los siguientes programas, sint√°ctica y sem√°nticamente id√©nticos:</p>
<p>public class FitNesseServer implements SocketServer { private FitNesseContext</p>
<p>context; public FitNesseServer(FitNesseContext context) { this.context =</p>
<p>context; } public void serve(Socket s) { serve(s, 10000); } public void</p>
<p>serve(Socket s, long requestTimeout) { try { FitNesseExpediter sender = new</p>
<p>FitNesseExpediter(s, context);</p>
<p>sender.setRequestParsingTimeLimit(requestTimeout); sender.start(); }</p>
<p>catch(Exception e) { e.printStackTrace(); } } }</p>
<p>public class FitNesseServer implements SocketServer {</p>
<p>private FitNesseContext context;</p>
<p>public FitNesseServer(FitNesseContext context) {</p>
<p>this.context = context;</p>
<p>public void serve(Socket s) {</p>
<p>serve (s, 10000);</p>
<p>public void serve(Socket s, long requestTimeout) {</p>
<p>try {</p>
<p>FitNesseExpediter sender = new FitNesseExpediter(s, context);</p>
<p>sender.setRequestParsingTimeLimit(requestTimeout);</p>
<p>sender.start();</p>
<p>catch (Exception e) {</p>
<p>e.printStackTrace();</p>
<p>A la vista puede incluso apreciar la estructura del archivo sangrado.</p>
<p>Detectamos inmediatamente las variables, constructores y m√©todos de acceso.</p>
<p>En cuesti√≥n de segundos vemos que es una especie de interfaz de conexi√≥n,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>con un tiempo de espera. La versi√≥n sin sangrar, por su parte, es</p>
<p>pr√°cticamente impenetrable.</p>
<p>Romper el sangrado</p>
<p>En ocasiones tenemos la tentaci√≥n de romper la regla de sangrado con</p>
<p>instrucciones if breves, bucles while breves o funciones breves. Siempre que</p>
<p>he sucumbido a esta tentaci√≥n, he acabado por volver a aplicar el sangrado.</p>
<p>Por ello, evito replegar √°mbitos a una l√≠nea, como en este ejemplo:</p>
<p>public class CommentWidget extends TextWidget</p>
<p>public static final String REGEXP = ‚Äú^#[^\r\n]*(?:(?:\r\n)|\n|\r)?‚Äù;</p>
<p>public CommentWidget(ParentWidget parent, String text){super (parent,</p>
<p>text);}</p>
<p>public String render() throws Exception { return ‚Äú‚Äù; }</p>
<p>Prefiero desplegar y sangrar los √°mbitos:</p>
<p>public class CommentWidget extends TextWidget {</p>
<p>public static final String REGEXP = ‚Äú^#[^\r\n]*(?:(?:\r\n)|\n|\r)?‚Äù;</p>
<p>public CommentWidget(ParentWidget parent, String text) {</p>
<p>super(parent, text);</p>
<p>public String render() throws Exception {</p>
<p>return ‚Äú‚Äù;</p>
<h3 id="ambitos-ficticios-119">√Åmbitos ficticios</h3>
<p>En ocasiones, el cuerpo de una instrucci√≥n while for es ficticio, como se</p>
<p>muestra a continuaci√≥n. No me gustan estas estructuras y prefiero evitarlas.</p>
<p>En caso de no poder hacerlo, me aseguro de sangrar el cuerpo ficticio y de</p>
<p>incluirlo entre par√©ntesis. No sabr√≠a decir cu√°ntas veces me ha enga√±ado un</p>
<p>punto y coma situado al final de un bucle while en la misma l√≠nea. A menos</p>
<p>que lo haga visible y lo sangre en una l√≠nea propia, es dif√≠cil de ver.</p>
<p>while (dis.read(buf, 0, readBufferSize) != -1)</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="reglas-de-equipo-120">Reglas de equipo</h3>
<p>Todo programador tiene sus reglas de</p>
<p>formato preferidas, pero si forma parte de</p>
<p>un equipo, el equipo manda.</p>
<p>Un equipo de programadores debe</p>
<p>acordar un √∫nico estilo de formato y todos</p>
<p>los integrantes del equipo deben aplicarlo.</p>
<p>El objetivo es que el software tenga un estilo coherente. No queremos que</p>
<p>parezca escrito por individuos enfrentados.</p>
<p>Cuando comenc√© el proyecto FitNesse en 2002, me reun√≠ con el equipo</p>
<p>para definir un estilo de c√≥digo. Tardamos 10 minutos. Decidimos d√≥nde</p>
<p>a√±adir las llaves, qu√© tama√±o de sangrado utilizar, los nombres de clases,</p>
<p>variables y m√©todos, y dem√°s. Tras ello, codificamos las reglas en el IDE y</p>
<p>las cumplimos desde entonces. No son las reglas que prefiero, son las que el</p>
<p>equipo decidi√≥. Y como miembro de ese equipo, las apliqu√© cuando creamos</p>
<p>el c√≥digo del proyecto FitNesse.</p>
<p>Recuerde que un buen sistema de software se compone de una serie de</p>
<p>documentos que se leen f√°cilmente. Deben tener un estilo coherente y</p>
<p>din√°mico. El lector debe confiar en que los formatos que ve en nuestro</p>
<p>archivo de c√≥digo significar√°n lo mismo para otros. Lo √∫ltimo que queremos</p>
<p>es aumentar la complejidad del c√≥digo creando una mezcla de estilos</p>
<p>diferentes.</p>
<h3 id="reglas-de-formato-de-uncle-bob-121">Reglas de formato de Uncle Bob</h3>
<p>Las reglas que uso personalmente son sencillas y se ilustran en el c√≥digo del</p>
<p>Listado 5-6. Consid√©relo un ejemplo de documento est√°ndar de c√≥digo</p>
<p>√≥ptimo.</p>
<p>Listado 5-6</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>CodeAnalyzer.java.</p>
<p>public class CodeAnalyzer implements JavaFileAnalysis {</p>
<p>private int lineCount;</p>
<p>private int maxLineWidth;</p>
<p>private int widestLineNumber;</p>
<p>private LineWidthHistogram lineWidthHistogram;</p>
<p>private int totalChars;</p>
<p>public CodeAnalyzer() {</p>
<p>lineWidthHistogram = new LineWidthHistogram();</p>
<p>public static List&lt;File&gt; findJavaFiles(File parentDirectory) {</p>
<p>List&lt;File&gt; files = new ArrayList&lt;File&gt;();</p>
<p>findJavaFiles(parentDirectory, files);</p>
<p>return files;</p>
<p>private static void findJavaFiles(File parentDirectory, List&lt;File&gt; files)</p>
<p>for (File file : parentDirectory.listFiles()) {</p>
<p>if (file.getName().endsWith(‚Äú.java‚Äù))</p>
<p>files.add(file);</p>
<p>else if (file.isDirectory())</p>
<p>findJavaFiles(file, files);</p>
<p>public void analyzeFile(File javaFile) throws Exception {</p>
<p>BufferedReader br = new BufferedReader(new FileReader(javaFile));</p>
<p>String line;</p>
<p>while ((line = br.readLine()) != null)</p>
<p>measureLine(line);</p>
<p>private void measureLine(String line) {</p>
<p>lineCount++;</p>
<p>int lineSize = line.length();</p>
<p>totalChars += lineSize;</p>
<p>lineWidthHistogram.addLine(lineSize, lineCount);</p>
<p>recordWidestLine(lineSize);</p>
<p>private void recordWidestLine(int lineSize) {</p>
<p>if (lineSize &gt; maxLineWidth) {</p>
<p>maxLineWidth = lineSize;</p>
<p>widestLineNumber = lineCount;</p>
<p>public int getLineCount() {</p>
<p>return lineCount;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public int getMaxLineWidth() {</p>
<p>return maxLineWidth;</p>
<p>public int getWidestLineNumber() {</p>
<p>return widestLineNumber;</p>
<p>public LineWidthHistogram getLineWidthHistogram() {</p>
<p>return lineWidthHistogram;</p>
<p>public double getMeanLineWidth() {</p>
<p>return (double)totalChars/lineCount;</p>
<p>public int getMedianLineWidth() {</p>
<p>Integer[] sortedwidths = getSortedWidths();</p>
<p>int cumulativeLineCount = 0;</p>
<p>for (int width : sortedwidths) {</p>
<p>cumulativeLineCount += lineCountForWidth(width);</p>
<p>if (cumulativeLineCount &gt; lineCount/2)</p>
<p>return width;</p>
<p>throw new Error (‚ÄúCannot get here‚Äù);</p>
<p>private int lineCountForWidth(int width) {</p>
<p>return lineWidthHistogram.getLinesforWidth(width).size();</p>
<p>private Integer[] getSortedWidths() {</p>
<p>Set&lt;Integer&gt; widths = lineWidthHistogram.getWidths();</p>
<p>Integer[] sortedwidths = (widths.toArray(new Integer[0]));</p>
<p>Arrays.sort(sortedwidths);</p>
<p>return sortedwidths;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="objetos-y-estructuras-de-datos-122">Objetos y estructuras de datos</h1>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Hay una raz√≥n para que las variables sean privadas. No queremos que nadie</p>
<p>m√°s dependa de ellas. Queremos poder cambiar su tipo o implementaci√≥n</p>
<p>cuando deseemos. Entonces, ¬øpor qu√© tantos programadores a√±aden</p>
<p>autom√°ticamente m√©todos de establecimiento y recuperaci√≥n que muestran</p>
<p>sus variables privadas como si fueran p√∫blicas?</p>
<h3 id="abstraccion-de-datos-123">Abstracci√≥n de datos</h3>
<p>F√≠jese en la diferencia entre los listados 6-1 y 6-2. Ambos representan los</p>
<p>datos de un punto cartesiano, pero uno muestra su implementaci√≥n y otro la</p>
<p>oculta totalmente.</p>
<p>Listado 6-1</p>
<p>Punto concreto.</p>
<p>public class Point {</p>
<p>public double x;</p>
<p>public double y;</p>
<p>Listado 6-2</p>
<p>Punto abstracto.</p>
<p>public interface Point {</p>
<p>double getX();</p>
<p>double getY();</p>
<p>void setCartesian(double x, double y);</p>
<p>double getR();</p>
<p>double getTheta();</p>
<p>void set Polar(double r, double theta);</p>
<p>Lo mejor del Listado 6-2 es que no hay forma de saber si la</p>
<p>implementaci√≥n est√° en coordenadas rectangulares o polares. ¬°Puede que en</p>
<p>ninguna! Y aun as√≠ la interfaz representa sin lugar a dudas una estructura de</p>
<p>datos.</p>
<p>Pero representa algo m√°s que una estructura de datos. Los m√©todos</p>
<p>refuerzan una pol√≠tica de acceso. Puede leer las coordenadas de forma</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>independiente, pero debe establecerlas de forma conjunta como operaci√≥n</p>
<p>at√≥mica.</p>
<p>El Listado 6-1, por su parte, se implementa claramente en coordenadas</p>
<p>rectangulares y nos obliga a manipularlas de forma independiente, lo que</p>
<p>muestra la implementaci√≥n. De hecho, la mostrar√≠a igualmente, aunque las</p>
<p>variables fueran privadas y us√°ramos m√©todos variables de establecimiento y</p>
<p>recuperaci√≥n. Para ocultar la implementaci√≥n no basta con a√±adir una capa de</p>
<p>funciones entre las variables. Se basa en la abstracci√≥n. Una clase no fuerza</p>
<p>sus variables a trav√©s de m√©todos de establecimiento y recuperaci√≥n. Por el</p>
<p>contrario, muestra interfaces abstractas que permiten a sus usuarios manipular</p>
<p>la esencia de los datos sin necesidad de conocer su implementaci√≥n.</p>
<p>F√≠jese en los listados 6-3 y 6-4. El primero usa t√©rminos concretos para</p>
<p>indicar el nivel de combustible de un veh√≠culo mientras que el segundo lo</p>
<p>hace con la abstracci√≥n del porcentaje. En el caso concreto, podemos estar</p>
<p>seguros de que se trata de m√©todos de acceso de variables. En el caso</p>
<p>abstracto, desconocemos la forma de los datos.</p>
<p>Listado 6-3</p>
<p>Veh√≠culo concreto.</p>
<p>public interface Vehicle {</p>
<p>double getFuelTankCapacityInGallons();</p>
<p>double getGallonsOfGasoline();</p>
<p>Listado 6-4</p>
<p>Veh√≠culo abstracto.</p>
<p>public interface Vehicle {</p>
<p>double getPercentFuelRemaining();</p>
<p>En ambos casos, la segunda opci√≥n es preferible. No queremos mostrar</p>
<p>los detalles de los datos, sino expresarlos en t√©rminos abstractos. Esto no se</p>
<p>consigue simplemente mediante interfaces o m√©todos de establecimiento y</p>
<p>recuperaci√≥n. Hay que meditar seriamente la forma √≥ptima de representar los</p>
<p>datos que contiene un objeto. La peor opci√≥n es a√±adir m√©todos de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>establecimiento y recuperaci√≥n a ciegas.</p>
<h3 id="antisimetria-de-datos-y-objetos-124">Antisimetr√≠a de datos y objetos</h3>
<p>Estos dos ejemplos ilustran la diferencia entre objetos y estructuras de datos.</p>
<p>Los objetos ocultan sus datos tras abstracciones y muestran funciones que</p>
<p>operan en dichos datos. La estructura de datos muestra sus datos y carece de</p>
<p>funciones con significado. Vuelva leerlos. F√≠jese en la naturaleza</p>
<p>complementaria de las dos definiciones. Son virtualmente opuestas. Puede</p>
<p>parecer una diferencia menor, pero tiene importantes implicaciones.</p>
<p>F√≠jese en el ejemplo del Listado 6-5. La clase Geometry opera en las tres</p>
<p>clases de formas, que son sencillas estructuras de datos sin comportamiento.</p>
<p>Todo el comportamiento se encuentra en la clase Geometry.</p>
<p>Listado 6-5</p>
<p>Forma mediante procedimientos.</p>
<p>public class Square {</p>
<p>public Point topLeft;</p>
<p>public double side;</p>
<p>public class Rectangle {</p>
<p>public Point topLeft;</p>
<p>public double height;</p>
<p>public double width;</p>
<p>public class Circle {</p>
<p>public Point center;</p>
<p>public double radius;</p>
<p>public class Geometry {</p>
<p>public final double PI = 3.141592653589793;</p>
<p>public double area(Object shape) throws NoSuchShapeException</p>
<p>if (shape instanceof Square) {</p>
<p>Square s = (Square)shape;</p>
<p>return s.side * s.side;</p>
<p>else if (shape instanceof Rectangle) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Rectangle r = (Rectangle)shape;</p>
<p>return r.height * r.width;</p>
<p>else if (shape instanceof Circle) {</p>
<p>Circle c = (Circle)shape;</p>
<p>return PI * c.radius * c.radius;</p>
<p>throw new NoSuchShapeException();</p>
<p>Los programadores orientados a objetos se quejar√°n de que es un ejemplo</p>
<p>de procedimiento, y tienen raz√≥n. Imagine qu√© pasar√≠a si a√±adimos la funci√≥n</p>
<p>perimeter() Geometry . ¬°Las clases de formas no se ver√≠an afectadas! ¬°Y</p>
<p>las dem√°s clases que dependieran de las formas tampoco! Por otra parte, si</p>
<p>a√±ado una nueva forma, tendr√≠a que cambiar todas las funciones de Geometry</p>
<p>Vu√©lvalo a leer. Comprobar√° que las dos condiciones son diametralmente</p>
<p>opuestas.</p>
<p>F√≠jese ahora en la soluci√≥n orientada a objetos del Listado 6-6. Aqu√≠, el</p>
<p>m√©todo area() es polim√≥rfico. No se necesita una clase Geometry . Por tanto,</p>
<p>si a√±ado una nueva forma, ninguna de las funciones existentes se ven</p>
<p>[29]</p>
<p>afectadas, pero si a√±ado otra funci√≥n, habr√° que cambiar todas las formas</p>
<p>Listado 6-6</p>
<p>Formas polim√≥rficas.</p>
<p>public class Square implements Shape {</p>
<p>private Point topLeft;</p>
<p>private double side;</p>
<p>public double area() {</p>
<p>return side*side;</p>
<p>public class Rectangle implements Shape {</p>
<p>private Point topLeft;</p>
<p>private double height;</p>
<p>private double width;</p>
<p>public double area() {</p>
<p>return height * width;</p>
<p>public class Circle implements Shape {</p>
<p>private Point center;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private double radius;</p>
<p>public final double PI = 3.141592653589793;</p>
<p>public double area() {</p>
<p>return PI * radius * radius;</p>
<p>De nuevo, vemos la naturaleza complementaria de estas dos definiciones;</p>
<p>totalmente contrarias. Esto ilustra la dicotom√≠a fundamental entre objetos y</p>
<p>estructuras de datos:</p>
<p>El c√≥digo por procedimientos (el que usa estructuras de datos)</p>
<p>facilita la inclusi√≥n de nuevas funciones sin modificar las estructuras</p>
<p>de datos existentes. El c√≥digo orientado a objetos, por su parte,</p>
<p>facilita la inclusi√≥n de nuevas clases sin cambiar las funciones</p>
<p>existentes.</p>
<p>El complemento tambi√©n es cierto:</p>
<p>El c√≥digo por procedimientos dificulta la inclusi√≥n de nuevas</p>
<p>estructuras de datos ya que es necesario cambiar todas las funciones.</p>
<p>El c√≥digo orientado objetos dificulta la inclusi√≥n de nuevas</p>
<p>funciones ya que es necesario cambiar todas las clases.</p>
<p>Por tanto, lo que es dif√≠cil para la programaci√≥n orientada a objetos es</p>
<p>f√°cil para los procedimientos, y viceversa.</p>
<p>En cualquier sistema complejo habr√° ocasiones en las que queramos</p>
<p>a√±adir nuevos tipos de datos en lugar de nuevas funciones. En dichos casos,</p>
<p>los objetos y la programaci√≥n orientada a objetos es lo m√°s adecuado. Por</p>
<p>otra parte, en ocasiones tendremos que a√±adir nuevas funciones en lugar de</p>
<p>tipos de datos, para lo que resulta m√°s adecuado usar c√≥digo por</p>
<p>procedimientos y estructuras de datos.</p>
<p>Los programadores experimentados saben que la idea de que todo es un</p>
<p>objeto es un mito. En ocasiones solamente queremos sencillas estructuras de</p>
<p>datos con procedimientos que operen en las mismas.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="la-ley-de-demeter-125">La ley de Demeter</h3>
<p>[30]</p>
<p>Existe una conocida heur√≠stica denominada Ley de Demeter que afirma</p>
<p>que un m√≥dulo no debe conocer los entresijos de los objetos que manipula.</p>
<p>Como vimos en el apartado anterior, los objetos ocultan sus datos y muestran</p>
<p>operaciones, lo que significa que un objeto no debe mostrar su estructura</p>
<p>interna a trav√©s de m√©todos de acceso ya que, si lo hace, mostrar√≠a, no</p>
<p>ocultar√≠a, su estructura interna.</p>
<p>En concreto, la ley de Demeter afirma que un m√©todo de una clase s√≥lo</p>
<p>debe invocar los m√©todos de:</p>
<p>Un objeto creado por</p>
<p>Un objeto pasado como argumento a</p>
<p>Un objeto en una variable de instancia de</p>
<p>El m√©todo no debe invocar m√©todos de objetos devueltos por ninguna de</p>
<p>las funciones permitidas. Es decir, no hable con desconocidos, s√≥lo con</p>
<p>amigos.</p>
<p>[31]</p>
<p>El siguiente c√≥digo parece incumplir la Ley de Demeter (entre otras</p>
<p>cosas) ya que invoca la funci√≥n getScratchDir() en el valor devuelto de</p>
<p>getOptions() y despu√©s invoca getAbsolutePath() en el valor devuelto de</p>
<p>getScratchDir()</p>
<p>final String outputDir = ctxt.getOptions().getScratchDir().getAbsolutePath();</p>
<h3 id="choque-de-trenes-126">Choque de trenes</h3>
<p>Ese tipo de c√≥digo suele denominarse choque de trenes ya que se asemeja a</p>
<p>un grupo de vagones de tren. Estas cadenas de invocaciones suelen</p>
<p>considerarse un estilo descuidado y deben evitarse [G36]. Conviene dividirlas</p>
<p>de esta forma:</p>
<p>Options opts = ctxt.getOptions();</p>
<p>File scratchDir = opts.getScratchDir();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>final String outputDir = scratchDir.getAbsolutePath();</p>
<p>¬øIncumplen estos dos fragmentos de</p>
<p>c√≥digo la Ley de Demeter? Sin duda el</p>
<p>m√≥dulo contenedor sabe que el objeto ctxt</p>
<p>contiene opciones, que contienen un</p>
<p>directorio scratch que tiene una ruta</p>
<p>absoluta. La funci√≥n sabe demasiado. La funci√≥n que realiza la invocaci√≥n</p>
<p>sabe c√≥mo desplazarse por numerosos objetos diferentes.</p>
<p>Si incumple o no la Ley de Demeter depende de si ctxt Options</p>
<p>ScratchDir son objetos o estructuras de datos. Si son objetos, deber√≠a</p>
<p>ocultarse su estructura interna, no mostrarse, y conocer sus detalles internos</p>
<p>ser√≠a un claro incumplimiento de la Ley de Demeter. Por otra parte, si ctxt</p>
<p>Options ScratchDir son simples estructuras de datos, mostrar√°n su</p>
<p>estructura interna con naturalidad y la Ley de Demeter no se aplica.</p>
<p>El uso de funciones de acceso complica el problema. Si el c√≥digo se</p>
<p>hubiera escrito de esta otra forma, probablemente no nos preocupar√≠amos de</p>
<p>si se incumple la Ley de Demeter o no.</p>
<p>final String outputDir = ctxt.options.ScratchDir.absolutePath;</p>
<p>El problema ser√≠a menos confuso si las estructuras de datos tuvieran</p>
<p>variables p√∫blicas y no funciones, y los objetos tuvieran variables privadas y</p>
<p>funciones p√∫blicas. Sin embargo, existen estructuras y est√°ndares (como los</p>
<p>bean ) que exigen que incluso una sencilla estructura de datos tenga elementos</p>
<p>de acceso y mutaci√≥n.</p>
<h3 id="hibridos-127">H√≠bridos</h3>
<p>Esta confusi√≥n genera ocasionalmente desafortunadas estructuras h√≠bridas</p>
<p>mitad objeto y mitad estructura de datos. Tienen funciones que realizan tareas</p>
<p>significativas y tambi√©n variables p√∫blicas o m√©todo p√∫blicos de acceso y</p>
<p>mutaci√≥n que hacen que las variables privadas sean p√∫blicas, y tientan a otras</p>
<p>funciones externas a usar dichas variables de la misma forma que un</p>
<p>[32]</p>
<p>programa por procedimientos usar√≠a una estructura de datos Estos</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>h√≠bridos dificultan la inclusi√≥n de nuevas funciones y tambi√©n de nuevas</p>
<p>estructuras de datos. Son lo peor de ambos mundos. Ev√≠telos. Indican un</p>
<p>dise√±o descuidado cuyos autores dudan, o peor todav√≠a, desconocen, si</p>
<p>necesitan protegerse de funciones o tipos.</p>
<h3 id="ocultar-la-estructura-128">Ocultar la estructura</h3>
<p>¬øQu√© pasar√≠a si ctxt options scratchDir fueran objetos con un</p>
<p>comportamiento real? Como los objetos deben ocultar su estructura interna,</p>
<p>no podr√≠amos desplazarnos por los mismos. Entonces, ¬øc√≥mo obtendr√≠amos</p>
<p>la ruta absoluta del directorio scratch</p>
<p>ctxt.getAbsolutePathOfScratchDirectoryOption();</p>
<p>ctxt.getScratchDirectoryOption().getAbsolutePath()</p>
<p>La primera opci√≥n provocar√≠a una explosi√≥n de m√©todos en el objeto</p>
<p>ctxt . La segunda asume que getScratchDirectoryOption() devuelve una</p>
<p>estructura de datos, no un objeto. Ninguna de las opciones parece correcta. Si</p>
<p>ctxt es un objeto, deber√≠amos indicarle que hiciera algo, no preguntar sobre</p>
<p>sus detalles internos. Entonces, ¬øpara qu√© queremos la ruta absoluta del</p>
<p>directorio scratch ? ¬øC√≥mo vamos a usarla? F√≠jese en este c√≥digo del mismo</p>
<p>m√≥dulo (muchas l√≠neas despu√©s):</p>
<p>String outFile = outputDir + ‚Äú/‚Äù + className.replace(‚Äò.‚Äô, ‚Äò/‚Äô) + ‚Äú.class‚Äù;</p>
<p>FileOutputStream fout = new FileOutputStream(outFile);</p>
<p>BufferedOutputStream bos = new BufferedOutputStream(fout);</p>
<p>La mezcla de distintos niveles de detalle [G34][G6] es preocupante.</p>
<p>Puntos, guiones, extensiones de archivo y objetos File no deben mezclarse</p>
<p>de esta forma, junto al c√≥digo contenedor. Si lo ignoramos, vemos que la</p>
<p>intenci√≥n de obtener la ruta absoluta del directorio scratch es crear un</p>
<p>archivo de borrador de un nombre concreto.</p>
<p>¬øY si le dij√©ramos al objeto ctxt que hiciera esto?</p>
<p>BufferedOutputStream bos = ctxt.createScratchFileStream(classFileName);</p>
<p>Parece algo razonable para un objeto. Permite a ctxt ocultar sus detalles</p>
<p>internos e impide que la funci√≥n actual incumpla la Ley de Demeter y se</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>desplace por objetos que no deber√≠a conocer.</p>
<h3 id="objetos-de-transferencia-de-datos-129">Objetos de transferencia de datos</h3>
<p>La quintaesencia de una estructura de datos es una clase con variables</p>
<p>p√∫blicas y sin funciones. En ocasiones se denomina Objeto de transferencia</p>
<p>de datos ( Data Transfer Object u OTD). Los OTD son estructuras muy √∫tiles,</p>
<p>en especial para comunicarse con bases de datos o analizar mensajes de</p>
<p>conexiones, etc. Suelen ser los primeros de una serie de fases de traducci√≥n</p>
<p>que convierten datos sin procesar en objetos en el c√≥digo de la aplicaci√≥n.</p>
<p>M√°s com√∫n es la forma de bean mostrada en el Listado 6-7. Los bean tienen</p>
<p>variables privadas manipuladas por m√©todos de establecimiento</p>
<p>recuperaci√≥n. La cuasi-Encapsulaci√≥n de bean hace que algunos puristas de la</p>
<p>programaci√≥n orientada a objetos se sientan mejor pero no ofrece ning√∫n otro</p>
<p>beneficio.</p>
<p>Listado 6-7</p>
<p>address.java</p>
<p>public class Address {</p>
<p>private String street;</p>
<p>private String streetExtra;</p>
<p>private String city;</p>
<p>private String state;</p>
<p>private String zip;</p>
<p>public Address(String Street, String streetExtra,</p>
<p>String city, String state, String zip) {</p>
<p>this.street = street;</p>
<p>this.streetExtra = streetExtra;</p>
<p>this.city = city;</p>
<p>this.state = state;</p>
<p>this.zip = zip;</p>
<p>public String getStreet() {</p>
<p>return street;</p>
<p>public String getStreetExtra() {</p>
<p>return streetExtra;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public String getCity() {</p>
<p>return city;</p>
<p>public String getState() {</p>
<p>return getState;</p>
<p>public String getZip() {</p>
<p>return zip;</p>
<h3 id="registro-activo-130">Registro activo</h3>
<p>Los registros activos son una forma especial de OTD. Son estructuras de</p>
<p>datos con variables p√∫blicas (o de acceso por bean) pero suelen tener</p>
<p>m√©todos de navegaci√≥n como save find . Por lo general, estos registros</p>
<p>activos son traducciones directas de tablas de base de datos u otros or√≠genes</p>
<p>de datos. Desafortunadamente, muchos programadores intentan procesar</p>
<p>estas estructuras de datos como si fueran objetos y les a√±aden m√©todos de</p>
<p>reglas empresariales. Es algo extra√±o ya que crea un h√≠brido entre una</p>
<p>estructura de datos y un objeto.</p>
<p>La soluci√≥n, evidentemente, consiste en considerar al registro activo una</p>
<p>estructura de datos y crear objetos independientes que contengan las reglas</p>
<p>empresariales y que oculten sus datos internos (que probablemente sean</p>
<p>instancias del propio registro activo).</p>
<h3 id="conclusion-131">Conclusi√≥n</h3>
<p>Los objetos muestran comportamiento ocultan datos. Esto facilita la</p>
<p>inclusi√≥n de nuevos tipos de objetos sin necesidad de cambiar los</p>
<p>comportamientos existentes. Tambi√©n dificulta la inclusi√≥n de nuevos</p>
<p>comportamientos en objetos existentes. Las estructuras de datos muestran</p>
<p>datos y carecen de comportamiento significativo. Esto facilita la inclusi√≥n de</p>
<p>nuevos comportamientos en las estructuras de datos existentes, pero dificulta</p>
<p>la inclusi√≥n de nuevas estructuras de datos en funciones existentes.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>En un sistema, en ocasiones necesitaremos la flexibilidad de a√±adir</p>
<p>nuevos tipos de datos, por lo que preferimos objetos para esa parte del</p>
<p>sistema. En otros casos, querremos a√±adir nuevos comportamientos, para lo</p>
<p>que preferimos tipos de datos y procedimientos en esa parte del sistema. Los</p>
<p>buenos programadores de software entienden estos problemas sin prejuicios y</p>
<p>eligen el enfoque m√°s adecuado para cada tarea concreta.</p>
<h3 id="bibliografia-132">Bibliograf√≠a</h3>
<p>[Refactoring] Refactoring: Improving the Design of Existing Code</p>
<p>Martin Fowler et al., Addison-Wesley, 1999.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="procesar-errores-133">Procesar errores</h1>
<p>por Michael Feathers</p>
<p>Le parecer√° extra√±o encontrar una secci√≥n de control de errores en un libro</p>
<p>sobre c√≥digo limpio. El control de errores es algo que todos tenemos que</p>
<p>hacer al programar. Las entradas pueden ser incorrectas y los dispositivos</p>
<p>pueden fallar, y cuando lo hacen, los programadores somos responsables de</p>
<p>comprobar que el c√≥digo hace lo que debe hacer.</p>
<p>No obstante, la conexi√≥n con el c√≥digo limpio debe ser evidente. Muchas</p>
<p>bases de c√≥digo est√°n totalmente dominadas por el control de errores. Cuando</p>
<p>digo que est√°n dominadas, no quiero decir que √∫nicamente realicen control de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>c√≥digo, sino que es pr√°cticamente imposible ver lo que el c√≥digo hace debido</p>
<p>a todo ese control de errores. El control de errores es importante, pero si</p>
<p>oscurece la l√≥gica, es incorrecto</p>
<p>En este cap√≠tulo detallaremos diversas t√©cnicas y consideraciones que</p>
<p>puede usar para crear c√≥digo limpio y robusto, c√≥digo que procese los errores</p>
<p>con elegancia y estilo.</p>
<h3 id="usar-excepciones-en-lugar-de-codigos-devueltos-134">Usar excepciones en lugar de c√≥digos devueltos</h3>
<p>En el pasado, muchos lenguajes carec√≠an de excepciones. Las t√©cnicas para</p>
<p>procesar e informar de errores eran limitadas. Se defin√≠a un indicador de error</p>
<p>o se devolv√≠a un c√≥digo de error que el invocador pod√≠a comprobar. El</p>
<p>c√≥digo del Listado 7-1 ilustra estos enfoques.</p>
<p>Listado 7-1</p>
<p>DeviceController.java.</p>
<p>public class DeviceController {</p>
<p>...</p>
<p>public void sendShutDown() {</p>
<p>DeviceHandle handle = getHandle(DEV1);</p>
<p>// Comprobar el estado del dispositivo</p>
<p>if (handle != DeviceHandle.INVALID) {</p>
<p>// Guardar el estado del dispositivo en el campo de registro</p>
<p>retrieveDeviceRecord(handle);</p>
<p>// Si no est√° suspendido, cerrarlo</p>
<p>if { record.getStatus() != DEVICE_SUSPENDED) {</p>
<p>pauseDevice(handle);</p>
<p>clearDeviceWorkQueue(handle);</p>
<p>closeDevice(handle);</p>
<p>} else {</p>
<p>logger.log(‚ÄúDevice suspended. Unable to shut down‚Äù);</p>
<p>} else {</p>
<p>logger.log(‚ÄúInvalid handle for: ‚Äù + DEV1.toString());</p>
<p>...</p>
<p>El problema de estos enfoques es que confunden al invocador. El</p>
<p>invocador debe comprobar inmediatamente los errores despu√©s de la</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>invocaci√≥n. Desafortunadamente, es algo que se suele olvidar. Por ello, es</p>
<p>m√°s recomendable generar una excepci√≥n al detectar un error. El c√≥digo de</p>
<p>invocaci√≥n es m√°s limpio. Su l√≥gica no se oscurece por el control de errores.</p>
<p>El Listado 7-2 muestra el c√≥digo tras generar una excepci√≥n en los</p>
<p>m√©todos que pueden detectar errores.</p>
<p>Listado 7-2</p>
<p>DeviceController.java (con excepciones).</p>
<p>public class DeviceController {</p>
<p>...</p>
<p>public void sendShutDown() {</p>
<p>try {</p>
<p>tryToShutDown();</p>
<p>} catch (DeviceShutDownError e) {</p>
<p>logger.log(e);</p>
<p>private void tryToShutDown() throws DeviceShutDownError {</p>
<p>DeviceHandle handle = getHandle(DEV1);</p>
<p>DeviceRecord record = retrieveDeviceRecord(handle);</p>
<p>pauseDevice(handle);</p>
<p>clearDeviceWorkQueue(handle);</p>
<p>closeDevice(handle);</p>
<p>private DeviceHandle getHandle(DeviceID id) {</p>
<p>...</p>
<p>throw new DeviceShutDownError(‚ÄúInvalid handle for: ‚Äù - id.toString());</p>
<p>...</p>
<p>...</p>
<p>Comprobar√° que es mucho m√°s limpio. No es cuesti√≥n de est√©tica. El</p>
<p>c√≥digo es mejor porque se solventan dos preocupaciones: el algoritmo para</p>
<p>apagar el dispositivo y el control de errores ahora se encuentran separados.</p>
<p>Puede ver cada uno de ellos y entenderlos de forma independiente.</p>
<h3 id="crear-primero-la-instruccion-try-catch-finally-135">Crear primero la instrucci√≥n try-catch-finally</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Uno de los aspectos m√°s interesantes de las excepciones es que definen un</p>
<p>√°mbito en el programa. Al ejecutar c√≥digo en la parte try de una instrucci√≥n</p>
<p>try-catch-finally indicamos que la ejecuci√≥n se puede cancelar en</p>
<p>cualquier momento y despu√©s retomar en catch</p>
<p>Los bloques try son como las transacciones, catch debe salir del</p>
<p>programa en un estado coherente, independientemente de lo que suceda en</p>
<p>try . Por este motivo, es aconsejable iniciar con una instrucci√≥n try-catch-</p>
<p>finally el c√≥digo que genere excepciones. De este modo define lo que debe</p>
<p>esperar el usuario del c√≥digo, independientemente de que se produzca un</p>
<p>error en el c√≥digo ejecutado en la cl√°usula try</p>
<p>Veamos un ejemplo. Imagine que tiene que crear un c√≥digo que acceda a</p>
<p>un archivo y lea objetos serializados.</p>
<p>Comenzamos con una prueba de unidad que muestra que obtendremos</p>
<p>una excepci√≥n cuando el archivo no exista:</p>
<p>@Test(expected = StorageException.class)</p>
<p>public void retrieveSectionShouldThrowOnInvalidFileName() {</p>
<p>sectionStore.retrieveSection(‚Äúinvalid - file‚Äù);</p>
<p>La prueba nos lleva a crear lo siguiente:</p>
<p>public List&lt;RecordedGrip&gt; retrieveSection(String sectionName) {</p>
<p>// se devuelve un resultado ficticio hasta tener una implementaci√≥n real</p>
<p>return new ArrayList&lt;RecordedGrip&gt;();</p>
<p>Nuestra prueba falla ya que no genera una excepci√≥n. Tras ello,</p>
<p>cambiamos la implementaci√≥n para que intente acceder a un archivo no</p>
<p>v√°lido. Esta operaci√≥n genera una excepci√≥n:</p>
<p>public List&lt;RecordedGrip&gt; retrieveSection (String sectionName) {</p>
<p>try {</p>
<p>FileInputstream stream = new FileInputStream(sectionName)</p>
<p>} catch (Exception e) {</p>
<p>throw new StorageException(‚Äúretrieval error‚Äù, e);</p>
<p>return new ArrayList&lt;RecordedGrip&gt;();</p>
<p>Ahora la prueba es correcta ya que capturamos la excepci√≥n y ya</p>
<p>podemos refactorizar. Podemos reducir el tipo de la excepci√≥n capturada para</p>
<p>que coincida con el tipo generado desde el constructor FileInputStream:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>FileNotFoundException</p>
<p>public List&lt;RecordedGrip&gt; retrieveSection(String sectionName) {</p>
<p>try {</p>
<p>FileInputStream stream = new FileInputStream(sectionName);</p>
<p>stream.close();</p>
<p>} catch (FileNotFoundException e) {</p>
<p>throw new StorageException(‚Äúretrieval error‚Äù, e);</p>
<p>return new ArrayList&lt;RecordedGrip&gt;();</p>
<p>Ahora que hemos definido el √°mbito con una estructura try-catch</p>
<p>podemos usar TDD para dise√±ar el resto de la l√≥gica necesaria. Dicha l√≥gica</p>
<p>se a√±ade entre la creaci√≥n de FileInputStream y el cierre, y podemos</p>
<p>pretender que no pasa nada incorrecto.</p>
<p>Intente crear pruebas que fuercen las excepciones, para despu√©s a√±adir al</p>
<p>controlador un comportamiento que satisfaga dichas pruebas. De este modo</p>
<p>primero crear√° el √°mbito de transacci√≥n del bloque try y podr√° mantener la</p>
<p>naturaleza de transacci√≥n del √°mbito.</p>
<h3 id="usar-excepciones-sin-comprobar-136">Usar excepciones sin comprobar</h3>
<p>El debate ha terminado. Durante a√±os, los programadores de Java han</p>
<p>debatido las ventajas y los problemas de las excepciones comprobadas.</p>
<p>Cuando aparecieron en la primera versi√≥n de Java, parec√≠an una gran idea. La</p>
<p>firma de todos los m√©todos enumerar√≠a todas las excepciones que se pod√≠an</p>
<p>pasar a su invocador. Es m√°s, estas excepciones formaban parte del tipo del</p>
<p>m√©todo. El c√≥digo no se compilar√≠a si la firma no coincid√≠a con lo que el</p>
<p>c√≥digo iba a hacer.</p>
<p>En aquel momento, pens√°bamos que las excepciones comprobadas eran</p>
<p>una gran idea y s√≠, ofrec√≠an ciertas ventajas. Sin embargo, ahora es evidente</p>
<p>que no se necesitan para crear software robusto. C# carece de excepciones</p>
<p>comprobadas y, a pesar de los intentos, C++ tampoco, como sucede en</p>
<p>Python o Ruby. Y en todos estos lenguajes se puede crear software robusto.</p>
<p>Por ello, debemos decidir si las excepciones comprobadas valen su precio.</p>
<p>¬øQu√© precio? El precio de las excepciones comprobadas es un</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[33]</p>
<p>incumplimiento del principio abierto/cerrado . Si genera una excepci√≥n</p>
<p>comprobada desde un m√©todo de su c√≥digo y la cl√°usula catch se encuentra</p>
<p>tres niveles por debajo, debe declarar dicha excepci√≥n en la firma de todos los</p>
<p>m√©todos comprendidos entre su posici√≥n y catch . Esto significa que un</p>
<p>cambio en un nivel inferior del software puede forzar cambios de firma en</p>
<p>muchos niveles superiores. Ser√° necesario volver a generar e implementar los</p>
<p>m√≥dulos cambiados, aunque no cambien los elementos a los que hacen</p>
<p>referencia.</p>
<p>Piense en la jerarqu√≠a de invocaci√≥n de un sistema. Las funciones de la</p>
<p>parte superior invocan a las funciones situadas debajo, que invocan a otras</p>
<p>funciones inferiores y as√≠ sucesivamente. Imagine que una de las funciones</p>
<p>de nivel inferior se modifica de forma que debe generar una excepci√≥n. Si la</p>
<p>excepci√≥n se comprueba, la firma de la funci√≥n tendr√° que a√±adir una</p>
<p>cl√°usula throws . Pero esto significa que todas las funciones que invoquen</p>
<p>nuestra funci√≥n modificada tambi√©n tendr√°n que cambiarse para capturar la</p>
<p>nueva excepci√≥n o para a√±adir la correspondiente cl√°usula throws en su</p>
<p>firma. Y as√≠ indefinidamente. El resultado final es una cascada de cambios</p>
<p>que pasan desde los niveles inferiores del software hasta los superiores. La</p>
<p>encapsulaci√≥n se rompe ya que todas las funciones en la ruta de throw deben</p>
<p>conocer detalles de la excepci√≥n de nivel inferior. Como el cometido de las</p>
<p>excepciones es permitimos procesar errores a distancia, es una l√°stima que las</p>
<p>excepciones comprobadas rompan la encapsulaci√≥n de esta forma.</p>
<p>Las excepciones comprobadas pueden ser √∫tiles si tiene que crear una</p>
<p>biblioteca cr√≠tica: tendr√° que capturarlas. Pero en el desarrollo de aplicaciones</p>
<p>generales, los costes de dependencia superan las ventajas.</p>
<h3 id="ofrecer-contexto-junto-a-las-excepciones-137">Ofrecer contexto junto a las excepciones</h3>
<p>Las excepciones que genere deben proporcionar el contexto adecuado para</p>
<p>determinar el origen y la ubicaci√≥n de un error. En Java, puede obtener un</p>
<p>rastreo de pila de cualquier excepci√≥n; sin embargo, no le indicar√° el</p>
<p>cometido de la funci√≥n fallida.</p>
<p>Redacte mensajes de error informativos p√°selos junto sus</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>excepciones. Mencione la operaci√≥n fallida y el tipo de fallo. Si guarda</p>
<p>registros en su aplicaci√≥n, incluya informaci√≥n suficiente para poder registrar</p>
<p>el error en la cl√°usula catch</p>
<h3 id="definir-clases-de-excepcion-de-acuerdo-a-las-neces-138">Definir clases de excepci√≥n de acuerdo a las necesidades</h3>
<h3 id="del-invocador-139">del invocador</h3>
<p>Existen varias formas de clasificar los errores. Podemos hacerlo por origen</p>
<p>(¬øprovienen de uno otro componente?) por tipo (¬øson fallos del</p>
<p>dispositivo, de la red o errores de programaci√≥n?). Sin embargo, al definir</p>
<p>clases de excepci√≥n en una aplicaci√≥n, debemos preocuparnos principalmente</p>
<p>en c√≥mo se capturan</p>
<p>Veamos un pobre ejemplo de clasificaci√≥n de excepciones. Es una</p>
<p>instrucci√≥n try-catch-finally de la invocaci√≥n de una biblioteca de</p>
<p>terceros. Abarca todas las excepciones que las invocaciones pueden generar:</p>
<p>ACMEPort port = new ACMEPort(12);</p>
<p>try {</p>
<p>port.open();</p>
<p>} catch (DeviceResponseException e) {</p>
<p>reportPortError(e);</p>
<p>logger.log{‚ÄúDevice response exception‚Äù, e);</p>
<p>} catch (ATM1212UnlockedException e) {</p>
<p>reportPortError(e);</p>
<p>logger.log(‚ÄúUnlock exception‚Äù, e);</p>
<p>} catch (GMXError e) {</p>
<p>reportPortError(e);</p>
<p>logger.log(‚ÄúDevice response exception‚Äù);</p>
<p>} finally {</p>
<p>...</p>
<p>Esta instrucci√≥n contiene elementos duplicados, algo que no deber√≠a</p>
<p>sorprendernos. En muchos casos de control de excepciones, el trabajo que</p>
<p>realizamos es relativamente est√°ndar independientemente de la causa real.</p>
<p>Debemos registrar un error y asegurarnos de poder continuar.</p>
<p>En este caso, como sabemos que el trabajo es el mismo</p>
<p>independientemente de la excepci√≥n, podemos simplificar el c√≥digo si</p>
<p>incluimos la API invocada y nos aseguramos de que devuelve un tipo de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>excepci√≥n com√∫n:</p>
<p>LocalPort port = new LocalPort(12);</p>
<p>try {</p>
<p>port.open();</p>
<p>} catch (PortDeviceFailure e) {</p>
<p>reportError(e);</p>
<p>logger.log(e.getMessage(), e);</p>
<p>} finally {</p>
<p>...</p>
<p>Nuestra clase LocalPort es un simple envoltorio que captura y traduce</p>
<p>excepciones generadas por la clase ACMEPort</p>
<p>public class LocalPort {</p>
<p>private ACMEPort innerPort;</p>
<p>public LocalPort(int portNumber) {</p>
<p>innerPort = new ACMEPort(portNumber);</p>
<p>public void open() {</p>
<p>try {</p>
<p>innerPort.open();</p>
<p>} catch (DeviceResponseException e) {</p>
<p>throw new PortDeviceFailure(e);</p>
<p>} catch (ATM1212UnlockedException e) {</p>
<p>throw new PortDeviceFailure(e);</p>
<p>} catch (GMXError e) {</p>
<p>throw new PortDeviceFailure(e);</p>
<p>...</p>
<p>Los envoltorios como el definido para ACMEPort pueden ser muy √∫tiles.</p>
<p>De hecho, es recomendable envolver API de terceros. Al hacerlo, se</p>
<p>minimizan las dependencias: puede cambiar a otra biblioteca diferente sin</p>
<p>apenas problemas y el envoltorio tambi√©n facilita imitar invocaciones de</p>
<p>terceros cuando se prueba el c√≥digo. Una √∫ltima ventaja es que no estamos</p>
<p>limitados a las decisiones de dise√±o de API de un determinado fabricante.</p>
<p>Puede definir una API que le resulte c√≥moda. En el ejemplo anterior,</p>
<p>definimos un √∫nico tipo de excepci√≥n para el fallo de puertos y podemos</p>
<p>escribir un c√≥digo mucho m√°s limpio. A menudo, una √∫nica clase de</p>
<p>excepci√≥n es suficiente para una zona concreta del c√≥digo. La informaci√≥n</p>
<p>enviada con la excepci√≥n puede distinguir los errores. Use clases diferentes</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>s√≥lo para capturar una excepci√≥n y permitir el paso de otra distinta.</p>
<h3 id="definir-el-flujo-normal-140">Definir el flujo normal</h3>
<p>Si sigue los consejos de apartados</p>
<p>anteriores, realizar√° una importante</p>
<p>separaci√≥n entre la l√≥gica empresarial y el</p>
<p>control de errores. La mayor√≠a de su c√≥digo</p>
<p>parecer√° un algoritmo limpio y sin adornos.</p>
<p>Sin embargo, el proceso desplaza la</p>
<p>detecci√≥n de errores hacia los bordes del programa. Debe envolver API</p>
<p>externas para poder generar sus propias excepciones y definir un controlador</p>
<p>por encima del c√≥digo para poder procesar c√°lculos cancelados. En muchos</p>
<p>casos es el enfoque m√°s acertado, pero en ocasiones conviene no cancelar.</p>
<p>Veamos un ejemplo, un c√≥digo extra√±o que suma gastos en una</p>
<p>aplicaci√≥n de facturaci√≥n:</p>
<p>try {</p>
<p>MealExpenses expenses = expenseReportDAO.getMeals(employee.getID());</p>
<p>m_total += expenses.getTotal();</p>
<p>} catch(MealExpensesNotFound e) {</p>
<p>m_total += getMealPerDiem();</p>
<p>En esta empresa, si las comidas son gastos, pasan a formar parte del total.</p>
<p>Si no lo son, los trabajadores reciben una cantidad diaria para la comida. La</p>
<p>excepci√≥n entorpece la l√≥gica. Ser√≠a m√°s adecuado no tener que procesar el</p>
<p>caso especial y el c√≥digo ser√≠a mucho m√°s sencillo:</p>
<p>MealExpenses expenses = expenseReportDAO.getMeals(employee.getID());</p>
<p>m_total += expenses.getTotal();</p>
<p>¬øDe verdad que el c√≥digo puede ser tan simple? Pues s√≠. Podemos</p>
<p>cambiar ExpenseReportDAO para que siempre devuelva un objeto</p>
<p>MealExpense . Si no hay gastos de comida, devuelve un objeto MealExpense</p>
<p>que devuelve la dieta diaria como total:</p>
<p>public class PerDiemMealExpenses implements MealExpenses {</p>
<p>public int getTotal() {</p>
<p>// devolver la dieta diaria predeterminada</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Es lo que se denomina Patr√≥n de Caso Especial [Fowler]. Se crea una</p>
<p>clase o se configura un objeto que procese un caso especial. Al hacerlo, el</p>
<p>c√≥digo cliente no tiene que procesar comportamientos excepcionales. Dichos</p>
<p>comportamientos se encapsulan en un objeto de caso especial.</p>
<h3 id="no-devolver-null-141">No devolver Null</h3>
<p>Creo que toda descripci√≥n del control de errores debe mencionar los</p>
<p>elementos proclives a errores. El primero es devolver null. He perdido la</p>
<p>cuenta de la cantidad de aplicaciones en que las que l√≠nea s√≠ y l√≠nea tambi√©n</p>
<p>se comprueba null:</p>
<p>public void registerItem(Item item) {</p>
<p>if (item != null) {</p>
<p>ItemRegistry registry = peristentStore.getItemRegistry();</p>
<p>if (registry != null) {</p>
<p>Item existing = registry.getItem(item.getID());</p>
<p>if (existing.getBillingPeriod().hasRetailOwner()) {</p>
<p>existing.register(item);</p>
<p>Si trabaja en una base de c√≥digo como √©sta, puede que no le parezca tan</p>
<p>mala, pero lo es. Al devolver null , b√°sicamente nos creamos trabajo y</p>
<p>generamos problemas para los invocadores. Basta con que falte una</p>
<p>comprobaci√≥n de null para que la aplicaci√≥n pierda el control.</p>
<p>¬øSe ha fijado en que no hay una comprobaci√≥n de null en la segunda</p>
<p>l√≠nea de la instrucci√≥n if anidada? ¬øQu√© suceder√≠a en tiempo de ejecuci√≥n si</p>
<p>persistentStore fuera null Se generar√≠a NullPointerException en</p>
<p>tiempo de ejecuci√≥n y se capturar√≠a NullPointerException en el nivel</p>
<p>superior o no. En ambos casos es incorrecto. ¬øQu√© deber√≠a hace como</p>
<p>respuesta a la generaci√≥n de NullPointerException desde el interior de su</p>
<p>aplicaci√≥n? Se puede afirmar que el problema de este c√≥digo es la ausencia</p>
<p>de una comprobaci√≥n de null pero en realidad el problema es su exceso. Si</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>siente la tentaci√≥n de devolver null desde un m√©todo, pruebe a generar una</p>
<p>excepci√≥n o a devolver un objeto de caso especial. Si invoca un m√©todo que</p>
<p>devuelva null desde una API de terceros, envu√©lvalo en un m√©todo que</p>
<p>genere una excepci√≥n o devuelva un objeto de caso especial. En muchos</p>
<p>casos, los objetos de caso especial son un remedio sencillo. Imagine que tiene</p>
<p>el siguiente c√≥digo:</p>
<p>List&lt;Employee&gt; employees = getEmployees();</p>
<p>if (employees != null) {</p>
<p>for(Employee e : employees) {</p>
<p>totalPay += e.getPay();</p>
<p>Ahora, getEmployees puede devolver null ¬øpero es necesario? Si</p>
<p>cambiamos getEmployee para que devuelva una lista vac√≠a, podremos limpiar</p>
<p>el c√≥digo:</p>
<p>List&lt;Employee&gt; employees = getEmployees();</p>
<p>for(Employee e : employees) {</p>
<p>totalPay += e.getPay();</p>
<p>Afortunadamente, Java dispone de Collections.emptyList()</p>
<p>devuelve una lista inmutable predefinida que podemos usar para este</p>
<p>cometido:</p>
<p>public List&lt;Employee&gt; getEmployees() {</p>
<p>if (... there are no employees ...)</p>
<p>return Collections.emptyList();</p>
<p>Si usa este tipo de c√≥digo, minimizar√° la presencia de</p>
<p>NullPointerException y su c√≥digo ser√° m√°s limpio.</p>
<h3 id="no-pasar-null-142">No pasar Null</h3>
<p>Devolver null desde m√©todos es incorrecto, pero es peor pasar null</p>
<p>m√©todos. A menos que trabaje con una API que espere que pase null , debe</p>
<p>evitarlo siempre que sea posible. Veamos otro ejemplo, un sencillo m√©todo</p>
<p>que calcula una m√©trica para dos puntos:</p>
<p>public class MetricsCalculator</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public double xProjection(Point p1, Point p2) {</p>
<p>return (p2.x ‚Äì p1.x) * 1.5;</p>
<p>...</p>
<p>¬øQu√© sucede cuando alguien pasa null como argumento?</p>
<p>calculator.xProjection(null, new Point (12, 13));</p>
<p>Se genera NullPointerException , evidentemente.</p>
<p>¬øC√≥mo solucionarlo? Podr√≠amos crear un nuevo tipo de excepci√≥n y</p>
<p>generarla:</p>
<p>public class MetricsCalculator</p>
<p>public double xProjection(Point p1, Point p2) {</p>
<p>if (p1==null || p2==null) {</p>
<p>throw InvalidArgumentException(</p>
<p>‚ÄúInvalid argument for MetricsCalculator.xProjection‚Äù);</p>
<p>return (p2.x ‚Äì p1.x) * 1.5; }</p>
<p>¬øMejor? Puede que sea mejor que una excepci√≥n de puntero nulo, pero</p>
<p>recuerde que debe definir un controlador para InvalidArgumentException</p>
<p>¬øQu√© debe hacer el controlador? ¬øHay alguna forma correcta de hacerlo?</p>
<p>Existe otra alternativa, usar un grupo de afirmaciones:</p>
<p>public class MetricsCalculator (</p>
<p>public double xProjection{Point p1, Point p2) {</p>
<p>assert p1 != null : ‚Äúp1 should not be null‚Äù;</p>
<p>assert p2 != null : ‚Äúp2 should not be null‚Äù;</p>
<p>return (p2.x - pl.x) * 1.5;</p>
<p>Es documentaci√≥n correcta pero no soluciona el problema. Si alguien</p>
<p>pasa null , seguir√° produci√©ndose un error de tiempo de ejecuci√≥n.</p>
<p>En la mayor√≠a de lenguajes de programaci√≥n no hay una forma correcta</p>
<p>de procesar un null pasado por accidente. Como √©ste es el caso, el enfoque</p>
<p>racional es impedir que se pase null de forma predeterminada. Si lo hace,</p>
<p>puede dise√±ar c√≥digo sabiendo que null en una lista de argumentos indica un</p>
<p>problema y los errores ser√°n menores.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="conclusion-143">Conclusi√≥n</h3>
<p>El c√≥digo limpio es legible pero tambi√©n debe ser robusto. No son objetivos</p>
<p>opuestos. Podemos crear c√≥digo limpio y robusto si consideramos el control</p>
<p>de errores una preocupaci√≥n diferente, algo que vemos de forma</p>
<p>independiente desde nuestra l√≥gica principal. Si somos capaces de lograrlo,</p>
<p>razonaremos de forma independiente y podemos aumentar la capacidad de</p>
<p>mantenimiento de nuestro c√≥digo.</p>
<h3 id="bibliografia-144">Bibliograf√≠a</h3>
<p>[Martin] Agile Software Development: Principles, Patterns, and</p>
<p>Practices , Robert C. Martin, Prentice Hall, 2002.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="limites-145">L√≠mites</h1>
<p>por James Grenning</p>
<p>No es habitual que controlemos todo el software de nuestros sistemas. En</p>
<p>ocasiones, adquirimos paquetes de terceros o usamos c√≥digo abierto. En otros</p>
<p>casos, dependemos de equipos de nuestra propia empresa para producir</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>componentes o subsistemas que utilizamos. De alg√∫n modo debemos integrar</p>
<p>este c√≥digo externo con el nuestro. En este cap√≠tulo veremos pr√°cticas y</p>
<p>t√©cnicas para definir con claridad los l√≠mites de nuestro software</p>
<h3 id="utilizar-codigo-de-terceros-146">Utilizar c√≥digo de terceros</h3>
<p>Existe una tensi√≥n natural entre el proveedor de una interfaz y el usuario de la</p>
<p>misma. Los proveedores de paquetes y estructuras de terceros abogan por una</p>
<p>capacidad de aplicaci√≥n global para poder trabajar en diversos entornos y</p>
<p>atraer a un p√∫blico m√°s amplio. Los usuarios, por su parte, desean una</p>
<p>interfaz centrada en sus necesidades concretas. Esta tensi√≥n puede provocar</p>
<p>problemas en los l√≠mites de nuestros sistemas.</p>
<p>Analicemos java.util.Map como ejemplo. Como puede apreciar en la</p>
<p>siguiente lista. Map tiene una amplia interfaz con numerosas prestaciones.</p>
<p>Esta potencia y flexibilidad es muy √∫til, pero tambi√©n puede ser un problema.</p>
<p>Por ejemplo, nuestra aplicaci√≥n puede generar un Map y compartirlo. Nuestra</p>
<p>intenci√≥n puede que sea que ninguno de los receptores del mapa borre sus</p>
<p>elementos. Pero en la parte superior de la lista encontramos el m√©todo</p>
<p>clear() . Cualquier usuario del mapa puede borrarlo. O puede que nuestra</p>
<p>convenci√≥n de dise√±o determine que s√≥lo se puedan almacenar objetos</p>
<p>concretos en el mapa, pero Map no limita de forma fiable los tipos de objetos</p>
<p>que admite. Cualquier usuario puede a√±adir elementos de cualquier tipo a</p>
<p>cualquier mapa.</p>
<p>clear() void - Map</p>
<p>containsKey (Object key) boolean - Map</p>
<p>containsValue (Object value) boolean - Map</p>
<p>entrySet() Set - Map</p>
<p>equals(Object o) boolean - Map</p>
<p>get(Object key) Object - Map</p>
<p>getClass() Class&lt;? extends Object&gt; - Object</p>
<p>hashCode() int - Map</p>
<p>isEmpty() boolean - Map</p>
<p>keySet() Set - Map</p>
<p>notify() void - Object</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>notifyAll() void - Object</p>
<p>put(Object key, Object value) Object - Map</p>
<p>putAll(Map t) void - Map</p>
<p>remove(Object key) Object - Map</p>
<p>size() int - Map</p>
<p>toString() String - Object</p>
<p>values() Collection - Map</p>
<p>wait() void - Object</p>
<p>wait(long timeout) void - Object</p>
<p>wait(long timeout, int nanos) void - Object</p>
<p>Figura 8.1. Los m√©todos de Map</p>
<p>Si nuestra aplicaci√≥n necesita un mapa de Sensor , comprobar√° que los</p>
<p>sensores se definen de esta forma:</p>
<p>Map sensors = new HashMap();</p>
<p>Tras ello, cuando otra parte del c√≥digo necesite acceder a sensor, vemos</p>
<p>este c√≥digo:</p>
<p>Sensor s = (Sensor)sensors.get(sensorId);</p>
<p>No lo vemos una sola vez, sino repetidamente a lo largo del c√≥digo. El</p>
<p>cliente de este c√≥digo es responsable de obtener un objeto de Map</p>
<p>convertirlo al tipo correcto. Funciona, pero no es c√≥digo limpio. Adem√°s, este</p>
<p>c√≥digo no cuenta su historia como deber√≠a. La legibilidad del c√≥digo se</p>
<p>podr√≠a mejorar mediante el uso de gen√©ricos, como se indica a continuaci√≥n:</p>
<p>Map&lt;Sensor&gt; sensors = new HashMap&lt;Sensor&gt;();</p>
<p>...</p>
<p>Sensor s = sensors.get(sensorId);</p>
<p>Sin embargo, esto no soluciona el problema de que Map&lt;Sensor&gt; ofrezca</p>
<p>m√°s prestaciones de las que necesitamos o deseamos.</p>
<p>Al pasar una instancia de Map&lt;Sensor&gt; en el sistema, significa que habr√°</p>
<p>muchos puntos que corregir si la interfaz de Map cambia. Seguramente piense</p>
<p>que son cambios improbables, pero recuerde que se han producido al a√±adir</p>
<p>compatibilidad con gen√©ricos en Java 5. Sin duda hemos visto sistemas que</p>
<p>impiden el uso de gen√©ricos debido a la gran cantidad de cambios necesarios</p>
<p>para compensar el uso liberal de Map</p>
<p>Una forma m√°s limpia de usar Map ser√≠a la siguiente. A ning√∫n usuario</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Sensor le importa si se usan gen√©ricos o no. Esa opci√≥n se ha convertido (y</p>
<p>siempre deber√≠a serlo) en un detalle de implementaci√≥n.</p>
<p>public class Sensors {</p>
<p>private Map sensors = new HashMap();</p>
<p>public Sensor getById(String id) {</p>
<p>return (Sensor) sensors.get(id);</p>
<p>//corte</p>
<p>La interfaz en el l√≠mite (Map) est√° oculta. Ha conseguido evolucionar sin</p>
<p>apenas impacto en el resto de la aplicaci√≥n. El uso de gen√©ricos ya no es un</p>
<p>problema ya que la conversi√≥n y la administraci√≥n de tipos se procesa dentro</p>
<p>de la clase Sensors</p>
<p>Esta interfaz tambi√©n se ha ajustado y limitado a las necesidades de la</p>
<p>aplicaci√≥n. Genera c√≥digo m√°s f√°cil de entender y con menor probabilidad de</p>
<p>errores. La clase Sensors puede aplicar las reglas empresariales y de dise√±o.</p>
<p>No sugerimos que se encapsulen de esta forma todos los usos de Map,</p>
<p>sino que no se pase Map (ni otras interfaces en el l√≠mite) por el sistema. Si usa</p>
<p>una interfaz de l√≠mite como Map , mant√©ngala dentro de la clase o la familia de</p>
<p>clases en la que se use. Evite devolverla o aceptarla como argumento de API</p>
<p>p√∫blicas.</p>
<h3 id="explorar-y-aprender-limites-147">Explorar y aprender l√≠mites</h3>
<p>El c√≥digo de terceros nos permite obtener mayor funcionalidad en menos</p>
<p>tiempo. ¬øPor d√≥nde empezamos cuando queremos utilizar un paquete de</p>
<p>terceros? Nuestra labor no es probar el c√≥digo, pero s√≠ crear pruebas para el</p>
<p>c√≥digo de terceros que utilicemos.</p>
<p>Imagine que no es evidente c√≥mo usar una biblioteca de terceros.</p>
<p>Podr√≠amos perder uno o varios d√≠as en leer la documentaci√≥n y decidir c√≥mo</p>
<p>usarla. Tras ello, podr√≠amos escribir el c√≥digo para usar el c√≥digo de terceros</p>
<p>comprobar si se comporta de la forma esperada. No deber√≠amos</p>
<p>sorprendernos por tener que realizar extensas sesiones de depuraci√≥n</p>
<p>intentando localizar errores en nuestro c√≥digo o en el suyo.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Aprender el c√≥digo de terceros es complicado, y tambi√©n integrarlo.</p>
<p>Hacer ambas cosas al mismo tiempo es el doble de complicado. Necesitamos</p>
<p>un enfoque diferente. En lugar de experimentar y probar el nuevo material en</p>
<p>nuestro c√≥digo de producci√≥n, podr√≠amos crear pruebas que analicen nuestro</p>
<p>entendimiento del c√≥digo de terceros. Jim Newkirk las denomina pruebas de</p>
<p>[34]</p>
<p>aprendizaje</p>
<p>En las pruebas de aprendizaje, invocamos la API de terceros como</p>
<p>supuestamente la usar√≠amos en nuestra aplicaci√≥n. B√°sicamente realizamos</p>
<p>experimentos controlados para comprobar si la entendemos. Las pruebas se</p>
<p>centran en lo que queremos obtener de la API.</p>
<h3 id="aprender-log4j-148">Aprender log4j</h3>
<p>Imagine que desea usar el paquete de Apache log4j en lugar de su propio</p>
<p>dispositivo de registro personalizado. Lo descarga y abre la p√°gina inicial de</p>
<p>la documentaci√≥n. Sin una lectura exhaustiva, crea el primer caso de prueba</p>
<p>con la esperanza de que escriba hello en la consola.</p>
<p>@Test</p>
<p>public void testLogCreate() {</p>
<p>Logger logger = Logger.getLogger(‚ÄúMyLogger‚Äù);</p>
<p>logger.info(‚Äúhello‚Äù);</p>
<p>Al ejecutarlo, el registrador genera un error que nos indica que</p>
<p>necesitamos algo denominado Appender . Tras investigar, descubrimos que</p>
<p>existe un elemento ConsoleAppender Creamos ConsoleAppender</p>
<p>comprobamos si hemos conseguido revelar los secretos del registro en la</p>
<p>consola.</p>
<p>@Test</p>
<p>public void testLogAddAppender() {</p>
<p>Logger logger = Logger.getLogger (‚ÄúMyLogger‚Äù);</p>
<p>ConsoleAppender appender = new ConsoleAppender();</p>
<p>logger.addAppender(appender);</p>
<p>logger.info(‚Äúhello‚Äù);</p>
<p>En esta ocasi√≥n descubrimos que Appender carece de flujo de salida, algo</p>
<p>extra√±o, ya que parece l√≥gico que lo tuviera. Tras recurrir Google,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>probamos lo siguiente:</p>
<p>@Test</p>
<p>public void testLogAddAppender() {</p>
<p>Logger logger = Logger.getLogger(‚ÄúMyLogger‚Äù);</p>
<p>logger.removeAllAppenders();</p>
<p>logger.addAppender(new ConsoleAppender(</p>
<p>new PatternLayout(‚Äú%p %t %m%n‚Äù),</p>
<p>ConsoleAppender.SYSTEM_OUT));</p>
<p>logger.info(‚Äúhello‚Äù);</p>
<p>Funciona; en la consola aparece un mensaje con la palabra hello . Resulta</p>
<p>extra√±o tener que indicarle a ConsoleAppender que escriba en la consola.</p>
<p>Al eliminar el argumento ConsoleAppender.SystemOut vemos que</p>
<p>hello sigue impreso. Pero al eliminar PatternLayout , de nuevo vemos la</p>
<p>queja de la falta de un flujo de salida. Es un comportamiento muy extra√±o.</p>
<p>Si nos fijamos en la documentaci√≥n, vemos que el constructor</p>
<p>ConsoleAppender predeterminado no est√° configurado, lo que no parece</p>
<p>demasiado obvio ni √∫til. Parece m√°s bien un error o una incoherencia de</p>
<p>log4j</p>
<p>Tras nuevas b√∫squedas en Google, investigaciones pruebas,</p>
<p>conseguimos el Listado 8-1. Hemos descubierto c√≥mo funciona log4j</p>
<p>hemos codificado esos conocimientos en un grupo de sencillas pruebas de</p>
<p>unidad.</p>
<p>Listado 8-1</p>
<p>LogTest.java.</p>
<p>public class LogTest (</p>
<p>private Logger logger;</p>
<p>@Before</p>
<p>public void initialize() {</p>
<p>logger = Logger.getLogger(‚Äúlogger‚Äù);</p>
<p>logger.removeAllAppenders();</p>
<p>Logger.getRootLogger().removeAllAppenders();</p>
<p>@Test</p>
<p>public void basicLogger() {</p>
<p>BasicConfigurator.configure();</p>
<p>logger.info(‚ÄúbasicLogger‚Äù);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>@Test</p>
<p>public void addAppenderWithStream() {</p>
<p>logger.addAppender(new ConsoleAppender(</p>
<p>new PatternLayout (‚Äú%p %t %m%n‚Äù),</p>
<p>ConsoleAppender.SYSTEM_OUT));</p>
<p>logger.info(‚ÄúaddAppenderWithStream‚Äù);</p>
<p>@Test</p>
<p>public void addAppenderWithoutStream() {</p>
<p>logger.addAppender(new ConsoleAppender(</p>
<p>new PatternLayout(‚Äú%p %t %m%n‚Äù)));</p>
<p>logger.info(‚ÄúaddAppenderWithoutStream‚Äù);</p>
<p>Ahora sabemos c√≥mo inicializar un sencillo registrador de consola y</p>
<p>encapsular ese conocimiento en nuestra propia clase de registro para que el</p>
<p>resto de la aplicaci√≥n se a√≠sle de la interfaz de l√≠mite log4j</p>
<h3 id="las-pruebas-de-aprendizaje-son-algo-mas-que-gratui-149">Las pruebas de aprendizaje son algo m√°s que gratuitas</h3>
<p>Las pruebas de aprendizaje no cuestan nada. De todas formas, hemos tenido</p>
<p>que aprender la API y crear las pruebas fue una forma sencilla y aislada de</p>
<p>adquirir esos conocimientos. Las pruebas de aprendizaje fueron experimentos</p>
<p>precisos que permitieron aumentar nuestros conocimientos.</p>
<p>Las pruebas no s√≥lo son gratuitas, sino tambi√©n rentables. Cuando</p>
<p>aparezcan nuevas versiones del paquete de terceros, ejecutamos las pruebas</p>
<p>de aprendizaje para comprobar si hay diferencias de comportamiento.</p>
<p>Las pruebas de aprendizaje demuestran que los paquetes de terceros que</p>
<p>usamos funcionan de la forma esperada. Una vez integrados, no hay garant√≠a</p>
<p>de que el c√≥digo de terceros sea compatible con nuestras necesidades. Los</p>
<p>autores originales se ver√°n presionados para cambiar el c√≥digo y ajustarlo a</p>
<p>sus propias necesidades. Corregir√°n errores y a√±adir√°n nuevas funciones. En</p>
<p>cada versi√≥n surgir√°n nuevos riesgos. Si el paquete de terceros cambia de una</p>
<p>forma incompatible con nuestras pruebas, lo sabremos al instante.</p>
<p>Independientemente de que necesite los conocimientos proporcionados</p>
<p>por las pruebas de aprendizaje, un l√≠mite claro debe estar respaldado por un</p>
<p>conjunto de pruebas que ejerciten la interfaz de la misma forma que hace el</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>c√≥digo de producci√≥n. Sin estas pruebas de l√≠mites para facilitar la transici√≥n,</p>
<p>podr√≠amos conservar la versi√≥n antigua m√°s tiempo del necesario.</p>
<h3 id="usar-codigo-que-todavia-no-existe-150">Usar c√≥digo que todav√≠a no existe</h3>
<p>Existe otro tipo de l√≠mite, que separa lo conocido de lo desconocido. En</p>
<p>ocasiones, nuestro conocimiento del c√≥digo parece desvanecerse. Lo que hay</p>
<p>al otro lado del l√≠mite es desconocido (al menos por el momento). En</p>
<p>ocasiones, decidimos no mirar m√°s all√° del l√≠mite.</p>
<p>Hace a√±os form√© parte de un equipo de desarrollo de software para un</p>
<p>sistema de comunicaci√≥n por radio. Hab√≠a un subsistema, el Transmisor, que</p>
<p>apenas conoc√≠amos y cuya interfaz todav√≠a no se hab√≠a dise√±ado. Como no</p>
<p>quer√≠amos quedarnos parados, comenzamos a trabajar alej√°ndonos de la parte</p>
<p>desconocida del c√≥digo.</p>
<p>Sab√≠amos perfectamente d√≥nde acababa nuestro mundo y comenzaba el</p>
<p>nuevo. Mientras avanz√°bamos, en ocasiones nos top√°bamos con este l√≠mite.</p>
<p>Aunque la ignorancia ocultaba nuestra visi√≥n m√°s all√° del l√≠mite, sab√≠amos</p>
<p>c√≥mo quer√≠amos que fuera la interfaz. Quer√≠amos decirle al transmisor algo</p>
<p>como lo siguiente:</p>
<p>Ajustar el transmisor en la frecuencia proporcionada y emitir una</p>
<p>representaci√≥n anal√≥gica de los datos que provienen de este flujo.</p>
<p>No sab√≠amos c√≥mo hacerlo ya que todav√≠a no se hab√≠a dise√±ado la API.</p>
<p>Por ello decidimos determinar despu√©s los detalles.</p>
<p>Para no quedarnos bloqueados, definimos nuestra propia interfaz. Le</p>
<p>dimos un nombre sencillo, Transmitter . Le asignamos el m√©todo transmit</p>
<p>que aceptaba una frecuencia un flujo de datos. Es la interfaz que</p>
<p>dese√°bamos haber tenido.</p>
<p>Lo mejor de escribir la interfaz que dese√°bamos haber tenido era que la</p>
<p>control√°bamos. Esto hace que el c√≥digo cliente sea m√°s legible y se ci√±a a los</p>
<p>objetivos previstos.</p>
<p>En la figura 8.1 se aprecia que aislamos las clases</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>CommunicationsController de la API del transmisor (que no control√°bamos</p>
<p>estaba por definir). Al usar nuestra propia interfaz espec√≠fica de la</p>
<p>aplicaci√≥n, el c√≥digo de CommunicationsController era limpio y expresivo.</p>
<p>Una vez definida la API del transmisor, creamos TransmitterAdapter para</p>
<p>[35]</p>
<p>reducir las distancias. El adaptador encapsulaba la interacci√≥n con la API</p>
<p>y ofrec√≠a un √∫nico punto en el que evolucionaba.</p>
<p>Figura 8.1. Predicci√≥n del transmisor</p>
<p>[36]</p>
<p>Este dise√±o tambi√©n nos ofrece un sello en el c√≥digo para realizar</p>
<p>pruebas. Con un elemento FakeTransmitter , podemos probar las clases</p>
<p>CommunicationsController . Tambi√©n podemos crear pruebas de l√≠mite una</p>
<p>vez dise√±ada la API Transmitter para asegurarnos de que la utilizamos</p>
<p>correctamente.</p>
<h3 id="limites-limpios-151">L√≠mites limpios</h3>
<p>En los l√≠mites suceden cosas interesantes. Los cambios es una de ellas. Los</p>
<p>dise√±os de c√≥digo correctos acomodan los cambios sin necesidad de grandes</p>
<p>modificaciones. Cuando usamos c√≥digo que no controlamos, hay que prestar</p>
<p>especial atenci√≥n a proteger nuestra inversi√≥n y asegurarnos de que los</p>
<p>cambios futuros no son demasiado costosos. El c√≥digo en los l√≠mites requiere</p>
<p>una separaci√≥n evidente y pruebas que definan expectativas. Debemos evitar</p>
<p>que el c√≥digo conozca los detalles de terceros. Es m√°s aconsejable depender</p>
<p>de algo que controlemos que de algo que no controlemos, y menos todav√≠a si</p>
<p>nos controla. Los l√≠mites de terceros se gestionan gracias a la presencia de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>puntos m√≠nimos en el c√≥digo que hagan referencia a los mismos. Podemos</p>
<p>envolverlos como hicimos con Map o usar un adaptador para convertir nuestra</p>
<p>interfaz perfecta en la interfaz proporcionada. En cualquier caso, el c√≥digo se</p>
<p>lee mejor, promueve el uso coherente e interno en el l√≠mite y hay menos</p>
<p>puntos de mantenimiento cuando cambie el c√≥digo de terceros.</p>
<h3 id="bibliografia-152">Bibliograf√≠a</h3>
<p>[BeckTDD] Test Driven Development , Kent Beck, Addison-Wesley,</p>
<p>2003.</p>
<p>[GOF] Design Patterns: Elements of Reusable Object Oriented</p>
<p>Software , Gamma et al., Addison Wesley, 19%.</p>
<p>[WELC] Working Effectively with Legacy Code , Addison-Wesley,</p>
<p>2004.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="pruebas-de-unidad-153">Pruebas de unidad</h1>
<p>Nuestra profesi√≥n ha evolucionado mucho en los √∫ltimos 10 a√±os. En 1997</p>
<p>nadie hab√≠a o√≠do hablar del Desarrollo guiado por pruebas (DGP). Para la</p>
<p>mayor√≠a, las pruebas de unidad eran peque√±os fragmentos de c√≥digo</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>desechable que cre√°bamos para asegurarnos de que nuestros programas</p>
<p>funcionaban. Escrib√≠amos clases y m√©todos, y despu√©s c√≥digo ad hoc para</p>
<p>probarlos, lo que implicaba alg√∫n tipo de programa controlador que nos</p>
<p>permitiera interactuar manualmente con el programa que hab√≠amos escrito.</p>
<p>Recuerdo crear un programa de C++ para un sistema incrustado de</p>
<p>tiempo real a mediados de la d√©cada de 1990. El programa era un sencillo</p>
<p>temporizador con la siguiente firma:</p>
<p>void Timer::ScheduleCommand(Command* theCommand, int milliseconds)</p>
<p>La idea era sencilla; el m√©todo execute de Command se ejecutaba en un</p>
<p>nuevo subproceso tras el n√∫mero especificado de milisegundos. El problema</p>
<p>era c√≥mo probarlo. Confeccion√© un sencillo programa controlador que</p>
<p>escuchaba al teclado. Cada vez que se introduc√≠a un car√°cter, se programaba</p>
<p>un comando que escrib√≠a el mismo car√°cter cinco segundos despu√©s.</p>
<p>Introduje una r√≠tmica melod√≠a en el teclado y esper√© a que se reprodujera en</p>
<p>pantalla cinco segundos despu√©s:</p>
<p>¬´I... want-a-girl... just... like-the-girl-who-marr... ied... dear... old...</p>
<p>dad.¬ª</p>
<p>Incluso tarare√© la melod√≠a mientras pulsaba la tecla, y la volv√≠ a cantar</p>
<p>cuando aparecieron los puntos en la pantalla.</p>
<p>√âsa fue mi prueba. Cuando vi que funcionaba y se lo mostr√© a mis</p>
<p>compa√±eros, me deshice del c√≥digo de prueba.</p>
<p>Como he afirmado, nuestra profesi√≥n ha evolucionado mucho. Ahora</p>
<p>crear√≠a una prueba que garantizara el funcionamiento de hasta el m√°s m√≠nimo</p>
<p>detalle del c√≥digo. Aislar√≠a el c√≥digo del sistema operativo en lugar de</p>
<p>invocar las funciones est√°ndar de temporizaci√≥n. Las imitar√≠a para tener</p>
<p>control total sobre el tiempo. Programar√≠a comandos que definieran</p>
<p>indicadores Booleanos y avanzar√≠a el tiempo, para observar los indicadores y</p>
<p>asegurarme de que pasaran de false true al cambiar el tiempo al valor</p>
<p>correcto. Cuando superara una serie de pruebas, comprobar√≠a que fueran</p>
<p>adecuadas para todo el que tuviera que trabajar con el c√≥digo. Me asegurar√≠a</p>
<p>de comprobar las pruebas y el c√≥digo en el mismo paquete. S√≠, hemos</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>avanzado mucho, pero nos queda mucho por avanzar. Los movimientos Agile</p>
<p>y TDD han animado a muchos programadores a crear pruebas de unidad</p>
<p>automatizadas y cada vez son m√°s. Pero en esta alocada carrera por a√±adir</p>
<p>pruebas a nuestra disciplina, muchos programadores han pasado por alto dos</p>
<p>de los aspectos m√°s sutiles e importantes de dise√±ar pruebas de calidad.</p>
<h3 id="las-tres-leyes-del-dgp-154">Las tres leyes del DGP</h3>
<p>Todos sabemos que el DGP nos pide que primero creemos las pruebas de</p>
<p>unidad, antes que el c√≥digo de producci√≥n. Pero esa norma es s√≥lo la punta</p>
<p>[37]</p>
<p>del iceberg. Tenga en cuenta las tres siguientes leyes</p>
<p>Primera ley : No debe crear c√≥digo de producci√≥n hasta que haya creado</p>
<p>una prueba de unidad que falle.</p>
<p>Segunda ley : No debe crear m√°s de una prueba de unidad que baste</p>
<p>como fallida, y no compilar se considera un fallo.</p>
<p>Tercera ley : No debe crear m√°s c√≥digo de producci√≥n que el necesario</p>
<p>para superar la prueba de fallo actual.</p>
<p>Estas tres leyes generan un ciclo de unos 30 segundos de duraci√≥n. Las</p>
<p>pruebas y el c√≥digo de producci√≥n se crean de forma conjunta, las pruebas</p>
<p>unos segundos antes que el c√≥digo. Si trabajamos de esta forma, crearemos</p>
<p>decenas de pruebas al d√≠a, cientos al mes y miles al a√±o. Si trabajamos de esta</p>
<p>forma, las pruebas abarcar√°n todos los aspectos de nuestro c√≥digo de</p>
<p>producci√≥n. El tama√±o de dichas pruebas, que puede ser similar al del c√≥digo</p>
<p>de producci√≥n, puede suponer un problema de administraci√≥n.</p>
<h3 id="realizar-pruebas-limpias-155">Realizar pruebas limpias</h3>
<p>Hace unos a√±os me pidieron que dirigiera un equipo que hab√≠a decidido</p>
<p>expl√≠citamente que su c√≥digo de prueba no deb√≠a mantenerse con los mismos</p>
<p>est√°ndares de calidad que su c√≥digo de producci√≥n. Pod√≠an incumplir las</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>reglas en sus pruebas de unidad. La premisa era ¬´R√°pido y directo¬ª. No era</p>
<p>necesario que las variables tuvieran nombres adecuados, ni que las funciones</p>
<p>de prueba fueran breves y descriptivas. No era necesario que el c√≥digo de</p>
<p>prueba estuviera bien dise√±ado. Bastaba con que funcionara y abarcara el</p>
<p>c√≥digo de producci√≥n.</p>
<p>Puede que algunos lectores empaticen con esta decisi√≥n. Puede que en el</p>
<p>pasado creara el tipo de pruebas que cree para la clase Timer . Supone un gran</p>
<p>paso crear ese tipo de pruebas desechables a dise√±ar una suite de pruebas de</p>
<p>unidad automatizadas. Por ello, como el equipo que dirig√≠a, puede decidir que</p>
<p>pruebas incorrectas sea mejor que no tener pruebas.</p>
<p>Pero el equipo no se daba cuenta que tener pruebas incorrectas era igual o</p>
<p>peor que no tener prueba alguna. El problema es que las pruebas deben</p>
<p>cambiar de acuerdo a la evoluci√≥n del c√≥digo. Cuanto menos limpias sean,</p>
<p>m√°s dif√≠cil es cambiarlas. Cuando m√°s enrevesado sea el c√≥digo de prueba,</p>
<p>m√°s probabilidades de que dedique m√°s tiempo a a√±adir nuevas pruebas a la</p>
<p>suite que el empleado en crear el nuevo c√≥digo de producci√≥n. Al modificar</p>
<p>el c√≥digo de producci√≥n, las pruebas antiguas comienzan a fallar y el desastre</p>
<p>impide que las pruebas se superen, por lo que acaban por convertirse en un</p>
<p>obst√°culo interminable.</p>
<p>Entre versiones, aument√≥ el coste de mantener la suite de pruebas de mi</p>
<p>equipo. Acab√≥ por convertirse en la principal queja entre los desarrolladores.</p>
<p>Cuando los directores preguntaron sobre este aumento, los desarrolladores</p>
<p>culparon a las pruebas. Al final, se vieron obligados a descartar la suite de</p>
<p>pruebas completa.</p>
<p>Pero sin una suite de pruebas perdieron la posibilidad de garantizar el</p>
<p>funcionamiento esperado de los cambios en el c√≥digo. Sin una suite de</p>
<p>pruebas no pod√≠an asegurar que los cambios en una parte del sistema no</p>
<p>afectaran a otras diferentes. Los defectos aumentaron, lo que propici√≥ que</p>
<p>temieran realizar cambios. Dejaron de limpiar su c√≥digo de producci√≥n por</p>
<p>miedo a que los cambios fueran da√±inos. El c√≥digo de producci√≥n comenz√≥ a</p>
<p>corromperse. Al final, se quedaron sin pruebas, con un c√≥digo de producci√≥n</p>
<p>enmara√±ado y defectuoso, clientes frustrados y la sensaci√≥n de que su</p>
<p>esfuerzo les hab√≠a fallado.</p>
<p>En cierto modo ten√≠an raz√≥n. Su esfuerzo les hab√≠a fallado. Pero fue su</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>decisi√≥n de permitir que las pruebas fueran incorrectas lo que provoc√≥ el</p>
<p>fallo. Si hubieran empleado pruebas limpias, su esfuerzo no habr√≠a fallado.</p>
<p>Puedo afirmarlo con cierta seguridad porque he participado dirigido</p>
<p>muchos equipos que han tenido √©xito gracias a pruebas de unidad limpias.</p>
<p>La moraleja de la historia es sencilla: el c√≥digo de prueba es tan</p>
<p>importante como el de producci√≥n. No es un ciudadano de segunda. Requiere</p>
<p>concentraci√≥n, dise√±o y cuidado. Debe ser tan limpio como el c√≥digo de</p>
<p>producci√≥n.</p>
<h3 id="las-pruebas-propician-posibilidades-156">Las pruebas propician posibilidades</h3>
<p>Si sus pruebas no son limpias, las perder√°. Y sin ellas pierde lo mismo que</p>
<p>hace que su c√≥digo de producci√≥n sea flexible. S√≠, ha le√≠do bien. Las pruebas</p>
<p>de unidad son las que hacen que el c√≥digo sea flexible y se pueda mantener y</p>
<p>reutilizar. La raz√≥n es sencilla. Si tiene pruebas, no tendr√° miedo a realizar</p>
<p>cambios en el c√≥digo. Sin pruebas, cada cambio es un posible error.</p>
<p>Independientemente de la flexibilidad de su arquitectura, de la divisi√≥n del</p>
<p>dise√±o, sin pruebas tendr√° miedo a realizar cambios por la posibilidad de</p>
<p>a√±adir errores no detectados.</p>
<p>Pero con las pruebas ese miedo desaparece. Cuanto mayor sea el alcance</p>
<p>de sus pruebas, menos miedo tendr√°. Podr√° modificar el c√≥digo con total</p>
<p>impunidad, aunque su arquitectura no sea la mejor y el dise√±o sea mediocre.</p>
<p>Podr√° mejorar la arquitectura y el dise√±o sin miedo alguno.</p>
<p>Por tanto, disponer de una suite automatizada de pruebas de unidad que</p>
<p>cubran el c√≥digo de producci√≥n es la clave para mantener limpio el dise√±o y</p>
<p>la arquitectura. Las pruebas proporcionan las posibilidades, ya que permiten</p>
<p>el cambio.</p>
<p>Si sus pruebas no son limpias, la capacidad de modificar el c√≥digo se ver√°</p>
<p>limitada y perder√° la posibilidad de mejorar la estructura de dicho c√≥digo.</p>
<p>Cuanto menos limpias sean las pruebas, menos lo ser√° el c√≥digo. En √∫ltima</p>
<p>instancia perder√° las pruebas y el c√≥digo se corromper√°.</p>
<h3 id="pruebas-limpias-157">Pruebas limpias</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>¬øQu√© hace que una prueba sea limpia? Tres elementos: legibilidad,</p>
<p>legibilidad y legibilidad. La legibilidad es sin duda m√°s importante en las</p>
<p>pruebas de unidad que en el c√≥digo de producci√≥n. ¬øQu√© hace que una prueba</p>
<p>sea legible? Lo mismo que en el c√≥digo: claridad, simplicidad y densidad de</p>
<p>expresi√≥n. En una prueba debe decir mucho con el menor n√∫mero de</p>
<p>expresiones posible.</p>
<p>F√≠jese en el c√≥digo de FitNesse del Listado 9-1. Estas tres pruebas son</p>
<p>dif√≠ciles de entender y sin duda se pueden mejorar. Por un lado, hay mucho</p>
<p>c√≥digo duplicado [G5] en las invocaciones repetidas addPage</p>
<p>assertSubString Sobre todo, este c√≥digo se carga con detalles que</p>
<p>interfieren con la expresividad de la prueba.</p>
<p>Listado 9-1</p>
<p>SerializedPageResponderTest.java.</p>
<p>public void testGetPageHieratchyAsXml() throws Exception</p>
<p>crawler.addPage(root, PathParser.parse(‚ÄúPageOne‚Äù));</p>
<p>crawler.addPage(root, PathParser.parse(‚ÄúPageOne.ChildOne‚Äù));</p>
<p>crawler.addPage(root, PathParser.parse(‚ÄúPageTwo‚Äù));</p>
<p>request.setResource(‚Äúroot‚Äù);</p>
<p>request.addInput(‚Äútype‚Äù, ‚Äúpages‚Äù);</p>
<p>Responder responder = new SerializedPageResponder();</p>
<p>SimpleResponse response =</p>
<p>(SimpleResponse) responder.makeResponse(</p>
<p>new FitNesseContext(root), request);</p>
<p>String xml = response.getContent();</p>
<p>assertEquals(‚Äútext/xml‚Äù, response.getContentType());</p>
<p>assertSubString(‚Äú&lt;name&gt;PageOne&lt;/name&gt;‚Äù, xml);</p>
<p>assertSubString(‚Äú&lt;name&gt;PageTwo&lt;/name&gt;‚Äù, xml);</p>
<p>assertSubString(‚Äú&lt;name&gt;ChildOne&lt;/name&gt;‚Äù, xml);</p>
<p>public void testGetPageHieratchyAsXmlDoesntContainSymbolicLinks()</p>
<p>throws Exception</p>
<p>WikiPage pageOne = crawler.addPage(root, PathParser.parse(‚ÄúPageOne‚Äù));</p>
<p>crawler.addPage(root, PathParser.parse(‚ÄúPageOne.ChildOne‚Äù));</p>
<p>crawler.addPage(root, PathParser.parse(‚ÄúPageTwo‚Äù));</p>
<p>PageData data = pageOne.getData();</p>
<p>WikiPageProperties properties = data.getProperties();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>WikiPageProperty symLinks = properties.set(SymbolicPage.PROPERTY_NAME);</p>
<p>symLinks.set(‚ÄúSymPage‚Äù, ‚ÄúPageTwo‚Äù);</p>
<p>pageOne.commit(data);</p>
<p>request.setResource(‚Äúroot‚Äù);</p>
<p>request.addInput(‚Äútype‚Äù, ‚Äúpages‚Äù);</p>
<p>Responder responder = new SerializedPageResponder();</p>
<p>SimpleResponse response =</p>
<p>(SimpleResponse) responder.makeResponse(</p>
<p>new FitNesseContext(root), request);</p>
<p>String xml = response.getContent();</p>
<p>assertEquals(‚Äútext/xml‚Äù, response.getContentType());</p>
<p>assertSubString(‚Äú&lt;name&gt;PageOne&lt;/name&gt;‚Äù, xml);</p>
<p>assertSubString(‚Äú&lt;name&gt;PageTwo&lt;/name&gt;‚Äù, xml);</p>
<p>assertSubString(‚Äú&lt;name&gt;ChildOne&lt;/name&gt;‚Äù, xml);</p>
<p>assertNotSubString(‚ÄúSymPage‚Äù, xml);</p>
<p>public void testGetDataAsHtml() throws Exception</p>
<p>crawler.addPage(root, PathParser.parse(‚ÄúTestPageOne‚Äù), ‚Äútest page‚Äù);</p>
<p>request.setResource(‚ÄúTestPageOne‚Äù);</p>
<p>request.addInput(‚Äútype‚Äù, ‚Äúdata‚Äù);</p>
<p>Responder responder = new SerializedPageResponder();</p>
<p>SimpleResponse response =</p>
<p>(SimpleResponse) responder.makeResponse(</p>
<p>new FitNesseContext(root), request);</p>
<p>String xml = response.getContent();</p>
<p>assertEquals(‚Äútext/xml‚Äù, response.getContentType());</p>
<p>assertSubString(‚Äútest page‚Äù, xml);</p>
<p>assertSubString(‚Äú&lt;Test‚Äù, xml);</p>
<p>F√≠jese en las invocaciones de PathParser . Transforman cadenas en</p>
<p>instancias de PagePath usadas por las ara√±as. Esta transformaci√≥n es</p>
<p>totalmente irrelevante para la prueba y √∫nicamente complica su cometido.</p>
<p>Los detalles circundantes a la creaci√≥n del respondedor y la obtenci√≥n y</p>
<p>conversi√≥n de la respuesta tambi√©n sobran. Tambi√©n la forma de crear la</p>
<p>URL de solicitud a partir de un recurso y un argumento (contribu√≠ a crear este</p>
<p>c√≥digo, por lo que tengo todo el derecho a criticarlo).</p>
<p>Al final, el c√≥digo no se ha dise√±ado de forma legible. El lector se ve</p>
<p>rodeado de miles de detalles que debe comprender antes de que las pruebas</p>
<p>tengan sentido.</p>
<p>F√≠jese ahora en las pruebas mejoradas del Listado 9-2. Hacen</p>
<p>exactamente lo mismo, pero se han refactorizado de forma m√°s clara y</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>descriptiva.</p>
<p>Listado 9-2</p>
<p>SerializedPageResponderTest.java (refactorizado)</p>
<p>public void testGetPageHierarchyAsXml() throws Exception {</p>
<p>makePages(‚ÄúPageOne‚Äù, ‚ÄúPageOne.ChildOne‚Äù, ‚ÄúPageTwo‚Äù);</p>
<p>submitRequest(‚Äúroot‚Äù, ‚Äútype:pages‚Äù);</p>
<p>assertResponseIsXML();</p>
<p>assertResponseContains(</p>
<p>‚Äú&lt;name&gt;PageOne&lt;/name&gt;‚Äù, ‚Äú&lt;name&gt;PageTwo&lt;/name&gt;‚Äù, ‚Äú&lt;name&gt;ChildOne&lt;/name&gt;‚Äù</p>
<p>);</p>
<p>public void testSymbolicLinksAreNotInXmlPageHierarchy() throws Exception {</p>
<p>WikiPage page = makePage(‚ÄúPageOne‚Äù);</p>
<p>makePages(‚ÄúPageOne.ChildOne‚Äù, ‚ÄúPageTwo‚Äù);</p>
<p>addLinkTo(page, ‚ÄúPageTwo‚Äù, ‚ÄúSymPage‚Äù);</p>
<p>submitRequest(‚Äúroot‚Äù, ‚Äútype:pages‚Äù);</p>
<p>assertResponseIsXML();</p>
<p>assertResponseContains(</p>
<p>‚Äú&lt;name&gt;PageOne&lt;/name&gt;‚Äù, ‚Äú&lt;name&gt;PageTwo&lt;/name&gt;‚Äù, ‚Äú&lt;name&gt;ChildOne&lt;/name&gt;‚Äù</p>
<p>);</p>
<p>assertResponseDoesNotContain(‚ÄúSymPage‚Äù);</p>
<p>public void testGetDataAsXml() throws Exception {</p>
<p>makePageWithContent(‚ÄúTestPageOne‚Äù, ‚Äútest page‚Äù);</p>
<p>submitRequest(‚ÄúTestPageOne‚Äù, ‚Äútype:data‚Äù);</p>
<p>assertResponseIsXML();</p>
<p>assertResponseContains(‚Äútest page‚Äù, ‚Äú&lt;Test‚Äù);</p>
<p>[38]</p>
<p>El patr√≥n Generar-Operar-Comprobar es evidente en la estructura de</p>
<p>las pruebas. Cada una se divide claramente en tres partes. La primera crea los</p>
<p>datos de prueba, la segunda opera en dichos datos y la tercera comprueba que</p>
<p>la operaci√≥n devuelva los resultados esperados.</p>
<p>Comprobar√° que se ha eliminado gran parte de los detalles molestos. Las</p>
<p>pruebas son concisas y s√≥lo usan los tipos de datos y funciones que realmente</p>
<p>necesitan. Todo el que lea estas pruebas sabr√° r√°pidamente para qu√© sirven y</p>
<p>no se perder√° entre detalles irrelevantes.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="lenguaje-de-pruebas-especifico-del-dominio-158">Lenguaje de pruebas espec√≠fico del dominio</h3>
<p>Las pruebas del Listado 9-2 ilustran la creaci√≥n de un lenguaje espec√≠fico del</p>
<p>dominio para sus pruebas. En lugar de usar las API que los programadores</p>
<p>emplean para manipular el sistema, creamos una serie de funciones</p>
<p>utilidades que usan dichas API y que facilitan la escritura y la lectura de las</p>
<p>pruebas. Estas funciones y utilidades se convierten en una API especializada</p>
<p>usada por las pruebas. Son un lenguaje de pruebas que los programadores</p>
<p>usan personalmente para crear sus pruebas y para ayudar a los que despu√©s</p>
<p>las lean.</p>
<p>Esta API de pruebas no se dise√±a con antelaci√≥n, sino que evoluciona con</p>
<p>la refactorizaci√≥n continuada del c√≥digo de prueba. Al igual que</p>
<p>refactorizamos el Listado 9-1 en el Listado 9-2, los programadores</p>
<p>disciplinados refactorizan su c√≥digo de prueba en versiones m√°s sucintas y</p>
<p>expresivas.</p>
<h3 id="un-estandar-dual-159">Un est√°ndar dual</h3>
<p>En un sentido, el equipo que mencionamos antes ten√≠a raz√≥n. El c√≥digo de la</p>
<p>API de pruebas tiene un conjunto de est√°ndares de ingenier√≠a diferentes al</p>
<p>c√≥digo de producci√≥n. Tambi√©n tiene que ser sencillo, sucinto y expresivo,</p>
<p>pero no tan eficaz como el c√≥digo de producci√≥n. Despu√©s de todo, se ejecuta</p>
<p>en un entorno de prueba, no de producci√≥n, y cada entorno tiene sus propias</p>
<p>necesidades.</p>
<p>F√≠jese en la prueba del Listado 9-3. La cre√© como parte de un prototipo de</p>
<p>sistema de control medioambiental. Sin entrar en detalles, se aprecia que esta</p>
<p>prueba comprueba que la alarma de baja temperatura, el calentador y el fuelle</p>
<p>est√©n activados cuando la temperatura sea demasiado fr√≠a.</p>
<p>Listado 9-3</p>
<p>EnvironmentControllerTest.java</p>
<p>@Test</p>
<p>public void turnOnLoTempAlarmAtThreashold() throws Exception {</p>
<p>hw.setTemp(WAY_TOO_COLD);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>controller.tic();</p>
<p>assertTrue(hw.heaterState());</p>
<p>assertTrue(hw.blowerState());</p>
<p>assertFalse(hw.coolerState());</p>
<p>assertFalse(hw.hiTempAlarm());</p>
<p>assertTrue(hw.loTempAlarm());</p>
<p>Aqu√≠ hay muchos detalles. Por ejemplo, ¬øpara qu√© sirve la funci√≥n tic</p>
<p>De hecho, la ignorar√≠a mientras leemos esta prueba. Intente centrarse en saber</p>
<p>si est√° de acuerdo en que el estado final del sistema tiene que ver con que la</p>
<p>temperatura sea demasiado baja.</p>
<p>Al leer la prueba, la vista tiene que cambiar entre el nombre del estado</p>
<p>comprobado y el sentido del estado comprobado. Vemos heaterState</p>
<p>despu√©s la vista salta a assertTrue . Vemos coolerState y nos fijamos en</p>
<p>assertFalse . Resulta tedioso y dificulta la lectura de la prueba.</p>
<p>He conseguido mejorar la legibilidad de la prueba transform√°ndola en el</p>
<p>Listado 9-4.</p>
<p>Listado 9-4</p>
<p>EnvironmentControllerTest.java (refactorizado)</p>
<p>@Test</p>
<p>public void turnOnLoTempAlarmAtThreshold() throws Exception {</p>
<p>wayTooCold();</p>
<p>assertEquals(‚ÄúHBchL‚Äù, hw.getState());</p>
<p>Evidentemente, he ocultado el detalle de la funci√≥n tic creando una</p>
<p>funci√≥n wayTooCold Pero lo importante es la extra√±a cadena de</p>
<p>assertEquals Las may√∫sculas significan activado las min√∫sculas</p>
<p>desactivado, y las letras siempre aparece en este orden: {heater, blower,</p>
<p>cooler, hi-temp-alarm, lo-temp-alarm}</p>
<p>Aunque pr√°cticamente sea un incumplimiento de las reglas de asignaci√≥n</p>
<p>[39]</p>
<p>mental en este caso parece apropiado. Una vez que conocemos el</p>
<p>significado, la vista pasa por la cadena y podemos interpretar los resultados.</p>
<p>La lectura de la prueba es casi un placer. F√≠jese en el Listado 9-5 y</p>
<p>compruebe con qu√© facilidad entiende las pruebas.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Listado 9-5</p>
<p>EnvironmentControllerTest.java (una selecci√≥n mayor).</p>
<p>@Test</p>
<p>public void turnOnCoolerAndBlowerIfTooHot() throws Exception {</p>
<p>tooHot();</p>
<p>assertEquals(‚ÄúhBChl‚Äù, hw.getState());</p>
<p>@Test</p>
<p>public void turnOnHeaterAndBlowerIfTooCold() throws Exception {</p>
<p>tooCold();</p>
<p>assertEquals(‚ÄúHBchl‚Äù, hw.getState());</p>
<p>@Test</p>
<p>public void turnOnHiTempAlarmAtThreshold() throws Exception {</p>
<p>wayTooHot();</p>
<p>assertEquals(‚ÄúhBCHL‚Äù, hw.getState());</p>
<p>@Test</p>
<p>public void turnOnLoTempAlarmAtThreshold() throws Exception {</p>
<p>wayTooCold();</p>
<p>assertEquals(‚ÄúHBchL‚Äù, hw.getState());</p>
<p>La funci√≥n getState se reproduce en el Listado 9-6. No es un c√≥digo</p>
<p>muy eficaz. Para que lo sea, deber√≠amos haber usado StringBuffer</p>
<p>Listado 9-6</p>
<p>MockControlHardware.java.</p>
<p>public String getState() {</p>
<p>String state = ‚Äú‚Äù;</p>
<p>state += heater ? ‚ÄúH‚Äù : ‚Äúh‚Äù;</p>
<p>state += blower ? ‚ÄúB‚Äù : ‚Äúb‚Äù;</p>
<p>state += cooler ? ‚ÄúC‚Äù : ‚Äúc‚Äù;</p>
<p>state += hiTempAlarm ? ‚ÄúH‚Äù : ‚Äúh‚Äù;</p>
<p>state += loTempAlarm ? ‚ÄúL‚Äù : ‚Äúl‚Äù;</p>
<p>return state;</p>
<p>StringBuffer es poco atractivo. Incluso en c√≥digo de producci√≥n, intento</p>
<p>evitarlo si el coste es m√≠nimo, como podr√≠a suceder en el Listado 9-6. Pero</p>
<p>esta aplicaci√≥n es claramente un sistema incrustado en tiempo real y es</p>
<p>probable que los recursos del equipo y la memoria est√©n limitados. Sin</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>embargo, el entorno de pruebas es improbable que lo est√©. Es la naturaleza</p>
<p>del est√°ndar dual. Hay cosas que nunca har√≠a en un entorno de producci√≥n</p>
<p>totalmente v√°lidas para un entorno de prueba. Suelen ser problemas de</p>
<p>memoria o eficacia de la CPU, pero nunca problemas de limpieza.</p>
<h3 id="una-afirmacion-por-prueba-160">Una afirmaci√≥n por prueba</h3>
<p>[40]</p>
<p>Existe una escuela de pensamiento que afirma que todas las funciones de</p>
<p>prueba de una prueba JUnit s√≥lo deben tener una instrucci√≥n de afirmaci√≥n.</p>
<p>Puede parecer una regla draconiana pero la ventaja se aprecia en el Listado 9-</p>
<ul>
<li>Las pruebas llegan a una misma conclusi√≥n, que se entiende de forma</li>
</ul>
<p>r√°pida y sencilla.</p>
<p>¬øPero qu√© sucede con el Listado 9-2? No parece razonable afirmar que el</p>
<p>resultado es XML y que contiene determinadas subcadenas. Sin embargo,</p>
<p>podemos dividir la prueba en dos, cada una con una afirmaci√≥n concreta,</p>
<p>como se muestra en el Listado 9-7.</p>
<p>Listado 9-7</p>
<p>SerializedPageResponderTest.java (una sola afirmaci√≥n).</p>
<p>public void testGetPageHierarchyAsXml() throws Exception {</p>
<p>givenPages(‚ÄúPageOne‚Äù, ‚ÄúPageOne.ChildOne‚Äù, ‚ÄúPageTwo‚Äù);</p>
<p>whenRequestIsIssued(‚Äúroot‚Äù, ‚Äútype:pages‚Äù);</p>
<p>thenResponseShouldBeXML();</p>
<p>public void testGetPageHierarchyHasRightTags() throws Exception {</p>
<p>givenPages(‚ÄúPageOne‚Äù, ‚ÄúPageOne.ChildOne‚Äù, ‚ÄúPageTwo‚Äù);</p>
<p>whenRequestIsIssued(‚Äúroot‚Äù, ‚Äútype:pages‚Äù);</p>
<p>thenResponseShouldContain(</p>
<p>‚Äú&lt;name&gt;PageOne&lt;/name&gt;‚Äù, ‚Äú&lt;name&gt;PageTwo&lt;/name&gt;‚Äù, ‚Äú&lt;name&gt;ChildOne&lt;/name&gt;‚Äù</p>
<p>);</p>
<p>He cambiado los nombres de las funciones para usar la convenci√≥n dado-</p>
<p>[41]</p>
<p>cuando-entonces . De este modo las pruebas son m√°s f√°ciles de leer.</p>
<p>Desafortunadamente, al dividir las pruebas se genera c√≥digo duplicado.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Podemos eliminar los duplicados por medio del patr√≥n M√©todo de</p>
<p>[42]</p>
<p>plantilla e incluir las partes dado/cuando en la clase base, y las partes</p>
<p>entonces en derivaciones diferentes. O podr√≠amos crear una clase de prueba</p>
<p>independiente e incluir las partes dado cuando en la funci√≥n @Before y las</p>
<p>partes entonces en cada funci√≥n @Test . Pero parece un mecanismo excesivo</p>
<p>para un problema tan menor. Al final, opto por las afirmaciones m√∫ltiples del</p>
<p>Listado 9-2. Considero que la regla de una sola afirmaci√≥n es una directriz</p>
<p>[43]</p>
<p>adecuada . Siempre intento crear un lenguaje de pruebas espec√≠fico del</p>
<p>dominio que la complemente, como en el Listado 9-5, pero no rechazo incluir</p>
<p>m√°s de una afirmaci√≥n en una prueba. Creo que lo mejor que podemos decir</p>
<p>es que el n√∫mero de afirmaciones de una prueba debe ser m√≠nimo.</p>
<h3 id="un-solo-concepto-por-prueba-161">Un solo concepto por prueba</h3>
<p>Puede que una regla m√°s indicada sea probar un √∫nico concepto en cada</p>
<p>funci√≥n de prueba. No queremos extensas funciones que prueben una cosa</p>
<p>diferente tras otra, como sucede en el Listado 9-8. Esta prueba deber√≠a</p>
<p>dividirse en tres diferentes que probaran tres cosas distintas. Al combinarlas</p>
<p>en la misma funci√≥n se obliga al lector a determinar por qu√© cada secci√≥n se</p>
<p>ubica en ese punto y qu√© prueba dicha secci√≥n.</p>
<p>Listado 9-8</p>
<p>/**</p>
<ul>
<li>Varias pruebas para el m√©todo addMonths().</li>
</ul>
<p>*/</p>
<p>public void testAddMonths() {</p>
<p>SerialDate d1 = SerialDate.createInstance(31, 5, 2004);</p>
<p>SerialDate d2 = SerialDate.addMonths(1, d1);</p>
<p>assertEquals(30, d2.getDayOfMonth());</p>
<p>assertEquals(6, d2.getMonth());</p>
<p>assertEquals(2004, d2.getYYYY());</p>
<p>SerialDate d3 = SerialDate.addMonths(2, d1);</p>
<p>assertEquals(31, d3.getDayOfMonth());</p>
<p>assertEquals(7, d3.getMonth());</p>
<p>assertEquals(2004, d3.getYYYY());</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>SerialDate d4 = SerialDate.addMonths(1, SerialDate.addMonths(1, d1));</p>
<p>assertEquals(30, d4.getDayOfMonth());</p>
<p>assertEquals(7, d4.getMonth());</p>
<p>assertEquals(2004, d4.getYYYY());</p>
<p>Las tres funciones deber√≠an ser las siguientes:</p>
<p>Dado el √∫ltimo d√≠a de un mes con 31 d√≠as (como mayo):</p>
<ul>
<li>Cuando se a√±ade un mes, si el √∫ltimo d√≠a de ese mes es el 30 (como</li>
</ul>
<p>en junio), entonces la fecha debe ser el d√≠a 30 de ese mes, no el 31.</p>
<ul>
<li>Cuando se a√±aden dos meses a esa fecha, si el √∫ltimo mes tiene 31</li>
</ul>
<p>d√≠as, entonces la fecha debe ser el d√≠a 31.</p>
<p>Dado el √∫ltimo d√≠a de un mes con 30 d√≠as (como junio):</p>
<ul>
<li>Cuando se a√±ade, si el √∫ltimo d√≠a de ese mes tiene 31 d√≠as, entonces</li>
</ul>
<p>la fecha debe ser el 30, no el 31.</p>
<p>Expresado de esta forma, se aprecia que existe una regla general entre las</p>
<p>distintas pruebas. Al incrementar el mes, la fecha no puede ser mayor que su</p>
<p>√∫ltimo d√≠a. Esto implica que al incrementar el mes en el 28 de febrero debe</p>
<p>generarse el 28 de marzo. Falta esa prueba y convendr√≠a que la escribi√©ramos.</p>
<p>As√≠ pues, no son las m√∫ltiples afirmaciones del Listado 9-8 las causantes</p>
<p>del problema, sino el hecho de que se prueba m√°s de un concepto.</p>
<p>Probablemente la regla √≥ptima sea minimizar el n√∫mero de activos por</p>
<p>concepto y probar un solo concepto por funci√≥n de prueba.</p>
<p>[44]</p>
<h3 id="first-162">F.I.R.S.T.</h3>
<p>Las pruebas limpias siguen otras cinco reglas, cuyas iniciales forman las</p>
<p>siglas FIRST en ingl√©s:</p>
<p>Rapidez Fast ): Las reglas deben ser r√°pidas y ejecutarse de forma</p>
<p>r√°pida. Si lo hacen lentamente, no las ejecutar√° con frecuencia. Al no hacerlo,</p>
<p>no detectar√° los problemas con la suficiente antelaci√≥n como para</p>
<p>solucionarlos. No se sentir√° con libertad para limpiar el c√≥digo, que acabar√°</p>
<p>corrompi√©ndose.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Independencia Independent ): Las pruebas no deben depender entre</p>
<p>ellas. Una prueba no debe establecer condiciones para la siguiente. Debe</p>
<p>poder ejecutar cada prueba de forma independiente y en el orden que desee.</p>
<p>Si las pruebas dependen unas de otras, la primera que falle provocar√° una</p>
<p>sucesi√≥n de fallos, dificultar√° el diagn√≥stico y ocultar√° efectos posteriores.</p>
<p>Repetici√≥n Repeatable ): Las pruebas deben poder repetirse en cualquier</p>
<p>entorno. Debe poder ejecutarlas en el entorno de producci√≥n, en el de calidad</p>
<p>y en su port√°til de camino a casa en un tren sin red. Si no puede repetir las</p>
<p>pruebas en cualquier entorno, siempre tendr√° una excusa de su fallo. Tambi√©n</p>
<p>ver√° que no puede ejecutar las pruebas si el entorno no est√° disponible.</p>
<p>Validaci√≥n autom√°tica Self-Validating ): Las pruebas deben tener un</p>
<p>resultado booleano: o aciertan o fallan. No debe tener que leer un extenso</p>
<p>archivo de registro para saber si una prueba ha acertado, ni comparar</p>
<p>manualmente dos archivos de texto distintos para ello. Si las pruebas no se</p>
<p>validan autom√°ticamente, el fallo puede ser subjetivo y la ejecuci√≥n de las</p>
<p>pruebas puede requerir una extensa evaluaci√≥n manual.</p>
<p>Puntualidad Timely ): Las pruebas deben crearse en el momento preciso:</p>
<p>antes del c√≥digo de producci√≥n que hace que acierten. Si crea las pruebas</p>
<p>despu√©s del c√≥digo de producci√≥n, puede que resulte dif√≠cil probarlo. Puede</p>
<p>decidir qu√© parte del c√≥digo de producci√≥n sea demasiado dif√≠cil de probar.</p>
<p>No dise√±e c√≥digo de producci√≥n que no se pueda probar.</p>
<h3 id="conclusion-163">Conclusi√≥n</h3>
<p>Apenas hemos abordado la superficie de este tema. De hecho, se podr√≠a crear</p>
<p>un libro entero sobre pruebas limpias. Las pruebas son tan importantes para la</p>
<p>salud de un proyecto como el c√≥digo de producci√≥n. Puede que incluso m√°s,</p>
<p>ya que conservan y mejoran la flexibilidad, capacidad de mantenimiento y</p>
<p>reutilizaci√≥n del c√≥digo de producci√≥n. Por ello, intente que sean limpias.</p>
<p>Trabaje para que resulten expresivas y concisas. Invente API de prueba que</p>
<p>act√∫en como lenguaje espec√≠fico del dominio que le ayude a crear las</p>
<p>pruebas.</p>
<p>Si deja que las pruebas se corrompan, suceder√° lo mismo con el c√≥digo de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>producci√≥n. Mantenga limpias las pruebas.</p>
<h3 id="bibliografia-164">Bibliograf√≠a</h3>
<p>[RSpec] RSpec: Behavior Driven Development for Ruby Programmers</p>
<p>Aslak Hellesay, David Chelimsky, Pragmatic Bookshelf, 2008.</p>
<p>[GOF] Design Patterns: Elements of Reusable Object Oriented</p>
<p>Software , Gamma et al., Addison-Wesley, 1996.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="clases-165">Clases</h1>
<p>con Jeff Langr</p>
<p>Hasta ahora nos hemos centrado en escribir bien l√≠neas y bloques de c√≥digo.</p>
<p>Nos hemos adentrado en la correcta composici√≥n de las funciones y en su</p>
<p>interrelaci√≥n. Pero a pesar de la atenci√≥n dedicada a la expresividad de las</p>
<p>instrucciones y las funciones, no tendremos c√≥digo limpio hasta que nos</p>
<p>fijemos en los niveles superiores de su organizaci√≥n. Hablemos sobre clases.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="organizacion-de-clases-166">Organizaci√≥n de clases</h3>
<p>De acuerdo a la convenci√≥n est√°ndar de Java, una clase debe comenzar con</p>
<p>una lista de variables. Las constantes est√°ticas p√∫blicas, si existen, deben</p>
<p>aparecer primero. Tras ello, las variables est√°ticas privadas y despu√©s las</p>
<p>variables de instancia privadas. No suele ser necesario usar variables</p>
<p>p√∫blicas.</p>
<p>Las funciones p√∫blicas deben seguir a la lista de variables. Incluimos las</p>
<p>utilidades p√∫blicas invocadas por una funci√≥n p√∫blica tras la propia funci√≥n</p>
<p>p√∫blica. Este sistema cumple la regla descendente y permite que el programa</p>
<p>se lea como un art√≠culo de peri√≥dico.</p>
<h3 id="encapsulacion-167">Encapsulaci√≥n</h3>
<p>Queremos que nuestras variables y funciones de utilidad sean privadas, pero</p>
<p>no es imprescindible. En ocasiones podemos proteger una variable o funci√≥n</p>
<p>de utilidad para que sea accesible para una prueba. Las reglas mandan. Si una</p>
<p>regla del mismo paquete tiene que invocar una funci√≥n o acceder a una</p>
<p>variable, hacemos que tenga √°mbito protected o de paquete. Sin embargo,</p>
<p>primero veremos una forma de mantener la privacidad. La relajaci√≥n de la</p>
<p>encapsulaci√≥n siempre es un √∫ltimo resorte.</p>
<h3 id="las-clases-deben-ser-de-tamano-reducido-168">Las clases deben ser de tama√±o reducido</h3>
<p>La primera regla de las clases es que deben ser de tama√±o reducido. La</p>
<p>segunda regla es que deben ser todav√≠a m√°s reducidas. No, no vamos a repetir</p>
<p>el mismo texto en el cap√≠tulo sobre las funciones, pero como sucede con las</p>
<p>funciones, el tama√±o reducido es lo principal a la hora de dise√±ar una clase. Y</p>
<p>la pregunta inmediata es qu√© nivel de reducci√≥n. Con las funciones medimos</p>
<p>el tama√±o contando l√≠neas f√≠sicas. Con las clases usamos otra medida distinta:</p>
<p>[45]</p>
<p>las responsabilidades</p>
<p>El Listado 10-1 muestra una clase, SuperDashboard , que muestra 70</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>m√©todos p√∫blicos. Muchos programadores estar√°n de acuerdo en que es un</p>
<p>tama√±o excesivo. Algunos denominar√≠an a SuperDashboard una clase Dios.</p>
<p>Listado 10-1</p>
<p>Demasiadas responsabilidades.</p>
<p>public class SuperDashboard extends JFrame implements MetaDataUser</p>
<p>public String getCustomizerLanguagePath()</p>
<p>public void setSystemConfigPath(String systemConfigPath)</p>
<p>public String getSystemConfigDocument()</p>
<p>public void setSystemConfigDocument(String systemConfigDocument)</p>
<p>public boolean getGuruState()</p>
<p>public boolean getNoviceState()</p>
<p>public boolean getOpenSourceState()</p>
<p>public void showObject(MetaObject object)</p>
<p>public void showProgress(String s)</p>
<p>public boolean isMetadataDirty()</p>
<p>public void setIsMetadataDirty(boolean isMetadataDirty)</p>
<p>public Component getLastFocusedComponent()</p>
<p>public void setLastFocused(Component lastFocused)</p>
<p>public void setMouseSelectState(boolean isMouseSelected)</p>
<p>public boolean isMouseSelected()</p>
<p>public LanguageManager getLanguageManager()</p>
<p>public Project getProject()</p>
<p>public Project getFirstProject()</p>
<p>public Project getLastProject()</p>
<p>public String getNewProjectName()</p>
<p>public void setComponentSizes(Dimension dim)</p>
<p>public String getCurrentDir()</p>
<p>public void setCurrentDir(String newDir)</p>
<p>public void updateStatus(int dotPos, int markPos)</p>
<p>public Class[] getDataBaseClasses()</p>
<p>public MetadataFeeder getMetadataFeeder()</p>
<p>public void addProject(Project project)</p>
<p>public boolean setCurrentProject(Project project)</p>
<p>public boolean removeProject(Project project)</p>
<p>public MetaProjectHeader getProgramMetadata()</p>
<p>public void resetDashboard()</p>
<p>public Project loadProject(String fileName, String projectName)</p>
<p>public void setCanSaveMetadata(boolean canSave)</p>
<p>public MetaObject getSelectedObject()</p>
<p>public void deselectObjects()</p>
<p>public void setProject(Project project)</p>
<p>public void editorAction(String actionName, ActionEvent event)</p>
<p>public void setMode(int mode)</p>
<p>public FileManager getFileManager()</p>
<p>public void setFileManager(FileManager fileManager)</p>
<p>public ConfigManager getConfigManager()</p>
<p>public void setConfigManager(ConfigManager configManager)</p>
<p>public ClassLoader getClassLoader()</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public void setClassLoader(ClassLoader classLoader)</p>
<p>public Properties getProps()</p>
<p>public String getUserHome()</p>
<p>public String getBaseDir()</p>
<p>public int getMajorVersionNumber()</p>
<p>public int getMinorVersionNumber()</p>
<p>public int getBuildNumber()</p>
<p>public MetaObject pasting(</p>
<p>MetaObject target, MetaObject pasted, MetaProject project)</p>
<p>public void processMenuItems(MetaObject metaObject)</p>
<p>public void processMenuSeparators(MetaObject metaObject)</p>
<p>public void processTabPages(MetaObject metaObject)</p>
<p>public void processPlacement(MetaObject object)</p>
<p>public void processCreateLayout(MetaObject object)</p>
<p>public void updateDisplayLayer(MetaObject object, int layerIndex)</p>
<p>public void propertyEditedRepaint(MetaObject object)</p>
<p>public void processDeleteObject(MetaObject object)</p>
<p>public boolean getAttachedToDesigner()</p>
<p>public void processProjectChangedState(boolean hasProjectChanged)</p>
<p>public void processObjectNameChanged(MetaObject object)</p>
<p>public void runProject()</p>
<p>public void setAllowDragging(boolean allowDragging)</p>
<p>public boolean allowDragging()</p>
<p>public boolean isCustomizing()</p>
<p>public void setTitle(String title)</p>
<p>public IdeMenuBar getIdeMenuBar()</p>
<p>public void showHelper(MetaObject metaObject, String propertyName)</p>
<p>//... y otros muchos m√©todos no p√∫blicos...</p>
<p>¬øY si SuperDashboard s√≥lo incluyera los m√©todos mostrados en el</p>
<p>Listado 10-2?</p>
<p>Listado 10-2</p>
<p>¬øSuficientemente reducido?</p>
<p>public class SuperDashboard extends JFrame implements MetaDataUser</p>
<p>public Component getLastFocusedComponent()</p>
<p>public void setLastFocused(Component lastFocused)</p>
<p>public int getMajorVersionNumber()</p>
<p>public int getMinorVersionNumber()</p>
<p>public int getBuildNumber()</p>
<p>Cinco m√©todos no es demasiado, ¬øverdad? En este caso s√≠ ya que a pesar</p>
<p>del reducido n√∫mero de m√©todos, SuperDashboard tambi√©n tiene demasiadas</p>
<p>responsabilidades.</p>
<p>El nombre de una clase debe describir las responsabilidades que</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>desempe√±a. De hecho, el nombre es la primera forma para determinar el</p>
<p>tama√±o de una clase. Si no podemos derivar un nombre conciso para una</p>
<p>clase, seguramente sea demasiado extenso. Cuanto m√°s ambiguo sea el</p>
<p>nombre de la clase, m√°s probabilidades hay de que tenga demasiadas</p>
<p>responsabilidades. Por ejemplo, los nombres de clase con palabras como</p>
<p>Processor Manager Super suelen indicar una desafortunada acumulaci√≥n</p>
<p>de responsabilidades.</p>
<p>Tambi√©n debemos ser capaces de escribir una breve descripci√≥n de la</p>
<p>clase en unas 25 palabras, sin usar las palabras ¬´ si ¬ª, ¬´ ¬ª, ¬´ ¬ª o ¬´ pero ¬ª.</p>
<p>¬øC√≥mo describir√≠amos SuperDashboard ?: SuperDashboard permite acceder</p>
<p>al componente con el enfoque y nos permite controlar los n√∫meros de versi√≥n</p>
<p>producto. El primer indica que SuperDashboard tiene demasiadas</p>
<p>responsabilidades.</p>
<h3 id="el-principio-de-responsabilidad-unica-169">El Principio de responsabilidad √∫nica</h3>
<p>El Principio de responsabilidad √∫nica ( Single Responsibility Principle , SRP)</p>
<p>[46]</p>
<p>indica que una clase o m√≥dulo debe tener uno y s√≥lo un motivo para</p>
<p>cambiar. Este principio nos indica la definici√≥n de responsabilidad y una</p>
<p>directriz para el tama√±o de la clase. Las clases s√≥lo deben tener una</p>
<p>responsabilidad, un motivo para cambiar. La clase SuperDashboard</p>
<p>aparentemente reducida del Listado 10-2 tiene dos motivos para cambiar.</p>
<p>Primero, controla informaci√≥n de versi√≥n que supuestamente debe</p>
<p>actualizarse cada vez que se comercialice el software . Por otra parte, gestiona</p>
<p>componentes de Java Swing (un derivado de JFrame, la representaci√≥n Swing</p>
<p>de una ventana de IGU de nivel superior). Sin duda, querremos cambiar el</p>
<p>n√∫mero de versi√≥n si cambiamos el c√≥digo Swing, pero lo contrario no es</p>
<p>necesario: podr√≠amos cambiar la informaci√≥n de versi√≥n en funci√≥n de los</p>
<p>cambios de otro c√≥digo del sistema. La identificaci√≥n de responsabilidades</p>
<p>(los motivos del cambio) nos permite reconocer y mejorar las abstracciones</p>
<p>en nuestro c√≥digo. Podemos extraer los tres m√©todos de SuperDashboard</p>
<p>relacionados con la informaci√≥n de versiones en una clase independiente</p>
<p>como Version (v√©ase el Listado 10-3.) La clase Version es una construcci√≥n</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>que se puede reutilizar en otras aplicaciones.</p>
<p>Listado 10-3</p>
<p>Una clase con una √∫nica responsabilidad.</p>
<p>public class Version {</p>
<p>public int getMajorVersionNumber()</p>
<p>public int getMinorVersionNumber()</p>
<p>public int getBuildNumber()</p>
<p>SRP es uno de los conceptos m√°s importantes del dise√±o orientado a</p>
<p>objetos y tambi√©n uno de los m√°s sencillos de entender y cumplir, pero</p>
<p>tambi√©n es uno de los que m√°s se abusa al dise√±ar clases. Habitualmente nos</p>
<p>encontramos clases que hacen demasiadas cosas. ¬øPor qu√©?</p>
<p>Crear software que funcione y crear software limpio son dos actividades</p>
<p>diferentes. Muchos tenemos un cerebro limitado, de modo que nos centramos</p>
<p>en que el c√≥digo funcione m√°s que en su organizaci√≥n y limpieza. Es algo</p>
<p>totalmente v√°lido. Mantener objetivos separados es tan importante en</p>
<p>nuestras actividades de programaci√≥n como en nuestros programas.</p>
<p>El problema es que muchos creemos que hemos terminado cuando el</p>
<p>programa funciona. No cambiamos al otro objetivo de organizaci√≥n</p>
<p>limpieza. Pasamos al siguiente problema en lugar de retroceder y dividir las</p>
<p>clases en unidades independientes con una √∫nica responsabilidad.</p>
<p>Al mismo tiempo, muchos programadores temen que un elevado n√∫mero</p>
<p>de peque√±as clases con un √∫nico prop√≥sito dificulten la comprensi√≥n del</p>
<p>conjunto. Les preocupa que tengan que desplazarse entre las clases para</p>
<p>determinar c√≥mo funciona un aspecto concreto.</p>
<p>Sin embargo, un sistema con muchas clases reducidas no tiene m√°s</p>
<p>elementos m√≥viles que un sistema con algunas clases enormes. En ambos hay</p>
<p>que entender lo mismo. La pregunta es si quiere organizar sus herramientas</p>
<p>en cajas con muchos peque√±os cajones que contengan componentes bien</p>
<p>definidos y etiquetados, o usar varios cajones grandes en los que mezcle todo.</p>
<p>Todos los sistemas tienen una gran l√≥gica y complejidad. El objetivo</p>
<p>principal para gestionar dicha complejidad es organizarla para que un</p>
<p>programador sepa d√≥nde buscar y comprenda la complejidad directamente</p>
<p>afectada en cada momento concreto. Por el contrario, un sistema con clases</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>multiprop√≥sito de mayor tama√±o nos obliga buscar entre numerosos</p>
<p>elementos que no siempre necesitamos conocer.</p>
<p>Para reformular los puntos anteriores, diremos que los sistemas deben</p>
<p>estar formados por muchas claves reducidas, no por algunas de gran tama√±o.</p>
<p>Cada clase reducida encapsula una √∫nica responsabilidad, tiene un solo</p>
<p>motivo para cambiar colabora con algunas otras para obtener los</p>
<p>comportamientos deseados del sistema.</p>
<h3 id="cohesion-170">Cohesi√≥n</h3>
<p>Las clases deben tener un n√∫mero reducido de variables de instancia. Los</p>
<p>m√©todos de una clase deben manipular una o varias de dichas variables. Por</p>
<p>lo general, cuantas m√°s variables manipule un m√©todo, m√°s cohesi√≥n tendr√°</p>
<p>con su clase. Una clase en la que cada variable se usa en cada m√©todo tiene</p>
<p>una cohesi√≥n m√°xima.</p>
<p>Por lo general, no es recomendable ni posible crear este tipo de clases</p>
<p>pero queremos que la cohesi√≥n de nuestras clases sea elevada. Si lo logramos,</p>
<p>significa que los m√©todos y variables de la clase dependen unos de otros y</p>
<p>act√∫an como un todo l√≥gico.</p>
<p>F√≠jese en la implementaci√≥n de Stack en el Listado 10-4. Es una clase</p>
<p>muy consistente. De los tres m√©todos, s√≥lo size() no usa ambas variables.</p>
<p>Listado 10-4</p>
<p>Stack.java, una clase consistente.</p>
<p>public class Stack {</p>
<p>private int topOfStack = 0;</p>
<p>List&lt;Integer&gt; elements = new LinkedList&lt;Integer&gt;();</p>
<p>public int size() {</p>
<p>return topOfStack;</p>
<p>public void push(int element) {</p>
<p>topOfStack++;</p>
<p>elements.add(element);</p>
<p>public int pop() throws PoppedWhenEmpty {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if (topOfStack == 0)</p>
<p>throw new PoppedWhenEmpty();</p>
<p>int element = elements.get(--topOfStack);</p>
<p>elements.remove(topOfStack);</p>
<p>return element;</p>
<p>La estrategia de reducir el tama√±o de las funciones y de las listas de</p>
<p>par√°metros suele provocar la proliferaci√≥n de variables de instancia usadas</p>
<p>por un subconjunto de los m√©todos. Si esto sucede, siempre existe al menos</p>
<p>una clase que intenta huir de la clase de mayor tama√±o. Debe intentar separar</p>
<p>las variables y m√©todos en dos o m√°s clases para que las nuevas sean m√°s</p>
<p>consistentes.</p>
<h3 id="mantener-resultados-consistentes-en-muchas-clases--171">Mantener resultados consistentes en muchas clases de</h3>
<h3 id="tamano-reducido-172">tama√±o reducido</h3>
<p>La divisi√≥n de grandes funciones en otras m√°s peque√±as aumenta la</p>
<p>proliferaci√≥n de clases. Imagine una gran funci√≥n con numerosas variables</p>
<p>declaradas. Imagine que desea extraer una peque√±a parte de esa funci√≥n en</p>
<p>otra independiente. Sin embargo, el c√≥digo que extrae usa cuatro de las</p>
<p>variables declaradas en la funci√≥n. ¬øDebe pasar las cuatro variables como</p>
<p>argumentos a la nueva funci√≥n?</p>
<p>En absoluto. Si ascendemos estas cuatro variables a variables de instancia</p>
<p>de la clase, podremos extraer el c√≥digo sin pasar las variables. Resultar√≠a m√°s</p>
<p>sencillo dividir la funci√≥n en peque√±os fragmentos.</p>
<p>Desafortunadamente, eso significar√≠a que nuestras clases perder√≠an</p>
<p>cohesi√≥n ya que acumular√≠an m√°s y m√°s variables de instancia que s√≥lo</p>
<p>existen para que otras funciones las compartan. Pero un momento. Si apenas</p>
<p>existen funciones que compartan determinadas variables, ¬øno son entonces</p>
<p>una clase con derecho propio? Por supuesto. Cuando las clases pierdan</p>
<p>cohesi√≥n, div√≠dalas.</p>
<p>Por tanto, dividir una gran funci√≥n en otras m√°s reducidas tambi√©n nos</p>
<p>permite dividir varias clases m√°s reducidas. De este modo mejora la</p>
<p>organizaci√≥n del programa y su estructura resulta m√°s transparente. Como</p>
<p>ejemplo, usaremos un ejemplo obtenido del libro de Knuth Literate</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[47]</p>
<p>Programming El Listado 10-5 muestra una traducci√≥n Java del</p>
<p>programa PrintPrimes de Knuth. Para hacerle justicia, no es el programa que</p>
<p>cre√≥ sino el resultado generado por su herramienta WEB. Lo usamos aqu√≠ por</p>
<p>ser un magn√≠fico punto de partida para dividir una funci√≥n de gran tama√±o en</p>
<p>varias funciones y clases m√°s reducidas.</p>
<p>Listado 10-5</p>
<p>PrintPrimes.java</p>
<p>package literatePrimes;</p>
<p>public class PrintPrimes {</p>
<p>public static void main(String[] args) {</p>
<p>final int M = 1000;</p>
<p>final int RR = 50;</p>
<p>final int CC = 4;</p>
<p>final int WW = 10;</p>
<p>final int ORDMAX = 30;</p>
<p>int P[] = new int[M + 1];</p>
<p>int PAGENUMBER;</p>
<p>int PAGEOFFSET;</p>
<p>int ROWOFFSET;</p>
<p>int C;</p>
<p>int J;</p>
<p>int K;</p>
<p>boolean JPRIME;</p>
<p>int ORD;</p>
<p>int SQUARE;</p>
<p>int N;</p>
<p>int MULT[] = new int[ORDMAX + 1];</p>
<p>J = 1;</p>
<p>K = 1;</p>
<p>P[1] = 2;</p>
<p>ORD = 2;</p>
<p>SQUARE = 9;</p>
<p>while (K &lt; M) {</p>
<p>do {</p>
<p>J = J + 2;</p>
<p>if (J == SQUARE) {</p>
<p>ORD = ORD + 1;</p>
<p>SQUARE = P[ORD] * P[ORD];</p>
<p>MULT[ORD - 1] = J;</p>
<p>N = 2;</p>
<p>JPRIME = true;</p>
<p>while (N &lt; ORD &amp;&amp; JPRIME) {</p>
<p>while (MULT[N] &lt; J)</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>MULT[N] = MULT[N] + P[N] + P[N];</p>
<p>if (MULT[N] == J)</p>
<p>JPRIME = false;</p>
<p>N = N + 1;</p>
<p>} while (!JPRIME);</p>
<p>K = K + 1;</p>
<p>P[K] = J;</p>
<p>PAGENUMBER = 1;</p>
<p>PAGEOFFSET = 1;</p>
<p>while (PAGEOFFSET &lt;= M) {</p>
<p>System.out.println(‚ÄúThe First ‚Äù + M +</p>
<p>‚Äú Prime Numbers --- Page ‚Äù + PAGENUMBER);</p>
<p>System.out.println(‚Äú‚Äù);</p>
<p>for (ROWOFFSET PAGEOFFSET; ROWOFFSET PAGEOFFSET RR;</p>
<p>ROWOFFSET++) {</p>
<p>for (C = 0; C &lt; CC;C++)</p>
<p>if (ROWOFFSET + C * RR &lt;= M)</p>
<p>System.out.format(‚Äú%10d‚Äù, P[ROWOFFSET + C * RR]);</p>
<p>System.out.println(‚Äú‚Äù);</p>
<p>System.out.println(‚Äú\f‚Äù);</p>
<p>PAGENUMBER = PAGENUMBER + 1;</p>
<p>PAGEOFFSET = PAGEOFFSET + RR * CC;</p>
<p>Este programa, escrito como una sola funci√≥n, es un desastre. El sangrado</p>
<p>de su estructura es excesivo y hay demasiadas variables extra√±as. Como</p>
<p>m√≠nimo, la funci√≥n deber√≠a dividirse en otras m√°s peque√±as. Los listados del</p>
<p>10-6 al 10-8 muestran la divisi√≥n del c√≥digo del Listado 10-5 en clases y</p>
<p>funciones de menor tama√±o, adem√°s de los nombres elegidos para dichas</p>
<p>clases, funciones y variables.</p>
<p>Listado 10-6</p>
<p>PrimePrinter.java (refactorizado)</p>
<p>package literatePrimes;</p>
<p>public class PrimePrinter (</p>
<p>public static void main(String[] args) {</p>
<p>final int NUMBER_OF_PRIME5 = 1000;</p>
<p>int[] primes = PrimeGenerator.generate(NUMBER_OF_PRIMES);</p>
<p>final int ROWS_PER_PAGE = 50;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>final int COLUMNS_PER_PAGE = 4;</p>
<p>RowColumnPagePrinter tablePrinter =</p>
<p>new RowColumnPagePrinter(ROWS_PER_PAGE,</p>
<p>COLUMNS_PER_PAGE,</p>
<p>‚ÄúThe First ‚Äù + NUMBER_OF_PRIMES +</p>
<p>‚Äú Prime Numbers‚Äù);</p>
<p>tablePrinter.print(primes);</p>
<p>Listado 10-7</p>
<p>RowColumnPagePrinter.java.</p>
<p>package literatePrimes;</p>
<p>import java.io.PrintStream;</p>
<p>public class RowColumnPagePrinter {</p>
<p>private int rowsPerPage;</p>
<p>private int columnsPerPage;</p>
<p>private int numbersPerPage;</p>
<p>private String pageHeader;</p>
<p>private PrintStream printStream;</p>
<p>public RowColumnPagePrinter(int rowsPerPage,</p>
<p>int columnsPerPage,</p>
<p>String pageHeader) {</p>
<p>this.rowsPerPage = rowsPerPage;</p>
<p>this.columnsPerPage = columnsPerPage;</p>
<p>this.pageHeader = pageHeader;</p>
<p>numbersPerPage = rowsPerPage * columnsPerPage;</p>
<p>printStream = System.out;</p>
<p>public void print(int data[]) {</p>
<p>int pageNumber = 1;</p>
<p>for (int firstIndexOnPage = 0;</p>
<p>firstIndexOnPage &lt; data.length;</p>
<p>firstIndexOnPage += numbersPerPage) {</p>
<p>int lastIndexOnPage =</p>
<p>Math.min(firstIndexOnPage + numbersPerPage - 1,</p>
<p>data.length - 1);</p>
<p>printPageHeader(pageHeader, pageNumber);</p>
<p>printPage(firstIndexOnPage, lastIndexOnPage, data);</p>
<p>printStream.println(‚Äú\f‚Äù);</p>
<p>pageNumber++;</p>
<p>private void printPage (int firstIndexOnPage,</p>
<p>int lastIndexOnPage,</p>
<p>int[] data) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>int firstIndexOfLastRowOnPage =</p>
<p>firstIndexOnPage + rowsPerPage - 1;</p>
<p>for (int firstIndexInRow = firstIndexOnPage;</p>
<p>firstIndexInRow &lt;= firstIndexOfLastRowOnPage;</p>
<p>firstIndexInRow++) {</p>
<p>printRow(firstIndexInRow, lastIndexOnPage, data);</p>
<p>printStream.println(‚Äú‚Äù);</p>
<p>private void printRow(int firstIndexInRow,</p>
<p>int lastIndexOnPage,</p>
<p>int[] data) {</p>
<p>for (int column = 0; column &lt; columnsPerPage; column++) {</p>
<p>int index = firstIndexInRow + column * rowsPerPage;</p>
<p>if (index &lt;= lastIndexOnPage)</p>
<p>printStream.format(‚Äú%10d‚Äù, data[index]);</p>
<p>private void printPageHeader(String pageHeader,</p>
<p>int pageNumber) {</p>
<p>printStream.println(pageHeader + ‚Äú --- Page ‚Äù + pageNumber);</p>
<p>printStream.println(‚Äú‚Äù);</p>
<p>public void setOutput(PrintStream printStream) {</p>
<p>this.printStream = printStream;</p>
<p>Listado 10-8</p>
<p>PrimeGenerator.java</p>
<p>package literatePrimes;</p>
<p>import java.util.ArrayList;</p>
<p>public class PrimeGenerator {</p>
<p>private static int[] primes;</p>
<p>private static ArrayList&lt;Integer&gt; multiplesOfPrimeFactors;</p>
<p>protected static int[] generate(int n) {</p>
<p>primes = new int[n];</p>
<p>multiplesOfPrimeFactors = new ArrayList&lt;Integer&gt;();</p>
<p>set2AsFirstPrime();</p>
<p>checkOddNumbersForSubsequentPrimes();</p>
<p>return primes;</p>
<p>private static void set2AsFirtsPrime() {</p>
<p>primes[0] = 2;</p>
<p>multiplesOfPrimeFactors.add(2);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private static void checkOddNumbersForSubsequentPrimes() {</p>
<p>int primeIndex = 1;</p>
<p>for (int candidate = 3;</p>
<p>primeIndex &lt; primes.length;</p>
<p>candidate += 2) {</p>
<p>if (isPrime(candidate))</p>
<p>primes[primeIndex++] = candidate;</p>
<p>private static boolean isPrime(int candidate) {</p>
<p>if (isLeastRelevantMultipleOfNextLargerPrimeFactor(candidate)) {</p>
<p>multiplesOfPrimeFactors.add(candidate);</p>
<p>return false;</p>
<p>return isNotMultipleOfAnyPreviousPrimeFactor(candidate);</p>
<p>private static boolean</p>
<p>isLeastRelevantMultipleOfNextLargerPrimeFactor(int candidate) {</p>
<p>int nextLargerPrimeFactor = primes[multiplesOfPrimeFactors.size()];</p>
<p>int leastRelevantMultiple nextLargerPrimeFactor</p>
<p>nextLargerPrimeFactor;</p>
<p>return candidate == leastRelevantMultiple;</p>
<p>private static boolean</p>
<p>isNotMultipleOfAnyPreviousPrimeFactor(int candidate) {</p>
<p>for (int n = 1; n &lt; multiplesOfPrimeFactors.size(); n++) {</p>
<p>if (isMultipleOfNthPrimeFactor(candidate, n))</p>
<p>return false;</p>
<p>return true;</p>
<p>private static boolean</p>
<p>isMultipleOfNthPrimeFactor(int candidate, int n) {</p>
<p>return</p>
<p>candidate == smallestOddNthMultipleNotLessThanCandidate(candidate, n);</p>
<p>private static int</p>
<p>smallestOddNthMultipleNotLessThanCandidate(int candidate, int n) {</p>
<p>int multiple = multiplesOfPrimeFactors.get(n);</p>
<p>while (multiple &lt; candidate)</p>
<p>multiple += 2 * primes[n];</p>
<p>multiplesOfPrimeFactors.set(n, multiple);</p>
<p>return multiple;</p>
<p>Lo primero que apreciar√° es que ha aumentado la longitud del programa,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>de una a casi tres p√°ginas. Este aumento se debe a varios motivos. En primer</p>
<p>lugar, el programa refactorizado usa nombres de variable m√°s extensos y</p>
<p>descriptivos. Por otra parte, usa declaraciones de funciones y clases como</p>
<p>comentarios del c√≥digo. Por √∫ltimo, usamos espacios en blanco y t√©cnicas de</p>
<p>formato para mantener la legibilidad.</p>
<p>El programa se ha dividido en tres responsabilidades principales. La parte</p>
<p>principal se incluye en la clase PrimePrinter , responsable de controlar el</p>
<p>entorno de ejecuci√≥n. Cambia si se modifica el m√©todo de invocaci√≥n. Por</p>
<p>ejemplo, si este programa se convierte en un servicio SOA, es la clase que se</p>
<p>ver√° afectada.</p>
<p>RowColumnPagePrinter sabe c√≥mo aplicar formato a una lista de n√∫meros</p>
<p>con una determinada cantidad de filas y columnas. Si es necesario cambiar el</p>
<p>formato del resultado, es la clase que se ver√° afectada.</p>
<p>La clase PrimeGenerator sabe c√≥mo generar una lista de n√∫meros</p>
<p>primos. No se crear√° una instancia como objeto. La clase es s√≥lo un √°mbito</p>
<p>√∫til en el que declarar y ocultar sus variables. Esta clase cambia si se</p>
<p>modifica el algoritmo para calcular n√∫meros primos. No hemos reescrito el</p>
<p>programa. No hemos empezado de cero y los hemos vuelto a dise√±ar. En</p>
<p>realidad, si se fija atentamente en los dos programas, ver√° que usan los</p>
<p>mismos algoritmos y mecanismos.</p>
<p>El cambio se ha realizado creando una suite de pruebas que verifican el</p>
<p>comportamiento preciso del primer programa. Tras ello, se aplican</p>
<p>numerosos cambios m√≠nimos, de uno en uno. Tras cada cambio, se ejecuta el</p>
<p>programa para garantizar que el comportamiento no var√≠a. Paso a paso, el</p>
<p>primer programa se limpia y se transforma en el segundo.</p>
<h3 id="organizar-los-cambios-173">Organizar los cambios</h3>
<p>En muchos sistemas, el cambio es continuo. Cada cambio supone un riesgo</p>
<p>de que el resto del sistema no funcione de la forma esperada. En un sistema</p>
<p>limpio organizamos las clases para reducir los riesgos de los cambios.</p>
<p>La clase Sql del Listado 10-9 se usa para generar cadenas SQL de forma</p>
<p>correcta con los metadatos adecuados. Es un trabajo continuo y, como tal, no</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>admite funciones SQL como instrucciones update . Cuando la clase Sql tenga</p>
<p>que admitir una instrucci√≥n update , tendremos que abrirla para realizar</p>
<p>modificaciones. El problema de abrir una clase es el riesgo que conlleva.</p>
<p>Cualquier modificaci√≥n puede afectar otro c√≥digo de la clase. Debe</p>
<p>probarse concienzudamente.</p>
<p>Listado 10-9</p>
<p>Clase que debemos abrir para realizar cambios.</p>
<p>public class Sql {</p>
<p>public Sql(String table, Column[] columns)</p>
<p>public String create()</p>
<p>public String insert(Object[] fields)</p>
<p>public String selectAll()</p>
<p>public String findByKey(String keyColumn, String keyValue)</p>
<p>public String select(Column column, String pattern)</p>
<p>public String select(Criteria criteria)</p>
<p>public String preparedInsert()</p>
<p>private String columnList(Column[] columns)</p>
<p>private String valuesList(Object[] fields, final Column[] columns)</p>
<p>private String selectWithCriteria(String criteria)</p>
<p>private String placeholderList(Column[] columns)</p>
<p>La clase Sql debe cambiar al a√±adir un nuevo tipo de instrucci√≥n.</p>
<p>Tambi√©n debe cambiar cuando variemos los detalles de un tipo de instrucci√≥n</p>
<p>concreto; por ejemplo, si tenemos que modificar la funcionalidad select para</p>
<p>admitir selecciones secundarias. Estos dos motivos de cambio significan que</p>
<p>la clase Sql incumple SRP.</p>
<p>Podemos detectar este incumplimiento desde un punto de vista</p>
<p>organizativo. El m√©todo outline de Sql muestra que hay m√©todos privados,</p>
<p>como selectWithCriteria que parecen relacionarse √∫nicamente con</p>
<p>instrucciones select</p>
<p>El comportamiento de m√©todos privados aplicados un peque√±o</p>
<p>subconjunto de una clase puede ser una heur√≠stica √∫til para detectar zonas que</p>
<p>mejorar. Sin embargo, la verdadera raz√≥n debe ser el cambio del sistema. Si</p>
<p>la clase Sql se considera totalmente l√≥gica, no debemos preocuparnos por</p>
<p>separar las responsabilidades. Si no necesitamos funcionalidad de</p>
<p>actualizaci√≥n en el futuro, podemos olvidarnos de Sql . Pero si tenemos que</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>abrir una clase, debemos corregir el dise√±o.</p>
<p>¬øY si optamos por una soluci√≥n como la del Listado 10-10? Los m√©todos</p>
<p>p√∫blicos de interfaz definidos en Sql en el Listado 10-9 se refactorizan en sus</p>
<p>propias variantes de la clase Sql . Los m√©todos privados, como valuesList</p>
<p>se mueven directamente a las posiciones necesarias. El comportamiento</p>
<p>privado se reduce a un par de clases de utilidad: Where ColumnList</p>
<p>Listado 10-10</p>
<p>Un grupo de clases cerradas.</p>
<p>Abstract public class Sql {</p>
<p>public Sql(String table, Column[] columns)</p>
<p>abstract public String generate();</p>
<p>public class CreateSql extends Sql {</p>
<p>public CreateSql(String table, Column[] columns)</p>
<p>@Override public String generate()</p>
<p>public class SelectSql extends Sql {</p>
<p>public SelectSql(String table, Column[] columns)</p>
<p>@Override public String generate()</p>
<p>public class InsertSql extends Sql {</p>
<p>public SelectSql(String table, Column[] columns, Object[] fields)</p>
<p>@Override public String generate()</p>
<p>private String valuesList(Object[] fields, final Column[] columns)</p>
<p>public class SelectWithCriteriaSql extends Sql {</p>
<p>public SelectWithCriteriaSql(</p>
<p>String table, Column[] columns, Criteria criteria)</p>
<p>@Override public String generate()</p>
<p>public class SelectWithMatchSql extends Sql {</p>
<p>public SelectWithMatchSql(</p>
<p>String table, Column[] columns, Column column, String pattern)</p>
<p>@Override public String generate()</p>
<p>public class FindByKeySql extends Sql {</p>
<p>public FindByKeySql(</p>
<p>String table, Column[] columns, String keyColumn, String keyValue)</p>
<p>@Override public String generate()</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public class PreparedInsertSql extends Sql {</p>
<p>public PreparedInsertSql(String table, Column[] columns)</p>
<p>@Override public String generate()</p>
<p>private String placeholderList(Column[] columns)</p>
<p>public class Where {</p>
<p>public Where(String criteria)</p>
<p>public String generate()</p>
<p>public class ColumnList {</p>
<p>public ColumnList(Column[] columns)</p>
<p>public String generate()</p>
<p>El c√≥digo de cada clase se simplifica enormemente. El tiempo necesario</p>
<p>para entender las clases se reduce al m√≠nimo. El riesgo de que una funci√≥n</p>
<p>afecte a otra desaparece casi por completo. Desde el punto de vista de las</p>
<p>pruebas, resulta m√°s sencillo probar la l√≥gica de esta soluci√≥n, ya que las</p>
<p>clases se a√≠slan unas de otras.</p>
<p>Adem√°s, cuando llegue el momento de a√±adir las instrucciones update</p>
<p>no cambia ninguna de las clases existentes. A√±adimos la l√≥gica para generar</p>
<p>instrucciones update a una nueva subclase de Sql UpdateSql . Este cambio</p>
<p>no afecta a otro c√≥digo del sistema.</p>
<p>Nuestra l√≥gica Sql reestructurada representa lo mejor de ambos mundos.</p>
<p>Cumple con SRP y tambi√©n con otro principio clave del dise√±o de clases</p>
<p>[48]</p>
<p>orientadas a objetos, denominado Principio abierto/cerrado : las clases</p>
<p>deben abrirse para su ampliaci√≥n para cerrarse para su modificaci√≥n. La</p>
<p>nueva clase Sql se abre a nuevas funcionalidades mediante la creaci√≥n de</p>
<p>subclases pero podemos realizar estos cambios y mantener cerradas las</p>
<p>dem√°s clases. Basta con a√±adir nuestra clase UpdateSql</p>
<p>Debemos estructurar nuestros sistemas para ensuciarlos lo menos posible</p>
<p>cuando los actualicemos con nuevas funciones o cambios. En un sistema</p>
<p>ideal, incorporamos nuevas funciones ampli√°ndolo, no modificando el c√≥digo</p>
<p>existente.</p>
<h3 id="aislarnos-de-los-cambios-174">Aislarnos de los cambios</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Las necesidades cambiar√°n y tambi√©n lo har√° el c√≥digo. En la programaci√≥n</p>
<p>orientada a objetos aprendemos que hay clases concretas que contienen</p>
<p>detalles de implementaci√≥n (el c√≥digo) clases abstractas que s√≥lo</p>
<p>representan conceptos. Una clase cliente que dependa de detalles concretos</p>
<p>est√° en peligro si dichos detalles cambian. Podemos recurrir a interfaces y</p>
<p>clases abstractas para aislar el impacto de dichos detalles.</p>
<p>Las dependencias de detalles de concretos crean retos para nuestro</p>
<p>sistema. Si tenemos que crear la clase Portfolio y √©sta depende de una API</p>
<p>TokyoStockExchange externa para obtener su valor, nuestros casos de prueba</p>
<p>se ver√°n afectados por la volatilidad de esta b√∫squeda. Resulta complicado</p>
<p>crear una prueba cuando se obtiene una respuesta diferente cada cinco</p>
<p>minutos. En lugar de dise√±ar Portfolio para que dependa directamente de</p>
<p>TokyoStockExchange , creamos una interfaz, StockExchange , que declara un</p>
<p>√∫nico m√©todo:</p>
<p>public Interface StockExchange {</p>
<p>Money currentPrice(String symbol);</p>
<p>Dise√±amos TokyoStockExchange para implementar esta interfaz.</p>
<p>Tambi√©n nos aseguramos de que el constructor de Portfolio adopte como</p>
<p>argumento una referencia a StockExchange:</p>
<p>public Portfolio {</p>
<p>private StockExchange exchange;</p>
<p>public Portfolio(StockExchange exchange) {</p>
<p>this.exchange = exchange;</p>
<p>//...</p>
<p>Ahora la prueba puede crear una implementaci√≥n de la interfaz</p>
<p>StockExchange que emule TokyoStockExchange . Esta implementaci√≥n de</p>
<p>prueba fijar√° el valor actual del s√≠mbolo que usemos en la prueba.</p>
<p>Si nuestra prueba demuestra la adquisici√≥n de cinco acciones de</p>
<p>Microsoft para nuestra cartera de valores, dise√±e el c√≥digo de la</p>
<p>implementaci√≥n de prueba para que siempre devuelva 100 d√≥lares por acci√≥n</p>
<p>de Microsoft. Nuestra implementaci√≥n de prueba de la interfaz</p>
<p>StockExchange se reduce a una sencilla b√∫squeda de tabla. De este modo</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>podemos crear una prueba que espere un valor de cartera total de 500 d√≥lares:</p>
<p>public class PortfolioTest {</p>
<p>private FixedStockExchangeStub exchange;</p>
<p>private Portfolio portfolio;</p>
<p>@Before</p>
<p>protected void setUp() throws Exception {</p>
<p>exchange = new FixedStockExchangeStub();</p>
<p>exchange.fix(‚ÄúMSFT‚Äù, 100);</p>
<p>portfolio = new Portfolio(exchange);</p>
<p>@Test</p>
<p>public void GivenFiveMSFTTotalShouldBe500() throws Exception {</p>
<p>portfolio.add(5, ‚ÄúMSFT‚Äù);</p>
<p>Assert.assertEquals(500, portfolio.value());</p>
<p>Si diseccionamos un sistema para poder probarlo de esta forma, resultar√°</p>
<p>m√°s flexible y se podr√° reutilizar. La ausencia de conexiones significa que los</p>
<p>elementos del sistema se a√≠slan entre ellos de otros cambios. Este</p>
<p>aislamiento hace que comprendamos mejor los elementos del sistema.</p>
<p>Al minimizar las conexiones de esta forma, nuestras clases cumplen otro</p>
<p>principio de dise√±o: Dependency Inversion Principle (DIP) o Principio de</p>
<p>[49]</p>
<p>inversi√≥n de dependencias . B√°sicamente afirma que nuestras clases deben</p>
<p>depender de abstracciones, no de detalles concretos.</p>
<p>En lugar de depender de los detalles de implementaci√≥n de la clase</p>
<p>TokyoStockExchange nuestra clase Portfolio depende de la interfaz</p>
<p>StockExchange , que representa el concepto abstracto de solicitar el precio</p>
<p>actual de una acci√≥n. Esta abstracci√≥n a√≠sla todos los datos concretos de la</p>
<p>obtenci√≥n de dicho precio, incluyendo de d√≥nde se obtiene.</p>
<h3 id="bibliografia-175">Bibliograf√≠a</h3>
<p>[RDD] Object Design: Roles, Responsibilities, and Collaborations</p>
<p>Rebecca Wirfs-Brock et al., Addison-Wesley, 2002.</p>
<p>[PPP] Agile Software Development: Principles, Patterns, and</p>
<p>Practices , Robert C. Martin, Prentice Hall, 2002.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[Knuth92] Literate Programming , Donald E. Knuth, Center for the</p>
<p>Study of language and Information, Leland Stanford Junior University,</p>
<p>1992.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="sistemas-176">Sistemas</h1>
<p>por el Dr. Kevin Dean Wampler</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>¬´La complejidad es letal. Acaba con los desarrolladores y dificulta</p>
<p>la planificaci√≥n, generaci√≥n y pruebas de los productos¬ª.</p>
<p>‚ÄîRay Ozzie, CTO, Microsoft Corporation</p>
<h3 id="como-construir-una-ciudad-177">C√≥mo construir una ciudad</h3>
<p>¬øPodr√≠a encargarse de todos los detalles por su cuenta? Seguramente no.</p>
<p>Incluso la gesti√≥n de una ciudad existente ser√≠a demasiado para una sola</p>
<p>persona. Y aun as√≠, las ciudades funcionan (en la mayor√≠a de los casos).</p>
<p>Funcionan porque tienen equipos que controlan partes concretas de la ciudad,</p>
<p>el alcantarillado, la red el√©ctrica, el tr√°fico, la seguridad, las normativas</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>urban√≠sticas, etc. Algunos se encargan de aspectos generales y otros se</p>
<p>centran en los detalles.</p>
<p>Las ciudades tambi√©n funcionan porque disponen de evolucionados</p>
<p>niveles de abstracci√≥n modularidad que permiten individuos</p>
<p>componentes trabajar de forma eficaz, sin necesidad de entender el trasfondo</p>
<p>general.</p>
<p>Aunque los equipos de software se suelen organizar de esta forma, los</p>
<p>sistemas en los que trabajan no suelen contar con la misma separaci√≥n de</p>
<p>aspectos y niveles de abstracci√≥n. En este cap√≠tulo veremos c√≥mo mantener la</p>
<p>limpieza en niveles superiores de abstracci√≥n, en el sistema.</p>
<h3 id="separar-la-construccion-de-un-sistema-de-su-uso-178">Separar la construcci√≥n de un sistema de su uso</h3>
<p>En primer lugar, recuerde que la construcci√≥n es un proceso muy diferente al</p>
<p>uso. Mientras escribo estas l√≠neas, a trav√©s de la ventana veo un nuevo hotel</p>
<p>en construcci√≥n en Chicago. Hoy instalar√°n una gran gr√∫a. Todos los obreros</p>
<p>llevan casco. Dentro de un a√±o habr√°n acabado el hotel. La gr√∫a</p>
<p>desaparecer√°. El edificio estar√° terminado, con su reluciente fachada de</p>
<p>cristal y su atractiva decoraci√≥n. La gente que trabajar√° en √©l tambi√©n ser√°</p>
<p>diferente.</p>
<p>Los sistemas de software deben separar el proceso de inicio, en el que</p>
<p>se crean los objetos de la aplicaci√≥n y se conectan las dependencias,</p>
<p>de la l√≥gica de ejecuci√≥n que toma el testigo tras el inicio.</p>
<p>El proceso de inicio es un aspecto que toda aplicaci√≥n debe abordar. Es el</p>
<p>primero que veremos en este cap√≠tulo. La separaci√≥n de aspectos es una de</p>
<p>las t√©cnicas de dise√±o m√°s antiguas e importantes de nuestra profesi√≥n.</p>
<p>Desafortunadamente, muchas aplicaciones no lo hacen. El c√≥digo del</p>
<p>proceso de inicio se mezcla con la l√≥gica de tiempo de ejecuci√≥n. Veamos un</p>
<p>ejemplo t√≠pico:</p>
<p>public Service getService() {</p>
<p>if (service == null)</p>
<p>service new MyServiceImpl (...); //¬øLo bastante predeterminado para la</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>mayor√≠a de los casos?</p>
<p>return service;</p>
<p>Es la t√©cnica de inicializaci√≥n/evaluaci√≥n tard√≠a y tiene sus m√©ritos. No</p>
<p>incurrimos en la sobrecarga de la construcci√≥n a menos que usemos el objeto</p>
<p>realmente, y como resultado el tiempo de inicio se puede acelerar. Tambi√©n</p>
<p>evitamos que se devuelva null</p>
<p>Sin embargo, ahora tenemos una dependencia en MyServiceImpl y todo</p>
<p>lo que su constructor requiere (que he omitido). No podemos compilar sin</p>
<p>resolver estas dependencias, aunque nunca usemos un objeto de este tipo en</p>
<p>tiempo de ejecuci√≥n.</p>
<p>Las pruebas tambi√©n pueden ser un problema. Si MyServiceImpl es un</p>
<p>objeto pesado, tendremos que asegurarnos de asignar el correspondiente test</p>
<p>[50]</p>
<p>double u objeto simulado al campo de servicio antes de invocar este</p>
<p>m√©todo en las pruebas de unidad. Como la l√≥gica de la construcci√≥n se</p>
<p>mezcla con el procesamiento normal de tiempo de ejecuci√≥n, debemos probar</p>
<p>todas las rutas de ejecuci√≥n (como la prueba null y su bloque). Al contar con</p>
<p>ambas responsabilidades, el m√©todo hace m√°s de una cosa, por lo que se</p>
<p>incumple el principio de responsabilidad √∫nica.</p>
<p>Lo peor de todo es que no sabemos si MyServiceImpl es el objeto</p>
<p>correcto en todos los casos. ¬øPor qu√© la clase con este m√©todo tiene que</p>
<p>conocer el contexto global? ¬øPodemos saber realmente cu√°l es el objeto</p>
<p>correcto que usar aqu√≠? ¬øEs posible que un mismo tipo sea el correcto para</p>
<p>todos los contextos posibles?</p>
<p>Un caso de inicializaci√≥n tard√≠a no es un problema serio. Sin embargo,</p>
<p>suele haber muchos casos de este tipo de configuraci√≥n en las aplicaciones.</p>
<p>Por tanto, la estrategia de configuraci√≥n global (si existe) se disemina por la</p>
<p>aplicaci√≥n, sin apenas modularidad y con una significativa duplicaci√≥n.</p>
<p>Si somos diligentes sobre el dise√±o de sistemas robustos y bien formados,</p>
<p>no debemos permitir fallos de modularidad. El proceso de inicio de la</p>
<p>construcci√≥n conexi√≥n de objetos no es una excepci√≥n. Debemos</p>
<p>modularizar este proceso y asegurarnos de contar con una estrategia global y</p>
<p>coherente para resolver las dependencias principales.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="separar-main-179">Separar Main</h3>
<p>Una forma de separar la construcci√≥n del uso consiste en trasladar todos los</p>
<p>aspectos de la construcci√≥n a main o a m√≥dulos invocados por main , y dise√±ar</p>
<p>el resto del sistema suponiendo que todos los objetos se han creado y</p>
<p>conectado correctamente (v√©ase la figura 11.1).</p>
<p>El flujo de control es f√°cil de seguir. La funci√≥n main crea los objetos</p>
<p>necesarios para el sistema, los pasa a la aplicaci√≥n y √©sta los utiliza. Ver√° que</p>
<p>las flechas de dependencia atraviesan la barrera entre main y la aplicaci√≥n.</p>
<p>Todas van en la misma direcci√≥n, alej√°ndose de main , lo que significa que la</p>
<p>aplicaci√≥n no tiene conocimiento de main ni del proceso de construcci√≥n.</p>
<p>Simplemente espera que todo se haya construido correctamente.</p>
<p>Figura 11.1. Separaci√≥n de la construcci√≥n en main()</p>
<h3 id="factorias-180">Factor√≠as</h3>
<p>En ocasiones, la aplicaci√≥n tendr√° que ser responsable de la creaci√≥n de un</p>
<p>objeto. Por ejemplo, en un sistema de procesamiento de pedidos, la</p>
<p>aplicaci√≥n debe crear las instancias LineItem que a√±adir a Order . En este</p>
<p>[51]</p>
<p>caso, podemos usar el patr√≥n de factor√≠a abstracta para que la aplicaci√≥n</p>
<p>controle cu√°ndo crear LineItem pero mantener los detalles de dicha</p>
<p>construcci√≥n separados del c√≥digo de la aplicaci√≥n (v√©ase la figura 11.2).</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>De nuevo vemos que todas las dependencias se desplazan desde main a la</p>
<p>aplicaci√≥n OrderProcessing , lo que significa que la aplicaci√≥n se desconecta</p>
<p>de los detalles de creaci√≥n de LineItem . Esta capacidad se incluye en</p>
<p>LineItemFactoryImplementation , en el extremo main de la l√≠nea. Y sin</p>
<p>embargo, la aplicaci√≥n tiene control total sobre cu√°ndo se crean las instancias</p>
<p>LineItem incluso puede proporcionar argumentos de constructor</p>
<p>espec√≠ficos de la aplicaci√≥n.</p>
<p>Figura 11.2. Separaci√≥n de la construcci√≥n con una factor√≠a.</p>
<h3 id="inyectar-dependencias-181">Inyectar dependencias</h3>
<p>Un potente mecanismo para separar la construcci√≥n del uso es la Inyecci√≥n</p>
<p>de dependencias, la aplicaci√≥n de Inversi√≥n de control ( Inversion of Control</p>
<p>[52]</p>
<p>IoC) a la administraci√≥n de dependencias . La Inversi√≥n de control pasa</p>
<p>responsabilidades secundarias de un objeto a otros dedicados a ese cometido,</p>
<p>por lo que admite el principio de responsabilidad √∫nica. En el contexto de la</p>
<p>administraci√≥n de dependencias, un objeto no debe ser responsable de</p>
<p>instanciar dependencias, sino que debe delegar esta responsabilidad en otro</p>
<p>mecanismo autorizado, de modo que se invierte el control. Como la</p>
<p>configuraci√≥n es un aspecto global, este mecanismo autorizado suele ser la</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>rutina main o un contenedor de prop√≥sito especial.</p>
<p>Las b√∫squedas JNDI son una implementaci√≥n parcial de la inyecci√≥n de</p>
<p>dependencias, en las que un objeto solicita a un servidor de directorios un</p>
<p>servicio que coincida con un nombre concreto.</p>
<p>MyService myService = (MyService)(jndiContext.lookup(‚ÄúNameOfMyService‚Äù));</p>
<p>El objeto invocador no controla el tipo de objeto devuelto (siempre que</p>
<p>implemente la interfaz correcta, evidentemente), pero es el que resuelve la</p>
<p>dependencia de forma activa.</p>
<p>La verdadera inyecci√≥n de dependencias va un paso m√°s all√°. La clase no</p>
<p>hace nada directamente para resolver sus dependencias, es totalmente pasiva.</p>
<p>Por el contrario, ofrece m√©todos de establecimiento argumentos de</p>
<p>constructor (o ambos) que se usan para inyectar las dependencias. En el</p>
<p>proceso de construcci√≥n, el contenedor de inyecci√≥n de dependencias crea</p>
<p>instancias de los objetos necesarios (normalmente bajo demanda) y usa los</p>
<p>argumentos de constructor o m√©todos de establecimiento proporcionados para</p>
<p>conectar las dependencias. Los objetos dependientes empleados suelen</p>
<p>especificarse trav√©s de un archivo de configuraci√≥n mediante</p>
<p>programaci√≥n en un m√≥dulo de construcci√≥n de prop√≥sito especial.</p>
<p>La estructura Spring proporciona el contenedor de inyecci√≥n de</p>
<p>[53]</p>
<p>dependencias m√°s conocido para Java . Los objetos que se van a conectar</p>
<p>se definen en un archivo de configuraci√≥n XML y despu√©s se solicitan</p>
<p>objetos concretos por nombre en c√≥digo de Java. Veremos un ejemplo en</p>
<p>breve.</p>
<p>¬øY qu√© sucede con las virtudes de la inicializaci√≥n tard√≠a? En ocasiones es</p>
<p>√∫til con la inyecci√≥n de dependencias. Por un lado, muchos contenedores de</p>
<p>inyecci√≥n de dependencias no crean un objeto hasta que es necesario. Por otra</p>
<p>parte, muchos de estos contenedores cuentan con mecanismos para invocar</p>
<p>factor√≠as o crear proxies que se pueden usar para evaluaci√≥n tard√≠a y</p>
<p>[54]</p>
<p>optimizaciones similares</p>
<h3 id="evolucionar-182">Evolucionar</h3>
<p>Las ciudades nacen de pueblos, que nacen de asentamientos. Inicialmente, los</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>caminos son estrechos y pr√°cticamente inexistentes, despu√©s se asfaltan y</p>
<p>aumentan de tama√±o.</p>
<p>Los peque√±os edificios y solares vac√≠os se llenan de otros mayores que</p>
<p>acaban convirti√©ndose en rascacielos. Al principio no hay servicios,</p>
<p>electricidad, agua, alcantarillado o Internet (¬°vaya!). Estos servicios se a√±aden</p>
<p>cuando aumenta la densidad de poblaci√≥n.</p>
<p>Este crecimiento no es f√°cil. Cu√°ntas veces mientras conduce por una</p>
<p>carretera llena de baches y ve una se√±al de obras no se ha preguntado por qu√©</p>
<p>no la hicieron m√°s ancha desde un principio.</p>
<p>No se pod√≠a haber hecho de otra forma. ¬øQui√©n puede justificar el gasto</p>
<p>en una autopista de seis carriles que atraviese un peque√±o pueblo como</p>
<p>anticipaci√≥n a un supuesto crecimiento? ¬øQui√©n querr√≠a una autopista as√≠ en</p>
<p>su ciudad?</p>
<p>Conseguir sistemas perfectos a la primera es un mito. Por el contrario,</p>
<p>debemos implementar hoy, y refactorizar y ampliar ma√±ana. Es la esencia de</p>
<p>la agilidad iterativa e incremental. El desarrollo controlado por pruebas, la</p>
<p>refactorizaci√≥n y el c√≥digo limpio que generan hace que funcione a nivel del</p>
<p>c√≥digo.</p>
<p>¬øPero qu√© sucede en el nivel del sistema? ¬øLa arquitectura del sistema no</p>
<p>requiere una planificaci√≥n previa? Sin duda no puede aumentar</p>
<p>incrementalmente algo sencillo a algo complejo, ¬øo s√≠?</p>
<p>Los sistemas de software son √∫nicos si los comparamos con los</p>
<p>sistemas f√≠sicos. Sus arquitecturas pueden crecer incrementalmente,</p>
<p>si mantenemos la correcta separaci√≥n de los aspectos.</p>
<p>La naturaleza ef√≠mera de los sistemas de software hace que sea posible,</p>
<p>como veremos. Primero nos centraremos en una arquitectura que no separa</p>
<p>correctamente los aspectos. Las arquitecturas EJB1 y EJB2 originales no</p>
<p>separaban correctamente los aspectos por tanto impon√≠an barreras</p>
<p>innecesarias al crecimiento org√°nico. Imagine un bean de entidad para una</p>
<p>clase Bank persistente. Un bean de entidad es una representaci√≥n en memoria</p>
<p>de datos relacionales, es decir, una fila de una tabla.</p>
<p>Primero, debe definir una interfaz local (en proceso) o remota (MVJ</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>independiente), que los clientes usen. El Listado 1-1 muestra una posible</p>
<p>interfaz local:</p>
<p>Listado 11-1</p>
<p>Una interfaz local EJB2 para el EJB Bank.</p>
<p>package com.example.banking;</p>
<p>import java.util.Collections;</p>
<p>import javax.ejb.*;</p>
<p>public interface BankLocal extends java.ejb.EJBLocalObject {</p>
<p>String getStreetAddrl{} throws EJBException;</p>
<p>String getStreetAddr2{} throws EJBException;</p>
<p>String getCity() throws EJBException;</p>
<p>String getState() throws EJBException;</p>
<p>String getZipCode() throws EJBException;</p>
<p>void setStreetAddr1(String street1) throws EJBException;</p>
<p>void setStreetAddr2(String street2) throws EJBException;</p>
<p>void setCity(String city) throws EJBException;</p>
<p>void setState(String state) throws EJBException;</p>
<p>void setZipCode(String zip) throws EJBException;</p>
<p>Collection getAccounts() throws EJBException;</p>
<p>void setAccounts(Collection accounts) throws EJBException;</p>
<p>void addAccount(AccountDTO accountDTO) throws EJBException;</p>
<p>Mostramos diversos atributos de la direcci√≥n de Bank y una colecci√≥n de</p>
<p>cuentas del banco, cuyos datos se procesar√°n por un EJB Account diferente.</p>
<p>El Listado 11-2 muestra la correspondiente clase de implementaci√≥n del bean</p>
<p>Bank</p>
<p>Listado 11-2</p>
<p>Implementaci√≥n del bean de entidad EJB2.</p>
<p>package com.example.banking;</p>
<p>import java.util.Collections;</p>
<p>import javax.ejb.*;</p>
<p>public abstract class Bank implements javax.ejb.EntityBean {</p>
<p>// L√≥gica empresarial...</p>
<p>public abstract String getStreerAddr1();</p>
<p>public abstract String getStreetAddr2();</p>
<p>public abstract String getCity();</p>
<p>public abstract String getState();</p>
<p>public abstract String getZipCode();</p>
<p>public abstract void setStreetAddr1(String street1);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public abstract void setStreetAddr2(String street2);</p>
<p>public abstract void setcity(String city);</p>
<p>public abstract void setState(String state);</p>
<p>public abstract void setZipCode(String zip);</p>
<p>public abstract Collection getAccounts();</p>
<p>public abstract void setAccounts(Collection accounts);</p>
<p>public void addAccount(AccountPTO accountDTO) {</p>
<p>InitialContext context = new InitialContext();</p>
<p>AccountHomeLocal accountHome = context.lookup(‚ÄúAccountHomeLocal‚Äù);</p>
<p>AccountLocal account = accountHome.create(accountDTO);</p>
<p>Collection accounts = getAccounts();</p>
<p>accounts.add(account);</p>
<p>// L√≥gica del contenedor EJB</p>
<p>public abstract void setId(Integer id);</p>
<p>public abstract Integer getId();</p>
<p>public Integer ejbCreate(Integer id) {...}</p>
<p>public void ejbPostCreate(Integer id) {...}</p>
<p>// El resto tendr√≠a que implementarse pero se deja vac√≠o:</p>
<p>public void setEntityContext(EntityContext ctxt) {}</p>
<p>public void unsetEntityContext() {}</p>
<p>public void ejbActivate() {}</p>
<p>public void ejbPassivate() {}</p>
<p>public void ejbLoad() {}</p>
<p>public void ejbStore() {}</p>
<p>public void ejbRemove() {}</p>
<p>No mostramos la correspondiente interfaz LocalHome , b√°sicamente una</p>
<p>factor√≠a usada para crear objetos, no los m√©todos de consulta Bank que pueda</p>
<p>a√±adir.</p>
<p>Por √∫ltimo, debemos crear uno o varios descriptores de implementaci√≥n</p>
<p>XML que especifiquen los detalles de asignaci√≥n relacional de objetos en un</p>
<p>almac√©n persistente, el comportamiento deseado de la transacci√≥n,</p>
<p>limitaciones de seguridad y dem√°s.</p>
<p>La l√≥gica empresarial est√° directamente conectada al contenedor de la</p>
<p>aplicaci√≥n EJB2. Debe crear subclases de tipos de contenedor y proporcionar</p>
<p>los m√©todos de ciclo vital necesarios para el contenedor. Debido a esta</p>
<p>conexi√≥n al contenedor pesado, las pruebas de unidad aisladas son</p>
<p>complicadas. Es necesario imitar el contenedor, algo dif√≠cil, perder</p>
<p>demasiado tiempo en la implementaci√≥n de EJB y pruebas en un servidor</p>
<p>real. La reutilizaci√≥n fuera de la arquitectura EJB2 es imposible, debido a esta</p>
<p>estrecha conexi√≥n. Por √∫ltimo, incluso la programaci√≥n orientada a objetos se</p>
<p>ve afectada. Un bean no se puede heredar de otro. F√≠jese en la l√≥gica para</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>a√±adir una nueva cuenta. En bean EJB2 es habitual definir Objetos de</p>
<p>transferencia de datos Data Transfer Objects DTO), estructuras sin</p>
<p>comportamiento. Esto suele generar tipos redundantes con los mismos datos</p>
<p>y requiere c√≥digo predefinido para copiar datos entre objetos.</p>
<h3 id="aspectos-transversales-183">Aspectos transversales</h3>
<p>La arquitectura EJB2 se acerca a la verdadera separaci√≥n de aspectos en</p>
<p>determinados aspectos. Por ejemplo, los comportamientos transaccionales, de</p>
<p>seguridad y comportamiento deseados se declaran en los descriptores de</p>
<p>implementaci√≥n, independientemente del c√≥digo fuente. Aspectos como la</p>
<p>persistencia suelen cruzar los l√≠mites de objeto naturales de un dominio. Por</p>
<p>lo general intentar√° mantener todos sus objetos mediante la misma estrategia,</p>
<p>[55]</p>
<p>por ejemplo con un determinado DBMS y no archivos planos, usando</p>
<p>determinadas convenciones de nomenclatura para tablas y columnas, una</p>
<p>sem√°ntica transaccional coherente, etc.</p>
<p>En principio, puede razonar su estrategia de persistencia de una forma</p>
<p>modular y encapsulada, pero en la pr√°ctica tendr√° que distribuir el mismo</p>
<p>c√≥digo que implemente la estrategia de persistencia entre varios objetos.</p>
<p>Usamos el t√©rmino transversales para este tipo de aspectos. De nuevo, la</p>
<p>estructura de persistencia podr√≠a ser modular y la l√≥gica de dominios, aislada,</p>
<p>tambi√©n. El problema es la intersecci√≥n entre ambos dominios.</p>
<p>De hecho, la forma en que la arquitectura EJB procesa persistencia,</p>
<p>seguridad y transacciones es una Programaci√≥n orientada a aspectos ( Aspect</p>
<p>[56]</p>
<p>Oriented Programming o AOP) anticipada, un enfoque de car√°cter general</p>
<p>para restaurar la modularidad en aspectos transversales. En AOP,</p>
<p>construcciones modulares denominadas aspectos especifican qu√© puntos del</p>
<p>sistema deben modificar su comportamiento de forma coherente para admitir</p>
<p>un determinado aspecto. Esta especificaci√≥n se realiza mediante un sucinto</p>
<p>mecanismo de declaraci√≥n o programaci√≥n.</p>
<p>Si usamos la persistencia como ejemplo, podr√≠a declarar qu√© objetos y</p>
<p>atributos (o patrones) deben conservarse y despu√©s delegar las tareas de</p>
<p>persistencia su estructura de persistencia. Las modificaciones de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[57]</p>
<p>comportamiento no son invasivas para el c√≥digo de destino. Veamos tres</p>
<p>aspectos o mecanismos similares en Java.</p>
<h3 id="proxies-de-java-184">Proxies de Java</h3>
<p>Los proxies de Java son √∫tiles en casos sencillos, como envolver</p>
<p>invocaciones de m√©todos en objetos o clases concretas. Sin embargo, los</p>
<p>proxies din√°micos proporcionados en el JDK s√≥lo funcionan con interfaces.</p>
<p>Para aplicarlos a clases, debe usar una biblioteca de manipulaci√≥n de c√≥digo</p>
<p>[58]</p>
<p>de bytes , como CGLIB, ASM o Javassist</p>
<p>El Listado 11-3 muestra la estructura de un proxy JDK para ofrecer</p>
<p>asistencia de persistencia a nuestra aplicaci√≥n Bank; √∫nicamente abarca los</p>
<p>m√©todos para obtener y establecer la lista de cuentas.</p>
<p>Listado 11-3</p>
<p>Ejemplo de proxy del JDK.</p>
<p>// Bank.java (eliminando nombres de paquetes...)</p>
<p>import java.utils.*;</p>
<p>// La abstracci√≥n de un banco.</p>
<p>public interface Bank {</p>
<p>Collection&lt;Account&gt; getAccounts();</p>
<p>void setAccounts(Collection&lt;Accounts&gt; accounts);</p>
<p>// BankImpl.java</p>
<p>import java.utils.*;</p>
<p>// ‚ÄúPlain Old Java Object‚Äù POJO que implementa la abstracci√≥n.</p>
<p>public class BankImpl implements Bank {</p>
<p>private List&lt;Account&gt; accounts;</p>
<p>public Collection&lt;Account&gt; getAccounts() {</p>
<p>return accounts;</p>
<p>public void setAccounts(Collections&lt;Accounts&gt; accounts) {</p>
<p>this.accounts = new ArrayList&lt;Accounts&gt;();</p>
<p>for (Account account: accounts) {</p>
<p>this.accounts.add(account);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>// BankProxyHandler.java</p>
<p>import java.lang.reflect.*;</p>
<p>import java.util.*;</p>
<p>// ¬´InvocationHandler¬ª necesario para la API de proxy.</p>
<p>public class BankProxyHandler implements InvocationHandler {</p>
<p>private Bank bank;</p>
<p>public BankHandler (Bank bank) {</p>
<p>this.bank = bank;</p>
<p>// M√©todo definido en InvocationHandler</p>
<p>public Object invoke(Object proxy, Method method, Object[] args)</p>
<p>throws Throwable {</p>
<p>String methodName = method.getName();</p>
<p>if (methodName.equals(‚ÄúgetAccounts‚Äù)) {</p>
<p>bank.setAccounts(getAccountsFromDatabase());</p>
<p>return bank.getAccounts();</p>
<p>} else if (methodName.equals(‚ÄúsetAccounts‚Äù)) {</p>
<p>bank.setAccounts((Collection&lt;Account&gt;) args[0]);</p>
<p>setAccountsToDatabase(bank.getAccounts());</p>
<p>return null;</p>
<p>} else {</p>
<p>...</p>
<p>// Muchos detalles:</p>
<p>protected Collection&lt;Account&gt; getAccountsFromDatabase() {...}</p>
<p>protected void setAccountsToDatabase(Collection&lt;Account&gt; accounts) {...}</p>
<p>//En otra parte...</p>
<p>Bank bank = (Bank) Proxy.newproxyInstance(</p>
<p>Bank.class.getClassLoader(),</p>
<p>new Class[] { Bank.class },</p>
<p>new BankProxyHandler(new BankImpl()));</p>
<p>Definimos la interfaz Bank , que envolvemos en el proxy y un POJO</p>
<p>Plain-Old Object u Objeto sencillo de Java), BankImpl , que implementa la</p>
<p>l√≥gica empresarial (encontrar√° m√°s informaci√≥n sobre POJO en un apartado</p>
<p>posterior).</p>
<p>La API Proxy requiere un objeto InvocationHandler que invocar para</p>
<p>implementar las invocaciones de m√©todos Bank realizadas en el proxy.</p>
<p>BankProxyHandler usa la API de reflexi√≥n de Java para asignar las</p>
<p>invocaciones de m√©todos gen√©ricos los m√©todos correspondientes de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>BankImpl , y as√≠ sucesivamente.</p>
<p>[59]</p>
<p>El c√≥digo es abundante y complejo, incluso para este sencillo caso . El</p>
<p>uso de una de las bibliotecas de manipulaci√≥n de bytes es igualmente</p>
<p>complicado. El volumen y la complejidad de este c√≥digo son dos de los</p>
<p>inconvenientes de los proxies . Dificultan la creaci√≥n de c√≥digo limpio.</p>
<p>Adem√°s, los proxies no ofrecen un mecanismo para especificar puntos de</p>
<p>ejecuci√≥n globales del sistema, imprescindibles para una verdadera soluci√≥n</p>
<p>[60]</p>
<p>AOP</p>
<h3 id="estructuras-aop-java-puras-185">Estructuras AOP Java puras</h3>
<p>Afortunadamente, gran parte del c√≥digo predefinido de proxy se puede</p>
<p>procesar de forma autom√°tica mediante herramientas. Los proxies se usan</p>
<p>internamente en varias estructuras de Java como Spring AOP y JBoss AOP,</p>
<p>[61]</p>
<p>para implementar aspectos en Java En Spring, se crea la l√≥gica</p>
<p>empresarial en forma de POJO, espec√≠ficos de su dominio. No dependen de</p>
<p>estructuras empresariales (ni de otros dominios). Por tanto, son</p>
<p>conceptualmente m√°s sencillos m√°s f√°ciles de probar. Su relativa</p>
<p>simplicidad garantiza que se implementen correctamente las correspondientes</p>
<p>historias y el mantenimiento y evoluci√≥n del c√≥digo en historias futuras.</p>
<p>La infraestructura necesaria de la aplicaci√≥n, incluidos aspectos</p>
<p>transversales como persistencia, transacciones, seguridad, almacenamiento en</p>
<p>cach√© y recuperaci√≥n ante fallos, se incorpora por medio de archivos de</p>
<p>configuraci√≥n declarativos o API. En muchos casos, se especifican aspectos</p>
<p>de bibliotecas Spring o JBoss, en los que la estructura controla el uso de</p>
<p>proxies de Java o bibliotecas de c√≥digo de bytes de forma transparente al</p>
<p>usuario. Estas declaraciones controlan el contenedor de inyecci√≥n de</p>
<p>dependencias, que crea instancias de los principales objetos y las conecta</p>
<p>bajo demanda.</p>
<p>El Listado 11-4 muestra un fragmento tipo de un archivo de</p>
<p>[62]</p>
<p>configuraci√≥n de Spring V2.5, app.xml</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Listado 11-4</p>
<p>Archivo de configuraci√≥n de Spring 2.X</p>
<p>&lt;beans&gt;</p>
<p>...</p>
<p>&lt;bean id=‚ÄúappDataSource‚Äù</p>
<p>class=‚Äúorg.apache.commons.dbcp.BasicDataSource‚Äù</p>
<p>destroy-method=‚Äúclose‚Äù</p>
<p>p:driverClassName=‚Äúcom.mysql.jdbc.Driver‚Äù</p>
<p>p:url=‚Äújdbc:mysql://localhost:3306/mydb‚Äù</p>
<p>p:username=‚Äúme‚Äù/&gt;</p>
<p>&lt;bean id=‚ÄúbankDataAccessObject‚Äù</p>
<p>class=‚Äúcom.example.banking.persistence.BankDataAccessObject‚Äù</p>
<p>p:dataSource-ref=‚ÄúappDataSource‚Äù/&gt;</p>
<p>&lt;bean id=‚Äúbank‚Äù</p>
<p>class=‚Äúcom.example.banking.model.Bank‚Äù</p>
<p>p:dataAccessObject-ref=‚ÄúbankDataAccessObject‚Äù/&gt;</p>
<p>...</p>
<p>&lt;/beans&gt;</p>
<p>Cada bean es como una parte de una mu√±eca rusa anidada, con un objeto</p>
<p>de domino de un proxy Bank (envuelto) por un Objeto de acceso a datos</p>
<p>Data Accessor Object , DAO), que tambi√©n se procesa a trav√©s de un proxy</p>
<p>por medio de un origen de datos de controlador JDBC (v√©ase la figura 11.3).</p>
<p>Figura 11.3. La ‚Äúmu√±eca rusa‚Äù de elementos de decoraci√≥n.</p>
<p>El cliente cree que invoca getAccounts() en un objeto Bank , pero en</p>
<p>[63]</p>
<p>realidad se comunica con el objeto DECORATOR m√°s externo de un grupo,</p>
<p>un objeto que ampl√≠a el comportamiento b√°sico del POJO Bank . Podr√≠amos</p>
<p>a√±adir otros objetos de decoraci√≥n para transacciones, almacenamiento en</p>
<p>cach√© y dem√°s.</p>
<p>En la aplicaci√≥n, bastan unas l√≠neas para solicitar al contenedor de ID los</p>
<p>objetos de nivel superior del sistema, como se especifica en el archivo XML.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>XmlBeanFactory bf =</p>
<p>new XmlBeanFactory(new ClassPathResource(‚Äúapp.xml‚Äù, getclass()));</p>
<p>Bank bank = (Bank) bf.getBean(‚Äúbank‚Äù);</p>
<p>Como apenas se necesitan l√≠neas de c√≥digo Java espec√≠fico de Spring, la</p>
<p>aplicaci√≥n se desconecta casi por completo de Spring y desaparecen los</p>
<p>problemas de conexi√≥n de sistemas como EJB2.</p>
<p>[64]</p>
<p>Aunque XML puede ser dif√≠cil de leer , la directiva especificada en</p>
<p>estos archivos de configuraci√≥n es m√°s sencilla que la complicada l√≥gica de</p>
<p>proxy y aspectos oculta a la vista y creada de forma autom√°tica. Es una</p>
<p>arquitectura tan atractiva que sistemas como Spring modificaron totalmente</p>
<p>el est√°ndar EJB para la versi√≥n 3. EJB3 sigue el modelo de Spring de</p>
<p>aspectos transversales admitidos mediante declaraciones con archivos de</p>
<p>configuraci√≥n XML y/o anotaciones de Java 5.</p>
<p>[65]</p>
<p>El Listado 11-5 muestra nuestro objeto Bank reescrito en EJB3</p>
<p>Listado 11-5</p>
<p>Un EJB Bank EJB3.</p>
<p>package com.example.banking.model;</p>
<p>import javax.persistence;</p>
<p>import java.util.ArrayList;</p>
<p>import java.util.Collection;</p>
<p>@Entity</p>
<p>@Table(name = ‚ÄúBANKS‚Äù)</p>
<p>public class Bank implements java.io.Serializable {</p>
<p>@Id @GeneratedValue(strategy=GenerationType.AUTO)</p>
<p>private int id;</p>
<p>@Embeddable // Un objeto en l√≠nea en la fila DB de Bank</p>
<p>public class Address {</p>
<p>protected String streetAddr1;</p>
<p>protected String streetAddr2;</p>
<p>protected String city;</p>
<p>protected String state;</p>
<p>protected String zipCode;</p>
<p>@Embedded</p>
<p>private Address address;</p>
<p>@OneToMany (cascade = CascadeType.ALL, fetch = FetchType.EAGER,</p>
<p>mappedBy=‚Äúbank‚Äù)</p>
<p>private Collection&lt;Account&gt; accounts = new ArrayList&lt;Account&gt;();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public int getId() {</p>
<p>return id;</p>
<p>public void setID(int id) {</p>
<p>this.id = id;</p>
<p>public void addAccount(Account account) {</p>
<p>account.setBank(this);</p>
<p>accounts.add(account);</p>
<p>public Collection&lt;Account&gt; getAccounts() {</p>
<p>return accounts;</p>
<p>public void setAccounts(Collection&lt;Account&gt; accounts) {</p>
<p>this.accounts = accounts;</p>
<p>Este c√≥digo es mucho m√°s limpio que el c√≥digo EJB2 original. Se</p>
<p>conservan algunos detalles de entidades, en las anotaciones. Sin embargo,</p>
<p>como no hay informaci√≥n fuera de las anotaciones, el c√≥digo es limpio y f√°cil</p>
<p>de probar, mantener y dem√°s.</p>
<p>Parte de la informaci√≥n de persistencia de las anotaciones se puede</p>
<p>cambiar a descriptores de implementaci√≥n XML si es necesario, dejando un</p>
<p>POJO puro. Si los detalles de asignaci√≥n de persistencia no cambian con</p>
<p>frecuencia, muchos equipos pueden optar por mantener las anotaciones pero</p>
<p>con menos obst√°culos que si usaran EJB2.</p>
<h3 id="aspectos-de-aspectj-186">Aspectos de AspectJ</h3>
<p>Por √∫ltimo, la herramienta m√°s completa de separaci√≥n a trav√©s de aspectos</p>
<p>[66]</p>
<p>es el lenguaje AspectJ , una extensi√≥n de Java que ofrece compatibilidad</p>
<p>de primer nivel para aspectos como construcciones de modularidad. Los</p>
<p>enfoques puros de Java proporcionados por Spring AOP y JBoss AOP son</p>
<p>suficientes en el 80-90 por 100 de los casos en los que los aspectos son √∫tiles.</p>
<p>Sin embargo, AspectJ ofrece un conjunto de herramientas avanzadas y</p>
<p>completas para la separaci√≥n de aspectos. El inconveniente de AspectJ es la</p>
<p>necesidad de adoptar nuevas herramientas y aprender nuevas construcciones</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>del lenguaje. Los problemas de adopci√≥n se han mitigado parcialmente</p>
<p>gracias a la introducci√≥n de un formato de anotaci√≥n de AspectJ, en el que se</p>
<p>usan anotaciones de Java 5 para definir aspectos con c√≥digo puro de Java.</p>
<p>Adem√°s, la estructura Spring dispone de funciones que facilitan la</p>
<p>incorporaci√≥n de aspectos basados en anotaciones en un equipo con</p>
<p>experiencia limitada con AspectJ.</p>
<p>El an√°lisis completo de AspectJ supera los objetivos de este libro. Si</p>
<p>necesita m√°s informaci√≥n al respecto, consulte [AspectJ], [Colyer] y [Spring].</p>
<h3 id="pruebas-de-unidad-de-la-arquitectura-del-sistema-187">Pruebas de unidad de la arquitectura del sistema</h3>
<p>La separaci√≥n trav√©s de enfoques similares aspectos no se puede</p>
<p>menospreciar. Si puede crear la l√≥gica de dominios de su aplicaci√≥n mediante</p>
<p>POJO, sin conexi√≥n con los aspectos arquitect√≥nicos a nivel del c√≥digo,</p>
<p>entonces se podr√° probar realmente la arquitectura. Puede evolucionar de</p>
<p>simple sofisticado, de acuerdo las necesidades, adoptando nuevas</p>
<p>tecnolog√≠as bajo demanda. No es necesario realizar un Buen dise√±o por</p>
<p>[67]</p>
<p>adelantado (Big Design Up Front , BDUF). De hecho, BDUF puede ser</p>
<p>negativo ya que impide la adaptaci√≥n al cambio, debido a la resistencia</p>
<p>fisiol√≥gica a descartar esfuerzos previos y a la forma en que las decisiones</p>
<p>arquitect√≥nicas influyen en la concepci√≥n posterior del dise√±o.</p>
<p>Los arquitectos deben realizar BDUF ya que no resulta factible aplicar</p>
<p>cambios arquitect√≥nicos radicales a una estructura f√≠sica una vez avanzada la</p>
<p>[68] [69]</p>
<p>construcci√≥n . Aunque el software se rige por una f√≠sica propia , es</p>
<p>econ√≥micamente factible realizar cambios radicales si la estructura del</p>
<p>software separa sus aspectos de forma eficaz.</p>
<p>Esto significa que podemos iniciar un proyecto de software con una</p>
<p>arquitectura simple pero bien desconectada, y ofrecer historias funcionales de</p>
<p>forma r√°pida, para despu√©s aumentar la infraestructura. Algunos de los</p>
<p>principales sitios Web del mundo han alcanzado una gran disponibilidad y</p>
<p>rendimiento por medio de sofisticadas t√©cnicas de almacenamiento en cach√©,</p>
<p>seguridad, virtualizaci√≥n y dem√°s, todo ello de forma eficaz y flexible ya que</p>
<p>los dise√±os m√≠nimamente conectados son adecuadamente simples en cada</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>nivel de abstracci√≥n √°mbito. Evidentemente, no quiere decir que</p>
<p>acometamos los proyectos sin tim√≥n. Debemos tener expectativas del √°mbito</p>
<p>general, objetivos y un programa, as√≠ como la estructura general del sistema</p>
<p>resultante. Sin embargo, debemos mantener la capacidad de cambiar de</p>
<p>rumbo en respuesta a las circunstancias.</p>
<p>La arquitectura EJB inicial es una de las API conocidas con un exceso de</p>
<p>ingenier√≠a y que compromete la separaci√≥n de aspectos. Incluso las API bien</p>
<p>dise√±adas pueden ser excesivas cuando no resultan necesarias. Una API</p>
<p>correcta debe desaparecer de la vista en la mayor√≠a de los casos, para que el</p>
<p>equipo dedique sus esfuerzos creativos a las historias implementadas. En caso</p>
<p>contrario, las limitaciones arquitect√≥nicas impedir√°n la entrega eficaz de un</p>
<p>valor √≥ptimo para el cliente. Para recapitular:</p>
<p>Una arquitectura de sistema √≥ptima se compone de dominios de</p>
<p>aspectos modularizados, cada uno implementado con POJO. Los</p>
<p>distintos dominios se integran mediante aspectos o herramientas</p>
<p>similares m√≠nimamente invasivas. Al igual que en el c√≥digo, en esta</p>
<p>arquitectura se pueden realizar pruebas.</p>
<h3 id="optimizar-la-toma-de-decisiones-188">Optimizar la toma de decisiones</h3>
<p>La modularidad y separaci√≥n de aspectos permite la descentralizaci√≥n de la</p>
<p>administraci√≥n y la toma de decisiones. En un sistema suficientemente</p>
<p>amplio, ya sea una ciudad o un proyecto de software , no debe haber una sola</p>
<p>persona que adopte todas las decisiones.</p>
<p>Sabemos que conviene delegar las responsabilidades en las personas m√°s</p>
<p>cualificadas. Solemos olvidar que tambi√©n conviene posponer decisiones</p>
<p>hasta el √∫ltimo momento. No es falta de responsabilidad; nos permite tomar</p>
<p>decisiones con la mejor informaci√≥n posible. Una decisi√≥n prematura siempre</p>
<p>es subjetiva. Si decidimos demasiado pronto, tendremos menos informaci√≥n</p>
<p>del cliente, reflexi√≥n mental sobre el proyecto y experiencia con las opciones</p>
<p>de implementaci√≥n.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>La agilidad que proporciona un sistema POJO con aspectos</p>
<p>modularizados nos permite adoptar decisiones √≥ptimas a tiempo,</p>
<p>basadas en los conocimientos m√°s recientes. Adem√°s, se reduce la</p>
<p>complejidad de estas decisiones.</p>
<h3 id="usar-estandares-cuando-anadan-un-valor-demostrable-189">Usar est√°ndares cuando a√±adan un valor demostrable</h3>
<p>La construcci√≥n de edificios es una maravilla para la vista debido al ritmo</p>
<p>empleado (incluso en invierno) y los extraordinarios dise√±os posibles gracias</p>
<p>a la tecnolog√≠a actual. La construcci√≥n es un sector maduro con elementos,</p>
<p>m√©todos y est√°ndares optimizados que han evolucionado bajo presi√≥n durante</p>
<p>siglos.</p>
<p>Muchos equipos usaron la arquitectura EJB2 por ser un est√°ndar, aunque</p>
<p>hubiera bastado con dise√±os m√°s ligeros y sencillos. He visto equipos</p>
<p>obsesionados con est√°ndares de moda y que se olvidaron de implementar el</p>
<p>valor para sus clientes.</p>
<p>Los est√°ndares facilitan la reutilizaci√≥n de ideas y componentes,</p>
<p>reclutan individuos con experiencia, encapsulan buenas ideas</p>
<p>conectan componentes. Sin embargo, el proceso de creaci√≥n de</p>
<p>est√°ndares puede tardar demasiado para el sector, y algunos pierden</p>
<p>el contacto con las verdaderas necesidades de aquello para los que</p>
<p>est√°n dirigidos.</p>
<h3 id="los-sistemas-necesitan-lenguajes-especificos-del-d-190">Los sistemas necesitan lenguajes espec√≠ficos del dominio</h3>
<p>La construcci√≥n de edificios, como muchos dominios, ha desarrollado un rico</p>
<p>[70]</p>
<p>lenguaje con vocabularios, frases y patrones que comunican informaci√≥n</p>
<p>esencial de forma clara y concisa. En el mundo del software , ha renacido el</p>
<p>inter√©s por crear Lenguajes espec√≠ficos del dominio Domain-Specific</p>
<p>[71]</p>
<p>Languages o DSL) , peque√±os lenguajes independientes de creaci√≥n de</p>
<p>secuencias de comandos o API de lenguajes est√°ndar que permiten crear</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>c√≥digo que se lea de una forma estructurada, como lo escribir√≠a un experto</p>
<p>del dominio. Un buen DSL minimiza el vac√≠o de comunicaci√≥n entre un</p>
<p>concepto de dominio y el c√≥digo que lo implementa, al igual que las pr√°cticas</p>
<p>√°giles optimizan la comunicaci√≥n entre un equipo y los accionistas del</p>
<p>proyecto. Si tiene que implementar la l√≥gica de dominios en el mismo</p>
<p>lenguaje usado por un experto del dominio, hay menos riesgo de traducir</p>
<p>incorrectamente el dominio en la implementaci√≥n.</p>
<p>Los DSL, si se usan de forma eficaz, aumentan el nivel de abstracci√≥n por</p>
<p>encima del c√≥digo y los patrones de dise√±o. Permiten al desarrollador revelar</p>
<p>la intenci√≥n del c√≥digo en el nivel de abstracci√≥n adecuado.</p>
<p>Los lenguajes espec√≠ficos del dominio permiten expresar como POJO</p>
<p>todos los niveles de abstracci√≥n y todos los dominios de la aplicaci√≥n,</p>
<p>desde directivas de nivel superior a los detalles m√°s m√≠nimos.</p>
<h3 id="conclusion-191">Conclusi√≥n</h3>
<p>Los sistemas tambi√©n deben ser limpios. Una arquitectura invasiva afecta a la</p>
<p>l√≥gica de dominios y a la agilidad. Si la l√≥gica de dominios se ve afectada, la</p>
<p>calidad se resiente, ya que los errores se ocultan y las historias son m√°s</p>
<p>dif√≠ciles de implementar. Si la agilidad se ve comprometida, la productividad</p>
<p>sufre y las ventajas de TDD se pierden.</p>
<p>En todos los niveles de abstracci√≥n, los objetivos deben ser claros. Esto</p>
<p>s√≥lo sucede si crea POJO y usa mecanismos similares a aspectos para</p>
<p>incorporar otros aspectos de implementaci√≥n de forma no invasiva.</p>
<p>Independientemente de que dise√±e sistemas o m√≥dulos individuales, no</p>
<p>olvide usar los elementos m√°s sencillos que funcionen.</p>
<h3 id="bibliografia-192">Bibliograf√≠a</h3>
<p>[Alexander] Christopher Alexander, Timeless Way of Building</p>
<p>Oxford University Press, New York, 1979.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[AOSD] Puerto de Desarrollo de software orientado aspectos,</p>
<p>http://aosd.net.</p>
<p>[ASM] : P√°gina de ASM, http://asm.objectweb.org/.</p>
<p>[AspectJ] : http: //eclipse.org/aspectj.</p>
<p>[CGLIB] Biblioteca de generaci√≥n de c√≥digo,</p>
<p>http://cglib.sourceforge.net/.</p>
<p>[Colyer] Adrian Colyer, Andy Clement, George Hurley, Mathew</p>
<p>Webster, Eclipse AspectJ , Person Education, Inc., Upper Saddle River,</p>
<p>NJ, 2005.</p>
<p>[DSL] Lenguaje de programaci√≥n espec√≠fico del dominio,</p>
<p>http://es.wikipedia.org/wiki/Lenguaje_espec%C3%ADfico_del_dominio.</p>
<p>[Fowler] : Inversi√≥n de contenedores de control y el patr√≥n de inyecci√≥n</p>
<p>de dependencias (http://martinfowler.com/articles/injection.html).</p>
<p>[Goetz] : Brian Goetz, Java Theory and Practice: Decorating with</p>
<p>Dynamic Proxies http://www.ibm.com/developerworks/java/library/j-</p>
<p>jtp08305.html.</p>
<p>[Javassist] P√°gina de Javassist,</p>
<p>http://www.csg.is.titech.ac.jp/chiba/javassist/.</p>
<p>[JBoss] : P√°gina de JBoss, http: //jboss.org.</p>
<p>[JMock] : JMock: Una biblioteca de objetos Mock ligeros para Java,</p>
<p>http://jmock.org.</p>
<p>[Kolence] Kenneth W. Kolence, Software physics and computer</p>
<p>performance measurements, Proceedings of the ACM annual</p>
<p>conference-Volume 2, Boston, Massachusetts, pp. 1024-1040,1972.</p>
<p>[Spring] The Spring Framework , http://www.springframework.org.</p>
<p>[Mezzaros07] XUnit Patterns Gerard Mezzaros, Addison-Wesley,</p>
<p>2007.</p>
<p>[GOF] Design Patterns: Elements of Reusable Object Oriented</p>
<p>Software , Gamma et al., Addison-Wesley, 1996.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="emergencia-193">Emergencia</h1>
<p>con Jeff Langr</p>
<h3 id="limpieza-a-traves-de-disenos-emergentes-194">Limpieza a trav√©s de dise√±os emergentes</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Imagine que existieran cuatro sencillas reglas para crear dise√±os de calidad.</p>
<p>Imagine que sigui√©ndolas accediera a la estructura y al dise√±o de su c√≥digo y</p>
<p>facilitara la aplicaci√≥n de principios como SRP y DIP. Imagine que estas</p>
<p>cuatro reglas facilitaran la emergencia de dise√±os de calidad.</p>
<p>Muchos consideramos que las cuatro reglas de Kent Beck de dise√±o</p>
<p>[72]</p>
<p>sencillo son fundamentales para crear un software bien dise√±ado.</p>
<p>Seg√∫n Kent, un dise√±o es sencillo si cumple estas cuatro reglas:</p>
<p>Ejecuta todas las pruebas.</p>
<p>No contiene duplicados.</p>
<p>Expresa la intenci√≥n del programador.</p>
<p>Minimiza el n√∫mero de clases y m√©todos.</p>
<p>Describiremos estas reglas en orden de importancia.</p>
<h3 id="primera-regla-del-diseno-sencillo-ejecutar-todas-l-195">Primera regla del dise√±o sencillo: Ejecutar todas las</h3>
<h3 id="pruebas-196">pruebas</h3>
<p>En primer lugar, un dise√±o debe generar un sistema que act√∫e de la forma</p>
<p>prevista. Un sistema puede tener un dise√±o perfecto sobre el papel pero si no</p>
<p>existe una forma sencilla de comprobar que realmente funciona de la forma</p>
<p>esperada, el esfuerzo sobre el papel es cuestionable.</p>
<p>Un sistema minuciosamente probado y que supera todas las pruebas en</p>
<p>todo momento se denomina sistema testable. Es una afirmaci√≥n obvia, pero</p>
<p>importante. Los sistemas que no se pueden probar no se pueden verificar, y</p>
<p>un sistema que no se puede verificar no debe implementarse.</p>
<p>Afortunadamente, crear sistemas testables hace que dise√±emos clases de</p>
<p>tama√±o reducido y un solo cometido. Resulta m√°s sencillo probar clases que</p>
<p>cumplen el SRP. Cuantas m√°s pruebas dise√±emos, m√°s nos acercaremos a</p>
<p>elementos m√°s f√°ciles de probar. Por lo tanto, hacer que nuestro sistema se</p>
<p>pueda probar nos ayuda a crear mejores dise√±os.</p>
<p>Las conexiones r√≠gidas dificultan la creaci√≥n de pruebas. Del mismo</p>
<p>modo, cuantas m√°s pruebas creemos, m√°s usaremos principios como DIP y</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>herramientas con inyecci√≥n de dependencias, interfaces y abstracci√≥n para</p>
<p>minimizar dichas conexiones. Nuestros dise√±os mejorar√°n todav√≠a m√°s.</p>
<p>En especial, seguir una sencilla regla que afirme que debemos realizar</p>
<p>pruebas y ejecutarlas continuamente afecta el cumplimiento por parte de</p>
<p>nuestro sistema de los principales objetivos de la programaci√≥n orientada a</p>
<p>objetos de baja conexi√≥n y elevada cohesi√≥n. La creaci√≥n de pruebas conduce</p>
<p>a obtener mejores dise√±os.</p>
<h3 id="reglas-2-a-4-del-diseno-sencillo-refactorizar-197">Reglas 2 a 4 del dise√±o sencillo: Refactorizar</h3>
<p>Una vez creadas las pruebas, debemos mantener limpio el c√≥digo y las clases.</p>
<p>Para ello, refactorizamos el c√≥digo progresivamente. Tras a√±adir unas l√≠neas,</p>
<p>nos detenemos y reflejamos el nuevo dise√±o. ¬øHa empeorado? En caso</p>
<p>afirmativo, lo limpiamos y ejecutamos las pruebas para comprobar que no</p>
<p>hay elementos afectados. La presencia de las pruebas hace que perdamos el</p>
<p>miedo a limpiar el c√≥digo y que resulte da√±ado</p>
<p>En la fase de refactorizaci√≥n, podemos aplicar todos los aspectos del</p>
<p>dise√±o de software correcto. Podemos aumentar la cohesi√≥n, reducir las</p>
<p>conexiones, separar las preocupaciones, modularizar aspectos del sistema,</p>
<p>reducir el tama√±o de funciones y clases, elegir nombres m√°s adecuados, etc.</p>
<p>Aqu√≠ tambi√©n aplicamos las tres √∫ltimas reglas del dise√±o correcto: eliminar</p>
<p>duplicados, garantizar la capacidad de expresi√≥n y minimizar el n√∫mero de</p>
<p>clases y m√©todos.</p>
<h3 id="eliminar-duplicados-198">Eliminar duplicados</h3>
<p>Los duplicados son los mayores enemigos de un sistema bien dise√±ado.</p>
<p>Suponen un esfuerzo adicional, riesgos a√±adidos una complejidad</p>
<p>mayores innecesaria. Los duplicados se manifiestan de diversas formas. Las</p>
<p>l√≠neas de c√≥digo similar pueden modificarse para que parezcan refactorizadas,</p>
<p>y hay otras formas de duplicaci√≥n como la de implementaci√≥n. Por ejemplo,</p>
<p>podr√≠amos tener dos m√©todos en una clase de colecci√≥n:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>int size() {}</p>
<p>boolean isEmpty() {}</p>
<p>Podr√≠amos tener implementaciones separadas para cada m√©todo. El</p>
<p>m√©todo isEmpty podr√≠a controlar un valor booleano y size un contador, o</p>
<p>podemos eliminar la duplicaci√≥n y vincular isEmpty a la definici√≥n de size</p>
<p>boolean isEmpty() {</p>
<p>return 0 == size();</p>
<p>La creaci√≥n de un sistema limpio requiere la eliminaci√≥n de duplicados,</p>
<p>aunque sean unas cuantas l√≠neas de c√≥digo. F√≠jese en el siguiente ejemplo:</p>
<p>public void scaleToOneDimension {</p>
<p>float desiredDimension, float imageDimension) {</p>
<p>if (Math.abs(desiredDimension - imageDimension) &lt; errorThreshold)</p>
<p>return;</p>
<p>float scalingFactor = desiredDimension / imageDimension;</p>
<p>scalingFactor = (float)(Math.floor(scalingFactor * 100) * 0.01f);</p>
<p>RenderedOp newImage = ImageUtilities.getScaledImage(</p>
<p>image, scalingFactor, scalingFactor);</p>
<p>image.dispose();</p>
<p>System.gc();</p>
<p>image = newImage;</p>
<p>public synchronized void rotate(int degrees) {</p>
<p>RenderedOp newImage = ImageUtilities.getRotatedImage(</p>
<p>image, degrees);</p>
<p>image.dispose();</p>
<p>System.gc();</p>
<p>image = newImage;</p>
<p>Para mantener limpio este sistema, debemos eliminar la peque√±a cantidad</p>
<p>de duplicaci√≥n entre los m√©todos scaleToOneDimension rotate</p>
<p>public void scaleToOneDimension (</p>
<p>float desiredDimension, float imageDimension) {</p>
<p>if (Math.abs(desiredDimension - imageDimension) &lt; errorThreshold)</p>
<p>return;</p>
<p>float scalingFactor = desiredDimension / imageDimension;</p>
<p>scalingFactor = (float)(Math.floor(scalingFactor * 100) * 0.01f);</p>
<p>replaceImage(ImageUtilities.getScaledImage(</p>
<p>image, scalingFactor, scalingFactor));</p>
<p>public synchronized void rotate (int degrees) {</p>
<p>replaceImage(ImageUtilities.getRotatedImage(image, degrees));</p>
<p>private void replaceImage(RenderedOp newImage) (</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>image.dispose();</p>
<p>System.gc();</p>
<p>image = newImage;</p>
<p>Al extraer a este reducido nivel, comenzamos a detectar incumplimientos</p>
<p>de SRP. Por ello, podr√≠amos cambiar un nuevo m√©todo extra√≠do a otra clase.</p>
<p>Esto aumenta su visibilidad. Otro miembro del equipo puede ver la necesidad</p>
<p>de volver a extraer el nuevo m√©todo y usarlo en otro contexto diferente. Esta</p>
<p>reutilizaci√≥n m√≠nima puede reducir considerablemente la complejidad del</p>
<p>sistema. Saber c√≥mo lograrlo es fundamental para alcanzar la reutilizaci√≥n a</p>
<p>gran escala.</p>
<p>[73]</p>
<p>El patr√≥n M√©todo de plantilla es una t√©cnica muy utilizada para</p>
<p>eliminar duplicados de nivel superior. Por ejemplo:</p>
<p>public class VacationPolicy {</p>
<p>public void accrueUSDivisionVacation() {</p>
<p>// c√≥digo para calcular las vacaciones en funci√≥n de las horas trabajadas</p>
<p>//...</p>
<p>// c√≥digo para garantizar que las vacaciones cumplen los m√≠nimos legales</p>
<p>//...</p>
<p>// c√≥digo para aplicar vacation al registro payroll</p>
<p>//...</p>
<p>public void accrueEUDivisionVacation() {</p>
<p>// c√≥digo para calcular las vacaciones en funci√≥n de las horas trabajadas</p>
<p>//...</p>
<p>// c√≥digo para garantizar que las vacaciones cumplen los m√≠nimos legales</p>
<p>//...</p>
<p>// c√≥digo para aplicar vacation al registro payroll</p>
<p>//...</p>
<p>El c√≥digo entre accrueUSDivisionVacation</p>
<p>accrueEuropeanDivisionVacation es pr√°cticamente id√©ntico, a excepci√≥n</p>
<p>del c√°lculo de m√≠nimos legales. Esa parte del algoritmo cambia en funci√≥n</p>
<p>del tipo de empleado. Podemos eliminar la duplicaci√≥n evidente si aplicamos</p>
<p>el patr√≥n de M√©todo de plantilla</p>
<p>abstract public class VacationPolicy {</p>
<p>public void accrueVacation() {</p>
<p>calculateBaseVacationHours();</p>
<p>alterForLegalMinimums();</p>
<p>applyToPayroll();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void calculateBaseVacationHours() { /* ... */ };</p>
<p>abstract protected void alterForLegalMinimums();</p>
<p>private void applyToPayroll(); { /* ... */ };</p>
<p>public class USVacationPolicy extends VacationPolicy {</p>
<p>@Override protected void alterForLegalMinimums() {</p>
<p>// L√≥gica espec√≠fica de EE.UU.</p>
<p>public class EUVacationPolicy extends VacationPolicy {</p>
<p>@Override protected void alterForLegalMinimums() {</p>
<p>// L√≥gica espec√≠fica de la UE.</p>
<p>Las subclases ocupan el vac√≠o generado en el algoritmo accrueVacation</p>
<p>y solamente proporcionan los datos que no est√°n duplicados.</p>
<h3 id="expresividad-199">Expresividad</h3>
<p>Muchos tenemos experiencia con c√≥digo enrevesado. Muchos lo hemos</p>
<p>creado. Es f√°cil crear c√≥digo que entendamos, ya que durante su creaci√≥n nos</p>
<p>centramos en comprender el problema que intentamos resolver. Los</p>
<p>encargados de mantener el c√≥digo no lo comprender√°n de la misma forma.</p>
<p>El principal coste de un proyecto de software es su mantenimiento a largo</p>
<p>plazo. Para minimizar los posibles defectos al realizar cambios, es</p>
<p>fundamental que comprendamos el funcionamiento del sistema. Al aumentar</p>
<p>la complejidad de los sistemas, el programador necesita m√°s tiempo para</p>
<p>entenderlo y aumentan las posibilidades de errores. Por tanto, el c√≥digo debe</p>
<p>expresar con claridad la intenci√≥n de su autor. Cuando m√°s claro sea el</p>
<p>c√≥digo, menos tiempo perder√°n otros en intentar comprenderlo. Esto reduce</p>
<p>los defectos y el coste de mantenimiento.</p>
<p>Puede expresarse si elige nombres adecuados. El objetivo es ver el</p>
<p>nombre de una clase funci√≥n, que sus responsabilidades no nos</p>
<p>sorprendan.</p>
<p>Tambi√©n puede expresarse si reduce el tama√±o de funciones y clases. Al</p>
<p>hacerlo, resulta m√°s sencillo asignarles nombres, crearlas y comprenderlas.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Otra forma de expresarse es usar una nomenclatura est√°ndar. Los patrones de</p>
<p>dise√±o, por ejemplo, se basan en la comunicaci√≥n y en la capacidad de</p>
<p>expresi√≥n. Al usar los nombres de patrones est√°ndar, como COMMAND</p>
<p>VISITOR , en los nombres de las clases que implementan dichos patrones</p>
<p>puede describir sucintamente su dise√±o a otros programadores.</p>
<p>Las pruebas de unidad bien escritas tambi√©n son expresivas. Uno de los</p>
<p>principales objetivos de una prueba es servir de documentaci√≥n mediante</p>
<p>ejemplos. Los que lean las pruebas deben entender con facilidad para qu√©</p>
<p>sirve una clase.</p>
<p>Pero la forma m√°s importante de ser expresivo es la pr√°ctica. A menudo,</p>
<p>conseguimos que el c√≥digo funcione y pasamos al siguiente problema sin</p>
<p>detenernos en facilitar la lectura del c√≥digo para otros. No olvide que</p>
<p>seguramente sea el pr√≥ximo que lea el c√≥digo.</p>
<p>Por tanto, afronte su creaci√≥n con orgullo. Dedique tiempo sus</p>
<p>funciones clases. Seleccione nombres mejores, divida las funciones</p>
<p>extensas en otras m√°s reducidas y cuide su obra. El cuidado es un recurso</p>
<p>precioso.</p>
<h3 id="clases-y-metodos-minimos-200">Clases y m√©todos m√≠nimos</h3>
<p>Incluso conceptos tan b√°sicos como la eliminaci√≥n de c√≥digo duplicado, la</p>
<p>expresividad del c√≥digo y SRP pueden exagerarse. En un esfuerzo por reducir</p>
<p>el tama√±o de clases y m√©todos, podemos crear demasiadas clases y m√©todos</p>
<p>reducidos. Esta regla tambi√©n sugiere minimizar la cantidad de funciones y</p>
<p>clases.</p>
<p>Una gran cantidad de clases y m√©todos suele indicar un dogmatismo sin</p>
<p>sentido. Imagine un est√°ndar de c√≥digo que insista en la creaci√≥n de una</p>
<p>interfaz para todas las clases, o a programadores que insisten en qu√© campos</p>
<p>y comportamientos siempre deben separarse en clases de datos y clases de</p>
<p>comportamiento. Este dogma debe evitarse y cambiarse por un enfoque m√°s</p>
<p>pragm√°tico.</p>
<p>Nuestro objetivo es reducir el tama√±o general del sistema adem√°s del</p>
<p>tama√±o de clases y funciones, pero recuerde que esta regla es la de menor</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>prioridad de las cuatro. Por ello, aunque sea importante reducir la cantidad de</p>
<p>clases funciones, es m√°s importante contar con pruebas, eliminar</p>
<p>duplicados y expresarse correctamente.</p>
<h3 id="conclusion-201">Conclusi√≥n</h3>
<p>¬øExisten pr√°cticas sencillas que puedan reemplazar a la experiencia? Por</p>
<p>supuesto que no. Sin embargo, las pr√°cticas descritas en este cap√≠tulo y en el</p>
<p>libro son una forma cristalizada de d√©cadas de experiencia de muchos</p>
<p>autores. La pr√°ctica del dise√±o correcto anima y permite a los programadores</p>
<p>adoptar principios patrones que en caso contrario tardar√≠an a√±os en</p>
<p>aprender.</p>
<h3 id="bibliografia-202">Bibliograf√≠a</h3>
<p>[XPE] Extreme Programming Explained: Embrace Change Kent</p>
<p>Beck, Addison Wesley, 1999.</p>
<p>[GOF] Design Patterns: Elements of Reusable Object Oriented</p>
<p>Software , Gamma et al., Addison-Wesley, 1996.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="concurrencia-203">Concurrencia</h1>
<p>por Brett L. Schuchert</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>‚ÄúLos objetos son abstracciones de procesamiento.</p>
<p>Los subprocesos son abstracciones de programaciones‚Äù.</p>
<p>[74]</p>
<p>‚ÄîJames O. Coplien</p>
<p>La creaci√≥n de programas concurrentes limpios es complicada, muy</p>
<p>complicada. Es mucho m√°s sencillo crear c√≥digo que se ejecute en un mismo</p>
<p>proceso. Tambi√©n es f√°cil crear c√≥digo de subprocesamiento m√∫ltiple que</p>
<p>parezca correcto en la superficie pero que est√© da√±ado niveles m√°s</p>
<p>profundos. Este c√≥digo funciona correctamente hasta que el sistema se</p>
<p>somete a determinadas presiones.</p>
<p>En este cap√≠tulo analizaremos la necesidad de la programaci√≥n</p>
<p>concurrente sus dificultades. Tras ello, presentaremos diversas</p>
<p>recomendaciones para superar dichas dificultades y crear c√≥digo concurrente</p>
<p>limpio. Por √∫ltimo, finalizaremos con los problemas relacionados con la</p>
<p>prueba de c√≥digo concurrente.</p>
<p>La concurrencia limpia es un tema complejo, merecedor de un libro</p>
<p>propio. Aqu√≠, intentaremos ofrecer una visi√≥n general, que despu√©s</p>
<p>ampliaremos en el ap√©ndice A. Si simplemente tiene curiosidad por el tema,</p>
<p>le bastar√° con este cap√≠tulo. Si necesita entender la concurrencia a un nivel</p>
<p>m√°s profundo, consulte tambi√©n el ap√©ndice.</p>
<h3 id="por-que-concurrencia-204">¬øPor qu√© concurrencia?</h3>
<p>La concurrencia es una estrategia de desvinculaci√≥n. Nos permite desvincular</p>
<p>lo que se hace de d√≥nde se hace. En aplicaci√≥n de un solo proceso, el qu√© y el</p>
<p>cu√°ndo est√°n tan firmemente vinculados que el estado de la aplicaci√≥n se</p>
<p>puede determinar analizando la huella de la pila. Un programador que depure</p>
<p>este tipo de sistemas puede definir un punto de interrupci√≥n (o varios) y saber</p>
<p>el estado de la aplicaci√≥n en funci√≥n del punto al que se llegue.</p>
<p>La desvinculaci√≥n del qu√© del d√≥nde puede mejorar considerablemente el</p>
<p>rendimiento y la estructura de una aplicaci√≥n. Desde un punto de vista</p>
<p>estructural, la aplicaci√≥n parece una serie de equipos colaboradores y no un</p>
<p>gran bucle principal. Esto puede hacer que el sistema sea m√°s f√°cil de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>comprender ofrece diversas formas de separar las preocupaciones.</p>
<p>Pongamos por caso el modelo Servlet est√°ndar de aplicaciones Web. Estos</p>
<p>sistemas se ejecutan bajo un contenedor Web EJB que gestiona</p>
<p>parcialmente la concurrencia. Los servlet se ejecutan de forma as√≠ncrona</p>
<p>cuando se reciben solicitudes Web. El programador de los servlet no tiene</p>
<p>que gestionar todas las solicitudes entrantes. En principio, la ejecuci√≥n de</p>
<p>cada servlet vive en un mundo propio y se desvincula del resto.</p>
<p>Evidentemente, si fuera tan sencillo, no necesitar√≠amos este cap√≠tulo. De</p>
<p>hecho, la desvinculaci√≥n proporcionada por los contenedores Web dista</p>
<p>mucho de ser perfecta. Los programadores de servlet deben asegurarse de que</p>
<p>sus programas sean correctos. No obstante, las ventajas estructurales del</p>
<p>modelo de servlet son significativas.</p>
<p>Pero la estructura no es el √∫nico motivo para adoptar la concurrencia.</p>
<p>Algunos sistemas tienen limitaciones de tiempo de respuesta y producci√≥n</p>
<p>que requieren soluciones concurrentes manuales. Imagine un dispositivo para</p>
<p>a√±adir informaci√≥n, con un solo proceso, que obtiene datos de distintos sitios</p>
<p>Web y los combina en un resumen diario. Al tener un solo proceso, accede</p>
<p>por turnos a cada sitio Web y siempre termina uno antes de comenzar el</p>
<p>siguiente. Su recorrido diario debe ejecutarse en menos de 24 horas. Sin</p>
<p>embargo, al a√±adir nuevos sitios Web, el tiempo aumenta hasta necesitarse</p>
<p>m√°s de 24 horas para recopilar todos los datos. El √∫nico proceso implica una</p>
<p>prolongada espera para completar la E/S. Podr√≠amos mejorar el rendimiento</p>
<p>con ayuda de un algoritmo de subprocesamiento m√∫ltiple que visite m√°s de</p>
<p>un sitio Web por vez.</p>
<p>Imagine un sistema que procesa un usuario por vez y s√≥lo requiere un</p>
<p>segundo por cada uno. Su capacidad de respuesta es v√°lida para un n√∫mero</p>
<p>reducido de usuarios pero si aumenta, tambi√©n lo hace el tiempo de respuesta</p>
<p>del sistema. Ning√∫n usuario querr√° esperar a otros 150. Podr√≠amos mejorar el</p>
<p>tiempo de respuesta de este sistema procesando varios usuarios a la vez.</p>
<p>Imagine un sistema que interprete grandes conjuntos de datos pero que s√≥lo</p>
<p>ofrezca una soluci√≥n completa tras procesarlos todos. Se podr√≠a procesar cada</p>
<p>conjunto de datos en un equipo distinto, para poder procesarlos todos en</p>
<p>paralelo.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="mitos-e-imprecisiones-205">Mitos e imprecisiones</h3>
<p>Tambi√©n existen motivos evidentes para adoptar la concurrencia aunque,</p>
<p>como indicamos antes, sea complicada. Si no presta la suficiente atenci√≥n,</p>
<p>pueden darse casos desagradables. Veamos los mitos e imprecisiones m√°s</p>
<p>habituales:</p>
<p>La concurrencia siempre mejora el rendimiento : En ocasiones lo hace</p>
<p>pero s√≥lo cuando se puede compartir tiempo entre varios procesos o</p>
<p>procesadores. Ninguna situaci√≥n es trivial.</p>
<p>El dise√±o no cambia al crear programas concurrentes : De hecho, el</p>
<p>dise√±o de un algoritmo concurrente puede ser muy distinto al de un</p>
<p>sistema de un solo proceso. La desvinculaci√≥n entre el qu√© y el cu√°ndo</p>
<p>suele tener un efecto importante en la estructura del sistema.</p>
<p>No es importante entender los problemas de concurrencia al trabajar</p>
<p>con un contenedor Web o EJB : En realidad, debe saber lo que hace su</p>
<p>contenedor y protegerlo de problemas de actualizaciones concurrentes y</p>
<p>bloqueo, como veremos despu√©s.</p>
<p>Veamos otros aspectos relacionados con la creaci√≥n de software</p>
<p>concurrente:</p>
<p>La concurrencia genera cierta sobrecarga , tanto en rendimiento como</p>
<p>en la creaci√≥n de c√≥digo adicional.</p>
<p>La concurrencia correcta es compleja , incluso para problemas sencillos.</p>
<p>Los errores de concurrencia no se suelen repetir , de modo que se</p>
<p>[75]</p>
<p>ignoran en lugar de considerarse verdaderos problemas.</p>
<p>La concurrencia suele acarrear un cambio fundamental de la estrategia</p>
<p>de dise√±o</p>
<h3 id="desafios-206">Desaf√≠os</h3>
<p>¬øQu√© hace que la programaci√≥n concurrente sea tan complicada? F√≠jese en la</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>siguiente clase:</p>
<p>public class X {</p>
<p>private int lastIdUsed;</p>
<p>public int getNextId() {</p>
<p>return ++lastIdUsed;</p>
<p>Imagine que creamos una instancia , establecemos el campo lastIdUsed</p>
<p>en 42 y despu√©s compartimos la instancia entre dos procesos. Imagine ahora</p>
<p>que esos dos procesos invocan el m√©todo getNextId() ; hay tres resultados</p>
<p>posibles:</p>
<p>El primer proceso obtiene el valor 43, el segundo el valor 44 y</p>
<p>lastIdUsed es 44.</p>
<p>El primer proceso obtiene el valor 44, el segundo el valor 43 y</p>
<p>lastIdUsed es 44.</p>
<p>El primer proceso obtiene el valor 43, el segundo el valor 43 y</p>
<p>lastIdUsed es 43.</p>
<p>[76]</p>
<p>El sorprendente tercer resultado se produce cuando los dos procesos</p>
<p>coinciden. Se debe a que pueden adoptar varias rutas posibles en una l√≠nea de</p>
<p>c√≥digo de Java y algunas generan resultados incorrectos. ¬øCu√°ntas rutas</p>
<p>distintas existen? Para responder, debemos entender lo que hace el</p>
<p>compilador justo a tiempo con el c√≥digo de bytes generado, y lo que el</p>
<p>modelo de memoria de Java considera at√≥mico.</p>
<p>Una r√°pida respuesta, con el c√≥digo de bytes generado, es que existen</p>
<p>[77]</p>
<p>12 870 rutas de ejecuci√≥n diferentes para los dos procesos ejecutados en el</p>
<p>m√©todo getNextId . Si el tipo de lastIdUsed cambia de int long , el</p>
<p>n√∫mero de rutas asciende a 2 704 156. Evidentemente, muchas generan</p>
<p>resultados v√°lidos. El problema es que algunas no lo hacen</p>
<h3 id="principios-de-defensa-de-la-concurrencia-207">Principios de defensa de la concurrencia</h3>
<p>A continuaci√≥n le mostramos una serie de principios y t√©cnicas para proteger</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>a sus sistemas de los problemas del c√≥digo concurrente.</p>
<h3 id="principio-de-responsabilidad-unica-srp-208">Principio de responsabilidad √∫nica (SRP)</h3>
<p>[78]</p>
<p>SRP establece que un m√©todo, clase o componente s√≥lo debe tener un</p>
<p>motivo para cambiar. El dise√±o de concurrencia es lo bastante complejo como</p>
<p>para ser un motivo de cambio con derecho propio y, por tanto, debe separarse</p>
<p>del resto del c√≥digo. Desafortunadamente, es habitual incrustar los detalles de</p>
<p>la implementaci√≥n de concurrencia directamente en otro c√≥digo de</p>
<p>producci√≥n.</p>
<p>Tenga en cuenta los siguientes aspectos:</p>
<p>El c√≥digo relacionado con la concurrencia tiene su propio ciclo de</p>
<p>desarrollo , cambios y ajustes.</p>
<p>El c√≥digo relacionado con la concurrencia tiene sus propios desaf√≠os</p>
<p>diferentes y m√°s complicados, que los del c√≥digo no relacionado con la</p>
<p>concurrencia.</p>
<p>El n√∫mero de formas en las que el c√≥digo incorrecto basado en la</p>
<p>concurrencia puede fallar lo complica ya de por s√≠, sin la carga a√±adida</p>
<p>del c√≥digo de aplicaci√≥n circundante.</p>
<p>Recomendaci√≥n Separe el c√≥digo de concurrencia del resto del</p>
<p>[79]</p>
<p>c√≥digo</p>
<h3 id="corolario-limitar-el-ambito-de-los-datos-209">Corolario: Limitar el √°mbito de los datos</h3>
<p>Como hemos visto, dos procesos que modifican el mismo campo u objeto</p>
<p>compartido pueden interferir entre ellos y provocar un comportamiento</p>
<p>inesperado. Una soluci√≥n consiste en usar la palabra clave synchronized</p>
<p>para proteger una secci√≥n importante del c√≥digo que use el objeto</p>
<p>compartido, aunque conviene limitar la cantidad de estas secciones. Cuantos</p>
<p>m√°s puntos actualicen datos compartidos, es m√°s probable que:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Se olvide de proteger uno o varios de esos puntos, y se da√±e el c√≥digo</p>
<p>que modifica los datos compartidos.</p>
<p>Se duplique el esfuerzo necesario para garantizar la protecci√≥n de todos</p>
<p>[80]</p>
<p>los elementos (incumplimiento de DRY ).</p>
<p>Resulta complicado determinar el origen de los fallos, que por</p>
<p>naturaleza son dif√≠ciles de detectar.</p>
<p>Recomendaci√≥n Encapsule los datos y limite el acceso a los datos</p>
<p>compartidos</p>
<h3 id="corolario-usar-copias-de-datos-210">Corolario: Usar copias de datos</h3>
<p>Una forma de evitar datos compartidos es no compartirlos. En algunos casos</p>
<p>se pueden copiar objetos y procesarlos como si fueran de s√≥lo lectura. En</p>
<p>otros, se pueden copiar objetos, recopilar los resultados de varios procesos en</p>
<p>las copias y despu√©s combinar los resultados en un mismo proceso. Si existe</p>
<p>una forma sencilla de evitar los objetos compartidos, el c√≥digo resultante</p>
<p>tendr√° menos problemas. Puede que le preocupe el coste de la creaci√≥n de</p>
<p>objetos adicionales. Merece la pena experimentar y comprobar si es un</p>
<p>problema real. No obstante, si el uso de copias de objetos permite al c√≥digo</p>
<p>evitar la sincronizaci√≥n, las ventajas de evitar el bloque compensan la</p>
<p>creaci√≥n adicional y la sobrecarga de la recolecci√≥n de elementos sin usar.</p>
<h3 id="corolario-los-procesos-deben-ser-independientes-211">Corolario: Los procesos deben ser independientes</h3>
<p>Pruebe a crear el c√≥digo de sus procesos de forma que cada uno sea</p>
<p>independiente y no comparta datos con otros. Cada uno procesa una solicitud</p>
<p>cliente y todos los datos necesarios provienen de un origen sin compartir y se</p>
<p>almacenan como variables locales. De este modo, los procesos se comportan</p>
<p>como si fueran los √∫nicos del mundo no existieran requisitos de</p>
<p>sincronizaci√≥n. Por ejemplo, las subclases de HttpServlet reciben toda su</p>
<p>informaci√≥n como par√°metros pasados en los m√©todos doGet doPost . Esto</p>
<p>hace que cada servlet act√∫e como si dispusiera de su propio equipo. Mientras</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>el c√≥digo del servlet s√≥lo use variables locales, es imposible que cause</p>
<p>problemas de sincronizaci√≥n. Evidentemente, muchas aplicaciones que usan</p>
<p>servlet se topan con recursos compartidos como conexiones de base de</p>
<p>datos.</p>
<p>Recomendaci√≥n Intente dividir los datos en subconjuntos</p>
<p>independientes que se puedan procesar en procesos independientes,</p>
<p>posiblemente en distintos procesadores</p>
<h3 id="conocer-las-bibliotecas-212">Conocer las bibliotecas</h3>
<p>Java 5 ofrece muchas mejoras para el desarrollo concurrente con respecto a</p>
<p>versiones anteriores. Existen diversos aspectos que tener en cuenta a la hora</p>
<p>de crear c√≥digo de procesos en Java 5:</p>
<p>Usar las colecciones compatibles con procesos proporcionadas.</p>
<p>Usar la estructura de ejecuci√≥n de tareas no relacionadas.</p>
<p>Usar soluciones antibloqueo siempre que sea posible.</p>
<p>Varias clases de bibliotecas no son compatibles con procesos.</p>
<h3 id="colecciones-compatibles-con-procesos-213">Colecciones compatibles con procesos</h3>
<p>[81]</p>
<p>En los albores de Java, Doug Lea escribi√≥ el conocido libro Concurrent</p>
<p>Programming in Java Al mismo tiempo, desarroll√≥ varias colecciones</p>
<p>compatibles con procesos, que posteriormente pasaron a formar parte del</p>
<p>JDK en el paquete java.util.concurrent . Las colecciones de dicho paquete</p>
<p>son compatibles con casos de procesos m√∫ltiples y tienen un rendimiento</p>
<p>adecuado. De hecho, la implementaci√≥n ConcurrentHashMap tiene mejor</p>
<p>rendimiento que HashMap en la mayor√≠a de los casos. Tambi√©n permite</p>
<p>lecturas escrituras simult√°neas, dispone de m√©todos que admiten</p>
<p>operaciones de composici√≥n habituales que en caso contrario serian</p>
<p>incompatibles con subprocesos. Si Java 5 es su entorno de desarrollo,</p>
<p>comience con ConcurrentHashMap</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Existen otras clases a√±adidas para admitir dise√±o avanzado de</p>
<p>concurrencia. Veamos algunos ejemplos:</p>
<p>ReentrantLock Bloqueo que se puede adquirir en un m√©todo y liberar en</p>
<p>otro.</p>
<p>semaphore Una implementaci√≥n del cl√°sico sem√°foro, un bloqueo con</p>
<p>un contador.</p>
<p>CountDownLatch Bloqueo que espera un n√∫mero de eventos antes de liberar</p>
<p>todos los subprocesos retenidos. De este modo todos</p>
<p>tienen la misma oportunidad de iniciarse al mismo tiempo.</p>
<p>Recomendaci√≥n Revise las clases de las que disponga. En el caso de</p>
<p>Java, debe familiarizarse con java.util.concurrent,</p>
<p>java.util.concurrent.atomic y java.util.concurrent.locks</p>
<h3 id="conocer-los-modelos-de-ejecucion-214">Conocer los modelos de ejecuci√≥n</h3>
<p>Existen diversas formas de dividir el comportamiento de una aplicaci√≥n</p>
<p>concurrente. Para describirlos debe conocer ciertas definiciones b√°sicas.</p>
<p>Recursos Recursos de tama√±o o n√∫mero fijo usados en un entorno</p>
<p>vinculados</p>
<p>concurrente, como por ejemplo conexiones de base de datos y</p>
<p>b√∫fer de lectura/escritura de tama√±o fijo.</p>
<p>Exclusi√≥n S√≥lo un proceso puede acceder a datos o a un recurso</p>
<p>mutua</p>
<p>compartido por vez.</p>
<p>Inanici√≥n Se impide que un proceso o grupo de procesos contin√∫en</p>
<p>demasiado tiempo o indefinidamente. Por ejemplo, si permite</p>
<p>primero la ejecuci√≥n de los procesos m√°s r√°pidos, los que se</p>
<p>ejecutan durante m√°s tiempo pueden perecer de inanici√≥n si los</p>
<p>primeros no terminan nunca.</p>
<p>Bloqueo Dos o m√°s procesos esperan a que ambos terminen. Cada</p>
<p>proceso tiene un recurso y ninguno puede terminar hasta que</p>
<p>obtenga el otro recurso.</p>
<p>Bloqueo Procesos bloqueados, intentando realizar su labor pero</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>activo estorb√°ndose unos a otros. Por motivos de resonancia, los</p>
<p>procesos siguen intentando avanzar pero no pueden durante</p>
<p>demasiado tiempo, o de forma indefinida.</p>
<p>Tras mostrar estas definiciones, ya podemos describir los distintos</p>
<p>modelos de ejecuci√≥n empleados en la programaci√≥n concurrente.</p>
<p>[82]</p>
<h3 id="productor-consumidor-215">Productor-Consumidor</h3>
<p>Uno o varios procesos productores crean trabajo y lo a√±aden a un b√∫fer o a</p>
<p>una cola. Uno o varios procesos consumidores adquieren dicho trabajo de la</p>
<p>cola y lo completan. La cola entre productores y consumidores es un recurso</p>
<p>vinculado, lo que significa que los productores deben esperar a que se libere</p>
<p>espacio en la cola antes de escribir y los consumidores deben esperar hasta</p>
<p>que haya algo que consumir en la cola. La coordinaci√≥n entre productores y</p>
<p>consumidores a trav√©s de la cola hace que unos emitan se√±ales a otros. Los</p>
<p>productores escriben en la cola indican que ya no est√° vac√≠a. Los</p>
<p>consumidores leen de la cola e indican que ya no est√° llena. Ambos esperan</p>
<p>la notificaci√≥n para poder continuar.</p>
<p>[83]</p>
<h3 id="lectores-escritores-216">Lectores-Escritores</h3>
<p>Cuando un recurso compartido act√∫a b√°sicamente como fuente de</p>
<p>informaci√≥n para lectores pero ocasionalmente se actualiza por parte de</p>
<p>escritores, la producci√≥n es un problema. El √©nfasis de la producci√≥n puede</p>
<p>provocar la inanici√≥n la acumulaci√≥n de informaci√≥n caducada. Las</p>
<p>actualizaciones pueden afectar a la producci√≥n. La coordinaci√≥n de lectores</p>
<p>para que no lean algo que un escritor est√° actualizando y viceversa es</p>
<p>complicada. Los escritores tienden a bloquear a los lectores durante periodos</p>
<p>prolongados, lo que genera problemas de producci√≥n.</p>
<p>El desaf√≠o consiste en equilibrar las necesidades de ambos para satisfacer</p>
<p>un funcionamiento correcto, proporcionar una producci√≥n razonable y evitar</p>
<p>la inanici√≥n. Una sencilla estrategia hace que los escritores esperen hasta que</p>
<p>deje de haber lectores antes de realizar una actualizaci√≥n. Si hay lectores</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>continuos, los escritores perecen de inanici√≥n.</p>
<p>Por otra parte, si hay escritores frecuentes y se les asigna prioridad, la</p>
<p>producci√≥n se ve afectada. Determinar el equilibrio y evitar problemas de</p>
<p>actualizaci√≥n concurrente es el objetivo de este modelo.</p>
<p>[84]</p>
<h3 id="la-cena-de-los-filosofos-217">La cena de los fil√≥sofos</h3>
<p>Imagine varios fil√≥sofos sentados alrededor de una mesa redonda. A la</p>
<p>izquierda de cada uno hay un tenedor. En el centro de la mesa, una gran</p>
<p>fuente de espaguetis. Los fil√≥sofos pasan el tiempo pensando a menos que</p>
<p>tengan hambre. Cuando tienen hambre, utilizan los tenedores situados a</p>
<p>ambos lados para comer. No pueden comer menos que tengan dos</p>
<p>tenedores. Si el fil√≥sofo situado a la derecha o izquierda de otros ya tiene uno</p>
<p>de los tenedores que necesita, tendr√° que esperar a que termine de comer y</p>
<p>deje los tenedores. Cuando un fil√≥sofo termina de comer, vuelve a colocar los</p>
<p>tenedores en la mesa hasta que vuelve a tener hambre. Cambie los fil√≥sofos</p>
<p>por procesos y los tenedores por recursos y tendr√° un problema habitual en</p>
<p>muchas aplicaciones en las que los procesos compiten por recursos. A menos</p>
<p>que se dise√±en correctamente, los sistemas que compiten de esta forma</p>
<p>experimentan problemas de bloqueo, bloqueo mutuo, producci√≥n</p>
<p>degradaci√≥n de la eficacia. La mayor√≠a de problemas de concurrencia que</p>
<p>encontrar√° ser√°n alguna variante de √©stos. Analice los algoritmos y cree</p>
<p>soluciones propias para estar preparado cuando surjan problemas de</p>
<p>concurrencia.</p>
<p>Recomendaci√≥n Aprenda estos algoritmos b√°sicos y comprenda sus</p>
<p>soluciones</p>
<h3 id="dependencias-entre-metodos-sincronizados-218">Dependencias entre m√©todos sincronizados</h3>
<p>Las dependencias entre m√©todos sincronizados generan sutiles errores en el</p>
<p>c√≥digo concurrente. Java cuenta con synchronized , que protege m√©todos</p>
<p>individuales. No obstante, si hay m√°s de un m√©todo sincronizado en la misma</p>
<p>[85]</p>
<p>clase compartida, puede que su sistema sea incorrecto</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Recomendaci√≥n Evite usar m√°s de un m√©todo en un objeto compartido</p>
<p>En ocasiones tendr√° que usar m√°s de un m√©todo en un objeto compartido.</p>
<p>En ese caso, hay tres formas de crear c√≥digo correcto:</p>
<p>Bloqueo basado en clientes : El cliente debe bloquear al servidor antes</p>
<p>de invocar el primer m√©todo y asegurarse de que el alcance del bloque</p>
<p>incluye el c√≥digo que invoque el √∫ltimo m√©todo.</p>
<p>Bloqueo basado en servidores : Debe crear un m√©todo en el servidor</p>
<p>que bloquee el servidor, invoque todos los m√©todos y despu√©s anule el</p>
<p>bloqueo. El cliente debe invocar el nuevo m√©todo.</p>
<p>Servidor adaptado : Cree un intermediario que realice el bloque. Es un</p>
<p>ejemplo de bloqueo basado en servidores en el que el servidor original</p>
<p>no se puede modificar.</p>
<h3 id="reducir-el-tamano-de-las-secciones-sincronizadas-219">Reducir el tama√±o de las secciones sincronizadas</h3>
<p>La palabra clave synchronized presenta un bloqueo. Todas las secciones de</p>
<p>c√≥digo protegidas por el mismo bloque s√≥lo tendr√°n un proceso que las</p>
<p>ejecute en un momento dado. Los bloqueos son costosos ya que generan</p>
<p>retrasos y a√±aden sobrecarga. Por ello, no conviene colapsar el c√≥digo con</p>
<p>[86]</p>
<p>instrucciones synchronized . Por otra parte, las secciones cr√≠ticas deben</p>
<p>protegerse, de modo que debemos dise√±ar nuestro c√≥digo con el menor</p>
<p>n√∫mero posible de secciones cr√≠ticas.</p>
<p>Algunos programadores intentan lograrlo ampliando el tama√±o de sus</p>
<p>secciones cr√≠ticas. Sin embargo, al ampliar la sincronizaci√≥n m√°s all√° de la</p>
<p>secci√≥n cr√≠tica m√≠nima aumentan los problemas y afecta negativamente al</p>
<p>[87]</p>
<p>rendimiento</p>
<p>Recomendaci√≥n Reduzca al m√°ximo el tama√±o de las secciones</p>
<p>synchronized</p>
<h3 id="crear-codigo-de-cierre-correcto-es-complicado-220">Crear c√≥digo de cierre correcto es complicado</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Crear un sistema activo y que se ejecute indefinidamente es distinto a crear</p>
<p>algo que funcione de forma temporal y despu√©s se cierre correctamente. Entre</p>
<p>[88]</p>
<p>los problemas m√°s habituales destacan los bloqueos , con procesos que</p>
<p>esperan una se√±al para continuar que nunca se produce.</p>
<p>Imagine, por ejemplo, un sistema con un proceso principal que genera</p>
<p>varios procesos secundarios y que espera a que todos terminen antes de</p>
<p>liberar sus recursos cerrarse. ¬øQu√© sucede si uno de los procesos</p>
<p>secundarios est√° bloqueado? El principal esperar√° indefinidamente y el</p>
<p>sistema nunca se cerrar√°.</p>
<p>Imagine ahora un sistema similar al que se le indica que se cierre. El</p>
<p>proceso principal indica a todos los secundarios que abandonen sus tareas y</p>
<p>terminen. Pero imagine que dos procesos secundarios funcionan como par</p>
<p>productor/consumidor y que el productor recibe una se√±al del principal y se</p>
<p>cierra r√°pidamente. El consumidor espera un mensaje del productor y puede</p>
<p>quedar bloqueado en un estado en el que no recibe la se√±al del principal, lo</p>
<p>que tambi√©n impide que √©ste finalice.</p>
<p>Son situaciones habituales. Por tanto, si tiene que crear c√≥digo</p>
<p>concurrente con cierres correctos, tendr√° que dedicar tiempo a que el cierre se</p>
<p>produzca de forma correcta.</p>
<p>Recomendaci√≥n Planifique con antelaci√≥n el proceso de cierre</p>
<p>pru√©belo hasta que funcione. Le llevar√° m√°s tiempo del que espera. Repase</p>
<p>los algoritmos existentes porque ser√° complicado</p>
<h3 id="probar-codigo-con-procesos-221">Probar c√≥digo con procesos</h3>
<p>Demostrar que el c√≥digo es correcto no resulta pr√°ctico. Las pruebas no</p>
<p>garantizan su correcci√≥n. Sin embargo, las pruebas adecuadas pueden</p>
<p>minimizar los riesgos, en especial en aplicaciones de un solo proceso.</p>
<p>Cuando hay dos o m√°s procesos que usan el mismo c√≥digo y trabajan con</p>
<p>datos compartidos, la situaci√≥n se vuelve m√°s compleja.</p>
<p>Recomendaci√≥n Cree pruebas que puedan detectar problemas</p>
<p>ejec√∫telas peri√≥dicamente, con distintas configuraciones de programaci√≥n y</p>
<p>del sistema, y cargas. Si las pruebas fallan, identifique el fallo. No lo ignore</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>porque las pruebas superen una ejecuci√≥n posterior</p>
<p>Hay muchos factores que tener en cuenta. Veamos algunas</p>
<p>recomendaciones concretas:</p>
<p>Considere los fallos como posibles problemas de los procesos.</p>
<p>Consiga que primero funcione el c√≥digo sin procesos.</p>
<p>El c√≥digo con procesos se debe poder conectar a otros elementos.</p>
<p>El c√≥digo con procesos debe ser modificable.</p>
<p>Ejecute con m√°s procesos que procesadores.</p>
<p>Ejecute en diferentes plataformas.</p>
<p>Dise√±e el c√≥digo para probar y forzar fallos.</p>
<h3 id="considerar-los-fallos-como-posibles-problemas-de-l-222">Considerar los fallos como posibles problemas de los</h3>
<h3 id="procesos-223">procesos</h3>
<p>El c√≥digo con procesos hace que fallen elementos que no deber√≠an fallar.</p>
<p>Muchos desarrolladores desconocen c√≥mo interact√∫an los procesos con otro</p>
<p>tipo de c√≥digo. Los problemas del c√≥digo con procesos pueden mostrar sus</p>
<p>s√≠ntomas una vez cada mil o un mill√≥n de ejecuciones.</p>
<p>Los intentos por repetir los sistemas pueden resultar frustrantes, lo que</p>
<p>suele provocar que los programadores consideren el fallo como algo aislado.</p>
<p>Es recomendable asumir que los fallos aislados no existen. Cuanto m√°s los</p>
<p>ignore, mayor ser√° la cantidad de c√≥digo que se acumule sobre un enfoque</p>
<p>defectuoso.</p>
<p>Recomendaci√≥n No ignore los fallos del sistema como algo aislado</p>
<h3 id="conseguir-que-primero-funcione-el-codigo-sin-proce-224">Conseguir que primero funcione el c√≥digo sin procesos</h3>
<p>Puede parecer evidente pero no est√° de m√°s recordarlo. Aseg√∫rese de que el</p>
<p>c√≥digo funciona fuera de sus procesos. Por lo general, esto significa crear</p>
<p>algunos POJO que los procesos deban invocar. Los POJO no son compatibles</p>
<p>con los procesos y por tanto se pueden probar fuera de su entorno. Conviene</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>incluir en los POJO la mayor cantidad posible del sistema.</p>
<p>Recomendaci√≥n No intente identificar fallos de procesos y que no sean</p>
<p>de procesos al mismo tiempo. Aseg√∫rese de que su c√≥digo funciona fuera de</p>
<p>los procesos</p>
<h3 id="el-codigo-con-procesos-se-debe-poder-conectar-a-ot-225">El c√≥digo con procesos se debe poder conectar a otros</h3>
<h3 id="elementos-226">elementos</h3>
<p>Cree el c√≥digo compatible con la concurrencia de forma que se pueda</p>
<p>ejecutar en distintas configuraciones:</p>
<p>Un proceso, varios procesos y variarlo durante la ejecuci√≥n.</p>
<p>El c√≥digo con procesos interact√∫a con algo que puede ser real o probado.</p>
<p>Ejecutar con pruebas dobles ejecutadas de forma r√°pida, lenta y variable.</p>
<p>Configurar pruebas que ejecutar en diferentes iteraciones.</p>
<p>Recomendaci√≥n El c√≥digo con procesos debe poder conectar a otros</p>
<p>elementos y ejecutar en distintas configuraciones</p>
<h3 id="el-codigo-con-procesos-debe-ser-modificable-227">El c√≥digo con procesos debe ser modificable</h3>
<p>La obtenci√≥n del equilibrio adecuado de procesos suele requerir operaciones</p>
<p>de ensayo y error. En las fases iniciales, compruebe el rendimiento del</p>
<p>sistema bajo diferentes configuraciones. Permita que se puedan modificar los</p>
<p>distintos procesos y tambi√©n durante la ejecuci√≥n del sistema. Tambi√©n puede</p>
<p>permitir la modificaci√≥n autom√°tica en funci√≥n de la producci√≥n la</p>
<p>utilizaci√≥n del sistema.</p>
<h3 id="ejecutar-con-mas-procesos-que-procesadores-228">Ejecutar con m√°s procesos que procesadores</h3>
<p>Cuando el sistema cambia de tarea, se producen reacciones. Para promover el</p>
<p>intercambio de tareas, realice la ejecuci√≥n con m√°s procesos que</p>
<p>procesadores o n√∫cleos. Cuanto mayor sea la frecuencia de intercambio de las</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>tareas, m√°s probabilidades existen de que el c√≥digo carezca de una secci√≥n</p>
<p>cr√≠tica o se produzcan bloqueos.</p>
<h3 id="ejecutar-en-diferentes-plataformas-229">Ejecutar en diferentes plataformas</h3>
<p>En 2007 dise√±amos un curso sobre programaci√≥n concurrente, principalmente</p>
<p>en OS X. La clase se present√≥ con Windows XP ejecutado en una MV. Se</p>
<p>crearon pruebas para ilustrar condiciones de fallo que fallaban con m√°s</p>
<p>frecuencia en OS X que en XP.</p>
<p>En todos los casos, el c√≥digo probado era incorrecto. Esto refuerza el</p>
<p>hecho de que cada sistema operativo tiene una pol√≠tica de procesos diferente</p>
<p>que afecta a la ejecuci√≥n del c√≥digo. El c√≥digo con procesos m√∫ltiples se</p>
<p>[89]</p>
<p>comporta de forma distinta en cada entorno . Debe ejecutar sus pruebas en</p>
<p>todos los entornos de implementaci√≥n posibles.</p>
<p>Recomendaci√≥n Ejecute el c√≥digo con procesos en todas las</p>
<p>plataformas de destino con frecuencia y en las fases iniciales</p>
<h3 id="disenar-el-codigo-para-probar-y-forzar-fallos-230">Dise√±ar el c√≥digo para probar y forzar fallos</h3>
<p>Es habitual que los fallos del c√≥digo concurrente se oculten. Las pruebas</p>
<p>sencillas no suelen mostrarlos. En realidad, suelen ocultarse durante el</p>
<p>procesamiento normal. Pueden aparecer horas, d√≠as o semanas despu√©s.</p>
<p>La raz√≥n de que los problemas de procesos sean infrecuentes, espor√°dicos</p>
<p>y apenas se repitan es que s√≥lo fallan algunas de las miles de rutas posibles</p>
<p>que recorren una secci√≥n vulnerable. Por tanto, la probabilidad de adoptar</p>
<p>una ruta fallida es realmente baja, lo que dificulta la detecci√≥n la</p>
<p>depuraci√≥n.</p>
<p>Se preguntar√° c√≥mo aumentar las posibilidades de capturar estos casos.</p>
<p>Puede dise√±ar el c√≥digo y forzarle a que se ejecute en diferentes √≥rdenes</p>
<p>a√±adiendo m√©todos como Object.wait() Object.sleep() Object.yield()</p>
<p>Object.priority()</p>
<p>Estos m√©todos afectan al orden de ejecuci√≥n y, por tanto, aumentan las</p>
<p>posibilidades de detectar un error. Resulta m√°s adecuado que el c√≥digo</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>incorrecto falle lo antes posible y con frecuencia. Hay dos opciones de</p>
<p>instrumentaci√≥n de c√≥digo:</p>
<p>Manual.</p>
<p>Autom√°tica.</p>
<h3 id="manual-231">Manual</h3>
<p>Puede a√±adir invocaciones de wait() sleep() yield() priority()</p>
<p>manualmente a su c√≥digo, en especial si tiene que probar un fragmento</p>
<p>especialmente escabroso. Veamos un ejemplo:</p>
<p>public synchronized String nextUrlOrNull() {</p>
<p>if (hasNext()) {</p>
<p>String url = urlGenerator.next();</p>
<p>Thread.yield(); // se a√±ade para pruebas.</p>
<p>updateHasNext();</p>
<p>return url;</p>
<p>return null;</p>
<p>La invocaci√≥n de yield() cambia la ruta de ejecuci√≥n adoptada por el</p>
<p>c√≥digo y posiblemente hace que el c√≥digo falla donde no lo hac√≠a antes. Si el</p>
<p>[90]</p>
<p>c√≥digo falla, no se debe a la invocaci√≥n de yield() a√±adida . Se debe a que</p>
<p>el c√≥digo es incorrecto y hemos hecho que el fallo sea m√°s evidente. Este</p>
<p>enfoque presenta varios problemas:</p>
<p>Tendr√° que buscar manualmente los puntos adecuados donde hacerlo.</p>
<p>¬øC√≥mo sabe d√≥nde incluir la invocaci√≥n y qu√© tipo de invocaci√≥n usar?</p>
<p>La presencia de este c√≥digo en un entorno de producci√≥n ralentiza</p>
<p>innecesariamente el c√≥digo.</p>
<p>Es un enfoque que puede o no detectar los fallos; de hecho, no las tiene</p>
<p>todas consigo.</p>
<p>Lo que necesitamos es una forma de hacerlo durante la fase de pruebas,</p>
<p>no de producci√≥n. Tambi√©n debemos poder mezclar configuraciones entre</p>
<p>ejecuciones, lo que aumenta las probabilidades de detectar los errores.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Evidentemente, si dividimos el sistema POJO que no sepa nada los</p>
<p>procesos en clases que controlen los procesos, resultar√° m√°s sencillo ubicar</p>
<p>los puntos en los que instrumentar el c√≥digo. Es m√°s, podr√≠amos crear</p>
<p>diferentes pruebas que invoquen los POJO bajo distintos reg√≠menes de</p>
<p>invocaciones a sleep yield y dem√°s.</p>
<h3 id="automatica-232">Autom√°tica</h3>
<p>Puede usar herramientas como la estructura orientada a aspectos, CGLIB o</p>
<p>ASM para instrumentar su c√≥digo mediante programaci√≥n. Por ejemplo,</p>
<p>podr√≠a usar una clase con un √∫nico m√©todo:</p>
<p>public class ThreadJigglePoint {</p>
<p>public static void jiggle() {</p>
<p>Puede a√±adir invocaciones en distintos puntos del c√≥digo:</p>
<p>public synchronized String nextUrlOrNull() {</p>
<p>if(hasNext()) {</p>
<p>ThreadJigglePoint.jiggle();</p>
<p>String url = urlGenerator.next();</p>
<p>ThreadJigglePoint.jiggle();</p>
<p>updateHasNext();</p>
<p>ThreadJigglePoint.jiggle();</p>
<p>return url;</p>
<p>return null;</p>
<p>Tras ello, use un sencillo aspecto que seleccione aleatoriamente entre no</p>
<p>hacer nada, pausar o generar un resultado.</p>
<p>Imagine que la clase ThreadJigglePoint tiene dos implementaciones. La</p>
<p>primera implementa jiggle para no hacer nada y se usa en producci√≥n. La</p>
<p>segunda genera un n√∫mero aleatorio para elegir entre sleep yield o nada. Si</p>
<p>ejecuta sus pruebas mil veces con jiggle de forma aleatoria, puede descubrir</p>
<p>algunos fallos. Si la prueba es satisfactoria, al menos puede felicitarse por</p>
<p>haber actuado correctamente. Aunque sea un tanto simple, puede resultar una</p>
<p>opci√≥n razonable en lugar de recurrir a una herramienta m√°s sofisticada. La</p>
<p>[91]</p>
<p>herramienta ConTest , desarrollada por IBM, tiene un funcionamiento</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>similar pero es m√°s sofisticada.</p>
<p>El objetivo es que los procesos del c√≥digo se ejecuten en distinto orden en</p>
<p>momentos diferentes. La combinaci√≥n de pruebas bien escritas y ejecuciones</p>
<p>aleatorias puede aumentar considerablemente la capacidad de detectar</p>
<p>errores.</p>
<p>Recomendaci√≥n Use estas estrategias para detectar errores</p>
<h3 id="conclusion-233">Conclusi√≥n</h3>
<p>Es complicado conseguir c√≥digo concurrente correcto. El c√≥digo sencillo se</p>
<p>puede complicar al a√±adir varios procesos y datos compartidos. Si tiene que</p>
<p>crear c√≥digo concurrente, tendr√° que hacerlo con rigor o se enfrentar√° a</p>
<p>sutiles y espor√°dicos fallos.</p>
<p>En primer lugar, siga el principio de responsabilidad √∫nica. Divida su</p>
<p>sistema en varios POJO que separen el c√≥digo compatible con procesos del</p>
<p>resto. Aseg√∫rese de probar √∫nicamente el c√≥digo compatible con procesos y</p>
<p>nada m√°s, por lo que este c√≥digo debe ser de tama√±o reducido y espec√≠fico.</p>
<p>Conozca los or√≠genes de los problemas de concurrencia: varios procesos</p>
<p>que operen en datos compartidos o usen una agrupaci√≥n de recursos com√∫n.</p>
<p>Los casos de l√≠mites, como el cierre correcto o la conclusi√≥n de la iteraci√≥n</p>
<p>de un bucle, pueden ser especialmente espinosos.</p>
<p>Conozca su biblioteca y los algoritmos fundamentales. Debe comprender</p>
<p>c√≥mo las funciones de la biblioteca permiten resolver problemas similares a</p>
<p>los de los algoritmos fundamentales.</p>
<p>Aprenda a localizar regiones del c√≥digo que se puedan bloquear y</p>
<p>bloqu√©elas. No bloquee otras regiones que no lo necesiten. Evite invocar una</p>
<p>secci√≥n bloqueada desde otra. Para ello debe saber si un elemento est√°</p>
<p>compartido o no. Reduzca la cantidad de objetos compartidos y su √°mbito.</p>
<p>Cambie los dise√±os de los objetos con datos compartidos para acomodar</p>
<p>clientes en lugar de obligar a los clientes a gestionar el estado compartido.</p>
<p>Los problemas se acumular√°n. Los que no aparezcan inicialmente suelen</p>
<p>considerarse espor√°dicos y suelen producirse en la fase de carga o de modo</p>
<p>aparentemente aleatorio. Por tanto, debe poder ejecutar su c√≥digo con</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>procesos en diferentes configuraciones y plataformas de forma repetida y</p>
<p>continua. La capacidad de prueba, algo natural si aplica las tres leyes de</p>
<p>TDD, implica cierto nivel de conectividad, lo que ofrece la compatibilidad</p>
<p>necesaria para ejecutar c√≥digo en distintas configuraciones.</p>
<p>La probabilidad de detectar errores mejora si se toma el tiempo necesario</p>
<p>para instrumentar su c√≥digo. Puede hacerlo manualmente mediante</p>
<p>tecnolog√≠as automatizadas. H√°galo en las fases iniciales. Es aconsejable</p>
<p>ejecutar el c√≥digo basado en procesos durante el mayor tiempo posible antes</p>
<p>de pasarlo a producci√≥n.</p>
<p>Si adopta un enfoque limpio, aumentar√°n las probabilidades de hacerlo de</p>
<p>forma correcta.</p>
<h3 id="bibliografia-234">Bibliograf√≠a</h3>
<p>[Lea99] Concurrent Programming in Java: Design Principles and</p>
<p>Patterns , 2d. ed., Doug Lea, Prentice Hall, 1999.</p>
<p>[PPP] Agile Software Development: Principles, Patterns, and</p>
<p>Practices , Robert C. Martin, Prentice Hall, 2002.</p>
<p>[PRAG] The Pragmatic Programmer , Andrew Hunt, Dave Thomas,</p>
<p>Addison-Wesley, 2000.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="refinamiento-sucesivo-235">Refinamiento sucesivo</h1>
<p>Caso pr√°ctico de un analizador de argumentos de l√≠nea de comandos</p>
<p>Este cap√≠tulo es un caso pr√°ctico de refinamiento sucesivo. Veremos un</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>m√≥dulo que comienza correctamente pero no mantiene dicha correcci√≥n. Tras</p>
<p>ello, veremos c√≥mo se refactoriza y se limpia. Muchos hemos tenido que</p>
<p>analizar argumentos de l√≠nea de comando. Si no disponemos de una utilidad</p>
<p>para ello, recorremos la matriz de cadenas pasadas a la funci√≥n principal.</p>
<p>Puede encontrar utilidades de calidad pero ninguna hace exactamente lo que</p>
<p>necesitamos. Por ello, decid√≠ crear una propia, a la que he denominado Args</p>
<p>Args es muy f√°cil de usar. Basta crearla con los argumentos de entrada y una</p>
<p>cadena de formato, y despu√©s consultar a la instancia de Args los valores de</p>
<p>los argumentos. F√≠jese en el siguiente ejemplo:</p>
<p>Listado 14-1</p>
<p>Uso de Args</p>
<p>public static void main(String[] args) {</p>
<p>try {</p>
<p>Args arg = new Args(‚Äúl,p#,d*‚Äù, args);</p>
<p>boolean logging = arg.getBoolean(‚Äòl‚Äô);</p>
<p>int port = arg.getInt(‚Äòp‚Äô);</p>
<p>String directory = arg.getString(‚Äòd‚Äô);</p>
<p>executeApplication(logging, port, directory);</p>
<p>} catch (ArgsException e) {</p>
<p>System.out.printf(‚ÄúArgument error: %s\n‚Äù, e.errorMessage());</p>
<p>Comprobar√° lo sencillo que es. Creamos una instancia de la clase Args</p>
<p>con dos par√°metros. El primero es la cadena de formato esquema:</p>
<p>‚Äúl,p#,d*‚Äù . Define tres argumentos de l√≠nea de comandos. El primero, -l , es</p>
<p>un argumento booleano. El segundo, -p , es un argumento entero. El tercero,</p>
<p>, es un argumento de cadena. El segundo par√°metro del constructor Args es</p>
<p>la matriz de argumentos de l√≠nea de comandos pasada main Si el</p>
<p>constructor no genera ArgsException , la l√≠nea de comandos entrante se ha</p>
<p>analizado y se puede consultar la instancia Args . Se usan m√©todos como</p>
<p>getBoolean getInteger getString para acceder a los valores de los</p>
<p>argumentos por sus nombres.</p>
<p>Si hay un problema, ya sea en la cadena de formato o en los argumentos</p>
<p>de l√≠nea de comandos, se genera ArgsException . La descripci√≥n del error se</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>puede recuperar del m√©todo errorMessage de la excepci√≥n.</p>
<h3 id="implementacion-de-args-236">Implementaci√≥n de Args</h3>
<p>El Listado 14-2 es la implementaci√≥n de la clase Args . Exam√≠nela con</p>
<p>atenci√≥n. El estilo y la estructura se han trabajado concienzudamente y espero</p>
<p>que los imite.</p>
<p>Listado 14-2</p>
<p>Args.java</p>
<p>package com.objectmentor.utilities.args;</p>
<p>import static com.objectmentor.utilities.args.ArgsException.ErrorCode.*;</p>
<p>import java.util.*;</p>
<p>public class Args {</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; marshalers;</p>
<p>private Set&lt;Character&gt; argsFound;</p>
<p>private ListIterator&lt;String&gt; currentArgument;</p>
<p>public Args(String schema, String[] args) throws ArgsException {</p>
<p>marshalers = new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>argsFound = new HashSet&lt;Character&gt;();</p>
<p>parseSchema(schema);</p>
<p>parseArgumentStrings(Arrays.asList(args));</p>
<p>private void parseSchema(String schema) throws ArgsException {</p>
<p>for (String element : schema.split(‚Äú,‚Äù))</p>
<p>if (element.length() &gt; 0)</p>
<p>parseSchemaElement(element.trim());</p>
<p>private void parseSchemaElement(String element) throws ArgsException {</p>
<p>char elementId = element.charAt(0);</p>
<p>String elementTail = element.substring(1);</p>
<p>validateSchemaElementId(element Id);</p>
<p>if (elementTail.length() == 0)</p>
<p>marshalers.put(elementId, new BooleanArgumentMarshaler());</p>
<p>else if (elementTail.equals(‚Äú*‚Äù))</p>
<p>marshalers.put(elementId, new StringArgumentMarshaler());</p>
<p>else if (elementTail.equals(‚Äú#‚Äù))</p>
<p>marshalers.put(elementId, new IntegerArgumentMarshaler());</p>
<p>else if (elementTail.equals(‚Äú##‚Äù))</p>
<p>marshalers.put(elementId, new DoubleArgumentMarshaler());</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>else if (elementTail.equals(‚Äú[*]‚Äù))</p>
<p>marshalers.put(elementId, new StringArrayArgumentMarshaler());</p>
<p>else</p>
<p>throw new ArgsException(INVALID_ARGUMENT_FORMAT, elementId,</p>
<p>elementTail);</p>
<p>private void validateSchemaElementId(char elementId) throws ArgsException</p>
<p>if {!Character.isLetter(elementId))</p>
<p>throw new ArgsException(INVALID_ARGUMENT_NAME, elementId, null);</p>
<p>private void parseArgumentStrings(List&lt;String&gt; argsList) throws</p>
<p>ArgsException</p>
<p>for (currentArgument argsList.listIterator();</p>
<p>currentArgument.hasNext();)</p>
<p>String argString = currentArgument.next();</p>
<p>if (argString.startsWith(‚Äú-‚Äù)) {</p>
<p>parseArgumentCharacters(argString.substring(1));</p>
<p>} else {</p>
<p>currentArgument.previous();</p>
<p>break;</p>
<p>private void parseArgumentCharacters(String argChars) throws ArgsException</p>
<p>for (int i = 0; i &lt; argChars.length(); i++)</p>
<p>parseArgumentCharacter(argChars.charAt(i));</p>
<p>private void parseArgumentCharacter(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (m == null) {</p>
<p>throw new ArgsException (UNEXPECTED_ARGUMENT, argChar, null);</p>
<p>} else {</p>
<p>argsFound.add(argChar);</p>
<p>try {</p>
<p>m.set(currentArgument);</p>
<p>} catch (ArgsException e) {</p>
<p>e.setErrorArgumentId(argChar);</p>
<p>throw e;</p>
<p>public boolean has(char arg) {</p>
<p>return argsFound.contains(arg);</p>
<p>public int nextArgument() {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return currentArgument.nextIndex();</p>
<p>public boolean getBoolean(char arg) {</p>
<p>return BooleanArgumentMarshaler.getValue(marshalers.get(arg));</p>
<p>public String getString(char arg) {</p>
<p>return StringArgumentMarshaler.getValue(marshalers.get(arg));</p>
<p>public int getInt(char arg) {</p>
<p>return IntegerArgumentMarshaler.getValue (marshalers.get(arg));</p>
<p>public double getDouble(char arg) {</p>
<p>return DoubleArgumentMarshaler.getValue(marshalers.get(arg));</p>
<p>public String[] getStringArray(char arg) {</p>
<p>return StringArrayArgumentMarshaler.getValue(marshalers.get(arg));</p>
<p>Puede leer el c√≥digo de arriba a abajo sin necesidad de saltar de un punto</p>
<p>a otro ni buscar hacia adelante. Lo que seguramente busque es la definici√≥n</p>
<p>de ArgumentMarshaler , que hemos omitido intencionadamente. Tras leer el</p>
<p>c√≥digo, comprender√° la interfaz ArgumentMarshaler y la funci√≥n de sus</p>
<p>variantes. Veamos algunas de ellas (entre los listados 14-3 y 14-6).</p>
<p>Listado 14-3</p>
<p>ArgumentMarshaler.java</p>
<p>public interface ArgumentMarshaler {</p>
<p>void set(Iterator&lt;String&gt; currentArgument) throws ArgsException;</p>
<p>Listado 14-4</p>
<p>BooleanArgumentMarshaler.java</p>
<p>public class BooleanArgumentMarshaler implements ArgumentMarshaler {</p>
<p>private boolean booleanValue = false;</p>
<p>public void set (Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>booleanValue = true;</p>
<p>public static boolean getValue(ArgumentMarshaler am) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if (am != null &amp;&amp; am instanceof BooleanArgumentMarshaler)</p>
<p>return ((BooleanArgumentMarshaler) am).booleanValue;</p>
<p>else</p>
<p>return false;</p>
<p>Listado 14-5</p>
<p>StringArgumentMarshaler.java</p>
<p>import static com.objectmentor.utilities.args.ArgsException.ErrorCode.*;</p>
<p>public class StringArgumentMarshaler implements ArgumentMarshaler {</p>
<p>private String stringValue = ‚Äú‚Äù;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>try {</p>
<p>stringValue = currentArgument.next();</p>
<p>} catch (NoSuchElementException e) {</p>
<p>throw new ArgsException(MISSING_STRING);</p>
<p>public static String getValue(ArgumentMarshaler am) {</p>
<p>if (am != null &amp;&amp; am instanceof StringArgumentMarshaler)</p>
<p>return ((StringArgumentMarshaler) am).stringValue;</p>
<p>else</p>
<p>return ‚Äú‚Äù;</p>
<p>Listado 14-6</p>
<p>IntegerArgumentMarshaler.java</p>
<p>import static com.objectmentor.utilities.args.ArgsException.ErrorCode.*;</p>
<p>public class IntegerArgumentMarshaler implements ArgumentMarshaler {</p>
<p>private int intValue = 0;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = currentArgument.next();</p>
<p>IntValue = Integer.parseInt(parameter);</p>
<p>} catch (NoSuchElementException e) {</p>
<p>throw new ArgsException(MISSING_INTEGER);</p>
<p>} catch (NumberFormatException e) {</p>
<p>throw new ArgsException(INVALID_INTEGER, parameter);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public static int getValue (ArgumentMarshaler am) {</p>
<p>if (am != null &amp;&amp; am instanceof IntegerArgumentMarshaler)</p>
<p>return ((IntegerArgumentMarshaler) am).intValue;</p>
<p>else</p>
<p>return 0;</p>
<p>Las otras variantes de ArgumentMarshaler simplemente repiten este</p>
<p>patr√≥n en matrices double String y s√≥lo complicar√≠an el cap√≠tulo. Puede</p>
<p>consultarlas como ejercicio. Otro fragmento que puede resultar complicado es</p>
<p>la definici√≥n de las constantes de c√≥digo de error, incluidas en la clase</p>
<p>ArgsException (v√©ase el Listado 14-7).</p>
<p>Listado 14-7</p>
<p>ArgsException.java</p>
<p>import static com.objectmentor.utilities.args.ArgsException.ErrorCode.*;</p>
<p>public class ArgsException extends Exception {</p>
<p>private char errorArgumentId = ‚Äò\0‚Äô;</p>
<p>private String errorParameter = null;</p>
<p>private ErrorCode errorCode = OK;</p>
<p>public ArgsException() {}</p>
<p>public ArgsException(String message) { super(message); }</p>
<p>public ArgsException(ErrorCode errorCode) {</p>
<p>this.errorCode = errorCode;</p>
<p>public ArgsException(ErrorCode errorCode, String errorParameter) {</p>
<p>this.errorCode = errorCode;</p>
<p>this.errorParameter = errorParameter;</p>
<p>public ArgsException(ErrorCode errorCode,</p>
<p>char errorArgumentId, String errorParameter) {</p>
<p>this.errorCode = errorCode;</p>
<p>this.errorParameter = errorParameter;</p>
<p>this.errorArgumentId = errorArgumentId;</p>
<p>public char getErrorArgumentId() {</p>
<p>return errorArgumentId;</p>
<p>public void setErrorArgumentId(char errorArgumentId) {</p>
<p>this.errorArgumentId = errorArgumentId;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public String getErrorParameter() {</p>
<p>return errorParameter;</p>
<p>public void setErrorParameter(String errorParameter) {</p>
<p>this.errorParameter = errorParameter;</p>
<p>public ErrorCode getErrorCode() {</p>
<p>return errorCode;</p>
<p>public void setErrorCode(ErrorCode errorCode) {</p>
<p>this.errorCode = errorCode;</p>
<p>public String errorMessage() {</p>
<p>switch (errorCode) {</p>
<p>case OK:</p>
<p>return ‚ÄúTILT: Should not get here.‚Äù;</p>
<p>case UNEXPECTED_ARGUMENT:</p>
<p>return String.format(‚ÄúArgument -%c unexpected.‚Äù, errorArgumentId);</p>
<p>case MISSING_STRING:</p>
<p>return String.format(‚ÄúCould not find string parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID INTEGER:</p>
<p>return String.format(‚ÄúArgument -%c expects an integer but was ‚Äò%s‚Äô.‚Äù,</p>
<p>errorArgumentId, errorParameter);</p>
<p>case MISSING_INTEGER:</p>
<p>return String.format(‚ÄúCould not find integer parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_DOUBLE:</p>
<p>return String.format(‚ÄúArgument -%c expects a double but was ‚Äò%s‚Äô.‚Äù,</p>
<p>errorArgumentId, errorParameter);</p>
<p>case MISSING_DOUBLE:</p>
<p>return String.format(‚ÄúCould not find double parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_ARGUMENT_NAME:</p>
<p>return String.format(‚Äú‚Äò%c‚Äô is not a valid argument name.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_ARGUMENT_FORMAT:</p>
<p>return String.format(‚Äú‚Äò%s‚Äô is not a valid argument format.‚Äù,</p>
<p>errorParameter);</p>
<p>return ‚Äú‚Äù;</p>
<p>public enum ErrorCode {</p>
<p>OK, INVALID_ARGUMENT_FORMAT, UNEXPECTED_ARGUMENT, INVALID_ARGUMENT_NAME,</p>
<p>MISSING_STRING,</p>
<p>MISSING_INTEGER, INVALID_INTEGER,</p>
<p>MISSING_DOUBLE, INVALID_DOUBLE }</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Es sorprendente la cantidad de c√≥digo necesario para detallar este sencillo</p>
<p>concepto. Uno de los motivos es el uso de un lenguaje especialmente profuso.</p>
<p>Java, al ser un lenguaje de tipos est√°ticos, requiere muchas palabras para</p>
<p>satisfacer el sistema de tipos. En lenguajes como Ruby, Python o Smalltalk,</p>
<p>[92]</p>
<p>este programa es mucho m√°s reducido</p>
<p>Vuelva a leer el c√≥digo. F√≠jese especialmente en los nombres de los</p>
<p>elementos, el tama√±o de las funciones y el formato. Si tiene experiencia como</p>
<p>programador, partes del estilo o la estructura no le convencer√°n, pero espero</p>
<p>que, desde un punto de vista global, considere que el programa est√° bien</p>
<p>escrito y tiene una estructura limpia.</p>
<p>Por ejemplo, deber√≠a ser evidente c√≥mo a√±adir un nuevo tipo de</p>
<p>argumento, como una fecha o un n√∫mero complejo, y que dicha inclusi√≥n</p>
<p>apenas requerir√≠a c√≥digo. En definitiva, bastar√≠a con una nueva variante de</p>
<p>ArgumentMarshaler , una nueva funci√≥n getXXX y una nueva instrucci√≥n case</p>
<p>en la funci√≥n parseSchemaElement Tambi√©n habr√≠a un nuevo c√≥digo</p>
<p>ArgsException.ErrorCode y un nuevo mensaje de error.</p>
<h3 id="como-se-ha-realizado-237">C√≥mo se ha realizado</h3>
<p>No dise√±√© este programa de principio a fin en su forma actual y, sobre todo,</p>
<p>no espero que pueda crear programas limpios y elegantes a la primera. Si</p>
<p>algo hemos aprendido en las dos √∫ltimas d√©cadas es que la programaci√≥n es</p>
<p>un arte m√°s que una ciencia. Para escribir c√≥digo limpio, primero debe crear</p>
<p>c√≥digo imperfecto y despu√©s limpiarlo. No deber√≠a sorprenderle. Ya lo</p>
<p>aprendimos en el colegio cuando los profesores (normalmente en vano) nos</p>
<p>obligaban a crear borradores de nuestras redacciones. El proceso, nos dec√≠an,</p>
<p>era escribir un primer borrador, despu√©s otro, y despu√©s otros muchos hasta</p>
<p>lograr una versi√≥n definitiva. Para escribir redacciones limpias, el</p>
<p>refinamiento deb√≠a ser continuado.</p>
<p>Muchos programadores noveles (como sucede con los alumnos) no</p>
<p>siguen este consejo. Creen que el objetivo principal es que el programa</p>
<p>funcione. Una vez que lo consiguen, pasan a la siguiente tarea, y conservan el</p>
<p>estado funcional del programa, sea cual sea. Los programadores</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>experimentados saben que esto es un suicidio profesional.</p>
<h3 id="args-el-primer-borrador-238">Args: El primer borrador</h3>
<p>El Listado 14-8 muestra una versi√≥n inicial de la clase Args . Funciona, pero</p>
<p>es un desastre.</p>
<p>Listado 14-8</p>
<p>Args.java (primer borrador)</p>
<p>import java.text.ParseException;</p>
<p>import java.util.*;</p>
<p>public class Args {</p>
<p>private String schema;</p>
<p>private String[] args;</p>
<p>private boolean valid = true;</p>
<p>private Set&lt;Character&gt; unexpectedArguments = new TreeSet&lt;Character&gt;();</p>
<p>private Map&lt;Character, Boolean&gt; booleanArgs =</p>
<p>new HashMap&lt;Character, Boolean&gt;();</p>
<p>private Map&lt;Character, String&gt; stringArgs =</p>
<p>new HashMap&lt;Character, String&gt;();</p>
<p>private Map&lt;Character, Integer&gt; intArgs =</p>
<p>new HashMap&lt;Character, Integer&gt;();</p>
<p>private Set&lt;Character&gt; argsFound = new HashSet&lt;Character&gt;();</p>
<p>private int currentArgument;</p>
<p>private char errorArgumentId = ‚Äò\0‚Äô;</p>
<p>private String errorParameter = ‚ÄúTILT‚Äù;</p>
<p>private ErrorCode errorCode = ErrorCode.OK;</p>
<p>private enum ErrorCode {</p>
<p>OK, MISSING_STRING, MISSING_INTEGER, INVALID_INTEGER,</p>
<p>UNEXPECTED_ARGUMENT}</p>
<p>public Args(String schema. String[] args) throws ParseException {</p>
<p>this.schema = schema;</p>
<p>this.args = args;</p>
<p>valid = parse();</p>
<p>private boolean parse() throws ParseException {</p>
<p>if (schema.length() == 0 &amp;&amp; args.length == 0)</p>
<p>return true;</p>
<p>parseSchema();</p>
<p>try {</p>
<p>parseArguments();</p>
<p>} catch (ArgsException e) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return valid;</p>
<p>private boolean parseSchema() throws ParseException {</p>
<p>for (String element : schema.split(‚Äú,‚Äù)) {</p>
<p>if (element.length() &gt; 0) {</p>
<p>String trimmedElement = element.trim();</p>
<p>parseSchemaElement(trimmedElement);</p>
<p>return true;</p>
<p>private void parseSchemaElement(String element) throws ParseException {</p>
<p>char elementId = element.charAt(0);</p>
<p>String elemenTail = element.substring(1);</p>
<p>validateSchemaElementId(elementId);</p>
<p>if (isBooleanSchemaElement(elementTail));</p>
<p>parseBooleanSchemaElement(elementId);</p>
<p>else if (isStringSchemaElement(elementTail))</p>
<p>parseStringSchemaElement(elementId);</p>
<p>else if (isIntegerSchemaElement(elementTail)) {</p>
<p>parseIntegerSchemaElement(elementId);</p>
<p>} else {</p>
<p>throw new ParseException(</p>
<p>String.format(‚ÄúArgument: %c has invalid format: %s.‚Äù,</p>
<p>elementId, elementTail), 0);</p>
<p>private void validateSchemaElementId(char elementId) throws ParseException</p>
<p>if (!Character.isLetter(elementId)) {</p>
<p>throw new ParseException(</p>
<p>‚ÄúBad character:‚Äù + elementId + ‚Äúin Args format: ‚Äù + schema, 0);</p>
<p>private void parseBooleanSchemaElement(char elementId) {</p>
<p>booleanArgs.put(elementId, false);</p>
<p>private void parseIntegerSchemaElement(char elementId) {</p>
<p>intArgs.put(elementId, 0);</p>
<p>private void parseStringSchemaElement(char elementId) {</p>
<p>stringArgs.put(elementId, ‚Äú‚Äù);</p>
<p>private boolean isStringSchemaElement(String elementTail) {</p>
<p>return elementTail.equals(‚Äú*‚Äù);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private boolean isBooleanSchemaElement(String elementTail) {</p>
<p>return elementTail.length() == 0;</p>
<p>private boolean isIntegerSchemaElement(String elementTail) {</p>
<p>return elementTail.equals(‚Äú#‚Äù);</p>
<p>private boolean parseArguments() throws ArgsException {</p>
<p>for (currentArgument 0; currentArgument args.length;</p>
<p>currentArgument++)</p>
<p>String arg = args[currentArgument];</p>
<p>parseArgument(arg);</p>
<p>return true;</p>
<p>private void parseArgument(String arg) throws ArgsException {</p>
<p>if (arg.startsWith(‚Äú-‚Äù))</p>
<p>parseElements(arg);</p>
<p>private void parseElements(String arg) throws ArgsException {</p>
<p>for (int i = 1; i &lt; arg.length(); i++)</p>
<p>parseElement(arg.charAt(i));</p>
<p>private void parseElement(char argChar) throws ArgsException {</p>
<p>if (setArgument(argChar))</p>
<p>argsFound.add(argChar);</p>
<p>else {</p>
<p>unexpectedArguments.add(argChar);</p>
<p>errorCode = ErrorCode.UNEXPECTED_ARGUMENT;</p>
<p>valid = false;</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>if (isBooleanArg(argChar))</p>
<p>setBooleanArg(argChar, true);</p>
<p>else if (isStringArg(argChar))</p>
<p>setStringArg(argChar);</p>
<p>else if (isIntArg(argChar))</p>
<p>setIntArg(argChar);</p>
<p>else</p>
<p>return false;</p>
<p>return true;</p>
<p>private boolean isIntArg(char argChar) {</p>
<p>return intArgs.containsKey(argChar);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void setIntArg(char argChar) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = args[currentArgument];</p>
<p>intArgs.put(argChar, new Integer(parameter));</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorCode = ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>} catch (NumberFormatException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>private void setStringArg(char argChar) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>try {</p>
<p>stringArgs.put(argChar, args[currentArgument]);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorCode = ErrorCode.MISSING_STRING;</p>
<p>throw new ArgsException();</p>
<p>private boolean isStringArg(char argChar) {</p>
<p>return stringArgs.containsKey(argChar);</p>
<p>private void setBooleanArg(char argChar, boolean value) {</p>
<p>booleanArgs.put(argChar, value);</p>
<p>private boolean isBooleanArg(char argChar) {</p>
<p>return booleanArgs.containsKey(argChar);</p>
<p>public int cardinality() {</p>
<p>return argsFound.size();</p>
<p>public String usage() {</p>
<p>if (schema.length() &gt; 0)</p>
<p>return "-[" + schema + ‚Äú]‚Äù;</p>
<p>else</p>
<p>return ‚Äú‚Äù;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public String errorMessage() throws Exception {</p>
<p>switch (errorCode) {</p>
<p>case OK:</p>
<p>throw new Exception(‚ÄúTILT: Should not get here.‚Äù);</p>
<p>case UNEXPECTED_ARGUMENT:</p>
<p>return unexpectedArgumentMessage();</p>
<p>case MISSING_STRING:</p>
<p>return String.format(‚ÄúCould not find string parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_INTEGER:</p>
<p>return String.format(‚ÄúArgument %c expects an integer but was</p>
<p>‚Äò%s‚Äô.‚Äù,</p>
<p>errorArgumentId, errorParameter);</p>
<p>case MISSING_INTEGER:</p>
<p>return String.format(‚ÄúCould not find integer parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>return ‚Äú‚Äù;</p>
<p>private String unexpectedArgumentMessage() {</p>
<p>StringBuffer message = new StringBuffer(‚ÄúArguments(s) -‚Äù);</p>
<p>for (char c : unexpectedArguments) {</p>
<p>message.append(c);</p>
<p>message.append(‚Äú unexpected.‚Äù);</p>
<p>return message.toString();</p>
<p>private boolean falseIfNull(Boolean b) {</p>
<p>return b != null &amp;&amp; b;</p>
<p>private int zeroIfNull(Integer i) {</p>
<p>return i == null ? 0 : i;</p>
<p>private String blankIfNull(String s) {</p>
<p>return s = null ? ‚Äú‚Äù : s;</p>
<p>public String getString(char arg) {</p>
<p>return blankIfNull(stringArgs.get(arg));</p>
<p>public int getInt(char arg) {</p>
<p>return zeroIfNull(intArgs.get(arg));</p>
<p>public boolean getBoolean(char arg) {</p>
<p>return falseIfNull(booleanArgs.get(arg));</p>
<p>public boolean has(char arg) (</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return argsFound.contains(arg);</p>
<p>public boolean isValid() {</p>
<p>return valid;</p>
<p>private class ArgsException extends Exception {</p>
<p>Espero que su reacci√≥n inicial ante tal cantidad de c√≥digo es alegrarse por</p>
<p>no haberlo conservado tal cual. Si ha sido su reacci√≥n, recuerde que ser√° la</p>
<p>que tengan otros que lean un borrador de su c√≥digo.</p>
<p>En realidad, primer borrador es lo mejor que se puede decir sobre este</p>
<p>c√≥digo. Evidentemente es un trabajo en progreso. La cantidad de variables de</p>
<p>instancia es apabullante. Cadenas extra√±as como ¬´ TILT ¬ª, HashSet TreeSet</p>
<p>y los bloques try-catch-catch aumentan el desastre.</p>
<p>No era mi intenci√≥n crear este desastre. En realidad, intentaba mantener</p>
<p>cierta organizaci√≥n, como demuestra la elecci√≥n de nombres de funciones y</p>
<p>variables, y la estructura del programa. Pero es evidente que el problema se</p>
<p>me fue de las manos.</p>
<p>El desastre aument√≥ gradualmente. Las versiones anteriores no fueron tan</p>
<p>malas. Por ejemplo, el Listado 14-9 muestra una versi√≥n inicial en la que s√≥lo</p>
<p>funcionaban los argumentos booleanos.</p>
<p>Listado 14-9</p>
<p>Args.java (s√≥lo argumentos booleanos)</p>
<p>package com.objectmentor.utilities.getopts;</p>
<p>import java.util.*;</p>
<p>public class Args {</p>
<p>private String schema;</p>
<p>private String[] args;</p>
<p>private boolean valid;</p>
<p>private Set&lt;Character&gt; unexpectedArguments = new TreeSet&lt;Character&gt;();</p>
<p>private Map&lt;Character, Boolean&gt; booleanArgs =</p>
<p>new HashMap&lt;Character, Boolean&gt;();</p>
<p>private int numberOfArguments = 0;</p>
<p>public Args(String schema, String[] args) {</p>
<p>this.schema = schema;</p>
<p>this.args = args;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>valid = parse();</p>
<p>public boolean isValid() {</p>
<p>return valid;</p>
<p>private boolean parse() {</p>
<p>if (schema.length() == 0 &amp;&amp; args.length == 0)</p>
<p>return true;</p>
<p>parseSchema();</p>
<p>parseArguments();</p>
<p>return unexpectedArguments.size() == 0;</p>
<p>private boolean parseSchema() {</p>
<p>for (String element : schema.split(‚Äú,‚Äù)) {</p>
<p>parseSchemaElement(element);</p>
<p>return true;</p>
<p>private void parseSchemaElement(String element) {</p>
<p>if (element.length() == 1) {</p>
<p>parseBooleanSchemaElement(element);</p>
<p>private void parseBooleanSchemaElement(String element) {</p>
<p>char c = element.charAt(0);</p>
<p>if (Character.isLetter(c)) {</p>
<p>booleanArgs.put(c, false);</p>
<p>private boolean parseArguments() {</p>
<p>for (String arg : args)</p>
<p>parseArgument(arg);</p>
<p>return true;</p>
<p>private void parseArgument(String arg) {</p>
<p>if (arg.startsWith(‚Äú-‚Äù))</p>
<p>parseElement(arg);</p>
<p>private void parseElements(String arg) {</p>
<p>for (int i = 1; i &lt; arg.length(); i++)</p>
<p>parseElement(arg.charAt(i));</p>
<p>private void parseElement(char argChar) {</p>
<p>if (isBoolean(argChar)) {</p>
<p>numberOfArguments++;</p>
<p>setBooleanArg(argChar, true);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>} else</p>
<p>unexpectedArguments.add(argChar);</p>
<p>private void setBooleanArg(char argChar, boolean value) {</p>
<p>booleanArgs.put(argChar, value);</p>
<p>private boolean isBoolean(char argChar) {</p>
<p>return booleanArgs.containsKey(argChar);</p>
<p>public int cardinality() {</p>
<p>return numberOfArguments;</p>
<p>public String usage() {</p>
<p>if (schema.length() &gt; 0)</p>
<p>return ‚Äú-[‚Äù+schema+‚Äú]‚Äù;</p>
<p>else</p>
<p>return ‚Äú‚Äù;</p>
<p>public String errorMessage() {</p>
<p>if (unexpectedArguments.size() &gt; 0) {</p>
<p>return unexpectedArgumentMessage();</p>
<p>} else</p>
<p>return ‚Äú‚Äù;</p>
<p>private String unexpectedArgumentMessage() {</p>
<p>StringBuffer message = new StringBuffer(‚ÄúArgument(s) -‚Äù);</p>
<p>for (char c : unexpectedArguments) {</p>
<p>message.append(c);</p>
<p>message.append(‚Äú unexpected.‚Äù);</p>
<p>return message.toString();</p>
<p>public boolean getBoolean(char arg) {</p>
<p>return booleanArgs.get(arg);</p>
<p>Aunque hay motivos para quejarse del c√≥digo, no es tan malo. Es</p>
<p>compacto y sencillo, y f√°cil de entender. Sin embargo, en este c√≥digo se</p>
<p>aprecia la semilla del desastre posterior y resulta evidente porqu√©.</p>
<p>La versi√≥n posterior s√≥lo tiene dos tipos de argumentos m√°s que √©sta:</p>
<p>String integer . La inclusi√≥n de s√≥lo dos tipos m√°s tiene un tremendo</p>
<p>impacto negativo en el c√≥digo. Lo convierte de algo que ser√≠a razonablemente</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>mantenible en algo que seguramente est√© plagado de errores.</p>
<p>A√±ad√≠ los dos tipos de argumento de forma incremental. Primero, el</p>
<p>argumento String , que genera lo siguiente:</p>
<p>Listado 14-10</p>
<p>Args.java (booleano y String)</p>
<p>package com.objectmentor.utilities.getopts;</p>
<p>import java.text.ParseException;</p>
<p>import java.util.*;</p>
<p>public class Args {</p>
<p>private String schema;</p>
<p>private String[] args;</p>
<p>private boolean valid = true;</p>
<p>private Set&lt;Character&gt; unexpectedArguments = new TreeSet&lt;Character&gt;();</p>
<p>private Map&lt;Character, Boolean&gt; booleanArgs =</p>
<p>new HashMap&lt;Character, Boolean&gt;();</p>
<p>private Map&lt;Character, String&gt; stringArgs =</p>
<p>new HashMap&lt;Character, String&gt;();</p>
<p>private Set&lt;Character&gt; argsFound = new HashSet&lt;Character&gt;();</p>
<p>private int currentArgument;</p>
<p>private char errorArgument = ‚Äò\0‚Äô;</p>
<p>enum ErrorCode { OK, MISSING_STRING }</p>
<p>private ErrorCode errorCode = ErrorCode.OK;</p>
<p>public Args(String schema, String[] args) throws ParseException {</p>
<p>this.schema = schema;</p>
<p>this.args = args;</p>
<p>valid = parse();</p>
<p>private boolean parse() throws ParseException {</p>
<p>if (schema.length() == 0 &amp;&amp; args.length == 0)</p>
<p>return true;</p>
<p>parseSchema();</p>
<p>parseArguments();</p>
<p>return valid;</p>
<p>private boolean parseSchema() throws ParseException {</p>
<p>for (String element : schema.split(‚Äú,‚Äù)) {</p>
<p>if (element.length() &gt; 0) {</p>
<p>String trimmedElement = element.trim();</p>
<p>parseSchemaElement(trimmedElement);</p>
<p>return true;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void parseSchemaElement(String element) throws ParseException {</p>
<p>char elementId = element.charAt(0);</p>
<p>String elementTail = element.substring(1);</p>
<p>validateSchemaElementId(elementId);</p>
<p>if (isBooleanSchemaElement(elementTail))</p>
<p>parseBooleanSchemaElement(elementId);</p>
<p>else if (isStringSchemaElement(elementTail))</p>
<p>parseStringSchemaElement(elementId);</p>
<p>private void validateSchemaElementId(char elementId) throws ParseException</p>
<p>if (!Character.isLetter(elementId)) {</p>
<p>throw new ParseException(</p>
<p>‚ÄúBad character:‚Äù + elementId + ‚Äúin Args format: ‚Äù + schema, 0);</p>
<p>private void parseStringSchemaElement(char elementId) {</p>
<p>stringArgs.put(elementId, ‚Äú‚Äù);</p>
<p>private boolean isStringSchemaElement(String elementTail) {</p>
<p>return elementTail.equals(‚Äú*‚Äù);</p>
<p>private boolean isBooleanSchemaElement(String elementTail) {</p>
<p>return elementTail.length() == 0;</p>
<p>private void parseBooleanSchemaElement(char elementId) {</p>
<p>booleanArgs.put(elementId, false);</p>
<p>private boolean parseArguments() {</p>
<p>for (currentArgument 0; currentArgument args.length;</p>
<p>currentArgument++)</p>
<p>String arg = args[currentArgument];</p>
<p>parseArgument(arg);</p>
<p>return true;</p>
<p>private void parseArgument(String arg) {</p>
<p>if (arg.startsWith(‚Äú-‚Äù))</p>
<p>parseElements(arg);</p>
<p>private void parseElements(String arg) {</p>
<p>for (int i = 1; i &lt; arg.length(); i++)</p>
<p>parseElement(arg.charAt(i));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void parseElement(char argChar) {</p>
<p>if (setArgument(argChar))</p>
<p>argsFound.add(argChar);</p>
<p>else {</p>
<p>unexpectedArguments.add(argChar);</p>
<p>valid = false;</p>
<p>private boolean setArgument(char argChar) {</p>
<p>boolean set = true;</p>
<p>if (isBoolean(argChar))</p>
<p>setBooleanArg(argChar, true);</p>
<p>else if (isString(argChar))</p>
<p>setStringArg (argChar, ‚Äú‚Äù);</p>
<p>else</p>
<p>set = false;</p>
<p>return set;</p>
<p>private void setStringArg(char argChar, String s) {</p>
<p>currentArgument++;</p>
<p>try {</p>
<p>stringArgs.put(argChar, args[currentArgument]);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>valid = false;</p>
<p>errorArgument = argChar;</p>
<p>errorCode = ErrorCode.MISSING_STRING;</p>
<p>private boolean isString(char argChar) {</p>
<p>return stringArgs.containsKey(argChar);</p>
<p>private void setBooleanArg(char argChar, boolean value) {</p>
<p>booleanArgs.put(argChar, value);</p>
<p>private boolean isBoolean(char argChar) {</p>
<p>return booleanArgs.containsKey(argChar);</p>
<p>public int cardinality() {</p>
<p>return argsFound.size();</p>
<p>public String usage() {</p>
<p>if (schema.length() &gt; 0)</p>
<p>return ‚Äú-[‚Äù + schema + ‚Äú]‚Äù;</p>
<p>else</p>
<p>return ‚Äú‚Äù;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public String errorMessage() throws Exception {</p>
<p>if (unexpectedArguments.size() &gt; 0) {</p>
<p>return unexpectedArgumentMessage();</p>
<p>} else</p>
<p>switch (errorCode) {</p>
<p>case MISSING_STRING:</p>
<p>return String.format (‚ÄúCould not find string parameter for -%c.‚Äù,</p>
<p>errorArgument);</p>
<p>case OK:</p>
<p>throw new Exception(‚ÄúTILT: Should not get here.‚Äù);</p>
<p>return ‚Äú‚Äù;</p>
<p>private String unexpectedArgumentMessage() {</p>
<p>StringBuffer message = new StringBuffer(‚ÄúArgument(s) -‚Äù);</p>
<p>for (char c : unexpectedArguments) {</p>
<p>message.append(c);</p>
<p>message.append(‚Äú unexpected.‚Äù);</p>
<p>return message.toString();</p>
<p>public boolean getBoolean(char arg) {</p>
<p>return falseIfNull(booleanArgs.get(arg));</p>
<p>private boolean falseIfNull(Boolean b) {</p>
<p>return b == null ? false : b;</p>
<p>public String getString(char arg) {</p>
<p>return blankIfNull(stringArgs.get(arg));</p>
<p>private String blankIfNull(String s) {</p>
<p>return s == null ? ‚Äú‚Äù : s;</p>
<p>public boolean has(char arg) {</p>
<p>return argsFound.contains(arg);</p>
<p>public boolean isValid() {</p>
<p>return valid;</p>
<p>Comprobar√° que empieza a desbocarse. No es terrible pero el desastre se</p>
<p>est√° gestando. Basta con incluir el tipo de argumento integer para que</p>
<p>resulte fat√≠dico.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="entonces-me-detuve-239">Entonces me detuve</h3>
<p>Todav√≠a ten√≠a que a√±adir otros dos tipos de argumentos sab√≠a que</p>
<p>empeorar√≠an las cosas. Si los forzaba, seguramente funcionar√≠an pero</p>
<p>provocar√≠a un desastre demasiado complicado de arreglar. Si la estructura del</p>
<p>c√≥digo ten√≠a que poder mantenerse, era el momento de corregirla.</p>
<p>Por ello dej√© de a√±adir elementos y comenc√© la refactorizaci√≥n. Tras</p>
<p>a√±adir los argumentos String integer , sab√≠a que cada uno necesitar√≠a</p>
<p>nuevo c√≥digo en tres puntos principales. En primer lugar, cada tipo de</p>
<p>argumento necesita una forma de analizar su elemento de esquema para poder</p>
<p>seleccionar el HashMap de ese tipo. Tras ello, ser√≠a necesario analizar cada</p>
<p>tipo de argumento en las cadenas de l√≠nea de comandos y convertirlos en su</p>
<p>tipo correcto. Por √∫ltimo, cada tipo de argumento necesitar√≠a un m√©todo</p>
<p>getXXX para poder devolverlo al invocador como su tipo correcto.</p>
<p>Muchos tipos diferentes y todos con m√©todos similares, lo que en realidad</p>
<p>era una clase. Y de este modo naci√≥ el concepto de ArgumentMarshaler</p>
<h3 id="sobre-el-incrementalismo-240">Sobre el incrementalismo</h3>
<p>Una de las mejores formas de acabar con un programa es realizar cambios</p>
<p>masivos con la intenci√≥n de mejorarlo. Algunos programas nunca se</p>
<p>recuperan de estas mejoras. El problema es lo complicado que resulta</p>
<p>conseguir que el programa funcione de la misma forma que antes de la</p>
<p>mejora.</p>
<p>Para evitarlo, recurro a la disciplina TDD ( Test-Driven Development</p>
<p>Desarrollo guiado por pruebas). Una de las doctrinas centrales de este</p>
<p>enfoque es mantener la ejecuci√≥n del sistema en todo momento. Es decir, con</p>
<p>TDD no puedo realizar cambios que afecten al funcionamiento del sistema.</p>
<p>Todos los cambios deben mantenerlo como antes de los cambios. Para</p>
<p>lograrlo, necesito una serie de pruebas automatizadas que ejecutar</p>
<p>r√°pidamente y que verifiquen que el comportamiento del sistema no ha</p>
<p>variado. Para la clase Args , cre√© una serie de pruebas de unidad y aceptaci√≥n.</p>
<p>Las pruebas de unidad se crearon en Java y se administraron con JUnit. Las</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>pruebas de aceptaci√≥n se crearon como p√°ginas wiki en FitNesse. Podr√≠a</p>
<p>haber ejecutado estas pruebas en cualquier momento y, si eran satisfactorias,</p>
<p>sabr√≠a que el sistema funcionaba de la forma especificada.</p>
<p>As√≠ pues, comenc√© a realizar peque√±os cambios. Cada uno desplazaba la</p>
<p>estructura del sistema hacia el concepto ArgumentMarshaler , y cada cambio</p>
<p>manten√≠a el funcionamiento del sistema. El primer cambio realizado fue</p>
<p>a√±adir el esqueleto de ArgumentMarshaller al final del desastre anterior</p>
<p>(v√©ase el Listado 14-11).</p>
<p>Listado 14-11</p>
<p>ArgumentMarshaller a√±adido a Args.java</p>
<p>private class ArgumentMarshaler {</p>
<p>private boolean booleanValue = false;</p>
<p>public void setBoolean(boolean value) {</p>
<p>booleanValue = value;</p>
<p>public boolean getBoolean() { return booleanValue; }</p>
<p>private class BooleanArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private class StringArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private class IntegerArgumentMarshaler extends ArgumentMarshaler {</p>
<p>Evidentemente, esto no afectar√≠a nada, por lo que realic√© la</p>
<p>modificaci√≥n m√°s sencilla posible que afectara a la m√≠nima cantidad de</p>
<p>c√≥digo. Cambi√© HashMap para que los argumentos Boolean aceptaran</p>
<p>ArgumentMarshaler</p>
<p>private Map&lt;Character, ArgumentMarshaler &gt; booleanArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler &gt;();</p>
<p>Esto afectaba a varias instrucciones que correg√≠ r√°pidamente.</p>
<p>...</p>
<p>private void parseBooleanSchemaElement(char elementId) {</p>
<p>booleanArgs.put(elementId, new BooleanArgumentMarshaler ());</p>
<p>...</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void setBooleanArg(char argChar, boolean value) {</p>
<p>booleanArgs. get (argChar). setBoolean (value);</p>
<p>...</p>
<p>public boolean getBoolean(char arg) {</p>
<p>return falseIfNull (booleanArgs.get(arg). getBoolean() );</p>
<p>Estos cambios se aplican a las zonas que mencionamos antes: parse set</p>
<p>get para el tipo de argumento. Desafortunadamente, aunque sean cambios</p>
<p>menores, algunas de las pruebas comenzaron a fallar. Si se fija atentamente</p>
<p>en getBoolean , comprobar√° que se puede invocar con pero no existe un</p>
<p>argumento , por lo que booleanArgs.get(‚Äòy‚Äô) devolver√° null y la funci√≥n</p>
<p>generar√° NullPointerException . La funci√≥n falseIfNull se usa como</p>
<p>protecci√≥n ante este hecho pero el cambio aplicado hace que la funci√≥n sea</p>
<p>irrelevante.</p>
<p>El incrementalismo exig√≠a que esto funcionara antes de realizar otros</p>
<p>cambios. La soluci√≥n no era demasiado complicada; bastaba con cambiar la</p>
<p>comprobaci√≥n de null . Ya no era necesario comprobar null en boolean, sino</p>
<p>en ArgumentMarshaller</p>
<p>Primero, elimin√© la invocaci√≥n de falseIfNull en la funci√≥n</p>
<p>getBoolean . Ya no serv√≠a de nada, por lo que elimin√© directamente la</p>
<p>funci√≥n. Las pruebas segu√≠an fallando igual, lo que supon√≠a que no hab√≠a</p>
<p>nuevos errores.</p>
<p>public boolean getBoolean(char arg) {</p>
<p>return booleanArgs.get(arg).getBoolean();</p>
<p>Tras ello, divid√≠ la funci√≥n en dos l√≠neas y a√±ad√≠ ArgumentMarshaller</p>
<p>una variable propia: argumentMarshaller . No me preocupaba el extenso</p>
<p>nombre de la variable; era redundante y estorbaba a la funci√≥n, por lo que lo</p>
<p>reduje a am [N5].</p>
<p>public boolean getBoolean(char arg) {</p>
<p>Args.ArgumentMarshaler am = booleanArgs.get(arg);</p>
<p>return am .getBoolean();</p>
<p>Y tras ello a√±ad√≠ la l√≥gica de detecci√≥n de null</p>
<p>public boolean getBoolean(char arg) {</p>
<p>Args.ArgumentMarshaler am = booleanArgs.get(arg);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return am != null &amp;&amp; am.getBoolean();</p>
<h3 id="argumentos-de-cadena-241">Argumentos de cadena</h3>
<p>La inclusi√≥n de los argumentos String fue similar a la de los argumentos</p>
<p>boolean . Tuve que cambiar HashMap y conseguir que funcionaran parse set</p>
<p>get . No deber√≠an producirse sorpresas posteriores a excepci√≥n de que la</p>
<p>implementaci√≥n completa se inclu√≠a en la clase ArgumentMarshaller en lugar</p>
<p>de distribuirla en variantes.</p>
<p>private Map&lt;Character, ArgumentMarshaler &gt; stringArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler &gt;();</p>
<p>...</p>
<p>private void parseStringSchemaElement(char elementId) {</p>
<p>stringArgs.put(elementId, new StringArgumentMarshaler());</p>
<p>...</p>
<p>private void setStringArg(char argChar) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>try {</p>
<p>stringArgs. get (argChar). setString (args[currentArgument]);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorCode = ErrorCode.MISSING_STRING;</p>
<p>throw new ArgsException();</p>
<p>...</p>
<p>public String getString (char arg) {</p>
<p>Args.ArgumentMarshaler am = stringArgs.get(arg);</p>
<p>return am == null ? ‚Äú‚Äù : am.getString();</p>
<p>...</p>
<p>private class ArgumentMarshaler {</p>
<p>private boolean booleanValue = false;</p>
<p>private String stringValue;</p>
<p>public void setBoolean(boolean value) {</p>
<p>booleanValue = value;</p>
<p>public boolean getBoolean() {</p>
<p>return booleanValue;</p>
<p>public void setString(String s) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>stringValue = s;</p>
<p>public String getString() {</p>
<p>return stringValue == null ? ‚Äú‚Äù : stringValue;</p>
<p>De nuevo, estos cambios se realizaron individualmente para conservar las</p>
<p>pruebas, aunque fallaran. Si una prueba fallaba, me aseguraba de que fuera</p>
<p>correcta antes de continuar con el siguiente cambio.</p>
<p>Ya deber√≠a reconocer mi intenci√≥n. Tras incluir el comportamiento de</p>
<p>se√±alizaci√≥n en la clase base ArgumentMarshaler , comenc√© a transferirlo a</p>
<p>las variantes, para de esta forma mantener el funcionamiento mientras</p>
<p>cambiaba gradualmente la forma del programa.</p>
<p>El siguiente paso consist√≠a en transferir la funcionalidad del argumento</p>
<p>int ArgumentMarshaler . De nuevo, no hubo sorpresas.</p>
<p>private Map&lt;Character, ArgumentMarshaler &gt; intArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler &gt;();</p>
<p>...</p>
<p>private void parseIntegerSchemaElement(char elementId) {</p>
<p>intArgs.put(elementId, new IntegerArgumentMarshaler() );</p>
<p>...</p>
<p>private void setIntArg(char argChar) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = args[currentArgument];</p>
<p>intArgs. get (argChar). setInteger (Integer.parseInt(parameter));</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorCode = ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>} catch (NumberFormatException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>...</p>
<p>public int getInt(char arg) {</p>
<p>Args.ArgumentMarshaler am = intArgs.get(arg);</p>
<p>return am == null ? 0 : am.getInteger();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>...</p>
<p>private class ArgumentMarshaler {</p>
<p>private boolean booleanValue = false;</p>
<p>private String stringValue;</p>
<p>private int integerValue;</p>
<p>public void setBoolean(boolean value) {</p>
<p>booleanValue = value;</p>
<p>public boolean getBoolean() {</p>
<p>return booleanValue;</p>
<p>public void setString(String s) {</p>
<p>stringValue = s;</p>
<p>public String getString() {</p>
<p>return stringValue == null ? ‚Äú‚Äù : stringValue;</p>
<p>public void setInteger(int i) {</p>
<p>integerValue = i;</p>
<p>public int getInteger() {</p>
<p>return integerValue;</p>
<p>Tras transferir la se√±alizaci√≥n a ArgumentMarshaler , comenc√© a transferir</p>
<p>la funcionalidad las variantes. El primer paso fue pasar la funci√≥n</p>
<p>setBoolean BooleanArgumentMarshaller garantizar su correcta</p>
<p>invocaci√≥n. Para ello cre√© un m√©todo set abstracto.</p>
<p>private abstract class ArgumentMarshaler {</p>
<p>protected boolean booleanValue = false;</p>
<p>private String stringValue;</p>
<p>private int integerValue;</p>
<p>public void setBoolean(boolean value) {</p>
<p>booleanValue = value;</p>
<p>public boolean getBoolean() {</p>
<p>return booleanValue;</p>
<p>public void setString(String s) {</p>
<p>stringValue = s;</p>
<p>public String getString() {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return stringValue == null ? ‚Äú‚Äù : stringValue;</p>
<p>public void set Integer(int i) {</p>
<p>integerValue = i;</p>
<p>public int getInteger() {</p>
<p>return integerValue;</p>
<p>public abstract void set(String s);</p>
<p>Tras ello, implement√© el m√©todo set en BooleanArgumentMarshaller</p>
<p>private class BooleanArgumentMarshaler extends ArgumentMarshaler {</p>
<p>public void set(String s) {</p>
<p>booleanValue = true;</p>
<p>Y por √∫ltimo cambi√© la invocaci√≥n de setBoolean por la de set</p>
<p>private void setBooleanArg(char argChar, boolean value) {</p>
<p>booleanArgs.get(argChar). set(‚Äútrue‚Äù)</p>
<p>Las pruebas segu√≠an siendo satisfactorias. Como este cambio hac√≠a que</p>
<p>set se implementara en BooleanArgumentMarshaler , elimin√© el m√©todo</p>
<p>setBoolean de la clase base ArgumentMarshaler</p>
<p>La funci√≥n abstracta set acepta un argumento String pero la</p>
<p>implementaci√≥n de BooleanArgumentMarshaler no lo usa. He incluido el</p>
<p>argumento porque sab√≠a que StringArgumentMarshaler</p>
<p>IntegerArgumentMarshaler lo utilizar√≠an.</p>
<p>Tras ello, el objetivo era implementar el m√©todo get en</p>
<p>BooleanArgumentMarshaler . La implementaci√≥n de funciones get siempre es</p>
<p>escabrosa ya que el tipo devuelto tiene que ser Object y en este caso debe</p>
<p>convertirse a Boolean</p>
<p>public boolean getBoolean(char arg) {</p>
<p>Args.ArgumentMarshaler am = booleanArgs.get(arg);</p>
<p>return am != null &amp;&amp; (Boolean) am. get ();</p>
<p>Para compilarlo, a√±ad√≠ la funci√≥n get ArgumentMarshaler</p>
<p>private abstract class ArgumentMarshaler {</p>
<p>...</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public Object get() {</p>
<p>return null;</p>
<p>Se compila y las pruebas fallan. Para que vuelvan a funcionar, basta con</p>
<p>convertir get en abstracto e implementarlo en BooleanArgumentMarshaler</p>
<p>private abstract class ArgumentMarshaler {</p>
<p>protected boolean booleanValue = false;</p>
<p>...</p>
<p>public abstract Object get();</p>
<p>private class BooleanArgumentMarshaler extends ArgumentMarshaler {</p>
<p>public void set (String s) {</p>
<p>booleanValue = true;</p>
<p>public Object get() {</p>
<p>return booleanValue;</p>
<p>De nuevo, las pruebas son satisfactorias. Ahora tanto get como set se</p>
<p>implementan en BooleanArgumentMarshaler . Esto me permite eliminar la</p>
<p>antigua funci√≥n getBoolean de ArgumentMarshaler , cambiar la variable</p>
<p>protegida booleanValue BooleanArgumentMarshaler convertirla en</p>
<p>privada.</p>
<p>Repet√≠ el mismo patr√≥n de cambios con las cadenas. Implement√© set</p>
<p>get , elimin√© las funciones sin usar y desplac√© las variables.</p>
<p>private void setStringArg(char argChar) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>try {</p>
<p>stringArgs.get(argChar). set (args[currentArgument]);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorCode = ErrorCode.MISSING_STRING;</p>
<p>throw new ArgsException();</p>
<p>...</p>
<p>public String getString(char arg) {</p>
<p>Args.ArgumentMarshaler am = stringArgs.get(arg);</p>
<p>return am == null ? ‚Äú‚Äù : (String) am. get ();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>...</p>
<p>private abstract class ArgumentMarshaler {</p>
<p>private int integerValue;</p>
<p>public void setInteger(int i) {</p>
<p>integerValue = i;</p>
<p>public int getInteger() {</p>
<p>return integerValue;</p>
<p>public abstract void set(String s);</p>
<p>public abstract Object get();</p>
<p>private class BooleanArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private boolean booleanValue = false;</p>
<p>public void set(String s) {</p>
<p>booleanValue = true;</p>
<p>public Object get() {</p>
<p>return booleanValue;</p>
<p>private class StringArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private String stringValue = ‚Äú‚Äù;</p>
<p>public void set(String s) {</p>
<p>stringValue = s;</p>
<p>public Object get() {</p>
<p>return stringValue;</p>
<p>private class IntegerArgumentMarshaler extends ArgumentMarshaler {</p>
<p>public void set(String s){</p>
<p>public Object get() {</p>
<p>return null;</p>
<p>Por √∫ltimo, repet√≠ el proceso con los enteros. Resulta m√°s complicado ya</p>
<p>que los enteros deben analizarse y la operaci√≥n de an√°lisis puede generar una</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>excepci√≥n, pero el resultado es m√°s indicado ya que el concepto de</p>
<p>NumberFormatException se oculta totalmente en</p>
<p>IntegerArgumentMarshaler</p>
<p>private boolean isIntArg(char argChar) return intArgs.containsKey(argChar);</p>
<p>private void setIntArg(char argChar) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = args[currentArgument];</p>
<p>intArgs.get(argChar). set (parameter);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorCode = ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>} catch ( ArgsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_INTEGER;</p>
<p>throw</p>
<p>...</p>
<p>private void setBooleanArg(char argChar) {</p>
<p>try {</p>
<p>booleanArgs.get(argChar).set(‚Äútrue‚Äù);</p>
<p>} catch (ArgsException e) {</p>
<p>...</p>
<p>public int getInt(char arg) {</p>
<p>Args.ArgumentMarshaler am = intArgs.get(arg);</p>
<p>return am == null ? 0 : (Integer) am. get ();</p>
<p>...</p>
<p>private abstract class ArgumentMarshaler {</p>
<p>public abstract void set(String s) throws ArgsException;</p>
<p>public abstract Object get();</p>
<p>...</p>
<p>private class IntegerArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private int intValue = 0;</p>
<p>public void set(String s) throws ArgsException {</p>
<p>try {</p>
<p>intValue = Integer.parseInt(s);</p>
<p>} catch (NumberFormatException s) {</p>
<p>throw new ArgsException();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public Object get() {</p>
<p>return intValue;</p>
<p>Evidentemente, las pruebas segu√≠an funcionando. Tras ello, me deshice</p>
<p>de las distintas asignaciones de la parte superior del algoritmo, lo que hace</p>
<p>que el sistema sea mucho m√°s gen√©rico. Sin embargo, no las puede eliminar</p>
<p>ya que afectar√≠a a la integridad del sistema. En su lugar, a√±ad√≠ un nuevo Map</p>
<p>para ArgumentMarshaler y, tras ello, cambi√© uno a uno los m√©todos para que</p>
<p>usaran la nueva asignaci√≥n en lugar de las originales.</p>
<p>public class Args {</p>
<p>...</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; booleanArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; stringArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; intArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; marshalers =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>...</p>
<p>private void parseBooleanSchemaElement(char elementId) {</p>
<p>ArgumentMarshaler m = new BooleanArgumentMarshaler();</p>
<p>booleanArgs.put(elementId, m);</p>
<p>marshalers.put(elementId, m);</p>
<p>private void parseIntegerSchemaElement(char elementId) {</p>
<p>ArgumentMarshaler m = new IntegerArgumentMarshaler();</p>
<p>intArgs.put(elementId, m);</p>
<p>marshalers.put(elementId, m);</p>
<p>private void parseStringSchemaElement(char elementId) {</p>
<p>ArgumentMarshaler m = new StringArgumentMarshaler();</p>
<p>stringArgs.put(elementId, m);</p>
<p>marshalers.put(elementId, m);</p>
<p>Las pruebas segu√≠an funcionando. Tras ello, cambi√© isBooleanArg de</p>
<p>esto:</p>
<p>private boolean isBooleanArg(char argChar) {</p>
<p>return booleanArgs.containsKey(argChar);</p>
<p>a este otro:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private boolean isBooleanArg(char argChar) {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>return m instanceof BooleanArgumentMarshaler;</p>
<p>Las pruebas funcionaban, por lo que apliqu√© el mismo cambio en</p>
<p>isIntArg isStringArg</p>
<p>private boolean isIntArg(char argChar) {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>return m instanceof IntegerArgumentMarshaler;</p>
<p>private boolean isStringArg(char argChar) {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>return m instanceof StringArgumentMarshaler;</p>
<p>Las pruebas eran correctas, por lo que elimin√© las invocaciones</p>
<p>duplicadas de marshalers.get</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (isBooleanArg( ))</p>
<p>setBooleanArg(argChar);</p>
<p>else if (isStringArg( ))</p>
<p>setStringArg(argChar);</p>
<p>else if (isIntArg( ))</p>
<p>setIntArg(argChar);</p>
<p>else</p>
<p>return false;</p>
<p>return true;</p>
<p>private boolean isIntArg ( ArgumentMarshaler m ) {</p>
<p>return m instanceof IntegerArgumentMarshaler;</p>
<p>private boolean isStringArg ( ArgumentMarshaler m ) {</p>
<p>return m instanceof StringArgumentMarshaler;</p>
<p>private boolean isBooleanArg ( ArgumentMarshaler m ) {</p>
<p>return m instanceof BooleanArgumentMarshaler;</p>
<p>Los tres argumentos isxxxArg ya no ten√≠an sentido, de modo que los</p>
<p>reubiqu√©:</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if ( m instanceof BooleanArgumentMarshaler</p>
<p>setBooleanArg(argChar);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>else if ( m instanceof StringArgumentMarshaler</p>
<p>setStringArg(argChar);</p>
<p>else if ( m instanceof IntegerArgumentMarshaler</p>
<p>setIntArg(argChar);</p>
<p>else</p>
<p>return false;</p>
<p>return true;</p>
<p>Tras ello, empec√© a usar la asignaci√≥n marshalers en las funciones set</p>
<p>dividiendo el uso de las otras tres asignaciones. Comenc√© por los elementos</p>
<p>boolean</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (m instanceof BooleanArgumentMarshaler)</p>
<p>setBooleanArg( );</p>
<p>else if (m instanceof StringArgumentMarshaler)</p>
<p>setStringArg(argChar);</p>
<p>else if (m instanceof IntegerArgumentMarshaler)</p>
<p>setIntArg(argChar);</p>
<p>else</p>
<p>return false;</p>
<p>return true;</p>
<p>...</p>
<p>private void setBooleanArg( ArgumentMarshaler m ) {</p>
<p>try {</p>
<p>.set(‚Äútrue‚Äù); // era: booleanArgs.get(argChar).set(‚Äútrue‚Äù);</p>
<p>} catch (ArgsException e) {</p>
<p>Las pruebas segu√≠an siendo correctas de modo que repet√≠ la operaci√≥n con</p>
<p>las cadenas y los enteros. De esta manera se puede integrar parte del</p>
<p>desagradable c√≥digo de gesti√≥n de excepciones en la funci√≥n setArgument</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>try {</p>
<p>if (m instanceof BooleanArgumentMarshaler)</p>
<p>setBooleanArg(m);</p>
<p>else if (m instanceof StringArgumentMarshaler)</p>
<p>setStringArg( );</p>
<p>else if (m instanceof IntegerArgumentMarshaler)</p>
<p>setIntArg( );</p>
<p>else</p>
<p>return false;</p>
<p>} catch (ArgsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>throw e;</p>
<p>return true;</p>
<p>private void setIntArg( ArgumentMarshaler m ) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = args[currentArgument];</p>
<p>.set(parameter);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>errorCode = ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>} catch (ArgsException e) {</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_INTEGER;</p>
<p>throw e;</p>
<p>private void setStringArg( ArgumentMarshaler m ) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>try {</p>
<p>.set(args[currentArgument]);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>errorCode = ErrorCode.MISSING_STRING;</p>
<p>throw new ArgsException();</p>
<p>Ya pod√≠a eliminar las tres asignaciones antiguas. Primero, deb√≠a cambiar</p>
<p>la funci√≥n getBoolean de:</p>
<p>public boolean getBoolean(char arg) {</p>
<p>Args.ArgumentMarshaler am = booleanArgs.get(arg);</p>
<p>return am != null &amp;&amp; (Boolean) am.get();</p>
<p>a:</p>
<p>public boolean getBoolean(char arg) {</p>
<p>Args.ArgumentMarshaler am = marshalers.get(arg);</p>
<p>boolean b = false;</p>
<p>try {</p>
<p>= am != null &amp;&amp; (Boolean) am.get();</p>
<p>} catch (ClassCastException e) {</p>
<p>b = false;</p>
<p>return b;</p>
<p>Este √∫ltimo cambio puede parecer sorprendente. ¬øPor qu√© de repente</p>
<p>decid√≠ enfrentarme a ClassCastException ? Por tener una serie de pruebas de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>unidad y otra serie independiente de pruebas de aceptaci√≥n creadas en</p>
<p>FitNesse. Las pruebas de FitNesse garantizan que si se invoca getBoolean en</p>
<p>un argumento no Booleano, se obtiene false . No sucede lo mismo con las</p>
<p>pruebas de unidad. Hasta el momento, s√≥lo hab√≠a ejecutado las pruebas de</p>
<p>[93]</p>
<p>unidad</p>
<p>Este √∫ltimo cambio me permiti√≥ extraer otro uso de la asignaci√≥n</p>
<p>boolean:</p>
<p>private void parseBooleanSchemaElement(char elementId) {</p>
<p>ArgumentMarshaler m = new BooleanArgumentMarshaler();</p>
<p>booleanArgs.put(elementId, m);</p>
<p>marshalers.put(elementId, m);</p>
<p>Y ahora ya podemos eliminar la asignaci√≥n boolean.</p>
<p>public class Args {</p>
<p>...</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; booleanArgs =</p>
<p>new HashMap&lt;Character, ArgmentMarshaler&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; stringArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; intArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; marshalers =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>...</p>
<p>Tras ello, cambi√© los argumentos String Integer de la misma forma y</p>
<p>limpi√© los valores boolean</p>
<p>private void parseBooleanSchemaElement(char elementId) {</p>
<p>marshalers.put(elementId, new BooleanArgumentMarshaler() );</p>
<p>private void parseIntegerSchemaElement(char elementId) {</p>
<p>marshalers.put(elementId, new IntegerArgumentMarshaler() );</p>
<p>private void parseStringSchemaElement(char elementId) {</p>
<p>marshalers.put(elementId, new StringArgumentMarshaler() );</p>
<p>...</p>
<p>public String getString(char arg) {</p>
<p>Args.ArgumentMarshaler am = marshalers .get(arg);</p>
<p>try {</p>
<p>return am null ? ‚Äú‚Äù : (String) am.get();</p>
<p>} catch (ClassCastException e) {</p>
<p>return ‚Äú‚Äù;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public int getInt(char arg) {</p>
<p>Args.ArgumentMarshaler am = marshalers .get(arg);</p>
<p>try {</p>
<p>return am == null ? 0 : (Integer) am.get();</p>
<p>} catch (Exception e) {</p>
<p>return 0;</p>
<p>...</p>
<p>public class Args {</p>
<p>...</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; stringArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; intArgs =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; marshalers =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>...</p>
<p>Seguidamente, dispuse en l√≠nea los tres m√©todos parse ya que no serv√≠an</p>
<p>para mucho:</p>
<p>private void parseSchemaElement(String element) throws ParseException {</p>
<p>char elementId = element.charAt(0);</p>
<p>String elementTail = element.substring(1);</p>
<p>validateSchemaElementId(elementId);</p>
<p>if (isBooleanSchemaElement(elementTail))</p>
<p>marshalers.put(elementId, new BooleanArgumentMarshaler());</p>
<p>else if (isStringSchemaElement(elementTail))</p>
<p>marshalers.put(elementId, new StringArgumentMarshaler());</p>
<p>else if (isIntegerSchemaElement(elementTail)) {</p>
<p>marshalers.put(elementId, new IntegerArgumentMarshaler());</p>
<p>} else {</p>
<p>throw new ParseException(String.format(</p>
<p>‚ÄúArgument: %c has invalid format: %s.‚Äù, elementId, elementTail), 0);</p>
<p>Es el momento de ver la estructura completa. El Listado 14-12 muestra la</p>
<p>clase Args actual.</p>
<p>Listado 14-12</p>
<p>Args.java (tras la primera refactorizaci√≥n)</p>
<p>package com.objectmentor.utilities.getopts;</p>
<p>import java.text.ParseException;</p>
<p>import java.util.*;</p>
<p>public class Args {</p>
<p>private String schema;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private String[] args;</p>
<p>private boolean valid = true;</p>
<p>private Set&lt;Character&gt; unexpectedArguments = new TreeSet&lt;Character&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; marshalers =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Set&lt;Character&gt; argsFound = new HashSet&lt;Character&gt;();</p>
<p>private int currentArgument;</p>
<p>private char errorArgumentId = ‚Äò\0‚Äô;</p>
<p>private String errorParameter = ‚ÄúTILT‚Äù;</p>
<p>private ErrorCode errorCode = ErrorCode.OK;</p>
<p>private enum ErrorCode {</p>
<p>OK, MISSING_STRING, MISSING_INTEGER, INVALID_INTEGER,</p>
<p>UNEXPECTED_ARGUMENT}</p>
<p>public Args(String schema, String[] args) throws ParseException {</p>
<p>this.schema = schema;</p>
<p>this.args = args;</p>
<p>valid = parse();</p>
<p>private boolean parse() throws ParseException {</p>
<p>if (schema.length() == 0 &amp;&amp; args.length == 0)</p>
<p>return true;</p>
<p>parseSchema();</p>
<p>try {</p>
<p>parseArguments();</p>
<p>} catch (ArgsException e) {</p>
<p>return valid;</p>
<p>private boolean parseSchema() throws ParseException {</p>
<p>for (String element : schema.split(‚Äú,‚Äù)) {</p>
<p>if (element.length() &gt; 0) {</p>
<p>String trimmedElement = element.trim();</p>
<p>parseSchemaElement(trimmedElement);</p>
<p>return true;</p>
<p>private void parseSchemaElement(String element) throws ParseException {</p>
<p>char elementId = element.charAt(0);</p>
<p>String elementTail = element.substring(1);</p>
<p>validateSchemaElementId(elementId);</p>
<p>if (isBooleanSchemaElement(elementTail))</p>
<p>marshalers.put(elementId, new BooleanArgumentMarshaler());</p>
<p>else if (isStringSchemaElement(elementTail))</p>
<p>marshalers.put(elementId, new StringArgumentWarshaler());</p>
<p>else if (isIntegerSchemaElement(elementTail)) {</p>
<p>marshalers.put(elementId, new IntegerArgumentMarshaler());</p>
<p>} else {</p>
<p>throw new ParseException(String.format(</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>‚ÄúArgument: %c has invalid format: %s.‚Äù, elementId, elementTail), 0);</p>
<p>private void validateSchemaElementId(char elementId) throws ParseException</p>
<p>if (!Character.isLetter(elementId)) {</p>
<p>throw new ParseException(</p>
<p>‚ÄúBad character:‚Äù + elementId + ‚Äúin Args format: ‚Äù + schema, 0);</p>
<p>private boolean isStringSchemaElement(String elementTail) {</p>
<p>return elementTail.equals(‚Äú*‚Äù);</p>
<p>private boolean isBooleanSchemaElement(String elementTail) {</p>
<p>return elementTail.length() == 0;</p>
<p>private boolean isIntegerSchemaElement(String elementTail) {</p>
<p>return elementTail.equals(‚Äú#‚Äù);</p>
<p>private boolean parseArguments() throws ArgsException {</p>
<p>for (currentArgument=0; currentArgument&lt;args.length; currentArgument++) {</p>
<p>String arg = args[currentArgument];</p>
<p>parseArgument(arg);</p>
<p>return true;</p>
<p>private void parseArgument(String arg) throws ArgsException {</p>
<p>if (arg.startsWith(‚Äú-‚Äù))</p>
<p>parseElements(arg);</p>
<p>private void parseElements(String arg) throws ArgsException {</p>
<p>for (int i = 1; i &lt; arg.length(); i++)</p>
<p>parseElement(arg.charAt(i));</p>
<p>private void parseElement(char argChar) throws ArgsException {</p>
<p>if (setArgument(argChar))</p>
<p>argsFound.add(argChar);</p>
<p>else {</p>
<p>unexpectedArguments.add(argChar);</p>
<p>errorCode = ErrorCode.UNEXPECTED_ARGUMENT;</p>
<p>valid = false;</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>try {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if (m instanceof BooleanArgumentMarshaler)</p>
<p>setBooleanArg(m);</p>
<p>else if (m instanceof StringArgumentMarshaler)</p>
<p>setStringArg(m);</p>
<p>else if (m instanceof IntegerArgumentMarshaler)</p>
<p>setIntArg(m);</p>
<p>else</p>
<p>return false;</p>
<p>} catch (ArgsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>throw e;</p>
<p>return true;</p>
<p>private void setIntArg(ArgumentMarshaler m) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = args[currentArgument];</p>
<p>m.set(parameter);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>errorCode = ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>} catch (ArgsException e) {</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_INTEGER;</p>
<p>throw e;</p>
<p>private void setStringArg(ArgumentMarshaler m) throws ArgsException {</p>
<p>currentArgument++;</p>
<p>try {</p>
<p>m.set (args[currentArgument]);</p>
<p>} catch (ArrayIndexOutOfBoundsException e) {</p>
<p>errorCode = ErrorCode.MISSING_STRING;</p>
<p>throw new ArgsException();</p>
<p>private void setBooleanArg(ArgumentMarshaler m) {</p>
<p>try {</p>
<p>m.set(‚Äútrue‚Äù);</p>
<p>} catch (ArgsException e) {</p>
<p>public int cardinality() {</p>
<p>return argsFound.size();</p>
<p>public String usage() {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if (schema.length() &gt; 0)</p>
<p>return = ‚Äú-[‚Äù + schema + ‚Äú]‚Äù;</p>
<p>else</p>
<p>return ‚Äú‚Äù;</p>
<p>public String errorMessage() throws Exception {</p>
<p>switch (errorCode) {</p>
<p>case OK:</p>
<p>throw new Exception(‚ÄúTILT: Should not get here.‚Äù);</p>
<p>case UNEXPECTED_ARGUMENT:</p>
<p>return unexpectedArgumentMessage();</p>
<p>case MISSING_STRING:</p>
<p>return String.format(‚ÄúCould not find string parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_INTEGER:</p>
<p>return String.format(‚ÄúArgument -%c expects an integer but was ‚Äò%s‚Äô.‚Äù,</p>
<p>errorArgumentId, errorParameter);</p>
<p>case MISSING_INTEGER:</p>
<p>return String.format(‚ÄúCould not find integer parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>return ‚Äú‚Äù;</p>
<p>private String unexpectedArgumentMessage() {</p>
<p>StringBuffer message = new StringBuffer(‚ÄúArgument(s) -‚Äù);</p>
<p>for {char c : unexpectedArguments) {</p>
<p>message.append(c);</p>
<p>message.append(‚Äú unexpected.‚Äù);</p>
<p>return message.toString();</p>
<p>public boolean getBoolean(char arg) {</p>
<p>Args.ArgumentMarshaler am = marshalers.get(arg);</p>
<p>boolean b = false;</p>
<p>try {</p>
<p>b = am != null &amp;&amp; (Boolean) am.get();</p>
<p>} catch (ClassCastException e) {</p>
<p>b = false;</p>
<p>return b;</p>
<p>public String getString(char arg) {</p>
<p>Args.ArgumentMarshaler am = marshalers.get (arg);</p>
<p>try {</p>
<p>return am == null ? ‚Äú‚Äù : (String) am.get();</p>
<p>} catch (ClassCastException e) {</p>
<p>return ‚Äú‚Äù;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public int getInt(char arg) {</p>
<p>Args.ArgumentMarshaler am = marshalers.get(arg);</p>
<p>try {</p>
<p>return am == null ? 0 : (Integer) am.get();</p>
<p>} catch (Exception e) {</p>
<p>return 0;</p>
<p>public boolean has(char arg) {</p>
<p>return argsFound.contains(arg);</p>
<p>public boolean isValid() {</p>
<p>return valid;</p>
<p>private class ArgsException extends Exception {</p>
<p>private abstract class ArgumentMarshaler {</p>
<p>public abstract void set(String s) throws ArgsException;</p>
<p>public abstract Object get();</p>
<p>private class BooleanArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private boolean booleanValue = false;</p>
<p>public void set(String s) {</p>
<p>booleanValue = true;</p>
<p>public Object get() {</p>
<p>return booleanValue;</p>
<p>private class StringArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private String stringValue = ‚Äú‚Äù;</p>
<p>public void set(String s) {</p>
<p>stringValue = s;</p>
<p>public Object get() {</p>
<p>return stringValue;</p>
<p>private class IntegerArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private int intValue = 0;</p>
<p>public void set(String s) throws ArgsException {</p>
<p>try {</p>
<p>intValue = Integer.parseInt(s);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>} catch (NumberFormatException e) {</p>
<p>throw new ArgsException();</p>
<p>public Object get() {</p>
<p>return intValue;</p>
<p>Tras todo este esfuerzo, es un tanto decepcionante. La estructura ha</p>
<p>mejorado pero todav√≠a hay demasiadas variables en la parte superior; se</p>
<p>mantiene un terrible caso de tipos en setArgument ; y todas las funciones set</p>
<p>Sin mencionar el procesamiento de errores. Todav√≠a nos queda mucho trabajo</p>
<p>por hacer.</p>
<p>Mi intenci√≥n es eliminar el caso de tipos de setArgument [G23] y que</p>
<p>s√≥lo incluya una invocaci√≥n a ArgumentMarshaler.set . Para ello, debo</p>
<p>desplazar setIntArg setStringArg setBooleanArg a las correspondientes</p>
<p>variantes de ArgumentMarshaler . Pero hay un problema.</p>
<p>Si se fija atentamente en setIntArg , comprobar√° que usa dos variables de</p>
<p>instancia: args currentArg Para desplazar setIntArg hasta</p>
<p>BooleanArgumentMarshaler , tengo que pasar args currentArgs como</p>
<p>argumentos de funci√≥n. Muy desagradable [F1]. Resultar√≠a m√°s indicado</p>
<p>pasar un argumento y no dos. Afortunadamente, la soluci√≥n es sencilla.</p>
<p>Podemos convertir la matriz args en list y pasar Iterator a las funciones</p>
<p>set . Para el siguiente cambio necesit√© diez pasos, y superar todas las pruebas</p>
<p>tras cada uno. Pero s√≥lo mostraremos el resultado. Deber√≠a determinar la</p>
<p>mayor√≠a de estos peque√±os pasos.</p>
<p>public class Args {</p>
<p>private String schema;</p>
<p>private String[] args;</p>
<p>private boolean valid = true;</p>
<p>private Set&lt;Character&gt; unexpectedArguments = new TreeSet&lt;Character&gt;();</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; marshalers =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Set&lt;Character&gt; argsFound = new HashSet&lt;Character&gt;();</p>
<p>private Iterator&lt;String&gt; currentArgument;</p>
<p>private char errorArgumentId = ‚Äò\0‚Äô;</p>
<p>private String errorParameter = ‚ÄúTILT‚Äù;</p>
<p>private ErrorCode errorCode = ErrorCode.OK;</p>
<p>private List&lt;String&gt; argsList;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private enum ErrorCode {</p>
<p>OK, MISSING_STRING, MISSING_INTEGER, INVALID_INTEGER, UNEXPECTED_ARGUMENT</p>
<p>public Args(String schema. String[] args) throws ParseException {</p>
<p>this.schema = schema;</p>
<p>argsList = Arrays.asList(args);</p>
<p>valid = parse();</p>
<p>private boolean parse() throws ParseException {</p>
<p>if (schema.length() == 0 &amp;&amp; argsList.size() == 0)</p>
<p>return true;</p>
<p>parseSchema();</p>
<p>try {</p>
<p>parseArguments();</p>
<p>} catch (ArgsException e) {</p>
<p>return valid;</p>
<p>...</p>
<p>private boolean parseArguments() throws ArgsException {</p>
<p>for (currentArgument = argsList.iterator(); currentArgument. hasNext() ;) {</p>
<p>String arg = currentArgument. next()</p>
<p>parseArgument(arg);</p>
<p>return true;</p>
<p>...</p>
<p>private void setIntArg(ArgumentMarshaler m) throws ArgsException {</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = currentArgument. next()</p>
<p>m.set(parameter);</p>
<p>} catch ( NoSuchElementException e) {</p>
<p>errorCode = ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>} catch (ArgsException e) {</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_INTEGER;</p>
<p>throw e;</p>
<p>private void setStringArg(ArgumentMarshaler m) throws ArgsException {</p>
<p>try {</p>
<p>m.set (currentArgument. next() );</p>
<p>} catch ( NoSuchElementException e) {</p>
<p>errorCode = ErrorCode.MISSING_STRING;</p>
<p>throw new ArgsException();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Son peque√±os cambios que conservan el funcionamiento de las pruebas.</p>
<p>Ahora podemos empezar a desplazar las funciones set a las correspondientes</p>
<p>variantes. Primero, debemos realizar el siguiente cambio en setArgument</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (m == null)</p>
<p>return false;</p>
<p>try {</p>
<p>if (m instanceof BooleanArgumentMarshaler)</p>
<p>setBooleanArg(m);</p>
<p>else if (m instanceof StringArgumentMarshaler)</p>
<p>setStringArg(m);</p>
<p>else if (m instanceof IntegerArgumentMarshaler)</p>
<p>setIntArg(m);</p>
<p>else</p>
<p>return false;</p>
<p>} catch (ArgsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>throw e;</p>
<p>return true;</p>
<p>Es un cambio importante ya que queremos eliminar totalmente la cadena</p>
<p>if-else . Por tanto, debemos excluir la condici√≥n de error.</p>
<p>Ya podemos empezar desplazar las funciones set La funci√≥n</p>
<p>setBooleanArg es trivial, de modo que la prepararemos en primer lugar. El</p>
<p>objetivo es cambiar la funci√≥n setBooleanArg para redirigirla</p>
<p>BooleanArgumentMarshaler</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (m == null)</p>
<p>return false;</p>
<p>try {</p>
<p>if (m instanceof BooleanArgumentMarshaler)</p>
<p>setBooleanArg(m, currentArgument );</p>
<p>else if (m instanceof StringArgumentMarshaler)</p>
<p>setStringArg(m);</p>
<p>else if (m instanceof IntegerArgumentMarshaler)</p>
<p>setIntArg(m);</p>
<p>} catch (ArgsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>throw e;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return true;</p>
<p>---</p>
<p>private void setBooleanArg (ArgumentMarshaler m,</p>
<p>Iterator&lt;String&gt; currentArgument)</p>
<p>throws ArgsException {</p>
<p>try {</p>
<p>m.set(‚Äútrue‚Äù);</p>
<p>catch (ArgsException e) {</p>
<p>¬øNo acabamos de incluir el procesamiento de excepciones? A√±adir</p>
<p>elementos para despu√©s excluirlos es habitual en los procesos de</p>
<p>refactorizaci√≥n. Los pasos reducidos y la necesidad de que las pruebas sigan</p>
<p>siendo correctas implican que los elementos cambien de posici√≥n. La</p>
<p>refactorizaci√≥n es como resolver el cubo de Rubik. Se necesitan muchos</p>
<p>pasos peque√±os para lograr un objetivo mayor. Cada paso habilita el</p>
<p>siguiente.</p>
<p>Se preguntar√° por qu√© pasamos iterator si setBooleanArg no lo</p>
<p>necesita. Pues porque setIntArg setStringArg s√≠. Y como el objetivo es</p>
<p>implementar las tres funciones trav√©s de un m√©todo abstracto en</p>
<p>ArgumentMarshaller , es necesario pasarlo a setBooleanArg</p>
<p>Ahora setBooleanArg no sirve de nada. Si hubiera una funci√≥n set en</p>
<p>ArgumentMarshaler , podr√≠amos invocarla directamente. Es el momento de</p>
<p>crear dicha funci√≥n. El primer paso consiste en a√±adir el nuevo m√©todo</p>
<p>abstracto a ArgumentMarshaler</p>
<p>private abstract class ArgumentMarshaler {</p>
<p>public abstract void set(Iterator&lt;String&gt; currentArgument)</p>
<p>throws ArgsException;</p>
<p>public abstract void set (String s) throws ArgsException;</p>
<p>public abstract Object get();</p>
<p>Evidentemente, esto afecta todas las variantes, de modo que</p>
<p>implementamos el nuevo m√©todo en cada una.</p>
<p>private class BooleanArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private boolean booleanValue = false;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>booleanValue = true;</p>
<p>public void set(String s) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>booleanValue = true;</p>
<p>public Object get() {</p>
<p>return booleanValue;</p>
<p>private class StringArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private String stringValue = ‚Äú‚Äù;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>public void set(String s) {</p>
<p>stringValue = s;</p>
<p>public Object get() {</p>
<p>return stringValue;</p>
<p>private class IntegerArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private int intValue = 0;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>public void set(String s) throws ArgsException {</p>
<p>try {</p>
<p>intValue = Integer.parseInt(s);</p>
<p>} catch (NumberFormatException e) {</p>
<p>throw new ArgsException();</p>
<p>public Object get() {</p>
<p>return intValue;</p>
<p>Y ahora ya podemos eliminar setBooleanArg</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (m == null)</p>
<p>return false;</p>
<p>try {</p>
<p>if (m instanceof BooleanArgumentMarshaler)</p>
<p>m.set (currentArgument);</p>
<p>else if (m instanceof StringArgumentMarshaler)</p>
<p>setStringArg(m);</p>
<p>else if (m instanceof IntegerArgumentMarshaler)</p>
<p>setIntArg(m);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>} catch (ArgsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>throw e;</p>
<p>return true;</p>
<p>Las pruebas siguen siendo satisfactorias y la funci√≥n set se implementa</p>
<p>en Boolean ArgumentMarshaler Podemos repetir la operaci√≥n con las</p>
<p>cadenas y los enteros.</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (m == null)</p>
<p>return false;</p>
<p>try {</p>
<p>if (m instanceof BooleanArgumentMarshaler)</p>
<p>m.set(currentArgument);</p>
<p>else if (m instanceof StringArgumentMarshaler)</p>
<p>m.set(currentArgument);</p>
<p>else if (m instanceof IntegerArgumentMarshaler)</p>
<p>m.set(currentArgument);</p>
<p>} catch (ArgsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>throw e;</p>
<p>return true;</p>
<p>---</p>
<p>private class StringArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private String stringValue = ‚Äú‚Äù;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>try {</p>
<p>stringValue = currentArgument.next();</p>
<p>} catch (NoSuchElementException e) {</p>
<p>errorCode = ErrorCode.MISSING_STRING;</p>
<p>throw new ArgsException();</p>
<p>public void set(String s){</p>
<p>public Object get() {</p>
<p>return stringValue;</p>
<p>private class IntegerArgumentMarshaler extends ArgumentMarshaler {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private int intValue = 0;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = currentArgument.next();</p>
<p>set(parameter);</p>
<p>} catch (NoSuchElementException e) {</p>
<p>errorCode = ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>} catch (ArgsException e) {</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_INTEGER;</p>
<p>throw e;</p>
<p>public void set(String s) throws ArgsException {</p>
<p>try {</p>
<p>intValue = Integer.parseInt(s);</p>
<p>} catch (NumberFormatException e) {</p>
<p>throw new ArgsException();</p>
<p>public Object get() {</p>
<p>return intValue;</p>
<p>Y el golpe de gracia: se elimina el caso de tipos.</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (m == null)</p>
<p>return false;</p>
<p>try {</p>
<p>m.set(currentArgument);</p>
<p>return true;</p>
<p>} catch (ArgsException e) {</p>
<p>valid = false;</p>
<p>errorArgumentId = argChar;</p>
<p>throw e;</p>
<p>Ya podemos deshacernos de las funciones de</p>
<p>IntegerArgumentMarshaler y limpiar el resto.</p>
<p>private class IntegerArgumentMarshaler extends ArgumentMarshaler {</p>
<p>private int intValue = 0</p>
<p>public void set (Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>String parameter = null;</p>
<p>try {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>parameter = currentArgument.next();</p>
<p>intValue = Integer.parseInt (parameter);</p>
<p>} catch (NoSuchElementException e) {</p>
<p>errorCode = ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>} catch ( NumberFormatException e) {</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_INTEGER;</p>
<p>throw new ArgsException();</p>
<p>public Object get() {</p>
<p>return intValue;</p>
<p>Tambi√©n podemos convertir ArgumentMarshaler en una interfaz.</p>
<p>private interface ArgumentMarshaler {</p>
<p>void set (Iterator&lt;String&gt; currentArgument) throws ArgsException;</p>
<p>Object get();</p>
<p>Veamos ahora lo sencillo que resulta a√±adir un nuevo tipo de argumento a</p>
<p>la estructura. Apenas necesitaremos cambios y los que apliquemos tendr√°n</p>
<p>que ser aislados. En primer lugar, a√±adimos un nuevo caso de prueba para</p>
<p>comprobar que el argumento double funciona correctamente:</p>
<p>public void testSimpleDoublePresent() throws Exception {</p>
<p>Args args = new Args(‚Äúx##‚Äù, new String[] {‚Äú-x‚Äù,‚Äú42.3‚Äù});</p>
<p>assertTrue(args.isValid());</p>
<p>assertEquals(1, args.cardinality());</p>
<p>assertTrue(args.has(‚Äòx‚Äô));</p>
<p>assertEquals(42.3, args.getDouble(‚Äòx‚Äô), .001);</p>
<p>Limpiamos el c√≥digo de an√°lisis de esquemas y a√±adimos la detecci√≥n ##</p>
<p>para el tipo de argumento double</p>
<p>private void parseSchemaElement(String element) throws ParseException {</p>
<p>char elementId = element.charAt(0);</p>
<p>String elementTail = element.substring(1);</p>
<p>validateSchemaElementId(elementId);</p>
<p>if (elementTail. length() == 0</p>
<p>marshalers.put(elementId, new BooleanArgumentMarshaler());</p>
<p>else if (elementTail. equals(‚Äú*‚Äù)</p>
<p>marshalers.put(elementId, new StringArgumentMarshaler());</p>
<p>else if (elementTail. equals(‚Äú#‚Äù)</p>
<p>marshalers.put(elementId, new IntegerArgumentMarshaler());</p>
<p>else if (elementTail.equals(‚Äú##‚Äù))</p>
<p>marshalers.put(elementId, new DoubleArgumentMarshaler());</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>else</p>
<p>throw new ParseException(String.format(</p>
<p>‚ÄúArgument: %c has invalid format: %s.‚Äù, elementId, elementTail), 0);</p>
<p>Seguidamente, creamos la clase DoubleArgumentMarshaler</p>
<p>private class DoubleArgumentMarshaler implements ArgumentMarshaler {</p>
<p>private double doubleValue = 0;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = currentArgument.next();</p>
<p>doubleValue = Double.parseDouble(parameter);</p>
<p>} catch (NoSuchElementException e) {</p>
<p>errorCode = ErrorCode.MISSING_DOUBLE;</p>
<p>throw new ArgsException();</p>
<p>} catch (NumberFormatException e) {</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ErrorCode.INVALID_DOUBLE;</p>
<p>throw new ArgsException();</p>
<p>public Object get() {</p>
<p>return doubleValue;</p>
<p>Esto nos obliga a a√±adir un nuevo c√≥digo de error ( ErrorCode ).</p>
<p>private enum ErrorCode {</p>
<p>OK, MISSING_STRING, MISSING_INTEGER, INVALID_INTEGER, UNEXPECTED_ARGUMENT,</p>
<p>MISSING_DOUBLE, INVALID_DOUBLE</p>
<p>Y necesitamos una funci√≥n getDouble</p>
<p>public double getDouble(char arg) {</p>
<p>Args.ArgumentMarshaler am = marshalers.get(arg);</p>
<p>try {</p>
<p>return am = null ? 0 : (Double) am.get();</p>
<p>} catch (Exception e) {</p>
<p>return 0.0;</p>
<p>Y todas las pruebas son correctas. Ha sido sencillo. A continuaci√≥n</p>
<p>comprobamos que el procesamiento de errores funciona correctamente. El</p>
<p>siguiente caso de prueba comprueba que se declare un error si se proporciona</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>una cadena que no se puede analizar a un argumento ##.</p>
<p>public void testInvalidDouble() throws Exception {</p>
<p>Args args = new Args(‚Äúx##‚Äù, new String[] {‚Äú-x‚Äù, ‚ÄúForty two‚Äù});</p>
<p>assertFalse(args.isValid());</p>
<p>assertEquals(0, args.cardinality());</p>
<p>assertFalse(args.has(‚Äòx‚Äô));</p>
<p>assertEquals(0, args.getInt(‚Äòx‚Äô));</p>
<p>assertEquals(‚ÄúArgument -x expects a double but was ‚ÄòForty two‚Äô.‚Äù,</p>
<p>args.errorMessage());</p>
<p>---</p>
<p>public String errorMessage() throws Exception {</p>
<p>switch (errorCode) {</p>
<p>case OK:</p>
<p>throw new Exception(‚ÄúTILT: Should not get here.‚Äù);</p>
<p>case UNEXPECTED_ARGUMENT:</p>
<p>return unexpectedArgumentMessage();</p>
<p>case MISSING_STRING:</p>
<p>return String.format(‚ÄúCould not find string parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_INTEGER:</p>
<p>return String.format(‚ÄúArgument -%c expects an integer but was ‚Äò%s‚Äô.‚Äù,</p>
<p>errorArgumentId, errorParameter);</p>
<p>case MISSING_INTEGER:</p>
<p>return String.format(‚ÄúCould not find integer parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_DOUBLE:</p>
<p>return String.format(‚ÄúArgument -%c expects a double but was ‚Äò%s‚Äô.‚Äù,</p>
<p>errorArgumentId, errorParameter);</p>
<p>case MISSING_DOUBLE:</p>
<p>return String.format(‚ÄúCould not find double parameter for -%c‚Äù,</p>
<p>errorArgumentId);</p>
<p>return ‚Äú‚Äù;</p>
<p>Y las pruebas son satisfactorias. La siguiente prueba garantiza que se</p>
<p>detecte correctamente la ausencia de un argumento double</p>
<p>public void testMissingDouble() throws Exception {</p>
<p>Args args = new Args(‚Äúx##‚Äù, new String[]{"-x"});</p>
<p>assertFalse (args.isValid());</p>
<p>assertEquals(0, args.cardinality());</p>
<p>assertFalse(args.has(‚Äòx‚Äô));</p>
<p>assertEquals(0.0, args.getDouble(‚Äòx‚Äô), 0.01);</p>
<p>assertEquals(‚ÄúCould not find double parameter for -x.‚Äù,</p>
<p>args.errorMessage());</p>
<p>Es correcto. La incluimos para que el ejemplo resulte m√°s completo.</p>
<p>El c√≥digo de excepciones no es atractivo y no pertenece realmente a la</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>clase Args . Tambi√©n generamos ParseException , que no nos pertenece. Por</p>
<p>ello, combinamos todas las excepciones en una √∫nica clase ArgsException</p>
<p>la incluimos en su propio m√≥dulo.</p>
<p>public class ArgsException extends Exception {</p>
<p>private char errorArgumentId = ‚Äò\0‚Äô;</p>
<p>private String errorParameter = ‚ÄúTILT‚Äù;</p>
<p>private ErrorCode errorCode = ErrorCode.OK;</p>
<p>public ArgsException() {}</p>
<p>public ArgsException(String message) { super(message); }</p>
<p>public enum ErrorCode {</p>
<p>OK, MISSING_STRING, MISSING_INTEGER, INVALID_INTEGER, UNEXPECTED_ARGUMENT,</p>
<p>MISSING_DOUBLE, INVALID_DOUBLE }</p>
<p>...</p>
<p>public class Args {</p>
<p>...</p>
<p>private char errorArgumentId = ‚Äò\0‚Äô;</p>
<p>private String errorParameter = ‚ÄúTILT‚Äù;</p>
<p>private ArgsException .ErrorCode errorCode = ArgsException .ErrorCode.OK;</p>
<p>private List&lt;String&gt; argsList;</p>
<p>public Args(String schema, String[] args) throws ArgsException</p>
<p>this.schema = schema;</p>
<p>argsList = Arrays.asList(args);</p>
<p>valid = parse();</p>
<p>private boolean parse() throws ArgsException {</p>
<p>if (schema.length() == 0 &amp;&amp; argsList.size() == 0)</p>
<p>return true;</p>
<p>parseSchema();</p>
<p>try {</p>
<p>parseArguments();</p>
<p>} catch ( ArgsException e) {</p>
<p>return valid;</p>
<p>private boolean parseSchema() throws ArgsException</p>
<p>...</p>
<p>private void parseSchemaElement(String element) throws ArgsException</p>
<p>...</p>
<p>else</p>
<p>throw new ArgsException</p>
<p>String.format(‚ÄúArgument: %c has invalid format: %s.‚Äù,</p>
<p>elementId, elementTail));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void validateSchemaElementId(char elementId) throws ArgsException</p>
<p>if (!Character.isLetter(elementId)) {</p>
<p>throw new ArgsException</p>
<p>‚ÄúBad character:‚Äù + elementId + ‚Äúin Args format: ‚Äù + schema);</p>
<p>...</p>
<p>private void parseElement(char argChar) throws ArgsException</p>
<p>if (setArgument(argChar))</p>
<p>argsFound.add(argChar);</p>
<p>else {</p>
<p>unexpectedArguments.add(argChar);</p>
<p>errorCode = ArgsException .ErrorCode.UNEXPECTED_ARGUMENT;</p>
<p>valid = false;</p>
<p>...</p>
<p>private class StringArgumentMarshaler implements ArgumentMarshaler {</p>
<p>private String stringValue = ‚Äú‚Äù;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>try {</p>
<p>stringValue = currentArgument.next();</p>
<p>} catch (NoSuchElementException e) {</p>
<p>errorCode = ArgsException .ErrorCode.MISSING_STRING;</p>
<p>throw new ArgsException();</p>
<p>public Object get() {</p>
<p>return stringValue;</p>
<p>private class IntegerArgumentMarshaler implements ArgumentMarshaler {</p>
<p>private int intValue = 0;</p>
<p>public void set (Iterator&lt;String&gt; currentArgument) throws ArgsException</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = currentArgument.next();</p>
<p>intValue = Integer.parseInt(parameter);</p>
<p>} catch (NoSuchElementException e) {</p>
<p>errorCode = ArgsException.ErrorCode.MISSING_INTEGER;</p>
<p>throw new ArgsException ();</p>
<p>} catch (NumberFormatException e) {</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ArgsException .ErrorCode.INVALID_INTEGER;</p>
<p>throw new ArgsException ();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public Object get() {</p>
<p>return intValue;</p>
<p>private class DoubleArgumentMarshaler implements ArgumentMarshaler {</p>
<p>private double doubleValue = 0;</p>
<p>public void set(Iterator&lt;String&gt; currentArgument) throws ArgsException {</p>
<p>String parameter = null;</p>
<p>try {</p>
<p>parameter = currentArgument.next();</p>
<p>doubleValue = Double.parseDouble(parameter);</p>
<p>} catch (NoSuchElementException e) {</p>
<p>errorCode = ArgsException .ErrorCode.MISSING_DOUBLE;</p>
<p>throw new ArgsException();</p>
<p>} catch (NumberFormatException e) {</p>
<p>errorParameter = parameter;</p>
<p>errorCode = ArgsException .ErrorCode.INVALID_DOUBLE;</p>
<p>throw new ArgsException);</p>
<p>public Object get() {</p>
<p>return doubleValue;</p>
<p>Muy bien. Ahora, Args solamente genera ArgsException . Al desplazar</p>
<p>ArgsException a un m√≥dulo propio, podemos a√±adir a dicho m√≥dulo gran</p>
<p>parte del c√≥digo de error y extraerlo del m√≥dulo Args . Es una posici√≥n natural</p>
<p>y evidente para incluir todo el c√≥digo y nos permitir√° limpiar posteriormente</p>
<p>el m√≥dulo Args</p>
<p>Ya hemos separado el c√≥digo de excepciones y de error del m√≥dulo Args</p>
<p>(v√©anse los listados del 14-13 al 14-16). Para ello realizamos una serie de 30</p>
<p>pasos m√≠nimos y las pruebas fueron satisfactorias entre todos ellos.</p>
<p>Listado 14-13</p>
<p>ArgsTest.java.</p>
<p>package com.objectmentor.utilities.args;</p>
<p>import junit.framework.TestCase;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public class ArgsTest extends TestCase {</p>
<p>public void testCreateWithNoSchemaOrArguments() throws Exception {</p>
<p>Args args = new Args(‚Äú‚Äù, new String[0]);</p>
<p>assertEquals(0, args.cardinality());</p>
<p>public void testWithNoSchemaButWithOneArgument() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äú‚Äù, new String[]{‚Äú-x‚Äù});</p>
<p>fail();</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT,</p>
<p>e.getErrorCode());</p>
<p>assertEquals(‚Äòx‚Äô, e.getErrorArgumentId());</p>
<p>public void testWithNoSchemaButWithMultipleArguments() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äú‚Äù, new String[]{‚Äú-x‚Äù, ‚Äú-y‚Äù});</p>
<p>fail();</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT,</p>
<p>e.getErrorCode());</p>
<p>assertEquals(‚Äòx‚Äô, e.getErrorArgumentId());</p>
<p>public void testNonLetterSchema() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äú*‚Äù, new String[]{});</p>
<p>fail(‚ÄúArgs constructor should have thrown exception‚Äù);</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.INVALID_ARGUMENT_NAME,</p>
<p>e.getErrorCode());</p>
<p>assertEquals(‚Äò*‚Äô, e.getErrorArgumentId());</p>
<p>public void testInvalidArgumentFormat() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äúf~‚Äù, new String[]{});</p>
<p>fail(‚ÄúArgs constructor should have throws exception‚Äù);</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.INVALID_FORMAT, e.getErrorCode());</p>
<p>assertEquals(‚Äòf‚Äô, e.getErrorArgumentId());</p>
<p>public void testSimpleBooleanPresent() throws Exception {</p>
<p>Args args = new Args(‚Äúx‚Äù, new String []{‚Äú-x‚Äù});</p>
<p>assertEquals(1, args.cardinality());</p>
<p>assertEquals(true, args.getBoolean(‚Äòx‚Äô));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public void testSimpleStringPresent() throws Exception {</p>
<p>Args args = new Args(‚Äúx*‚Äù, new String[]{‚Äú-x‚Äù, ‚Äúparam‚Äù});</p>
<p>assertEquals(1, args.cardinality());</p>
<p>assertTrue(args.has(‚Äòx‚Äô));</p>
<p>assertEquals(‚Äúparam‚Äù, args.getString(‚Äòx‚Äô));</p>
<p>public void testMissingStringArgument() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äúx*‚Äù, new String[]{"-x"});</p>
<p>fail();</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.MISSING_STRING, e.getErrorCode());</p>
<p>assertEquals(‚Äòx‚Äô, e.getErrorArgumentId());</p>
<p>public void testSpacesInFormat() throws Exception {</p>
<p>Args args = new Args(‚Äúx, y‚Äù, new String[]{‚Äú-xy‚Äù});</p>
<p>assertEquals(2, args.cardinality());</p>
<p>assertTrue(args.has(‚Äòx‚Äô));</p>
<p>assertTrue(args.has(‚Äòy‚Äô));</p>
<p>public void testSimpleIntPresent() throws Exception {</p>
<p>Args args = new Args(‚Äúx#‚Äù, new String[]{‚Äú-x‚Äù, ‚Äú42‚Äù});</p>
<p>assertEquals(1, args.cardinality());</p>
<p>assertTrue(args.has(‚Äòx‚Äô));</p>
<p>assertEquals(42, args.getInt(‚Äòx‚Äô));</p>
<p>public void testInvalidInteger() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äúx#‚Äù, new String[] {‚Äú-x‚Äù, ‚ÄúForty two‚Äù});</p>
<p>fail();</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.INVALID_INTEGER,</p>
<p>e.getErrorCode());</p>
<p>assertEquals(‚Äòx‚Äô, e.getErrorArgumentId());</p>
<p>assertEquals(‚ÄúForty two‚Äù, e.getErrorParameter());</p>
<p>public void testMissingInteger() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äúx#‚Äù, new String[]{‚Äú-x‚Äù});</p>
<p>fail();</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.MISSING_INTEGER,</p>
<p>e.getErrorCode());</p>
<p>assertEquals(‚Äòx‚Äô, e.getErrorArgumentId());</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public void testSimpleDoublePresent() throws Exception {</p>
<p>Args args = new Args(‚Äúx##‚Äù, new String[](‚Äú-x‚Äù, ‚Äú42.3‚Äù});</p>
<p>assertEquals(1, args.cardinality());</p>
<p>assertTrue(args.has(‚Äòx‚Äô));</p>
<p>assertEquals(42.3, args.getDouble(‚Äòx‚Äô), .001);</p>
<p>public void testInvalidDouble() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äúx##‚Äù, new String []{‚Äú-x‚Äù, ‚ÄúForty two‚Äù});</p>
<p>fail();</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.INVALID_DOUBLE, e.getErrorCode());</p>
<p>assertEquals(‚Äòx‚Äô, e.getErrorArgumentId());</p>
<p>assertEquals(‚ÄúForty two‚Äù, e.getErrorParameter());</p>
<p>public void testMissingDouble() throws Exception {</p>
<p>try {</p>
<p>new Args(‚Äúx##‚Äù, new String[]{‚Äú-x‚Äù});</p>
<p>fail();</p>
<p>} catch (ArgsException e) {</p>
<p>assertEquals(ArgsException.ErrorCode.MISSING_DOUBLE, e.getErrorCode());</p>
<p>assertEquals(‚Äòx‚Äô, e.getErrorArgumentId());</p>
<p>Listado 14-14</p>
<p>ArgsExceptionTest.java.</p>
<p>public class ArgsExceptionTest extends TestCase {</p>
<p>public void testUnexpectedMessage() throws Exception {</p>
<p>ArgsException e =</p>
<p>new ArgsException(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT,</p>
<p>‚Äòx‚Äô, null);</p>
<p>assertEquals(‚ÄúArgument -x unexpected.‚Äù, e.errorMessage());</p>
<p>public void testMissingStringMessage() throws Exception {</p>
<p>ArgsException new</p>
<p>ArgsException(ArgsException.ErrorCode.MISSING_STRING,</p>
<p>‚Äòx‚Äô, null);</p>
<p>assertEquals(‚ÄúCould not find string parameter for ‚Äìx.‚Äù,</p>
<p>e.errorMessage());</p>
<p>public void testInvalidIntegerMessage() throws Exception {</p>
<p>ArgsException e =</p>
<p>new ArgsException(ArgsException.ErrorCode.INVALID_INTEGER,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>‚Äòx‚Äô, ‚ÄúForty two‚Äù);</p>
<p>assertEquals(‚ÄúArgument ‚Äìx expects an integer but was ‚ÄòForty two‚Äô.‚Äù,</p>
<p>e.errorMessage());</p>
<p>public void testMissingIntegerMessage() throws Exception {</p>
<p>ArgsException e =</p>
<p>new ArgsException(ArgsException.ErrorCode.MISSING_INTEGER, ‚Äòx‚Äô, null);</p>
<p>assertEquals(‚ÄúCould not find integer parameter for -x.‚Äù,</p>
<p>e.errorMessage());</p>
<p>public void testInvalidDoubleMessage() throws Exception {</p>
<p>ArgsException new</p>
<p>ArgsException(ArgsException.ErrorCode.INVALID_DOUBLE,</p>
<p>‚Äòx‚Äô, ‚ÄúForty two‚Äù);</p>
<p>assertEquals(‚ÄúArgument -x expects a double but was ‚ÄòForty two‚Äô.‚Äù,</p>
<p>e.errorMessage());</p>
<p>public void testMissingDoubleMessage() throws Exception {</p>
<p>ArgsException new</p>
<p>ArgsException(ArgsException.ErrorCode.MISSING_DOUBLE,</p>
<p>‚Äòx‚Äô, null);</p>
<p>assertEquals(‚ÄúCould not find double parameter for -x.‚Äù,</p>
<p>e.errorMessage());</p>
<p>Listado 14-15</p>
<p>ArgsException.java.</p>
<p>public class ArgsException extends Exception {</p>
<p>private char errorArgumentId = ‚Äò\0‚Äô;</p>
<p>private String errorParameter = ‚ÄúTILT‚Äù;</p>
<p>private ErrorCode errorCode = ErrorCode.OK;</p>
<p>public ArgsException() {}</p>
<p>public ArgsException(String message) {super(message);}</p>
<p>public ArgsException(ErrorCode errorCode) {</p>
<p>this.errorCode = errorCode;</p>
<p>public ArgsException(ErrorCode errorCode, String errorParameter) {</p>
<p>this.errorCode = errorCode;</p>
<p>this.errorParameter = errorParameter;</p>
<p>public ArgsException(ErrorCode errorCode, char errorArgumentId,</p>
<p>String errorParameter) {</p>
<p>this.errorCode = errorCode;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>this.errorParameter = errorParameter;</p>
<p>this.errorArgumentId = errorArgumentId;</p>
<p>public char getErrorArgumentId() {</p>
<p>return errorArgumentId;</p>
<p>public void setErrorArgumentId(char errorArgumentId) {</p>
<p>this.errorArgumentId = errorArgumentId;</p>
<p>public String getErrorParameter() {</p>
<p>return errorParameter;</p>
<p>public void setErrorParameter(String errorParameter) {</p>
<p>this.errorParameter = errorParameter;</p>
<p>public ErrorCode getErrorCode() {</p>
<p>return errorCode;</p>
<p>public void setErrorCode(ErrorCode errorCode) {</p>
<p>this.errorCode = errorCode;</p>
<p>public String errorMessage() throws Exception {</p>
<p>switch (errorCode) {</p>
<p>case OK:</p>
<p>throw new Exception(‚ÄúTILT: Should not get here.‚Äù);</p>
<p>case UNEXPECTED_ARGUMENT:</p>
<p>return String.format(‚ÄúArgument -%c unexpected.‚Äù, errorArgumentId);</p>
<p>case MISSING_STRING:</p>
<p>return String.format(‚ÄúCould not find string parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_INTEGER:</p>
<p>return String.format(‚ÄúArgument -%c expects an integer but was ‚Äò%s‚Äô.‚Äù,</p>
<p>errorArgumentId, errorParameter);</p>
<p>case MISSING_INTEGER:</p>
<p>return String.format(‚ÄúCould not find integer parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>case INVALID_DOUBLE:</p>
<p>return String.format(‚ÄúArgument -%c expects a double but was ‚Äò%s‚Äô.‚Äù,</p>
<p>errorArgumentId, errorParameter);</p>
<p>case MISSING_DOUBLE:</p>
<p>return String.format(‚ÄúCould not find double parameter for -%c.‚Äù,</p>
<p>errorArgumentId);</p>
<p>return ‚Äú‚Äù;</p>
<p>public enum ErrorCode {</p>
<p>OK, INVALID_FORMAT, UNEXPECTED_ARGUMENT, INVALID_ARGUMENT_NAME,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>MISSING_STRING,</p>
<p>MISSING_INTEGER, INVALID_INTEGER,</p>
<p>MISSING_DOUBLE, INVALID_DOUBLE}</p>
<p>Listado 14-16</p>
<p>Args.java.</p>
<p>public class Args {</p>
<p>private String schema;</p>
<p>private Map&lt;Character, ArgumentMarshaler&gt; marshalers =</p>
<p>new HashMap&lt;Character, ArgumentMarshaler&gt;();</p>
<p>private Set&lt;Character&gt; argsFound = new HashSet&lt;Character&gt;();</p>
<p>private Iterator&lt;String&gt; currentArgument;</p>
<p>private List&lt;String&gt; argsList;</p>
<p>public Args(String schema, String[] args) throws ArgsException {</p>
<p>this.schema = schema;</p>
<p>argsList = Arrays.asList(args);</p>
<p>parse();</p>
<p>private void parse() throws ArgsException {</p>
<p>parseSchema();</p>
<p>parseArguments();</p>
<p>private boolean parseSchema() throws ArgsException {</p>
<p>for (String element : schema.split(‚Äú,‚Äù)) {</p>
<p>if (element.length() &gt; 0) {</p>
<p>parseSchemaElement(element.trim());</p>
<p>return true;</p>
<p>private void parseSchemaElement(String element) throws ArgsException {</p>
<p>char elementId = element.charAt(0);</p>
<p>String elementTail = element.substring(1);</p>
<p>validateSchemaElementId(elementId);</p>
<p>if (elementTail.length() == 0)</p>
<p>marshalers.put(elementId, new BooleanArgumentMarshaler());</p>
<p>else if (elementTail.equals(‚Äú*‚Äù))</p>
<p>marshalers.put(elementId, new StringArgumentMarshaler());</p>
<p>else if (elementTail.equals(‚Äú#‚Äù))</p>
<p>marshalers.put(elementId, new IntegerArgumentMarshaler());</p>
<p>else if (elementTail.equals(‚Äú##‚Äù))</p>
<p>marshalers.put(elementId, new DoubleArgumentMarshaler());</p>
<p>else</p>
<p>throw new ArgsException(ArgsException.ErrorCode.INVALID_FORMAT,</p>
<p>elementId, elementTail);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void validateSchemaElementId(char elementId) throws ArgsException</p>
<p>if (!Character.isLetter(elementId)) {</p>
<p>throw new ArgsException(ArgsException.ErrorCode.INVALID_ARGUMENT_NAME,</p>
<p>elementId, null);</p>
<p>private void parseArguments() throws ArgsException {</p>
<p>for (currentArgument = argsList.iterator(); currentArgument.hasNext();) {</p>
<p>String arg = currentArgument.next();</p>
<p>parseArgument(arg);</p>
<p>private void parseArgument(String arg) throws ArgsException {</p>
<p>if (arg.startsWith(‚Äú-‚Äù))</p>
<p>parseElements(arg);</p>
<p>private void parseElements(String arg) throws ArgsException {</p>
<p>for (int i = 1; i &lt; arg.length(); i++)</p>
<p>parseElement(arg.charAt(i));</p>
<p>private void parseElement(char argChar) throws ArgsException {</p>
<p>if (setArgument(argChar))</p>
<p>argsFound.add(argChar);</p>
<p>else {</p>
<p>throw new ArgsException(ArgsException.ErrorCode.UNEXPECTED_ARGUMENT,</p>
<p>argChar, null);</p>
<p>private boolean setArgument(char argChar) throws ArgsException {</p>
<p>ArgumentMarshaler m = marshalers.get(argChar);</p>
<p>if (m == null)</p>
<p>return false;</p>
<p>try {</p>
<p>m.set(currentArgument);</p>
<p>return true;</p>
<p>} catch (ArgsException e) {</p>
<p>e.setErrorArgumentId(argChar);</p>
<p>throw e;</p>
<p>public int cardinality() {</p>
<p>return argsFound.size();</p>
<p>public String usage() {</p>
<p>if (schema.length() &gt; 0)</p>
<p>return "-[" + schema + ‚Äú]‚Äù;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>else</p>
<p>return ‚Äú‚Äù;</p>
<p>public boolean getBoolean(char arg) {</p>
<p>ArgumentMarshaler am = marshalers.get(arg);</p>
<p>boolean b = false;</p>
<p>try {</p>
<p>b = am != null &amp;&amp; (Boolean) am.get();</p>
<p>} catch (ClassCastException e) {</p>
<p>b = false;</p>
<p>return b;</p>
<p>public String getString(char arg) {</p>
<p>ArgumentMarshaler am = marshalers.get(arg);</p>
<p>try {</p>
<p>return am == null ? ‚Äú‚Äù : (String) am.get();</p>
<p>} catch (ClassCastException e) {</p>
<p>return ‚Äú‚Äù;</p>
<p>public int getInt(char arg) {</p>
<p>ArgumentMarshaler am = marshalers.get(arg);</p>
<p>try {</p>
<p>return am == null ? 0 : (Integer) am.get();</p>
<p>} catch (Exception e) {</p>
<p>return 0;</p>
<p>public double getDouble(char arg) {</p>
<p>ArgumentMarshaler am = marshalers.get(arg);</p>
<p>try {</p>
<p>return am == null ? 0 : (Double) am.get();</p>
<p>} catch (Exception e) {</p>
<p>return 0.0;</p>
<p>public boolean has(char arg) {</p>
<p>return argsFound.contains(arg);</p>
<p>La mayor√≠a de los cambios realizados en la clase Args han sido</p>
<p>eliminaciones. Gran parte del c√≥digo se extrajo de Args y se a√±adi√≥ a</p>
<p>ArgsException Perfecto. Tambi√©n cambiamos todos los elementos</p>
<p>ArgumentMarshaller a sus propios archivos. Mejor todav√≠a.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>El dise√±o de software correcto se basa gran parte en las particiones, en</p>
<p>crear zonas adecuadas para incluir distintos tipos de c√≥digo. Esta separaci√≥n</p>
<p>hace que el c√≥digo sea m√°s f√°cil de entender y mantener.</p>
<p>Especialmente interesante es el m√©todo errorMessage de ArgsException</p>
<p>Incumple claramente el SRP al incluir el formato de mensajes de error en</p>
<p>Args Args debe centrarse en el procesamiento de argumentos, no en el</p>
<p>formato de los mensajes de error. Sin embargo, ¬ørealmente tiene sentido</p>
<p>incluir el c√≥digo de formato de mensajes de error en ArgsException</p>
<p>Francamente es un compromiso. Los usuarios que no deseen los mensajes</p>
<p>de error proporcionados por ArgsException tendr√°n que crear los suyos</p>
<p>propios, pero la utilidad de mensajes de error ya preparados es evidente.</p>
<p>Ya deber√≠a haberse dado cuenta de la distancia recorrida con respecto a la</p>
<p>soluci√≥n mostrada al inicio del cap√≠tulo. Las transformaciones finales puede</p>
<p>examinarlas por su cuenta.</p>
<h3 id="conclusion-242">Conclusi√≥n</h3>
<p>No basta con que el c√≥digo funcione. El c√≥digo que funciona suele ser</p>
<p>incorrecto. Los programadores que se conforman con c√≥digo funcional no se</p>
<p>comportan de forma profesional. Puede que teman que no tienen tiempo para</p>
<p>mejorar la estructura y el dise√±o del c√≥digo, pero discrepo. No hay nada que</p>
<p>afecte m√°s negativamente un proyecto de desarrollo que el c√≥digo</p>
<p>incorrecto. Los plazos incorrectos se pueden rehacer los requisitos</p>
<p>equivocados se pueden volver a definir. La din√°mica incorrecta de un equipo</p>
<p>se puede reparar pero el c√≥digo incorrecto se corrompe y se convierte en una</p>
<p>carga que arrastra al equipo completo. He visto equipos dominados por el</p>
<p>desastre que han generado y que han dominado su destino.</p>
<p>Evidentemente, el c√≥digo incorrecto se puede limpiar pero resulta muy</p>
<p>costoso. Cuando el c√≥digo se corrompe los m√≥dulos se insin√∫an unos a otros</p>
<p>y generan multitud de dependencias ocultas y entrelazadas. La localizaci√≥n y</p>
<p>divisi√≥n de dependencias antiguas es una tarea larga y complicada. Por otra</p>
<p>parte, resulta relativamente sencillo mantener c√≥digo limpio. Si comete un</p>
<p>error en un m√≥dulo, es m√°s f√°cil limpiarlo directamente. Mejor todav√≠a, si</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>cometi√≥ un error hace cinco minutos, es muy f√°cil limpiarlo ahora.</p>
<p>Por tanto, la soluci√≥n consiste en mantener el c√≥digo limpio y sencillo</p>
<p>siempre que se pueda y no dejar que llegue a corromperse.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="aspectos-internos-de-junit-243">Aspectos internos de JUnit</h1>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>JUnit es una de las estructuras de Java m√°s conocidas. De concepci√≥n</p>
<p>sencilla, definici√≥n precisa y documentaci√≥n elegante. ¬øY su c√≥digo? En este</p>
<p>cap√≠tulo analizaremos un ejemplo extra√≠do de la estructura JUnit.</p>
<h3 id="la-estructura-junit-244">La estructura JUnit</h3>
<p>JUnit ha tenido muchos autores, comenzando por Kent Beck y Eric Gamma</p>
<p>en un vuelo a Atlanta. Kent quer√≠a aprender Java y Eric quer√≠a saber m√°s</p>
<p>sobre la estructura de pruebas Smalltalk de Kent. ‚Äú¬øHay algo m√°s natural que</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[94]</p>
<p>dos fan√°ticos enciendan sus port√°tiles y empiecen a escribir c√≥digo?‚Äù Tras</p>
<p>tres horas de trabajo de altura, hab√≠an creado los fundamentos de JUnit.</p>
<p>El m√≥dulo que analizaremos es un inteligente fragmento de c√≥digo que</p>
<p>permite identificar errores de comparaci√≥n de cadenas. El nombre del m√≥dulo</p>
<p>es ComparisonCompactor . Dadas dos cadenas diferentes, como ABCDE</p>
<p>ABXDE , muestra la diferencia entre ambas generando una cadena como &lt;...</p>
<p>B[X]D...&gt;</p>
<p>Podr√≠amos explicarlo m√°s, pero los casos de prueba son mejores. F√≠jese</p>
<p>en el Listado 15-1 para comprender los requisitos de este m√≥dulo. Analice la</p>
<p>estructura de las pruebas. ¬øPodr√≠an ser m√°s simples o m√°s evidentes?</p>
<p>Listado 15-1</p>
<p>ComparisonCompactorTest.java.</p>
<p>package junit.tests.framework;</p>
<p>import junit.framework.ComparisonCompactor;</p>
<p>import junit.framework.TestCase;</p>
<p>public class ComparisonCompactorTest extends TestCase {</p>
<p>public void testMessage() {</p>
<p>String failure= new ComparisonCompactor(0, ‚Äúb‚Äù, ‚Äúc‚Äù).compact(‚Äúa‚Äù);</p>
<p>assertTrue(‚Äúa expected:&lt;[b]&gt; but was:&lt;[c]&gt;‚Äù.equals(failure));</p>
<p>public void testStartSame() {</p>
<p>String failure= new ComparisonCompactor(1, ‚Äúba‚Äù, ‚Äúbc‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;b[a]&gt; but was:&lt;b[c]&gt;‚Äù, failure);</p>
<p>public void testEndSame() {</p>
<p>String failure= new ComparisonCompactor(1, ‚Äúab‚Äù, ‚Äúcb‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;[a]b&gt; but was:&lt;[c]b&gt;‚Äù, failure);</p>
<p>public void testSame() {</p>
<p>String failure= new ComparisonCompactor(1, ‚Äúab‚Äù, ‚Äúab‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;ab&gt; but was:&lt;ab&gt;‚Äù, failure);</p>
<p>public void testNoContextStartAndEndSame() {</p>
<p>String failure= new ComparisonCompactor(0, ‚Äúabc‚Äù, ‚Äúadc‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;...[b]...&gt; but was:&lt;...[d]...&gt;‚Äù, failure);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public void testStartAndEndContext() {</p>
<p>String failure= new ComparisonCompactor(1, ‚Äúabc‚Äù, ‚Äúadc‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;a[b]c&gt; but was:&lt;a[d]c&gt;‚Äù, failure);</p>
<p>public void testStartAndEndContextWithEllipses() {</p>
<p>String failure=</p>
<p>new ComparisonCompactor(1, ‚Äúabcde‚Äù, ‚Äúabfde‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;...b[c]d...&gt; but was:&lt;...b[f]d...&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorStartSameComplete() {</p>
<p>String failure= new ComparisonCompactor(2, ‚Äúab‚Äù, ‚Äúabc‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;ab[]&gt; but was:&lt;ab[c]&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorEndSameComplete() {</p>
<p>String failure= new ComparisonCompactor(0, ‚Äúbc‚Äù, ‚Äúabc‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;[]...&gt; but was:&lt;[a]...&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorEndSameCompleteContext() {</p>
<p>String failure= new ComparisonCompactor(2, ‚Äúbc‚Äù, ‚Äúabc‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;[]bc&gt; but was:&lt;[a]bc&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorOverlapingMatches() {</p>
<p>String failure= new ComparisonCompactor(0, ‚Äúabc‚Äù, ‚Äúabbc‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;...[]...&gt; but was:&lt;...[b]...&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorOverlapingMatchesContext() {</p>
<p>String failure= new ComparisonCompactor(2, ‚Äúabc‚Äù, ‚Äúabbc‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;ab[]c&gt; but was:&lt;ab[b]c&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorOverlapingMatches2() {</p>
<p>String failure= new ComparisonCompactor(0, ‚Äúabcdde‚Äù,</p>
<p>‚Äúabcde‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;...[d]...&gt; but was:&lt;...[]...&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorOverlapingMatches2Context() {</p>
<p>String failure=</p>
<p>new ComparisonCompactor(2, ‚Äúabcdde‚Äù, ‚Äúabcde‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;...cd[d]e&gt; but was:&lt;...cd[]e&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorWithActualNull() {</p>
<p>String failure= new ComparisonCompactor(0, ‚Äúa‚Äù, null).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;a&gt; but was:&lt;null&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorWithActualNullContext() {</p>
<p>String failure= new ComparisonCompactor(2, ‚Äúa‚Äù, null).compact(null);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>assertEquals(‚Äúexpected:&lt;a&gt; but was:&lt;null&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorWithExpectedNull() {</p>
<p>String failure= new ComparisonCompactor(0, null, ‚Äúa‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;null&gt; but was:&lt;a&gt;‚Äù, failure);</p>
<p>public void testComparisonErrorWithExpectedNullContext() {</p>
<p>String failure= new ComparisonCompactor(2, null, ‚Äúa‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;null&gt; but was:&lt;a&gt;‚Äù, failure);</p>
<p>public void testBug609972() {</p>
<p>String failure= new ComparisonCompactor(10, ‚ÄúS&amp;P500‚Äù, ‚Äú0‚Äù).compact(null);</p>
<p>assertEquals(‚Äúexpected:&lt;[S&amp;P50]0&gt; but was:&lt;[]0&gt;‚Äù, failure);</p>
<p>Realic√© un an√°lisis de alcance de c√≥digo en ComparisonCompactor con</p>
<p>estas pruebas. El c√≥digo se cubre en un 100 por 100. Cada l√≠nea, cada</p>
<p>instrucci√≥n if y cada bucle for se ejecuta con las pruebas. De este modo s√©</p>
<p>que el c√≥digo funciona y sus autores me merecen el mayor de los respetos.</p>
<p>El c√≥digo ComparisonCompactor se reproduce en el Listado 15-2.</p>
<p>Exam√≠nelo. Creo que lo encontrar√° bien distribuido, razonablemente</p>
<p>expresivo y estructuralmente sencillo. Cuando termine, lo diseccionaremos.</p>
<p>Listado 15-2</p>
<p>ComparisonCompactor.java (Original).</p>
<p>package junit.framework;</p>
<p>public class ComparisonCompactor {</p>
<p>private static final String ELLIPSIS = ‚Äú...‚Äù;</p>
<p>private static final String DELTA_END = ‚Äú]‚Äù;</p>
<p>private static final String DELTA_START = ‚Äú[‚Äù;</p>
<p>private int fContextLength;</p>
<p>private String fExpected;</p>
<p>private String fActual;</p>
<p>private int fPrefix;</p>
<p>private int fSuffix;</p>
<p>public ComparisonCompactor(int contextLength,</p>
<p>String expected,</p>
<p>String actual) {</p>
<p>fContextLength = contextLength;</p>
<p>fExpected = expected;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>fActual = actual;</p>
<p>public String compact(String message) {</p>
<p>if (fExpected == null || fActual == null || areStringsEqual())</p>
<p>return Assert.format(message, fExpected, fActual);</p>
<p>findCommonPrefix();</p>
<p>findCommonSuffix();</p>
<p>String expected = compactString(fExpected);</p>
<p>String actual = compactString(fActual);</p>
<p>return Assert.format(message, expected, actual);</p>
<p>private String compactString(String source) {</p>
<p>String result = DELTA_START +</p>
<p>source.substring(fPrefix, source.length() -</p>
<p>fSuffix + 1) + DELTA_END;</p>
<p>if (fPrefix &gt; 0)</p>
<p>result = computeCommonPrefix() + result;</p>
<p>if (fSuffix &gt; 0)</p>
<p>result = result + computeCommonSuffix();</p>
<p>return result;</p>
<p>private void findCommonPrefix() {</p>
<p>fPrefix = 0;</p>
<p>int end = Math.min(fExpected.length(), fActual.length());</p>
<p>for (; fPrefix &lt; end; fPrefix++) {</p>
<p>if (fExpected.charAt(fPrefix) != fActual.charAt(fPrefix))</p>
<p>break;</p>
<p>private void findCommonSuffix() {</p>
<p>int expectedSuffix = fExpected.length() - 1;</p>
<p>int actualSuffix = fActual.length() - 1;</p>
<p>for (;</p>
<p>actualSuffix &gt;= fPrefix &amp;&amp; expectedSuffix &gt;= fPrefix;</p>
<p>actualSuffix--, expectedSuffix--) {</p>
<p>if (fExpected.charAt(expectedSuffix) != fActual.charAt(actualSuffix))</p>
<p>break;</p>
<p>fSuffix = fExpected.length() - expectedSuffix;</p>
<p>private String computeCommonPrefix() {</p>
<p>return (fPrefix &gt; fContextLength ? ELLIPSIS : ‚Äú‚Äù) +</p>
<p>fExpected.substring(Math.max(0, fPrefix - fContextLength),</p>
<p>fPrefix);</p>
<p>private String computeCommonSuffix() {</p>
<p>int end = Math.min(fExpected.length() - fSuffix + 1 + fContextLength,</p>
<p>fExpected.length());</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return fExpected.substring(fExpected.length() - fSuffix + 1, end) +</p>
<p>(fExpected.length() - fSuffix + 1 &lt; fExpected.length() -</p>
<p>fContextLength ? ELLIPSIS : ‚Äú‚Äù);</p>
<p>private boolean areStringsEqual() {</p>
<p>return fExpected.equals(fActual);</p>
<p>Puede que tenga varias quejas sobre el m√≥dulo. Incluye expresiones</p>
<p>extensas y extra√±os elementos +1 . Pero en general, est√° bastante bien.</p>
<p>Despu√©s de todo, podr√≠a haber sido como el Listado 15-3.</p>
<p>Listado 15-3</p>
<p>ComparisonCompator.java (defactorizado)</p>
<p>package junit.framework;</p>
<p>public class ComparisonCompactor {</p>
<p>private int ctxt;</p>
<p>private String s1;</p>
<p>private String s2;</p>
<p>private int pfx;</p>
<p>private int sfx;</p>
<p>public ComparisonCompactor(int ctxt, String s1, String s2) {</p>
<p>this.ctxt = ctxt;</p>
<p>this.s1 = s1;</p>
<p>this.s2 = s2;</p>
<p>public String compact(String msg) {</p>
<p>if (s1 == null || s2 == null || s1.equals(s2))</p>
<p>return Assert.format(msg, s1, s2);</p>
<p>pfx = 0;</p>
<p>for (; pfx &lt; Math.min(s1.length(), s2.length()); pfx++) {</p>
<p>if (s1.charAt(pfx) != s2.charAt(pfx))</p>
<p>break;</p>
<p>int sfx1 = s1.length() - 1;</p>
<p>int sfx2 = s2.length() - 1;</p>
<p>for (; sfx2 &gt;= pfx &amp;&amp; sfx1 &gt;= pfx; sfx2--, sfx1--) {</p>
<p>if (s1.charAt(sfx1) != s2.charAt(sfx2))</p>
<p>break;</p>
<p>sfx = s1.length() - sfx1;</p>
<p>String cmp1 = compactString(s1);</p>
<p>String cmp2 = compactString(s2);</p>
<p>return Assert.format(msg, cmp1, cmp2);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private String compactString(String s) {</p>
<p>String result =</p>
<p>‚Äú[‚Äù + s.substring(pfx, s.length() - sfx + 1) + ‚Äú]‚Äù;</p>
<p>if (pfx &gt; 0)</p>
<p>result = (pfx &gt; ctxt ? ‚Äú...‚Äù : ‚Äú‚Äù) +</p>
<p>s1.substring(Math.max(0, pfx - ctxt), pfx) + result;</p>
<p>if (sfx &gt; 0) {</p>
<p>int end = Math.min(s1.length() - sfx + 1 + ctxt, s1.length());</p>
<p>result = result + (s1.substring(s1.length() - sfx + 1, end) +</p>
<p>(s1.length() - sfx + 1 &lt; s1.length() - ctxt ? ‚Äú...‚Äù : ‚Äú‚Äù));</p>
<p>return result;</p>
<p>Aunque los autores hicieron un buen trabajo con este m√≥dulo, la Regla</p>
<p>[95]</p>
<p>del Boy Scout muestra que podr√≠an haberlo dejado m√°s limpio de lo que se</p>
<p>encontr√≥. ¬øC√≥mo podemos mejorar el c√≥digo original del Listado 15-2? Lo</p>
<p>primero que no necesitamos es el prefijo de las variables miembro [N6].</p>
<p>Los entornos actuales hacen que este tipo de c√≥digo de √°mbito sea</p>
<p>redundante, por lo que eliminaremos todas las</p>
<p>private int contextLength;</p>
<p>private String expected;</p>
<p>private String actual;</p>
<p>private int prefix;</p>
<p>private int suffix;</p>
<p>Tras ello, tenemos una condicional sin encapsular al inicio de la funci√≥n</p>
<p>compact [G28].</p>
<p>public String compact(String message) {</p>
<p>if (expected == null || actual == null || areStringsEqual())</p>
<p>return Assert.format(message, expected, actual);</p>
<p>findCommonPrefix();</p>
<p>findCommonSuffix();</p>
<p>String expected = compactString(this.expected);</p>
<p>String actual = compactString(this.actual);</p>
<p>return Assert.format(message, expected, actual);</p>
<p>Es necesario encapsular esta condicional para que nuestra intenci√≥n sea</p>
<p>m√°s clara. Por tanto, extraemos un m√©todo que la explique.</p>
<p>public String compact(String message) {</p>
<p>if ( shouldNotCompact()</p>
<p>return Assert.format(message, expected, actual);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>findCommonPrefix();</p>
<p>findCommonSuffix();</p>
<p>String expected = compactString(this.expected);</p>
<p>String actual = compactString(this.actual);</p>
<p>return Assert.format(message, expected, actual);</p>
<p>private boolean shouldNotCompact() {</p>
<p>return expected == null || actual == null || areStringsEqual();</p>
<p>En la funci√≥n compact this.expected this.actual no son demasiado</p>
<p>relevantes. Sucede al cambiar el nombre de fExpected por expected . ¬øPor</p>
<p>qu√© esta funci√≥n tiene variables con los mismos nombres que las variables</p>
<p>miembro? ¬øNo representan cosas diferentes?[N4]. Los nombres deben ser</p>
<p>exclusivos.</p>
<p>String compactExpected = compactString( expected );</p>
<p>String compactActual = compactString( actual );</p>
<p>Los negativos son m√°s dif√≠ciles de entender que los positivos [G29]. Por</p>
<p>ello, invertimos esa instrucci√≥n if para cambiar el sentido de la condicional.</p>
<p>public String compact(String message) {</p>
<p>if ( canBeCompacted() ) {</p>
<p>findCommonPrefix();</p>
<p>findCommonSuffix();</p>
<p>String compactExpected = compactString(expected);</p>
<p>String compactActual = compactString(actual);</p>
<p>return Assert.format(message, compactExpected, compactActual);</p>
<p>} else {</p>
<p>return Assert.format(message, expected, actual);</p>
<p>private boolean canBeCompacted () {</p>
<p>return expected != null &amp;&amp; actual != null &amp;&amp; !areStringsEqual();</p>
<p>El nombre de la funci√≥n es extra√±o [N7]. Aunque compacta las cadenas,</p>
<p>puede que lo haga si canBeCompacted devuelve false . Al asignar el nombre</p>
<p>compact a esta funci√≥n se oculta el efecto secundario de la comprobaci√≥n de</p>
<p>errores. Adem√°s, la funci√≥n devuelve un mensaje con formato, no s√≥lo las</p>
<p>cadenas compactadas. Por tanto, el nombre de la funci√≥n deber√≠a ser</p>
<p>formatCompactedComparison De esta forma, se lee mejor junto al</p>
<p>argumento de la funci√≥n:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public String formatCompactedComparison(String message) {</p>
<p>El cuerpo de la instrucci√≥n if es donde se realiza la verdadera</p>
<p>compactaci√≥n de las cadenas. Debemos extraerlo como m√©todo con el</p>
<p>nombre compactExpectedAndActual . Sin embargo, queremos que la funci√≥n</p>
<p>formatCompactedComparison realice todo el formato. La funci√≥n compact ...</p>
<p>s√≥lo debe realizar la compactaci√≥n [G30], de modo que la dividimos de esta</p>
<p>forma:</p>
<p>...</p>
<p>private String compactExpected;</p>
<p>private String compactActual;</p>
<p>...</p>
<p>public String formatCompactedComparison(String message) {</p>
<p>if (canBeCompacted()) {</p>
<p>compactExpectedAndActual();</p>
<p>return Assert.format(message, compactExpected, compactActual);</p>
<p>} else {</p>
<p>return Assert.format(message, expected, actual);</p>
<p>private void compactExpectedAndActual () {</p>
<p>findCommonPrefix();</p>
<p>findCommonSuffix();</p>
<p>compactExpected = compactString(expected);</p>
<p>compactActual = compactString(actual);</p>
<p>Para ello, hemos tenido que ascender compactExpected compactActual</p>
<p>a variables miembro. No me gusta la forma en que las dos √∫ltimas l√≠neas de la</p>
<p>nueva funci√≥n devuelven variables pero las dos primeras no lo hacen. No</p>
<p>utilizan convenciones coherentes [G11]. Debemos cambiar</p>
<p>findCommonPrefix findCommonSuffix para que devuelvan los valores de</p>
<p>prefijo y sufijo.</p>
<p>private void compactExpectedAndActual() {</p>
<p>prefixIndex = findCommonPrefix();</p>
<p>suffixIndex = findCommonSuffix();</p>
<p>compactExpected = compactString(expected);</p>
<p>compactActual = compactString(actual);</p>
<p>private int findCommonPrefix() {</p>
<p>int prefix Index = 0;</p>
<p>int end = Math.min(expected.length(), actual.length());</p>
<p>for (; prefix Index &lt; end; prefix Index ++) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if (expected.charAt(prefix Index ) != actual.charAt(prefix Index ))</p>
<p>break;</p>
<p>return prefixIndex;</p>
<p>private int findCommonSuffix() {</p>
<p>int expectedSuffix = expected.length() - 1;</p>
<p>int actualSuffix = actual.length() - 1;</p>
<p>for (; actualSuffix &gt;= prefix Index &amp;&amp; expectedSuffix &gt;= prefixIndex;</p>
<p>actualSuffix--, expectedSuffix--) {</p>
<p>if (expected.charAt(expectedSuffix) != actual.charAt(actualSuffix))</p>
<p>break;</p>
<p>return expected.length() - expectedSuffix;</p>
<p>Tambi√©n debemos cambiar los nombres de las variables miembro para</p>
<p>que sean m√°s preciosas [N1], ya que en el fondo son √≠ndices.</p>
<p>Al examinar findCommonSuffix vemos una conexi√≥n temporal oculta</p>
<p>[G31]; depende de que prefixIndex se calcule por findCommonPrefix . Si</p>
<p>estas dos funcione se invocan de forma desordenada, la sesi√≥n de depuraci√≥n</p>
<p>posterior ser√≠a complicada. Por ello, para mostrar esta combinaci√≥n temporal,</p>
<p>haremos que findCommonSuffix acepte prefixIndex como argumento.</p>
<p>private void compactExpectedAndActual() {</p>
<p>prefixIndex = findCommonPrefix();</p>
<p>suffixIndex = findCommonSuffix( prefixIndex );</p>
<p>compactExpected = compactString(expected);</p>
<p>compactActual = compactString(actual);</p>
<p>private int findCommonSuffix( int prefixIndex ) {</p>
<p>int expectedSuffix = expected.length() - 1;</p>
<p>int actualSuffix = actual.length() - 1;</p>
<p>for (; actualSuffix &gt;= prefixIndex &amp;&amp; expectedSuffix &gt;= prefixIndex;</p>
<p>actualSuffix--, expectedSuffix--) {</p>
<p>if (expected.charAt(expectedSuffix) != actual.charAt(actualSuffix))</p>
<p>break;</p>
<p>return expected.length() - expectedSuffix;</p>
<p>No me convence del todo. El hecho de pasar prefixIndex como</p>
<p>argumento es un tanto arbitrario [G32]. Permite establecer el orden pero no</p>
<p>explica la necesidad del mismo. Otro programador podr√≠a deshacer esta</p>
<p>operaci√≥n ya que no se indica en ning√∫n momento para qu√© sirve el</p>
<p>par√°metro. Adoptemos un enfoque diferente.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void compactExpectedAndActual() {</p>
<p>findCommonPrefixAndSuffix();</p>
<p>compactExpected = compactString(expected);</p>
<p>compactActual = compactString(actual);</p>
<p>private void findCommonPrefixAndSuffix () {</p>
<p>findCommonPrefix();</p>
<p>int expectedSuffix = expected.length() - 1;</p>
<p>int actualSuffix = actual.length() - 1;</p>
<p>for (;</p>
<p>actualSuffix &gt;= prefixIndex &amp;&amp; expectedSuffix &gt;= prefixIndex;</p>
<p>actualSuffix--, expectedSuffix--</p>
<p>) {</p>
<p>if (expected.charAt(expectedSuffix) != actual.charAt(actualSuffix))</p>
<p>break;</p>
<p>suffixIndex = expected.length() - expectedSuffix;</p>
<p>private void findCommonPrefix() {</p>
<p>prefixIndex = 0;</p>
<p>int end = Math.min(expected.length(), actual.length());</p>
<p>for (; prefixIndex &lt; end; prefixIndex++)</p>
<p>if (expected.charAt(prefixIndex) != actual.charAt(prefixIndex))</p>
<p>break;</p>
<p>Devolvemos findCommonPrefix findCommonSuffix su posici√≥n</p>
<p>original, cambiamos el nombre de findCommonSuffix por</p>
<p>findCommonPrefixAndSuffix y hacemos que invoque findCommonPrefix</p>
<p>antes de hacer nada m√°s. De ese modo se establece la naturaleza temporal de</p>
<p>ambas funciones de forma m√°s evidente que antes. Adem√°s, se muestra el</p>
<p>m√≠nimo atractivo de findCommonPrefixAndSuffix que limpiaremos</p>
<p>continuaci√≥n:</p>
<p>private void findCommonPrefixAndSuffix() {</p>
<p>findCommonPrefix();</p>
<p>int suffixLength = 1;</p>
<p>for (; !suffixOverlapsPrefix(suffixLength); suffixLength++) {</p>
<p>if (charFromEnd(expected, suffixLength) !=</p>
<p>charFromEnd(actual, suffixLength))</p>
<p>break;</p>
<p>suffixIndex = suffixLength;</p>
<p>private char charFromEnd(String s, int i) {</p>
<p>return s.charAt(s.length()-i);}</p>
<p>private boolean suffixOverlapsPrefix(int suffixLength) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return actual.length() - suffixLength &lt; prefixLength ||</p>
<p>expected.length() - suffixLength &lt; prefixLength;</p>
<p>Mucho mejor. Muestra que suffixIndex es en realidad la longitud del</p>
<p>sufijo y que su nombre no es correcto. Lo mismo sucede con prefixIndex</p>
<p>aunque en ese caso √≠ndice y longitud son sin√≥nimos. Incluso as√≠, es m√°s</p>
<p>coherente usar length . El problema es que la variable suffixIndex no es de</p>
<p>base cero, sino de base y no es una verdadera longitud. √âste es el motivo de</p>
<p>la abundancia de +1 en computeCommonSuffix [G33]. Lo corregimos. En el</p>
<p>Listado 15-4 puede ver el resultado.</p>
<p>Listado 15-4</p>
<p>ComparisonCompactor.java (versi√≥n intermedia).</p>
<p>public class ComparisonCompactor {</p>
<p>...</p>
<p>private int suffixLength</p>
<p>...</p>
<p>private void findCommonPrefixAndSuffix() {</p>
<p>findCommonPrefix();</p>
<p>suffixLength = 0;</p>
<p>for (; !suffixOverlapsPrefix(suffixLength); suffixLength++) {</p>
<p>if (charFromEnd(expected, suffixLength) !=</p>
<p>charFromEnd(actual, suffixLength))</p>
<p>break;</p>
<p>private char charFromEnd(String s, int i) {</p>
<p>return s.charAt(s.length() - i - 1 );</p>
<p>private boolean suffixOverlapsPrefix(int suffixLength) {</p>
<p>return actual.length() - suffixLength &lt;= prefixLength ||</p>
<p>expected.length() - suffixLength &lt;= prefixLength;</p>
<p>...</p>
<p>private String compactString(String source) {</p>
<p>String result =</p>
<p>DELTA_START +</p>
<p>source.substring(prefixLength, source.length() - suffixLength ) +</p>
<p>DELTA_END;</p>
<p>if (prefixLength &gt; 0)</p>
<p>result = computeCommonPrefix() + result;</p>
<p>if ( suffixLength &gt; 0)</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>result = result + computeCommonSuffix();</p>
<p>return result;</p>
<p>...</p>
<p>private String computeCommonSuffix() {</p>
<p>int end = Math.min(expected.length() - suffixLength</p>
<p>contextLength, expected.length()</p>
<p>);</p>
<p>return</p>
<p>expected.substring(expected.length() - suffixLength , end) +</p>
<p>(expected.length() - suffixLength</p>
<p>expected.length() - contextLength ?</p>
<p>ELLIPSIS : ‚Äú‚Äù);</p>
<p>Cambiamos +1 en computeCommonSuffix por un -1 en charFromEnd,</p>
<p>donde tiene sentido, dos operadores &lt;= en suffixOverlapsPrefix</p>
<p>totalmente correctos. De este modo podemos cambiar el nombre de</p>
<p>suffixIndex por suffixLength lo que mejora considerablemente la</p>
<p>legibilidad del c√≥digo.</p>
<p>Pero hay un problema. Al comenzar a eliminar los +1 , me fij√© en la</p>
<p>siguiente l√≠nea de compactstring</p>
<p>if (suffixLength &gt; 0)</p>
<p>B√∫squela en el Listado 15-4. Como ahora suffixLength es una unidad</p>
<p>menos que antes, debemos cambiar el operador por &gt;= . Pero eso no tiene</p>
<p>sentido. Ahora s√≠. Significa que no ten√≠a sentido antes y que seguramente</p>
<p>fuera un error. Bueno, no del todo. Tras un an√°lisis detallado, vemos que</p>
<p>ahora la instrucci√≥n if impide que se a√±ada un sufijo de longitud cero. Antes</p>
<p>de realizar el cambio, la instrucci√≥n if no funcionaba ya que suffixIndex</p>
<p>nunca pod√≠a ser menos de uno.</p>
<p>Esto cuestiona ambas instrucciones if en compactString . Parece como si</p>
<p>se pudieran eliminar. Por ello, las comentamos y ejecutamos las pruebas.</p>
<p>Satisfactorias. Reestructuremos compactString para eliminar las</p>
<p>instrucciones if sobrantes y simplificar la funci√≥n [G9].</p>
<p>private String compactString(String source) {</p>
<p>return</p>
<p>computeCommonPrefix() +</p>
<p>DELTA_START +</p>
<p>source.substring(prefixLength, source.length() - suffixLength) +</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>DELTA_END +</p>
<p>computeCommonSuffix();</p>
<p>Mucho mejor. Ahora vemos que la funci√≥n compactString simplemente</p>
<p>combina los fragmentos. Probablemente lo podr√≠amos limpiar m√°s, en</p>
<p>peque√±as operaciones, pero en lugar de desarrollar el resto de los cambios,</p>
<p>mostraremos el resultado final en el Listado 15-5.</p>
<p>Listado 15-5</p>
<p>ComparisonCompactor.java (versi√≥n definitiva).</p>
<p>package junit.framework;</p>
<p>public class ComparisonCompactor {</p>
<p>private static final String ELLIPSIS = ‚Äú...‚Äù;</p>
<p>private static final String DELTA_END = ‚Äú]‚Äù;</p>
<p>private static final String DELTA_START = ‚Äú[‚Äù;</p>
<p>private int contextLength;</p>
<p>private String expected;</p>
<p>private String actual;</p>
<p>private int prefixLength;</p>
<p>private int suffixLength;</p>
<p>public ComparisonCompactor(</p>
<p>int contextLength, String expected, String actual</p>
<p>) {</p>
<p>this.contextLength = contextLength;</p>
<p>this.expected = expected;</p>
<p>this.actual = actual;</p>
<p>public String formatCompactedComparison(String message) {</p>
<p>String compactExpected = expected;</p>
<p>String compactActual = actual;</p>
<p>if (shouldBeCompacted()) {</p>
<p>findCommonPrefixAndSuffix();</p>
<p>compactExpected = compact(expected);</p>
<p>compactActual = compact(actual);</p>
<p>return Assert.format(message, compactExpected, compactActual);</p>
<p>private boolean shouldBeCompacted() {</p>
<p>return !shouldNotBeCompacted();</p>
<p>private boolean shouldNotBeCompacted() {</p>
<p>return expected == null ||</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>actual == null ||</p>
<p>expected.equals(actual);</p>
<p>private void findCommonPrefixAndSuffix() {</p>
<p>findCommonPrefix();</p>
<p>suffixLength = 0;</p>
<p>for (; !suffixOverlapsPrefix(); suffixLength++) {</p>
<p>if (charFromEnd(expected, suffixLength) !=</p>
<p>charFromEnd(actual, suffixLength)</p>
<p>break;</p>
<p>private char charFromEnd(String s, int i) {</p>
<p>return s.charAt(s.length() - i - 1);</p>
<p>private boolean suffixOverlapsPrefix() {</p>
<p>return actual.length() - suffixLength &lt;= prefixLength ||</p>
<p>expected.length() - suffixLength &lt;= prefixLength;</p>
<p>private void findCommonPrefix() {</p>
<p>prefixLength = 0;</p>
<p>int end = Math.min(expected.length(), actual.length());</p>
<p>for (; prefixLength &lt; end; prefixLength++)</p>
<p>if (expected.charAt(prefixLength) != actual.charAt(prefixLength))</p>
<p>break;</p>
<p>private String compact(String s) {</p>
<p>return new StringBuilder()</p>
<p>.append(startingEllipsis())</p>
<p>.append(startingContext())</p>
<p>.append(DELTA_START)</p>
<p>.append(delta(s))</p>
<p>.append(DELTA_END)</p>
<p>.append(endingContext())</p>
<p>.append(endingEllipsis())</p>
<p>.toString();</p>
<p>private String startingEllipsis() {</p>
<p>return prefixLength &gt; contextLength ? ELLIPSIS : ‚Äú‚Äù;</p>
<p>private String startingContext() {</p>
<p>int contextStart = Math.max(0, prefixLength - contextLength);</p>
<p>int contextEnd = prefixLength;</p>
<p>return expected.substring(contextStart, contextEnd);</p>
<p>private String delta(String s) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>int deltaStart = prefixLength;</p>
<p>int deltaEnd = s.length() - suffixLength;</p>
<p>return s.substring(deltaStart, deltaEnd);</p>
<p>private String endingContext() {</p>
<p>int contextStart = expected.length() - suffixLength;</p>
<p>int contextEnd =</p>
<p>Math.min(contextStart + contextLength, expected.length());</p>
<p>return expected.substring(contextStart, contextEnd);</p>
<p>private String endingEllipsis() {</p>
<p>return (suffixLength &gt; contextLength ? ELLIPSIS : ‚Äú‚Äù);</p>
<p>Bastante atractivo. El m√≥dulo se separa en un grupo de funciones de</p>
<p>an√°lisis y otro grupo de funciones de s√≠ntesis. Se ordenan topol√≥gicamente</p>
<p>para que la definici√≥n de cada funci√≥n aparezca donde realmente se usa.</p>
<p>Primero se muestran las funciones de an√°lisis y despu√©s las de s√≠ntesis. Si se</p>
<p>fija atentamente, ver√° que he invertido algunas de las decisiones adoptadas</p>
<p>inicialmente. Por ejemplo, he a√±adido algunos m√©todos extra√≠dos</p>
<p>formatCompactedComparison y he modificado el sentido de la expresi√≥n</p>
<p>shouldNotBeCompacted Es algo habitual. menudo, un cambio de</p>
<p>refactorizaci√≥n lleva a otro que a su vez lleva a deshacer el primero. La</p>
<p>refactorizaci√≥n es un proceso iterativo de ensayo y error, e inevitablemente</p>
<p>converge en algo que consideramos digno de un profesional.</p>
<h3 id="conclusion-245">Conclusi√≥n</h3>
<p>Hemos cumplido la Regla del Boy Scout. Hemos dejado este m√≥dulo m√°s</p>
<p>limpio de como lo encontramos. No es que no estuviera limpio originalmente,</p>
<p>ya que el trabajo de sus autores es excelente, pero cualquier m√≥dulo se puede</p>
<p>mejorar y es nuestra responsabilidad dejar el c√≥digo m√°s limpio de lo que lo</p>
<p>encontramos.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="refactorizacion-de-serialdate-246">Refactorizaci√≥n de SerialDate</h1>
<p>Si visita http://www.jfree.org/jcommon/index.php encontrar√° la</p>
<p>biblioteca JCommon. En su interior incluye el paquete org.jfree.date y,</p>
<p>dentro de √©ste, la clase SerialDate . Vamos a analizar esta clase.</p>
<p>El autor de SerialDate es David Gilbert. David es un programador</p>
<p>experimentado y competente. Como veremos, muestra un elevado grado de</p>
<p>profesionalidad y disciplina en su c√≥digo. En lo que a √©ste respecta, se puede</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>considerar de calidad. Y voy a despedazarlo.</p>
<p>No es un acto de malicia, ni tampoco me creo mejor que David y con el</p>
<p>derecho de juzgar su c√≥digo. De hecho, si leyera alg√∫n c√≥digo que he creado,</p>
<p>seguramente tendr√≠a que objetar muchos aspectos del mismo. No es un acto</p>
<p>de arrogancia. Lo que voy a hacer no es m√°s que una revisi√≥n profesional,</p>
<p>algo con lo que todos deber√≠amos sentirnos c√≥modos y algo que deber√≠amos</p>
<p>agradecer si alguien lo hace. A trav√©s de las cr√≠ticas es como podemos</p>
<p>aprender, como hacen m√©dicos, pilotos abogados. nosotros, como</p>
<p>programadores, tambi√©n tenemos que aprender a hacerlo.</p>
<p>Otra cosa m√°s sobre David Gilbert: es m√°s que un buen programador.</p>
<p>David ha tenido el valor y la buena voluntad de ofrecer este c√≥digo al p√∫blico</p>
<p>gratuitamente, para que cualquiera pueda usarlo y examinarlo. ¬°Bien hecho!</p>
<p>SerialDate (v√©ase el Listado B-1) es una clase que representa una fecha</p>
<p>en Java. ¬øPara qu√© se necesita una clase que represente una fecha si Java ya</p>
<p>cuenta con java.util.Date java.util.Calendar , entre otras? El autor</p>
<p>cre√≥ esta clase como respuesta a un problema que yo tambi√©n he padecido. El</p>
<p>comentario de su Javadoc inicial (l√≠nea 67) lo explica. Podr√≠amos cuestionar</p>
<p>su intenci√≥n, pero yo tambi√©n he sufrido este problema y se agradece una</p>
<p>clase sobre fechas en lugar de horas.</p>
<h3 id="primero-conseguir-que-funcione-247">Primero, conseguir que funcione</h3>
<p>Hay varias pruebas de unidad en la clase SerialDateTests (v√©ase el Listado</p>
<p>B-2). Todas son satisfactorias. Desafortunadamente, un r√°pido examen</p>
<p>demuestra que no comprueban todos los aspectos [T1]. Por ejemplo, al</p>
<p>realizar una b√∫squeda de usos en el m√©todo MonthCodeToQuarter (l√≠nea 334)</p>
<p>se indica que no se usa [F4]. Por lo tanto, las pruebas de unidad no lo</p>
<p>comprueban. Por ello, recurr√≠ a Clover para ver el alcance de las pruebas de</p>
<p>unidad. Clover indic√≥ que las pruebas s√≥lo ejecutan de las</p>
<p>instrucciones ejecutables de SerialDate (aproximadamente el 50 por 100)</p>
<p>[T2]. El mapa de alcance muestra grandes fragmentos de c√≥digo sin ejecutar</p>
<p>desperdigados por la clase.</p>
<p>Mi objetivo era comprender la clase y refactorizarla, algo que no pod√≠a</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>lograr sin una cobertura mayor de las pruebas. Por ello dise√±√© mi propia suite</p>
<p>de pruebas de unidad independientes (v√©ase el Listado B-4).</p>
<p>Si se fija en las pruebas, comprobar√° que muchas est√°n comentadas, ya</p>
<p>que no se superaron. Representan un comportamiento que considero deber√≠a</p>
<p>incluirse en SerialDate . Por tanto, al refactorizar SerialDate , intentar√© que</p>
<p>estas pruebas funcionen.</p>
<p>Incluso con algunas de las pruebas comentadas, el informe de Clover</p>
<p>indica que ahora ejecutan 170 (el 92 por ciento) de las 185 instrucciones</p>
<p>ejecutables. Un gran resultado que creo que puedo mejorar.</p>
<p>Las primeras pruebas comentadas (l√≠neas 23-63) son un tanto</p>
<p>pretenciosas. El programa no fue dise√±ado para superar estas pruebas, pero el</p>
<p>comportamiento me parec√≠a evidente [G2]. Desconozco por qu√© se ha creado</p>
<p>el m√©todo testWeekdayCodeToString pero ya que est√° ah√≠, parece obvio que</p>
<p>no debe distinguir entre may√∫sculas y min√∫sculas. El dise√±o de las pruebas</p>
<p>fue sencillo [T3] y m√°s todav√≠a que fueran satisfactorias; simplemente cambi√©</p>
<p>las l√≠neas 259 y 263 para usar equalsIgnoreCase</p>
<p>Coment√© las pruebas de las l√≠neas 32 y 45 ya que no estaba seguro de si</p>
<p>las abreviaturas tues thurs se admit√≠an o no. Las pruebas de las l√≠neas 153</p>
<p>y 154 no se superaron, aunque deber√≠an haberlo hecho [G2]. Podemos</p>
<p>corregirlas, junto a las pruebas de las l√≠neas 163 a la 213, si realizamos los</p>
<p>siguientes cambios en la funci√≥n stringToMonthCode</p>
<p>if ((result &lt; 1) || (result &gt; 12)) { result = -1;</p>
<p>for (int i = 0; i &lt; monthNames.length; i++) {</p>
<p>if (s.equalsIgnoreCase(shortMonthNames[i])) {</p>
<p>result = i + 1;</p>
<p>break;</p>
<p>if (s.equalsIgnoreCase(monthNames[i])) {</p>
<p>result = i + 1;</p>
<p>break;</p>
<p>La prueba comentada de la l√≠nea 318 descubre un error en el m√©todo</p>
<p>getFollowingDayOfWeek (l√≠nea 672). El 25 de diciembre de 2004 fue s√°bado</p>
<p>y el siguiente s√°bado fue el 1 de enero de 2005. Sin embargo, al ejecutar la</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>prueba, vemos que getFollowingDayOfWeek devuelve el 25 de diciembre</p>
<p>como siguiente s√°bado despu√©s del 25 de diciembre, un error evidente [G3],</p>
<p>[T1]. Vemos el problema en la l√≠nea 685. Es un error de condici√≥n de l√≠mite</p>
<p>t√≠pico [T5]. Deber√≠a ser lo siguiente:</p>
<p>685 if (baseDOW &gt;= targetWeekday) {</p>
<p>Conviene destacar que esta funci√≥n sufri√≥ una reparaci√≥n anterior. El</p>
<p>historial de cambios (l√≠nea 43) muestra que se corrigieron los errores en</p>
<p>getPreviousDayOfWeek getFollowingDayOfWeek getNearestDayOfWeek</p>
<p>[T6].</p>
<p>La prueba de unidad testGetNearestDayOfWeek (l√≠nea 329), que prueba</p>
<p>el m√©todo getNearestDayOfWeek (l√≠nea 705), inicialmente no era tan extensa</p>
<p>y completa. A√±ad√≠ multitud de casos de prueba ya que los iniciales no se</p>
<p>superaban [T6]. Puede ver el patr√≥n de fallos si se fija en los casos de prueba</p>
<p>comentados. El patr√≥n es revelador [T7]. Muestra que el algoritmo falla si el</p>
<p>d√≠a m√°s pr√≥ximo es de una fecha futura. Evidentemente se trata de alg√∫n tipo</p>
<p>de error de condici√≥n de l√≠mite [T5].</p>
<p>El patr√≥n de alcance de las pruebas generado por Clover tambi√©n es</p>
<p>interesante [T8]. La l√≠nea 719 nunca se ejecuta, lo que significa que la</p>
<p>instrucci√≥n if de la l√≠nea 718 siempre es false , pero si nos fijamos en el</p>
<p>c√≥digo, indica que debe ser true . La variable adjust siempre es negativa y</p>
<p>no puede ser mayor o igual a 4, por lo que el algoritmo es incorrecto.</p>
<p>A continuaci√≥n se muestra el algoritmo correcto:</p>
<p>int delta = targetDOW - base.getDayOfWeek();</p>
<p>int positiveDelta = delta + 7;</p>
<p>int adjust = positiveDelta % 7;</p>
<p>if (adjust &gt; 3)</p>
<p>adjust -= 7;</p>
<p>return SerialDate.addDays (adjust, base);</p>
<p>Por √∫ltimo, las pruebas de la l√≠neas 417 y 429 se pueden superar si se</p>
<p>genera IllegalArgumentException en lugar de devolver una cadena de error</p>
<p>desde weekInMonthToString relativeToString . Con estos cambios, todas</p>
<p>las pruebas de unidad se superan y creo que ahora SerialDate funciona.</p>
<p>Llega el momento de hacer que sea correcta.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="hacer-que-sea-correcta-248">Hacer que sea correcta</h3>
<p>Describiremos SerialDate de arriba a abajo para mejorarla en nuestro</p>
<p>recorrido. Aunque no lo veamos en este an√°lisis, ejecutar√© todas las pruebas</p>
<p>de unidad de JCommon incluida mi prueba de unidad mejorada para</p>
<p>SerialDate , con todos los cambios efectuados. Por ello, tenga la seguridad</p>
<p>de que todos los cambios que vea funcionan para JCommon</p>
<p>En la l√≠nea 1 vemos abundantes comentarios sobre informaci√≥n de</p>
<p>licencia, derechos de autor, autores e historial de cambios. Asumo que hay</p>
<p>ciertos aspectos legales que mostrar, por lo que los derechos de autor y las</p>
<p>licencias deben conservarse. Por otra parte, el historial de cambios es una</p>
<p>r√©mora de la d√©cada de 1960. Ahora tenemos herramientas de control de</p>
<p>c√≥digo fuente que se encargan de ello. Hay que eliminar este historial [C1].</p>
<p>La lista de importaci√≥n que comienza en la l√≠nea 61 se puede reducir por</p>
<p>medio de java.text.* java.util.* . [J1]</p>
<p>No me convence el formato HTML del Javadoc (l√≠nea 67). Un archivo</p>
<p>fuente con m√°s de un lenguaje me parece un problema. Este comentario tiene</p>
<p>cuatro lenguajes: Java, espa√±ol, Javadoc y html [G1]. Con tantos lenguajes se</p>
<p>hace dif√≠cil mantener la coherencia. Por ejemplo, la ubicaci√≥n de las l√≠neas 71</p>
<p>y 72 se pierde al generar el Javadoc y adem√°s, ¬øqui√©n quiere ver &lt;ul&gt; &lt;li&gt;</p>
<p>en el c√≥digo fuente? Una estrategia m√°s acertada consiste en rodear el</p>
<p>comentario con &lt;pre&gt; para que el formato del c√≥digo fuente se conserve en el</p>
<p>[96]</p>
<p>Javadoc</p>
<p>La l√≠nea 86 es la declaraci√≥n de la clase. ¬øPor qu√© se le asigna el nombre</p>
<p>SerialDate ? ¬øQu√© sentido tiene la palabra serial ? ¬øEs porque la clase se</p>
<p>deriva de Serializable ? Parece improbable.</p>
<p>Basta de adivinanzas. S√© por qu√© (o al menos eso creo) se usa la palabra</p>
<p>serial . La clave se encuentra en las constantes SERIAL_LOWER_BOUND</p>
<p>SERIAL_UPPER_BOUND de las l√≠neas 98 y 101. Y una clave todav√≠a mejor es el</p>
<p>comentario de la l√≠nea 830. El nombre de la clase es SerialDate ya que se</p>
<p>implementa con un n√∫mero de serie, que parece ser el n√∫mero de d√≠as desde</p>
<p>el 30 de diciembre de 1899.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Pero esto supone un problema. Por un lado, el t√©rmino ¬´n√∫mero de serie¬ª</p>
<p>no es realmente correcto. Puede ser un detalle menor pero la representaci√≥n</p>
<p>es m√°s un desplazamiento relativo que un n√∫mero de serie. El t√©rmino</p>
<p>¬´n√∫mero de serie¬ª tiene que ver m√°s con marcadores de identificaci√≥n de</p>
<p>productos que con fechas. Por ello, no lo considero especialmente descriptivo</p>
<p>[N1]. Un t√©rmino m√°s descriptivo ser√≠a ¬´ordinal¬ª.</p>
<p>El segundo problema es m√°s significativo. El nombre SerialDate implica</p>
<p>una implementaci√≥n. Esta clase es abstracta. No es necesario que implique</p>
<p>nada sobre la implementaci√≥n; de hecho, es aconsejable ocultarla. Por ello,</p>
<p>creo que el nombre se encuentra en un nivel de abstracci√≥n incorrecto [N2].</p>
<p>En mi opini√≥n, el nombre de esta clase deber√≠a ser simplemente Date</p>
<p>Desafortunadamente, hay demasiadas clases con el nombre Date en la</p>
<p>biblioteca de Java, de modo que no es el m√°s adecuado. Como esta clase</p>
<p>trabaja con d√≠as y no horas, podr√≠amos usar Day , pero ya se usa en otros</p>
<p>muchos puntos. Al final, opt√© por DayDate como mejor opci√≥n.</p>
<p>A partir de ahora, usaremos DayDate . Recuerde que los listados que va a</p>
<p>leer siguen usando SerialDate</p>
<p>Entiendo porque DayDate se hereda de Comparable Serializable</p>
<p>¬øPero de MonthConstants ? La clase MonthConstants (v√©ase el Listado B-3)</p>
<p>es una serie de constantes finales est√°ticas que definen los meses. Heredar de</p>
<p>clases con constantes es un viejo truco que los programadores de Java usan</p>
<p>para evitar expresiones como MonthConstants.January , pero es una mala</p>
<p>idea [J2]. MonthConstants deber√≠a ser una enumeraci√≥n.</p>
<p>public abstract class DayDate implements Comparable,</p>
<p>Serializable {</p>
<p>public static enum Month {</p>
<p>JANUARY(1),</p>
<p>FEBRUARY(2),</p>
<p>MARCH(3),</p>
<p>APRIL(4),</p>
<p>MAY(5),</p>
<p>JUNE(6),</p>
<p>JULY(7),</p>
<p>AUGUST(8),</p>
<p>SEPTEMBER(9),</p>
<p>OCTOBER(10),</p>
<p>NOVEMBER(11),</p>
<p>DECEMBER(12);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Month(int index) {</p>
<p>this.index = index;</p>
<p>public static Month make(int monthIndex) {</p>
<p>for (Month m : Month.values()) {</p>
<p>if (m.index == monthIndex)</p>
<p>return m;</p>
<p>throw new IllegalArgumentException(‚ÄúInvalid month index ‚Äù + monthIndex);</p>
<p>public final int index;</p>
<p>Al cambiar MonthConstants por esta enumeraci√≥n se modifica la clase</p>
<p>DayDate y todos sus usuarios. Tard√© una hora en realizar todos los cambios.</p>
<p>Sin embargo, las funciones que antes aceptaban un valor int para el mes,</p>
<p>ahora aceptan un enumerador Month . Esto significa que podemos deshacernos</p>
<p>del m√©todo isValidMonthCode (l√≠nea 326) y de la comprobaci√≥n de errores</p>
<p>del c√≥digo de los meses como en monthCodeToQuarter (l√≠nea 356) [G5]. Tras</p>
<p>ello, en la l√≠nea 91, tenemos serialVersionUID . Esta variable se usa para</p>
<p>controlar el se√±alizador. Si la cambiamos, con lo que todos los elementos</p>
<p>DayDate escritos con una versi√≥n antigua del software ser√°n ilegibles y se</p>
<p>generar√° InvalidClassException Si no declara la variable</p>
<p>serialVersionUID el compilador genera una autom√°ticamente ser√°</p>
<p>diferente cada vez que modifique el m√≥dulo. Ya s√© que todos los documentos</p>
<p>recomiendan el control manual de esta variable, pero creo que el control</p>
<p>autom√°tico de la se√±alizaci√≥n es m√°s seguro [G4]. Despu√©s de todo, prefiero</p>
<p>depurar una InvalidClassException que el extra√±o comportamiento que se</p>
<p>producir√≠a si me olvido de cambiar serialVersionUID . Por ello, eliminar√© la</p>
<p>[97]</p>
<p>variable, al menos por ahora</p>
<p>Creo que el comentario de la l√≠nea 93 es redundante. Los comentarios</p>
<p>redundantes s√≥lo sirven para acumular mentiras y desinformaci√≥n [C2]. Por</p>
<p>ello los eliminar√©.</p>
<p>Los comentarios de las l√≠neas 97 y 100 hablan sobre n√∫meros de serie,</p>
<p>que ya hemos mencionado antes [C1]. Las variables que describen son la</p>
<p>primera y √∫ltima fecha posible que DayDate puede describir. Podr√≠amos</p>
<p>hacer que fuera m√°s claro [N1].</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public static final int EARLIEST_DATE_ORDINAL = 2; // 1/1/1900</p>
<p>public static final int LATEST_DATE_ORDINAL = 2958465; // 12/31/9999</p>
<p>Desconozco por qu√© EARLIEST_DATE_ORDINAL es 2 en lugar de 0. El</p>
<p>comentario de la l√≠nea 829 sugiere que tiene que ver con la forma de</p>
<p>representar fechas en Microsoft Excel. Hay informaci√≥n mucho m√°s completa</p>
<p>en una variante de DayDate SpreadsheetDate (v√©ase el Listado B-5). El</p>
<p>comentario de la l√≠nea 71 describe este problema.</p>
<p>El problema parece relacionado con la implementaci√≥n de</p>
<p>SpreadsheetDate no con DayDate Mi conclusi√≥n es que</p>
<p>EARLIEST_DATE_ORDINAL LATEST_DATE_ORDINAL no pertenecen a DayDate</p>
<p>deber√≠an cambiarse a SpreadsheetDate [G6].</p>
<p>De hecho, una b√∫squeda en el c√≥digo demuestra que estas variables s√≥lo</p>
<p>se usan en SpreadsheetDate . Ni en DayDate , ni en otras clases de la</p>
<p>estructura JCommon. Por lo tanto, las cambio por SpreadsheetDate</p>
<p>Las siguientes variables, MINIMUM_YEAR_SUPPORTED</p>
<p>MAXIMUM_YEAR_SUPPORTED (l√≠neas 104 y 107), constituyen un dilema. Parece</p>
<p>evidente que si DayDate es una clase abstracta que no dice nada sobre</p>
<p>implementaci√≥n, no deber√≠a informarnos de un a√±o m√≠nimo o m√°ximo. De</p>
<p>nuevo, siento la necesidad de cambiar las variables a SpreadsheetDate [G6].</p>
<p>Pero una b√∫squeda r√°pida de los usuarios de estas variables muestra que otra</p>
<p>clase las utiliza: RelativeDayOfWeekRule (v√©ase el Listado B-6), Vemos</p>
<p>dicho uso en las l√≠neas 177 y 178, en la funci√≥n getDate , donde se usan para</p>
<p>comprobar que el argumento de getDate sea un a√±o v√°lido. El dilema es que</p>
<p>un usuario de una clase abstracta necesita informaci√≥n sobre su</p>
<p>implementaci√≥n.</p>
<p>Tendremos que proporcionar esta informaci√≥n sin contaminar DayDate</p>
<p>Por lo general, obtendr√≠amos la informaci√≥n de implementaci√≥n de una</p>
<p>instancia de una variante. Sin embargo, la funci√≥n getDate no recibe una</p>
<p>instancia de DayDate , aunque s√≠ la devuelve, lo que significa que debe crearla</p>
<p>en alguna parte. La soluci√≥n est√° en las l√≠neas 187-205. La instancia DayDate</p>
<p>se crea por medio de una de estas tres funciones: getPreviousDayOfWeek</p>
<p>getNearestDayOfWeek getFollowingDayOfWeek Si nos fijamos en el</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>listado DayDate , vemos que estas funciones (l√≠neas 638-724) devuelven una</p>
<p>fecha creada por addDays (l√≠nea 571), que invoca createInstance (l√≠nea</p>
<p>808), que crea SpreadsheetDate [G7].</p>
<p>No es recomendable que las clases base conozcan sus variantes. Para</p>
<p>[98]</p>
<p>corregirlo, debemos usar el patr√≥n de factor√≠a abstracta crear</p>
<p>DayDateFactory Esta factor√≠a crear√° las instancias de DayDate que</p>
<p>necesitamos y tambi√©n responder√° a preguntas sobre la implementaci√≥n,</p>
<p>como las fechas m√°xima y m√≠nima.</p>
<p>public abstract class DayDateFactory {</p>
<p>private static DayDateFactory factory = new SpreadsheetDateFactory();</p>
<p>public static void set Instance(DayDateFactory factory) {</p>
<p>DayDateFactory.factory = factory;</p>
<p>protected abstract DayDate _makeDate(int ordinal);</p>
<p>protected abstract DayDate _makeDate(int day, DayDate.Month month, int</p>
<p>year);</p>
<p>protected abstract DayDate _makeDate(int day, int month, int year);</p>
<p>protected abstract DayDate _makeDate(java.util.Date date);</p>
<p>protected abstract int _getMinimumYear();</p>
<p>protected abstract int _getMaximumYear();</p>
<p>public static DayDate makeDate(int ordinal) {</p>
<p>return factory._makeDate(ordinal);</p>
<p>public static DayDate makeDate(int day, DayDate.Month month, int year) {</p>
<p>return factory._makeDate(day, month, year);</p>
<p>public static DayDate makeDate(int day, int month, int year) {</p>
<p>return factory._makeDate(day, month, year);</p>
<p>public static DayDate makeDate(java.util.Date date) {</p>
<p>return factory._makeDate(date);</p>
<p>public static int getMinimumYear() {</p>
<p>return factory._getMinimumYear();</p>
<p>public static int getMaximumYear() {</p>
<p>return factory._getMaximumYear();</p>
<p>Esta clase de factor√≠a sustituye los m√©todos createInstance por m√©todos</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>makeDate lo que mejora ligeramente los nombres [N1]. De forma</p>
<p>predeterminada es SpreadsheetDateFactory pero se puede cambiar por otra</p>
<p>factor√≠a. Los m√©todos est√°ticos delegados en m√©todos abstractos usan una</p>
<p>[99] [100]</p>
<p>combinaci√≥n de los patrones de instancia √∫nica decorador factor√≠a</p>
<p>abstracta que considero muy √∫til. SpreadsheetDateFactory tiene este</p>
<p>aspecto:</p>
<p>public class SpreadsheetDateFactory extends DayDateFactory {</p>
<p>public DayDate _makeDate(int ordinal) {</p>
<p>return new SpreadsheetDate(ordinal);</p>
<p>public DayDate _makeDate(int day, DayDate.Month month, int year) {</p>
<p>return new SpreadsheetDate(day, month, year);</p>
<p>public DayDate _makeDate(int day, int month, int year) {</p>
<p>return new SpreadsheetDate(day, month, year);</p>
<p>public DayDate _makeDate(Date date) {</p>
<p>final GregorianCalendar calendar = new GregorianCalendar();</p>
<p>calendar.setTime(date);</p>
<p>return new SpreadsheetDate(</p>
<p>calendar.get(Calendar.DATE),</p>
<p>DayDate.Month.make(calendar.get(Calendar.MONTH) + 1),</p>
<p>calendar.get(Calendar.YEAR));</p>
<p>protected int _getMinimumYear() {</p>
<p>return SpreadsheetDate.MINIMUM_YEAR_SUPPORTED;</p>
<p>protected int _getMaximumYear() {</p>
<p>return SpreadsheetDate.MAXIMUM_YEAR_SUPPORTED;</p>
<p>Como puede apreciar, hemos enviado las variables</p>
<p>MINIMUM_YEAR_SUPPORTED MAXIMUM_YEAR_SUPPORTED SpreadsheetDate</p>
<p>donde pertenecen [G6].</p>
<p>El siguiente problema de DayDate son las constantes de d√≠as, comenzando</p>
<p>en la l√≠nea 109. Deber√≠an ser otra enumeraci√≥n [J3]. Ya hemos visto este</p>
<p>patr√≥n, de modo que no lo repetiremos. Se incluye en los listados definitivos.</p>
<p>Seguidamente, vemos una serie de tablas que comienzan en</p>
<p>LAST_DAY_OF_MONTH (l√≠nea 140). El primer problema con estas tablas es que</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>los comentarios que las describen son redundantes [C3]. Basta con sus</p>
<p>nombres, de modo que eliminamos los comentarios.</p>
<p>No hay motivos para que la tabla no sea privada [G8], ya que existe una</p>
<p>funci√≥n est√°tica lastDayOfMonth que proporciona los mismos datos.</p>
<p>La siguiente tabla, AGGREGATE_DAYS_TO_END_OF_MONTH es m√°s</p>
<p>misteriosa, ya que no se usa en ninguna parte de la estructura JCommon [G9],</p>
<p>de modo que la elimino.</p>
<p>Lo mismo sucede con LEAP_YEAR_AGGREGATE_DAYS_TO_END_OF_MONTH</p>
<p>La siguiente tabla, AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH , s√≥lo</p>
<p>se usa en SpreadsheetDate (l√≠neas 434 y 473), lo que me hace dudar si</p>
<p>transferirla a SpreadsheetDate . La raz√≥n de no cambiarla es que la tabla no</p>
<p>es espec√≠fica de ninguna implementaci√≥n concreta [G6]. Por otra parte, s√≥lo</p>
<p>existe la implementaci√≥n SpreadsheetDate , de modo que la tabla debe</p>
<p>acercarse a donde se vaya a usar [G10],</p>
<p>Para zanjar la duda y ser coherentes [G11], deber√≠amos privatizar la tabla</p>
<p>y mostrarla a trav√©s de una funci√≥n como julianDateOfLastDayOfMonth</p>
<p>Pero nadie parece que la necesita. Es m√°s, la tabla se puede cambiar a</p>
<p>DayDate si una nueva implementaci√≥n de DayDate la necesita. As√≠ que la</p>
<p>cambiamos.</p>
<p>Lo mismo sucede con LEAP_YEAR_AGGREGATE_DAYS_TO_END_OF_MONTH</p>
<p>Tras ello, vemos tres grupos de constantes que se pueden convertir en</p>
<p>enumeraciones (l√≠neas 162-205). La primera selecciona una semana de un</p>
<p>mes. La transformo en la enumeraci√≥n WeekInMonth</p>
<p>public enum WeekInMonth {</p>
<p>FIRST(1), SECOND(2), THIRD(3), FOURTH(4), LAST(0);</p>
<p>public final int index;</p>
<p>WeekInMonth(int index) {</p>
<p>this.index = index;</p>
<p>El segundo grupo de constantes (l√≠neas 177-187) es m√°s complicado. Las</p>
<p>constantes INCLUDE_NONE, INCLUDE_FIRST, INCLUDE_SECOND</p>
<p>INCLUDE_BOTH se usan para describir si las fechas finales de un intervalo</p>
<p>deben incluirse en el mismo. Matem√°ticamente, se describe como intervalo</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>abierto, intervalo a medio abrir e intervalo cerrado. Creo que resulta m√°s</p>
<p>claro con la nomenclatura matem√°tica [N3], de modo que lo cambio por la</p>
<p>enumeraci√≥n DateInterval con los enumeradores CLOSED, CLOSED_LEFT,</p>
<p>CLOSED_RIGHT OPEN</p>
<p>El tercer grupo de constantes (l√≠neas 18-205) describen si la b√∫squeda de</p>
<p>un d√≠a concreto de la semana devuelve la √∫ltima instancia, la siguiente o la</p>
<p>m√°s pr√≥xima. Decidir un nombre adecuado es complicado. Al final, opt√© por</p>
<p>WeekdayRange con los enumeradores LAST, NEXT NEAREST</p>
<p>Puede que no est√© de acuerdo con los nombres elegidos. Para m√≠ tienen</p>
<p>sentido. Lo importante es que ahora son m√°s f√°ciles de cambiar [J3]. Ya no se</p>
<p>pasan como enteros, sino como s√≠mbolos. Puedo usar la funci√≥n de cambio de</p>
<p>nombre de mi IDE para cambiar los nombres o los tipos sin preocuparme de</p>
<p>haberme olvidado de un -1 o un en alguna parte del c√≥digo o de que la</p>
<p>declaraci√≥n de un argumento int no est√©n bien descrita.</p>
<p>El campo de descripci√≥n de la l√≠nea 208 no parece que se use en ninguna</p>
<p>parte. Lo elimino junto a sus elementos de acceso y mutaci√≥n [G9]. Tambi√©n</p>
<p>elimino el constructor predeterminado de la l√≠nea 213 [G12]. El compilador</p>
<p>se encargar√° de generarlo.</p>
<p>Podemos ignorar el m√©todo isValidWeekdayCode (l√≠neas 216-238) ya que</p>
<p>lo eliminamos al crear la enumeraci√≥n Day</p>
<p>Llegamos al m√©todo stringToWeekdayCode (l√≠neas 242-270). Los</p>
<p>Javadoc que no suponen demasiado para la firma del m√©todo sobran [C3],</p>
<p>[G12]. El √∫nico valor de este Javadoc es la descripci√≥n del valor devuelto -1</p>
<p>Sin embargo, como cambiamos a la enumeraci√≥n Day , el comentario es en</p>
<p>realidad incorrecto [C2]. Ahora el m√©todo genera</p>
<p>IllegalArgumentException . Por ello, eliminamos el Javadoc.</p>
<p>Tambi√©n elimino las palabras clave final de argumentos y declaraciones</p>
<p>de variables, ya que no parecen servir de mucho [G12]. La eliminaci√≥n de</p>
<p>[101]</p>
<p>final no goza de gran aceptaci√≥n. Por ejemplo, Robert Simmons</p>
<p>recomienda ¬´... diseminar final por la totalidad del c√≥digo¬ª. No estoy de</p>
<p>acuerdo. Creo que existen casos para usar final , por ejemplo como constante</p>
<p>ocasional, pero en general, esta palabra clave apenas a√±ade valor y suele ser</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>un estorbo. Puede que lo piense porque el tipo de errores que puede capturar</p>
<p>final ya se capturan en las pruebas de unidad que he creado.</p>
<p>Las instrucciones if duplicadas [G5] del bucle for (l√≠neas 259 y 263) son</p>
<p>irrelevantes, de modo que las conect√© en una √∫nica instrucci√≥n if con el</p>
<p>operador || . Tambi√©n us√© la enumeraci√≥n Day para dirigir el bucle for</p>
<p>realic√© otros cambios est√©ticos.</p>
<p>Este m√©todo no pertenece realmente a DayDate . En realidad es la funci√≥n</p>
<p>de an√°lisis de Day . Por lo tanto, lo cambi√© a la enumeraci√≥n Day , lo que hizo</p>
<p>que aumentara considerablemente de tama√±o. Como el concepto de Day no</p>
<p>depende de DayDate , extraje la enumeraci√≥n Day de la clase DayDate a un</p>
<p>archivo propio [G13].</p>
<p>Tambi√©n cambi√© la siguiente funci√≥n, weekdayCodeToString (l√≠neas</p>
<p>272-286) a la enumeraci√≥n Day y le asign√© el nombre toString</p>
<p>public enum Day {</p>
<p>MONDAY(Calendar.MONDAY),</p>
<p>TUESDAY(Calendar.TUESDAY),</p>
<p>WEDNESDAY(Calendar.WEDNESDAY),</p>
<p>THURSDAY(Calendar.THURSDAY),</p>
<p>FRIDAY(Calendar.FRIDAY),</p>
<p>SATURDAY(Calendar.SATURDAY),</p>
<p>SUNDAY(Calendar.SUNDAY);</p>
<p>public final int index;</p>
<p>private static DateFormatSymbols dateSymbols = new DateFormatSymbols();</p>
<p>Day(int day) {</p>
<p>index = day;</p>
<p>public static Day make(int index) throws IllegalArgumentException {</p>
<p>for (Day d : Day.values())</p>
<p>if (d.index == index)</p>
<p>return d;</p>
<p>throw new IllegalArgumentException(</p>
<p>String.format(‚ÄúIllegal day index: %d.‚Äù, index));</p>
<p>public static Day parse(String s) throws IllegalArgumentException {</p>
<p>String[] shortWeekdayNames =</p>
<p>dateSymbols.getShortWeekdays();</p>
<p>String[] weekDayNames =</p>
<p>dateSymbols.getWeekdays();</p>
<p>s = s.trim();</p>
<p>for (Day day : Day.values()) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if (s.equalsIgnoreCase(shortWeekdayNames[day.index]) ||</p>
<p>s.equalsIgnoreCase(weekDayNames[day.index])) {</p>
<p>return day;</p>
<p>throw new IllegalArgumentException(</p>
<p>String.format(‚Äú%s is not a valid weekday string‚Äù, s));</p>
<p>public String toString() {</p>
<p>return dateSymbols.getWeekdays()[index];</p>
<p>Hay dos funciones getMonths (l√≠neas 288-316). La primera invoca la</p>
<p>segunda. La segunda solamente se invoca desde la primera. Por ello, las he</p>
<p>combinado en una y las he simplificado considerablemente [G9], [G12], [F4].</p>
<p>Por √∫ltimo, he cambiado el nombre por otro m√°s descriptivo [N1].</p>
<p>public static String[] getMonthNames() {</p>
<p>return dateFormatSymbols.getMonths();</p>
<p>La funci√≥n isValidMonthCode (l√≠neas 326-346) es ahora irrelevante</p>
<p>gracias a la enumeraci√≥n Month , de modo que la elimino [G9].</p>
<p>La funci√≥n monthCodeToQuarter (l√≠neas 356-375) parece sufrir envidia</p>
<p>[102]</p>
<p>de las caracter√≠sticas [G14] y seguramente pertenezca a la enumeraci√≥n</p>
<p>Month como m√©todo quarter , motivo por el que la sustituyo.</p>
<p>public int quarter() {</p>
<p>return 1 + (index-1)/3;</p>
<p>De este modo, la enumeraci√≥n Month tiene tama√±o suficiente como para</p>
<p>estar en una clase propia. La extraigo de DayDate para mantener la</p>
<p>coherencia con la enumeraci√≥n Day [G11], [G13].</p>
<p>Los dos siguientes m√©todos tienen el nombre monthCodeToString (l√≠neas</p>
<p>377-426). Vemos de nuevo que uno invoca al otro con un indicador. No es</p>
<p>recomendable pasar un indicador como argumento de una funci√≥n, en</p>
<p>especial si dicho indicador s√≥lo selecciona el formato del resultado [G15].</p>
<p>Por tanto, cambio de nombre, simplifico y reestructuro estas funciones y las</p>
<p>incluyo en la enumeraci√≥n Month [N1], [N3], [C3], [G14].</p>
<p>public String toString() {</p>
<p>return dateFormatSymbols.getMonths()[index - 1];</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public String toShortString() {</p>
<p>return dateFormatSymbols.getShortMonths()[index ‚Äì 1];</p>
<p>El siguiente m√©todo es stringToMonthCode (l√≠neas 428-472). Lo cambio</p>
<p>de nombre, lo paso a la enumeraci√≥n Month y lo simplifico [N1], [N3], [C3],</p>
<p>[G14], [G12].</p>
<p>public static Month parse(String s) {</p>
<p>s = s.trim();</p>
<p>for (Month m : Month.values())</p>
<p>if (m.matches(s))</p>
<p>return m;</p>
<p>try {</p>
<p>return make(Integer.parseInt(s));</p>
<p>catch (NumberFormatException e) {}</p>
<p>throw new IllegalArgumentException(‚ÄúInvalid month ‚Äù + s);</p>
<p>private boolean matches(String a) {</p>
<p>return s.equalsIgnoreCase(toString()) ||</p>
<p>s.equalsIgnoreCase(toShortString());</p>
<p>El m√©todo isLeapYear (l√≠neas 495-517) se puede modificar para que sea</p>
<p>m√°s expresivo [G16].</p>
<p>public static boolean isLeapYear(int year) {</p>
<p>boolean fourth = year % 4 == 0;</p>
<p>boolean hundredth = year % 100 == 0;</p>
<p>boolean fourHundredth = year % 400 == 0;</p>
<p>return fourth &amp;&amp; (!hundredth || fourHundredth);</p>
<p>La siguiente funci√≥n, leapYearCount (l√≠neas 519-536) no pertenece</p>
<p>realmente DayDate Nadie la invoca, excepto los dos m√©todos de</p>
<p>SpreadsheetDate , de modo que la desplazo hacia abajo [G6].</p>
<p>La funci√≥n lastDayOfMonth (l√≠neas 538-560) usa la matriz</p>
<p>LAST_DAY_OF_MONTH , que en realidad pertenece a la enumeraci√≥n Month</p>
<p>[G17], por lo que la cambio de ubicaci√≥n. Tambi√©n simplifico la funci√≥n y</p>
<p>aumento su expresividad [G16].</p>
<p>public static int lastDayOfMonth(Month month, int year) {</p>
<p>if (month == Month.FEBRUARY &amp;&amp; isLeapYear(year))</p>
<p>return month.lastDay() + 1;</p>
<p>else</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return month.lastDay();</p>
<p>Ahora empieza a ponerse interesante. La siguiente funci√≥n es addDays</p>
<p>(l√≠neas 562-576). En primer lugar, como opera en las variables de DayDate</p>
<p>no deber√≠a ser est√°tica [G18]. La cambio por un m√©todo de instancia. Por otra</p>
<p>parte, invoca la funci√≥n toSerial , cuyo nombre deber√≠amos cambiar por</p>
<p>toOrdinal [N1]. Por √∫ltimo, el m√©todo se puede simplificar.</p>
<p>public DayDate addDays(int days) {</p>
<p>return DayDateFactory.makeDate(toOrdinal() + days);</p>
<p>Lo mismo sucede con addMonths (l√≠neas 578-602). Deber√≠a ser un</p>
<p>m√©todo de instancia [G18]. El algoritmo es un tanto complicado, de modo</p>
<p>[103]</p>
<p>que recurro a la explicaci√≥n de variables temporales [G19] para que sea</p>
<p>m√°s transparente. Tambi√©n cambio el nombre del m√©todo getYYY por</p>
<p>getYear [N1].</p>
<p>public DayDate addMonths(int months) {</p>
<p>int thisMonthAsOrdinal = 12 * getYear() + getMonth().index - 1;</p>
<p>int resultMonthAsOrdinal = thisMonthAsOrdinal + months;</p>
<p>int resultYear = resultMonthAsOrdinal / 12;</p>
<p>Month resultMonth = Month.make(resultMonthAsOrdinal % 12 + 1);</p>
<p>int lastDayOfResultMonth = lastDayOfMonth(resultMonth, resultYear);</p>
<p>int resultDay = Math.min(getDayOfMonth(), lastDayOfResultMonth);</p>
<p>return DayDateFactory.makeDate(resultDay, resultMonth, resultYear);</p>
<p>La funci√≥n addYears (l√≠neas 604-626) es similar al resto.</p>
<p>public DayDate plusYears(int years) {</p>
<p>int resultYear = getYear() + years;</p>
<p>int lastDayOfMonthInResultYear = lastDayOfMonth(getMonth(), resultYear);</p>
<p>int resultDay = Math.min(getDayOfMonth(), lastDayOfMonthInResultYear);</p>
<p>return DayDateFactory.makeDate(resultDay, getMonth(), resultYear);</p>
<p>Hay algo que me preocupa sobre el cambio de estos m√©todos de est√°ticos</p>
<p>a m√©todos de instancia. ¬øLa expresi√≥n date.addDays(5) aclara que el objeto</p>
<p>date no cambia y que se devuelve una nueva instancia de DayDate o se</p>
<p>supone, equivocadamente, que se a√±aden cinco d√≠as al objeto date ? Pensar√°</p>
<p>que no es un gran problema, pero un fragmento de c√≥digo como el siguiente</p>
<p>puede ser muy enga√±oso [G20].</p>
<p>DayDate date = DateFactory.makeDate(5, Month.DECEMBER, 1952);</p>
<p>date.addDays(7); // desplazar la fecha una semana</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Un lector de este c√≥digo podr√≠a aceptar que addDays cambia el objeto</p>
<p>date , de modo que necesitamos un nombre que acabe con la ambig√ºedad</p>
<p>[N4]: plusDays plusMonths . Creo que la intenci√≥n del m√©todo se captura</p>
<p>correctamente por medio de</p>
<p>DayDate date = oldDate.plusDays(5);</p>
<p>mientras que el siguiente no transmite con fluidez al lector que el objeto</p>
<p>date ha cambiado:</p>
<p>date.plusDays(5);</p>
<p>Los algoritmos son cada vez m√°s interesantes. getPreviousDayOfWeek</p>
<p>(l√≠neas 628-660) funciona pero es complicado. Tras meditar en lo que suced√≠a</p>
<p>[G21], pude simplificarlo y aplicar la explicaci√≥n de variables temporales</p>
<p>[G19] para aclarar su significado. Tambi√©n lo cambi√© de m√©todo est√°tico a</p>
<p>m√©todo de instancia [G18] y me deshice del m√©todo de instancia duplicado</p>
<p>[G5] (l√≠neas 997-1008).</p>
<p>public DayDate getPreviousDayOfWeek(Day targetDayOfWeek) {</p>
<p>int offsetToTarget = targetDayOfWeek.index = getDayOfWeek().index;</p>
<p>if (offsetToTarget &gt;= 0)</p>
<p>offsetToTarget - 7;</p>
<p>return plusDays(offsetToTarget);</p>
<p>Sucede exactamente lo mismo con getFollowingDayOfWeek (l√≠neas</p>
<p>662-693).</p>
<p>public DayDate getFollowingDayOfWeek(Day targetDayOfWeek) {</p>
<p>int offsetToTarget = targetDayOfWeek.index - getDayOfWeek().index;</p>
<p>if (offsetToTarget &lt;= 0)</p>
<p>offsetToTarget += 7;</p>
<p>return plusDays(offsetToTarget);</p>
<p>La siguiente funci√≥n es getNearestDayOfWeek (l√≠neas 695-726), que</p>
<p>corregimos en un apartado anterior. Pero esos cambios no son coherentes con</p>
<p>el patr√≥n actual de las dos √∫ltimas funciones [G11]. Por ello, recurro a la</p>
<p>explicaci√≥n de variables temporales [G19] para aclarar el algoritmo.</p>
<p>public DayDate getNearestDayOfWeek(final Day targetDay) {</p>
<p>int offsetToThisWeeksTarget = targetDay.index - getDayOfWeek().index;</p>
<p>int offsetToFutureTarget = (offsetToThisWeeksTarget + 7) % 7;</p>
<p>int offsetToPreviousTarget = offsetToFutureTarget - 7;</p>
<p>if (offsetToFutureTarget &gt; 3)</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return plusDays(offsetToPreviousTarget);</p>
<p>else</p>
<p>return plusDays(offsetToFutureTarget);</p>
<p>El m√©todo getEndOfCurrentMonth (l√≠neas 728-740) es un tanto extra√±o</p>
<p>ya que es un m√©todo de instancia que envidia [G14] a su propia clase</p>
<p>aceptado un argumento DayDate . Lo convierto en un verdadero m√©todo de</p>
<p>instancia y clarifico algunos de los nombres.</p>
<p>public DayDate getEndOfMonth() {</p>
<p>Month month = getMonth();</p>
<p>int year = getYear();</p>
<p>int lastDay = lastDayOfMonth(month, year);</p>
<p>return DayDateFactory.makeDate(lastDay, month, year);</p>
<p>La refactorizaci√≥n de weekInMonthToString (l√≠neas 742-761) result√≥ ser</p>
<p>muy interesante. Mediante las herramientas de refactorizaci√≥n de mi IDE,</p>
<p>primero cambi√© el m√©todo a la enumeraci√≥n WeekInMonth creada antes y</p>
<p>despu√©s cambi√© el nombre por toString . Tras ello, lo convert√≠ en m√©todo de</p>
<p>instancia. Todas las pruebas fueron correctas (¬øadivina hacia d√≥nde nos</p>
<p>dirigimos?).</p>
<p>Seguidamente, elimin√© el m√©todo. Fallaron cinco afirmaciones (l√≠neas</p>
<p>411-415 del Listado B-4). Cambi√© estas l√≠neas para usar los nombres de los</p>
<p>enumeradores ( FIRST SECOND , etc.). Las pruebas fueron correctas. ¬øVe por</p>
<p>qu√©? ¬øPuede ver tambi√©n por qu√© son necesarios estos pasos? La herramienta</p>
<p>de refactorizaci√≥n se encarg√≥ de que los invocadores anteriores de</p>
<p>weekInMonthToString invocaran ahora toString en el enumerador</p>
<p>weekInMonth ya que todos los enumeradores implementan toString para</p>
<p>devolver sus nombres...</p>
<p>Desafortunadamente, me pas√© de listo. A pesar de la elegancia de la</p>
<p>cadena de refactorizaci√≥n, comprob√© que los √∫nicos usuarios de esta funci√≥n</p>
<p>eran las pruebas que acababa de modificar, de modo que las elimin√©. As√≠</p>
<p>pues, tras determinar que s√≥lo las pruebas invocaban relativeToString</p>
<p>(l√≠neas 765-781), elimin√© directamente la funci√≥n y sus pruebas.</p>
<p>Hemos llegado a los m√©todos abstractos de esta clase abstracta. Y el</p>
<p>primero es toSerial (l√≠neas 838-844). En un apartado anterior cambi√© el</p>
<p>nombre por toOrdinal . Al verlo en este contexto, decid√≠ que el cambio de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>nombre deber√≠a ser por getOrdinalDay . El siguiente m√©todo abstracto es</p>
<p>toDate (l√≠neas 838-844). Convierte DayDate en java.util.Date . ¬øPor qu√© es</p>
<p>abstracto? Si analizamos su implementaci√≥n en SpreadsheetDate (l√≠neas</p>
<p>198-207 del Listado B-5), vemos que no depende de la implementaci√≥n de</p>
<p>esa clase [G6]. Por tanto, lo desplazo hacia arriba.</p>
<p>Los m√©todos getYYYY getMonth getDayOfMonth son evidentemente</p>
<p>abstractos. Sin embargo, getDayOfWeek deber√≠a ascender desde</p>
<p>SpreadSheetDate ya que no depende de nada de lo que encontremos en</p>
<p>DayDate [G6]. ¬øO s√≠?</p>
<p>Si se fija atentamente (l√≠nea 247 del Listado B-5), ver√° que el algoritmo</p>
<p>depende impl√≠citamente del origen del d√≠a ordinal (es decir, el d√≠a de la</p>
<p>semana del d√≠a 0). Por ello, aunque esta funci√≥n carezca de dependencias</p>
<p>f√≠sicas que no se puedan cambiar a DayDate , cuenta con una dependencia</p>
<p>l√≥gica. Este tipo de dependencias l√≥gicas me molestan [G22]. Si algo l√≥gico</p>
<p>depende de la implementaci√≥n, tambi√©n deber√≠a haber algo f√≠sico. Adem√°s,</p>
<p>me parece que el propio algoritmo podr√≠a ser gen√©rico y que deber√≠a depender</p>
<p>en menor medida de la implementaci√≥n [G6]. Por tanto, cre√© un m√©todo</p>
<p>abstracto en DayDate con el nombre getDayOfWeekForOrdinalZero y lo</p>
<p>implement√© en SpreadsheetDate para devolver Day.SATURDAY . Tras ello,</p>
<p>envi√© el m√©todo getDayOfWeek DayDate y lo cambi√© para que invocara</p>
<p>getOrdinalDay getDayOfWeekForOrdinalZero</p>
<p>public Day getDayOfWeek() {</p>
<p>Day startingDay = getDayOfWeekForOrdinalZero();</p>
<p>int startingOffset = startingDay.index - Day.SUNDAY.index;</p>
<p>return Day.make((getOrdinalDay() + startingOffset) % 7 + 1);</p>
<p>F√≠jese en el comentario de las l√≠neas 895-899. ¬øNecesitamos realmente</p>
<p>esta repetici√≥n? Como de costumbre, elimin√© este comentario junto a los</p>
<p>dem√°s.</p>
<p>El siguiente m√©todo es compare (l√≠neas 902-913). De nuevo, es</p>
<p>incorrectamente abstracto [G6], por lo que cambio la implementaci√≥n a</p>
<p>DayDate . Adem√°s, el nombre no es descriptivo [N1]. En realidad, este</p>
<p>m√©todo devuelve la diferencia en d√≠as desde el argumento, por lo que cambi√©</p>
<p>el nombre por daysSince . Tampoco exist√≠an pruebas para este m√©todo, de</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>modo que las cre√©.</p>
<p>Las seis siguientes funciones (l√≠neas 915-980) son m√©todos abstractos que</p>
<p>deben implementarse en DayDate , por lo que las extraje de SpreadsheetDate</p>
<p>La √∫ltima funci√≥n, isInRange (l√≠neas 982-995), tambi√©n debe extraerse y</p>
<p>refactorizarse. La instrucci√≥n switch no es agradable [G23] y se puede</p>
<p>modificar si enviamos los casos a la enumeraci√≥n DateInterval</p>
<p>public enum DateInterval {</p>
<p>OPEN {</p>
<p>public boolean isIn(int d, int left, int right) {</p>
<p>return d &gt; left &amp;&amp; d &lt; right;</p>
<p>},</p>
<p>CLOSED_LEFT {</p>
<p>public boolean isIn(int d, int left, int right) {</p>
<p>return d &gt;= left &amp;&amp; d &lt; right;</p>
<p>},</p>
<p>CLOSED_RIGHT {</p>
<p>public boolean isIn(int d, int left, int right) {</p>
<p>return d &gt; left &amp;&amp; d &lt;= right;</p>
<p>},</p>
<p>CLOSED {</p>
<p>public boolean isIn(int d, int left, int right) {</p>
<p>return d &gt;= left &amp;&amp; d &lt;= right;</p>
<p>};</p>
<p>public abstract boolean isIn(int d, int left, int right);</p>
<p>public boolean isInRange(DayDate d1, DayDate d2, DateInterval interval) {</p>
<p>int left = Math.min(d1.getOrdinalDay(), d2.getOrdinalDay());</p>
<p>int right = Math.max(d1.getOrdinalDay(), d2.getOrdinalDay());</p>
<p>return interval.isIn(getOrdinalDay(), left, right);</p>
<p>Con esto llegamos al final de DayDate . Realizaremos una nueva pasada</p>
<p>por la clase completa para comprobar c√≥mo fluye. Primero, el comentario</p>
<p>inicial est√° desfasado, de modo que lo reduzco y lo mejoro [C2].</p>
<p>Tras ello, desplazo las enumeraciones restantes a sus propios archivos</p>
<p>[G12].</p>
<p>Seguidamente, desplazo la variable est√°tica ( dateFormatSymbols ) y tres</p>
<p>m√©todos est√°ticos ( getMonthNames isLeapYear lastDayOfMonth ) a una</p>
<p>nueva clase con el nombre DateUtil [G6].</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Cambio los m√©todos abstractos a una posici√≥n superior, donde pertenecen</p>
<p>[G24].</p>
<p>Cambio Month.make por Month.fromInt [N1] y repito la operaci√≥n con</p>
<p>las dem√°s enumeraciones. Tambi√©n creo un m√©todo de acceso toInt() para</p>
<p>todas las enumeraciones y convierto en privado el campo index</p>
<p>Se produce una interesante duplicaci√≥n [G5] en plusYears plusMonths</p>
<p>que consegu√≠ eliminar extrayendo un nuevo m√©todo con el nombre</p>
<p>correctLastDayOfMonth , lo que aclaraba el significado de los tres m√©todos.</p>
<p>Me deshice del n√∫mero m√°gico [G25] lo sustitu√≠ por</p>
<p>Month.JANUARY.toInt() Day.SUNDAY.toInt() , seg√∫n el caso. Me detuve</p>
<p>en limpiar los algoritmos de SpreadsheetDate . El resultado final se puede</p>
<p>comprobar en los listados B.7 a B.16.</p>
<p>El alcance del c√≥digo en DayDate se ha reducido al 84.9 por 100, no</p>
<p>porque se pruebe una cantidad menor de funcionalidad, sino porque la clase</p>
<p>se ha reducido tanto que las l√≠neas sin alcance tienen un peso mayor. Ahora,</p>
<p>en DayDate las pruebas se aplican a 45 de las 53 instrucciones ejecutables.</p>
<p>Las l√≠neas sin alcance son tan triviales que no merece la pena probarlas.</p>
<h3 id="conclusion-249">Conclusi√≥n</h3>
<p>Otra vez hemos aplicado la Regla del Boy Scout. Hemos entregado el c√≥digo</p>
<p>m√°s limpio de lo que lo recibimos. Nos ha llevado tiempo, pero ha merecido</p>
<p>la pena. El alcance de las pruebas ha aumentado, hemos corregido algunos</p>
<p>errores y hemos aclarado y reducido el tama√±o del c√≥digo. La pr√≥xima</p>
<p>persona que lo lea seguramente lo encontrar√° m√°s f√°cil de leer.</p>
<p>probablemente esa persona sea capaz de limpiarlo algo m√°s de lo que hemos</p>
<p>hecho nosotros.</p>
<h3 id="bibliografia-250">Bibliograf√≠a</h3>
<p>[GOF] Design Patterns: Elements of Reusable Object Oriented</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Software , Gamma et al., Addison-Wesley, 1996.</p>
<p>[Simmons04] Hardcore Java , Robert Simmons, Jr., O‚ÄôReilly, 2004.</p>
<p>[Refactoring] Refactoring: Improving the Design of Existing Code</p>
<p>Martin Fowler et al., Addison-Wesley, 1999.</p>
<p>[Beck97] Smalltalk Best Practice Patterns , Kent Beck, Prentice Hall,</p>
<p>1997.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="sintomas-y-heuristica-251">S√≠ntomas y heur√≠stica</h1>
<p>[104]</p>
<p>En su magn√≠fico libro Refactoring , Martin Fowler identifica diversos</p>
<p>s√≠ntomas de c√≥digo ( Smells ). La lista que mostramos a continuaci√≥n incluye</p>
<p>muchos de los s√≠ntomas de Martin y otros propios. Tambi√©n contiene otras</p>
<p>perlas y heur√≠stica que suelo emplear en mi trabajo.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Para compilar esta lista he examinado diversos programas y los he</p>
<p>refactorizado. Al aplicar un cambio, me preguntaba el por qu√© y anotaba el</p>
<p>motivo. El resultado es una extensa lista de aspectos que no me ¬´huelen¬ª</p>
<p>bien cuando leo c√≥digo.</p>
<p>La lista se debe leer de arriba a abajo, y tambi√©n se puede usar como</p>
<p>referencia.</p>
<h3 id="comentarios-252">Comentarios</h3>
<h3 id="c1-informacion-inapropiada-253">C1: Informaci√≥n inapropiada</h3>
<p>No es apropiado que un comentario contenga informaci√≥n que se pueda</p>
<p>almacenar en otro tipo de sistema como un sistema de control de c√≥digo</p>
<p>fuente, de seguimiento de problemas o de mantenimiento de registros. Los</p>
<p>historiales de cambios, por ejemplo, abarrotan los archivos de c√≥digo con</p>
<p>abundante texto sin inter√©s alguno. Por lo general, metadatos como autores,</p>
<p>fechas de modificaci√≥n, n√∫meros SPR y similares no deben aparecer en los</p>
<p>comentarios. Los comentarios deben reservarse para notas t√©cnicas sobre el</p>
<p>c√≥digo y el dise√±o.</p>
<h3 id="c2-comentario-obsoleto-254">C2: Comentario obsoleto</h3>
<p>Un comentario anticuado, irrelevante incorrecto es obsoleto. Los</p>
<p>comentarios envejecen r√°pidamente. Es recomendable no escribir un</p>
<p>comentario que vaya a quedar obsoleto. Si detecta un comentario obsoleto,</p>
<p>conviene actualizarlo eliminarlo lo antes posible. Los comentarios</p>
<p>obsoletos tienden a alejarse del c√≥digo que describ√≠an. Se convierten en islas</p>
<p>de irrelevancia y desorientaci√≥n en el c√≥digo.</p>
<h3 id="c3-comentario-redundante-255">C3: Comentario redundante</h3>
<p>Un comentario es redundante si describe algo que ya se define correctamente</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>por s√≠ mismo. Por ejemplo:</p>
<p>i++; // incrementar i</p>
<p>Otro ejemplo es un Javadoc que no dice m√°s (o incluso menos) que la</p>
<p>firma de una funci√≥n:</p>
<p>/**</p>
<ul>
<li>@param sellRequest</li>
<li>@return</li>
<li>@throws ManagedComponentException</li>
</ul>
<p>*/</p>
<p>public SellResponse beginSellItem(SellRequest sellRequest)</p>
<p>throws ManagedComponentException</p>
<p>Los comentarios deben comunicar lo que el c√≥digo no pueda expresar por</p>
<p>s√≠ mismo.</p>
<h3 id="c4-comentario-mal-escrito-256">C4: Comentario mal escrito</h3>
<p>Un comentario que merezca la pena escribir merece la pena ser le√≠do. Si</p>
<p>piensa escribir un comentario, aseg√∫rese de que es el mejor que puede crear.</p>
<p>Elija las palabras con atenci√≥n. Use gram√°tica y puntuaci√≥n correctas. No</p>
<p>divague. No afirme lo evidente. Sea breve.</p>
<h3 id="c5-codigo-comentado-257">C5: C√≥digo comentado</h3>
<p>Me molesta ver grandes fragmentos de c√≥digo comentado. ¬øQui√©n sabe qu√©</p>
<p>antig√ºedad tienen? ¬øQui√©n sabe si tiene sentido o no? Pero nadie lo borra</p>
<p>porque piensa que alguien m√°s lo necesita.</p>
<p>Ese c√≥digo se estanca y se corrompe, y cada d√≠a que pasa es menos</p>
<p>relevante. Invoca funciones que ya no existen. Usa variables cuyos nombres</p>
<p>han cambiado. Se rige por convenciones obsoletas. Contamina los m√≥dulos</p>
<p>en los que aparece y distrae a los usuarios que lo leen. El c√≥digo comentado</p>
<p>es una aberraci√≥n.</p>
<p>Cuando vea c√≥digo comentado, elim√≠nelo. No se preocupe, el sistema de</p>
<p>control de c√≥digo fuente lo recordar√°. Si alguien lo necesita, puede consultar</p>
<p>una versi√≥n anterior. No sufra el c√≥digo comentado para sobrevivir.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="entorno-258">Entorno</h3>
<h3 id="e1-la-generacion-requiere-mas-de-un-paso-259">E1: La generaci√≥n requiere m√°s de un paso</h3>
<p>La generaci√≥n de un proyecto deber√≠a ser una operaci√≥n sencilla. No deber√≠a</p>
<p>tener que comprobar demasiados elementos del control de c√≥digo fuente. No</p>
<p>deber√≠a necesitar una secuencia de antiguos comandos ni secuencias de</p>
<p>comandos dependientes del contexto para generar cada elemento. No deber√≠a</p>
<p>tener que buscar los distintos archivos JAR, XML y similares necesarios para</p>
<p>el sistema. Deber√≠a finalizar el sistema con un sencillo comando y despu√©s</p>
<p>ejecutar otro igual de sencillo para generarlo.</p>
<p>svn get mySystem</p>
<p>cd mySystem</p>
<p>ant all</p>
<h3 id="e2-las-pruebas-requieren-mas-de-un-paso-260">E2: Las pruebas requieren m√°s de un paso</h3>
<p>Deber√≠a poder ejecutar todas las pruebas de unidad con un solo comando. En</p>
<p>el mejor de los casos, deber√≠a poder ejecutarlas pulsando un bot√≥n de su IDE.</p>
<p>En el peor, deber√≠a poder ejecutar un √∫nico comando en una l√≠nea de</p>
<p>comandos. La capacidad de ejecutar todas las pruebas es tan importante que</p>
<p>debe ser algo r√°pido, sencillo y obvio.</p>
<h3 id="funciones-261">Funciones</h3>
<h3 id="f1-demasiados-argumentos-262">F1: Demasiados argumentos</h3>
<p>Las funciones deben tener un n√∫mero reducido de argumentos. Lo mejor es</p>
<p>que no tengan, seguido de uno, dos y tres argumentos. M√°s de tres ya es</p>
<p>cuestionable y deber√≠a evitarse (v√©ase el cap√≠tulo 3).</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="f2-argumentos-de-salida-263">F2: Argumentos de salida</h3>
<p>Los argumentos de salida son il√≥gicos. El lector espera que los argumentos</p>
<p>sean entradas, no salidas. Si su funci√≥n tiene que cambiar el estado de algo,</p>
<p>haga que cambie el estado del objeto en el que se invoca (v√©ase el cap√≠tulo 3).</p>
<h3 id="f3-argumentos-de-indicador-264">F3: Argumentos de indicador</h3>
<p>Los argumentos booleanos declaran abiertamente que la funci√≥n hace m√°s de</p>
<p>una cosa. Resultan confusos y deben eliminarse (v√©ase el cap√≠tulo 3).</p>
<h3 id="f4-funcion-muerta-265">F4: Funci√≥n muerta</h3>
<p>Los m√©todos que nunca se invocan deben descartarse. La presencia de c√≥digo</p>
<p>muerto es innecesaria. No tema eliminar la funci√≥n. Su sistema de control de</p>
<p>c√≥digo fuente la recordar√°.</p>
<h3 id="general-266">General</h3>
<h3 id="g1-varios-lenguajes-en-un-archivo-de-codigo-267">G1: Varios lenguajes en un archivo de c√≥digo</h3>
<p>Los modernos entornos de programaci√≥n actuales permiten incluir varios</p>
<p>lenguajes diferentes en el mismo archivo de c√≥digo. Por ejemplo, un archivo</p>
<p>de Java puede contener fragmentos de XML, HTML, YAML, JavaDoc,</p>
<p>JavaScript, y similares. Adem√°s de HTML, un archivo JSP podr√≠a incluir</p>
<p>Java, sintaxis de biblioteca de etiquetas, comentarios en espa√±ol, Javadoc,</p>
<p>XML, JavaScript, etc. Resulta confuso en el mejor de los casos y un desastre</p>
<p>en el peor.</p>
<p>Lo ideal ser√≠a que el archivo de c√≥digo incluyera un solo lenguaje pero,</p>
<p>en realidad, seguramente tendremos que usar m√°s de uno. Debemos intentar</p>
<p>minimizar la cantidad y el alcance de los lenguajes adicionales en nuestros</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>archivos de c√≥digo.</p>
<h3 id="g2-comportamiento-evidente-no-implementado-268">G2: Comportamiento evidente no implementado</h3>
<p>[105]</p>
<p>De acuerdo al Principio de la M√≠nima Sorpresa , una funci√≥n o clase debe</p>
<p>implementar los comportamientos que otro programador esperar√≠a. Por</p>
<p>ejemplo, imagine una funci√≥n que traduce el nombre de un d√≠a en una</p>
<p>enumeraci√≥n que represente dicho d√≠a.</p>
<p>Day day = DayDate.StringToDay(String dayName);</p>
<p>Esperar√≠amos que la cadena ¬´ Monday ¬ª se tradujera en Day.MONDAY.</p>
<p>Tambi√©n esperar√≠amos la traducci√≥n de las abreviaturas habituales y que la</p>
<p>funci√≥n ignorara may√∫sculas y min√∫sculas.</p>
<p>Cuando un comportamiento obvio no se implementa, los lectores y</p>
<p>usuarios del c√≥digo ya no dependen de su intuici√≥n sobre los nombres de las</p>
<p>funciones. Pierden su confianza en el autor original y se ven obligados a leer</p>
<p>los detalles del c√≥digo.</p>
<h3 id="g3-comportamiento-incorrecto-en-los-limites-269">G3: Comportamiento incorrecto en los l√≠mites</h3>
<p>Parece evidente afirmar que el c√≥digo debe comportarse de forma correcta. El</p>
<p>problema es que no nos damos cuenta de lo complicado que es dicho</p>
<p>comportamiento correcto. Los programadores suelen crear funciones que</p>
<p>esperan que funcionen y conf√≠an en su intuici√≥n m√°s que en comprobar que el</p>
<p>c√≥digo funciona en todos los casos de l√≠mites.</p>
<p>No existe sustituto para la meticulosidad. Las condiciones de l√≠mite, los</p>
<p>casos extremos, las excepciones, representan algo que puede confundir a un</p>
<p>algoritmo elegante e intuitivo. No dependa de su intuici√≥n . Busque todas las</p>
<p>condiciones de l√≠mite y cree pruebas para cada una.</p>
<h3 id="g4-medidas-de-seguridad-canceladas-270">G4: Medidas de seguridad canceladas</h3>
<p>Chernobyl se derriti√≥ porque el director de la central ignor√≥ todos y cada uno</p>
<p>de los mecanismos de seguridad. Imped√≠an que se realizara un experimento.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>El resultado fue que el experimento no sali√≥ bien y el mundo fue testigo de la</p>
<p>primera gran cat√°strofe nuclear para la poblaci√≥n.</p>
<p>Anular las medidas de seguridad es un riesgo. Puede que sea necesario</p>
<p>ejercer el control manual sobre serialVersionUID pero siempre es</p>
<p>arriesgado. La desactivaci√≥n de determinadas advertencias del compilador (o</p>
<p>de todas) puede ayudarle a conseguir la generaci√≥n, pero corre el riesgo de</p>
<p>sufrir interminables sesiones de depuraci√≥n. Desactivar las pruebas que fallan</p>
<p>y convencerse de que conseguir√° que despu√©s sean satisfactorias es tan</p>
<p>err√≥neo como pensar que sus tarjetas de cr√©dito son dinero gratuito.</p>
<h3 id="g5-duplicacion-271">G5: Duplicaci√≥n</h3>
<p>Una de las reglas m√°s importantes del libro y que debe tomarse muy en serio.</p>
<p>La pr√°ctica totalidad de los autores que escriben sobre dise√±o de software</p>
<p>mencionan esta regla. Dave Thomas y Andy Hunt la denominaron principio</p>
<p>[106]</p>
<p>DRY Don't Repeat Yourself , No repetirse). Kent Beck la convirti√≥ en</p>
<p>uno de los principios fundamentales de la programaci√≥n Extreme y la</p>
<p>denomin√≥ ¬´Una sola vez¬ª. Ron Jeffries sit√∫a esta regla en segunda posici√≥n,</p>
<p>por debajo de la consecuci√≥n satisfactoria de todas las pruebas.</p>
<p>Siempre que vea duplicados en el c√≥digo, indican una oportunidad de</p>
<p>abstracci√≥n fallida. La duplicaci√≥n podr√≠a convertirse en una subrutina o en</p>
<p>otra clase. Al incluir la duplicaci√≥n en una abstracci√≥n, aumenta el</p>
<p>vocabulario del lenguaje del dise√±o. Otros programadores pueden usar sus</p>
<p>creaciones abstractas. El c√≥digo se vuelve m√°s r√°pido y menos proclive a</p>
<p>errores ya que ha aumentado el nivel de abstracci√≥n.</p>
<p>El caso m√°s evidente de duplicaci√≥n es la presencia de fragmentos de</p>
<p>c√≥digo id√©ntico que parecen pegados repetidamente por el programador, sin</p>
<p>sentido. Conviene reemplazarlos por m√©todos simples.</p>
<p>Una forma m√°s sutil es la cadena switch/case if/else que aparece</p>
<p>repetidamente en diversos m√≥dulos que siempre prueba las mismas</p>
<p>condiciones. Conviene reemplazar estas cadenas por polimorfismo.</p>
<p>Y m√°s sutiles todav√≠a son los m√≥dulos con algoritmos similares pero que</p>
<p>no comparten las mismas l√≠neas de c√≥digo. Sigue siendo duplicaci√≥n y debe</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[107] [108]</p>
<p>corregirse por medio del patr√≥n de m√©todo de plantilla estrategia</p>
<p>En realidad, la mayor√≠a de patrones de dise√±o aparecidos en los √∫ltimos</p>
<p>15 a√±os son formas de eliminar la duplicaci√≥n. Las Formas normales de Codd</p>
<p>tambi√©n son una estrategia para eliminar la duplicaci√≥n en esquemas de base</p>
<p>de datos. Incluso la programaci√≥n orientada a objetos es una estrategia para</p>
<p>organizar m√≥dulos y eliminar la duplicaci√≥n. No deber√≠a sorprenderle, ya que</p>
<p>se trata de programaci√≥n estructurada. Creo que el objetivo es evidente:</p>
<p>localice los elementos duplicados y elim√≠nelos siempre que pueda.</p>
<h3 id="g6-codigo-en-un-nivel-de-abstraccion-incorrecto-272">G6: C√≥digo en un nivel de abstracci√≥n incorrecto</h3>
<p>Es importante crear abstracciones que separen conceptos generales de nivel</p>
<p>superior de conceptos detallados de nivel inferior. Para ello, en ocasiones</p>
<p>creamos clases abstractas que contengan los conceptos de nivel superior y</p>
<p>variantes los de nivel inferior. Si lo hacemos, debemos asegurarnos de que la</p>
<p>separaci√≥n sea completa. Todos los conceptos de nivel inferior deben estar en</p>
<p>las variantes y los de nivel superior en la clase base.</p>
<p>Por ejemplo, constantes, variables o funciones de utilidad que solamente</p>
<p>pertenezcan a la implementaci√≥n detallada no deben aparecer en la clase base.</p>
<p>La clase base no debe saber nada al respecto de estos elementos.</p>
<p>Esta regla tambi√©n se aplica a archivos fuente, componentes y m√≥dulos.</p>
<p>El dise√±o correcto de software requiere la separaci√≥n de conceptos en</p>
<p>distintos niveles y su inclusi√≥n en contenedores diferentes. En ocasiones,</p>
<p>dichos contenedores son clases base o variantes, y en otros casos son archivos</p>
<p>fuente, m√≥dulos o componentes. Independientemente del caso, la separaci√≥n</p>
<p>debe ser completa. No queremos que conceptos de nivel inferior y superior se</p>
<p>mezclen.</p>
<p>F√≠jese en este c√≥digo:</p>
<p>public interface Stack {</p>
<p>Object pop() throws EmptyException;</p>
<p>void push(Object o) throws FullException;</p>
<p>double percentFull();</p>
<p>class EmptyException extends Exception {}</p>
<p>class FullException extends Exception {}</p>
<p>La funci√≥n percentFull se encuentra en el nivel de abstracci√≥n</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>equivocado. Aunque hay implementaciones de Stack en las que el concepto</p>
<p>de amplitud es razonable, otras no pueden conocer su nivel de amplitud. Por</p>
<p>tanto, la funci√≥n deber√≠a incluirse en una interfaz derivada como</p>
<p>BoundedStack</p>
<p>Pensar√° que la implementaci√≥n podr√≠a devolver cero si la pila no tuviera</p>
<p>l√≠mites. El problema es que no existen pilas totalmente sin l√≠mites. No se</p>
<p>puede evitar OutOfMemoryException mediante la comprobaci√≥n de</p>
<p>stack.percentFull() &lt; 50.0.</p>
<p>La implementaci√≥n de esta funci√≥n para que devuelva 0 ser√≠a una mentira.</p>
<p>La moraleja es que no puede mentir o escapar de una abstracci√≥n mal</p>
<p>ubicada. El aislamiento de abstracciones es una de las operaciones m√°s</p>
<p>complicadas para los desarrolladores de software y no se puede corregir</p>
<p>cuando se realiza de forma incorrecta.</p>
<h3 id="g7-clases-base-que-dependen-de-sus-variantes-273">G7: Clases base que dependen de sus variantes</h3>
<p>El motivo m√°s habitual para dividir conceptos en clases base y derivadas es</p>
<p>para que los conceptos de nivel superior de la clase base sean independientes</p>
<p>de los de nivel inferior de las derivadas. Por ello, cuando vemos clases base</p>
<p>que mencionan los nombres de sus variantes, se intuye un problema. Por lo</p>
<p>general, las clases base no deben saber nada sobre su derivadas.</p>
<p>Evidentemente, hay excepciones. En ocasiones, el n√∫mero de variantes es</p>
<p>fijo y la clase base tiene c√≥digo que elegir entre las variantes. Es muy</p>
<p>habitual en implementaciones de equipos con estado finito. Sin embargo, en</p>
<p>ese caso las variantes y la clase base est√°n √≠ntimamente unidas y siempre se</p>
<p>implementan en el mismo archivo jar. En el caso general, deben</p>
<p>implementarse en archivos independientes.</p>
<p>Al implementar variantes y clases base en archivos diferentes y garantizar</p>
<p>que los archivos de la clase base desconocen el contenido de los archivos de</p>
<p>las variantes podemos implementar nuestros sistemas en componentes</p>
<p>discretos e independientes. Al modificar dichos componentes, se pueden</p>
<p>volver implementar sin necesidad de implementar de nuevo los</p>
<p>componentes base. De este modo se reduce significativamente el impacto del</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>cambio y se facilita el mantenimiento de los sistemas.</p>
<h3 id="g8-exceso-de-informacion-274">G8: Exceso de informaci√≥n</h3>
<p>Los m√≥dulos bien definidos tienen interfaces reducidas que nos permiten</p>
<p>hacer mucho con poco. Los m√≥dulos definidos de forma incorrecta tienen</p>
<p>interfaces m√°s amplias que nos obligan a usar distintos gestos para realizar</p>
<p>operaciones sencillas. Una interfaz bien definida no ofrece demasiadas</p>
<p>funciones y las conexiones son reducidas. Una interfaz definida de forma</p>
<p>incorrecta ofrece multitud de funciones que invocar y, por tanto, las</p>
<p>conexiones son elevadas. Los buenos programadores de software aprenden a</p>
<p>limitar la parte de sus clases y m√≥dulos que muestran en sus interfaces.</p>
<p>Cuantos menos m√©todos tenga una clase, mejor. Cuantas menos variables</p>
<p>conozca una funci√≥n, mejor. Cuantas menos variables de instancia tenga una</p>
<p>clase, mejor.</p>
<p>Oculte sus datos. Oculte sus funciones de utilidad. Oculte sus constantes</p>
<p>y elementos temporales. No cree clases con multitud de m√©todos y variables</p>
<p>de instancia. No cree multitud de variables y funciones protegidas para sus</p>
<p>subclases. Conc√©ntrese en crear interfaces concisas y de tama√±o reducido.</p>
<p>Limite la informaci√≥n para reducir las conexiones.</p>
<h3 id="g9-codigo-muerto-275">G9: C√≥digo muerto</h3>
<p>El c√≥digo muerto es el que no se ejecuta. Se encuentra en el cuerpo de una</p>
<p>instrucci√≥n if que comprueba una condici√≥n que no sucede. Se encuentra en</p>
<p>el bloque catch de una instrucci√≥n try que carece de throws . Se encuentra</p>
<p>en peque√±os m√©todos de utilidad que nunca se invocan o en condiciones</p>
<p>switch/case inexistentes.</p>
<p>El problema del c√≥digo muerto es que con el tiempo empieza a oler.</p>
<p>Cuanto m√°s antiguo es, m√°s profundo el hedor que despide. Se debe a que el</p>
<p>c√≥digo muerto no se actualiza al cambiar los dise√±os. Sigue compil√°ndose</p>
<p>pero no se rige por nuevas convenciones o reglas. Se cre√≥ en un momento en</p>
<p>el que el sistema era diferente . Debe tener un entierro digno. B√≥rrelo del</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>sistema.</p>
<h3 id="g10-separacion-vertical-276">G10: Separaci√≥n vertical</h3>
<p>Variables funciones deben definirse cerca de donde se utilicen. Las</p>
<p>variables locales deben declararse por encima de su primer uso y deben tener</p>
<p>un reducido √°mbito vertical. No deben declararse a cientos de l√≠neas de</p>
<p>distancia de su uso.</p>
<p>Las funciones privadas deben definirse justo debajo de su primer uso.</p>
<p>Pertenecen al √°mbito de la clase completa pero conviene limitar la distancia</p>
<p>vertical entre las invocaciones y las definiciones. Para localizar una funci√≥n</p>
<p>privada debe bastar con buscar debajo de su primer uso.</p>
<h3 id="g11-incoherencia-277">G11: Incoherencia</h3>
<p>Si hace algo de una forma concreta, aplique la misma t√©cnica a operaciones</p>
<p>similares. Esto entronca con el principio de m√≠nima sorpresa. Preste atenci√≥n</p>
<p>a las convenciones que elija y, una vez elegidas, aseg√∫rese de mantenerlas. Si</p>
<p>en una funci√≥n concreta usa la variable response para almacenar</p>
<p>HttpServletResponse , use el mismo nombre de variable en las dem√°s</p>
<p>funciones que usen objetos HttpServletResponse . Si asigna el nombre</p>
<p>processVerificationRequest a un m√©todo, use un nombre similar, como</p>
<p>processDeletionRequest , para los m√©todos que procesen otros tipos de</p>
<p>solicitudes.</p>
<p>Este tipo de coherencia, si se aplica repetidamente, facilita la lectura y</p>
<p>modificaci√≥n del c√≥digo.</p>
<h3 id="g12-desorden-278">G12: Desorden</h3>
<p>¬øPara qu√© sirve un constructor predeterminado sin implementaci√≥n?</p>
<p>√önicamente desordena el c√≥digo y lo inunda de elementos sin sentido.</p>
<p>Variables sin usar, funciones que nunca se invocan, comentarios que no</p>
<p>a√±aden informaci√≥n, etc. Todos estos elementos sobran y deben eliminarse.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Mantenga limpios sus archivos, bien organizados y sin elementos sobrantes.</p>
<h3 id="g13-conexiones-artificiales-279">G13: Conexiones artificiales</h3>
<p>Los elementos que no dependen unos de otros no deben conectarse de forma</p>
<p>artificial. Por ejemplo, las enumeraciones generales no deben incluirse en</p>
<p>clases m√°s espec√≠ficas ya que esto obliga a la aplicaci√≥n a saber m√°s sobre</p>
<p>dichas clases. Lo mismo sucede con funciones static de prop√≥sito general</p>
<p>declaradas en clases espec√≠ficas.</p>
<p>Por lo general, una conexi√≥n artificial es la que se establece entre dos</p>
<p>m√≥dulos sin un prop√≥sito directo. Es el resultado de incluir una variable,</p>
<p>constante o funci√≥n en una ubicaci√≥n temporalmente √∫til pero inadecuada. Es</p>
<p>un s√≠ntoma de falta de atenci√≥n.</p>
<p>Piense en d√≥nde debe declarar sus funciones, constantes y variables. No</p>
<p>las deje en el punto m√°s c√≥modo.</p>
<h3 id="g14-envidia-de-las-caracteristicas-280">G14: Envidia de las caracter√≠sticas</h3>
<p>[109]</p>
<p>Uno de los s√≠ntomas de Martin Fowler . Los m√©todos de una clase deben</p>
<p>interesarse por las variables y funciones de la clase a la que pertenecen, no</p>
<p>por las variables funciones de otras clases. Cuando un m√©todo usa</p>
<p>elementos de acceso y mutaci√≥n de otro objeto para manipular los datos de</p>
<p>√©ste, envidia el √°mbito de la clase de dicho objeto. Desea formar parte de la</p>
<p>otra clase para tener acceso directo a las variables que manipula.</p>
<p>Por ejemplo:</p>
<p>public class HourlyPayCalculator {</p>
<p>public Money calculateWeeklyPay(HourlyEmployee e) {</p>
<p>int tenthRate = e.getTenthRate().getPennies();</p>
<p>int tenthsWorked = e.getTenthsWorked();</p>
<p>int straightTime = Math.min(400, tenthsWorked);</p>
<p>int overTime = Math.max(0, tenthsWorked - straightTime);</p>
<p>int straightPay = straightTime * tenthRate;</p>
<p>int overtimePay = (int)Math.round(overTime*tenthRate*1.5);</p>
<p>return new Money(straightPay + overtimePay);</p>
<p>El m√©todo calculateWeeklyPay se acerca al objeto HourlyEmployee para</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>obtener los datos sobre los que opera. El m√©todo calculateWeeklyPay</p>
<p>envidia el √°mbito de HourlyEmployee Su deseo es formar parte de</p>
<p>HourlyEmployee</p>
<p>Es recomendable suprimir la envidia de caracter√≠sticas ya que muestra los</p>
<p>detalles internos de una clase a otra. Sin embargo, en ocasiones es un mal</p>
<p>necesario. F√≠jese en lo siguiente:</p>
<p>public class HourlyEmployeeReport {</p>
<p>private HourlyEmployee employee;</p>
<p>public HourlyEmployeeReport(HourlyEmployee e) {</p>
<p>this.employee = e;</p>
<p>String reportHours() {</p>
<p>return String.format(</p>
<p>‚ÄúName: %s\tHours:%d.%1d\n‚Äù,</p>
<p>employee.getName(),</p>
<p>employee.getTenthsWorked()/10,</p>
<p>employee.getTenthsWorked()%10);</p>
<p>Evidentemente, el m√©todo reportHours envidia la clase HourlyEmployee</p>
<p>Por otra parte, no queremos que HourlyEmployee tenga que conocer el</p>
<p>formato del informe. Al incluir la cadena de formato en la clase</p>
<p>HourlyEmployee incumplir√≠amos varios de los principios del dise√±o orientado</p>
<p>[110]</p>
<p>a objetos . Conectar√≠a HourlyEmployee al formato del informe y lo</p>
<p>mostrar√≠a en los cambios de dicho formato.</p>
<h3 id="g15-argumentos-de-selector-281">G15: Argumentos de selector</h3>
<p>No hay nada m√°s abominable que un argumento false aislado al final de la</p>
<p>invocaci√≥n de una funci√≥n. ¬øQu√© significa? ¬øQu√© cambiar√≠a si fuera true ? No</p>
<p>s√≥lo el prop√≥sito de un argumento de selector es dif√≠cil de recordar, sino que</p>
<p>cada argumento de selector combina varias funciones en una. Los argumentos</p>
<p>de selector son una forma indolente de evitar dividir una funci√≥n de gran</p>
<p>tama√±o en otras menores. F√≠jese en lo siguiente:</p>
<p>public int calculateWeeklyPay(boolean overtime) {</p>
<p>int tenthRate = getTenthRate();</p>
<p>int tenthsWorked = getTenthsWorked();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>int straightTime = Math.min(400, tenthsWorked);</p>
<p>int overTime = Math.max(0, tenthsWorked - straightTime);</p>
<p>int straightPay = straightTime * tenthRate;</p>
<p>double overtimeRate = overtime ? 1.5 : 1.0 * tenthRate;</p>
<p>int overtimePay = (int)Math.round(overTime*overtimeRate);</p>
<p>return straightPay + overtimePay;</p>
<p>Esta funci√≥n se invoca con true si las horas extras se pagan como hora y</p>
<p>media, y con false si se pagan como una hora normal. Ya es bastante malo</p>
<p>tener que recordar lo que significa calculateWeeklyPay(false) cada vez</p>
<p>que aparezca. Pero lo peor de esta funci√≥n es que el autor ha perdido la</p>
<p>oportunidad de crear lo siguiente:</p>
<p>public int straightPay() {</p>
<p>return getTenthsWorked() * getTenthRate();</p>
<p>public int overTimePay() {</p>
<p>int overTimeTenths = Math.max(0, getTenthsWorked() - 400);</p>
<p>int overTimePay = overTimeBonus(overTimeTenths);</p>
<p>return straightPay() + overTimePay;</p>
<p>private int overTimeBonus(int overTimeTenths) {</p>
<p>double bonus = 0.5 * getTenthRate() * overTimeTenths;</p>
<p>return (int) Math.round(bonus);</p>
<p>Evidentemente, los selectores no deben ser boolean Pueden ser</p>
<p>enumeraciones, enteros u otro tipo de argumento que se use para seleccionar</p>
<p>el comportamiento de la funci√≥n. Es m√°s recomendable tener varias</p>
<p>funciones que pasar c√≥digo una funci√≥n para seleccionar el</p>
<p>comportamiento.</p>
<h3 id="g16-intencion-desconocida-282">G16: Intenci√≥n desconocida</h3>
<p>Queremos que el c√≥digo sea lo m√°s expresivo posible. Expresiones extensas,</p>
<p>notaci√≥n H√∫ngara y n√∫meros m√°gicos distorsionan la intenci√≥n del autor. Por</p>
<p>ejemplo, veamos la funci√≥n overTimePay c√≥mo podr√≠a haber aparecido:</p>
<p>public int m_otCalc() {</p>
<p>return iThsWkd * iThsRte +</p>
<p>(int) Math.round(0.5 * iThsRte *</p>
<p>Math.max(0/ iThsWkd - 400)</p>
<p>);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Aunque parezca reducida densa, tambi√©n es pr√°cticamente</p>
<p>impenetrable. Es recomendable dedicar tiempo a lograr que la intenci√≥n de</p>
<p>nuestro c√≥digo sea aparente para nuestros lectores.</p>
<h3 id="g17-responsabilidad-desubicada-283">G17: Responsabilidad desubicada</h3>
<p>Una de las principales decisiones de un programador de software es d√≥nde</p>
<p>ubicar el c√≥digo. Por ejemplo, d√≥nde incluir la constante PI . ¬øEn la clase</p>
<p>Math ? ¬øPertenece a la clase Trigonometry ? ¬øO a la clase Circle</p>
<p>El principio de m√≠nima sorpresa vuelve a aparecer. El c√≥digo debe</p>
<p>ubicarse donde el lector espera encontrarlo. La constante PI debe incluirse</p>
<p>junto la declaraci√≥n de las funciones trigonom√©tricas. La constante</p>
<p>OVERTIME_RATE debe declararse en la clase HourlyPayCalculator</p>
<p>En ocasiones presumimos de d√≥nde a√±adimos una determinada</p>
<p>funcionalidad. Incluimos una funci√≥n porque nos resulta c√≥modo pero no</p>
<p>porque sea intuitivo para el lector. Por ejemplo, puede que tengamos que</p>
<p>imprimir un informe con el total de horas que ha trabajado un empleado.</p>
<p>Podr√≠amos sumar las horas en el c√≥digo que imprime el informe o intentar</p>
<p>mantener un total en el c√≥digo que acepte horarios de trabajo.</p>
<p>Una forma de tomar esta decisi√≥n consiste en analizar el nombre de las</p>
<p>funciones. Imagine que el m√≥dulo del informe tiene la funci√≥n</p>
<p>getTotalHours . Imagine tambi√©n que el m√≥dulo que acepta horarios de</p>
<p>trabajo tiene la funci√≥n saveTimeCard . ¬øCu√°l de las dos, por nombre, implica</p>
<p>que calcula el total? La respuesta es evidente.</p>
<p>Existen motivos de rendimiento para calcular el total como horarios de</p>
<p>trabajo y no como informe impreso. Es correcto, pero el nombre de las</p>
<p>funciones deber√≠a reflejarlo. Por ejemplo, deber√≠a haber una funci√≥n</p>
<p>computeRunningTotalOfHours en el m√≥dulo de horarios.</p>
<h3 id="g18-elementos-estaticos-incorrectos-284">G18: Elementos est√°ticos incorrectos</h3>
<p>Math.max (double a, double b) es un m√©todo est√°tico correcto. No opera</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>en una √∫nica instancia; de hecho, ser√≠a un error tener que usar new</p>
<p>Math().max(a,b) o incluso a.max(b) . Todos los datos que usa max provienen</p>
<p>de sus dos argumentos, no de un objeto. Adem√°s, es pr√°cticamente imposible</p>
<p>que queramos que Math.max sea polim√≥rfico. Sin embargo, en ocasiones</p>
<p>creamos funciones est√°ticas que no deben serlo. F√≠jese en este ejemplo:</p>
<p>HourlyPayCalculator.calculatePay(employee, overtimeRate).</p>
<p>De nuevo, parece una funci√≥n est√°tica razonable. No opera en un objeto</p>
<p>concreto y recibe todos los datos de sus argumentos. Sin embargo, existe la</p>
<p>posibilidad de que queramos que sea polim√≥rfica. Puede que queramos</p>
<p>implementar distintos algoritmos para calcular el precio de la hora, como por</p>
<p>ejemplo. OvertimeHourlyPayCalculator</p>
<p>StraightTimeHourlyPayCalculator . En este caso, la funci√≥n no debe ser</p>
<p>est√°tica. Deber√≠a ser una funci√≥n miembro no est√°tica de Employee</p>
<p>Por lo general, debe decantarse por m√©todos no est√°ticos. En caso de</p>
<p>duda, convierta la funci√≥n en no est√°tica. Si realmente quiere que una funci√≥n</p>
<p>sea est√°tica, aseg√∫rese de que nunca querr√° que sea polim√≥rfica.</p>
<h3 id="g19-usar-variables-explicativas-285">G19: Usar variables explicativas</h3>
<p>Kent Beck escribi√≥ sobre este tema en su magn√≠fico libro Smalltalk Best</p>
<p>[111] [112]</p>
<p>Practice Patterns y, m√°s recientemente en Implementation Patterns</p>
<p>Una de las t√©cnicas m√°s completas para que un programa sea legible consiste</p>
<p>en dividir los c√°lculos en valores intermedios almacenados en variables con</p>
<p>nombres descriptivos. F√≠jese en este ejemplo de FitNesse:</p>
<p>Matcher match = headerPattern.matcher(line);</p>
<p>if(match.find())</p>
<p>String key = match.group(1);</p>
<p>String value = match.group(2);</p>
<p>headers.put(key.toLowercase(), value);</p>
<p>El simple uso de variables explicativas ilustra con claridad que el primer</p>
<p>grupo comparado es la clave y el segundo es el valor</p>
<p>Es complicado excederse en esta t√©cnica. Por lo general, es mejor tener</p>
<p>m√°s variables explicativas que menos. Es sorprendente que un m√≥dulo opaco</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>se vuelva m√°s transparente con tan s√≥lo dividir los c√°lculos en valores</p>
<p>intermedios con los nombres adecuados.</p>
<h3 id="g20-los-nombres-de-funcion-deben-indicar-lo-que-286">G20: Los nombres de funci√≥n deben indicar lo que</h3>
<h3 id="hacen-287">hacen</h3>
<p>F√≠jese en este c√≥digo:</p>
<p>Date newDate = date.add(5);</p>
<p>¬øIntuye que se a√±aden cinco d√≠as a la fecha o son semanas u horas? ¬øLa</p>
<p>instancia date cambia y la funci√≥n simplemente devuelve un nuevo objeto</p>
<p>Date sin cambiar el antiguo? Por la invocaci√≥n no podemos saber qu√© hace</p>
<p>la funci√≥n</p>
<p>Si la funci√≥n a√±ade cinco d√≠as a la fecha y despu√©s la cambia, el nombre</p>
<p>deber√≠a ser addDaysTo increaseByDays . Si, por otra parte, la funci√≥n</p>
<p>devuelve una nueva fecha con cinco d√≠as m√°s pero no cambia la instancia</p>
<p>date , el nombre deber√≠a ser daysLater daysSince</p>
<p>Si tiene que fijarse en la implementaci√≥n (o documentaci√≥n) de la funci√≥n</p>
<p>para saber qu√© hace, tendr√° que elegir un nombre m√°s apropiado o modificar</p>
<p>la funcionalidad para que se pueda incluir en funciones con nombres m√°s</p>
<p>acertados.</p>
<h3 id="g21-comprender-el-algoritmo-288">G21: Comprender el algoritmo</h3>
<p>Se crea gran cantidad de c√≥digo extra√±o porque los autores no se esfuerzan en</p>
<p>comprender el algoritmo. Consiguen que algo funcione combinando</p>
<p>instrucciones if e indicadores sin pararse a pensar en qu√© sucede realmente.</p>
<p>La programaci√≥n es una tarea de exploraci√≥n. Creemos que conocemos el</p>
<p>algoritmo adecuado para algo pero despu√©s lo modificamos y variamos hasta</p>
<p>conseguir que funcione . ¬øC√≥mo sabemos que funciona ? Porque supera los</p>
<p>casos de prueba que pensamos.</p>
<p>No es un enfoque equivocado. De hecho, suele ser la √∫nica forma de</p>
<p>conseguir que una funci√≥n haga lo que pensamos que debe hacer. Sin</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>embargo, no basta con conseguir que funcione</p>
<p>Antes de creer que hemos terminado con una funci√≥n, aseg√∫rese de</p>
<p>entender su funcionamiento. No basta con que supere todas las pruebas.</p>
<p>[113]</p>
<p>Tiene que estar seguro de que la soluci√≥n es la correcta.</p>
<p>Por lo general, la forma √≥ptima de saberlo consiste en refactorizar la</p>
<p>funci√≥n en algo tan limpio y expresivo que su funcionamiento sea evidente</p>
<h3 id="g22-convertir-dependencias-logicas-en-fisicas-289">G22: Convertir dependencias l√≥gicas en f√≠sicas</h3>
<p>Si un m√≥dulo depende de otro, dicha dependencia debe ser f√≠sica, no s√≥lo</p>
<p>l√≥gica. El m√≥dulo dependiente no debe asumir aspectos (es decir,</p>
<p>dependencias l√≥gicas) sobre el m√≥dulo del que depende. Por el contrario,</p>
<p>debe solicitar de forma expl√≠cita al m√≥dulo toda la informaci√≥n de la que</p>
<p>depende.</p>
<p>Por ejemplo, imagine que tiene que crear una funci√≥n que imprima un</p>
<p>informe de las horas trabajadas por cada empleado. La clase HourlyReporter</p>
<p>recopila los datos y los pasa a HourlyReportFormatter para imprimirlos</p>
<p>(v√©ase el Listado 17-1).</p>
<p>Listado 17-1</p>
<p>HourlyReporter.java.</p>
<p>public class HourlyReporter {</p>
<p>private HourlyReportFormatter formatter;</p>
<p>private List&lt;LineItem&gt; page;</p>
<p>private final int PAGE_SIZE = 55;</p>
<p>public HourlyReporter(HourlyReportFormatter formatter) {</p>
<p>this.formatter = formatter;</p>
<p>page = new ArrayList&lt;LineItem&gt;();</p>
<p>public void generateReport(List&lt;HourlyEmployee&gt; employees) {</p>
<p>for (HourlyEmployee e : employees) {</p>
<p>addLineItemToPage(e);</p>
<p>if (page.size() == PAGE_SIZE)</p>
<p>printAndClearItemList();</p>
<p>if (page.size() &gt; 0)</p>
<p>printAndClearItemList();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private void printAndClearItemList() {</p>
<p>formatter.format(page);</p>
<p>page.clear();</p>
<p>private void addLineItemToPage(HourlyEmployee e) {</p>
<p>LineItem item = new LineItem();</p>
<p>item.name = e.getName();</p>
<p>item.hours = e.getTenthsWorked() / 10;</p>
<p>item.tenths = e.getTenthsWorked() % 10;</p>
<p>page.add(item);</p>
<p>public class LineItem {</p>
<p>public String name;</p>
<p>public int hours;</p>
<p>public int tenths;</p>
<p>Este c√≥digo tiene una dependencia l√≥gica que no se ha convertido en</p>
<p>f√≠sica. ¬øLa detecta? Es la constante PAGE_SIZE ¬øPara qu√© necesita</p>
<p>HourlyReporter saber el tama√±o de la p√°gina? El tama√±o de la p√°gina debe</p>
<p>ser responsabilidad de HourlyReportFormatter La declaraci√≥n de</p>
<p>PAGE_SIZE en HourlyReporter representa una responsabilidad desubicada</p>
<p>[G17] que hace que HourlyReporter asuma que conoce el tama√±o que debe</p>
<p>tener la p√°gina. Esta presunci√≥n es una dependencia l√≥gica. HourlyReporter</p>
<p>depende de que HourlyReportFormatter pueda procesar tama√±os de p√°gina</p>
<p>de hasta 55. Si alguna implementaci√≥n de HourlyReportFormatter no puede</p>
<p>asumir esos tama√±os, se producir√° un error. Podemos convertir en f√≠sica esta</p>
<p>dependencia si creamos un nuevo m√©todo en HourlyReportFormatter con el</p>
<p>nombre getMaxPageSize() . Tras ello, HourlyReporter invoca esta funci√≥n</p>
<p>en lugar de usar la constante PAGE_SIZE</p>
<h3 id="g23-polimorfismo-antes-que-ifelse-o-switchcase-290">G23: Polimorfismo antes que If/Else o Switch/Case</h3>
<p>Puede parecer una sugerencia extra√±a dado el tema descrito en el cap√≠tulo 6.</p>
<p>En este cap√≠tulo, afirmo que las instrucciones switch son adecuadas en partes</p>
<p>del sistema en las que se a√±adan m√°s funciones nuevas que tipos nuevos.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Por un lado, la mayor√≠a usamos instrucciones switch por ser una soluci√≥n</p>
<p>de fuerza bruta evidente, no por ser la soluci√≥n perfecta. Por tanto, esta</p>
<p>heur√≠stica nos recuerda que debemos considerar el uso de polimorfismo antes</p>
<p>de usar switch</p>
<p>Por otra parte, los casos en que las funciones son m√°s vol√°tiles que los</p>
<p>tipos son escasos. Por tanto, toda instrucci√≥n switch es sospechosa.</p>
<p>Suelo aplicar la siguiente regla de una instrucci√≥n switch No puede</p>
<p>haber m√°s de una instrucci√≥n switch por cada tipo de selecci√≥n. Los casos</p>
<p>de esa instrucci√≥n switch deben crear objetos polim√≥rficos que ocupen el</p>
<p>lugar de otras instrucciones switch similares en el resto del sistema</p>
<h3 id="g24-seguir-las-convenciones-estandar-291">G24: Seguir las convenciones est√°ndar</h3>
<p>Todos los equipos deben seguir un est√°ndar de dise√±o de c√≥digo basado en</p>
<p>normas comunes de la industria. Este est√°ndar debe especificar aspectos</p>
<p>como d√≥nde declarar variables de instancia, c√≥mo asignar nombres a clases,</p>
<p>m√©todos y variables, d√≥nde a√±adir llaves, etc. El equipo no debe necesitar un</p>
<p>documento que describa estas convenciones ya que su c√≥digo proporciona los</p>
<p>ejemplos.</p>
<p>Todos los miembros del equipo deben seguir estas convenciones, lo que</p>
<p>significa que no importa d√≥nde a√±ada cada uno las llaves mientras todos</p>
<p>est√©n de acuerdo en d√≥nde a√±adirlas.</p>
<p>Si desea saber qu√© convenciones aplico, puede verlas en el c√≥digo</p>
<p>refactorizado de los listados B.7 a B.14 del ap√©ndice B.</p>
<h3 id="g25-sustituir-numeros-magicos-por-constantes-con-292">G25: Sustituir n√∫meros m√°gicos por constantes con</h3>
<h3 id="nombre-293">nombre</h3>
<p>Es probablemente una de las reglas m√°s antiguas del desarrollo de software</p>
<p>Recuerdo haberla le√≠do a finales de la d√©cada de 1960 en manuales de</p>
<p>COBOL, FORTRAN y PL/1. Por lo general, no es recomendable incluir</p>
<p>n√∫meros sin procesar en el c√≥digo; debe ocultarlos tras constantes con</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>nombres correctos. Por ejemplo, el n√∫mero 86 400 debe ocultarse tras la</p>
<p>constante SECONDS_PER_DAY . Si va a imprimir 55 l√≠neas por p√°gina, la</p>
<p>constante 55 debe ocultarse tras la constante LINES_PER_PAGE</p>
<p>Algunas constantes son tan f√°ciles de reconocer que no siempre necesitan</p>
<p>una constante con nombre tras la que ocultarse mientras se usen junto a</p>
<p>c√≥digo explicativo. Por ejemplo:</p>
<p>double milesWalked = feetWalked/5280.0;</p>
<p>int dailyPay = hourlyRate * 8;</p>
<p>double circumference = radius * Math.PI * 2;</p>
<p>¬øNecesitamos realmente las constantes FEET_PER_MILE,</p>
<p>WORK_HOURS_PER_DAY TWO en los ejemplos anteriores? El √∫ltimo caso es</p>
<p>absurdo. Existen ciertas f√≥rmulas en las que las constantes se escriben mejor</p>
<p>como n√∫meros sin procesar. Puede cuestionar el caso de</p>
<p>WORK_HOURS_PER_DAY ya que las leyes o las convenciones pueden cambiar.</p>
<p>Por otra parte, esa f√≥rmula se lee perfectamente si se incluye el 8 por lo que</p>
<p>no es necesario a√±adir 17 m√°s. En el caso de FEET_PER_MILE , el n√∫mero 5280</p>
<p>es una constante tan conocida y exclusiva que los lectores la reconocer√°n</p>
<p>aunque se muestre de forma independiente en una p√°gina sin contexto</p>
<p>alguno.</p>
<p>Constantes como 3.141592653589793 tambi√©n son conocidas</p>
<p>reconocibles. Sin embargo, la probabilidad de errores es alta y no conviene</p>
<p>mostrarlas tal cual. Siempre que alguien ve 3.1415927535890793, sabe que</p>
<p>es œÄ, y no se molestan en examinarlo (¬øha visto el error de un d√≠gito?).</p>
<p>Tampoco queremos que la gente use 3.14, 3.14159, 3.142, y similares. Por lo</p>
<p>tanto, es una suerte contar con Math.PI</p>
<p>El t√©rmino n√∫mero m√°gico no s√≥lo se aplica a n√∫meros, sino a todo</p>
<p>s√≠mbolo que tenga un valor que no sea descriptivo por s√≠ mismo. Por ejemplo:</p>
<p>assertEquals(7777, Employee.find(‚ÄúJohn Doe‚Äù).employeeNumber());</p>
<p>En esta afirmaci√≥n hay dos n√∫meros m√°gicos. El primero es obviamente</p>
<p>7777, aunque no significa que no sea obvio. El segundo es ¬´ John Doe ¬ª y su</p>
<p>cometido tampoco est√° claro.</p>
<p>‚ÄúJohn Doe‚Äù es el nombre del empleado #7777 en una conocida base de</p>
<p>datos de pruebas creada por nuestro equipo. Todo el mundo sabe que al</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>conectarse a la base de datos, ya cuenta con varios empleados con sus valores</p>
<p>y atributos. Adem√°s, ¬´ John Doe ¬ª representa el √∫nico empleado por horas de</p>
<p>la base de datos. Por tanto, la prueba deber√≠a ser la siguiente:</p>
<p>assertEquals(</p>
<p>HOURLY_EMPLOYEE_ID,</p>
<p>Employee.find(HOURLY_EMPLOYEE_NAME).employeeNumber());</p>
<h3 id="g26-precision-294">G26: Precisi√≥n</h3>
<p>Esperar que la primera coincidencia de una consulta sea la √∫nica es una</p>
<p>ingenuidad. El uso de n√∫meros de coma flotante para representar divisas es</p>
<p>casi un delito. Evitar bloqueos y/o la administraci√≥n de transacciones por</p>
<p>creer que las actualizaciones concurrentes no son posibles es pura indolencia.</p>
<p>Declarar una variable como ArrayList cuando se necesita List es un exceso</p>
<p>de restricciones. Crear todas las variables como protected de forma</p>
<p>predeterminada es falta de restricciones.</p>
<p>Al adoptar una decisi√≥n en el c√≥digo, debe hacerlo de forma precisa.</p>
<p>Debe saber por qu√© la adopta y c√≥mo afrontar√° las excepciones. No sea</p>
<p>indolente sobre la precisi√≥n de sus decisiones. Si decide invocar una funci√≥n</p>
<p>que pueda devolver null , aseg√∫rese de comprobar null . Si consulta el que</p>
<p>considera el √∫nico registro de una base de datos, aseg√∫rese de que el c√≥digo</p>
<p>comprueba que no haya otros. Si tiene que trabajar con divisas, use</p>
<p>[114]</p>
<p>enteros y aplique el redondeo correcto. Si existe la posibilidad de una</p>
<p>actualizaci√≥n concurrente, aseg√∫rese de implementar alg√∫n tipo de</p>
<p>mecanismo de bloqueo.</p>
<p>En el c√≥digo, la ambig√ºedad y las imprecisiones son el resultado de</p>
<p>desacuerdos o de indolencia. En cualquier caso, elim√≠nelas.</p>
<h3 id="g27-estructura-sobre-convencion-295">G27: Estructura sobre convenci√≥n</h3>
<p>Aplique las decisiones de dise√±o con estructura y no convenciones. Las</p>
<p>convenciones de nomenclatura son correctas pero resultan inferiores</p>
<p>estructuras que refuerzan la compatibilidad. Por ejemplo, los casos switch</p>
<p>con enumeraciones de nombres correctos son inferiores a clases base con</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>m√©todos abstractos. No estamos obligados implementar siempre la</p>
<p>instrucci√≥n switch/case de la misma forma, pero las clases base hacen que</p>
<p>las clases concretas implementen m√©todos abstractos.</p>
<h3 id="g28-encapsular-condicionales-296">G28: Encapsular condicionales</h3>
<p>La l√≥gica booleana es dif√≠cil de entender sin necesidad de verla en el contexto</p>
<p>de una instrucci√≥n if while . Extraiga funciones que expliquen el cometido</p>
<p>de la condicional. Por ejemplo:</p>
<p>if (shouldBeDeleted(timer))</p>
<p>es preferible a</p>
<p>if (timer.hasExpired() &amp;&amp; !timer.isRecurrent())</p>
<h3 id="g29-evitar-condicionales-negativas-297">G29: Evitar condicionales negativas</h3>
<p>Las condicionales negativas son m√°s dif√≠ciles de entender que las positivas.</p>
<p>Por ello, siempre que sea posible, debe expresar las condiciones como</p>
<p>positivas. Por ejemplo:</p>
<p>if (buffer.shouldCompact())</p>
<p>es preferible a</p>
<p>if (!buffer.shouldNotCompact())</p>
<h3 id="g30-las-funciones-solo-deben-hacer-una-cosa-298">G30: Las funciones s√≥lo deben hacer una cosa</h3>
<p>Es tentador crear funciones con varias secciones que realicen una serie de</p>
<p>operaciones. Este tipo de funciones hacen m√°s de una cosa deben</p>
<p>convertirse en funciones de menor tama√±o, cada una para una cosa . Por</p>
<p>ejemplo:</p>
<p>public void pay() {</p>
<p>for (Employee e : employees) {</p>
<p>if (e.isPayday()) {</p>
<p>Money pay = e .calculatePay();</p>
<p>e.deliverPay(pay);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Este fragmento de c√≥digo realiza tres operaciones. Itera por todos los</p>
<p>empleados, comprueba si cada uno debe recibir su paga y despu√©s paga al</p>
<p>empleado. Se podr√≠a reescribir de esta forma:</p>
<p>public void pay() {</p>
<p>for (Employee e : employees)</p>
<p>payifNecessary(e);</p>
<p>private void payifNecessary(Employee e) {</p>
<p>if (e.isPayday())</p>
<p>calculateAndDeliverPay(e);</p>
<p>private void calculateAndDeliverPay(Employee e) {</p>
<p>Money pay = e.calculatePay();</p>
<p>e.deliverPay(pay);</p>
<p>Cada una de estas funciones hace una sola cosa (v√©ase el cap√≠tulo 3).</p>
<h3 id="g31-conexiones-temporales-ocultas-299">G31: Conexiones temporales ocultas</h3>
<p>Las conexiones temporales suelen ser necesarias pero no debe ocultar la</p>
<p>conexi√≥n. Estructure los argumentos de sus funciones de modo que el orden</p>
<p>de invocaci√≥n sea evidente. F√≠jese en lo siguiente:</p>
<p>public class MoogDiver {</p>
<p>Gradient gradient;</p>
<p>List&lt;Spline&gt; splines;</p>
<p>public void dive(String reason) {</p>
<p>saturateGradient();</p>
<p>reticulateSplines();</p>
<p>diveForMoog(reason);</p>
<p>...</p>
<p>El orden de las tres funciones es importante. Debe saturar el degradado</p>
<p>antes de poder entrelazar las tiras, para despu√©s continuar.</p>
<p>Desafortunadamente, el c√≥digo no aplica esta conexi√≥n temporal. Otro</p>
<p>programador podr√≠a invocar reticulateSplines antes de</p>
<p>saturateGradient , lo que generar√≠a UnsaturatedGradientException . Una</p>
<p>soluci√≥n m√°s acertada ser√≠a:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public class MoogDiver {</p>
<p>Gradient gradient;</p>
<p>List&lt;Spline&gt; splines;</p>
<p>public void dive(String reason) {</p>
<p>Gradient gradient = saturateGradient();</p>
<p>List&lt;Spline&gt; splines = reticulateSplines(gradient);</p>
<p>diveForMoog(splines, reason);</p>
<p>...</p>
<p>De este modo se muestra la conexi√≥n temporal generando una especie de</p>
<p>embudo. Cada funci√≥n genera un resultado que la siguiente necesita de modo</p>
<p>que no se pueden invocar en otro orden.</p>
<p>Puede argumentar que esto aumenta la complejidad de las funciones y</p>
<p>tiene raz√≥n, pero ese incremento de complejidad sint√°ctica muestra la</p>
<p>verdadera complejidad temporal de la situaci√≥n.</p>
<p>Observar√° que he mantenido las variables de instancia. Imagino que son</p>
<p>necesarias para los m√©todos privados de las clases. Incluso as√≠, conservo los</p>
<p>argumentos para que la conexi√≥n temporal sea expl√≠cita.</p>
<h3 id="g32-evitar-la-arbitrariedad-300">G32: Evitar la arbitrariedad</h3>
<p>Argumente la estructura de su c√≥digo y aseg√∫rese de que la estructura del</p>
<p>c√≥digo comunica dicho argumento. Si la estructura parece arbitraria, otros se</p>
<p>ver√°n con derecho a modificarla.</p>
<p>Si la estructura parece coherente en la totalidad del sistema, otros la</p>
<p>usar√°n y conservar√°n la convenci√≥n. Por ejemplo, recientemente repasaba</p>
<p>cambios realizados en FitNesse y descubr√≠ lo siguiente:</p>
<p>public class AliasLinkWidget extends ParentWidget</p>
<p>public static class VariableExpandingWidgetRoot {</p>
<p>...</p>
<p>...</p>
<p>El problema es que VariableExpandingWidgetRoot no deb√≠a estar en el</p>
<p>√°mbito de AliasLinkWidget Es m√°s, otras clases sin relaci√≥n usaban</p>
<p>AliasLinkWidget.VariableExpandingWidgetRoot y no ten√≠an por qu√© saber</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>nada de AliasLinkWidget Puede que el programador a√±adiera</p>
<p>VariableExpandingWidgetRoot AliasWidget por comodidad que</p>
<p>realmente pensara que deb√≠a formar parte del √°mbito de AliasWidget</p>
<p>Independientemente del motivo, el resultado ser√° arbitrario. Las clases</p>
<p>p√∫blicas que no son utilidades de otra clase no deben incluirse en el √°mbito</p>
<p>de otra clase. La convenci√≥n es convertirlas en p√∫blicas en el nivel superior</p>
<p>de su paquete.</p>
<h3 id="g33-encapsular-condiciones-de-limite-301">G33: Encapsular condiciones de l√≠mite</h3>
<p>Las condiciones de l√≠mite son dif√≠ciles de controlar. A√≠sle su procesamiento y</p>
<p>no permita que se transfieran al resto del c√≥digo. No necesitamos legiones de</p>
<p>+1 -1 por todas partes. F√≠jese en este ejemplo de FIT:</p>
<p>if (level + 1 &lt; tags.length)</p>
<p>parts = new Parse(body, tags, level + 1, offset + endTag);</p>
<p>body = null;</p>
<p>level+1 aparece dos veces. Es una condici√≥n de l√≠mite que debe</p>
<p>encapsularse en una variable con un nombre como nextLevel</p>
<p>int nextLevel = level + 1;</p>
<p>if(nextLevel &lt; tags.length) {</p>
<p>parts = new Parse(body, tags, nextLevel, offset + endTag);</p>
<p>body = null;</p>
<h3 id="g34-las-funciones-solo-deben-descender-un-nivel-de-302">G34: Las funciones s√≥lo deben descender un nivel de</h3>
<h3 id="abstraccion-303">abstracci√≥n</h3>
<p>Las instrucciones de una funci√≥n deben crearse en el mismo nivel de</p>
<p>abstracci√≥n, un nivel por debajo de la operaci√≥n descrita por el nombre de la</p>
<p>funci√≥n. Puede que sea la heur√≠stica m√°s dif√≠cil de interpretar y aplicar.</p>
<p>Aunque la idea es simple, como humanos nos cuesta mezclar niveles de</p>
<p>abstracci√≥n. F√≠jese en el siguiente c√≥digo de FitNesse:</p>
<p>public String render() throws Exception</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>StringBuffer html = new StringBuffer(‚Äú&lt;hr‚Äù);</p>
<p>if(size &gt; 0)</p>
<p>html.append(‚Äú size=\‚Äú‚Äù).append(size + 1).append(‚Äú\‚Äù‚Äù);</p>
<p>html.append(‚Äú&gt;‚Äù);</p>
<p>return html.toString();</p>
<p>Si lo analiza, ver√° lo que sucede. Esta funci√≥n crea la etiqueta HTML que</p>
<p>traza una regla horizontal por la p√°gina. La altura de la regla se especifica en</p>
<p>la variable size</p>
<p>F√≠jese otra vez en el c√≥digo. Este m√©todo mezcla al menos dos niveles de</p>
<p>abstracci√≥n. El primero es la noci√≥n de que una regla horizontal tiene un</p>
<p>tama√±o. El segundo es la sintaxis de la propia etiqueta HR . El c√≥digo proviene</p>
<p>del m√≥dulo HruleWidget de FitNesse. Este m√≥dulo detecta una fila de cuatro</p>
<p>o m√°s guiones y la convierte en la correspondiente etiqueta HR . Cuantos m√°s</p>
<p>guiones haya, mayor ser√° el tama√±o.</p>
<p>A continuaci√≥n le muestro la refactorizaci√≥n del c√≥digo. He cambiado el</p>
<p>nombre del campo size para reflejar su verdadero cometido. Conten√≠a el</p>
<p>n√∫mero de guiones adicionales.</p>
<p>public String render() throws Exception</p>
<p>HtmlTag hr = new HtmlTag(‚Äúhr‚Äù);</p>
<p>if (extraDashes &gt; 0)</p>
<p>hr.addAttribute(‚Äúsize‚Äù, hrSize(extraDashes));</p>
<p>return hr.html();</p>
<p>private String hrSize(int height)</p>
<p>int hrSize = height + 1;</p>
<p>return String.format(‚Äú%d‚Äù, hrSize);</p>
<p>Este cambio separa correctamente los dos niveles de abstracci√≥n. La</p>
<p>funci√≥n render simplemente crea una etiqueta HR sin tener que saber nada</p>
<p>sobre su sintaxis HTML. El m√≥dulo HtmlTag se encarga de los problemas</p>
<p>sint√°cticos.</p>
<p>De hecho, al realizar este cambio detect√© un sutil error. El c√≥digo original</p>
<p>no inclu√≠a la barra final en la etiqueta HR , como har√≠a el est√°ndar XHTML (es</p>
<p>decir, generaba &lt;hr&gt; en lugar de &lt;hr/&gt; ). El m√≥dulo HtmlTag se hab√≠a</p>
<p>modificado hace tiempo para ajustarlo a XHTML.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>La separaci√≥n de niveles de abstracci√≥n es una de las tareas m√°s</p>
<p>importantes de la refactorizaci√≥n, y tambi√©n una de las m√°s complejas. Por</p>
<p>ejemplo, f√≠jese en el siguiente c√≥digo. Fue mi primer intento de separar los</p>
<p>niveles de abstracci√≥n del m√©todo HruleWidget.render</p>
<p>public String render() throws Exception</p>
<p>HtmlTag hr = new HtmlTag(‚Äúhr‚Äù);</p>
<p>if (size &gt; 0) {</p>
<p>hr.addAttribute (‚Äúsize‚Äù, ‚Äú‚Äù+(size+1));</p>
<p>return hr.html();</p>
<p>Mi objetivo, en esta fase, es crear la separaci√≥n necesaria y conseguir</p>
<p>superar las pruebas. El objetivo lo alcanc√© f√°cilmente pero el resultado fue</p>
<p>una funci√≥n con niveles de abstracci√≥n mezclados. En este caso, fueron obra</p>
<p>de la etiqueta HR y de la interpretaci√≥n y el formato de la variable size. Esto</p>
<p>indica que al dividir una funci√≥n en l√≠neas de abstracci√≥n, suelen aparecer</p>
<p>nuevas l√≠neas de abstracci√≥n ocultas por la estructura anterior.</p>
<h3 id="g35-mantener-los-datos-configurables-en-los-nivele-304">G35: Mantener los datos configurables en los niveles</h3>
<h3 id="superiores-305">superiores</h3>
<p>Si tiene una constante como un valor predeterminado o de configuraci√≥n que</p>
<p>se conoce y se espera en un nivel superior de abstracci√≥n, no debe sepultarla</p>
<p>en una funci√≥n de nivel inferior. Mu√©strela como argumento para esa funci√≥n</p>
<p>de nivel inferior invocado desde la funci√≥n de nivel superior. F√≠jese en este</p>
<p>ejemplo de FitNesse:</p>
<p>public static void main(String[] args) throws Exception</p>
<p>Arguments arguments = parseCommandLine(args);</p>
<p>...</p>
<p>public class Arguments</p>
<p>public static final String DEFAULT_PATH = ‚Äú.‚Äù;</p>
<p>public static final String DEFAULT_ROOT = ‚ÄúFitNesseRoot‚Äù;</p>
<p>public static final int DEFAULT_PORT = 80;</p>
<p>public static final int DEFAULT_VERSION_DAYS = 14;</p>
<p>...</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Los argumentos de l√≠nea de comandos se analizan en la primera l√≠nea</p>
<p>ejecutable de FitNesse. Los valores predeterminados de dichos argumentos se</p>
<p>especifican al inicio de la clase Argument . No tiene que buscar instrucciones</p>
<p>como la siguiente en los niveles inferiores del sistema:</p>
<p>if (arguments.port == 0) // usar 80 de forma predeterminada</p>
<p>Las constantes de configuraci√≥n se encuentran en un nivel superior y son</p>
<p>f√°ciles de cambiar. Se pasan al resto de la aplicaci√≥n. Los niveles inferiores</p>
<p>de la aplicaci√≥n no poseen los valores de estas constantes.</p>
<h3 id="g36-evitar-desplazamientos-transitivos-306">G36: Evitar desplazamientos transitivos</h3>
<p>Por lo general, no es recomendable que un m√≥dulo sepa demasiado sobre sus</p>
<p>colaboradores. En concreto, si A colabora con B y B con C, no queremos que</p>
<p>los m√≥dulos que usan A sepan nada sobre C (por ejemplo, o queremos</p>
<p>a.getB().getC().doSomething(); ).</p>
<p>Es lo que en ocasiones se denomina Ley de Demeter. Los programadores</p>
<p>[115]</p>
<p>pragm√°ticos lo denominan Crear c√≥digo silencioso . En cualquier caso, se</p>
<p>trata de garantizar que los m√≥dulos s√≥lo tienen conocimiento de sus</p>
<p>colaboradores inmediatos y no del mapa de navegaci√≥n completo del sistema.</p>
<p>Si varios m√≥dulos usan alguna variante de la instrucci√≥n a.getB().getC()</p>
<p>ser√≠a complicado cambiar el dise√±o y la arquitectura para intercalar Q entre</p>
<p>B y C. Tendr√≠a que localizar todas las instancias de a.getB().getC()</p>
<p>convertirlas a a.getB().getQ().getC() . Es la forma en que las arquitecturas</p>
<p>se vuelven r√≠gidas. Demasiados m√≥dulos saben demasiado sobre la</p>
<p>arquitectura. Por el contrario, queremos que nuestros colaboradores</p>
<p>intermedios ofrezcan todos los servicios que necesitamos. No debemos</p>
<p>deambular por el gr√°fico de objetos del sistema en busca del m√©todo que</p>
<p>necesitamos invocar. Bastar√≠a con poder usar:</p>
<p>myCollaborator.doSomething().</p>
<h3 id="java-307">Java</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="j1-evitar-extensas-listas-de-importacion-mediante--308">J1: Evitar extensas listas de importaci√≥n mediante el</h3>
<h3 id="uso-de-comodines-309">uso de comodines</h3>
<p>Si usa dos o m√°s clases de un paquete, importe el paquete completo con</p>
<p>import package.*;</p>
<p>Las listas extensas de importaciones intimidan al lector. No queremos</p>
<p>colapsar la parte superior de los m√≥dulos con 80 l√≠neas de importaciones, sino</p>
<p>que sean una instrucci√≥n concisa de los paquetes con los que colaboramos.</p>
<p>Las importaciones espec√≠ficas son dependencias r√≠gidas, mientras que las</p>
<p>importaciones de comod√≠n no. Si importa una clase concreta, esa clase debe</p>
<p>existir, pero si importa un paquete con un comod√≠n, no es necesario que</p>
<p>existan clases concretas. La instrucci√≥n de importaci√≥n simplemente a√±ade el</p>
<p>paquete a la ruta de b√∫squeda al localizar los nombres. Por tanto, no se</p>
<p>genera una verdadera dependencia en estas importaciones y permiten aligerar</p>
<p>las conexiones de nuestros m√≥dulos. En ocasiones, la lista extensa de</p>
<p>importaciones puede resultar √∫til. Por ejemplo, si tiene que trabajar con</p>
<p>c√≥digo de legado y desea saber para qu√© clases crear elementos ficticios,</p>
<p>puede examinar la lista de importaciones concretas para determinar los</p>
<p>verdaderos nombres cualificados de todas esas clases y despu√©s a√±adirlos. No</p>
<p>obstante, este uso de las importaciones concretas no es habitual. Es m√°s,</p>
<p>muchos IDE modernos le permiten convertir las importaciones con</p>
<p>comodines en una lista de importaciones concretas con un solo comando. Por</p>
<p>tanto, incluso en el caso anterior, es recomendable usar comodines. Las</p>
<p>importaciones de comod√≠n pueden probar conflictos de nombres</p>
<p>ambig√ºedades. Dos clases con el mismo nombre pero en paquetes diferentes</p>
<p>tienen que importarse de forma concreta o al menos cualificarse de forma</p>
<p>espec√≠fica cuando se usen. Puede resultar molesto pero no es habitual que el</p>
<p>uso de importaciones de comod√≠n sea m√°s indicado que el de importaciones</p>
<p>concretas.</p>
<h3 id="j2-no-heredar-constantes-310">J2: No heredar constantes</h3>
<p>Lo he visto muchas veces y siempre me molesta. Un programador a√±ade</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>constantes a una interfaz y despu√©s accede a las mismas heredando dicha</p>
<p>interfaz. F√≠jese en el siguiente c√≥digo:</p>
<p>public class HourlyEmployee extends Employee {</p>
<p>private int tenthsWorked;</p>
<p>private double hourlyRate;</p>
<p>public Money calculatePay() {</p>
<p>int straightTime = Math.min(tenthsWorked, TENTHS_PER_WEEK);</p>
<p>int overTime = tenthsWorked - straightTime;</p>
<p>return new Money(</p>
<p>hourlyRate * (tenthsWorked + OVERTIME_RATE * overTime)</p>
<p>);</p>
<p>...</p>
<p>¬øDe d√≥nde salen las constantes TENTHS_PER_WEEK OVERTIME_RATE</p>
<p>Puede que provengan de la clase Employee ; comprob√©moslo:</p>
<p>public abstract class Employee implements PayrollConstants {</p>
<p>public abstract boolean isPayday();</p>
<p>public abstract Money calculatePay();</p>
<p>public abstract void deliverPay(Money pay);</p>
<p>No, de ah√≠ no. ¬øEntonces de d√≥nde? F√≠jese atentamente en la clase</p>
<p>Employee . Implementa PayrollConstants</p>
<p>public interface PayrollConstants {</p>
<p>public static final int TENTHS_PER_WEEK = 400;</p>
<p>public static final double OVERTIME_RATE = 1.5;</p>
<p>Es horrible. Las constantes se ocultan en la parte superior de la jerarqu√≠a</p>
<p>de herencia. No use la herencia para burlar las reglas de √°mbito del lenguaje.</p>
<p>Use una importaci√≥n est√°tica:</p>
<p>import static PayrollConstants.*;</p>
<p>public class HourlyEmployee extends Employee {</p>
<p>private int tenthsWorked;</p>
<p>private double hourlyRate;</p>
<p>public Money calculatePay() {</p>
<p>int straightTime = Math.min(tenthsWorked, TENTHS_PER_WEEK);</p>
<p>int overTime = tenthsWorked - straightTime;</p>
<p>return new Money(</p>
<p>hourlyRate * (tenthsWorked + OVERTIME_RATE * overTime)</p>
<p>);</p>
<p>...</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="j3-constantes-frente-a-enumeraciones-311">J3: Constantes frente a enumeraciones</h3>
<p>Ahora que se han a√±adido enumeraciones al lenguaje (Java 5), ¬°√∫selas! No</p>
<p>recurra al viejo truco de public static final int . El significado de int se</p>
<p>puede perder. El de enum no, ya que pertenece a una enumeraci√≥n con</p>
<p>nombre.</p>
<p>Es m√°s, analice atentamente la sintaxis de las enumeraciones . Pueden</p>
<p>tener m√©todos y campos, lo que las convierte en potentes herramientas que</p>
<p>ofrecen mayor expresividad y flexibilidad que los int . F√≠jese en esta variante</p>
<p>del c√≥digo:</p>
<p>public class HourlyEmployee extends Employee {</p>
<p>private int tenthsWorked;</p>
<p>HourlyPayGrade grade;</p>
<p>public Money calculatePay() {</p>
<p>int straightTime = Math.min(tenthsWorked, TENTHS_PER_WEEK);</p>
<p>int overTime = tenthsWorked - straightTime;</p>
<p>return new Money(</p>
<p>grade.rate() * (tenthsWorked + OVERTIME_RATE * overTime)</p>
<p>);</p>
<p>...</p>
<p>public enum HourlyPayGrade {</p>
<p>APPRENTICE {</p>
<p>public double rate() {</p>
<p>return 1.0;</p>
<p>},</p>
<p>LEUTENANT_JOURNEYMAN (</p>
<p>public double rate() {</p>
<p>return 1.2;</p>
<p>},</p>
<p>JOURNEYMAN {</p>
<p>public double rate() {</p>
<p>return 1.5;</p>
<p>},</p>
<p>MASTER {</p>
<p>public double rate() {</p>
<p>return 2.0;</p>
<p>};</p>
<p>public abstract double rate();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="nombres-312">Nombres</h3>
<h3 id="n1-elegir-nombres-descriptivos-313">N1: Elegir nombres descriptivos</h3>
<p>No sea demasiado r√°pido a la hora de elegir un nombre. Aseg√∫rese de que sea</p>
<p>descriptivo. Recuerde que los significados suelen variar cuando el c√≥digo</p>
<p>evoluciona, de modo que debe revisar frecuentemente la correcci√≥n de los</p>
<p>nombres elegidos.</p>
<p>No es una recomendaci√≥n de sensaciones. En software , los nombres</p>
<p>constituyen el 90 por 100 de su legibilidad. Dedique tiempo a seleccionarlos</p>
<p>con atenci√≥n mantenga su relevancia. Los nombres son demasiado</p>
<p>importantes como para tratarlos mal.</p>
<p>F√≠jese en el siguiente c√≥digo. ¬øPara qu√© sirve? Si le muestro el mismo</p>
<p>c√≥digo con nombres bien elegidos, tendr√° sentido, pero con este formato no</p>
<p>es m√°s que una masa de s√≠mbolos y n√∫meros m√°gicos.</p>
<p>public int x() {</p>
<p>int q = 0;</p>
<p>int z = 0;</p>
<p>for (int kk = 0; kk &lt; 10; kk++) {</p>
<p>if (l[z] == 10)</p>
<p>q += 10 + (l[z + 1] + l[z + 2]);</p>
<p>z += 1;</p>
<p>else if (l[z] + l[z + 1] == 10)</p>
<p>q += 10 + l[z + 2];</p>
<p>z += 2;</p>
<p>} else {</p>
<p>q += l[z] + l[z + 1];</p>
<p>z += 2;</p>
<p>return q;</p>
<p>A continuaci√≥n, el c√≥digo como deber√≠a haberse escrito. Este fragmento</p>
<p>es en realidad menos completo que el anterior, pero detectar√° inmediatamente</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>lo que intenta hacer y es probable que pudiera crear las funciones que faltan</p>
<p>en funci√≥n de ese significado que intuye. Los n√∫meros m√°gicos ya no lo son</p>
<p>y la estructura del algoritmo es descriptiva y atractiva:</p>
<p>public int score() {</p>
<p>int score = 0;</p>
<p>int frame = 0;</p>
<p>for (int frameNumber = 0; frameNumber &lt; 10; frameNumber++) {</p>
<p>if (isStrike(frame)) {</p>
<p>score += 10 + nextTwoBallsForStrike(frame);</p>
<p>frame += 1;</p>
<p>} else if (isSpare(frame)) {</p>
<p>score += 10 + nextBallForSpare(frame);</p>
<p>frame += 2;</p>
<p>} else {</p>
<p>score += twoBallsInFrame(frame);</p>
<p>frame += 2;</p>
<p>return score;</p>
<p>Los nombres bien elegidos inundan la estructura del c√≥digo con</p>
<p>descripciones. Dicha inundaci√≥n define las expectativas del lector sobre el</p>
<p>cometido de otras funciones del m√≥dulo.</p>
<p>Puede inferir la implementaci√≥n de isStrike() si se fija en el c√≥digo</p>
<p>anterior. Cuando lea el m√©todo isStrike ser√° pr√°cticamente lo que</p>
<p>[116]</p>
<p>esperaba</p>
<p>private boolean isStrike(int frame) {</p>
<p>return rolls[frame] = 10;</p>
<h3 id="n2-elegir-nombres-en-el-nivel-correcto-de-abstracc-314">N2: Elegir nombres en el nivel correcto de abstracci√≥n</h3>
<p>No elija nombres que comuniquen implementaci√≥n; seleccione nombres que</p>
<p>reflejen el nivel de abstracci√≥n de la clase o la funci√≥n con la que trabaje. Es</p>
<p>complicado. De nuevo, nos cuesta mezclar niveles de abstracci√≥n. Siempre</p>
<p>que realice una pasada por su c√≥digo, es probable que encuentre una variable</p>
<p>con nombre en un nivel demasiado bajo. Cambie esos nombres cuando los</p>
<p>vea. Para que el c√≥digo sea legible se necesita una mejora continua. F√≠jese en</p>
<p>la siguiente interfaz Modem</p>
<p>public interface Modem {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>boolean dial(String phoneNumber);</p>
<p>boolean disconnect();</p>
<p>boolean send(char c);</p>
<p>char recv();</p>
<p>String getConnectedPhoneNumber();</p>
<p>Inicialmente parece correcta. Las funciones parecen las adecuadas. De</p>
<p>hecho lo son para muchas aplicaciones, pero piense ahora en una aplicaci√≥n</p>
<p>en la que algunos m√≥dems no se conecten mediante marcaci√≥n telef√≥nica,</p>
<p>sino mediante cables (como los usados para conexiones dom√©sticas</p>
<p>Internet). Puede que algunos se conecten enviando un n√∫mero de puerto a un</p>
<p>concentrador a trav√©s de una conexi√≥n USB. Es evidente que la noci√≥n de</p>
<p>n√∫meros de tel√©fono se encuentra en un nivel de abstracci√≥n equivocado. Una</p>
<p>estrategia de nomenclatura m√°s adecuada para este caso ser√≠a la siguiente:</p>
<p>public interface Modem {</p>
<p>boolean connect(String connectionLocator);</p>
<p>boolean disconnect();</p>
<p>boolean send(char c);</p>
<p>char recv();</p>
<p>String getConnectedLocator();</p>
<p>Ahora los nombres no se limitan a n√∫meros de tel√©fono. Se pueden usar</p>
<p>para n√∫meros de tel√©fono o para otros tipos de estrategia de conexi√≥n.</p>
<h3 id="n3-usar-nomenclatura-estandar-siempre-que-sea-315">N3: Usar nomenclatura est√°ndar siempre que sea</h3>
<h3 id="posible-316">posible</h3>
<p>Los nombres son m√°s f√°ciles de entender si se basan en una convenci√≥n o un</p>
<p>uso existente. Por ejemplo, si emplea el patr√≥n DECORATOR , deber√≠a usar la</p>
<p>palabra Decorator en los nombres de las clases. Por ejemplo,</p>
<p>AutoHangupModemDecorator podr√≠a ser el nombre de una clase que permite a</p>
<p>un m√≥dem colgar autom√°ticamente al final de una sesi√≥n. Los patrones son</p>
<p>un tipo de est√°ndar. En Java, por ejemplo, las funciones que convierten</p>
<p>objetos en representaciones de cadena suelen tener el nombre toString . Es</p>
<p>mejor seguir estas convenciones que inventar otras propias.</p>
<p>Los equipos suelen inventar su propio sistema est√°ndar de nombres para</p>
<p>un proyecto concreto. Eric Evans lo denomina lenguaje omnipresente del</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[117]</p>
<p>proyecto Su c√≥digo debe usar los t√©rminos de este lenguaje. En</p>
<p>definitiva, cuantos m√°s nombres con significado especial y relevante para su</p>
<p>proyecto utilice, m√°s f√°cil ser√° para los lectores saber de qu√© trata el c√≥digo.</p>
<h3 id="n4-nombres-inequivocos-317">N4: Nombres inequ√≠vocos</h3>
<p>Seleccione nombres que ilustren de forma inequ√≠voca el funcionamiento de</p>
<p>funciones y variables. F√≠jese en este ejemplo de FitNesse:</p>
<p>private String doRename() throws Exception</p>
<p>if (refactorReferences)</p>
<p>renameReferences();</p>
<p>renamePage();</p>
<p>pathToRename.removeNameFromEnd();</p>
<p>pathToRename.addNameToEnd(newName);</p>
<p>return PathParser.render(pathToRename);</p>
<p>El nombre de esta funci√≥n no indica qu√© hace, al menos en t√©rminos</p>
<p>amplios y sin concretar. Adem√°s, se refuerza por la presencia de la funci√≥n</p>
<p>renamePage dentro de la funci√≥n doRename . ¬øQu√© indican los nombres sobre</p>
<p>la diferencia entre ambas funciones? Nada. Un nombre m√°s acertado para la</p>
<p>funci√≥n ser√≠a renamePageAndOptionallyAllReferences Puede parecerle</p>
<p>extenso, y lo es, pero s√≥lo se invoca desde un punto del m√≥dulo, de modo que</p>
<p>su valor descriptivo supera su longitud.</p>
<h3 id="n5-usar-nombres-extensos-para-ambitos-extensos-318">N5: Usar nombres extensos para √°mbitos extensos</h3>
<p>La longitud de un nombre debe estar relacionada con la de su √°mbito. Puede</p>
<p>usar nombres de variables breves para √°mbitos diminutos pero en √°mbitos</p>
<p>mayores debe emplear nombres extensos.</p>
<p>Los nombres de variables como son correctos si su √°mbito tiene</p>
<p>cinco l√≠neas de longitud. F√≠jese en el siguiente fragmento del conocido juego</p>
<p>de los bolos:</p>
<p>private void rollMany(int n, int pins)</p>
<p>for (int i=0; i&lt;n; i++)</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>g.roll(pins);</p>
<p>Es totalmente claro y se complicar√≠a si la variable se cambiara por algo</p>
<p>como rollCount . Por otra parte, las variables y funciones con nombres</p>
<p>breves pierden su significado en las grandes distancias. Por tanto, cuanto</p>
<p>mayor sea el √°mbito del nombre, m√°s extenso y preciso tendr√° que ser el</p>
<p>nombre.</p>
<h3 id="n6-evitar-codificaciones-319">N6: Evitar codificaciones</h3>
<p>Los nombres no deben codificarse con informaci√≥n de tipos o √°mbitos.</p>
<p>Prefijos como m_ no sirven de nada en los entornos actuales. Adem√°s,</p>
<p>codificaciones de proyecto y/o subsistema como vis_ (para un sistema de</p>
<p>im√°genes visuales) distraen la atenci√≥n y son redundantes. Los entornos</p>
<p>actuales proporcionan toda esa informaci√≥n sin tener que modificar los</p>
<p>nombres. Aleje sus nombres de la contaminaci√≥n h√∫ngara.</p>
<h3 id="n7-los-nombres-deben-describir-efectos-secundarios-320">N7: Los nombres deben describir efectos secundarios</h3>
<p>Los nombres deben describir todo lo que haga una funci√≥n, variable o clase.</p>
<p>No oculte efectos secundarios con un nombre. No utilice un simple verbo</p>
<p>para describir una funci√≥n que realiza algo m√°s que una simple acci√≥n. F√≠jese</p>
<p>en este c√≥digo de TestNG:</p>
<p>public ObjectOutputStream getOos() throws IOException {</p>
<p>if (m_oos == null) {</p>
<p>m_oos = new ObjectOutputStream(m_socket.getOutputStream());</p>
<p>return m_oos;</p>
<p>Esta funci√≥n hace algo m√°s que obtener oos ; lo crea si todav√≠a no se ha</p>
<p>creado. Por lo tanto, un nombre m√°s acertado ser√≠a createOrReturnOos</p>
<h3 id="pruebas-test-321">Pruebas (Test)</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="t1-pruebas-insuficientes-322">T1: Pruebas insuficientes</h3>
<p>¬øCu√°ntas pruebas debe incluir una suite de pruebas? Desafortunadamente,</p>
<p>muchos programadores dir√≠an que las que parezcan suficientes. Una suite de</p>
<p>pruebas debe probar todo lo que pueda fallar. Las pruebas son insuficientes</p>
<p>mientras haya condiciones que no se hayan examinado o c√°lculos que no se</p>
<p>hayan validado.</p>
<h3 id="t2-usar-una-herramienta-de-cobertura-323">T2: Usar una herramienta de cobertura</h3>
<p>Las herramientas de cobertura indican vac√≠os en su estrategia de pruebas.</p>
<p>Facilitan la detecci√≥n de m√≥dulos, clases y funciones insuficientemente</p>
<p>probadas. Muchos IDE le ofrecen un indicador visual y marcan en verde las</p>
<p>l√≠neas cubiertas y en rojo las no cubiertas. De este modo es m√°s r√°pido y</p>
<p>sencillo detectar instrucciones if catch cuyos cuerpos no se han</p>
<p>comprobado.</p>
<h3 id="t3-no-ignorar-pruebas-triviales-324">T3: No ignorar pruebas triviales</h3>
<p>Son f√°ciles de redactar y su valor documental es mayor que el coste de</p>
<p>crearlas.</p>
<h3 id="t4-una-prueba-ignorada-es-una-pregunta-sobre-una-325">T4: Una prueba ignorada es una pregunta sobre una</h3>
<h3 id="ambiguedad-326">ambig√ºedad</h3>
<p>En ocasiones dudamos de un detalle de comportamiento porque los requisitos</p>
<p>no son claros. Podemos expresar nuestra duda sobre los requisitos en forma</p>
<p>de prueba comentada o como prueba anotada con @Ignore . La decisi√≥n</p>
<p>depende de si la ambig√ºedad es sobre algo que se compila o no.</p>
<h3 id="t5-probar-condiciones-de-limite-327">T5: Probar condiciones de l√≠mite</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Preste especial atenci√≥n a las pruebas de condiciones de l√≠mite. Solemos</p>
<p>acertar con la parte central de un algoritmo pero malinterpretar los l√≠mites.</p>
<h3 id="t6-probar-de-forma-exhaustiva-junto-a-los-errores-328">T6: Probar de forma exhaustiva junto a los errores</h3>
<p>Los errores suelen congregarse. Si detecta un error en una funci√≥n, es</p>
<p>recomendable probarla de forma exhaustiva. Seguramente no sea el √∫nico</p>
<p>error.</p>
<h3 id="t7-los-patrones-de-fallo-son-reveladores-329">T7: Los patrones de fallo son reveladores</h3>
<p>En ocasiones diagnosticamos un problema detectando patrones de fallo en los</p>
<p>casos de prueba. Es otro argumento para crear casos de prueba lo m√°s</p>
<p>completos posibles. Los casos de prueba completos, si se ordenan de forma</p>
<p>razonable, revelan patrones.</p>
<p>Como ejemplo, imagine que ha detectado que todas las pruebas con un</p>
<p>entero mayor de cinco caracteres fallan. O que fallan todas las pruebas que</p>
<p>pasan un n√∫mero negativo al segundo argumento de una funci√≥n. En</p>
<p>ocasiones, con ver el patr√≥n de rojos y verdes de un informe de pruebas basta</p>
<p>para hacer saltar la chispa y llegar a una soluci√≥n. En el cap√≠tulo 16</p>
<p>encontrar√° un interesante ejemplo en el caso de SerialDate</p>
<h3 id="t8-los-patrones-de-cobertura-de-pruebas-pueden-ser-330">T8: Los patrones de cobertura de pruebas pueden ser</h3>
<h3 id="reveladores-331">reveladores</h3>
<p>El an√°lisis del c√≥digo que se ejecuta o no en las pruebas superadas suele</p>
<p>indicar porqu√© fallan las pruebas no superadas.</p>
<h3 id="t9-las-pruebas-deben-ser-rapidas-332">T9: Las pruebas deben ser r√°pidas</h3>
<p>Una prueba lenta no se ejecuta. Cuando las cosas se ponen feas, las pruebas</p>
<p>lentas se eliminan de la suite . Por lo tanto, intente que sus pruebas sean</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>r√°pidas.</p>
<h3 id="conclusion-333">Conclusi√≥n</h3>
<p>Esta lista de heur√≠stica y s√≠ntomas no se podr√≠a considerar completa. De</p>
<p>hecho, dudo de que alguna vez exista alguna. Pero puede que ese no sea el</p>
<p>objetivo, ya que lo que implica esta lista es un sistema de valores.</p>
<p>El sistema de valores ha sido el objetivo y la base de este libro. El c√≥digo</p>
<p>limpio no se crea siguiendo una serie de reglas. No se convertir√° en un</p>
<p>maestro del software aprendiendo una lista de heur√≠sticas. La profesionalidad</p>
<p>y la maestr√≠a provienen de los valores que impulsan las disciplinas.</p>
<h3 id="bibliografia-334">Bibliograf√≠a</h3>
<p>[Refactoring] Refactoring: Improving the Design of Existing Code</p>
<p>Martin Fowler et al., Addison-Wesley, 1999.</p>
<p>[PRAG] The Pragmatic Programmer , Andrew Hunt, Dave Thomas,</p>
<p>Addison-Wesley, 2000.</p>
<p>[GOF] Design Patterns: Elements of Reusable Object Oriented</p>
<p>Software , Gamma et al., Addison-Wesley, 1996.</p>
<p>[Beck97] Smalltalk Best Practice Patterns , Kent Beck, Prentice Hall,</p>
<p>1997.</p>
<p>[Beck07] Implementation Patterns , Kent Beck, Addison-Wesley, 2008.</p>
<p>[PPP] Agile Software Development: Principles, Patterns, and</p>
<p>Practices , Robert C. Martin, Prentice Hall, 2002.</p>
<p>[DDD] Domain Driven Design , Eric Evans, Addison-Wesley, 2003.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="apendice-a-335">Ap√©ndice A</h1>
<h1 id="concurrencia-ii-336">Concurrencia II</h1>
<p>por Brett L. Schuchert</p>
<p>Este ap√©ndice complementa y ampl√≠a el cap√≠tulo 13 sobre concurrencia. Se ha</p>
<p>escrito como una serie de temas independientes que puede leer en el orden</p>
<p>que desee. Algunas secciones est√°n duplicadas para facilitar dicha lectura.</p>
<h3 id="ejemplo-clienteservidor-337">Ejemplo cliente/servidor</h3>
<p>Imagine una sencilla aplicaci√≥n cliente/servidor. Un servidor espera a que un</p>
<p>cliente se conecte. Un cliente se conecta y env√≠a una solicitud.</p>
<h3 id="el-servidor-338">El servidor</h3>
<p>A continuaci√≥n le mostramos una versi√≥n simplificada de una aplicaci√≥n de</p>
<p>servidor. El c√≥digo completo de este ejemplo se recoge en el Listado A-3.</p>
<p>ServerSocket serverSocket = new ServerSocket(8009);</p>
<p>while (keepProcessing) {</p>
<p>try {</p>
<p>Socket socket = serverSocket.accept();</p>
<p>process(socket);</p>
<p>} catch (Exception e) {</p>
<p>handle(e);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Esta sencilla aplicaci√≥n espera una conexi√≥n, procesa un mensaje entrante</p>
<p>y vuelve a esperar a la siguiente solicitud cliente. El c√≥digo cliente para</p>
<p>conectarse al servidor es el siguiente:</p>
<p>private void connectSendReceive(int i) {</p>
<p>try {</p>
<p>Socket socket = new Socket (‚Äúlocalhost‚Äù, PORT);</p>
<p>MessageUtils.sendMessage(socket, Integer.toString(i));</p>
<p>MessageUtils.getMessage(socket);</p>
<p>socket.close();</p>
<p>} catch (Exception e) {</p>
<p>e.printStackTrace();</p>
<p>¬øC√≥mo se comporta esta combinaci√≥n de cliente y servidor? ¬øC√≥mo</p>
<p>podemos describir formalmente ese rendimiento? La siguiente prueba afirma</p>
<p>que el rendimiento es aceptable:</p>
<p>@Test(timeout = 10000)</p>
<p>public void shouldRunInUnder10Seconds() throws Exception {</p>
<p>Thread[] threads = createThreads();</p>
<p>startAllThreadsw(threads);</p>
<p>waitForAllThreadsToFinish(threads);</p>
<p>Se omite la configuraci√≥n para que el ejemplo sea sencillo (v√©ase</p>
<p>ClientTest.java ‚Äù m√°s adelante). Esta prueba afirma que debe completarse</p>
<p>en 10 000 milisegundos.</p>
<p>Es un ejemplo cl√°sico de validaci√≥n del rendimiento de un sistema. Este</p>
<p>sistema debe completar una serie de solicitudes cliente en 10 segundos.</p>
<p>Mientras el servidor pueda procesar cada solicitud cliente a tiempo, la prueba</p>
<p>ser√° satisfactoria.</p>
<p>¬øQu√© sucede si la prueba falla? Aparte de desarrollar alg√∫n tipo de bucle</p>
<p>de consulta de eventos, no hay mucho que hacer en un √∫nico proceso para</p>
<p>aumentar la velocidad de este c√≥digo. ¬øSe solucionar√≠a el problema con</p>
<p>varios procesos? Puede, pero necesitamos saber c√≥mo se consume el tiempo.</p>
<p>Hay dos posibilidades:</p>
<p>E/S: Con un socket, conect√°ndose a la base de datos, esperando al</p>
<p>intercambio de memoria virtual, etc.</p>
<p>Procesador: C√°lculos num√©ricos, procesamiento de expresiones</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>regulares, recolecci√≥n de elementos sin usar, etc.</p>
<p>Los sistemas suelen tener uno de cada, pero para una operaci√≥n concreta</p>
<p>suele haber uno dominante. Si el c√≥digo se vincula al procesador, mayor</p>
<p>cantidad de hardware de procesamiento puede mejorar el rendimiento y</p>
<p>hacer que se supere la prueba, pero no hay tantos ciclos de CPU disponibles,</p>
<p>de modo que a√±adir procesos a un problema vinculado al procesador no har√°</p>
<p>que aumente la velocidad.</p>
<p>Por otra parte, si el proceso est√° vinculado a E/S, la concurrencia puede</p>
<p>aumentar la eficacia. Cuando una parte del sistema espera a E/S, otra puede</p>
<p>usar ese tiempo de espera para procesar algo distinto, maximizando el uso</p>
<p>eficaz de la CPU disponible.</p>
<h3 id="anadir-subprocesos-339">A√±adir subprocesos</h3>
<p>Imagine que la prueba de rendimiento falla. ¬øC√≥mo podemos mejorar la</p>
<p>producci√≥n para que la prueba de rendimiento sea satisfactoria? Si el m√©todo</p>
<p>process del servidor est√° vinculado a la E/S, existe una forma de conseguir</p>
<p>que el servidor use subprocesos (basta con cambiar processMessage):</p>
<p>void process (final Socket socket) {</p>
<p>if (socket == null)</p>
<p>return;</p>
<p>Runnable clientHandler = new Runnable() {</p>
<p>public void run() {</p>
<p>try {</p>
<p>String message = MessageUtils.getMessage(socket);</p>
<p>MessageUtils.sendMessage(socket, ‚ÄúProcessed: ‚Äù + message);</p>
<p>closeIgnoringException(socket);</p>
<p>} catch (Exception e) {</p>
<p>e.printStackTrace();</p>
<p>};</p>
<p>Thread clientConnection = new Thread(clientHandler);</p>
<p>clientConnection.start();</p>
<p>[118]</p>
<p>Asuma que este cambio hace que la prueba se supere ; el c√≥digo es</p>
<p>completo, ¬øcorrecto?</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="observaciones-del-servidor-340">Observaciones del servidor</h3>
<p>El servidor actualizado completa satisfactoriamente la prueba en algo m√°s de</p>
<p>un segundo. Desafortunadamente, la soluci√≥n genera ciertos problemas.</p>
<p>¬øCu√°ntos subprocesos podr√≠a crear nuestro servidor? El c√≥digo no define</p>
<p>l√≠mites de modo que podr√≠amos alcanzar el impuesto por la M√°quina virtual</p>
<p>de Java (MVJ), suficiente en muchos sistemas sencillos. ¬øPero y si el sistema</p>
<p>tiene que asumir multitud de usuarios de una red p√∫blica? Si se conectan</p>
<p>demasiados usuarios al mismo tiempo, el sistema podr√≠a colapsarse.</p>
<p>Pero dejemos temporalmente este problema de comportamiento. La</p>
<p>soluci√≥n mostrada tiene problemas de limpieza estructura. ¬øCu√°ntas</p>
<p>responsabilidades tiene el c√≥digo del servidor?</p>
<p>Administraci√≥n de conexiones.</p>
<p>Procesamiento de clientes.</p>
<p>Pol√≠tica de subprocesos.</p>
<p>Pol√≠tica de cierre del servidor.</p>
<p>Desafortunadamente, todas estas responsabilidades se encuentran en la</p>
<p>funci√≥n process . Adem√°s, el c√≥digo cruza varios niveles diferentes de</p>
<p>abstracci√≥n. Por tanto, a pesar de la reducida funci√≥n process , es necesario</p>
<p>dividirlo.</p>
<p>Existen varios motivos para cambiar el servidor; por tanto, incumple el</p>
<p>principio de responsabilidad √∫nica. Para mantener la limpieza de un sistema</p>
<p>concurrente, la administraci√≥n de subprocesos debe limitarse a una serie de</p>
<p>puntos controlados. Es m√°s, el c√≥digo que gestione los subprocesos</p>
<p>√∫nicamente debe encargarse de la gesti√≥n de subprocesos. ¬øPor qu√©? Si no</p>
<p>existe otro motivo, el control de problemas de concurrencia ya es lo</p>
<p>suficientemente complicado como para generar simult√°neamente otros</p>
<p>problemas no relacionados con la concurrencia.</p>
<p>Si creamos una lista independiente para cada una de las responsabilidades</p>
<p>anteriores, incluyendo la administraci√≥n de subprocesos, al cambiar la</p>
<p>estrategia de administraci√≥n de subprocesos, el cambio tiene un menor</p>
<p>impacto sobre el c√≥digo y no contamina a otras responsabilidades. De este</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>modo tambi√©n es m√°s sencillo probar las dem√°s responsabilidades sin</p>
<p>necesidad de preocuparse de los subprocesos. Veamos la versi√≥n actualizada</p>
<p>que se encarga de ello:</p>
<p>public void run() {</p>
<p>while (keepProcessing) {</p>
<p>try {</p>
<p>ClientConnection clientConnection = connectionManager.awaitClient();</p>
<p>ClientRequestProcessor requestProcessor</p>
<p>= new ClientRequestProcessor(clientConnection);</p>
<p>clientScheduler.schedule(requestProcessor);</p>
<p>} catch (Exception e) {</p>
<p>e.printStackTrace();</p>
<p>connectionManager.shutdown();</p>
<p>Ahora centra en el mismo punto todos los aspectos relacionados con los</p>
<p>subprocesos: clientScheduler . Si hay problemas de concurrencia, bastar√°</p>
<p>con examinar un punto concreto:</p>
<p>public interface ClientScheduler {</p>
<p>void schedule(ClientRequestProcessor requestProcessor);</p>
<p>La pol√≠tica actual es f√°cil de implementar:</p>
<p>public class ThreadPerRequestScheduler implements ClientScheduler {</p>
<p>public void schedule(final ClientRequestProcessor requestProcessor) {</p>
<p>Runnable runnable = new Runnable() {</p>
<p>public void run() {</p>
<p>requestProcessor.process();</p>
<p>};</p>
<p>Thread thread = new Thread(runnable);</p>
<p>thread.start();</p>
<p>Tras aislar la administraci√≥n de subprocesos, resulta m√°s sencillo cambiar</p>
<p>el control de los mismos. Por ejemplo, para cambiar a la estructura Executor</p>
<p>de Java 5 es necesario crear una nueva clase y conectarla (v√©ase el Listado</p>
<p>A-1).</p>
<p>Listado A-1</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>ExecutorClientScheduler.java.</p>
<p>import java.util.concurrent.Executor;</p>
<p>import java.util.concurrent.Executors;</p>
<p>public class ExecutorClientScheduler implements ClientScheduler {</p>
<p>Executor executor;</p>
<p>public ExecutorClientScheduler(int availableThreads) {</p>
<p>executor = Executors.newFixedThreadPool(availableThreads);</p>
<p>public void schedule(final ClientRequestProcessor requestProcessor) {</p>
<p>Runnable runnable = new Runnable() {</p>
<p>public void run() {</p>
<p>requestProcessor.process();</p>
<p>};</p>
<p>executor.execute(runnable);</p>
<h3 id="conclusion-341">Conclusi√≥n</h3>
<p>En este ejemplo concreto, la presencia de la concurrencia ilustra una forma de</p>
<p>mejorar la producci√≥n de un sistema y otra de validar dicha producci√≥n a</p>
<p>trav√©s de una estructura de pruebas. Al centrar el c√≥digo de concurrencia en</p>
<p>un n√∫mero reducido de clases, aplicamos el Principio de responsabilidad</p>
<p>√∫nica. En el caso de la programaci√≥n concurrente, resulta especialmente</p>
<p>importante debido a su complejidad.</p>
<h3 id="posibles-rutas-de-ejecucion-342">Posibles rutas de ejecuci√≥n</h3>
<p>Repase el m√©todo incrementValue , un m√©todo de Java de una l√≠nea sin</p>
<p>bucles ni ramificaciones:</p>
<p>public class IdGenerator {</p>
<p>int lastIdUsed;</p>
<p>public int incrementValue() {</p>
<p>return ++lastIdUsed;</p>
<p>Ignore el desbordamiento de enteros imagine que solamente un</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>subproceso accede a una instancia de IdGenerator . En este caso existe una</p>
<p>sola ruta de ejecuci√≥n y un √∫nico resultado garantizado:</p>
<p>El valor devuelto es igual al valor de lastIdUsed , y ambos son una</p>
<p>unidad mayores que antes de invocar el m√©todo.</p>
<p>¬øQu√© sucede si usamos dos subprocesos y no cambiamos el m√©todo?</p>
<p>¬øCu√°les son los posibles resultados si cada subproceso invoca</p>
<p>incrementValue una vez? ¬øCu√°ntas rutas de ejecuci√≥n posibles hay?</p>
<p>Primero, los resultados (imagine que el valor inicial de lastIdUsed es 93):</p>
<p>El primer subproceso obtiene el valor 94, el segundo el valor 95 y</p>
<p>lastIdUsed es 95.</p>
<p>El primer subproceso obtiene el valor 95, el segundo el valor 94 y</p>
<p>lastIdUsed es 95.</p>
<p>El primer subproceso obtiene el valor 94, el segundo el valor 94 y</p>
<p>lastIdUsed es 94.</p>
<p>El resultado final, aunque sorprendente, es posible. Para ver los distintos</p>
<p>resultados, debemos comprender las diferentes rutas de ejecuci√≥n posibles y</p>
<p>c√≥mo las ejecuta la MVJ.</p>
<h3 id="numero-de-rutas-343">N√∫mero de rutas</h3>
<p>Para calcular el n√∫mero de rutas de ejecuci√≥n posibles, comenzaremos con el</p>
<p>c√≥digo de bytes generado. La √∫nica l√≠nea de Java ( return ++lastIdUsed; ) se</p>
<p>convierte en ocho instrucciones de c√≥digo de bytes . Los dos subprocesos</p>
<p>pueden intercambiar la ejecuci√≥n de estas ocho instrucciones del mismo</p>
<p>[119]</p>
<p>modo que mezclamos las cartas de una baraja . Incluso con s√≥lo ocho</p>
<p>cartas en cada mano, el n√∫mero de posibles resultados es sorprendente.</p>
<p>Para este sencillo caso de N instrucciones en una secuencia, sin bucles ni</p>
<p>condicionales y T subprocesos, el n√∫mero total de posibles rutas de ejecuci√≥n</p>
<p>es igual a:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>(NT)!</p>
<p>N!</p>
<p>Calcular las √≥rdenes posibles</p>
<p>Extra√≠do de un correo electr√≥nico de Uncle Bob a Brett:</p>
<p>Con pasos subprocesos hay pasos totales. Antes de cada paso</p>
<p>hay un conmutador de contexto que elige entre los subprocesos. Por tanto,</p>
<p>cada ruta se representa como una cadena de d√≠gitos que denota los cambios</p>
<p>de contexto. Dados los pasos A y B los subprocesos 2, las seis rutas</p>
<p>posibles son 1122, 1212, 1221, 2112, 2211. O, en t√©rminos de pasos,</p>
<p>A1B1A2B2, A1A2B1B2, A1A2B2B1, A2A1B1B2, A2A1B2B1 A2B2A1B1. Para tres</p>
<p>subprocesos, la secuencia ser√≠a 112233, 112323, 113223, 113232, 112233,</p>
<p>121233, 121323, 121332, 123132, 123123...</p>
<p>Una caracter√≠stica de estas cadenas es que siempre debe haber instancias</p>
<p>de cada Por tanto, la cadena 111111 no es v√°lida ya que tiene seis</p>
<p>instancias de 1 y ninguna de 2 y 3.</p>
<p>Por tanto, necesitamos las permutaciones de 1, 2... En realidad</p>
<p>son las permutaciones de tomando cada vez que es (N T)!</p>
<p>pero sin los duplicados. Por tanto, el truco consiste en contar los</p>
<p>duplicados y restarlos de (N * T)!</p>
<p>Dados dos pasos dos subprocesos, ¬øcu√°ntos duplicados hay? Cada cadena de</p>
<p>cuatro d√≠gitos tiene dos dos 2. Estos pares se pueden intercambiar sin</p>
<p>modificar el sentido de la cadena. Podr√≠amos intercambiar los los 2,</p>
<p>ninguno. Por tanto hay cuatro isomorfas por cada cadena, lo que significa</p>
<p>que hay tres duplicados, de modo que tres de las cuatro opciones son</p>
<p>duplicados; por otra parte, una de las cuatro permutaciones no son</p>
<p>duplicados. 4! * .25 = 6. Este razonamiento parece funcionar.</p>
<p>¬øCu√°ntos duplicados hay? Si 2, podr√≠a intercambiar los 1, los</p>
<p>2, ambos. En el caso de 3, podr√≠a intercambiar los 1, los 2,</p>
<p>los 3, 2, 3, 3. El intercambio son las permutaciones de</p>
<p>Imagine que hay permutaciones de El n√∫mero de formas diferentes de</p>
<p>organizar dichas permutaciones es P**T</p>
<p>Por tanto el n√∫mero de isomorfas posibles es N!**T el n√∫mero de rutas</p>
<p>es T*N )!/( N!**T ). De nuevo, en nuestro caso 2, obtenemos</p>
<p>(24/4).</p>
<p>Para = 2 y = 3 obtenemos 720/8 = 90.</p>
<p>Para = 3 y = 3 obtenemos 9!/6^3 = 1680.</p>
<p>En nuestro sencillo caso de una sola l√≠nea de c√≥digo Java, que equivale a</p>
<p>ocho l√≠neas de c√≥digo de bytes y a dos subprocesos, el n√∫mero total de</p>
<p>posibles rutas de ejecuci√≥n es 12 870. Si el tipo de lastIdUsed es long , cada</p>
<p>lectura y escritura se convierte en dos operaciones y no una, y el n√∫mero de</p>
<p>posibilidades asciende a 2 704 156.</p>
<p>¬øQu√© sucede si realizamos un cambio en este m√©todo?</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public synchronized void incrementValue() {</p>
<p>++lastIdUsed;</p>
<p>El n√∫mero de posibles rutas de ejecuci√≥n es dos para dos subprocesos</p>
<p>y N! para el caso general.</p>
<h3 id="un-examen-mas-profundo-344">Un examen m√°s profundo</h3>
<p>¬øQu√© piensa del sorprendente resultado de dos subprocesos que invoquen el</p>
<p>m√©todo una vez (antes de a√±adir synchronized ) y obtengan el mismo</p>
<p>resultado num√©rico? ¬øC√≥mo es posible? Vayamos por partes.</p>
<p>¬øQu√© es una operaci√≥n at√≥mica? Podemos definir una operaci√≥n at√≥mica</p>
<p>como toda operaci√≥n ininterrumpible. Por ejemplo, en el siguiente c√≥digo, la</p>
<p>l√≠nea 5, donde se asigna lastId , es at√≥mica ya que de acuerdo al modelo</p>
<p>de memoria de Java, la asignaci√≥n a un valor de 32 bits es ininterrumpible.</p>
<p>01: public class Example {</p>
<p>02: int lastId;</p>
<p>03:</p>
<p>04: public void resetId() {</p>
<p>05: value = 0;</p>
<p>06:</p>
<p>07:</p>
<p>08: public int getNextId() {</p>
<p>09: ++value;</p>
<p>10:</p>
<p>11:</p>
<p>¬øQu√© sucede si cambiamos el tipo de lastId de int long ? ¬øSigue</p>
<p>siendo at√≥mica la l√≠nea 5? No de acuerdo a la especificaci√≥n de la MVJ.</p>
<p>Podr√≠a ser at√≥mica en un procesador concreto, pero seg√∫n la especificaci√≥n de</p>
<p>la MVJ, la asignaci√≥n a un valor de 64 bits requiere dos asignaciones de 32</p>
<p>bits. Esto significa que entre la primera y la segunda podr√≠a irrumpir otro</p>
<p>subproceso y cambiar uno de los valores.</p>
<p>¬øY qu√© sucede con el operador de preincremento, ++ , de la l√≠nea 9? Este</p>
<p>operador se puede interrumpir, de modo que no es at√≥mico. Para entenderlo,</p>
<p>repasemos el c√≥digo de bytes de ambos m√©todos.</p>
<p>Antes de continuar, hay tres definiciones importantes:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Marco: La invocaci√≥n de un m√©todo requiere un marco, el cual incluye</p>
<p>la direcci√≥n de devoluci√≥n, los par√°metros pasados al m√©todo y las</p>
<p>variables locales definidas en el mismo. Es una t√©cnica est√°ndar</p>
<p>empleada para definir una pila de invocaciones, que se usa en muchos</p>
<p>lenguajes modernos para permitir la invocaci√≥n de funciones y m√©todos</p>
<p>b√°sicos, adem√°s de invocaciones recursivas.</p>
<p>Variable local: Las variables definidas en el √°mbito del m√©todo. Todos</p>
<p>los m√©todos no est√°ticos tienen al menos una variable, this , que</p>
<p>representa el objeto actual, el objeto que ha recibido el √∫ltimo mensaje</p>
<p>(en el subproceso actual) que ha propiciado la invocaci√≥n del m√©todo.</p>
<p>Pila de operandos: Muchas instrucciones de la MVJ aceptan</p>
<p>par√°metros. La pila de operandos es donde se incluyen dichos</p>
<p>par√°metros. La pila es una estructura de datos LIFO ( Last-In, First-Out</p>
<p>o √öltimo en entrar, primero en salir) est√°ndar.</p>
<p>Veamos el c√≥digo de bytes generado para resetId().</p>
<p>Nem√≥nico Descripci√≥n Pila de</p>
<p>operandos</p>
<p>posterior</p>
<p>ALOAD 0 Cargar la variable 0 en la pila de operandos. ¬øQu√© this</p>
<p>es la variable 0 ? Es this. , el objeto actual. Al</p>
<p>invocar el m√©todo, el receptor del mensaje, una</p>
<p>instancia de Example , se env√≠a a la matriz de</p>
<p>variables locales del marco creado para la</p>
<p>invocaci√≥n de m√©todos. Siempre es la primera</p>
<p>variable que se a√±ade a todos los m√©todos de</p>
<p>instancia.</p>
<p>ICONST_0 Incluir el valor constante 0 en la pila de operandos. this, 0</p>
<p>PUTFIELD Almacenar el valor superior de la pila (0) en el valor &lt;Vac√≠o&gt;</p>
<p>lastId</p>
<p>de campo del objeto denominado por la referencia</p>
<p>de objeto una posici√≥n alejada de la parte superior</p>
<p>de la pila, this</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Estas tres instrucciones son at√≥micas ya que a pesar de que el subproceso</p>
<p>que las ejecuta podr√≠a verse interrumpido por cualquiera de ellas, la</p>
<p>informaci√≥n para la instrucci√≥n PUTFIELD (el valor constante de la parte</p>
<p>superior de la pila y la referencia a √©ste una posici√≥n inferior, junto con el</p>
<p>valor del campo) no se ve alterada por ning√∫n otro subproceso. Por tanto, al</p>
<p>producirse la asignaci√≥n, sabemos que el valor 0 se almacena en el valor del</p>
<p>campo. La operaci√≥n es at√≥mica. Todos los operandos procesan informaci√≥n</p>
<p>local del m√©todo, de modo que no hay interferencias entre subprocesos.</p>
<p>Si estas instrucciones se ejecutan en diez subprocesos, hay</p>
<p>4.38679733629e+24 ordenaciones posibles. Sin embargo, s√≥lo hay un</p>
<p>resultado posible, de modo que las distintas ordenaciones son irrelevantes. Y</p>
<p>adem√°s, se garantiza el mismo resultado para valores long en este caso. ¬øPor</p>
<p>qu√©? Los diez subprocesos asignan un valor constante. Aunque se</p>
<p>entremezclen, el resultado final ser√° el mismo. Habr√° problemas con la</p>
<p>operaci√≥n ++ en el m√©todo getNextId . Imagine que lastId contiene al</p>
<p>inicio de este m√©todo. Veamos el c√≥digo de bytes de este nuevo m√©todo:</p>
<p>Nem√≥nico Descripci√≥n Pila de</p>
<p>operandos</p>
<p>posterior</p>
<p>ALOAD 0 Cargar this en la pila de operandos. this</p>
<p>DUP Copiar la parte superior de la pila. Ahora tenemos this,</p>
<p>this</p>
<p>dos copias de this en la pila de operandos.</p>
<p>GETFIELD Recuperar el valor del campo lastId del objeto al this, 42</p>
<p>lastId</p>
<p>que se apunta en la parte superior de la pila ( this ) y</p>
<p>volver a almacenar el valor en la pila.</p>
<p>ICONST_1 Desplazar la constante entera 1 en la pila. this, 42,</p>
<p>IADD Suma entera de los dos valores superiores de la pila this, 43</p>
<p>de operandos y volver a almacenar el resultado en la</p>
<p>pila.</p>
<p>DUP_X1 Duplicar el valor 43 y a√±adirlo delante de this 43, this,</p>
<p>PUTFIELD Almacenar el valor superior de la pila de operandos,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>value 43, en el valor de campo del objeto actual,</p>
<p>representado por el siguiente valor superior de la</p>
<p>pila de operandos, this</p>
<p>IRETURN Devolver el valor superior (y √∫nico) de la pila de &lt;Vac√≠o&gt;</p>
<p>operandos.</p>
<p>Imagine que el primer subproceso completa las tres primeras</p>
<p>instrucciones, hasta GETFIELD incluida y despu√©s se interrumpe. Aparece un</p>
<p>segundo subproceso y ejecuta el m√©todo completo, incrementando lastId en</p>
<p>uno; devuelve 43. Tras ello, el primer subproceso retoma desde donde se</p>
<p>detuvo; 42 sigue en la pila de operandos por ser el valor de lastId cuando</p>
<p>ejecut√≥ GETFIELD . Suma uno para obtener 43 y almacena el resultado.</p>
<p>El valor 43 tambi√©n se devuelve al primer subproceso. Como resultado,</p>
<p>uno de los incrementos se pierde ya que el primer subproceso interfiere con el</p>
<p>segundo despu√©s de que √©ste haya interrumpido al primero.</p>
<p>Al convertir el m√©todo getNextId() en synchronized se corrige este</p>
<p>problema.</p>
<h3 id="conclusion-345">Conclusi√≥n</h3>
<p>No se necesita un conocimiento extenso del c√≥digo de bytes para entender</p>
<p>c√≥mo unos subprocesos interrumpen a otros. Si consigue entender este</p>
<p>ejemplo, demostrar√° la posibilidad de varios subprocesos entrelazados, un</p>
<p>conocimiento suficiente.</p>
<p>Dicho esto, lo que este sencillo ejemplo revela es la necesidad de</p>
<p>entender el modelo de memoria para saber qu√© se permite y qu√© no.</p>
<p>Equivocadamente se piensa que el operador ++ (pre o postincremento) es</p>
<p>at√≥mico, y evidentemente no lo es. Esto significa que tiene que saber:</p>
<p>D√≥nde est√°n los objetos y valores compartidos.</p>
<p>El c√≥digo que provoca problemas de lectura/actualizaci√≥n concurrente.</p>
<p>C√≥mo evitar que se produzcan dichos problemas.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="conocer-su-biblioteca-346">Conocer su biblioteca</h3>
<h3 id="la-estructura-executor-347">La estructura Executor</h3>
<p>Como mostramos en ExecutorClientScheduler.java la estructura</p>
<p>Executor de Java permite la ejecuci√≥n sofisticada por medio de</p>
<p>agrupaciones de subprocesos. Es una clase del paquete</p>
<p>java.util.concurrent . Si va a crear subprocesos y no usa una agrupaci√≥n</p>
<p>de subprocesos o utiliza una creada a mano, considere el uso de Executor.</p>
<p>Hace que el c√≥digo sea m√°s limpio, m√°s f√°cil de entender y de menor tama√±o.</p>
<p>La estructura Executor agrupa subprocesos, los cambia autom√°ticamente</p>
<p>de tama√±o y los vuelve a crear si es necesario. Tambi√©n admite futuros , una</p>
<p>construcci√≥n de programaci√≥n concurrente habitual. La estructura Executor</p>
<p>funciona con clases que implementan Runnable y tambi√©n con clases que</p>
<p>implementan la interfaz Callable Callable se parece a Runnable , pero</p>
<p>puede devolver un resultado, una necesidad habitual en soluciones de</p>
<p>m√∫ltiples subprocesos.</p>
<p>Un futuro resulta muy √∫til cuando el c√≥digo tiene que ejecutar varias</p>
<p>operaciones independientes y esperar a que terminen:</p>
<p>public String processRequest(String message) throws Exception {</p>
<p>Callable&lt;String&gt; makeExternalCall = new Callable&lt;String&gt;() {</p>
<p>public String call() throws Exception {</p>
<p>String result = ‚Äú‚Äù;</p>
<p>// realizar solicitud externa</p>
<p>return result;</p>
<p>};</p>
<p>Future&lt;String&gt; result = executorService.submit(makeExternalCall);</p>
<p>String partialResult = doSomeLocalProcessing();</p>
<p>return result.get() + partialResult;</p>
<p>En este ejemplo, el m√©todo comienza ejecutar el objeto</p>
<p>makeExternalCall , prosigue con otro procesamiento y la √∫ltima l√≠nea invoca</p>
<p>result.get(), que se bloquea hasta que el futuro termina.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="soluciones-no-bloqueantes-348">Soluciones no bloqueantes</h3>
<p>La MV Java 5 aprovecha el dise√±o de los procesadores modernos que</p>
<p>admiten actualizaciones fiables y no bloqueantes. Imagine una clase que usa</p>
<p>sincronizaci√≥n (y por tanto bloqueo) para proporcionar la actualizaci√≥n</p>
<p>compatible con subprocesos de un valor:</p>
<p>public class ObjectWithValue {</p>
<p>private int value;</p>
<p>public void synchronized incrementValue() { ++value; }</p>
<p>public int getValue() { return value; }</p>
<p>Java 5 dispone de varias clases nuevas para este tipo de situaciones, como</p>
<p>por ejemplo AtomicBoolean AtomicInteger AtomicReference . Podemos</p>
<p>modificar el c√≥digo anterior para usar un enfoque no bloqueante:</p>
<p>public class ObjectWithValue {</p>
<p>private AtomicInteger value = new AtomicInteger(0);</p>
<p>public void incrementValue() {</p>
<p>value.incrementAndGet();</p>
<p>public int getValue() {</p>
<p>return value.get();</p>
<p>Aunque use un objeto en lugar de una primitiva y env√≠e mensajes como</p>
<p>incrementAndGet() en lugar de ++ , el rendimiento de esta clase supera en la</p>
<p>mayor√≠a de los casos al de la versi√≥n anterior. En algunos casos ser√°</p>
<p>ligeramente m√°s r√°pido pero los casos en los que es m√°s lento son</p>
<p>pr√°cticamente inexistentes.</p>
<p>¬øC√≥mo es posible? Los procesadores modernos disponen de una</p>
<p>operaci√≥n denominada CAS (Compare and Swap, Comparar e intercambiar).</p>
<p>Es una operaci√≥n similar al bloqueo optimista de una base de datos, mientras</p>
<p>que la versi√≥n sincronizada es similar al bloqueo pesimista.</p>
<p>La palabra clave synchronized siempre adquiere un bloqueo, incluso</p>
<p>cuando un segundo subproceso no intenta actualizar el mismo valor. Aunque</p>
<p>el rendimiento de los bloqueos intr√≠nsecos ha mejorado con respecto a</p>
<p>versiones anteriores, sigue siendo muy costoso.</p>
<p>La versi√≥n no bloqueante asume inicialmente que varios subprocesos no</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>modifican el mismo valor con la suficiente periodicidad como para generar</p>
<p>un problema. Por el contrario, detecta de forma eficaz si se produce dicha</p>
<p>situaci√≥n y la reintenta hasta que la actualizaci√≥n es satisfactoria. Esta</p>
<p>detecci√≥n suele ser menos costosa que la adquisici√≥n de un bloqueo, incluso</p>
<p>en situaciones de contenci√≥n moderada o alta.</p>
<p>¬øC√≥mo lo hace la MV? La operaci√≥n CAS es at√≥mica. Por tanto, la</p>
<p>operaci√≥n CAS tiene este aspecto:</p>
<p>int variableBeingSet;</p>
<p>void simulateNonBlockingSet (int newValue) {</p>
<p>int currentValue;</p>
<p>do {</p>
<p>currentValue = variableBeingSet</p>
<p>} while(currentValue != compareAndSwap(currentValue, newValue));</p>
<p>int synchronized compareAndSwap(int currentValue, int newValue) {</p>
<p>if(variableBeingSet == currentValue) {</p>
<p>variableBeingSet = newValue;</p>
<p>return currentValue;</p>
<p>return variableBeingSet;</p>
<p>Cuando un m√©todo intenta actualizar una variable compartida, la</p>
<p>operaci√≥n CAS comprueba que la variable establecida sigue teniendo el</p>
<p>√∫ltimo valor conocido. En caso afirmativo, se cambia la variable. En caso</p>
<p>contrario, la variable no se establece ya que otro subproceso ha conseguido</p>
<p>acceder.</p>
<p>El m√©todo que realiza el intento (mediante la operaci√≥n CAS) ve que el</p>
<p>cambio no se ha realizado y lo intenta de nuevo.</p>
<h3 id="clases-incompatibles-con-subprocesos-349">Clases incompatibles con subprocesos</h3>
<p>Existen clases que no son compatibles con subprocesos, como las siguientes:</p>
<p>SimpleDateFormat</p>
<p>Conexiones de base de datos.</p>
<p>Contenedores de java.util</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Servlet.</p>
<p>Algunas clases de colecci√≥n tienen m√©todos concretos compatibles con</p>
<p>subprocesos. Sin embargo, cualquier operaci√≥n que invoque m√°s de un</p>
<p>m√©todo no lo es. Por ejemplo, si no quiere reemplazar algo en HashTable</p>
<p>porque ya existe, podr√≠a crear el siguiente c√≥digo:</p>
<p>if(!hashTable.containsKey(someKey)) {</p>
<p>hashTable.put(someKey, new SomeValue());</p>
<p>Cada uno de los m√©todos es compatible con subprocesos. Sin embargo,</p>
<p>otro subproceso podr√≠a a√±adir un valor entre las invocaciones de</p>
<p>containsKey put . Existen varias formas de solucionar este problema:</p>
<p>Bloquear primero HashTable y comprobar que los dem√°s usuarios de</p>
<p>HashTable hagan lo mismo; bloqueo basado en clientes:</p>
<p>synchronized(map) {</p>
<p>if(!map.containsKey(key))</p>
<p>map.put(key,value);</p>
<p>Envolver HashTable en su propio objeto y usar dos API distintas;</p>
<p>bloqueo basado en servidores con un adaptador:</p>
<p>public class WrappedHashtable&lt;K, V&gt; {</p>
<p>private Map&lt;K, V&gt; map = new Hashtable&lt;K, V&gt;();</p>
<p>public synchronized void putIfAbsent(K key, V value) {</p>
<p>if (map.containsKey(key))</p>
<p>map.put(key, value);</p>
<p>Usar colecciones compatibles con subprocesos:</p>
<p>ConcurrentHashMap&lt;Integer, String&gt; map new ConcurrentHashMap&lt;Integer,</p>
<p>String&gt;();</p>
<p>map.putIfAbsent(key, value);</p>
<p>Las colecciones de java.util.concurrent incluyen operaciones como</p>
<p>putIfAbsent() para acomodar este tipo de operaciones.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="las-dependencias-entre-metodos-pueden-afectar-al-350">Las dependencias entre m√©todos pueden afectar al</h3>
<h3 id="codigo-concurrente-351">c√≥digo concurrente</h3>
<p>El siguiente ejemplo es una forma de a√±adir dependencias entre m√©todos:</p>
<p>public class IntegerIterator implements Iterator&lt;Integer&gt;</p>
<p>private Integer nextValue = 0;</p>
<p>public synchronized boolean hasNext() {</p>
<p>return nextValue &lt; 100000;</p>
<p>public synchronized Integer next() {</p>
<p>if (nextValue == 100000)</p>
<p>throw new IteratorPastEndException();</p>
<p>return nextValue++;</p>
<p>public synchronized Integer getNextValue() {</p>
<p>return nextValue;</p>
<p>Veamos otro c√≥digo que usa IntegerIterator</p>
<p>IntegerIterator iterator = new IntegerIterator();</p>
<p>while(iterator.hasNext()) {</p>
<p>int nextValue = iterator.next();</p>
<p>// hacer algo con nextValue</p>
<p>Si un subproceso ejecuta este c√≥digo no habr√° problemas. ¬øQu√© sucede si</p>
<p>dos subprocesos intentan compartir una misma instancia de IntegerIterator</p>
<p>para procesar el valor que reciba cada uno pero cada elemento de la lista s√≥lo</p>
<p>se procesa una vez? En la mayor√≠a de los casos, no hay consecuencias</p>
<p>negativas; los subprocesos comparten la lista, procesan los elementos</p>
<p>devueltos por el iterador y se detienen cuando √©ste termina. Sin embargo,</p>
<p>existe la posibilidad de que al final de la iteraci√≥n los dos subprocesos</p>
<p>interfieran entre ellos y provoquen que uno supere el final del iterador y se</p>
<p>genere una excepci√≥n.</p>
<p>El problema es el siguiente: El subproceso 1 pregunta hasNext() , que</p>
<p>devuelve true . El subproceso 1 se evita y el subproceso 2 realiza la misma</p>
<p>pregunta, que sigue siendo true . Tras ello, el subproceso 2 invoca next()</p>
<p>que devuelve un valor, como era de esperar, pero como efecto secundario</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>hace que hasNext() devuelva false</p>
<p>Se vuelve a iniciar el subproceso 1, pensando que hasNext() sigue siendo</p>
<p>true despu√©s invoca next() Aunque los m√©todos concretos est√°n</p>
<p>sincronizados, el cliente usa dos m√©todos.</p>
<p>Es un problema real un ejemplo que puede surgir en c√≥digo</p>
<p>concurrente. En este caso concreto, el problema es especialmente sutil ya que</p>
<p>la √∫nica ocasi√≥n en la que produce un fallo es durante la iteraci√≥n final del</p>
<p>iterador. Si los subprocesos se dividen de forma correcta, puede que uno</p>
<p>supere el final del iterador. Es el tipo de error que surge en un sistema que</p>
<p>lleva tiempo en producci√≥n, y es dif√≠cil de detectar. Tiene tres opciones:</p>
<p>Tolerar el fallo.</p>
<p>Solucionar el problema cambiando el cliente: bloqueo basado en el</p>
<p>cliente.</p>
<p>Solucionar el problema cambiando el servidor, lo que tambi√©n provoca</p>
<p>que cambie el cliente: bloqueo basado en el servidor.</p>
<h3 id="tolerar-el-fallo-352">Tolerar el fallo</h3>
<p>En ocasiones, los sistemas se configuran para que un fallo no produzca</p>
<p>da√±os. Por ejemplo, el cliente anterior pod√≠a capturar la excepci√≥n</p>
<p>limpiarla, aunque ser√≠a un tanto torpe. Es como limpiar fugas de memoria</p>
<p>reiniciando a medianoche.</p>
<h3 id="bloqueo-basado-en-el-cliente-353">Bloqueo basado en el cliente</h3>
<p>Para que IntegerIterator funcione correctamente con varios subprocesos,</p>
<p>cambie el cliente (y los dem√°s) como se indica a continuaci√≥n:</p>
<p>IntegerIterator iterator = new IntegerIterator();</p>
<p>while (true) {</p>
<p>int nextValue;</p>
<p>synchronized (iterator) {</p>
<p>if (!iterator.hasNext())</p>
<p>break;</p>
<p>nextValue = iterator.next();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>doSometingWith(nextValue);</p>
<p>Cada cliente a√±ade un bloqueo a trav√©s de la palabra clave synchronized</p>
<p>Esta duplicaci√≥n incumple el principio DRY, pero puede ser necesaria si el</p>
<p>c√≥digo usa agrupaciones de terceros no compatibles con subprocesos.</p>
<p>La estrategia es arriesgada ya que todos los programadores que usen el</p>
<p>servidor deben acordarse de bloquearlo antes de usarlo y de desbloquearlo</p>
<p>cuando terminen. Hace muchos a√±os, trabaj√© en un sistema que usaba el</p>
<p>bloqueo basado en el cliente en un recurso compartido. El recurso se usaba en</p>
<p>cientos de puntos distintos del c√≥digo. Un pobre programador se olvid√≥ de</p>
<p>bloquear el recurso en uno de esos puntos.</p>
<p>Era un sistema de varios terminales con software de contabilidad para el</p>
<p>sindicato de transportistas. Local 705. El ordenador se encontraba en una sala</p>
<p>de temperatura controlada de un piso elevado, a unas 50 millas al norte de la</p>
<p>sede de Local 705. En la sede, decenas de trabajadores introduc√≠an datos en</p>
<p>las terminales, conectadas al ordenador mediante l√≠neas telef√≥nicas dedicadas</p>
<p>y m√≥dem semid√∫plex de 600bps (esto fue hace mucho , mucho tiempo).</p>
<p>Una vez al d√≠a, una de las terminales se bloqueaba, sin raz√≥n aparente. El</p>
<p>bloqueo no ten√≠a preferencia alguna por una terminal o una hora concreta. Es</p>
<p>como si alguien echara a suertes la terminal que bloquear y la hora del</p>
<p>bloqueo. En ocasiones, se bloqueaba m√°s de una terminal. En ocasiones,</p>
<p>pod√≠an pasar varios d√≠as sin bloqueos.</p>
<p>Inicialmente, se opt√≥ por reiniciar como soluci√≥n, pero era complicado</p>
<p>coordinar los reinicios. Tenemos que avisar a la sede y esperar a que todos</p>
<p>terminaran lo que estuvieran haciendo en todas las terminales. Tras ello, se</p>
<p>apagaba el sistema y se reiniciaba. Si alguien estaba haciendo algo importante</p>
<p>para lo que necesitaba una o dos horas, la terminal bloqueada ten√≠a que seguir</p>
<p>bloqueada.</p>
<p>Tras varias semanas de depuraci√≥n, descubrimos que la causa era un</p>
<p>contador de b√∫fer circular desincronizado con su puntero. Este b√∫fer</p>
<p>controlaba la salida a la terminal. El valor del puntero indicaba que el b√∫fer</p>
<p>estaba vac√≠o pero el contador mostraba que estaba lleno. Como estaba vac√≠o,</p>
<p>no hab√≠a nada que mostrar; pero como tambi√©n estaba lleno, no se pod√≠a</p>
<p>a√±adir nada al b√∫fer que mostrar en la pantalla.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Sab√≠amos qu√© era lo que bloqueaba las terminales pero no qu√© provocaba</p>
<p>la desincronizaci√≥n del b√∫fer circular, por lo que a√±adimos un truco para</p>
<p>resolver el problema. Se pod√≠an leer los conmutadores del panel frontal en el</p>
<p>ordenador (esto fue hace mucho, mucho, mucho tiempo). Dise√±amos una</p>
<p>funci√≥n de trampa que detectaba si uno de los conmutadores se hab√≠a</p>
<p>generado y despu√©s busc√°bamos un b√∫fer circular que estuviera tanto lleno</p>
<p>como vac√≠o. Si lo encontr√°bamos, lo vari√°bamos. Voil√° La terminal</p>
<p>bloqueada volv√≠a a funcionar. De este modo no era necesario reiniciar el</p>
<p>sistema si una terminal se bloqueaba. La sede nos llamaba y nos dec√≠a que</p>
<p>hab√≠a un bloqueo, nos acerc√°bamos hasta la sala de ordenadores</p>
<p>puls√°bamos un conmutador.</p>
<p>En ocasiones ellos trabajan los fines de semana pero nosotros no. Por</p>
<p>ello, a√±adimos una funci√≥n al programador que comprobaba los b√∫fer</p>
<p>circulares una vez por minuto y restablec√≠a los que estuvieran tanto llenos</p>
<p>como vac√≠os. De este modo se descongestionaban las pantallas antes de que</p>
<p>la direcci√≥n llegara al tel√©fono.</p>
<p>Necesitamos varias semanas de an√°lisis de c√≥digo de lenguaje de</p>
<p>ensamblado antes de localizar al culpable. Hab√≠amos calculado que la</p>
<p>frecuencia de los bloqueos se deb√≠a a un uso desprotegido del b√∫fer circular,</p>
<p>as√≠ que s√≥lo era necesario determinar el uso fallido. Desafortunadamente,</p>
<p>esto fue hace mucho tiempo y no dispon√≠amos de herramientas de b√∫squeda,</p>
<p>referencias cruzadas ni de otras t√©cnicas autom√°ticas de ayuda. Ten√≠amos que</p>
<p>escudri√±ar los listados. En aquel fr√≠o invierno de 1971 en Chicago aprend√≠</p>
<p>que los bloqueos basados en el cliente son verdaderamente terribles.</p>
<h3 id="bloqueo-basado-en-el-servidor-354">Bloqueo basado en el servidor</h3>
<p>La duplicaci√≥n se puede eliminar si modificamos IntegerIterator de esta</p>
<p>forma:</p>
<p>public class IntegerIteratorServerLocked {</p>
<p>private Integer nextValue = 0;</p>
<p>public synchronized Integer getNextOrNull() {</p>
<p>if (nextValue &lt; 100000)</p>
<p>return nextValue++;</p>
<p>else</p>
<p>return null;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Y tambi√©n cambia el c√≥digo cliente:</p>
<p>while (true) {</p>
<p>Integer nextValue = iterator.getNextOrNull();</p>
<p>if (next == null)</p>
<p>break;</p>
<p>// hacer algo con nextValue</p>
<p>En este caso, en realidad cambiamos la API de la clase para que sea</p>
<p>[120]</p>
<p>compatible con el subproceso . El cliente debe realizar una comprobaci√≥n</p>
<p>de null en lugar de comprobar hasNext()</p>
<p>Por lo general, el bloqueo basado en el servidor es preferible por estos</p>
<p>motivos:</p>
<p>Reduce el c√≥digo repetido: El bloqueo basado en el servidor hace que el</p>
<p>cliente bloquee correctamente el servidor. Al incluir el c√≥digo de</p>
<p>bloqueo en el servidor, se libera a los clientes para usar el objeto y no</p>
<p>tener que preocuparse de crear c√≥digo de bloqueo adicional.</p>
<p>Permite un mejor rendimiento: Puede intercambiar un servidor</p>
<p>compatible con subprocesos por otro incompatible en caso de desarrollo</p>
<p>de un solo subproceso, lo que evita la sobrecarga.</p>
<p>Reduce las posibilidades de error: S√≥lo se necesita un programador que</p>
<p>se olvide del bloqueo.</p>
<p>Aplica una √∫nica pol√≠tica: La pol√≠tica se aplica solamente al servidor, no</p>
<p>a todos los clientes.</p>
<p>Reduce el √°mbito de las variables compartidas: El cliente las desconoce</p>
<p>y tampoco sabe c√≥mo se bloquean. Todo se oculta en el servidor.</p>
<p>Cuando se produce un fallo, su origen se busca en menos puntos.</p>
<p>¬øY si no es el propietario del c√≥digo de servidor?</p>
<p>Usar un adaptador para cambiar la API y a√±adir bloqueo</p>
<p>public class ThreadSafeIntegerIterator {</p>
<p>private IntegerIterator iterator = new IntegerIterator();</p>
<p>public synchronized Integer getNextOrNull() {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if(iterator.hasNext())</p>
<p>return iterator.next();</p>
<p>return null;</p>
<p>Mejor todav√≠a, usar colecciones compatibles con subprocesos con</p>
<p>interfaces ampliadas.</p>
<h3 id="aumentar-la-produccion-355">Aumentar la producci√≥n</h3>
<p>Imagine que desea leer el contenido de una serie de p√°ginas de una lista de</p>
<p>URL en la red. Al leer cada p√°gina, la analizamos para acumular estad√≠sticas.</p>
<p>Despu√©s de leer todas, imprimimos un informe de resumen.</p>
<p>La siguiente clase devuelve el contenido de una p√°gina, dada una URL.</p>
<p>public class PageReader {</p>
<p>//...</p>
<p>public String getPageFor(String url) {</p>
<p>HttpMethod method = new GetMethod(url);</p>
<p>try {</p>
<p>httpClient.executeMethod(method);</p>
<p>String response = method.getResponseBodyAsString();</p>
<p>return response;</p>
<p>} catch (Exception e) {</p>
<p>handle(e);</p>
<p>} finally {</p>
<p>method.releaseConnection();</p>
<p>La siguiente clase es el iterador que proporciona el contenido de las</p>
<p>p√°ginas en funci√≥n de un iterador de URL:</p>
<p>public class PageIterator {</p>
<p>private PageReader reader;</p>
<p>private URLIterator urls;</p>
<p>public PageIterator(PageReader reader, URLIterator urls) {</p>
<p>this.urls = urls;</p>
<p>this.reader = reader;</p>
<p>public synchronized String getNextPageOrNull() {</p>
<p>if (urls.hasNext())</p>
<p>getPageFor(urls.next());</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>else</p>
<p>return null;</p>
<p>public String getPageFor(String url) {</p>
<p>return reader.getPageFor(ur1);</p>
<p>Se puede compartir una instancia de PageIterator entre varios</p>
<p>subprocesos distintos, cada uno con su propia instancia de PageReader para</p>
<p>leer las p√°ginas que obtiene del iterador.</p>
<p>Hemos reducido el tama√±o del bloque synchronized Simplemente</p>
<p>contiene la secci√≥n cr√≠tica de PageIterator . Siempre conviene sincronizar lo</p>
<p>menos posible.</p>
<h3 id="calculo-de-produccion-de-un-solo-subproceso-356">C√°lculo de producci√≥n de un solo subproceso</h3>
<p>Vayamos con los c√°lculos. Imagine lo siguiente, de acuerdo al argumento</p>
<p>anterior:</p>
<p>Tiempo de E/S para recuperar una p√°gina (de media): 1 segundo.</p>
<p>Tiempo de procesamiento para analizar la p√°gina (de media): .5</p>
<p>segundos.</p>
<p>E/S requiere 0 por 100 de la CPU mientras que el procesamiento</p>
<p>requiere 100 por 100.</p>
<p>Si se procesan p√°ginas en un mismo subproceso, el tiempo de ejecuci√≥n</p>
<p>total es de 1.5 segundos * . En la figura A.1 puede ver una instant√°nea de 13</p>
<p>p√°ginas, aproximadamente 19.5 segundos.</p>
<p>Figura A.1. Un √∫nico subproceso</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="calculo-de-produccion-con-varios-subprocesos-357">C√°lculo de producci√≥n con varios subprocesos</h3>
<p>Si se pueden recuperar p√°ginas en cualquier orden y procesarlas de forma</p>
<p>independiente, entonces es posible usar varios subprocesos para aumentar la</p>
<p>producci√≥n. ¬øQu√© sucede si usamos tres subprocesos? ¬øCu√°ntas p√°ginas</p>
<p>podemos obtener en el mismo tiempo?</p>
<p>Como se aprecia en la figura A.2, la soluci√≥n con varios procesos permite</p>
<p>que el an√°lisis de las p√°ginas vinculado al proceso se solape con la lectura de</p>
<p>las mismas, vinculada E/S. En un mundo ideal, significar√≠a que el</p>
<p>procesador se utiliza totalmente. Cada lectura de p√°gina por segundo se</p>
<p>solapa con dos an√°lisis. Por tanto, podemos procesar dos p√°ginas por</p>
<p>segundo, lo que triplica la producci√≥n de la soluci√≥n con un solo proceso.</p>
<p>Figura A.2. Tres subprocesos concurrentes.</p>
<h3 id="bloqueo-mutuo-358">Bloqueo mutuo</h3>
<p>Imagine una aplicaci√≥n Web con dos agrupaciones de recursos compartidos</p>
<p>de tama√±o finito:</p>
<p>Una agrupaci√≥n de conexiones de base de datos para tareas locales de</p>
<p>almacenamiento de procesos.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Una agrupaci√≥n de conexiones MQ a un repositorio principal.</p>
<p>Imagine que hay dos operaciones en la aplicaci√≥n: crear y actualizar:</p>
<p>Crear: Adquirir una conexi√≥n al repositorio principal y la base de datos.</p>
<p>Comunicarse con el repositorio principal y despu√©s almacenar el trabajo</p>
<p>local en la base de datos de procesos.</p>
<p>Actualizar: Adquirir una conexi√≥n a la base de datos y despu√©s al</p>
<p>repositorio principal. Leer el trabajo de la base de datos y enviarlo al</p>
<p>repositorio principal.</p>
<p>¬øQu√© sucede con los usuarios que superan el tama√±o de la agrupaci√≥n?</p>
<p>Imagine que el tama√±o de cada agrupaci√≥n es</p>
<p>usuarios intentan usar crear, de modo que se adquieren diez</p>
<p>conexiones de base de datos y cada subproceso se interrumpe despu√©s de</p>
<p>esta adquisici√≥n pero antes de adquirir una conexi√≥n al repositorio</p>
<p>principal.</p>
<p>10 usuarios intentan usar actualizar, de modo que se adquieren las diez</p>
<p>conexiones al repositorio principal y cada subproceso se interrumpe</p>
<p>despu√©s de adquirir el repositorio principal pero antes de adquirir una</p>
<p>conexi√≥n a la base de datos.</p>
<p>Ahora los 10 subprocesos crear deben esperar a adquirir una conexi√≥n al</p>
<p>repositorio principal pero los 10 subprocesos actualizar deben esperar a</p>
<p>adquirir una conexi√≥n a la base de datos.</p>
<p>Bloqueo mutuo. El sistema no se recupera nunca.</p>
<p>Puede parecerle una situaci√≥n improbable pero ¬øqui√©n desea un sistema</p>
<p>que se colapsa cada semana? ¬øQui√©n quiere depurar un sistema con s√≠ntomas</p>
<p>tan dif√≠ciles de reproducir? Es el tipo de problema que tarda semanas en</p>
<p>resolverse.</p>
<p>Una soluci√≥n habitual consiste en a√±adir instrucciones de depuraci√≥n para</p>
<p>determinar qu√© sucede. Evidentemente, estas instrucciones cambian tanto el</p>
<p>c√≥digo que el bloqueo mutuo se genera en otras situaciones y tarda meses en</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[121]</p>
<p>volver a producirse</p>
<p>Para solucionar realmente el problema del bloqueo absoluto, debemos</p>
<p>entender sus causas. Para que se produzca, deben darse cuatro condiciones:</p>
<p>Exclusi√≥n mutua.</p>
<p>Bloqueo y espera.</p>
<p>No expropiaci√≥n.</p>
<p>Espera circular.</p>
<h3 id="exclusion-mutua-359">Exclusi√≥n mutua</h3>
<p>La exclusi√≥n mutua se produce cuando varios subprocesos deben usar los</p>
<p>mismos recursos y dichos recursos</p>
<p>No se pueden usar en varios subprocesos al mismo tiempo.</p>
<p>Son de n√∫mero limitado.</p>
<p>Un ejemplo t√≠pico de este tipo de recurso es una conexi√≥n de base de</p>
<p>datos, un archivo abierto para escritura, un bloqueo de registro un</p>
<p>sem√°foro.</p>
<h3 id="bloqueo-y-espera-360">Bloqueo y espera</h3>
<p>Cuando un subproceso adquiere un recurso, no lo libera hasta adquirir los</p>
<p>dem√°s recursos que necesita y terminar su trabajo.</p>
<h3 id="no-expropiacion-361">No expropiaci√≥n</h3>
<p>Un subproceso no puede adue√±arse de los recursos de otro. Cuando un</p>
<p>subproceso obtiene un recurso, la √∫nica forma de que otro lo consiga es que</p>
<p>el primero lo libere.</p>
<h3 id="espera-circular-362">Espera circular</h3>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Tambi√©n se denomina abrazo mortal. Imagine dos subprocesos, T1 y T2, y</p>
<p>dos recursos, R1 y R2. T1 tiene R1, T2 tiene R2. T1 tambi√©n necesita R2 y</p>
<p>T2 tambi√©n necesita R1. Es similar al diagrama de la figura A.3:</p>
<p>Figura A.3.</p>
<p>Estas cuatro condiciones deben cumplirse para que se produzca un</p>
<p>bloqueo mutuo. Si se incumple alguna de ellas, no se producir√°.</p>
<h3 id="evitar-la-exclusion-mutua-363">Evitar la exclusi√≥n mutua</h3>
<p>Una estrategia para evitar el bloqueo mutuo es impedir la condici√≥n de</p>
<p>exclusi√≥n mutua, por medio de lo siguiente:</p>
<p>Usar recursos que permitan un uso simult√°neo, como por ejemplo,</p>
<p>AtomicInteger</p>
<p>Incrementar el n√∫mero de recursos para que sea igual o mayor que el</p>
<p>n√∫mero de subprocesos implicados.</p>
<p>Comprobar que todos los recursos est√°n libres antes de adquirir ninguno.</p>
<p>Desafortunadamente, la mayor√≠a de recursos son limitados y no permiten</p>
<p>un uso simult√°neo, y es habitual que la identidad del segundo recurso se base</p>
<p>en los resultados de operar sobre el primero, pero no se desanime, todav√≠a</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>quedan tres condiciones.</p>
<h3 id="evitar-bloqueo-y-espera-364">Evitar bloqueo y espera</h3>
<p>Tambi√©n puede eliminar el bloqueo mutuo si rechaza la espera. Compruebe</p>
<p>cada uno de los recursos antes de obtenerlos y libere todos los recursos y</p>
<p>comience de nuevo si detecta uno que est√© ocupado. Este enfoque genera</p>
<p>algunos problemas:</p>
<p>Inanici√≥n: Un subproceso no consigue adquirir los recursos que necesita</p>
<p>(puede que tenga una combinaci√≥n exclusiva de recursos que casi nunca</p>
<p>est√© disponible).</p>
<p>Bloqueo activo: Varios subprocesos pueden actuar al un√≠sono, adquirir</p>
<p>un recurso y liberarlo, de forma repetida. Es especialmente probable en</p>
<p>algoritmos de programaci√≥n de CPU simples (como dispositivos</p>
<p>incrustados o algoritmos de equilibrio de subprocesos escritos a mano).</p>
<p>En ambos casos, se puede reducir la producci√≥n. El primero reduce la</p>
<p>utilizaci√≥n de la CPU, mientras que el segundo genera una elevada utilizaci√≥n</p>
<p>de la CPU sin sentido.</p>
<p>Aunque esta estrategia parezca ineficaz, es mejor que nada. Como</p>
<p>ventaja, siempre se puede implementar si todo lo dem√°s falla.</p>
<h3 id="evitar-la-expropiacion-365">Evitar la expropiaci√≥n</h3>
<p>Otra estrategia para evitar el bloqueo mutuo consiste en permitir que todos</p>
<p>los subprocesos se apropien de los recursos de otros. Suele realizarse a trav√©s</p>
<p>de un sencillo mecanismo de solicitudes. Cuando un subproceso descubre que</p>
<p>hay un recurso ocupado, le solicita al propietario que lo libere. Si el</p>
<p>propietario tambi√©n espera a otro recurso, lo libera y comienza de nuevo.</p>
<p>Es similar al enfoque anterior, pero, como ventaja, un subproceso puede</p>
<p>esperar a un recurso, lo que reduce el n√∫mero de reinicios. Sin embargo, la</p>
<p>gesti√≥n de todas estas solicitudes puede resultar complicada.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h3 id="evitar-la-espera-circular-366">Evitar la espera circular</h3>
<p>Es el enfoque m√°s habitual para impedir el bloqueo mutuo. En la mayor√≠a de</p>
<p>sistemas, basta con una sencilla convenci√≥n acordada entre ambas partes.</p>
<p>En el ejemplo anterior del subproceso 1 que quiere tanto el recurso 1</p>
<p>como el 2, y el subproceso 2 que desea tanto el recurso 2 como el 1, al forzar</p>
<p>a ambos subprocesos a que asignen los recursos en el mismo orden se</p>
<p>imposibilita la espera circular.</p>
<p>En general, si todos los subprocesos pueden acordar un orden global de</p>
<p>los recursos y si todos asignan los recursos en ese orden, el bloqueo mutuo es</p>
<p>imposible. Pero como todas las estrategias, tambi√©n se pueden producir</p>
<p>problemas:</p>
<p>El orden de adquisici√≥n puede no corresponderse al orden de uso; por</p>
<p>tanto, un recurso adquirido al inicio puede que no se use hasta el final.</p>
<p>Esto puede bloquear recursos m√°s tiempo de lo estrictamente necesario.</p>
<p>En ocasiones no se puede imponer un orden de adquisici√≥n de recursos.</p>
<p>Si el ID del segundo recurso proviene de una operaci√≥n realizada en el</p>
<p>primero, ese orden no es factible.</p>
<p>Por tanto, existen varias formas de evitar el bloqueo mutuo. Algunas</p>
<p>provocan inanici√≥n, mientras que otras usan la CPU en exceso y reducen la</p>
<p>[122]</p>
<p>capacidad de respuesta. ¬° TANSTAAFL</p>
<p>El aislamiento de la parte relacionada con subprocesos de su soluci√≥n</p>
<p>para permitir ajustes experimentaci√≥n es una forma de aprender</p>
<p>determinar las estrategias √≥ptimas.</p>
<h3 id="probar-codigo-con-multiples-subprocesos-367">Probar c√≥digo con m√∫ltiples subprocesos</h3>
<p>¬øC√≥mo se puede crear una prueba que demuestre que el siguiente c√≥digo no</p>
<p>es correcto?</p>
<p>01: public class ClassWithThreadingProblem {</p>
<p>02: int nextId;</p>
<p>03:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>04: public int takeNextId() {</p>
<p>05: return nextId++;</p>
<p>06:</p>
<p>07:</p>
<p>Veamos la descripci√≥n de una prueba que lo demuestre:</p>
<p>Recordar el valor actual de nextId</p>
<p>Crear dos subprocesos y que cada uno invoque takeNextId() una vez.</p>
<p>Comprobar que el valor de nextId es dos m√°s que el inicial.</p>
<p>Ejecutar hasta demostrar que nextId s√≥lo se ha incrementado en uno y</p>
<p>no en dos.</p>
<p>En el Listado A-2 se reproduce la prueba:</p>
<p>Listado A-2</p>
<p>ClassWithThreadingProblemTest.java.</p>
<p>01: package example;</p>
<p>02:</p>
<p>03: import static org.junit.Assert.fail;</p>
<p>04:</p>
<p>05: import org.junit.Test;</p>
<p>06:</p>
<p>07: public class ClassWithThreadingProblemTest {</p>
<p>08: @Test</p>
<p>09: public void twoThreadsShouldFailEventually() throws Exception {</p>
<p>10: final ClassWithThreadingProblem classWithThreadingProblem</p>
<p>= new ClassWithThreadingProblem();</p>
<p>11:</p>
<p>12: Runnable runnable = new Runnable() {</p>
<p>13: public void run() {</p>
<p>14: ClassWithThreadingProblem.takeNextId();</p>
<p>15:</p>
<p>16: };</p>
<p>17:</p>
<p>18: for (int i = 0; i &lt; 50000; ++i) {</p>
<p>19: int startingId = classWithThreadingProblem.lastId;</p>
<p>20: int expectedResult = 2 + startingId;</p>
<p>21:</p>
<p>22: Thread t1 = new Thread(runnable);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>23: Thread t2 = new Thread(runnable);</p>
<p>24: t1.start();</p>
<p>25: t2.start();</p>
<p>26: t1.join();</p>
<p>27: t2.join();</p>
<p>28:</p>
<p>29: int endingId = classWithThreadingProblem.lastId;</p>
<p>30:</p>
<p>31: if (endingId != expectedResult)</p>
<p>32: return;</p>
<p>33:</p>
<p>34:</p>
<p>35: fail(‚ÄúShould have exposed a threading issue but it did not.‚Äù);</p>
<p>36:</p>
<p>37: }</p>
<p>L√≠nea Descripci√≥n</p>
<p>Crear una sola instancia de ClassWithThreadingProblem . Debemos</p>
<p>usar la palabra clave final ya que se usa despu√©s en una clase interna</p>
<p>an√≥nima.</p>
<p>12-16 Crear una clase interna an√≥nima que use la instancia de</p>
<p>ClassWithThreadingProblem</p>
<p>Ejecutar este c√≥digo hasta demostrar que falla, pero no tanto como</p>
<p>para que la prueba tarde demasiado. Es un acto de equilibrio; no</p>
<p>queremos esperar demasiado para demostrar el fallo. Elegir la</p>
<p>cantidad de ejecuciones es complicado, aunque como veremos</p>
<p>despu√©s, esta cifra se puede reducir considerablemente.</p>
<p>Recordar el valor inicial, la prueba intenta demostrar que el c√≥digo</p>
<p>de ClassWithThreadingProblem es incorrecto. Si se supera la</p>
<p>prueba, lo habr√° demostrado. Si la prueba falla, habr√° sido incapaz</p>
<p>de demostrarlo.</p>
<p>Esperamos que el valor final sea dos m√°s que el actual.</p>
<p>22-23 Crear dos subprocesos que usen el objeto creado en las l√≠neas 12-16.</p>
<p>De este modo contamos con dos posibles subprocesos que intentan</p>
<p>usar nuestra instancia de ClassWithThreadingProblem y ambos</p>
<p>interfieren entre s√≠.</p>
<p>24-25 Hacer que los dos subprocesos se puedan ejecutar.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>26-27 Esperar a que terminen los dos subprocesos antes de comprobar los</p>
<p>resultados.</p>
<p>Registrar el valor final.</p>
<p>31-32 ¬øEs diferente endingId a lo que esper√°bamos? En caso afirmativo, se</p>
<p>finaliza la prueba; hemos demostrado que el c√≥digo es incorrecto. En</p>
<p>caso negativo, volver a intentarlo.</p>
<p>Si hemos llegado hasta aqu√≠, la prueba no ha podido demostrar que el</p>
<p>c√≥digo de producci√≥n era incorrecto en una cantidad de tiempo</p>
<p>razonable; el c√≥digo ha fallado. O no es incorrecto o no hemos</p>
<p>realizado suficientes iteraciones para que se produzca la condici√≥n de</p>
<p>fallo.</p>
<p>Esta prueba establece las condiciones de un problema de actualizaci√≥n</p>
<p>concurrente. Sin embargo, el problema es tan infrecuente que la mayor√≠a de</p>
<p>las veces la prueba no lo detecta.</p>
<p>En realidad, para detectar el problema debemos establecer el n√∫mero de</p>
<p>iteraciones en m√°s de un mill√≥n. Incluso con esa cantidad, en diez</p>
<p>ejecuciones de un bucle de 1 000 000, el problema s√≥lo apareci√≥ una vez, lo</p>
<p>que significa que debemos aumentar las iteraciones para obtener fallos</p>
<p>fiables. ¬øCu√°nto estamos dispuestos a esperar?</p>
<p>Aunque ajust√°ramos la prueba para obtener fallos fiables en un equipo,</p>
<p>seguramente tendr√≠amos que ajustarla con otros valores para ilustrar el fallo</p>
<p>en otro equipo, sistema operativo o versi√≥n de la MVJ.</p>
<p>Y es un problema sencillo . Si no podemos demostrarlo, ¬øqu√© pasar√°</p>
<p>cuando detectemos problemas realmente complejos?</p>
<p>¬øQu√© enfoques debemos adoptar para demostrar este sencillo fallo? Y,</p>
<p>sobre todo, ¬øc√≥mo podemos crear pruebas que demuestren fallos en un</p>
<p>c√≥digo m√°s complejo? ¬øC√≥mo podremos saber si el c√≥digo tiene fallos</p>
<p>cuando ni siquiera sabemos d√≥nde buscar?</p>
<p>Veamos algunas sugerencias:</p>
<p>Pruebas Monte Carlo: Crear pruebas flexibles que se puedan ajustar.</p>
<p>Despu√©s, ejecutarlas repetidamente, por ejemplo, en un servidor de</p>
<p>prueba, y cambiar los valores de ajuste aleatoriamente. Si las pruebas</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>fallan, el c√≥digo es incorrecto. Dise√±e las pruebas en las fases iniciales</p>
<p>para que un servidor de integraci√≥n continua las ejecute lo antes posible.</p>
<p>Registre las condiciones de fallo de las pruebas.</p>
<p>Ejecutar la prueba en todas las plataformas de desarrollo: De forma</p>
<p>repetida y continuada. Cuanto m√°s tiempo se ejecuten las pruebas sin</p>
<p>fallos, m√°s probable es que</p>
<p>El c√≥digo de producci√≥n sea correcto o</p>
<p>Las pruebas no sean adecuadas para revelar los problemas.</p>
<p>Ejecutar las pruebas en un equipo con distintas cargas: Si puede simular</p>
<p>cargas similares a las del entorno de producci√≥n, h√°galo.</p>
<p>Sin embargo, aunque realice todos estos pasos, no es probable que detecte</p>
<p>problemas de subprocesos en el c√≥digo. Los problemas m√°s complicados son</p>
<p>los que s√≥lo se producen una vez cada mil millones de oportunidades. Son el</p>
<p>azote de los sistemas complejos.</p>
<h3 id="herramientas-para-probar-codigo-basado-en-368">Herramientas para probar c√≥digo basado en</h3>
<h3 id="subprocesos-369">subprocesos</h3>
<p>[123]</p>
<p>IBM ha creado la herramienta ConTest . Lo que hace es instrumentar las</p>
<p>clases para aumentar las probabilidades de que falle el c√≥digo sin</p>
<p>subprocesos.</p>
<p>No tenemos relaci√≥n directa con IBM ni con el equipo que ha</p>
<p>desarrollado ConTest. Un colega nos la descubri√≥. Tras varios minutos de</p>
<p>usarla, notamos una gran mejor√≠a en la detecci√≥n de errores.</p>
<p>A continuaci√≥n, le indicamos c√≥mo usar ConTest:</p>
<p>Crear pruebas y c√≥digo de producci√≥n, asegur√°ndonos que haya pruebas</p>
<p>dise√±adas espec√≠ficamente para simular varios usuarios con diferentes</p>
<p>cargas, como mencionamos antes.</p>
<p>Instrumentar el c√≥digo de pruebas y producci√≥n con ConTest.</p>
<p>Ejecutar las pruebas.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Al instrumentar el c√≥digo con ConTest, la tasa de √©xito pas√≥ de un fallo</p>
<p>por cada mill√≥n de iteraciones a un fallo en 30 iteraciones. Los valores de</p>
<p>bucle de las distintas ejecuciones de la prueba tras la instrumentaci√≥n son los</p>
<p>siguientes: 13, 23, 0, 54, 16, 14, 6, 69, 107, 49, 2. Evidentemente, las clases</p>
<p>instrumentadas fallaban antes y con mayor fiabilidad.</p>
<h3 id="conclusion-370">Conclusi√≥n</h3>
<p>En este cap√≠tulo hemos realizado un breve recorrido por el vasto y complejo</p>
<p>territorio de la programaci√≥n concurrente. Apenas hemos mostrado la</p>
<p>superficie. Nos hemos centrado en disciplinas para mantener la limpieza del</p>
<p>c√≥digo concurrente, pero hay mucho m√°s que aprender si tiene pensado</p>
<p>dise√±ar sistemas concurrentes. Le recomendamos que empiece por el libro de</p>
<p>Doug Lea Concurrent Programming in Java: Design Principles and</p>
<p>[124]</p>
<p>Patterns</p>
<p>En este cap√≠tulo hemos presentado la actualizaci√≥n concurrente y las</p>
<p>disciplinas de sincronizaci√≥n y bloqueo para evitarla. Hemos visto c√≥mo los</p>
<p>subprocesos pueden mejorar la producci√≥n de un sistema vinculado a E/S y</p>
<p>las t√©cnicas limpias para lograr dichas mejoras. Hemos descrito el bloqueo</p>
<p>mutuo y las disciplinas para evitarlo de forma limpia.</p>
<p>Por √∫ltimo, hemos analizado estrategias para mostrar problemas de</p>
<p>concurrencia mediante la instrumentaci√≥n del c√≥digo.</p>
<h3 id="ejemplos-de-codigo-completos-371">Ejemplos de c√≥digo completos</h3>
<h3 id="clienteservidor-sin-subprocesos-372">Cliente/Servidor sin subprocesos</h3>
<p>Listado A-3</p>
<p>Server.java</p>
<p>package com.objectmentor.clientserver.nonthreaded;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>import java.io.IOException;</p>
<p>import java.net.ServerSocket;</p>
<p>import java.net.Socket;</p>
<p>import java.net.SocketException;</p>
<p>import common.MessageUtils;</p>
<p>public class Server implements Runnable {</p>
<p>ServerSocket serverSocket;</p>
<p>volatile boolean keepProcessing = true;</p>
<p>public Server(int port, int millisecondsTimeout) throws IOException {</p>
<p>serverSocket = new ServerSocket(port);</p>
<p>serverSocket.setSoTimeout(millisecondsTimeout);</p>
<p>public void run() {</p>
<p>System.out.printf(‚ÄúServer Starting\n‚Äù);</p>
<p>while (keepProcessing) {</p>
<p>try {</p>
<p>System.out.printf(‚Äúaccepting client\n‚Äù);</p>
<p>Socket socket = serverSocket.accept();</p>
<p>System.out.printf(‚Äúgot client\n‚Äù);</p>
<p>process(socket);</p>
<p>} catch (Exception e) {</p>
<p>handle(e);</p>
<p>private void handle(Exception e) {</p>
<p>if (!(e instanceof SocketException)) {</p>
<p>e.printStackTrace();</p>
<p>public void stopProcessing() {</p>
<p>keepProcessing = false;</p>
<p>closeIgnoringException(serverSocket);</p>
<p>void process(Socket socket) {</p>
<p>if (socket == null)</p>
<p>return;</p>
<p>try {</p>
<p>System.out.printf(‚ÄúServer: getting message\n‚Äù);</p>
<p>String message = MessageUtils.getMessage(socket);</p>
<p>System.out.printf(‚ÄúServer: got message: %s\n‚Äù, message);</p>
<p>Thread.sleep(1000);</p>
<p>System.out.printf(‚ÄúServer: sending reply: %s\n‚Äù, message);</p>
<p>MessageUtils.sendMessage(socket, ‚ÄúProcessed: ‚Äù + message);</p>
<p>System.out.printf(‚ÄúServer: sent\n‚Äù);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>closeIgnoringException(socket);</p>
<p>} catch (Exception e) {</p>
<p>e.printStackTrace();</p>
<p>private void closeIgnoringException(Socket socket) {</p>
<p>if (socket != null)</p>
<p>try {</p>
<p>socket.close();</p>
<p>} catch (IOException ignore) {</p>
<p>private void closeIgnoringException(ServerSocket serverSocket) {</p>
<p>if (serverSocket != null)</p>
<p>try {</p>
<p>serverSocket.close();</p>
<p>} catch (IOException ignore) {</p>
<p>Listado A-4</p>
<p>ClientTest.java.</p>
<p>package com.objectmentor.clientserver.nonthreaded;</p>
<p>import java.io.IOException;</p>
<p>import java.net.ServerSocket;</p>
<p>import java.net.Socket;</p>
<p>import java.net.SocketException;</p>
<p>import common.MessageUtils;</p>
<p>public class Server implements Runnable {</p>
<p>ServerSocket serverSocket;</p>
<p>volatile boolean keepProcessing = true;</p>
<p>public Server(int port, int millisecondsTimeout) throws IOException {</p>
<p>serverSocket = new ServerSocket(port);</p>
<p>serverSocket.setSoTimeout(millisecondsTimeout);</p>
<p>public void run() {</p>
<p>System.out.printf(‚ÄúServer Starting\n‚Äù);</p>
<p>while (keepProcessing) {</p>
<p>try {</p>
<p>System.out.printf(‚Äúaccepting client\n‚Äù);</p>
<p>Socket socket = serverSocket.accept();</p>
<p>System.out.printf(‚Äúgot client\n‚Äù);</p>
<p>process(socket);</p>
<p>} catch (Exception e) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>handle(e);</p>
<p>private void handle(Exception e) {</p>
<p>if (!(e instanceof SocketException)) {</p>
<p>e.printStackTrace();</p>
<p>public void stopProcessing() {</p>
<p>keepProcessing = false;</p>
<p>closeIgnoringException(serverSocket);</p>
<p>void process(Socket socket) {</p>
<p>if (socket == null)</p>
<p>return;</p>
<p>try {</p>
<p>System.out.printf(‚ÄúServer: getting message\n‚Äù);</p>
<p>String message = MessageUtils.getMessage(socket);</p>
<p>System.out.printf(‚ÄúServer: got message: %s\n‚Äù, message);</p>
<p>Thread.sleep(1000);</p>
<p>System.out.printf(‚ÄúServer: sending reply: %s\n‚Äù, message);</p>
<p>MessageUtils.sendMessage(socket, ‚ÄúProcessed: ‚Äù + message);</p>
<p>System.out.printf(‚ÄúServer: sent\n‚Äù);</p>
<p>closeIgnoringException(socket);</p>
<p>} catch (Exception e) {</p>
<p>e.printStackTrace();</p>
<p>private void closeIgnoringException(Socket socket) {</p>
<p>if (socket != null)</p>
<p>try {</p>
<p>socket.close();</p>
<p>} catch (IOException ignore) {</p>
<p>private void closeIgnoringException(ServerSocket serverSocket) {</p>
<p>if (serverSocket != null)</p>
<p>try {</p>
<p>serverSocket.close();</p>
<p>} catch (IOException ignore) {</p>
<p>Listado A-5</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>MessageUtils.java.</p>
<p>package common;</p>
<p>import java.io.IOException;</p>
<p>import java.io.InputStream;</p>
<p>import java.io.ObjectInputStream;</p>
<p>import java.io.ObjectOutputStream;</p>
<p>import java.io.OutputStream;</p>
<p>import java.net.Socket;</p>
<p>public class MessageUtils {</p>
<p>public static void sendMessage(Socket socket, String message)</p>
<p>throws IOException {</p>
<p>OutputStream stream = socket.getOutputStream();</p>
<p>ObjectOutputStream oos = new ObjectOutputStream(stream);</p>
<p>oos.writeUTF(message);</p>
<p>oos.flush();</p>
<p>public static String getMessage(Socket socket) throws IOException {</p>
<p>InputStream stream = socket.getInputStream();</p>
<p>ObjectInputStream ois = new ObjectInputStream(stream);</p>
<p>return ois.readUTF();</p>
<h3 id="clienteservidor-con-subprocesos-373">Cliente/Servidor con subprocesos</h3>
<p>Para cambiar el servidor para que use subprocesos basta con cambiar el</p>
<p>mensaje process (las nuevas l√≠neas se muestran en negrita para destacarlas):</p>
<p>void process(final Socket socket) {</p>
<p>if (socket == null)</p>
<p>return;</p>
<p>Runnable clientHandler = new Runnable() {</p>
<p>public void run() {</p>
<p>try {</p>
<p>System.out.printf(‚ÄúServer: getting message\n‚Äù);</p>
<p>String message = MessageUtils.getMessage(socket);</p>
<p>System.out.printf(‚ÄúServer: got message: %s\n‚Äù, message);</p>
<p>Thread.sleep(1000);</p>
<p>System.out.printf(‚ÄúServer: sending reply: %s\n‚Äù, message);</p>
<p>MessageUtils.sendMessage(socket, ‚ÄúProcessed: ‚Äù + message);</p>
<p>System.out.printf(‚ÄúServer: sent\n‚Äù);</p>
<p>closeIgnoringException(socket);</p>
<p>} catch (Exception e) {</p>
<p>e.printStackTrace();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>};</p>
<p>Thread clientConnection = new Thread(clientHandler);</p>
<p>clientConnection.start();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="apendice-b-374">Ap√©ndice B</h1>
<h1 id="orgjfreedateserialdate-375">org.jfree.date.SerialDate</h1>
<p>Listado B-1</p>
<p>SerialDate.Java</p>
<p>/*==============================================================</p>
<ul>
<li>JCommon: biblioteca gratuita de clases de prop√≥sito general para</li>
</ul>
<p>Java(tm)</p>
<p>*==============================================================</p>
<ul>
<li>(C) Copyright 2000-2005, de Object Refinery Limited y colaboradores.</li>
<li>Informaci√≥n del proyecto: http://www.jfree.org/jcommon/index.html</li>
<li>Esta biblioteca es software gratuito; puede distribuirla y/o modificarla</li>
<li>bajo las condiciones de la Licencia p√∫blica general GNU publicada por</li>
<li>la Free Software Foundation; ya sea la versi√≥n 2.1 de la licencia, u</li>
<li>otra versi√≥n posterior (de su elecci√≥n).</li>
<li>Esta biblioteca se distribuye con la intenci√≥n de que sea √∫til, pero</li>
<li>SIN GARANT√çA ALGUNA, incluida la garant√≠a impl√≠cita de COMERCIABILIDAD</li>
<li>e IDONEIDAD PARA UN DETERMINADO FIN. Consulte la Licencia</li>
<li>p√∫blica general GNU si necesita m√°s informaci√≥n al respecto.</li>
<li>Deber√≠a haber recibido una copia de la Licencia p√∫blica general GNU</li>
<li>junto a esta biblioteca; en caso contrario, contacte con la Free</li>
</ul>
<p>Software</p>
<ul>
<li>Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-</li>
</ul>
<p>1301,</p>
<ul>
<li>EE.UU.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>[Java es una marca comercial o marca comercial registrada de Sun</li>
<li>Microsystems, Inc. en Estados Unidos y otros pa√≠ses.]</li>
<li>------------------</li>
<li>SerialDate.java</li>
<li>------------------</li>
<li>(C) Copyright 2001-2005, de Object Refinery Limited.</li>
<li>Autor original: David Gilbert (para Object Refinery Limited);</li>
<li>Colaborador(es): -;</li>
<li>$Id: SerialDate.java,v 1.7 2005/11/03 09:25:17 mungady Exp $</li>
<li>Cambios (11-Oct-2001)</li>
<li>--------------------------------------</li>
<li>11-Oct-2001: Reorganizaci√≥n de la clase y cambio a un nuevo paquete</li>
<li>com.jrefinery.date (DG);</li>
<li>05-Nov-2001: Se a√±ade un m√©todo getDescription() y se elimina la clase</li>
<li>NotableDate (DG);</li>
<li>12-Nov-2001: IBD requiere el m√©todo setDescription(), una vez eliminada</li>
</ul>
<p>la clase</p>
<ul>
<li>NotableDate (DG); Se cambian getPreviousDayOfWeek(),</li>
<li>getFollowingDayOfWeek() y getNearestDayOfWeek() para corregir</li>
<li>errores (DG);</li>
<li>05-Dic-2001: Error corregido en la clase SpreadsheetDate (DG);</li>
<li>29-May-2002: Se transfieren las constantes de mes a una interfaz</li>
</ul>
<p>independiente</p>
<ul>
<li>(MonthConstants) (DG);</li>
<li>27-Ago-2002: Error corregido en el m√©todo addMonths(), gracias a N√°levka</li>
</ul>
<p>Petr (DG);</p>
<ul>
<li>03-Oct-2002: Errores indicados por Checkstyle (DG) corregidos;</li>
<li>13-Mar-2003: Implementaci√≥n de Serializable (DG);</li>
<li>29-May-2003: Error corregido en el m√©todo addMonths (DG);</li>
<li>04-Sep-2003: Implementaci√≥n de Comparable. Actualizaci√≥n de los javadoc</li>
</ul>
<p>isInRange (DG);</p>
<ul>
<li>05-Ene-2005: Error corregido en el m√©todo addYears() (1096282) (DG);</li>
</ul>
<p>*/</p>
<p>package org.jfree.date;</p>
<p>import java.io.Serializable;</p>
<p>import java.text.DateFormatSymbols;</p>
<p>import java.text.SimpleDateFormat;</p>
<p>import java.util.Calendar;</p>
<p>import java.util.GregorianCalendar;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Clase abstracta que define nuestros requisitos para manipular fechas,</li>
<li>sin limitaci√≥n a una determinada implementaci√≥n.</li>
<li>&lt;P&gt;</li>
<li>Requisito 1: coincidir al menos con el procesamiento de fechas en Excel;</li>
<li>Requisito 2: la clase es inmutable;</li>
<li>&lt;P&gt;</li>
<li>¬øPor qu√© no usar java.util.Date? Lo haremos, cuando tenga sentido. En</li>
</ul>
<p>ocasiones,</p>
<ul>
<li>java.util.Date puede ser demasiado precisa; representa un instante en el</li>
</ul>
<p>tiempo,</p>
<ul>
<li>con una precisi√≥n de 1/1000 de segundo (y la fecha depende de la</li>
<li>zona horaria). En ocasiones s√≥lo querremos representar un d√≠a concreto</li>
</ul>
<p>(como el 21</p>
<ul>
<li>de enero de 2015) sin preocuparnos de la hora del d√≠a, la</li>
<li>zona horaria u otros aspectos. Para eso hemos definido DayDate.</li>
<li>&lt;P&gt;</li>
<li>Puede invocar getInstance() para obtener una subclase concreta de</li>
</ul>
<p>SerialDate,</p>
<ul>
<li>sin preocuparse de su implementaci√≥n exacta</li>
<li>@author David Gilbert</li>
</ul>
<p>*/</p>
<p>public abstract class SerialDate implements Comparable,</p>
<p>Serializable,</p>
<p>MonthConstants {</p>
<p>/** Para serializaci√≥n. */</p>
<p>private static final long serialVersionUID = -293716040467423637L;</p>
<p>/** S√≠mbolos de formato de fecha. */</p>
<p>public static final DateFormatSymbols</p>
<p>DATE_FORMAT_SYMBOLS = new</p>
<p>SimpleDateFormat().getDateFormatSymbols();</p>
<p>/** N√∫mero de serie para el 1 de enero de 1900. */</p>
<p>public static final int SERIAL_LOWER_BOUND = 2;</p>
<p>/** N√∫mero de serie para el 31 de diciembre de 9999. */</p>
<p>public static final int SERIAL_UPPER_BOUND = 2958465;</p>
<p>/** Valor de a√±o m√°s bajo admitido por este formato de fecha. */</p>
<p>public static final int MINIMUM_YEAR_SUPPORTED = 1900;</p>
<p>/** Valor de a√±o m√°s alto admitido por este formato de fecha. */</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public static final int MAXIMUM_YEAR_SUPPORTED = 9999;</p>
<p>/** Constante √∫til para lunes; equivale a java.util.Calendar.MONDAY.</p>
<p>*/</p>
<p>public static final int MONDAY = Calendar.MONDAY;</p>
<p>/**</p>
<ul>
<li>Constante √∫til para martes; equivale a java.util.Calendar.TUESDAY.</li>
<li>/</li>
</ul>
<p>public static final int TUESDAY = Calendar.TUESDAY;</p>
<p>/**</p>
<ul>
<li>Constante √∫til para mi√©rcoles; equivale a</li>
<li>java.util.Calendar.WEDNESDAY.</li>
</ul>
<p>*/</p>
<p>public static final int WEDNESDAY = Calendar.WEDNESDAY;</p>
<p>/**</p>
<ul>
<li>Constante √∫til para jueves; equivale a java.util.Calendar.THURSDAY.</li>
</ul>
<p>*/</p>
<p>public static final int THURSDAY = Calendar.THURSDAY;</p>
<p>/** Constante √∫til para viernes; equivale a</p>
<p>java.util.Calendar.FRIDAY. */</p>
<p>public static final int FRIDAY = Calendar.FRIDAY;</p>
<p>/**</p>
<ul>
<li>Constante √∫til para s√°bado; equivale a java.util.Calendar.SATURDAY.</li>
</ul>
<p>*/</p>
<p>public static final int SATURDAY = Calendar.SATURDAY;</p>
<p>/** Constante √∫til para domingo; equivale a</p>
<p>java.util.Calendar.SUNDAY. */</p>
<p>public static final int SUNDAY = Calendar.SUNDAY;</p>
<p>/** N√∫mero de d√≠as de cada mes en a√±os no bisiestos. */</p>
<p>static final int[] LAST_DAY_OF_MONTH =</p>
<p>{0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};</p>
<p>/** N√∫mero de d√≠as en un a√±o (no bisiesto) hasta el final de cada</p>
<p>mes. */</p>
<p>static final int[] AGGREGATE_DAYS_TO_END_OF_MONTH =</p>
<p>{0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365};</p>
<p>/** N√∫mero de d√≠as en un a√±o hasta el final del mes anterior. */</p>
<p>static final int[] AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH =</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>{0, 0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365};</p>
<p>/** N√∫mero de d√≠as en un a√±o bisiesto hasta el final de cada mes. */</p>
<p>static final int[] LEAP_YEAR_AGGREGATE_DAYS_TO_END_OF_MONTH =</p>
<p>{0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366};</p>
<p>/**</p>
<ul>
<li>N√∫mero de d√≠as en un a√±o bisiesto hasta el final del mes anterior.</li>
</ul>
<p>*/</p>
<p>static final int[]</p>
<p>LEAP_YEAR_AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH =</p>
<p>{0, 0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366};</p>
<p>/** Una constante √∫til para hacer referencia a la primera semana del</p>
<p>mes. */</p>
<p>public static final int FIRST_WEEK_IN_MONTH = 1;</p>
<p>/** Una constante √∫til para hacer referencia a la segunda semana del</p>
<p>mes. */</p>
<p>public static final int SECOND_WEEK_IN_MONTH = 2;</p>
<p>/** Una constante √∫til para hacer referencia a la tercera semana del</p>
<p>mes. */</p>
<p>public static final int THIRD_WEEK_IN_MONTH = 3;</p>
<p>/** Una constante √∫til para hacer referencia a la cuarta semana del</p>
<p>mes. */</p>
<p>public static final int FOURTH_WEEK_IN_MONTH = 4;</p>
<p>/** Una constante √∫til para hacer referencia a la √∫ltima semana del</p>
<p>mes. */</p>
<p>public static final int LAST_WEEK_IN_MONTH = 0;</p>
<p>/** Constante de intervalo. */</p>
<p>public static final int INCLUDE_NONE = 0;</p>
<p>/** Constante de intervalo. */</p>
<p>public static final int INCLUDE_FIRST = 1;</p>
<p>/** Constante de intervalo. */</p>
<p>public static final int INCLUDE_SECOND = 2;</p>
<p>/** Constante de intervalo. */</p>
<p>public static final int INCLUDE_BOTH = 3;</p>
<p>/**</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<ul>
<li>Constante √∫til para especificar un d√≠a de la semana con respecto a</li>
</ul>
<p>una fecha</p>
<ul>
<li>fija.</li>
</ul>
<p>*/</p>
<p>public static final int PRECEDING = -1;</p>
<p>/**</p>
<ul>
<li>Constante √∫til para especificar un d√≠a de la semana con respecto a</li>
</ul>
<p>una fecha</p>
<ul>
<li>fija.</li>
</ul>
<p>*/</p>
<p>public static final int NEAREST = 0;</p>
<p>/**</p>
<ul>
<li>Constante √∫til para especificar un d√≠a de la semana con respecto a</li>
</ul>
<p>una fecha</p>
<ul>
<li>fija.</li>
</ul>
<p>*/</p>
<p>public static final int FOLLOWING = 1;</p>
<p>/** Una descripci√≥n para la fecha. */</p>
<p>private String description;</p>
<p>/**</p>
<ul>
<li>Constructor predeterminado.</li>
</ul>
<p>*/</p>
<p>protected SerialDate() {</p>
<p>/**</p>
<ul>
<li>Devuelve &lt;code&gt;true&lt;/code&gt; si el c√≥digo entero proporcionado</li>
</ul>
<p>representa un</p>
<ul>
<li>d√≠a de la semana v√°lido y &lt;code&gt;false&lt;/code&gt; en caso contrario.</li>
<li>@param code el c√≥digo del que se comprueba la validez.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si el c√≥digo entero proporcionado</li>
</ul>
<p>representa un</p>
<ul>
<li>d√≠a de la semana v√°lido y &lt;code&gt;false&lt;/code&gt; en caso contrario.</li>
</ul>
<p>*/</p>
<p>public static boolean isValidWeekdayCode(final int code) {</p>
<p>switch(code) {</p>
<p>case SUNDAY:</p>
<p>case MONDAY:</p>
<p>case TUESDAY:</p>
<p>case WEDNESDAY:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>case THURSDAY:</p>
<p>case FRIDAY:</p>
<p>case SATURDAY:</p>
<p>return true;</p>
<p>default:</p>
<p>return false;</p>
<p>/**</p>
<ul>
<li>Convierte la cadena proporcionada en un d√≠a de la semana.</li>
<li>@param s una cadena que representa el d√≠a de la semana.</li>
<li>@return &lt;code&gt;-1&lt;/code&gt; si la cadena no se puede convertir o el d√≠a</li>
</ul>
<p>de</p>
<ul>
<li>la semana en caso contrario.</li>
</ul>
<p>*/</p>
<p>public static int stringToWeekdayCode(String s) {</p>
<p>final String[] shortWeekdayNames</p>
<p>= DATE_FORMAT_SYMBOLS.getShortWeekdays();</p>
<p>final String[] weekDayNames = DATE_FORMAT_SYMBOLS.getWeekdays();</p>
<p>int result = -1;</p>
<p>s = s.trim();</p>
<p>for (int i = 0; i &lt; weekDayNames.length; i++) {</p>
<p>if (s.equals(shortWeekdayNames[i])) {</p>
<p>result = i;</p>
<p>break;</p>
<p>if (s.equals(weekDayNames[i])) {</p>
<p>result = i;</p>
<p>break;</p>
<p>return result;</p>
<p>/**</p>
<ul>
<li>Devuelve una representaci√≥n en cadena del d√≠a de la semana</li>
</ul>
<p>proporcionado.</p>
<ul>
<li>&lt;P&gt;</li>
<li>Necesitamos un enfoque mejor.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>@param weekday el d√≠a de la semana.</li>
<li>@return una cadena que representa el d√≠a de la semana</li>
</ul>
<p>proporcionado.</p>
<p>*/</p>
<p>public static String weekdayCodeToString(final int weekday) {</p>
<p>final String[] weekdays = DATE_FORMAT_SYMBOLS.getWeekdays();</p>
<p>return weekdays[weekday];</p>
<p>/**</p>
<ul>
<li>Devuelve una matriz de nombres de mes.</li>
<li>@return una matriz de nombres de mes.</li>
</ul>
<p>*/</p>
<p>public static String[] getMonths() {</p>
<p>return getMonths(false);</p>
<p>/**</p>
<ul>
<li>Devuelve una matriz de nombres de mes.</li>
<li>@param shortened un indicador para indicar que deben devolverse los</li>
</ul>
<p>nombres</p>
<ul>
<li>de mes en formato reducido.</li>
<li>@return una matriz de nombres de mes.</li>
</ul>
<p>*/</p>
<p>public static String[] getMonths(final boolean shortened) {</p>
<p>if (shortened) {</p>
<p>return DATE_FORMAT_SYMBOLS.getShortMonths();</p>
<p>else {</p>
<p>return DATE_FORMAT_SYMBOLS.getMonths();</p>
<p>/**</p>
<ul>
<li>Devuelve true si el c√≥digo entero proporcionado representa un mes</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
</ul>
<p>v√°lido.</p>
<ul>
<li>@param code el c√≥digo del que se comprueba la validez.</li>
<li>return &lt;code&gt;true&lt;/code&gt; si el c√≥digo entero proporcionado</li>
</ul>
<p>representa un</p>
<ul>
<li>mes v√°lido.</li>
</ul>
<p>*/</p>
<p>public static boolean isValidMonthCode(final int code) {</p>
<p>switch(code) {</p>
<p>case JANUARY:</p>
<p>case FEBRUARY:</p>
<p>case MARCH:</p>
<p>case APRIL:</p>
<p>case MAY:</p>
<p>case JUNE:</p>
<p>case JULY:</p>
<p>case AUGUST:</p>
<p>case SEPTEMBER:</p>
<p>case OCTOBER:</p>
<p>case NOVEMBER:</p>
<p>case DECEMBER:</p>
<p>return true;</p>
<p>default:</p>
<p>return false;</p>
<p>/**</p>
<ul>
<li>Devuelve el trimestre del mes especificado.</li>
<li>@param code el c√≥digo del mes (1-12).</li>
<li>@return el trimestre al que pertenece el mes.</li>
<li>@throws java.lang.IllegalArgumentException</li>
</ul>
<p>*/</p>
<p>public static int monthCodeToQuarter(final int code) {</p>
<p>switch(code) {</p>
<p>case JANUARY:</p>
<p>case FEBRUARY:</p>
<p>case MARCH: return 1;</p>
<p>case APRIL:</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>case MAY:</p>
<p>case JUNE: return 2;</p>
<p>case JULY:</p>
<p>case AUGUST:</p>
<p>case SEPTEMBER: return 3;</p>
<p>case OCTOBER:</p>
<p>case NOVEMBER:</p>
<p>case DECEMBER: return 4;</p>
<p>default: throw new IllegalArgumentException(</p>
<p>‚ÄúSerialDate.monthCodeToQuarter: invalid month code.‚Äù);</p>
<p>/**</p>
<ul>
<li>Devuelve una cadena que representa el mes proporcionado.</li>
<li>&lt;P&gt;</li>
<li>La cadena devuelta es la forma extensa del nombre del mes obtenido</li>
</ul>
<p>de la</p>
<ul>
<li>configuraci√≥n regional.</li>
<li>@param month el mes.</li>
<li>@return una cadena que representa el mes proporcionado</li>
</ul>
<p>*/</p>
<p>public static String monthCodeToString(final int month) {</p>
<p>return monthCodeToString(month, false);</p>
<p>/**</p>
<ul>
<li>Devuelve una cadena que representa el mes proporcionado.</li>
<li>&lt;P&gt;</li>
<li>La cadena devuelta es la forma extensa o reducida del nombre del</li>
</ul>
<p>mes</p>
<ul>
<li>obtenido de la configuraci√≥n regional.</li>
<li>@param month el mes.</li>
<li>@param shortened si &lt;code&gt;true&lt;/code&gt; devuelve la abreviatura del</li>
<li>mes.</li>
<li>@return una cadena que representa el mes proporcionado.</li>
<li>@throws java.lang.IllegalArgumentException</li>
</ul>
<p>*/</p>
<p>public static String monthCodeToString(final int month,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>final boolean shortened) {</p>
<p>// comprobar argumentos...</p>
<p>if (!isValidMonthCode(month)) {</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúSerialDate.monthCodeToString: month outside valid range.‚Äù);</p>
<p>final String[] months;</p>
<p>if (shortened) {</p>
<p>months = DATE_FORMAT_SYMBOLS.getShortMonths();</p>
<p>else {</p>
<p>months = DATE_FORMAT_SYMBOLS.getMonths();</p>
<p>return months[month - 1];</p>
<p>/**</p>
<ul>
<li>Convierte una cadena en el c√≥digo del mes.</li>
<li>&lt;P&gt;</li>
<li>Este m√©todo devuelve una de las constantes JANUARY, FEBRUARY, ...,</li>
<li>DECEMBER correspondientes a la cadena. Si la cadena no se</li>
<li>reconoce, este m√©todo devuelve -1.</li>
<li>@param s la cadena que analizar.</li>
<li>@return &lt;code&gt;-1&lt;/code&gt; si la cadena no se puede analizar, o el mes</li>
</ul>
<p>del</p>
<ul>
<li>a√±o en caso contrario.</li>
</ul>
<p>*/</p>
<p>public static int stringToMonthCode(String s) {</p>
<p>final String[] shortMonthNames =</p>
<p>DATE_FORMAT_SYMBOLS.getShortMonths();</p>
<p>final String[] monthNames = DATE_FORMAT_SYMBOLS.getMonths();</p>
<p>int result = -1;</p>
<p>s = s.trim();</p>
<p>// primero intentar analizar la cadena como entero (1-12)...</p>
<p>try {</p>
<p>result = Integer.parseInt(s);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>catch (NumberFormatException e) {</p>
<p>// suprimir</p>
<p>// buscar por los nombres de los meses...</p>
<p>if ((result &lt; 1) || (result &gt; 12)) {</p>
<p>for (int i = 0; i &lt; monthNames.length; i++) {</p>
<p>if (s.equals(shortMonthNames[i])) {</p>
<p>result = i + 1;</p>
<p>break;</p>
<p>if (s.equals(monthNames[i])) {</p>
<p>result = i + 1;</p>
<p>break;</p>
<p>return result;</p>
<p>/**</p>
<ul>
<li>Devuelve true si el c√≥digo entero proporcionado representa una</li>
</ul>
<p>semana</p>
<ul>
<li>del mes v√°lida y false en caso contrario</li>
<li>@param code el c√≥digo del que se comprueba la validez.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si el c√≥digo entero proporcionado</li>
</ul>
<p>representa una</p>
<ul>
<li>semana del mes v√°lida.</li>
</ul>
<p>*/</p>
<p>public static boolean isValidWeekInMonthCode(final int code) {</p>
<p>switch(code) {</p>
<p>case FIRST_WEEK_IN_MONTH:</p>
<p>case SECOND_WEEK_IN_MONTH:</p>
<p>case THIRD_WEEK_IN_MONTH:</p>
<p>case FOURTH_WEEK_IN_MONTH:</p>
<p>case LAST_WEEK_IN_MONTH: return true;</p>
<p>default: return false;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Determina si el a√±o especificado es bisiesto o no.</li>
<li>@param yyyy el a√±o (entre 1900 y 9999).</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si el a√±o especificado es bisiesto.</li>
</ul>
<p>*/</p>
<p>public static boolean isLeapYear(final int yyyy) {</p>
<p>if ((yyyy % 4) != 0) {</p>
<p>return false;</p>
<p>else if ((yyyy % 400) == 0) {</p>
<p>return true;</p>
<p>else if ((yyyy % 100) == 0) {</p>
<p>return false;</p>
<p>else {</p>
<p>return true;</p>
<p>/**</p>
<ul>
<li>Devuelve el n√∫mero de a√±os bisiestos desde 1900 hasta el a√±o</li>
</ul>
<p>especificado</p>
<ul>
<li>INCLUSIVE.</li>
<li>&lt;P&gt;</li>
<li>1900 no es un a√±o bisiesto.</li>
<li>@param yyyy el a√±o (entre 1900 y 9999).</li>
<li>@return el n√∫mero de a√±os bisiestos desde 1900 hasta el a√±o</li>
</ul>
<p>especificado.</p>
<p>*/</p>
<p>public static int leapYearCount(final int yyyy) {</p>
<p>final int leap4 = (yyyy - 1896) / 4;</p>
<p>final int leap100 = (yyyy - 1800) / 100;</p>
<p>final int leap400 = (yyyy - 1600) / 400;</p>
<p>return leap4 - leap100 + leap400;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Devuelve el n√∫mero del √∫ltimo d√≠a del mes, teniendo en cuenta los</li>
<li>a√±os bisiestos.</li>
<li>@param month el mes.</li>
<li>@param yyyy el a√±o (entre 1900 y 9999).</li>
<li>@return el n√∫mero del √∫ltimo d√≠a del mes.</li>
</ul>
<p>*/</p>
<p>public static int lastDayOfMonth(final int month, final int yyyy) {</p>
<p>final int result = LAST_DAY_OF_MONTH[month];</p>
<p>if (month != FEBRUARY) {</p>
<p>return result;</p>
<p>else if (isLeapYear(yyyy)) {</p>
<p>return result + 1;</p>
<p>else {</p>
<p>return result;</p>
<p>/**</p>
<ul>
<li>Crea una nueva fecha a√±adiendo el n√∫mero especificado de d√≠as a la</li>
</ul>
<p>fecha</p>
<ul>
<li>base.</li>
<li>@param days el n√∫mero de d√≠as que a√±adir (puede ser negativo).</li>
<li>@param base la fecha base.</li>
<li>@return una nueva fecha.</li>
</ul>
<p>*/</p>
<p>public static SerialDate addDays(final int days, final SerialDate</p>
<p>base) {</p>
<p>final int serialDayNumber = base.toSerial() + days;</p>
<p>return SerialDate.createInstance(serialDayNumber);</p>
<p>/**</p>
<ul>
<li>Crea una nueva fecha a√±adiendo el n√∫mero especificado de meses a la</li>
</ul>
<p>fecha</p>
<ul>
<li>base.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>&lt;P&gt;</li>
<li>Si la fecha base es pr√≥xima al final del mes, el d√≠a del resultado</li>
<li>se puede ajustar ligeramente: 31 Mayo + 1 mes = 30 Junio.</li>
<li>@param months el n√∫mero de meses que a√±adir (puede ser negativo).</li>
<li>@param base la fecha base.</li>
<li>@return una nueva fecha.</li>
</ul>
<p>*/</p>
<p>public static SerialDate addMonths(final int months,</p>
<p>final SerialDate base) {</p>
<p>final int yy = (12 * base.getYYYY() + base.getMonth() + months - 1)</p>
<p>/ 12;</p>
<p>final int mm = (12 * base.getYYYY() + base.getMonth() + months ‚Äì 1)</p>
<p>% 12 + 1;</p>
<p>final int dd = Math.min(</p>
<p>base.getDayOfMonth(), SerialDate.lastDayOfMonth(mm, yy)</p>
<p>);</p>
<p>return SerialDate.createInstance(dd, mm, yy);</p>
<p>/**</p>
<ul>
<li>Crea una nueva fecha a√±adiendo el n√∫mero especificado de a√±os a la</li>
</ul>
<p>fecha</p>
<ul>
<li>base.</li>
<li>@param years el n√∫mero de a√±os que a√±adir (puede ser negativo).</li>
<li>@param base la fecha base.</li>
<li>@return Una nueva fecha.</li>
</ul>
<p>*/</p>
<p>public static SerialDate addYears(final int years, final SerialDate</p>
<p>base) {</p>
<p>final int baseY = base.getYYYY();</p>
<p>final int baseM = base.getMonth();</p>
<p>final int baseD = base.getDayOfMonth();</p>
<p>final int targetY = baseY + years;</p>
<p>final int targetD = Math.min(</p>
<p>baseD, SerialDate.lastDayOfMonth(baseM, targetY)</p>
<p>);</p>
<p>return SerialDate.createInstance(targetD, baseM, targetY);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Devuelve la √∫ltima fecha correspondiente al d√≠a de la semana</li>
</ul>
<p>especificado y</p>
<ul>
<li>ANTERIOR a la fecha base.</li>
<li>@param targetWeekday un c√≥digo para el d√≠a de la semana de destino.</li>
<li>@param base la fecha base.</li>
<li>@return la √∫ltima fecha correspondiente al d√≠a de la semana</li>
</ul>
<p>especificado y</p>
<ul>
<li>ANTERIOR a la fecha base.</li>
</ul>
<p>*/</p>
<p>public static SerialDate getPreviousDayOfWeek(final int</p>
<p>targetWeekday,</p>
<p>final SerialDate base) {</p>
<p>// comprobar argumentos...</p>
<p>if (!SerialDate.isValidWeekdayCode(targetWeekday)) {</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúInvalid day-of-the-week code.‚Äù</p>
<p>);</p>
<p>// buscar la fecha...</p>
<p>final int adjust;</p>
<p>final int baseDOW = base.getDayOfWeek();</p>
<p>if (baseDOW &gt; targetWeekday) {</p>
<p>adjust = Math.min(0, targetWeekday - baseDOW);</p>
<p>else {</p>
<p>adjust = -7 + Math.max(0, targetWeekday - baseDOW);</p>
<p>return SerialDate.addDays(adjust, base);</p>
<p>/**</p>
<ul>
<li>Devuelve la primera fecha que coincide con el d√≠a de la semana</li>
</ul>
<p>especificado</p>
<ul>
<li>y POSTERIOR a la fecha base.</li>
<li>@param targetWeekday un c√≥digo para el d√≠a de la semana de destino.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>@param base la fecha base.</li>
<li>@return la primera fecha que coincide con el d√≠a de la semana</li>
</ul>
<p>especificado</p>
<ul>
<li>y POSTERIOR a la fecha base.</li>
</ul>
<p>*/</p>
<p>public static SerialDate getFollowingDayOfWeek(final int</p>
<p>targetWeekday,</p>
<p>final SerialDate base) {</p>
<p>// comprobar argumentos...</p>
<p>if (!SerialDate.isValidWeekdayCode(targetWeekday)) {</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúInvalid day-of-the-week code.‚Äù</p>
<p>);</p>
<p>// buscar la fecha...</p>
<p>final int adjust;</p>
<p>final int baseDOW = base.getDayOfWeek();</p>
<p>if (baseDOW &gt; targetWeekday) {</p>
<p>adjust = 7 + Math.min(0, targetWeekday - baseDOW);</p>
<p>else {</p>
<p>adjust = Math.max(0, targetWeekday - baseDOW);</p>
<p>return SerialDate.addDays(adjust, base);</p>
<p>/**</p>
<ul>
<li>Devuelve la fecha que coincide con el d√≠a de la semana especificado</li>
</ul>
<p>y m√°s</p>
<ul>
<li>PR√ìXIMA a la fecha base.</li>
<li>@param targetDOW un c√≥digo para el d√≠a de la semana de destino.</li>
<li>@param base la fecha base.</li>
<li>@return la fecha que coincide con el d√≠a de la semana especificado</li>
</ul>
<p>y m√°s</p>
<ul>
<li>PR√ìXIMA a la fecha base.</li>
</ul>
<p>*/</p>
<p>public static SerialDate getNearestDayOfWeek(final int targetDOW,</p>
<p>final SerialDate base) {</p>
<p>// comprobar argumentos...</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>if (!SerialDate.isValidWeekdayCode(targetDOW)) {</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúInvalid day-of-the-week code.‚Äù</p>
<p>);</p>
<p>// buscar la fecha...</p>
<p>final int baseDOW = base.getDayOfWeek();</p>
<p>int adjust = -Math.abs(targetDOW - baseDOW);</p>
<p>if (adjust &gt;= 4) {</p>
<p>adjust = 7 - adjust;</p>
<p>if (adjust &lt;= -4) {</p>
<p>adjust = 7 + adjust;</p>
<p>return SerialDate.addDays(adjust, base);</p>
<p>/**</p>
<ul>
<li>Avanzar la fecha hasta el √∫ltimo d√≠a del mes.</li>
<li>@param base la fecha base.</li>
<li>@return una nueva fecha de serie.</li>
</ul>
<p>*/</p>
<p>public SerialDate getEndOfCurrentMonth(final SerialDate base) {</p>
<p>final int last = SerialDate.lastDayOfMonth(</p>
<p>base.getMonth(), base.getYYYY()</p>
<p>);</p>
<p>return SerialDate.createInstance(last, base.getMonth(),</p>
<p>base.getYYYY());</p>
<p>/**</p>
<ul>
<li>Devuelve una cadena correspondiente al c√≥digo de la semana del mes.</li>
<li>&lt;P&gt;</li>
<li>Necesitamos un enfoque mejor.</li>
<li>@param count un c√≥digo entero que representa la semana del mes.</li>
<li>@return una cadena correspondiente al c√≥digo de la semana del mes.</li>
</ul>
<p>*/</p>
<p>public static String weekInMonthToString(final int count) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>switch (count) {</p>
<p>case SerialDate.FIRST_WEEK_IN_MONTH : return ‚ÄúFirst‚Äù;</p>
<p>case SerialDate.SECOND_WEEK_IN_MONTH : return ‚ÄúSecond‚Äù;</p>
<p>case SerialDate.THIRD_WEEK_IN_MONTH : return ‚ÄúThird‚Äù;</p>
<p>case SerialDate.FOURTH_WEEK_IN_MONTH : return ‚ÄúFourth‚Äù;</p>
<p>case SerialDate.LAST_WEEK_IN_MONTH : return ‚ÄúLast‚Äù;</p>
<p>default :</p>
<p>return ‚ÄúSerialDate.weekInMonthToString(): invalid code.‚Äù;</p>
<p>/**</p>
<ul>
<li>Devuelve una cadena que representa el valor ‚Äòrelativo‚Äô</li>
</ul>
<p>proporcionado.</p>
<ul>
<li>&lt;P&gt;</li>
<li>Necesitamos un enfoque mejor.</li>
<li>@param relative una constante que representa el valor ‚Äòrelativo‚Äô.</li>
<li>@return una cadena que representa el valor ‚Äòrelativo‚Äô</li>
</ul>
<p>proporcionado.</p>
<p>*/</p>
<p>public static String relativeToString(final int relative) {</p>
<p>switch (relative) {</p>
<p>case SerialDate.PRECEDING : return ‚ÄúPreceding‚Äù;</p>
<p>case SerialDate.NEAREST : return ‚ÄúNearest‚Äù;</p>
<p>case SerialDate.FOLLOWING : return ‚ÄúFollowing‚Äù;</p>
<p>default : return ‚ÄúERROR : Relative To String‚Äù;</p>
<p>/**</p>
<ul>
<li>M√©todo de factor√≠a que devuelve una instancia de una subclase</li>
</ul>
<p>concreta de</p>
<ul>
<li>{@link SerialDate}.</li>
<li>@param day el d√≠a (1-31).</li>
<li>@param month el mes (1-12).</li>
<li>@param yyyy el a√±o (entre 1900 y 9999).</li>
<li>@return Una instancia de {@link SerialDate}</li>
</ul>
<p>*/</p>
<p>public static SerialDate createInstance(final int day, final int</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>month,</p>
<p>final int yyyy) {</p>
<p>return new SpreadsheetDate(day, month, yyyy);</p>
<p>/**</p>
<ul>
<li>M√©todo de factor√≠a que devuelve una instancia de una subclase</li>
</ul>
<p>concreta de</p>
<ul>
<li>{@link SerialDate}.</li>
<li>@param serial numero de serie del d√≠a (1 de enero de 1900 = 2).</li>
<li>@return una instancia de SerialDate.</li>
</ul>
<p>*/</p>
<p>public static SerialDate createInstance(final int serial) {</p>
<p>return new SpreadsheetDate(serial);</p>
<p>/**</p>
<ul>
<li>M√©todo de factor√≠a que devuelve una instancia de una subclase de</li>
</ul>
<p>SerialDate.</p>
<ul>
<li>@param date Un objeto de fecha de Java.</li>
<li>@return una instancia de SerialDate.</li>
</ul>
<p>*/</p>
<p>public static SerialDate createInstance(final java.util.Date date) {</p>
<p>final GregorianCalendar calendar = new GregorianCalendar();</p>
<p>calendar.setTime(date);</p>
<p>return new SpreadsheetDate(calendar.get(Calendar.DATE),</p>
<p>calendar.get(Calendar.MONTH) + 1,</p>
<p>calendar.get(Calendar.YEAR));</p>
<p>/**</p>
<ul>
<li>Devuelve el n√∫mero de serie de la fecha, siendo el 1 de enero de</li>
</ul>
<p>1900 = 2 (se</p>
<ul>
<li>corresponde, casi totalmente, al sistema de numeraci√≥n empleado en</li>
</ul>
<p>Microsoft</p>
<ul>
<li>Excel para Windows y Lotus 1-2-3).</li>
<li>@return el n√∫mero de serie de la fecha.</li>
</ul>
<p>*/</p>
<p>public abstract int toSerial();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Devuelve java.util.Date. Como java.util.Date tiene mayor precisi√≥n</li>
</ul>
<p>que</p>
<ul>
<li>SerialDate, debemos definir una convenci√≥n para ‚Äúla hora del d√≠a‚Äù.</li>
<li>@return this como &lt;code&gt;java.util.Date&lt;/code&gt;.</li>
</ul>
<p>*/</p>
<p>public abstract java.util.Date toDate();</p>
<p>/**</p>
<ul>
<li>Devuelve una descripci√≥n de la fecha.</li>
<li>@return una descripci√≥n de la fecha.</li>
</ul>
<p>*/</p>
<p>public String getDescription() {</p>
<p>return this.description;</p>
<p>/**</p>
<ul>
<li>Establece la descripci√≥n de la fecha.</li>
<li>@param description la nueva descripci√≥n de la fecha.</li>
</ul>
<p>*/</p>
<p>public void setDescription(final String description) {</p>
<p>this.description = description;</p>
<p>/**</p>
<ul>
<li>Convierte la fecha en una cadena.</li>
<li>@return una representaci√≥n en cadena de la fecha.</li>
</ul>
<p>*/</p>
<p>public String toString() {</p>
<p>return getDayOfMonth() + ‚Äú-‚Äù +</p>
<p>SerialDate.monthCodeToString(getMonth())</p>
<p>+ ‚Äú-‚Äù + getYYYY();</p>
<p>/**</p>
<ul>
<li>Devuelve el a√±o (con un intervalo v√°lido de 1900 a 9999).</li>
<li>@return el a√±o.</li>
</ul>
<p>*/</p>
<p>public abstract int getYYYY();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Devuelve el mes (Enero = 1, Febrero = 2, Marzo = 3).</li>
<li>@return el mes del a√±o.</li>
</ul>
<p>*/</p>
<p>public abstract int getMonth();</p>
<p>/**</p>
<ul>
<li>Devuelve el d√≠a del mes.</li>
<li>@return el d√≠a del mes.</li>
</ul>
<p>*/</p>
<p>public abstract int getDayOfMonth();</p>
<p>/**</p>
<ul>
<li>Devuelve el d√≠a de la semana.</li>
<li>@return el d√≠a de la semana.</li>
</ul>
<p>*/</p>
<p>public abstract int getDayOfWeek();</p>
<p>/**</p>
<ul>
<li>Devuelve la diferencia (en d√≠as) entre esta fecha y la</li>
<li>‚Äòotra‚Äô fecha especificada.</li>
<li>&lt;P&gt;</li>
<li>El resultado es positivo si esta fecha es posterior a la ‚Äòotra‚Äô y</li>
<li>negativo si es anterior.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return la diferencia entre esta fecha y la otra.</li>
</ul>
<p>*/</p>
<p>public abstract int compare(SerialDate other);</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa la misma fecha que la</li>
<li>SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa la misma</li>
</ul>
<p>fecha que</p>
<ul>
<li>la SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public abstract boolean isOn(SerialDate other);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa una fecha anterior en</li>
<li>comparaci√≥n a la SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa una fecha</li>
</ul>
<p>anterior</p>
<ul>
<li>en comparaci√≥n a la SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public abstract boolean isBefore(SerialDate other);</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa la misma fecha que la</li>
<li>SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa la misma</li>
</ul>
<p>fecha</p>
<ul>
<li>que la SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public abstract boolean isOnOrBefore(SerialDate other);</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa la misma fecha que la</li>
<li>SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa la misma</li>
</ul>
<p>fecha</p>
<ul>
<li>que la SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public abstract boolean isAfter(SerialDate other);</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa la misma fecha que la</li>
<li>SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa la misma</li>
</ul>
<p>fecha</p>
<ul>
<li>que la SerialDate especificada.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
</ul>
<p>*/</p>
<p>public abstract boolean isOnOrAfter(SerialDate other);</p>
<p>/**</p>
<ul>
<li>Devuelve &lt;code&gt;true&lt;/code&gt; si {@link SerialDate} se encuentra en el</li>
<li>rango especificado (INCLUSIVE). El orden de fecha de d1 y d2 no es</li>
<li>importante.</li>
<li>@param d1 fecha l√≠mite del rango.</li>
<li>@param d2 la otra fecha l√≠mite del rango.</li>
<li>@return Un valor booleano.</li>
</ul>
<p>*/</p>
<p>public abstract boolean isInRange(SerialDate d1, SerialDate d2);</p>
<p>/**</p>
<ul>
<li>Devuelve &lt;code&gt;true&lt;/code&gt; si {@link SerialDate} se encuentra en el</li>
<li>rango especificado (el invocador especifica si los puntos finales</li>
</ul>
<p>se</p>
<ul>
<li>incluyen o no). El orden de fecha de d1 y d2 no es importante.</li>
<li>@param d1 fecha l√≠mite del rango.</li>
<li>@param d2 la otra fecha l√≠mite del rango.</li>
<li>@param include un c√≥digo que controla si las fechas inicial y final</li>
<li>se incluyen o no en el rango.</li>
<li>@return Un valor booleano.</li>
</ul>
<p>*/</p>
<p>public abstract boolean isInRange(SerialDate d1, SerialDate d2,</p>
<p>int include);</p>
<p>/**</p>
<ul>
<li>Devuelve la √∫ltima fecha que coincide con el d√≠a de la semana</li>
</ul>
<p>especificado y</p>
<ul>
<li>que es ANTERIOR a esta fecha.</li>
<li>@param targetDOW un c√≥digo para el d√≠a de la semana de destino.</li>
<li>@return la √∫ltima fecha que coincide con el d√≠a de la semana</li>
</ul>
<p>especificado y</p>
<ul>
<li>que es ANTERIOR a esta fecha.</li>
</ul>
<p>*/</p>
<p>public SerialDate getPreviousDayOfWeek(final int targetDOW) {</p>
<p>return getPreviousDayOfWeek(targetDOW, this);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Devuelve la primera fecha que coincide con el d√≠a de la semana</li>
</ul>
<p>especificado</p>
<ul>
<li>y que es POSTERIOR a esta fecha.</li>
<li>@param targetDOW un c√≥digo para el d√≠a de la semana de destino.</li>
<li>@return la primera fecha que coincide con el d√≠a de la semana</li>
</ul>
<p>especificado</p>
<ul>
<li>que es POSTERIOR a esta fecha.</li>
</ul>
<p>*/</p>
<p>public SerialDate getFollowingDayOfWeek(final int targetDOW) {</p>
<p>return getFollowingDayOfWeek(targetDOW, this);</p>
<p>/**</p>
<ul>
<li>Devuelve la fecha m√°s pr√≥xima que coincide con el d√≠a de la semana</li>
</ul>
<p>especificado.</p>
<ul>
<li>@param targetDOW un c√≥digo para el d√≠a de la semana de destino.</li>
<li>@return la fecha m√°s pr√≥xima que coincide con el d√≠a de la semana</li>
</ul>
<p>especificado.</p>
<p>*/</p>
<p>public SerialDate getNearestDayOfWeek(final int targetDOW) {</p>
<p>return getNearestDayOfWeek(targetDOW, this);</p>
<p>1034 }</p>
<p>Listado B-2</p>
<p>SerialDateTest.java</p>
<p>/* =============================================================</p>
<ul>
<li>JCommon : biblioteca gratuita de clases de prop√≥sito general para</li>
</ul>
<p>Java(tm)</p>
<ul>
<li>=============================================================</li>
<li>(C) Copyright 2000-2005, de Object Refinery Limited y colaboradores.</li>
<li>Informaci√≥n del projecto: http://www.jfree.org/jcommon/index.html</li>
<li>Esta biblioteca es software gratuito; puede distribuirla y/o modificarla</li>
<li>bajo las condiciones de la Licencia p√∫blica general GNU publicada por</li>
<li>la Free Software Foundation; ya sea la versi√≥n 2.1 de la licencia, u</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>otra versi√≥n posterior (de su elecci√≥n).</li>
<li>Esta biblioteca se distribuye con la intenci√≥n de que sea √∫til, pero</li>
<li>SIN GARANT√çA ALGUNA, incluida la garant√≠a impl√≠cita de COMERCIABILIDAD</li>
<li>e IDONEIDAD PARA UN DETERMINADO FIN. Consulte la Licencia p√∫blica general</li>
</ul>
<p>GNU</p>
<ul>
<li>si necesita m√°s informaci√≥n al respecto.</li>
<li>Deber√≠a haber recibido una copia de la Licencia p√∫blica general GNU</li>
<li>junto a esta biblioteca; en caso contrario, contacte con la Free Software</li>
<li>Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,</li>
<li>EE.UU.</li>
<li>[Java es una marca comercial o marca comercial registrada de Sun</li>
<li>Microsystems, Inc. en Estados Unidos y otros pa√≠ses.]</li>
<li>-------------------------</li>
<li>SerialDateTests.java</li>
<li>-------------------------</li>
<li>(C) Copyright 2001-2005, por Object Refinery Limited.</li>
<li>Autor original: David Gilbert (por Object Refinery Limited);</li>
<li>Colaborador(es): -;</li>
<li>$Id: SerialDateTests.java,v 1.6 2005/11/16 15:58:40 taqua Exp $</li>
<li>Cambios</li>
<li>-----------</li>
<li>15-Nov-2001: Version 1 (DG);</li>
<li>25-Jun-2002: Se elimina la importaci√≥n innecesaria (DG);</li>
<li>24-Oct-2002: Errores indicados Checkstyle corregidos (DG);</li>
<li>13-Mar-2003: Se a√±ade prueba de serializaci√≥n (DG);</li>
<li>05-Jan-2005: Se a√±ade prueba para el informe de errores 1096282 (DG);</li>
</ul>
<p>*/</p>
<p>package org.jfree.date.junit;</p>
<p>import java.io.ByteArrayInputStream;</p>
<p>import java.io.ByteArrayOutputStream;</p>
<p>import java.io.ObjectInput;</p>
<p>import java.io.ObjectInputStream;</p>
<p>import java.io.ObjectOutput;</p>
<p>import java.io.ObjectOutputStream;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>import junit.framework.Test;</p>
<p>import junit.framework.TestCase;</p>
<p>import junit.framework.TestSuite;</p>
<p>import org.jfree.date.MonthConstants;</p>
<p>import org.jfree.date.SerialDate;</p>
<p>/**</p>
<ul>
<li>Pruebas JUnit para la clase {@link SerialDate}.</li>
</ul>
<p>*/</p>
<p>public class SerialDateTests extends TestCase {</p>
<p>/** Fecha que representa 9 de noviembre.</p>
<p>private SerialDate nov9Y2001;</p>
<p>/**</p>
<ul>
<li>Crea un nuevo caso de prueba.</li>
<li>@param name el nombre.</li>
</ul>
<p>*/</p>
<p>public SerialDateTests(final String name) {</p>
<p>super(name);</p>
<p>/**</p>
<ul>
<li>Devuelve una suite de pruebas para el ejecutor de pruebas JUnit.</li>
<li>@return La suite de pruebas.</li>
</ul>
<p>*/</p>
<p>public static Test suite() {</p>
<p>return new TestSuite(SerialDateTests.class);</p>
<p>/**</p>
<ul>
<li>Problema.</li>
</ul>
<p>*/</p>
<p>protected void setUp() {</p>
<p>this.nov9Y2001 = SerialDate.createInstance(9,</p>
<p>MonthConstants.NOVEMBER, 2001);</p>
<p>/**</p>
<ul>
<li>9 Nov 2001 m√°s dos meses debe ser 9 Ene 2002.</li>
</ul>
<p>*/</p>
<p>public void testAddMonthsTo9Nov2001() {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>final SerialDate jan9Y2002 = SerialDate.addMonths(2,</p>
<p>this.nov9Y2001);</p>
<p>final SerialDate answer = SerialDate.createInstance(9, 1, 2002);</p>
<p>assertEquals(answer, jan9Y2002);</p>
<p>/**</p>
<ul>
<li>Caso de prueba de un error, ya corregido.</li>
</ul>
<p>*/</p>
<p>public void testAddMonthsTo5Oct2003() {</p>
<p>final SerialDate d1 = SerialDate.createInstance(5,</p>
<p>MonthConstants.OCTOBER, 2003);</p>
<p>final SerialDate d2 = SerialDate.addMonths(2, d1);</p>
<p>assertEquals(d2, SerialDate.createInstance(5,</p>
<p>MonthConstants.DECEMBER, 2003));</p>
<p>/**</p>
<ul>
<li>Caso de prueba de un error, ya corregido.</li>
</ul>
<p>*/</p>
<p>public void testAddMonthsTo1Jan2003() {</p>
<p>final SerialDate d1 = SerialDate.createInstance(1,</p>
<p>MonthConstants.JANUARY, 2003);</p>
<p>final SerialDate d2 = SerialDate.addMonths(0, d1);</p>
<p>assertEquals(d2, d1);</p>
<p>/**</p>
<ul>
<li>El lunes anterior al viernes 9 de noviembre de 2001 debe ser el 5 de</li>
</ul>
<p>noviembre.</p>
<p>*/</p>
<p>public void testMondayPrecedingFriday9Nov2001() {</p>
<p>SerialDate mondayBefore = SerialDate.getPreviousDayOfWeek(</p>
<p>SerialDate.MONDAY, this.nov9Y2001</p>
<p>);</p>
<p>assertEquals(5, mondayBefore.getDayOfMonth());</p>
<p>/**</p>
<ul>
<li>El lunes posterior al viernes 9 de noviembre de 2001 debe ser el 12</li>
</ul>
<p>de noviembre.</p>
<p>*/</p>
<p>public void testMondayFollowingFriday9Nov2001() {</p>
<p>SerialDate mondayAfter = SerialDate.getFollowingDayOfWeek(</p>
<p>SerialDate.MONDAY, this.nov9Y2001</p>
<p>);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>assertEquals(12, mondayAfter.getDayOfMonth());</p>
<p>/**</p>
<ul>
<li>El lunes m√°s pr√≥ximo al viernes 9 de noviembre de 2001 debe ser el</li>
</ul>
<p>12 de noviembre.</p>
<p>*/</p>
<p>public void testMondayNearestFriday9Nov2001() {</p>
<p>SerialDate mondayNearest = SerialDate.getNearestDayOfWeek(</p>
<p>SerialDate.MONDAY, this.nov9Y2001</p>
<p>);</p>
<p>assertEquals(12, mondayNearest.getDayOfMonth());</p>
<p>/**</p>
<ul>
<li>El lunes m√°s pr√≥ximo al 22 de enero de 1970 cae en el 19.</li>
</ul>
<p>*/</p>
<p>public void testMondayNearest22Jan1970() {</p>
<p>SerialDate jan22Y1970 = SerialDate.createInstance(22,</p>
<p>MonthConstants.JANUARY, 1970);</p>
<p>SerialDate mondayNearest =</p>
<p>SerialDate.getNearestDayOfWeek(SerialDate.MONDAY, jan22Y1970);</p>
<p>assertEquals(19, mondayNearest.getDayOfMonth());</p>
<p>/**</p>
<ul>
<li>El problema es que la conversi√≥n de d√≠as en cadenas devuelva el</li>
</ul>
<p>resultado</p>
<ul>
<li>correcto. En realidad este resultado depende de la configuraci√≥n</li>
</ul>
<p>regional.</p>
<p>*/</p>
<p>public void testWeekdayCodeToString() {</p>
<p>final String test =</p>
<p>SerialDate.weekdayCodeToString(SerialDate.SATURDAY);</p>
<p>assertEquals(‚ÄúSaturday‚Äù, test);</p>
<p>/**</p>
<ul>
<li>Probar la conversi√≥n de una cadena en d√≠a de la semana. Esta prueba</li>
</ul>
<p>falla si</p>
<ul>
<li>la configuraci√≥n regional predeterminada no usa nombres de d√≠as en</li>
</ul>
<p>ingl√©s</p>
<p>*/</p>
<p>public void testStringToWeekday() {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>int weekday = SerialDate.stringToWeekdayCode(‚ÄúWednesday‚Äù);</p>
<p>assertEquals(SerialDate.WEDNESDAY, weekday);</p>
<p>weekday = SerialDate.stringToWeekdayCode(‚Äú Wednesday ‚Äù);</p>
<p>assertEquals(SerialDate.WEDNESDAY, weekday);</p>
<p>weekday = SerialDate.stringToWeekdayCode(‚ÄúWed‚Äù);</p>
<p>assertEquals(SerialDate.WEDNESDAY, weekday);</p>
<p>/**</p>
<ul>
<li>Probar la conversi√≥n de una cadena en mes. Esta prueba falla si la</li>
<li>configuraci√≥n regional predeterminada no usa nombres de d√≠as en</li>
</ul>
<p>ingl√©s</p>
<p>*/</p>
<p>public void testStringToMonthCode() {</p>
<p>int m = SerialDate.stringToMonthCode(‚ÄúJanuary‚Äù);</p>
<p>assertEquals(MonthConstants.JANUARY, m);</p>
<p>m = SerialDate.stringToMonthCode(‚Äú January ‚Äù);</p>
<p>assertEquals(MonthConstants.JANUARY, m);</p>
<p>m = SerialDate.stringToMonthCode(‚ÄúJan‚Äù);</p>
<p>assertEquals(MonthConstants.JANUARY, m);</p>
<p>/**</p>
<ul>
<li>Probar la conversi√≥n de un c√≥digo de mes en cadena.</li>
</ul>
<p>*/</p>
<p>public void testMonthCodeToStringCode() {</p>
<p>final String test =</p>
<p>SerialDate.monthCodeToString(MonthConstants.DECEMBER);</p>
<p>assertEquals(‚ÄúDecember‚Äù, test);</p>
<p>/**</p>
<ul>
<li>1900 no es un a√±o bisiesto.</li>
</ul>
<p>*/</p>
<p>public void testIsNotLeapYear1900() {</p>
<p>assertTrue(!SerialDate.isLeapYear(1900));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>2000 es un a√±o bisiesto.</li>
</ul>
<p>*/</p>
<p>public void testIsLeapYear2000() {</p>
<p>assertTrue(SerialDate.isLeapYear(2000));</p>
<p>/**</p>
<ul>
<li>El n√∫mero de a√±os bisiestos desde 1900 y hasta 1899 incluido es 0.</li>
</ul>
<p>*/</p>
<p>public void testLeapYearCount1899() {</p>
<p>assertEquals(SerialDate.leapYearCount(1899), 0);</p>
<p>/**</p>
<ul>
<li>El n√∫mero de a√±os bisiestos desde 1900 y hasta 1903 incluido es 0.</li>
</ul>
<p>*/</p>
<p>public void testLeapYearCount1903() {</p>
<p>assertEquals(SerialDate.leapYearCount(1903), 0);</p>
<p>/**</p>
<ul>
<li>El n√∫mero de a√±os bisiestos desde 1900 y hasta 1904 incluido es 1.</li>
</ul>
<p>*/</p>
<p>public void testLeapYearCount1904() {</p>
<p>assertEquals(SerialDate.leapYearCount(1904), 1);</p>
<p>/**</p>
<ul>
<li>El n√∫mero de a√±os bisiestos desde 1900 y hasta 1999 incluido es 24.</li>
</ul>
<p>*/</p>
<p>public void testLeapYearCount1999() {</p>
<p>assertEquals(SerialDate.leapYearCount(1999), 24);</p>
<p>/**</p>
<ul>
<li>El n√∫mero de a√±os bisiestos desde 1900 y hasta 2000 incluido es 25.</li>
</ul>
<p>*/</p>
<p>public void testLeapYearCount2000() {</p>
<p>assertEquals(SerialDate.leapYearCount(2000), 25);</p>
<p>/**</p>
<ul>
<li>Serializar una instancia, restaurarla y comprobar la igualdad.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
</ul>
<p>*/</p>
<p>public void testSerialization() {</p>
<p>SerialDate d1 = SerialDate.createInstance(15, 4, 2000);</p>
<p>SerialDate d2 = null;</p>
<p>try {</p>
<p>ByteArrayOutputStream buffer = new ByteArrayOutputStream();</p>
<p>ObjectOutput out = new ObjectOutputStream(buffer);</p>
<p>out.writeObject(d1);</p>
<p>out.close();</p>
<p>ObjectInput in = new ObjectInputStream(</p>
<p>new ByteArrayInputStream(buffer.toByteArray()));</p>
<p>d2 = (SerialDate) in.readObject();</p>
<p>in.close();</p>
<p>catch (Exception e) {</p>
<p>System.out.println(e.toString());</p>
<p>assertEquals(d1, d2);</p>
<p>/**</p>
<ul>
<li>Prueba para el informe de error 1096282 (ya corregido).</li>
</ul>
<p>*/</p>
<p>public void test1096282() {</p>
<p>SerialDate d = SerialDate.createInstance(29, 2, 2004);</p>
<p>d = SerialDate.addYears(1, d);</p>
<p>SerialDate expected = SerialDate.createInstance(28, 2, 2005);</p>
<p>assertTrue(d.isOn(expected));</p>
<p>/**</p>
<ul>
<li>Diversas pruebas para el m√©todo addMonths().</li>
</ul>
<p>*/</p>
<p>public void testAddMonths() {</p>
<p>SerialDate d1 = SerialDate.createInstance(31, 5, 2004);</p>
<p>SerialDate d2 = SerialDate.addMonths(1, d1);</p>
<p>assertEquals(30, d2.getDayOfMonth());</p>
<p>assertEquals(6, d2.getMonth());</p>
<p>assertEquals(2004, d2.getYYYY());</p>
<p>SerialDate d3 = SerialDate.addMonths(2, d1);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>assertEquals(31, d3.getDayOfMonth());</p>
<p>assertEquals(7, d3.getMonth());</p>
<p>assertEquals(2004, d3.getYYYY());</p>
<p>SerialDate d4 = SerialDate.addMonths(1, SerialDate.addMonths(1,</p>
<p>d1));</p>
<p>assertEquals(30, d4.getDayOfMonth());</p>
<p>assertEquals(7, d4.getMonth());</p>
<p>assertEquals(2004, d4.getYYYY());</p>
<p>322 }</p>
<p>Listado B-3</p>
<p>MonthConstants.java</p>
<p>/* =============================================================</p>
<ul>
<li>JCommon : biblioteca gratuita de clases de prop√≥sito general para Java(tm)</li>
<li>=============================================================</li>
<li>(C) Copyright 2000-2005, de Object Refinery Limited y colaboradores.</li>
<li>Informaci√≥n del proyecto: http://www.jfree.org/jcommon/index.html</li>
<li>Esta biblioteca es software gratuito; puede distribuirla y/o modificarla</li>
</ul>
<p>10 * bajo las condiciones de la Licencia p√∫blica general GNU publicada por</p>
<p>11 * la Free Software Foundation; ya sea la versi√≥n 2.1 de la licencia, u</p>
<p>12 * otra versi√≥n posterior (de su elecci√≥n).</p>
<p>13 *</p>
<p>14 * Esta biblioteca se distribuye con la intenci√≥n de que sea √∫til, pero</p>
<p>15 * SIN GARANT√çA ALGUNA, incluida la garant√≠a impl√≠cita de COMERCIABILIDAD</p>
<p>16 * e IDONEIDAD PARA UN DETERMINADO FIN. Consulte la Licencia p√∫blica general</p>
<p>GNU</p>
<p>17 * si necesita m√°s informaci√≥n al respecto.</p>
<p>18 *</p>
<p>19 * Deber√≠a haber recibido una copia de la Licencia p√∫blica general GNU</p>
<p>20 * junto a esta biblioteca; en caso contrario, contacte con la Free Software</p>
<p>21 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,</p>
<p>22 * EE.UU.</p>
<p>23 *</p>
<p>24 * [Java es una marca comercial o marca comercial registrada de Sun</p>
<p>25 * Microsystems, Inc. en Estados Unidos y otros pa√≠ses.]</p>
<p>26 *</p>
<p>27 * ----------------------</p>
<p>28 * MonthConstants.java</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>29 * ----------------------</p>
<p>30 * (C) Copyright 2002, 2003, de Object Refinery Limited.</p>
<p>31 *</p>
<p>32 * Autor original: David Gilbert (para Object Refinery Limited);</p>
<p>33 * Colaborador(es): -;</p>
<p>34 *</p>
<p>35 * $Id: MonthConstants.java,v 1.4 2005/11/16 15:58:40 taqua Exp $</p>
<p>36 *</p>
<p>37 * Cambios</p>
<p>38 * ----------</p>
<p>39 * 29-May-2002 : Version 1 (code moved from SerialDate class) (DG);</p>
<p>40 *</p>
<p>41 */</p>
<p>43 package org.jfree.date;</p>
<p>45 /**</p>
<p>46 * Constantes √∫tiles para los meses. NO son equivalentes a las</p>
<p>47 * constantes definidas por java.util.Calendar (donde JANUARY=0 y</p>
<p>DECEMBER=11).</p>
<p>48 * &lt;P&gt;</p>
<p>49 * Se usa en las clases SerialDate y RegularTimePeriod.</p>
<p>50 *</p>
<p>51 * @author David Gilbert</p>
<p>52 */</p>
<p>53 public interface MonthConstants {</p>
<p>/** Constante para Enero. */</p>
<p>public static final int JANUARY = 1;</p>
<p>/** Constante para Febrero. */</p>
<p>public static final int FEBRUARY = 2;</p>
<p>/** Constante para Marzo. */</p>
<p>public static final int MARCH = 3;</p>
<p>/** Constante para Abril. */</p>
<p>public static final int APRIL = 4;</p>
<p>/** Constante para Mayo. */</p>
<p>public static final int MAY = 5;</p>
<p>/** Constante para Junio. */</p>
<p>public static final int JUNE = 6;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/** Constante para Julio. */</p>
<p>public static final int JULY = 7;</p>
<p>/** Constante para Agosto. */</p>
<p>public static final int AUGUST = 8;</p>
<p>/** Constante para Septiembre. */</p>
<p>public static final int SEPTEMBER = 9;</p>
<p>/** Constante para Octubre. */</p>
<p>public static final int OCTOBER = 10;</p>
<p>/** Constante para Noviembre. */</p>
<p>public static final int NOVEMBER = 11;</p>
<p>/** Constante para Diciembre. */</p>
<p>public static final int DECEMBER = 12;</p>
<p>91 }</p>
<p>Listado B-4</p>
<p>BobsSerialDateTest.java</p>
<p>package org.jfree.date.junit;</p>
<p>import junit.framework.TestCase;</p>
<p>import org.jfree.date.*;</p>
<p>import static org.jfree.date.SerialDate.*;</p>
<p>import java.util.*;</p>
<p>public class BobsSerialDateTest extends TestCase {</p>
<p>public void testIsValidWeekdayCode() throws Exception {</p>
<p>for (int day = 1; day &lt;= 7; day++)</p>
<p>assertTrue(isValidWeekdayCode(day));</p>
<p>assertFalse(isValidWeekdayCode(0));</p>
<p>assertFalse(isValidWeekdayCode(8));</p>
<p>public void testStringToWeekdayCode() throws Exception {</p>
<p>assertEquals(-1, stringToWeekdayCode(‚ÄúHello‚Äù));</p>
<p>assertEquals(MONDAY, stringToWeekdayCode(‚ÄúMonday‚Äù));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>assertEquals(MONDAY, stringToWeekdayCode(‚ÄúMon‚Äù));</p>
<p>//todo assertEquals(MONDAY,stringToWeekdayCode(‚Äúmonday‚Äù));</p>
<p>// assertEquals(MONDAY,stringToWeekdayCode(‚ÄúMONDAY‚Äù));</p>
<p>// assertEquals(MONDAY, stringToWeekdayCode(‚Äúmon‚Äù));</p>
<p>assertEquals(TUESDAY, stringToWeekdayCode(‚ÄúTuesday‚Äù));</p>
<p>assertEquals(TUESDAY, stringToWeekdayCode(‚ÄúTue‚Äù));</p>
<p>// assertEquals(TUESDAY,stringToWeekdayCode(‚Äútuesday‚Äù));</p>
<p>// assertEquals(TUESDAY,StringToWeekdayCode(‚ÄúTUESDAY‚Äù));</p>
<p>// assertEquals(TUESDAY, stringToWeekdayCode(‚Äútue‚Äù));</p>
<p>// assertEquals(TUESDAY, stringToWeekdayCode(‚Äútues‚Äù));</p>
<p>assertEquals(WEDNESDAY, stringToWeekdayCode (‚ÄúWednesday‚Äù));</p>
<p>assertEquals(WEDNESDAY, stringToWeekdayCode(‚ÄúWed‚Äù));</p>
<p>// assertEquals(WEDNESDAY,stringToWeekdayCode(‚Äúwednesday‚Äù));</p>
<p>// assertEquals(WEDNESDAY,stringToWeekdayCode(‚ÄúWEDNESDAY‚Äù));</p>
<p>// assertEquals(WEDNESDAY, StringToWeekdayCode(‚Äúwed‚Äù));</p>
<p>assertEquals(THURSDAY, stringToWeekdayCode(‚ÄúThursday‚Äù));</p>
<p>assertEquals(THURSDAY, stringToWeekdayCode(‚ÄúThu‚Äù));</p>
<p>// assertEquals(THURSDAY,stringToWeekdayCode(‚Äúthursday‚Äù));</p>
<p>// assertEquals(THURSDAY,stringToWeekdayCode(‚ÄúTHURSDAY‚Äù));</p>
<p>// assertEquals(THURSDAY, stringToWeekdayCode(‚Äúthu‚Äù));</p>
<p>// assertEquals(THURSDAY, stringToWeekdayCode(‚Äúthurs‚Äù));</p>
<p>assertEquals(FRIDAY, stringToWeekdayCode(‚ÄúFriday‚Äù));</p>
<p>assertEquals(FRIDAY, stringToWeekdayCode(‚ÄúFri‚Äù));</p>
<p>// assertEquals(FRIDAY,stringToWeekdayCode(‚Äúfriday‚Äù));</p>
<p>// assertEquals(FRIDAY,stringToWeekdayCode(‚ÄúFRIDAY‚Äù));</p>
<p>// assertEquals(FRIDAY, StringToWeekdayCode(‚Äúfri‚Äù));</p>
<p>assertEquals(SATURDAY, stringToWeekdayCode(‚ÄúSaturday‚Äù));</p>
<p>assertEquals(SATURDAY, stringToWeekdayCode(‚ÄúSat‚Äù));</p>
<p>// assertEquals(SATURDAY,stringToWeekdayCode(‚Äúsaturday‚Äù));</p>
<p>// assertEquals(SATURDAY,stringToWeekdayCode(‚ÄúSATURDAY‚Äù));</p>
<p>// assertEquals(SATURDAY, stringToWeekdayCode(‚Äúsat‚Äù));</p>
<p>assertEquals(SUNDAY, stringToWeekdayCode(‚ÄúSunday‚Äù));</p>
<p>assertEquals(SUNDAY, stringToWeekdayCode(‚ÄúSun‚Äù));</p>
<p>// assertEquals(SUNDAY,stringToWeekdayCode(‚Äúsunday‚Äù));</p>
<p>// assertEquals(SUNDAY,stringToWeekdayCode(‚ÄúSUNDAY‚Äù));</p>
<p>// assertEquals(SUNDAY, stringToWeekdayCode(‚Äúsun‚Äù));</p>
<p>public void testWeekdayCodeToString() throws Exception {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>assertEquals(‚ÄúSunday‚Äù, weekdayCodeToString(SUNDAY));</p>
<p>assertEquals(‚ÄúMonday‚Äù, weekdayCodeToString(MONDAY));</p>
<p>assertEquals(‚ÄúTuesday‚Äù, weekdayCodeToString(TUESDAY));</p>
<p>assertEquals(‚ÄúWednesday‚Äù, weekdayCodeToString(WEDNESDAY));</p>
<p>assertEquals(‚ÄúThursday‚Äù, weekdayCodeToString(THURSDAY));</p>
<p>assertEquals(‚ÄúFriday‚Äù, weekdayCodeToString(FRIDAY));</p>
<p>assertEquals(‚ÄúSaturday‚Äù, weekdayCodeToString(SATURDAY));</p>
<p>public void testIsValidMonthCode() throws Exception {</p>
<p>for (int i = 1; i &lt;= 12; i++)</p>
<p>assertTrue(isValidMonthCode(i));</p>
<p>assertFalse(isValidMonthCode(0));</p>
<p>assertFalse(isValidMonthCode(13));</p>
<p>public void testMonthToQuarter() throws Exception {</p>
<p>assertEquals(1, monthCodeToQuarter(JANUARY));</p>
<p>assertEquals(1, monthCodeToQuarter(FEBRUARY));</p>
<p>assertEquals(1, monthCodeToQuarter(MARCH));</p>
<p>assertEquals(2, monthCodeToQuarter(APRIL));</p>
<p>assertEquals(2, monthCodeToQuarter(MAY));</p>
<p>assertEquals(2, monthCodeToQuarter(JUNE));</p>
<p>assertEquals(3, monthCodeToQuarter(JULY));</p>
<p>assertEquals(3, monthCodeToQuarter(AUGUST));</p>
<p>assertEquals(3, monthCodeToQuarter(SEPTEMBER));</p>
<p>assertEquals(4, monthCodeToQuarter(OCTOBER));</p>
<p>assertEquals(4, monthCodeToQuarter(NOVEMBER));</p>
<p>assertEquals(4, monthCodeToQuarter(DECEMBER));</p>
<p>try {</p>
<p>monthCodeToQuarter(-1);</p>
<p>fail(‚ÄúInvalid Month Code should throw exception‚Äù);</p>
<p>} catch (IllegalArgumentException e) {</p>
<p>public void testMonthCodeToString() throws Exception {</p>
<p>assertEquals(‚ÄúJanuary‚Äù, monthCodeToString(JANUARY));</p>
<p>assertEquals(‚ÄúFebruary‚Äù, monthCodeToString(FEBRUARY));</p>
<p>assertEquals(‚ÄúMarch‚Äù, monthCodeToString(MARCH));</p>
<p>assertEquals(‚ÄúApril‚Äù, monthCodeToString(APRIL));</p>
<p>assertEquals(‚ÄúMay‚Äù, monthCodeToString(MAY));</p>
<p>assertEquals(‚ÄúJune‚Äù, monthCodeToString(JUNE));</p>
<p>assertEquals(‚ÄúJuly‚Äù, monthCodeToString(JULY));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>assertEquals(‚ÄúAugust‚Äù, monthCodeToString(AUGUST));</p>
<p>assertEquals(‚ÄúSeptember‚Äù, monthCodeToString(SEPTEMBER));</p>
<p>assertEquals(‚ÄúOctober‚Äù, monthCodeToString(OCTOBER));</p>
<p>assertEquals(‚ÄúNovember‚Äù, monthCodeToString(NOVEMBER));</p>
<p>assertEquals(‚ÄúDecember‚Äù, monthCodeToString(DECEMBER));</p>
<p>assertEquals(‚ÄúJan‚Äù, monthCodeToString(JANUARY, true));</p>
<p>assertEquals(‚ÄúFeb‚Äù, monthCodeToString(FEBRUARY, true));</p>
<p>assertEquals(‚ÄúMar‚Äù, monthCodeToString(MARCH, true));</p>
<p>assertEquals(‚ÄúApr‚Äù, monthCodeToString(APRIL, true));</p>
<p>assertEquals(‚ÄúMay‚Äù, monthCodeToString(MAY, true));</p>
<p>assertEquals(‚ÄúJun‚Äù, monthCodeToString(JUNE, true));</p>
<p>assertEquals(‚ÄúJul‚Äù, monthCodeToString(JULY, true));</p>
<p>assertEquals(‚ÄúAug‚Äù, monthCodeToString(AUGUST, true));</p>
<p>assertEquals(‚ÄúSep‚Äù, monthCodeToString(SEPTEMBER, true));</p>
<p>assertEquals(‚ÄúOct‚Äù, monthCodeToString(OCTOBER, true));</p>
<p>assertEquals(‚ÄúNov‚Äù, monthCodeToString(NOVEMBER, true));</p>
<p>assertEquals(‚ÄúDec‚Äù, monthCodeToString(DECEMBER, true));</p>
<p>try {</p>
<p>monthCodeToString(-1);</p>
<p>fail(‚ÄúInvalid month code should throw exception‚Äù);</p>
<p>} catch (IllegalArgumentException e) {</p>
<p>public void testStringToMonthCode() throws Exception {</p>
<p>assertEquals(JANUARY,stringToMonthCode(‚Äú1‚Äù));</p>
<p>assertEquals(FEBRUARY,stringToMonthCode(‚Äú2‚Äù));</p>
<p>assertEquals(MARCH,stringToMonthCode(‚Äú3‚Äù));</p>
<p>assertEquals(APRIL,stringToMonthCode(‚Äú4‚Äù));</p>
<p>assertEquals(MAY,stringToMonthCode(‚Äú5‚Äù));</p>
<p>assertEquals(JUNE,stringToMonthCode(‚Äú6‚Äù));</p>
<p>assertEquals(JULY,stringToMonthCode(‚Äú7‚Äù));</p>
<p>assertEquals(AUGUST,stringToMonthCode(‚Äú8‚Äù));</p>
<p>assertEquals(SEPTEMBER,stringToMonthCode(‚Äú9‚Äù));</p>
<p>assertEquals(OCTOBER,stringToMonthCode(‚Äú10‚Äù));</p>
<p>assertEquals(NOVEMBER, stringToMonthCode(‚Äú11‚Äù));</p>
<p>assertEquals(DECEMBER,stringToMonthCode(‚Äú12‚Äù));</p>
<p>153 //todo assertEquals(-1, stringToMonthCode(‚Äú0‚Äù));</p>
<p>154 // assertEquals(-1, stringToMonthCode(‚Äú13‚Äù));</p>
<p>assertEquals(-1,stringToMonthCode(‚ÄúHello‚Äù));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>for (int m = 1; m &lt;= 12; m++) {</p>
<p>assertEquals(m, stringToMonthCode(monthCodeToString(m, false)));</p>
<p>assertEquals(m, stringToMonthCode(monthCodeToString(m, true)));</p>
<p>163 // assertEquals(1,stringToMonthCode(‚Äújan‚Äù));</p>
<p>164 // assertEquals(2,stringToMonthCode(‚Äúfeb‚Äù));</p>
<p>165 // assertEquals(3,stringToMonthCode(‚Äúmar‚Äù));</p>
<p>166 // assertEquals(4,stringToMonthCode(‚Äúapr‚Äù));</p>
<p>167 // assertEquals(5,stringToMonthCode(‚Äúmay‚Äù));</p>
<p>168 // assertEquals(6,stringToMonthCode(‚Äújun‚Äù));</p>
<p>169 // assertEquals(7,stringToMonthCode(‚Äújul‚Äù));</p>
<p>170 // assertEquals(8,stringToMonthCode(‚Äúaug‚Äù));</p>
<p>171 // assertEquals(9,stringToMonthCode(‚Äúsep‚Äù));</p>
<p>172 // assertEquals(10,stringToMonthCode(‚Äúoct‚Äù));</p>
<p>173 // assertEquals(11,stringToMonthCode(‚Äúnov‚Äù));</p>
<p>174 // assertEquals(12,stringToMonthCode(‚Äúdec‚Äù));</p>
<p>176 // assertEquals(1,stringToMonthCode(‚ÄúJAN‚Äù));</p>
<p>177 // assertEquals(2,stringToMonthCode(‚ÄúFEB‚Äù));</p>
<p>178 // assertEquals(3,stringToMonthCode(‚ÄúMAR‚Äù));</p>
<p>179 // assertEquals(4,stringToMonthCode(‚ÄúAPR‚Äù));</p>
<p>180 // assertEquals(5,stringToMonthCode(‚ÄúMAY‚Äù));</p>
<p>181 // assertEquals(6,stringToMonthCode(‚ÄúJUN‚Äù));</p>
<p>182 // assertEquals(7,stringToMonthCode(‚ÄúJUL‚Äù));</p>
<p>183 // assertEquals(8,stringToMonthCode(‚ÄúAUG‚Äù));</p>
<p>184 // assertEquals(9,stringToMonthCode(‚ÄúSEP‚Äù));</p>
<p>185 // assertEquals(10,stringToMonthCode(‚ÄúOCT‚Äù));</p>
<p>186 // assertEquals(11,stringToMonthCode(‚ÄúNOV‚Äù));</p>
<p>187 // assertEquals(12,stringToMonthCode(‚ÄúDEC‚Äù));</p>
<p>189 // assertEquals(1,stringToMonthCode(‚Äújanuary‚Äù));</p>
<p>190 // assertEquals(2,stringToMonthCode(‚Äúfebruary‚Äù));</p>
<p>191 // assertEquals(3,stringToMonthCode(‚Äúmarch‚Äù));</p>
<p>192 // assertEquals(4,stringToMonthCode(‚Äúapril‚Äù));</p>
<p>193 // assertEquals(5,stringToMonthCode(‚Äúmay‚Äù));</p>
<p>194 // assertEquals(6,stringToMonthCode(‚Äújune‚Äù));</p>
<p>195 // assertEquals(7,stringToMonthCode(‚Äújuly‚Äù));</p>
<p>196 // assertEquals(8,stringToMonthCode(‚Äúaugust‚Äù));</p>
<p>197 // assertEquals(9,stringToMonthCode(‚Äúseptember‚Äù));</p>
<p>198 // assertEquals(10,stringToMonthCode(‚Äúoctober‚Äù));</p>
<p>199 // assertEquals(11,stringToMonthCode(‚Äúnovember‚Äù));</p>
<p>200 // assertEquals(12,stringToMonthCode(‚Äúdecember‚Äù));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>202 // assertEquals(1,stringToMonthCode(‚ÄúJANUARY‚Äù));</p>
<p>203 // assertEquals(2,stringToMonthCode(‚ÄúFEBRUARY‚Äù));</p>
<p>204 // assertEquals(3,stringToMonthCode(‚ÄúMAR‚Äù));</p>
<p>205 // assertEquals(4,stringToMonthCode(‚ÄúAPRIL‚Äù));</p>
<p>206 // assertEquals(5,stringToMonthCode(‚ÄúMAY‚Äù));</p>
<p>207 // assertEquals(6,stringToMonthCode(‚ÄúJUNE‚Äù));</p>
<p>208 // assertEquals(7,stringToMonthCode(‚ÄúJULY‚Äù));</p>
<p>209 // assertEquals(8,stringToMonthCode(‚ÄúAUGUST‚Äù));</p>
<p>210 // assertEquals(9,stringToMonthCode(‚ÄúSEPTEMBER‚Äù));</p>
<p>211 // assertEquals(10,stringToMonthCode(‚ÄúOCTOBER‚Äù));</p>
<p>212 // assertEquals(11,stringToMonthCode(‚ÄúNOVEMBER‚Äù));</p>
<p>213 // assertEquals(12,stringToMonthCode(‚ÄúDECEMBER‚Äù));</p>
<p>public void testIsValidWeekInMonthCode() throws Exception {</p>
<p>for (int w = 0; w &lt;= 4; w++) {</p>
<p>assertTrue(isValidWeekInMonthCode(w));</p>
<p>assertFalse(isValidWeekInMonthCode(5));</p>
<p>public void testIsLeapYear() throws Exception {</p>
<p>assertFalse(isLeapYear(1900));</p>
<p>assertFalse(isLeapYear(1901));</p>
<p>assertFalse(isLeapYear(1902));</p>
<p>assertFalse(isLeapYear(1903));</p>
<p>assertTrue(isLeapYear(1904));</p>
<p>assertTrue(isLeapYear(1908));</p>
<p>assertFalse(isLeapYear(1955));</p>
<p>assertTrue(isLeapYear(1964));</p>
<p>assertTrue(isLeapYear(1980));</p>
<p>assertTrue(isLeapYear(2000));</p>
<p>assertFalse(isLeapYear(2001));</p>
<p>assertFalse(isLeapYear(2100));</p>
<p>public void testLeapYearCount() throws Exception {</p>
<p>assertEquals(0, leapYearCount(1900));</p>
<p>assertEquals(0, leapYearCount(1901));</p>
<p>assertEquals(0, leapYearCount(1902));</p>
<p>assertEquals(0, leapYearCount(1903));</p>
<p>assertEquals(1, leapYearCount(1904));</p>
<p>assertEquals(1, leapYearCount(1905));</p>
<p>assertEquals(1, leapYearCount(1906));</p>
<p>assertEquals(1, leapYearCount(1907));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>assertEquals(2, leapYearCount(1908));</p>
<p>assertEquals(24, leapYearCount(1999));</p>
<p>assertEquals(25, leapYearCount(2001));</p>
<p>assertEquals(49, leapYearCount(2101));</p>
<p>assertEquals(73, leapYearCount(2201));</p>
<p>assertEquals(97, leapYearCount(2301));</p>
<p>assertEquals(122, leapYearCount(2401));</p>
<p>public void testLastDayOfMonth() throws Exception {</p>
<p>assertEquals(31, lastDayOfMonth(JANUARY, 1901));</p>
<p>assertEquals(28, lastDayOfMonth(FEBRUARY, 1901));</p>
<p>assertEquals(31, lastDayOfMonth(MARCH, 1901));</p>
<p>assertEquals(30, lastDayOfMonth(APRIL, 1901));</p>
<p>assertEquals(31, lastDayOfMonth(MAY, 1901));</p>
<p>assertEquals(30, lastDayOfMonth(JUNE, 1901));</p>
<p>assertEquals(31, lastDayOfMonth(JULY, 1901));</p>
<p>assertEquals(31, lastDayOfMonth(AUGUST, 1901));</p>
<p>assertEquals(30, lastDayOfMonth(SEPTEMBER, 1901));</p>
<p>assertEquals(31, lastDayOfMonth(OCTOBER, 1901));</p>
<p>assertEquals(30, lastDayOfMonth(NOVEMBER, 1901));</p>
<p>assertEquals(31, lastDayOfMonth(DECEMBER, 1901));</p>
<p>assertEquals(29, lastDayOfMonth(FEBRUARY, 1904));</p>
<p>public void testAddDays() throws Exception {</p>
<p>SerialDate newYears = d(1, JANUARY, 1900);</p>
<p>assertEquals(d(2, JANUARY, 1900), addDays(1, newYears));</p>
<p>assertEquals(d(1, FEBRUARY, 1900), addDays(31, newYears));</p>
<p>assertEquals(d(1, JANUARY, 1901), addDays(365, newYears));</p>
<p>assertEquals(d(31, DECEMBER, 1904), addDays(5 * 365, newYears));</p>
<p>private static SpreadsheetDate d(int day, int month, int year)</p>
<p>{ return new SpreadsheetDate(day, month, year); }</p>
<p>public void testAddMonths() throws Exception {</p>
<p>assertEquals(d(1, FEBRUARY, 1900), addMonths(1, d(1, JANUARY,</p>
<p>1900)));</p>
<p>assertEquals(d(28, FEBRUARY, 1900), addMonths(1, d(31, JANUARY,</p>
<p>1900)));</p>
<p>assertEquals(d(28, FEBRUARY, 1900), addMonths(1, d(30, JANUARY,</p>
<p>1900)));</p>
<p>assertEquals(d(28, FEBRUARY, 1900), addMonths(1, d(29, JANUARY,</p>
<p>1900)));</p>
<p>assertEquals(d(28, FEBRUARY, 1900), addMonths(1, d(28, JANUARY,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>1900)));</p>
<p>assertEquals(d(27, FEBRUARY, 1900), addMonths(1, d(27, JANUARY,</p>
<p>1900)));</p>
<p>assertEquals(d(30, JUNE, 1900), addMonths(5, d(31, JANUARY, 1900)));</p>
<p>assertEquals(d(30, JUNE, 1901), addMonths(17, d(31, JANUARY,</p>
<p>1900)));</p>
<p>assertEquals(d(29, FEBRUARY, 1904), addMonths(49, d(31, JANUARY,</p>
<p>1900)));</p>
<p>public void testAddYears() throws Exception {</p>
<p>assertEquals(d(1, JANUARY, 1901), addYears(1, d(1, JANUARY, 1900)));</p>
<p>assertEquals(d(28, FEBRUARY, 1905), addYears(1, d(29, FEBRUARY,</p>
<p>1904)));</p>
<p>assertEquals(d(28, FEBRUARY, 1905), addYears(1, d(28, FEBRUARY,</p>
<p>1904)));</p>
<p>assertEquals(d(28, FEBRUARY, 1904), addYears(1, d(28, FEBRUARY,</p>
<p>1903)));</p>
<p>public void testGetPreviousDayOfWeek() throws Exception {</p>
<p>assertEquals(d(24, FEBRUARY, 2006), getPreviousDayOfWeek(FRIDAY,</p>
<p>d(1, MARCH, 2006)));</p>
<p>assertEquals(d(22, FEBRUARY, 2006), getPreviousDayOfWeek(WEDNESDAY,</p>
<p>d(1, MARCH, 2006)));</p>
<p>assertEquals(d(29, FEBRUARY, 2004), getPreviousDayOfWeek(SUNDAY,</p>
<p>d(3, MARCH, 2004)));</p>
<p>assertEquals(d(29, DECEMBER, 2004), getPreviousDayOfWeek(WEDNESDAY,</p>
<p>d(5, JANUARY, 2005)));</p>
<p>try {</p>
<p>getPreviousDayOfWeek(-1, d(1, JANUARY, 2006));</p>
<p>fail(‚ÄúInvalid day of week code should throw exception‚Äù);</p>
<p>} catch (IllegalArgumentException e) {</p>
<p>public void testGetFollowingDayOfWeek() throws Exception {</p>
<p>318 // assertEquals(d(1, JANUARY, 2005),getFollowingDayOfWeek(SATURDAY, d(25,</p>
<p>DECEMBER, 2004)));</p>
<p>assertEquals(d(1, JANUARY, 2005), getFollowingDayOfWeek(SATURDAY,</p>
<p>d(26, DECEMBER, 2004)));</p>
<p>assertEquals(d(3, MARCH, 2004), getFollowingDayOfWeek(WEDNESDAY,</p>
<p>d(28, FEBRUARY, 2004)));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>try {</p>
<p>getFollowingDayOfWeek(-1, d(1, JANUARY, 2006));</p>
<p>fail(‚ÄúInvalid day of week code should throw exception‚Äù);</p>
<p>} catch (IllegalArgumentException e) {</p>
<p>public void testGetNearestDayOfWeek() throws Exception {</p>
<p>assertEquals(d(16, APRIL, 2006), getNearestDayOfWeek(SUNDAY, d(16,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(16, APRIL, 2006), getNearestDayOfWeek(SUNDAY, d(17,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(16, APRIL, 2006), getNearestDayOfWeek(SUNDAY, d(18,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(16, APRIL, 2006), getNearestDayOfWeek(SUNDAY, d(19,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(23, APRIL, 2006), getNearestDayOfWeek(SUNDAY, d(20,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(23, APRIL, 2006), getNearestDayOfWeek(SUNDAY, d(21,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(23, APRIL, 2006), getNearestDayOfWeek(SUNDAY, d(22,</p>
<p>APRIL, 2006)));</p>
<p>338 //todo assertEquals(d(17, APRIL, 2006), getNearestDayOfWeek(MONDAY, d(16,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(17, APRIL, 2006), getNearestDayOfWeek(MONDAY, d(17,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(17, APRIL, 2006), getNearestDayOfWeek(MONDAY, d(18,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(17, APRIL, 2006), getNearestDayOfWeek(MONDAY, d(19,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(17, APRIL, 2006), getNearestDayOfWeek(MONDAY, d(20,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(24, APRIL, 2006), getNearestDayOfWeek(MONDAY, d(21,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(24, APRIL, 2006), getNearestDayOfWeek(MONDAY, d(22,</p>
<p>APRIL, 2006)));</p>
<p>346 // assertEquals(d(18, APRIL, 2006), getNearestDayOfWeek(TUESDAY, d(16,</p>
<p>APRIL, 2006)));</p>
<p>347 // assertEquals(d(18, APRIL, 2006), getNearestDayOfWeek(TUESDAY, d(17,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(18, APRIL, 2006), getNearestDayOfWeek(TUESDAY, d(18,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(18, APRIL, 2006), getNearestDayOfWeek(TUESDAY, d(19,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(18, APRIL, 2006), getNearestDayOfWeek(TUESDAY, d(20,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(18, APRIL, 2006), getNearestDayOfWeek(TUESDAY, d(21,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>APRIL, 2006)));</p>
<p>assertEquals(d(25, APRIL, 2006), getNearestDayOfWeek(TUESDAY, d(22,</p>
<p>APRIL, 2006)));</p>
<p>354 // assertEquals(d(19, APRIL, 2006), getNearestDayOfWeek(WEDNESDAY, d(16,</p>
<p>APRIL, 2006)));</p>
<p>355 // assertEquals(d(19, APRIL, 2006), getNearestDayOfWeek(WEDNESDAY, d(17,</p>
<p>APRIL, 2006)));</p>
<p>356 // assertEquals(d(19, APRIL, 2006), getNearestDayOfWeek(WEDNESDAY, d(18,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(19, APRIL, 2006), getNearestDayOfWeek(WEDNESDAY,</p>
<p>d(19, APRIL, 2006)));</p>
<p>assertEquals(d(19, APRIL, 2006), getNearestDayOfWeek(WEDNESDAY,</p>
<p>d(20, APRIL, 2006)));</p>
<p>assertEquals(d(19, APRIL, 2006), getNearestDayOfWeek(WEDNESDAY,</p>
<p>d(21, APRIL, 2006)));</p>
<p>assertEquals(d(19, APRIL, 2006), getNearestDayOfWeek(WEDNESDAY,</p>
<p>d(22, APRIL, 2006)));</p>
<p>362 // assertEquals(d(13, APRIL, 2006), getNearestDayOfWeek(THURSDAY, d(16,</p>
<p>APRIL, 2006)));</p>
<p>363 // assertEquals(d(20, APRIL, 2006), getNearestDayOfWeek(THURSDAY, d(17,</p>
<p>APRIL, 2006)));</p>
<p>364 // assertEquals(d(20, APRIL, 2006), getNearestDayOfWeek(THURSDAY, d(18,</p>
<p>APRIL, 2006)));</p>
<p>365 // assertEquals(d(20, APRIL, 2006), getNearestDayOfWeek(THURSDAY, d(19,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(20, APRIL, 2006), getNearestDayOfWeek(THURSDAY, d(20,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(20, APRIL, 2006), getNearestDayOfWeek(THURSDAY, d(21,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(20, APRIL, 2006), getNearestDayOfWeek(THURSDAY, d(22,</p>
<p>APRIL, 2006)));</p>
<p>370 // assertEquals(d(14, APRIL, 2006), getNearestDayOfWeek(FRIDAY, d(16,</p>
<p>APRIL, 2006)));</p>
<p>371 // assertEquals(d(14, APRIL, 2006), getNearestDayOfWeek(FRIDAY, d(17,</p>
<p>APRIL, 2006)));</p>
<p>372 // assertEquals(d(21, APRIL, 2006), getNearestDayOfWeek(FRIDAY, d(18,</p>
<p>APRIL, 2006)));</p>
<p>373 // assertEquals(d(21, APRIL, 2006), getNearestDayOfWeek(FRIDAY, d(19,</p>
<p>APRIL, 2006)));</p>
<p>374 // assertEquals(d(21, APRIL, 2006), getNearestDayOfWeek(FRIDAY, d(20,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(21, APRIL, 2006), getNearestDayOfWeek(FRIDAY, d(21,</p>
<p>APRIL, 2006)));</p>
<p>376 assertEquals(d(21, APRIL, 2006), getNearestDayOfWeek(FRIDAY, d(22, APRIL,</p>
<p>2006)));</p>
<p>378 // assertEquals(d(15, APRIL, 2006), getNearestDayOfWeek(SATURDAY, d(16,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>APRIL, 2006)));</p>
<p>379 // assertEquals(d(15, APRIL, 2006), getNearestDayOfWeek(SATURDAY, d(17,</p>
<p>APRIL, 2006)));</p>
<p>380 // assertEquals(d(15, APRIL, 2006), getNearestDayOfWeek(SATURDAY, d(18,</p>
<p>APRIL, 2006)));</p>
<p>381 // assertEquals(d(22, APRIL, 2006), getNearestDayOfWeek(SATURDAY, d(19,</p>
<p>APRIL, 2006)));</p>
<p>382 // assertEquals(d(22, APRIL, 2006), getNearestDayOfWeek(SATURDAY, d(20,</p>
<p>APRIL, 2006)));</p>
<p>383 // assertEquals(d(22, APRIL, 2006), getNearestDayOfWeek(SATURDAY, d(21,</p>
<p>APRIL, 2006)));</p>
<p>assertEquals(d(22, APRIL, 2006), getNearestDayOfWeek(SATURDAY, d(22,</p>
<p>APRIL, 2006)));</p>
<p>try {</p>
<p>getNearestDayOfWeek(-1, d(1, JANUARY, 2006));</p>
<p>fail(‚ÄúInvalid day of week code should throw exception‚Äù);</p>
<p>} catch (IllegalArgumentException e) {</p>
<p>public void testEndOfCurrentMonth() throws Exception {</p>
<p>SerialDate d = SerialDate.createInstance(2);</p>
<p>assertEquals(d(31, JANUARY, 2006), d.getEndOfCurrentMonth(d(1,</p>
<p>JANUARY, 2006)));</p>
<p>assertEquals(d(28, FEBRUARY, 2006), d.getEndOfCurrentMonth(d(1,</p>
<p>FEBRUARY, 2006)));</p>
<p>assertEquals(d(31, MARCH, 2006), d.getEndOfCurrentMonth(d(1, MARCH,</p>
<p>2006)));</p>
<p>assertEquals(d(30, APRIL, 2006), d.getEndOfCurrentMonth(d(1, APRIL,</p>
<p>2006)));</p>
<p>assertEquals(d(31, MAY, 2006), d.getEndOfCurrentMonth(d(1, MAY,</p>
<p>2006)));</p>
<p>assertEquals(d(30, JUNE, 2006), d.getEndOfCurrentMonth(d(1, JUNE,</p>
<p>2006)));</p>
<p>assertEquals(d(31, JULY, 2006), d.getEndOfCurrentMonth(d(1, JULY,</p>
<p>2006)));</p>
<p>assertEquals(d(31, AUGUST, 2006), d.getEndOfCurrentMonth(d(1,</p>
<p>AUGUST, 2006)));</p>
<p>assertEquals(d(30, SEPTEMBER, 2006), d.getEndOfCurrentMonth(d(1,</p>
<p>SEPTEMBER, 2006)));</p>
<p>assertEquals(d(31, OCTOBER, 2006), d.getEndOfCurrentMonth(d(1,</p>
<p>OCTOBER, 2006)));</p>
<p>assertEquals(d(30, NOVEMBER, 2006), d.getEndOfCurrentMonth(d(1,</p>
<p>NOVEMBER, 2006)));</p>
<p>assertEquals(d(31, DECEMBER, 2006), d.getEndOfCurrentMonth(d(1,</p>
<p>DECEMBER, 2006)));</p>
<p>assertEquals(d(29, FEBRUARY, 2008), d.getEndOfCurrentMonth(d(1,</p>
<p>FEBRUARY, 2008)));</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public void testWeekInMonthToString() throws Exception {</p>
<p>assertEquals(‚ÄúFirst‚Äù,weekInMonthToString(FIRST_WEEK_IN_MONTH));</p>
<p>assertEquals(‚ÄúSecond‚Äù,weekInMonthToString(SECOND_WEEK_IN_MONTH));</p>
<p>assertEquals(‚ÄúThird‚Äù,weekInMonthToString(THIRD_WEEK_IN_MONTH));</p>
<p>assertEquals(‚ÄúFourth‚Äù,weekInMonthToString(FOURTH_WEEK_IN_MONTH));</p>
<p>assertEquals(‚ÄúLast‚Äù,weekInMonthToString(LAST_WEEK_IN_MONTH));</p>
<p>417 //todo try {</p>
<p>418 // weekInMonthToString(-1);</p>
<p>419 // fail(‚ÄúInvalid week code should throw exception‚Äù);</p>
<p>420 // } catch (IllegalArgumentException e) {</p>
<p>421 // }</p>
<p>public void testRelativeToString() throws Exception {</p>
<p>assertEquals(‚ÄúPreceding‚Äù,relativeToString(PRECEDING));</p>
<p>assertEquals(‚ÄúNearest‚Äù,relativeToString(NEAREST));</p>
<p>assertEquals(‚ÄúFollowing‚Äù,relativeToString(FOLLOWING));</p>
<p>429 //todo try {</p>
<p>430 // relativeToString(-1000);</p>
<p>431 // fail(‚ÄúInvalid relative code should throw exception‚Äù);</p>
<p>432 // } catch (IllegalArgumentException e) {</p>
<p>433 // }</p>
<p>public void testCreateInstanceFromDDMMYYYY() throws Exception {</p>
<p>SerialDate date = createInstance(1, JANUARY, 1900);</p>
<p>assertEquals(1,date.getDayOfMonth());</p>
<p>assertEquals(JANUARY,date.getMonth());</p>
<p>assertEquals(1900,date.getYYYY());</p>
<p>assertEquals(2,date.toSerial());</p>
<p>public void testCreateInstanceFromSerial() throws Exception {</p>
<p>assertEquals(d(1, JANUARY, 1900),createInstance(2));</p>
<p>assertEquals(d(1, JANUARY, 1901), createInstance(367));</p>
<p>public void testCreateInstanceFromJavaDate() throws Exception {</p>
<p>assertEquals(d(1, JANUARY, 1900),</p>
<p>createInstance(new GregorianCalendar(1900,0,1).getTime()));</p>
<p>assertEquals(d(1, JANUARY, 2006),</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>createInstance(new GregorianCalendar(2006,0,1).getTime()));</p>
<p>public static void main(String[] args) {</p>
<p>junit.textui.TestRunner.run(BobsSerialDateTest.class);</p>
<p>457 }</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Listado B-5</p>
<p>SpreadsheetDate.java.</p>
<p>/* =============================================================</p>
<ul>
<li>JCommon: biblioteca gratuita de clases de prop√≥sito general para Java(tm)</li>
<li>=============================================================</li>
<li>(C) Copyright 2000-2005, de Object Refinery Limited y colaboradores.</li>
<li>Informaci√≥n del proyecto: http://www.jfree.org/jcommon/index.html</li>
<li>Esta biblioteca es software gratuito; puede distribuirla y/o modificarla</li>
<li>bajo las condiciones de la Licencia p√∫blica general GNU publicada por</li>
<li>la Free Software Foundation; ya sea la versi√≥n 2.1 de la licencia, u</li>
<li>otra versi√≥n posterior (de su elecci√≥n).</li>
<li>Esta biblioteca se distribuye con la intenci√≥n de que sea √∫til, pero</li>
<li>SIN GARANT√çA ALGUNA, incluida la garant√≠a impl√≠cita de COMERCIABILIDAD</li>
<li>e IDONEIDAD PARA UN DETERMINADO FIN. Consulte la Licencia p√∫blica general</li>
</ul>
<p>GNU</p>
<ul>
<li>si necesita m√°s informaci√≥n al respecto.</li>
<li>Deber√≠a haber recibido una copia de la Licencia p√∫blica general GNU</li>
<li>junto a esta biblioteca; en caso contrario, contacte con la Free Software</li>
<li>Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,</li>
<li>EE.UU.</li>
<li>[Java es una marca comercial o marca comercial registrada de Sun</li>
<li>Microsystems, Inc. en Estados Unidos y otros pa√≠ses.]</li>
<li>--------------------------</li>
<li>SpreadsheetDate.java</li>
<li>--------------------------</li>
<li>(C) Copyright 2000-2005, de Object Refinery Limited y colaboradores.</li>
<li>Autor original: David Gilbert (por Object Refinery Limited);</li>
<li>Colaboradores(s): -;</li>
<li>$Id: SpeadsheetDate.java,v 1.8 2005/11/03 09:25:39 mungady Exp $</li>
<li>Cambios</li>
<li>----------</li>
<li>11-Oct-2001 : Version 1 (DG);</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>05-Nov-2001 : Se a√±aden los m√©todos getDescription() y setDescription()</li>
</ul>
<p>(DG);</p>
<ul>
<li>12-Nov-2001 : Se cambia el nombre ExcelDate.java por SpreadsheetDate.java</li>
</ul>
<p>(DG);</p>
<ul>
<li>Se corrige un error a la hora de calcular el d√≠a, mes y a√±o a</li>
<li>partir del n√∫mero de serie (DG);</li>
<li>24-Jan-2002 : Se corrige un error a la hora de calcular el n√∫mero de</li>
</ul>
<p>serie a</p>
<ul>
<li>partir del d√≠a, mes y a√±o. Gracias a Trevor Kills por el informe (DG);</li>
<li>29-May-2002 : Se a√±ade el m√©todo equals(Object) (SourceForge ID 558850)</li>
</ul>
<p>(DG);</p>
<ul>
<li>03-Oct-2002 : Se corrigen los errores detectados por Checkstyle (DG);</li>
<li>13-Mar-2003 : Implementaci√≥n de Serializable (DG);</li>
<li>04-Sep-2003 : M√©todos isInRange() completados (DG);</li>
<li>05-Sep-2003 : Implementaci√≥n de Comparable (DG);</li>
<li>21-Oct-2003 : Se a√±ade el m√©todo hashCode() (DG);</li>
</ul>
<p>/*</p>
<p>package org.jfree.date;</p>
<p>import java.util.Calendar;</p>
<p>import java.util.Date;</p>
<p>/**</p>
<ul>
<li>Representa una con un entero, de forma similar a la</li>
<li>implementaci√≥n en Microsoft Excel. El intervalo de fechas admitido es</li>
<li>1-Ene-1900 a 31-Dic-9999.</li>
<li>&lt;P&gt;</li>
<li>Recuerde que Excel tiene un error que reconoce el a√±o</li>
<li>1900 como bisiesto cuando en realidad no lo es. Encontrar√° m√°s</li>
<li>informaci√≥n en el sitio Web de Microsoft, en el art√≠culo Q181370:</li>
<li>&lt;P&gt;</li>
<li>http://support.microsoft.com/support/kb/articles/Q181/3/70.asp</li>
<li>&lt;P&gt;</li>
<li>Excel usa como convenci√≥n que el 1-Ene-1900 = 1. Esta clase usa la</li>
<li>convenci√≥n de que 1-Ene-1900 = 2.</li>
<li>Como resultado, el n√∫mero de d√≠a de esta clase ser√° diferente al de</li>
<li>Excel para enero y febrero de 1900... pero Excel a√±ade un d√≠a</li>
<li>m√°s (29-Feb-1900 que en realidad no existe) y a partir de ah√≠</li>
<li>los n√∫meros de los d√≠as coinciden.</li>
<li>@author David Gilbert</li>
</ul>
<p>*/</p>
<p>public class SpreadsheetDate extends SerialDate {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/** Para serializaci√≥n. */</p>
<p>private static final long serialVersionUID = -2039586705374454461L;</p>
<p>/**</p>
<ul>
<li>El n√∫mero de d√≠a (1-Ene-1900 = 2, 2-Ene-1900 = 3..., 31-Dic-9999 =</li>
<li>2958465).</li>
</ul>
<p>*/</p>
<p>private int serial;</p>
<p>/** El d√≠a del mes (de 1 a 28, 29, 30 o 31 en funci√≥n del mes). */</p>
<p>private int day;</p>
<p>/** El mes del a√±o (de 1 a 12). */</p>
<p>private int month;</p>
<p>/** El a√±o (de 1900 a 9999). */</p>
<p>private int year;</p>
<p>/** Una descripci√≥n opcional para la fecha. */</p>
<p>private String description;</p>
<p>/**</p>
<ul>
<li>Crear una nueva instancia de la fecha.</li>
<li>@param day el d√≠a (entre 1 y 28/29/30/31).</li>
<li>@param month el mes (entre 1 y 12).</li>
<li>@param year el a√±o (entre 1900 y 9999).</li>
</ul>
<p>*/</p>
<p>public SpreadsheetDate(final int day, final int month, final int year)</p>
<p>if ((year &gt;= 1900) &amp;&amp; (year &lt;= 9999)) {</p>
<p>this.year = year;</p>
<p>else {</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúThe ‚Äòyear‚Äô argument must be in range 1900 to 9999.‚Äù</p>
<p>);</p>
<p>if ((month &gt;= MonthConstants.JANUARY)</p>
<p>&amp;&amp; (month &lt;= MonthConstants.DECEMBER)) {</p>
<p>this.month = month;</p>
<p>else {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúThe ‚Äòmonth‚Äô argument must be in the range 1 to 12.‚Äù</p>
<p>);</p>
<p>if ((day &gt;= 1) &amp;&amp; (day &lt;= SerialDate.lastDayOfMonth(month, year))) {</p>
<p>this.day = day;</p>
<p>else {</p>
<p>throw new IllegalArgumentException(‚ÄúInvalid ‚Äòday‚Äô argument.‚Äù);</p>
<p>// es necesario sincronizar el n√∫mero de serie con el d√≠a-mes-a√±o...</p>
<p>this.serial = calcSerial(day, month, year);</p>
<p>this.description = null;</p>
<p>/**</p>
<ul>
<li>Constructor est√°ndar: crear un nuevo objeto de fecha que representa</li>
</ul>
<p>el</p>
<ul>
<li>n√∫mero de d√≠a especificado (que debe estar comprendido entre 2 y</li>
</ul>
<p>2958465).</p>
<ul>
<li>@param serial n√∫mero de serie para el d√≠a (entre 2 y 2958465).</li>
</ul>
<p>*/</p>
<p>public SpreadsheetDate(final int serial) {</p>
<p>if ((serial &gt;= SERIAL_LOWER_BOUND) &amp;&amp; (serial &lt;=</p>
<p>SERIAL_UPPER_BOUND)) {</p>
<p>this.serial = serial;</p>
<p>else {</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúSpreadsheetDate: Serial must be in range 2 to 2958465.‚Äù);</p>
<p>// el d√≠a-mes-a√±o debe estar sincronizado con el n√∫mero de serie...</p>
<p>calcDayMonthYear();</p>
<p>/**</p>
<ul>
<li>Devuelve la descripci√≥n adjuntada a la fecha. No es</li>
<li>obligatorio que la fecha tenga una descripci√≥n, pero resulta √∫til</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>en algunas aplicaciones.</li>
<li>@return La descripci√≥n adjuntada a la fecha.</li>
</ul>
<p>*/</p>
<p>public String getDescription() {</p>
<p>return this.description;</p>
<p>/**</p>
<ul>
<li>Establece la descripci√≥n de la fecha.</li>
<li>@param description la descripci√≥n de esta fecha (&lt;code&gt;null&lt;/code&gt;</li>
<li>se permite)</li>
</ul>
<p>*/</p>
<p>public void setDescription(final String description) {</p>
<p>this.description = description;</p>
<p>/**</p>
<ul>
<li>Devuelve el n√∫mero de serie de la fecha, siendo el 1 de enero 1900 =</li>
<li>(se corresponde, casi totalmente, al sistema de numeraci√≥n empleado</li>
</ul>
<p>en</p>
<ul>
<li>Microsoft Excel para Windows y Lotus 1-2-3).</li>
<li>@return El n√∫mero de serie de la fecha.</li>
</ul>
<p>*/</p>
<p>public int toSerial() {</p>
<p>return this.serial;</p>
<p>/**</p>
<ul>
<li>Devuelve una &lt;code&gt;java.util.Date&lt;/code&gt; equivalente a esta fecha.</li>
<li>@return La fecha.</li>
</ul>
<p>*/</p>
<p>public Date toDate() {</p>
<p>final Calendar calendar = Calendar.getInstance();</p>
<p>calendar.set(getYYYY(), getMonth() - 1, getDayOfMonth(), 0, 0, 0);</p>
<p>return calendar.getTime();</p>
<p>/**</p>
<ul>
<li>Devuelve el a√±o (con un intervalo v√°lido de 1900 a 9999).</li>
<li>@return El a√±o.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
</ul>
<p>*/</p>
<p>public int getYYYY() {</p>
<p>return this.year;</p>
<p>/**</p>
<ul>
<li>Devuelve el mes (Enero = 1, Febrero = 2, Marzo = 3).</li>
<li>@return El mes del a√±o.</li>
</ul>
<p>*/</p>
<p>public int getMonth() {</p>
<p>return this.month;</p>
<p>/**</p>
<ul>
<li>Devuelve el d√≠a del mes.</li>
<li>@return El d√≠a del mes.</li>
</ul>
<p>*/</p>
<p>public int getDayOfMonth() {</p>
<p>return this.day;</p>
<p>/**</p>
<ul>
<li>Devuelve un c√≥digo que representa el d√≠a de la semana.</li>
<li>&lt;P&gt;</li>
<li>Los c√≥digos se definen en la clase {@link SerialDate} como:</li>
<li>&lt;code&gt;SUNDAY&lt;/code&gt;, &lt;code&gt;MONDAY&lt;/code&gt;, &lt;code&gt;TUESDAY&lt;/code&gt;,</li>
<li>&lt;code&gt;WEDNESDAY&lt;/code&gt;, &lt;code&gt;THURSDAY&lt;/code&gt;, &lt;code&gt;FRIDAY&lt;/code&gt;,</li>
<li>&lt;code&gt;SATURDAY&lt;/code&gt;.</li>
<li>@return Un c√≥digo que representa el d√≠a de la semana.</li>
</ul>
<p>*/</p>
<p>public int getDayOfWeek() {</p>
<p>return (this.serial + 6) % 7 + 1;</p>
<p>/**</p>
<ul>
<li>Prueba la igualdad de esta fecha con un objeto arbitrario.</li>
<li>&lt;P&gt;</li>
<li>Este m√©todo S√ìLO devuelve true si el objeto es una instancia de la</li>
<li>clase base {@link SerialDate} y representa el mismo d√≠a que</li>
<li>{@link SpreadsheetDate}.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>@param object el objeto que comparar (se permite &lt;code&gt;null&lt;/code&gt;).</li>
<li>@return Un valor booleano.</li>
</ul>
<p>*/</p>
<p>public boolean equals(final Object object) {</p>
<p>if (object instanceof SerialDate) {</p>
<p>final SerialDate s = (SerialDate) object;</p>
<p>return (s.toSerial() == this.toSerial());</p>
<p>else {</p>
<p>return false;</p>
<p>/**</p>
<ul>
<li>Devuelve un c√≥digo hash para la instancia de este objeto.</li>
<li>@return Un c√≥digo hash.</li>
</ul>
<p>*/</p>
<p>public int hashCode() {</p>
<p>return toSerial();</p>
<p>/**</p>
<ul>
<li>Devuelve la diferencia (en d√≠as) entre esta fecha y la</li>
<li>‚Äòotra‚Äô fecha especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return La diferencia (en d√≠as) entre esta fecha y la</li>
<li>otra‚Äô fecha especificada.</li>
</ul>
<p>*/</p>
<p>public int compare(final SerialDate other) {</p>
<p>return this.serial ‚Äì other.toSerial();</p>
<p>/**</p>
<ul>
<li>Implementa el m√©todo necesario para la interfaz Comparable.</li>
<li>@param other el otro objeto (normalmente otro SerialDate).</li>
<li>@return Un entero negativo, cero o un entero positivo si este objeto</li>
<li>es menor que, igual o mayor que el objeto especificado.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
</ul>
<p>*/</p>
<p>public int compareTo(final Object other) {</p>
<p>return compare((SerialDate) other);</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa la misma fecha que la</li>
<li>SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa la misma</li>
</ul>
<p>fecha que</p>
<ul>
<li>la otra SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public boolean isOn(final SerialDate other) {</p>
<p>return (this.serial == other.toSerial());</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa una fecha anterior a</li>
<li>la SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa una fecha</li>
</ul>
<p>anterior a</p>
<ul>
<li>la SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public boolean isBefore(final SerialDate other) {</p>
<p>return (this.serial &lt; other.toSerial());</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa la misma fecha que la</li>
<li>SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa la misma</li>
</ul>
<p>fecha</p>
<ul>
<li>que la SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public boolean isOnOrBefore(final SerialDate other) {</p>
<p>return (this.serial &lt;= other.toSerial());</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa la misma fecha que la</li>
<li>SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa la misma</li>
</ul>
<p>fecha</p>
<ul>
<li>que la SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public boolean isAfter(final SerialDate other) {</p>
<p>return (this.serial &gt; other.toSerial());</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate representa la misma fecha que la</li>
<li>SerialDate especificada.</li>
<li>@param other la fecha con la que se compara.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate representa la misma</li>
</ul>
<p>fecha</p>
<ul>
<li>que la SerialDate especificada.</li>
</ul>
<p>*/</p>
<p>public boolean isOnOrAfter(final SerialDate other) {</p>
<p>return (this.serial &gt;= other.toSerial());</p>
<p>/**</p>
<ul>
<li>Devuelve &lt;code&gt;true&lt;/code&gt; si {@link SerialDate} se encuentra en el</li>
<li>intervalo especificado (INCLUSIVE). El orden de fecha de d1 y d2 no</li>
</ul>
<p>es</p>
<ul>
<li>importante.</li>
<li>@param d1 una fecha l√≠mite para el rango.</li>
<li>@param d2 la otra fecha l√≠mite para el rango.</li>
<li>@return Un valor booleano.</li>
</ul>
<p>*/</p>
<p>public boolean isInRange(final SerialDate d1, final SerialDate d2) {</p>
<p>return isInRange(d1, d2, SerialDate.INCLUDE_BOTH);</p>
<p>/**</p>
<ul>
<li>Devuelve true si esta SerialDate se encuentra en el intervalo</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
</ul>
<p>especificado</p>
<ul>
<li>(el invocador especifica si los puntos finales se incluyen o no). El</li>
</ul>
<p>orden</p>
<ul>
<li>de d1 y d2 no es importante.</li>
<li>@param d1 una fecha l√≠mite para el rango.</li>
<li>@param d2 la otra fecha l√≠mite para el rango.</li>
<li>@param include un c√≥digo que controla si la fecha inicial y final</li>
<li>se incluyen en el intervalo.</li>
<li>@return &lt;code&gt;true&lt;/code&gt; si esta SerialDate se encuentra en el</li>
</ul>
<p>intervalo</p>
<ul>
<li>especificado.</li>
</ul>
<p>*/</p>
<p>public boolean isInRange(final SerialDate d1, final SerialDate d2,</p>
<p>final int include) {</p>
<p>final int s1 = d1.toSerial();</p>
<p>final int s2 = d2.toSerial();</p>
<p>final int start = Math.min(s1, s2);</p>
<p>final int end = Math.max(s1, s2);</p>
<p>final int s = toSerial();</p>
<p>if (include == SerialDate.INCLUDE_BOTH) {</p>
<p>return (s &gt;= start &amp;&amp; s &lt;= end);</p>
<p>else if (include == SerialDate.INCLUDE_FIRST) {</p>
<p>return (s &gt;= start &amp;&amp; s &lt; end);</p>
<p>else if (include == SerialDate.INCLUDE_SECOND) {</p>
<p>return (s &gt; start &amp;&amp; s &lt;= end);</p>
<p>else {</p>
<p>return (s &gt; start &amp;&amp; s &lt; end);</p>
<p>/**</p>
<ul>
<li>Calcular el n√∫mero de serie a partir del d√≠a, mes y a√±o.</li>
<li>&lt;P&gt;</li>
<li>1-Ene-1900 = 2.</li>
<li>@param d el d√≠a.</li>
<li>@param m el mes.</li>
<li>@param y el a√±o.</li>
<li>@return el n√∫mero de serie a partir del d√≠a, mes y a√±o.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
</ul>
<p>*/</p>
<p>private int calcSerial(final int d, final int m, final int y) {</p>
<p>final int yy = ((y - 1900) * 365) + SerialDate.leapYearCount(y - 1);</p>
<p>int mm = SerialDate.AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH[m];</p>
<p>if (m &gt; MonthConstants.FEBRUARY) {</p>
<p>if (SerialDate.isLeapYear(y)) {</p>
<p>mm = mm + 1;</p>
<p>final int dd = d;</p>
<p>return yy + mm + dd + 1;</p>
<p>/**</p>
<ul>
<li>Calcular el d√≠a, mes y a√±o a partir del n√∫mero de serie.</li>
</ul>
<p>*/</p>
<p>private void calcDayMonthYear() {</p>
<p>// obtener el a√±o a partir del n√∫mero de serie de la fecha</p>
<p>final int days = this.serial - SERIAL_LOWER_BOUND;</p>
<p>// sobrevalorado ya que ignoramos los d√≠as bisiestos</p>
<p>final int overestimatedYYYY = 1900 + (days / 365);</p>
<p>final int leaps = SerialDate.leapYearCount(overestimatedYYYY);</p>
<p>final int nonleapdays = days - leaps;</p>
<p>// subestimado ya que sobrevaloramos los a√±os</p>
<p>int underestimatedYYYY = 1900 + (nonleapdays / 365);</p>
<p>if (underestimatedYYYY == overestimatedYYYY) {</p>
<p>this.year = underestimatedYYYY;</p>
<p>else {</p>
<p>int ss1 = calcSerial(1, 1, underestimatedYYYY);</p>
<p>while (ss1 &lt;= this.serial) {</p>
<p>underestimatedYYYY = underestimatedYYYY + 1;</p>
<p>ss1 = calcSerial(1, 1, underestimatedYYYY);</p>
<p>this.year = underestimatedYYYY - 1;</p>
<p>final int ss2 = calcSerial(1, 1, this.year);</p>
<p>int[] daysToEndOfPrecedingMonth</p>
<p>= AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH;</p>
<p>if (isLeapYear(this.year)) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>daysToEndOfPrecedingMonth</p>
<p>= LEAP_YEAR_AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH;</p>
<p>// get the month from the serial date</p>
<p>int mm = 1;</p>
<p>int sss = ss2 + daysToEndOfPrecedingMonth[mm] - 1;</p>
<p>while (sss &lt; this.serial) {</p>
<p>mm = mm + 1;</p>
<p>sss = ss2 + daysToEndOfPrecedingMonth[mm] - 1;</p>
<p>this.month = mm - 1;</p>
<p>// el resto es d(+1);</p>
<p>this.day = this.serial - ss2</p>
<ul>
<li>daysToEndOfPrecedingMonth[this.month] + 1;</li>
</ul>
<p>495 }</p>
<p>Listado B-6</p>
<p>RelativeDayOfWeekRule.java</p>
<p>/* =============================================================</p>
<ul>
<li>JCommon : biblioteca gratuita de clases de prop√≥sito general para</li>
</ul>
<p>Java(tm)</p>
<ul>
<li>=============================================================</li>
<li>(C) Copyright 2000-2005, de Object Refinery Limited y colaboradores.</li>
<li>Informaci√≥n del proyecto: http://www.jfree.org/jcommon/index.html</li>
<li>Esta biblioteca es software gratuito; puede distribuirla y/o modificarla</li>
<li>bajo las condiciones de la Licencia p√∫blica general GNU publicada por</li>
<li>la Free Software Foundation; ya sea la versi√≥n 2.1 de la licencia, u</li>
<li>otra versi√≥n posterior (de su elecci√≥n).</li>
<li>Esta biblioteca se distribuye con la intenci√≥n de que sea √∫til, pero</li>
<li>SIN GARANT√çA ALGUNA, incluida la garant√≠a impl√≠cita de COMERCIABILIDAD</li>
<li>e IDONEIDAD PARA UN DETERMINADO FIN. Consulte la Licencia p√∫blica general</li>
</ul>
<p>GNU</p>
<ul>
<li>si necesita m√°s informaci√≥n al respecto.</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>Deber√≠a haber recibido una copia de la Licencia p√∫blica general GNU</li>
<li>junto a esta biblioteca; en caso contrario, contacte con la Free Software</li>
<li>Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301,</li>
<li>EE.UU.</li>
<li>[Java es una marca comercial o marca comercial registrada de Sun</li>
<li>Microsystems, Inc. en Estados Unidos y otros pa√≠ses.]</li>
<li>--------------------------</li>
<li>RelativeDayOfWeekRule.java</li>
<li>--------------------------</li>
<li>(C) Copyright 2000-2003, de Object Refinery Limited y colaboradores.</li>
<li>Autor original: David Gilbert (por Object Refinery Limited);</li>
<li>Colaboradores(s): -;</li>
<li>$Id: RelativeDayOfWeekRule.java,v 1.6 2005/11/16 15:58:40 taqua Exp $</li>
<li>Cambios (26-Oct-2001)</li>
<li>--------------------------</li>
<li>26-Oct-2001 : Se cambi√≥ el paquete por com.jrefinery.date.*;</li>
<li>03-Oct-2002 : Se corrigen los errores detectados por Checkstyle (DG);</li>
</ul>
<p>*/</p>
<p>package org.jfree.date;</p>
<p>/**</p>
<ul>
<li>Una regla de fechas anuales que devuelve una fecha por cada a√±o en</li>
</ul>
<p>funci√≥n de</p>
<ul>
<li>(a) una regla de referencia; (b) un d√≠a de la semana y (c) un par√°metro</li>
</ul>
<p>de</p>
<ul>
<li>selecci√≥n (SerialDate.PRECEDING, SerialDate.NEAREST,</li>
</ul>
<p>SerialDate.FOLLOWING).</p>
<ul>
<li>&lt;P&gt;</li>
<li>Por ejemplo, el Viernes Santo se puede especificado ‚Äòel Viernes ANTERIOR</li>
</ul>
<p>al</p>
<ul>
<li>domingo de Resurrecci√≥n.</li>
<li>@author David Gilbert</li>
</ul>
<p>*/</p>
<p>public class RelativeDayOfWeekRule extends AnnualDateRule {</p>
<p>/** Una referencia a la regla de fechas anuales sobre la que se basa</p>
<p>esta regla. */</p>
<p>private AnnualDateRule subrule;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>El d√≠a de la semana (SerialDate.MONDAY, SerialDate.TUESDAY, etc).</li>
</ul>
<p>*/</p>
<p>private int dayOfWeek;</p>
<p>/** Indica que d√≠a de la semana (PRECEDING, NEAREST o FOLLOWING). */</p>
<p>private int relative;</p>
<p>/**</p>
<ul>
<li>Constructor predeterminado: genera una regla para el lunes siguiente</li>
</ul>
<p>al 1 de enero.</p>
<p>*/</p>
<p>public RelativeDayOfWeekRule() {</p>
<p>this(new DayAndMonthRule(), SerialDate.MONDAY,</p>
<p>SerialDate.FOLLOWING);</p>
<p>/**</p>
<ul>
<li>Constructor est√°ndar: genera una regla en funci√≥n de la subregla</li>
</ul>
<p>proporcionada.</p>
<ul>
<li>@param subrule la regla que determina la fecha de referencia.</li>
<li>@param dayOfWeek el d√≠a de la semana relativo a la fecha de</li>
</ul>
<p>referencia.</p>
<ul>
<li>@param relative indica ‚Äúqu√©‚Äù d√≠a de la semana (anterior, m√°s pr√≥ximo</li>
<li>o posterior).</li>
</ul>
<p>*/</p>
<p>public RelativeDayOfWeekRule(final AnnualDateRule subrule,</p>
<p>final int dayOfWeek, final int relative) {</p>
<p>this.subrule = subrule;</p>
<p>this.dayOfWeek = dayOfWeek;</p>
<p>this.relative = relative;</p>
<p>/**</p>
<ul>
<li>Devuelve la subregla (tambi√©n denominada regla de referencia).</li>
<li>@return La regla de fechas anuales que determina la fecha de</li>
</ul>
<p>referencia para</p>
<ul>
<li>esta regla.</li>
</ul>
<p>*/</p>
<p>public AnnualDateRule getSubrule() {</p>
<p>return this.subrule;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>/**</p>
<ul>
<li>Establece la subregla.</li>
<li>@param subrule la regla de fechas anuales que determina la fecha de</li>
<li>referencia para esta regla.</li>
</ul>
<p>*/</p>
<p>public void setSubrule(final AnnualDateRule subrule) {</p>
<p>this.subrule = subrule;</p>
<p>/**</p>
<ul>
<li>Devuelve el d√≠a de la semana de esta regla.</li>
<li>@return el d√≠a de la semana de esta regla.</li>
</ul>
<p>*/</p>
<p>public int getDayOfWeek() {</p>
<p>return this.dayOfWeek;</p>
<p>/**</p>
<ul>
<li>Establece el d√≠a de la semana de esta regla.</li>
<li>@param dayOfWeek el d√≠a de la semana de (SerialDate.MONDAY,</li>
<li>SerialDate.TUESDAY, etc.).</li>
</ul>
<p>*/</p>
<p>public void setDayOfWeek(final int dayOfWeek) {</p>
<p>this.dayOfWeek = dayOfWeek;</p>
<p>/**</p>
<ul>
<li>Devuelve el atributo ‚Äòrelativo‚Äô que determina ‚Äúqu√©‚Äù</li>
<li>d√≠a de la semana nos interesa (SerialDate.PRECEDING,</li>
<li>SerialDate.NEAREST o SerialDate.FOLLOWING).</li>
<li>@return El atributo ‚Äòrelativo‚Äô.</li>
</ul>
<p>*/</p>
<p>public int getRelative() {</p>
<p>return this.relative;</p>
<p>/**</p>
<ul>
<li>Establece el atributo ‚Äòrelativo‚Äô (SerialDate.PRECEDING,</li>
</ul>
<p>SerialDate.NEAREST,</p>
<ul>
<li>SerialDate.FOLLOWING).</li>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<li>@param relative determina ‚Äúqu√©‚Äù d√≠a de la semana se selecciona con</li>
</ul>
<p>esta</p>
<ul>
<li>regla.</li>
</ul>
<p>*/</p>
<p>public void setRelative(final int relative) {</p>
<p>this.relative = relative;</p>
<p>/**</p>
<ul>
<li>Crea un clon de esta regla.</li>
<li>@return un clon de esta regla.</li>
<li>@throws CloneNotSupportedException nunca debe producirse.</li>
</ul>
<p>*/</p>
<p>public Object clone() throws CloneNotSupportedException {</p>
<p>final RelativeDayOfWeekRule duplicate</p>
<p>= (RelativeDayOfWeekRule) super.clone();</p>
<p>duplicate.subrule = (AnnualDateRule) duplicate.getSubrule().clone();</p>
<p>return duplicate;</p>
<p>/**</p>
<ul>
<li>Devuelve la fecha generada por esta regla, para el a√±o especificado.</li>
<li>@param year el a√±o (1900 &amp;lt;= year &amp;lt;= 9999).</li>
<li>@return La fecha generada por esta regla para un a√±o concreto</li>
</ul>
<p>(posiblemente</p>
<ul>
<li>&lt;code&gt;null&lt;/code&gt;).</li>
</ul>
<p>*/</p>
<p>public SerialDate getDate(final int year) {</p>
<p>// comprobar argumento...</p>
<p>if ((year &lt; SerialDate.MINIMUM_YEAR_SUPPORTED)</p>
<p>|| (year &gt; SerialDate.MAXIMUM_YEAR_SUPPORTED)) {</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúRelativeDayOfWeekRule.getDate(): year outside valid range.‚Äù);</p>
<p>// calcular la fecha...</p>
<p>SerialDate result = null;</p>
<p>final SerialDate base = this.subrule.getDate(year);</p>
<p>if (base != null) {</p>
<p>switch (this.relative) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>case(SerialDate.PRECEDING):</p>
<p>result = SerialDate.getPreviousDayOfWeek(this.dayOfWeek,</p>
<p>base);</p>
<p>break;</p>
<p>case(SerialDate.NEAREST):</p>
<p>result = SerialDate.getNearestDayOfWeek(this.dayOfWeek,</p>
<p>base);</p>
<p>break;</p>
<p>case(SerialDate.FOLLOWING):</p>
<p>result = SerialDate.getFollowingDayOfWeek(this.dayOfWeek,</p>
<p>base);</p>
<p>break;</p>
<p>default:</p>
<p>break;</p>
<p>return result;</p>
<p>209 }</p>
<p>Listado B-7</p>
<p>DayDate.java (Final)</p>
<p>/* =============================================================</p>
<ul>
<li>JCommon: biblioteca gratuita de clases de prop√≥sito general para Java(tm)</li>
<li>=============================================================</li>
<li>(C) Copyright 2000-2005, de Object Refinery Limited y colaboradores.</li>
</ul>
<p>...</p>
<p>*/</p>
<p>package org.jfree.date;</p>
<p>import java.io.Serializable;</p>
<p>import java.util.*;</p>
<p>/**</p>
<ul>
<li>Una clase abstracta que representa fechas inmutables con una precisi√≥n de</li>
<li>un d√≠a. La implementaci√≥n asigna cada fecha a un entero que</li>
<li>representa un n√∫mero ordinal de d√≠as de un origen fijo.</li>
<li>¬øPor qu√© no usar java.√∫til.Date? Lo haremos, cuando tenga sentido. En</li>
</ul>
<p>ocasiones,</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<ul>
<li>java.util.Date puede ser demasiado precisa; representa un instante en el</li>
</ul>
<p>tiempo,</p>
<ul>
<li>con una precisi√≥n de 1/1000 de segundo (y la fecha depende de la</li>
<li>zona horaria). En ocasiones solo querremos representar un d√≠a concreto</li>
</ul>
<p>(como el 21</p>
<ul>
<li>de enero de 2015) sin preocuparnos de la hora del d√≠a, la</li>
<li>zona horaria u otros aspectos. Para eso hemos definido SerialDate.</li>
<li>Usar DayDateFactory.makeDate para crear una instancia.</li>
<li>@author David Gilbert</li>
<li>@author Robert C. Martin realiz√≥ gran parte de la refactorizaci√≥n.</li>
</ul>
<p>*/</p>
<p>public abstract class DayDate implements Comparable, Serializable {</p>
<p>public abstract int getOrdinalDay();</p>
<p>public abstract int getYear();</p>
<p>public abstract Month getMonth();</p>
<p>public abstract int getDayOfMonth();</p>
<p>protected abstract Day getDayOfWeekForOrdinalZero();</p>
<p>public DayDate plusDays(int days) {</p>
<p>return DayDateFactory.makeDate(getOrdinalDay() + days);</p>
<p>public DayDate plusMonths(int months) {</p>
<p>int thisMonthAsOrdinal = getMonth().toInt() - Month.JANUARY.toInt();</p>
<p>int thisMonthAndYearAsOrdinal = 12 * getYear() + thisMonthAsOrdinal;</p>
<p>int resultMonthAndYearAsOrdinal = thisMonthAndYearAsOrdinal +</p>
<p>months;</p>
<p>int resultYear = resultMonthAndYearAsOrdinal / 12;</p>
<p>int resultMonthAsOrdinal = resultMonthAndYearAsOrdinal % 12 +</p>
<p>Month.JANUARY.toInt();</p>
<p>Month resultMonth = Month.fromInt(resultMonthAsOrdinal);</p>
<p>int resultDay = correctLastDayOfMonth(getDayOfMonth(), resultMonth,</p>
<p>resultYear);</p>
<p>return DayDateFactory.makeDate(resultDay, resultMonth, resultYear);</p>
<p>public DayDate plusYears(int years) {</p>
<p>int resultYear = getYear() + years;</p>
<p>int resultDay = correctLastDayOfMonth(getDayOfMonth(), getMonth(),</p>
<p>resultYear);</p>
<p>return DayDateFactory.makeDate(resultDay, getMonth(), resultYear);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>private int correctLastDayOfMonth(int day, Month month, int year) {</p>
<p>int lastDayOfMonth = DateUtil.lastDayOfMonth(month, year);</p>
<p>if (day &gt; lastDayOfMonth)</p>
<p>day = lastDayOfMonth;</p>
<p>return day;</p>
<p>public DayDate getPreviousDayOfWeek(Day targetDayOfWeek) {</p>
<p>int offsetToTarget = targetDayOfWeek.toInt() -</p>
<p>getDayOfWeek().toInt();</p>
<p>if (offsetToTarget &gt;= 0)</p>
<p>offsetToTarget -= 7;</p>
<p>return plusDays(offsetToTarget);</p>
<p>public DayDate getFollowingDayOfWeek(Day targetDayOfWeek) {</p>
<p>int offsetToTarget = targetDayOfWeek.toInt() -</p>
<p>getDayOfWeek().toInt();</p>
<p>if (offsetToTarget &lt;= 0)</p>
<p>offsetToTarget += 7;</p>
<p>return plusDays(offsetToTarget);</p>
<p>public DayDate getNearestDayOfWeek(Day targetDayOfWeek) {</p>
<p>int offsetToThisWeeksTarget = targetDayOfWeek.toInt() -</p>
<p>getDayOfWeek().toInt();</p>
<p>int offsetToFutureTarget = (offsetToThisWeeksTarget + 7) % 7;</p>
<p>int offsetToPreviousTarget = offsetToFutureTarget - 7;</p>
<p>if (offsetToFutureTarget &gt; 3)</p>
<p>return plusDays(offsetToPreviousTarget);</p>
<p>else</p>
<p>return plusDays(offsetToFutureTarget);</p>
<p>public DayDate getEndOfMonth() {</p>
<p>Month month = getMonth();</p>
<p>int year = getYear();</p>
<p>int lastDay = DateUtil.lastDayOfMonth(month, year);</p>
<p>return DayDateFactory.makeDate(lastDay, month, year);</p>
<p>public Date toDate() {</p>
<p>final Calendar calendar = Calendar.getInstance();</p>
<p>int ordinalMonth = getMonth().toInt() - Month.JANUARY.toInt();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>calendar.set(getYear(), ordinalMonth, getDayOfMonth(), 0, 0, 0);</p>
<p>return calendar.getTime();</p>
<p>public String toString() {</p>
<p>return String.format(‚Äú%02d-%s-%d‚Äù, getDayOfMonth(), getMonth(),</p>
<p>getYear());</p>
<p>public Day getDayOfWeek() {</p>
<p>Day startingDay = getDayOfWeekForOrdinalZero();</p>
<p>int startingOffset = startingDay.toInt() - Day.SUNDAY.toInt();</p>
<p>int ordinalOfDayOfWeek = (getOrdinalDay() + startingOffset) % 7;</p>
<p>return Day.fromInt(ordinalOfDayOfWeek + Day.SUNDAY.toInt());</p>
<p>public int daysSince(DayDate date) {</p>
<p>return getOrdinalDay() - date.getOrdinalDay();</p>
<p>public boolean isOn(DayDate other) {</p>
<p>return getOrdinalDay() == other.getOrdinalDay();</p>
<p>public boolean isBefore(DayDate other) {</p>
<p>return getOrdinalDay() &lt; other.getOrdinalDay();</p>
<p>public boolean isOnOrBefore(DayDate other) {</p>
<p>return getOrdinalDay() &lt;= other.getOrdinalDay();</p>
<p>public boolean isAfter(DayDate other) {</p>
<p>return getOrdinalDay() &gt; other.getOrdinalDay();</p>
<p>public boolean isOnOrAfter(DayDate other) {</p>
<p>return getOrdinalDay() &gt;= other.getOrdinalDay();</p>
<p>public boolean isInRange(DayDate d1, DayDate d2) {</p>
<p>return isInRange(d1, d2, DateInterval.CLOSED);</p>
<p>public boolean isInRange(DayDate d1, DayDate d2, DateInterval</p>
<p>interval) {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>int left = Math.min(d1.getOrdinalDay(), d2.getOrdinalDay());</p>
<p>int right = Math.max(d1.getOrdinalDay(), d2.getOrdinalDay());</p>
<p>return interval.isIn(getOrdinalDay(), left, right);</p>
<p>179 }</p>
<p>Listado B-8</p>
<p>Month.java (Final)</p>
<p>package org.jfree.date;</p>
<p>import java.text.DateFormatSymbols;</p>
<p>public enum Month {</p>
<p>JANUARY(1), FEBRUARY(2), MARCH(3),</p>
<p>APRIL(4), MAY(5), JUNE(6),</p>
<p>JULY(7), AUGUST(8), SEPTEMBER(9),</p>
<p>OCTOBER(10),NOVEMBER(11),DECEMBER(12);</p>
<p>private static DateFormatSymbols dateFormatSymbols = new</p>
<p>DateFormatSymbols();</p>
<p>private static final int[] LAST_DAY_OF_MONTH =</p>
<p>{0, 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};</p>
<p>private int index;</p>
<p>Month(int index) {</p>
<p>this.index = index;</p>
<p>public static Month fromInt(int monthIndex) {</p>
<p>for (Month m : Month.values()) {</p>
<p>if (m.index == monthIndex)</p>
<p>return m;</p>
<p>throw new IllegalArgumentException(‚ÄúInvalid month index ‚Äù +</p>
<p>monthIndex);</p>
<p>public int lastDay() {</p>
<p>return LAST_DAY_OF_MONTH[index];</p>
<p>public int quarter() {</p>
<p>return 1 + (index - 1) / 3;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public String toString() {</p>
<p>return dateFormatSymbols.getMonths()[index - 1];</p>
<p>public String toShortString() {</p>
<p>return dateFormatSymbols.getShortMonths()[index - 1];</p>
<p>public static Month parse(String s) {</p>
<p>s = s.trim();</p>
<p>for (Month m : Month.values())</p>
<p>if (m.matches(s))</p>
<p>return m;</p>
<p>try {</p>
<p>return fromInt(Integer.parseInt(s));</p>
<p>catch (NumberFormatException e) {}</p>
<p>throw new IllegalArgumentException(‚ÄúInvalid month ‚Äù + s);</p>
<p>private boolean matches(String s) {</p>
<p>return s.equalsIgnoreCase(toString()) ||</p>
<p>s.equalsIgnoreCase(toShortString());</p>
<p>public int toInt() {</p>
<p>return index;</p>
<p>65 }</p>
<p>Listado B-9</p>
<p>Day.java (Final)</p>
<p>package org.jfree.date;</p>
<p>import java.util.Calendar;</p>
<p>import java.text.DateFormatSymbols;</p>
<p>public enum Day {</p>
<p>MONDAY(Calendar.MONDAY),</p>
<p>TUESDAY(Calendar.TUESDAY),</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>WEDNESDAY(Calendar.WEDNESDAY),</p>
<p>THURSDAY(Calendar.THURSDAY),</p>
<p>FRIDAY(Calendar.FRIDAY),</p>
<p>SATURDAY(Calendar.SATURDAY),</p>
<p>SUNDAY(Calendar.SUNDAY);</p>
<p>private final int index;</p>
<p>private static DateFormatSymbols dateSymbols = new DateFormatSymbols();</p>
<p>Day(int day) {</p>
<p>index = day;</p>
<p>public static Day fromInt(int index) throws IllegalArgumentException {</p>
<p>for (Day d : Day.values())</p>
<p>if (d.index == index)</p>
<p>return d;</p>
<p>throw new IllegalArgumentException(</p>
<p>String.format(‚ÄúIllegal day index: %d.‚Äù, index));</p>
<p>public static Day parse(String s) throws IllegalArgumentException {</p>
<p>String[] shortWeekdayNames =</p>
<p>dateSymbols.getShortWeekdays();</p>
<p>String[] weekDayNames =</p>
<p>dateSymbols.getWeekdays();</p>
<p>s = s.trim();</p>
<p>for (Day day : Day.values()) {</p>
<p>if (s.equalsIgnoreCase(shortWeekdayNames[day.index]) ||</p>
<p>s.equalsIgnoreCase(weekDayNames[day.index])) {</p>
<p>return day;</p>
<p>throw new IllegalArgumentException(</p>
<p>String.format(‚Äú%s is not a valid weekday string‚Äù, s));</p>
<p>public String toString() {</p>
<p>return dateSymbols.getWeekdays()[index];</p>
<p>public int toInt() {</p>
<p>return index;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>54 }</p>
<p>Listado B-10</p>
<p>DateInterval.java (Final)</p>
<p>package org.jfree.date;</p>
<p>public enum DateInterval {</p>
<p>OPEN {</p>
<p>public boolean isIn(int d, int left, int right) {</p>
<p>return d &gt; left &amp;&amp; d &lt; right;</p>
<p>},</p>
<p>CLOSED_LEFT {</p>
<p>public boolean isIn(int d, int left, int right) {</p>
<p>return d &gt;= left &amp;&amp; d &lt; right;</p>
<p>},</p>
<p>CLOSED_RIGHT {</p>
<p>public boolean isIn(int d, int left, int right) {</p>
<p>return d &gt; left &amp;&amp; d &lt;= right;</p>
<p>},</p>
<p>CLOSED {</p>
<p>public boolean isIn(int d, int left, int right) {</p>
<p>return d &gt;= left &amp;&amp; d &lt;= right;</p>
<p>};</p>
<p>public abstract boolean isIn(int d, int left, int right);</p>
<p>Listado B-11</p>
<p>WeekInMonth.java (Final)</p>
<p>package org.jfree.date;</p>
<p>public enum WeekInMonth {</p>
<p>FIRST(1), SECOND(2), THIRD(3), FOURTH(4), LAST(0);</p>
<p>private final int index;</p>
<p>WeekInMonth(int index) {</p>
<p>this.index = index;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public int toInt() {</p>
<p>return index;</p>
<p>Listado B-12</p>
<p>WeekdayRange.java (Final)</p>
<p>package org.jfree.date;</p>
<p>public enum WeekdayRange {</p>
<p>LAST, NEAREST, NEXT</p>
<p>Listado B-13</p>
<p>DateUtil.java (Final)</p>
<p>package org.jfree.date;</p>
<p>import java.text.DateFormatSymbols;</p>
<p>public class DateUtil {</p>
<p>private static DateFormatSymbols dateFormatSymbols = new</p>
<p>DateFormatSymbols();</p>
<p>public static String[] getMonthNames() {</p>
<p>return dateFormatSymbols.getMonths();</p>
<p>public static boolean isLeapYear(int year) {</p>
<p>boolean fourth = year % 4 == 0;</p>
<p>boolean hundredth = year % 100 == 0;</p>
<p>boolean fourHundredth = year % 400 == 0;</p>
<p>return fourth &amp;&amp; (!hundredth || fourHundredth);</p>
<p>public static int lastDayOfMonth(Month month, int year) {</p>
<p>if (month == Month.FEBRUARY &amp;&amp; isLeapYear(year))</p>
<p>return month.lastDay() + 1;</p>
<p>else</p>
<p>return month.lastDay();</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public static int leapYearCount(int year) {</p>
<p>int leap4 = (year - 1896) / 4;</p>
<p>int leap100 = (year - 1800) / 100;</p>
<p>int leap400 = (year - 1600) / 400;</p>
<p>return leap4 - leap100 + leap400;</p>
<p>32 }</p>
<p>Listado B-14</p>
<p>DayDateFactory.java (Final)</p>
<p>package org.jfree.date;</p>
<p>public abstract class DayDateFactory {</p>
<p>private static DayDateFactory factory = new SpreadsheetDateFactory();</p>
<p>public static void setInstance(DayDateFactory factory) {</p>
<p>DayDateFactory.factory = factory;</p>
<p>protected abstract DayDate _makeDate(int ordinal);</p>
<p>protected abstract DayDate _makeDate(int day, Month month, int year);</p>
<p>protected abstract DayDate _makeDate(int day, int month, int year);</p>
<p>protected abstract DayDate _makeDate(java.util.Date date);</p>
<p>protected abstract int _getMinimumYear();</p>
<p>protected abstract int _getMaximumYear();</p>
<p>public static DayDate makeDate(int ordinal) {</p>
<p>return factory._makeDate(ordinal);</p>
<p>public static DayDate makeDate(int day, Month month, int year) {</p>
<p>return factory._makeDate(day, month, year);</p>
<p>public static DayDate makeDate(int day, int month, int year) {</p>
<p>return factory._makeDate(day, month, year);</p>
<p>public static DayDate makeDate(java.util.Date date) {</p>
<p>return factory._makeDate(date);</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public static int getMinimumYear() {</p>
<p>return factory._getMinimumYear();</p>
<p>public static int getMaximumYear() {</p>
<p>return factory._getMaximumYear();</p>
<p>39 }</p>
<p>Listado B-15</p>
<p>SpreadsheetDateFactory.java (Final)</p>
<p>package org.jfree.date;</p>
<p>import java.util.*;</p>
<p>public class SpreadsheetDateFactory extends DayDateFactory {</p>
<p>public DayDate _makeDate(int ordinal) {</p>
<p>return new SpreadsheetDate(ordinal);</p>
<p>public DayDate _makeDate(int day, Month month, int year) {</p>
<p>return new SpreadsheetDate(day, month, year);</p>
<p>public DayDate _makeDate(int day, int month, int year) {</p>
<p>return new SpreadsheetDate(day, month, year);</p>
<p>public DayDate _makeDate(Date date) {</p>
<p>final GregorianCalendar calendar = new GregorianCalendar();</p>
<p>calendar.setTime(date);</p>
<p>return new SpreadsheetDate(</p>
<p>calendar.get(Calendar.DATE),</p>
<p>Month.fromInt(calendar.get(Calendar.MONTH) + 1),</p>
<p>calendar.get(Calendar.YEAR));</p>
<p>protected int _getMinimumYear() {</p>
<p>return SpreadsheetDate.MINIMUM_YEAR_SUPPORTED;</p>
<p>protected int _getMaximumYear() {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>return SpreadsheetDate.MAXIMUM_YEAR_SUPPORTED;</p>
<p>Listado B-16</p>
<p>SpreadsheetDate.java (Final)</p>
<p>/* ==============================================================</p>
<ul>
<li>JCommon: biblioteca gratuita de clases de prop√≥sito general para Java(tm)</li>
<li>==============================================================</li>
<li>(C) Copyright 2000-2005, de Object Refinery Limited y Colaboradores.</li>
</ul>
<p>...</p>
<p>*/</p>
<p>package org.jfree.date;</p>
<p>import static org.jfree.date.Month.FEBRUARY;</p>
<p>import java.util.*;</p>
<p>/**</p>
<ul>
<li>Representa una fecha con un entero, de forma similar a la</li>
<li>implementaci√≥n en Microsoft Excel. El intervalo de fechas admitido es</li>
<li>del 1-Ene-1900 al 31-Dic-9999.</li>
<li>&lt;p/&gt;</li>
<li>Recuerde que Excel tiene un error que reconoce el a√±o</li>
<li>1900 como bisiesto cuando en realidad no lo es. Encontrar√° m√°s</li>
<li>informaci√≥n en el sitio de Microsoft, en el art√≠culo Q181370:</li>
<li>&lt;p/&gt;</li>
<li>http://support.microsoft.com/support/kb/articles/Q181/3/70.asp</li>
<li>&lt;p/&gt;</li>
<li>Excel usa como convenci√≥n que el 1-Ene-1900 = 1. Esta clase usa la</li>
<li>convenci√≥n de que el 1-Ene-1900 = 2.</li>
<li>Como resultado, el n√∫mero de d√≠a de esta clase ser√° diferente al de</li>
<li>Excel para enero y febrero de 1900... pero Excel a√±ade un d√≠a</li>
<li>m√°s (29-Feb-1900 que en realidad no existe) y a partir de ah√≠</li>
<li>los n√∫meros de los d√≠as coinciden.</li>
<li>@author David Gilbert</li>
</ul>
<p>*/</p>
<p>public class SpreadsheetDate extends DayDate {</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public static final int EARLIEST_DATE_ORDINAL = 2; // 1/1/1900</p>
<p>public static final int LATEST_DATE_ORDINAL = 2958465; // 12/31/9999</p>
<p>public static final int MINIMUM_YEAR_SUPPORTED = 1900;</p>
<p>public static final int MAXIMUM_YEAR_SUPPORTED = 9999;</p>
<p>static final int[] AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH =</p>
<p>{0, 0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334, 365};</p>
<p>static final int[] LEAP_YEAR_AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH</p>
<p>{0, 0, 31, 60, 91, 121, 152, 182, 213, 244, 274, 305, 335, 366};</p>
<p>private int ordinalDay;</p>
<p>private int day;</p>
<p>private Month month;</p>
<p>private int year;</p>
<p>public SpreadsheetDate(int day, Month month, int year) {</p>
<p>if (year &lt; MINIMUM_YEAR_SUPPORTED || year &gt; MAXIMUM_YEAR_SUPPORTED)</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúThe ‚Äòyear‚Äô argument must be in range ‚Äù +</p>
<p>MINIMUM_YEAR_SUPPORTED + ‚Äú to ‚Äù + MAXIMUM_YEAR_SUPPORTED + ‚Äú.‚Äù);</p>
<p>if (day &lt; 1 || day &gt; DateUtil.lastDayOfMonth(month, year))</p>
<p>throw new IllegalArgumentException(‚ÄúInvalid ‚Äòday‚Äô argument.‚Äù);</p>
<p>this.year = year;</p>
<p>this.month = month;</p>
<p>this.day = day;</p>
<p>ordinalDay = calcOrdinal(day, month, year);</p>
<p>public SpreadsheetDate(int day, int month, int year) {</p>
<p>this(day, Month.fromInt(month), year);</p>
<p>public SpreadsheetDate(int serial) {</p>
<p>if (serial &lt; EARLIEST_DATE_ORDINAL || serial &gt; LATEST_DATE_ORDINAL)</p>
<p>throw new IllegalArgumentException(</p>
<p>‚ÄúSpreadsheetDate: Serial must be in range 2 to 2958465.‚Äù);</p>
<p>ordinalDay = serial;</p>
<p>calcDayMonthYear();</p>
<p>public int getOrdinalDay() {</p>
<p>return ordinalDay;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>public int getYear() {</p>
<p>return year;</p>
<p>public Month getMonth() {</p>
<p>return month;</p>
<p>public int getDayOfMonth() {</p>
<p>return day;</p>
<p>protected Day getDayOfWeekForOrdinalZero() {return Day.SATURDAY;}</p>
<p>public boolean equals(Object object) {</p>
<p>if (!(object instanceof DayDate))</p>
<p>return false;</p>
<p>DayDate date = (DayDate) object;</p>
<p>return date.getOrdinalDay() == getOrdinalDay();</p>
<p>public int hashCode() {</p>
<p>return getOrdinalDay();</p>
<p>public int compareTo(Object other) {</p>
<p>return daysSince((DayDate) other);</p>
<p>private int calcOrdinal(int day, Month month, int year) {</p>
<p>int leapDaysForYear = DateUtil.leapYearCount(year - 1);</p>
<p>int daysUpToYear = (year - MINIMUM_YEAR_SUPPORTED) * 365 +</p>
<p>leapDaysForYear;</p>
<p>int daysUpToMonth =</p>
<p>AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH[month.toInt()];</p>
<p>if (DateUtil.isLeapYear(year) &amp;&amp; month.toInt() &gt; FEBRUARY.toInt())</p>
<p>daysUpToMonth++;</p>
<p>int daysInMonth = day - 1;</p>
<p>return daysUpToYear + daysUpToMonth + daysInMonth +</p>
<p>EARLIEST_DATE_ORDINAL;</p>
<p>private void calcDayMonthYear() {</p>
<p>int days = ordinalDay - EARLIEST_DATE_ORDINAL;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>int overestimatedYear = MINIMUM_YEAR_SUPPORTED + days / 365;</p>
<p>int nonleapdays = days - DateUtil.leapYearCount(overestimatedYear);</p>
<p>int underestimatedYear = MINIMUM_YEAR_SUPPORTED + nonleapdays / 365;</p>
<p>year = huntForYearContaining(ordinalDay, underestimatedYear);</p>
<p>int firstOrdinalOfYear = firstOrdinalOfYear(year);</p>
<p>month = huntForMonthContaining(ordinalDay, firstOrdinalOfYear);</p>
<p>day = ordinalDay - firstOrdinalOfYear -</p>
<p>daysBeforeThisMonth(month.toInt());</p>
<p>private Month huntForMonthContaining(int anOrdinal, int</p>
<p>firstOrdinalOfYear) {</p>
<p>int daysIntoThisYear = anOrdinal - firstOrdinalOfYear;</p>
<p>int aMonth = 1;</p>
<p>while (daysBeforeThisMonth(aMonth) &lt; daysIntoThisYear)</p>
<p>aMonth++;</p>
<p>return Month.fromInt(aMonth - 1);</p>
<p>private int daysBeforeThisMonth(int aMonth) {</p>
<p>if (DateUtil.isLeapYear(year))</p>
<p>return LEAP_YEAR_AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH[aMonth] -</p>
<p>1;</p>
<p>else</p>
<p>return AGGREGATE_DAYS_TO_END_OF_PRECEDING_MONTH[aMonth] - 1;</p>
<p>private int huntForYearContaining(int anOrdinalDay, int startingYear)</p>
<p>int aYear = startingYear;</p>
<p>while (firstOrdinalOfYear(aYear) &lt;= anOrdinalDay)</p>
<p>aYear++;</p>
<p>return aYear - 1;</p>
<p>private int firstOrdinalOfYear(int year) {</p>
<p>return calcOrdinal(1, Month.JANUARY, year);</p>
<p>public static DayDate createInstance(Date date) {</p>
<p>GregorianCalendar calendar = new GregorianCalendar();</p>
<p>calendar.setTime(date);</p>
<p>return new SpreadsheetDate(calendar.get(Calendar.DATE),</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Month.fromInt(calendar.get(Calendar.MONTH) + 1),</p>
<p>calendar.get(Calendar.YEAR));</p>
<p>215 }</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="epilogo-376">Ep√≠logo</h1>
<p>En 2005, mientras asist√≠a a la conferencia Agile en Denver (EE.UU.),</p>
<p>[125]</p>
<p>Elisabeth Hedrickson me dio una pulsera verde parecida a la que Lance</p>
<p>Armstrong populariz√≥ hace unos a√±os. En √©sta se le√≠a Test Obsessed</p>
<p>(Obsesionado por las pruebas). Me la puse y la luc√≠ con orgullo. Desde que</p>
<p>aprend√≠ el TDD de Kent Beck en 1999, sin duda el desarrollo controlado por</p>
<p>pruebas me ha obsesionado.</p>
<p>Pero sucedi√≥ algo extra√±o. No me pod√≠a</p>
<p>quitar la pulsera. No porque se hubiera</p>
<p>quedado f√≠sicamente pegada, sino porque</p>
<p>estaba moralmente pegada.</p>
<p>La pulsera resum√≠a mi √©tica profesional.</p>
<p>Era un indicador visible de mi</p>
<p>compromiso por crear el mejor c√≥digo</p>
<p>posible. Si me la hubiera quitado habr√≠a</p>
<p>traicionado a esa √©tica y a ese compromiso.</p>
<p>Y todav√≠a la llevo en la mu√±eca.</p>
<p>Cuando escribo c√≥digo, la veo ah√≠. Es un recordatorio constante de la</p>
<p>promesa que me hice de escribir c√≥digo limpio.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>Robert Cecil ‚ÄúUncle Bob‚Äù Martin (Palo Alto California, Estados Unidos,</p>
<p>1952). Es un prestigioso desarrollador de software desde 1970 y consultor</p>
<p>internacional desde 1990. Es fundador y presidente de Object Mentor, Inc.,</p>
<p>un equipo de experimentados consultores que ayudan a clientes de todo el</p>
<p>mundo en diferentes campos de la programaci√≥n como C++, Java, C#, Ruby,</p>
<p>Programaci√≥n orientada objetos (POO), patrones de dise√±o, UML,</p>
<p>metodolog√≠as √°giles y programaci√≥n eXtreme.</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<h1 id="notas-377">Notas</h1>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[1]</p>
<p>[Beck07]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[2]</p>
<p>Cuando Ignaz Semmelweis recomend√≥ en 1847 que los m√©dicos se lavaran</p>
<p>las manos, su propuesta fue rechazada aludiendo que los doctores estaban</p>
<p>demasiado ocupados para hacerlo entre paciente y paciente. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[3]</p>
<p>http://www.pragmaticprogrammer.com/booksellers/2004-12.html. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[4]</p>
<p>[Knuth92]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[5]</p>
<p>Es una adaptaci√≥n del mensaje de despedida de Robert Stephenson Smyth</p>
<p>Baden-Powell a los Scouts: ¬´Intentad dejar este mundo un poco mejor de</p>
<p>como os lo encontrasteis...¬ª. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[6]</p>
<p>Como veremos m√°s adelante, aunque un contenedor sea una lista , no</p>
<p>conviene codificar el tipo de contenedor en el nombre. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[7]</p>
<p>Imagine que se crea una variable con el nombre klass s√≥lo porque el</p>
<p>nombre class se ha usado en otro elemento. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[8]</p>
<p>Uncle Bob sol√≠a hacerlo en C++ pero ha abandonado esta pr√°ctica ya que</p>
<p>no es necesario en los IDE modernos. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[9]</p>
<p>http://java.sun.com/products/javabeans/docs/spec.html. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[10]</p>
<p>Una herramienta de pruebas de c√≥digo abierto (www.fitnese.org). &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[11]</p>
<p>Una herramienta de c√≥digo abierto para probar unidades para Java</p>
<p>(www.junit.org). &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[12]</p>
<p>Le pregunt√© a Kent si todav√≠a conservaba una copia, pero no la encontr√≥.</p>
<p>Busqu√© en mis viejos ordenadores, pero nada. Solamente se conserva el</p>
<p>recuerdo de aqu√©l programa. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[13]</p>
<p>El lenguaje LOGO usaba la palabra clave TO al igual que Ruby y Python</p>
<p>usaban def . Por tanto, todas las funciones comenzaban por TO , lo que ten√≠a un</p>
<p>efecto interesante en c√≥mo se dise√±aban. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[14]</p>
<p>[KP78], p. 37. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[15]</p>
<p>Y, por supuesto, se incluyen cadenas if/else. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[16]</p>
<p>a. http://en.wikipedia.org/wiki/Single_responsibility_principle</p>
<p>b. http://www.objectmentor.com/resources/articles/srp.pdf &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[17]</p>
<p>a. http://en.wikipedia.org/wiki/Open/closed_principle</p>
<p>b. http://www.objectmentor.com/resources/articles/ocp.pdf &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[18]</p>
<p>[GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[19]</p>
<p>Termin√© la refactorizaci√≥n de un m√≥dulo que usaba la forma din√°mica.</p>
<p>Consegu√≠ convertir el m√≥dulo outputStream en un campo de la clase y las</p>
<p>invocaciones de writeField a formato mon√≥dico. El resultado fue mucho</p>
<p>m√°s limpio. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[20]</p>
<p>Existen algunos que creen que pueden evitar volver a compilar e</p>
<p>implementar, y nos hemos encargado de ellos. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[21]</p>
<p>Ejemplo de principio abierto/cerrado (OCP) [PPP02]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[22]</p>
<p>El principio DRY. [PRAG]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[23]</p>
<p>[SP72]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[24]</p>
<p>[KP78], p. 144. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[25]</p>
<p>La tendencia actual de los IDE de comprobar la ortograf√≠a de los</p>
<p>comentarios ser√° un b√°lsamo para los que tenemos que leer gran cantidad de</p>
<p>c√≥digo. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[26]</p>
<p>El cuadro muestra sigma/2 por encima y debajo de la media. Asumo que</p>
<p>la distribuci√≥n de la longitud de archivos no es normal, por lo que la</p>
<p>desviaci√≥n est√°ndar no es matem√°ticamente precisa. Pero aqu√≠ el objetivo no</p>
<p>es la precisi√≥n, sino la sensaci√≥n. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[27]</p>
<p>Es lo contrario a lo que sucede en lenguajes como Pascal, C y C++ que</p>
<p>obligan a definir, o al menos a declarar, las funciones antes de usarlas. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[28]</p>
<p>¬øA quien voy a enga√±ar? Sigo siendo programador de lenguajes de</p>
<p>ensamblado. En este caso, el h√°bito s√≠ hace al monje. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[29]</p>
<p>Siempre existe una soluci√≥n conocida por los dise√±adores orientados a</p>
<p>objetos con experiencia: VISITOR o entrega dual, por ejemplo. Pero son</p>
<p>t√©cnicas costosas suelen devolver la estructura de un programa por</p>
<p>procedimientos. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[30]</p>
<p>http://es.wikipedia.org/wiki/Ley_de_Demeter. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[31]</p>
<p>De la estructura Apache. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[32]</p>
<p>En ocasiones se denomina Feature Envy (Envidia de las caracter√≠sticas),</p>
<p>de [Refactoring]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[33]</p>
<p>[Martin]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[34]</p>
<p>[BeckTDD], pp. 136-137. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[35]</p>
<p>V√©ase el patr√≥n del adaptador en [GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[36]</p>
<p>M√°s informaci√≥n al respecto en [WELC]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[37]</p>
<p>Professionalism and Test-Driven Development , Robert C. Martin, Object</p>
<p>Mentor, IEEE Software, Mayo/Junio 2007 (Vol. 24, No. 3) pp. 32-36</p>
<p>http://doi.ieeecomputersociety.org/10.1109/MS.2007.85 &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[38]</p>
<p>http://fitnesse.org/FitNesse.AcceptanceTestPatterns. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[39]</p>
<p>V√©ase el apartado sobre asignaciones mentales del cap√≠tulo 2. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[40]</p>
<p>V√©ase la entrada de Dave Astel:</p>
<p>http://www.artima.com/weblogs/viewpost.jsp?thread=35578 &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[41]</p>
<p>[RSpec]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[42]</p>
<p>[GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[43]</p>
<p>¬°C√≠√±ase al c√≥digo! &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[44]</p>
<p>Materiales de formaci√≥n de Object Mentor. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[45]</p>
<p>[RDD]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[46]</p>
<p>Encontrar√° m√°s Informaci√≥n sobre este principio en [PPP]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[47]</p>
<p>[Knuth92]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[48]</p>
<p>[PPP]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[49]</p>
<p>[PPP]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[50]</p>
<p>[Mezzaros07]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[51]</p>
<p>[GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[52]</p>
<p>V√©ase, por ejemplo, [Fowler]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[53]</p>
<p>V√©ase [Spring], Tambi√©n existe una estructura Spring.NET. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[54]</p>
<p>No olvide que la creaci√≥n de instancias/evaluaci√≥n tard√≠a es s√≥lo una</p>
<p>optimizaci√≥n, puede que prematura. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[55]</p>
<p>Sistema de administraci√≥n de base de datos. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[56]</p>
<p>Consulte [AOSD] si necesita informaci√≥n general sobre aspectos y</p>
<p>[AspectJ] y [Colyer] para Informaci√≥n concreta de AspectJ. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[57]</p>
<p>No se necesita la modificaci√≥n manual del c√≥digo fuente de destino. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[58]</p>
<p>V√©ase [CGLIB], [ASM] y [Javassist]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[59]</p>
<p>Si necesita ejemplos m√°s detallados de la API Proxy y ejemplos de uso,</p>
<p>consulte [Goetz]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[60]</p>
<p>AOP se suele confundir con t√©cnicas empleadas para implementarlo,</p>
<p>como la intercepci√≥n y envoltorio de m√©todos a trav√©s de proxies . El</p>
<p>verdadero valor de un sistema AOP es la capacidad para especificar</p>
<p>comportamientos del sistema de forma concisa y modular. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[61]</p>
<p>V√©ase [Spring] y [JBoss]. Java puro significa sin AspectJ. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[62]</p>
<p>Adaptado de www.theserverside.com/tt/articles/article.tss?</p>
<p>l=IntrotoSpring25. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[63]</p>
<p>[GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[64]</p>
<p>El ejemplo se puede simplificar mediante mecanismos que usen</p>
<p>convenciones y anotaciones de Java 5 para reducir la cantidad necesaria de</p>
<p>l√≥gica de conexi√≥n expl√≠cita. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[65]</p>
<p>Adaptado de</p>
<p>http://www.onjava.com/pub/a/onjava/2006/05/17/standardizing-with-ejb3-</p>
<p>java-persistence-api.html. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[66]</p>
<p>V√©ase [AspectJ] y [Colyer]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[67]</p>
<p>No confundir con la pr√°ctica de dise√±o anticipado. BDUF es la pr√°ctica</p>
<p>de dise√±ar todo por adelantado antes de implementar nada. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[68]</p>
<p>Existe una cantidad significativa de exploraci√≥n iterativa y detalles de</p>
<p>an√°lisis, incluso una vez iniciada la construcci√≥n. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[69]</p>
<p>El t√©rmino fue empleado por primera vez por [Kolence]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[70]</p>
<p>El trabajo de [Alexander] ha sido una gran influencia para la comunidad</p>
<p>de software . &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[71]</p>
<p>V√©ase, por ejemplo, [DSL]. [JMock] es un buen ejemplo de API de Java</p>
<p>que crea un DSL. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[72]</p>
<p>[XPE]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[73]</p>
<p>[GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[74]</p>
<p>Correspondencia privada. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[75]</p>
<p>Rayos c√≥smicos, repeticiones, etc. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[76]</p>
<p>V√©ase el ap√©ndice A. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[77]</p>
<p>V√©ase el ap√©ndice A. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[78]</p>
<p>[PPP]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[79]</p>
<p>V√©ase el ap√©ndice A. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[80]</p>
<p>[PRAG]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[81]</p>
<p>[Lea99]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[82]</p>
<p>http://en.wikipedia.org/wiki/Producer-consumer. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[83]</p>
<p>http://en.wikipedia.org/wiki/Readers-writers_problem. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[84]</p>
<p>http://es.wikipedia.org/wiki/Problema_de_la_cena_de_los_fil√≥sofos. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[85]</p>
<p>V√©ase el ap√©ndice A. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[86]</p>
<p>Una secci√≥n cr√≠tica es cualquier secci√≥n de c√≥digo que debe protegerse de</p>
<p>usos simult√°neos por parte del programa para que sea correcta. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[87]</p>
<p>V√©ase el ap√©ndice A. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[88]</p>
<p>V√©ase el ap√©ndice A. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[89]</p>
<p>¬øSab√≠a que el modelo de procesos de Java no garantiza el procesamiento</p>
<p>preventivo? Los SO modernos s√≠ lo hacen, de modo que lo obtiene de forma</p>
<p>gratuita. No obstante, la MVJ no lo garantiza. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[90]</p>
<p>No es estrictamente el caso. Como la MVJ no garantiza los procesos</p>
<p>preventivos, un determinado algoritmo puede que siempre funcione en un SO</p>
<p>que no prevea los procesos. Lo contrario tambi√©n es posible, pero por</p>
<p>distintos motivos. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[91]</p>
<p>https://www.ibm.com/developerworks/community/groups/service/html/communityview?</p>
<p>lang=es&amp;communityUuid=18d10b14-e2c8-4780-bace-9af1fc463cc0. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[92]</p>
<p>Hace poco modifiqu√© este m√≥dulo para Ruby. Ten√≠a una s√©ptima parte del</p>
<p>tama√±o original y una mejor estructura. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[93]</p>
<p>Para evitar este tipo de sorpresas, a√±ad√≠ una nueva prueba de unidad que</p>
<p>invocaba todas las pruebas de FitNesse. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[94]</p>
<p>JUnit Pocket Guide , Kent Beck, O‚ÄôReilly. 2004. p. 43. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[95]</p>
<p>V√©ase el cap√≠tulo 1. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[96]</p>
<p>Una soluci√≥n mejor ser√≠a que el Javadoc presentara todos los comentarios</p>
<p>con formato previo, para que tengan el mismo aspecto en el c√≥digo y en el</p>
<p>documento. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[97]</p>
<p>Algunos revisores de este texto no comparten esta decisi√≥n. Sostienen que</p>
<p>en una estructura de c√≥digo abierto es m√°s recomendable ejercer control</p>
<p>manual sobre el ID de serie para que los cambios m√≠nimos del software no</p>
<p>invaliden las fechas se√±alizadas antiguas. Me parece justo. Sin embargo, al</p>
<p>menos el fallo, aunque sea inconveniente, tiene un motivo evidente. Por otra</p>
<p>parte, si el autor de la clase se olvida de actualizar el ID, el modo de fallo ser√°</p>
<p>indefinido y puede que silencioso. Creo que la moraleja es que no debe</p>
<p>esperar a deserializar entre versiones. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[98]</p>
<p>[GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[99]</p>
<p>Ibid. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[100]</p>
<p>Ibid. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[101]</p>
<p>[Simmons04], p. 73. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[102]</p>
<p>[Refactoring]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[103]</p>
<p>[Beck97]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[104]</p>
<p>[Refactoring]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[105]</p>
<p>http://es.wikipedia.org/wiki/Principio_de_la_M√≠nima_Sorpresa &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[106]</p>
<p>[PRAG]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[107]</p>
<p>[GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[108]</p>
<p>[GOF]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[109]</p>
<p>[Refactoring]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[110]</p>
<p>En concreto, el Principio de Responsabilidad √önica, el Principio</p>
<p>Abierto/Cerrado y el Principio de Cierre Com√∫n. V√©ase [PPP]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[111]</p>
<p>[Beck97], p. 108. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[112]</p>
<p>[Beck07]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[113]</p>
<p>Es distinto saber c√≥mo funciona el c√≥digo y saber si el algoritmo se</p>
<p>encargar√° de realizar la tarea para la que se necesita. Es habitual desconocer</p>
<p>si un algoritmo es el adecuado. Desconocer lo que hace el c√≥digo es</p>
<p>indolencia. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[114]</p>
<p>O mejor todav√≠a, una clase Money que use enteros. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[115]</p>
<p>[PRAG]. p. 138. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[116]</p>
<p>V√©ase la cita de Ward Cunningham del cap√≠tulo 1. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[117]</p>
<p>[DDD]. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[118]</p>
<p>Puede comprobar personalmente el c√≥digo antes y despu√©s, y revisar las</p>
<p>versiones con y sin subprocesos, que veremos en un apartado posterior. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[119]</p>
<p>Es una comparaci√≥n simplificada, pero para los objetivos de este</p>
<p>ejercicio es un modelo v√°lido. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[120]</p>
<p>De hecho, la interfaz Iterator es incompatible con subprocesos por</p>
<p>naturaleza. No se dise√±√≥ para usar varios subprocesos, de modo que no</p>
<p>deber√≠a sorprenderle. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[121]</p>
<p>Por ejemplo, alguien a√±ade un resultado de depuraci√≥n y el problema</p>
<p>desaparece. El c√≥digo de depuraci√≥n corrige el problema, pero permanece en</p>
<p>el sistema. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[122]</p>
<p>Siglas de There ain‚Äôt no such thing as a free lunch (Todo tiene un</p>
<p>precio). &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[123]</p>
<p>http://www.haifa.ibm.com/projects/verification/contest/index.html &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[124]</p>
<p>V√©ase [Lea99] p. 191. &lt;&lt;</p>
<hr style="margin: 40px 0; border: 1px dashed #ccc;">
<p>[125]</p>
<p>http://www.qualitytree.com/ &lt;&lt;</p>

        </main>
    </div>
    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById("theme-icon");
            if (html.getAttribute("data-theme") === "dark") {
                html.removeAttribute("data-theme");
                themeIcon.textContent = "üåô";
                localStorage.setItem("theme", "light");
            } else {
                html.setAttribute("data-theme", "dark");
                themeIcon.textContent = "‚òÄÔ∏è";
                localStorage.setItem("theme", "dark");
            }
        }
        
        window.addEventListener("DOMContentLoaded", () => {
            if (localStorage.getItem("theme") === "dark") {
                toggleTheme();
            }

            const menuToggle = document.getElementById('menu-toggle');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const tocLinks = document.querySelectorAll('.toc-link');

            function closeMenu() {
                sidebar.classList.remove('is-open');
                overlay.classList.remove('is-active');
            }

            menuToggle.addEventListener('click', () => {
                sidebar.classList.toggle('is-open');
                overlay.classList.toggle('is-active');
            });
            
            overlay.addEventListener('click', closeMenu);
            tocLinks.forEach(link => link.addEventListener('click', closeMenu));

            const observer = new IntersectionObserver(entries => {
                entries.forEach(entry => {
                    const id = entry.target.getAttribute('id');
                    const link = document.querySelector(`.toc-link[href="#${id}"]`);
                    if (entry.isIntersecting) {
                        document.querySelectorAll('.toc-link.active').forEach(l => l.classList.remove('active'));
                        if(link) {
                            link.classList.add('active');
                            link.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                });
            }, { rootMargin: "-20% 0px -80% 0px", threshold: 0 });

            document.querySelectorAll('main h1, main h2, main h3, main h4').forEach(h => {
                if(h) observer.observe(h);
            });
        });
    </script>
</body>
</html>